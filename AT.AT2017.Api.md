# AT.AT2017.Api
## ApplicationSettings.cs
```cs
namespace AT.AT2017.Api
{
    public class ApplicationSettings
    {

        public string AdminServer { get; set; }
        public string AdminDatabase { get; set; }
        public string AdminUser { get; set; }
        public string AdminPassword { get; set; }
        public string SubmissionServer { get; set; }
        public string AppInsightsDatabase { get; set; }
        public bool enableApiCallLog { get; set; }
        public string b2bEndPoints { get; set; }
        public string SubmissionServiceURL { get; set; }
        public string EmailHost { get; set; }
        public int EmailPort { get; set; }
        public string EmailUserName { get; set; }
        public string EmailPassword { get; set; }
        public string DatabaseServers { get; set; }
        public string DatabaseModes { get; set; }
        public string BrandCodes { get; set; }
        public string AgentBooksServer { get; set; }
        public string AgentBooksDatabase { get; set; }
        public string DarwinCloudWidgetUrl { get; set; }
        public string[] CorsClientOrigin { get; set; }
    }
}

```
## ModelValidator.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using AT.AT2017.Api.Controllers;
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Core.Shared;
using AT.AT2017.Api.Core.Exceptions;
using Newtonsoft.Json;
using System.Reflection;

namespace AT.AT2017.Api
{
    public class ModelValidator
    {
        private List<UIValidation> _rules;

        public ModelValidator(List<UIValidation> rules)
        {
            _rules = rules;
        }

        public void IsValid(object objModel, List<object> objDetail = null)
        {
            List<ModelValidationError> errors = new List<ModelValidationError>();

            // validate model
            errors.AddRange(IsValid(objModel));

            if ((objDetail != null))
            {
                // validate detail
                foreach (object objD in objDetail)
                {
                    errors.AddRange(IsValid(objD));
                }
            }

            if (errors.Count > 0)
            {
                throw new ModelValidationException("Model is invalid!", new Exception(JsonConvert.SerializeObject(errors)));
            }

        }

        private List<ModelValidationError> IsValid(object objModel)
        {
            List<ModelValidationError> errors = new List<ModelValidationError>();
            Type objType = objModel.GetType();
            string table = objType.Name;

            PropertyInfo[] listProperties = objType.GetProperties();

            ////Get EntityId
            //PropertyInfo propEntity = listProperties.GetType().GetProperty(table + "Id");
            //entityId = (int) propEntity.GetValue(objModel, null);

            if ( _rules!=null && _rules.Count > 0)
            {
                foreach (PropertyInfo pInfo in listProperties)
                {
                    //Linq is case sensitive when compare strings
                     UIValidation validInfo = (from v in _rules
                                               where v.column.Equals(pInfo.Name, StringComparison.OrdinalIgnoreCase) &&
                                               v.table.Equals(table, StringComparison.OrdinalIgnoreCase)
                                               select v).FirstOrDefault();

                    if ((validInfo != null))
                    {
                        bool hasToValidate = false;
                        if (validInfo.isComputed) hasToValidate = false;
                        if (validInfo.isIdentity) hasToValidate = false;
                        if (!validInfo.isNullable) hasToValidate = true;
                        if (validInfo.isNullable && validInfo.isRequired == false) hasToValidate = false;
                        if (validInfo.isNullable && validInfo.isRequired == true) hasToValidate = true;

                        if (hasToValidate)
                        {
                            object propValue= pInfo.GetValue(objModel, null);
                            bool isError = false;

                            if (propValue == null)
                            {
                                isError = true;
                            }
                            else
                            {
                                Type propType = pInfo.PropertyType;
                                switch (propType.Name)
                                {
                                    case "Decimal":
                                        Decimal valdc = Convert.ToDecimal(propValue);
                                        if (valdc <= 0)
                                        {
                                            isError = true;
                                        }
                                        break;
                                    case "Double":
                                        Double valb = Convert.ToDouble(propValue);
                                        if (valb <= 0)
                                        {
                                            isError = true;
                                        }
                                        break;
                                    case "DateTime":
                                        DateTime vald = Convert.ToDateTime(propValue);
                                        if (vald == DateTime.MinValue)
                                        {
                                            isError = true;
                                        }
                                        break;
                                    case "Int32":
                                        int vali = Convert.ToInt32(propValue);
                                        if (vali <= 0)
                                        {
                                            isError = true;
                                        }
                                        break;
                                    case "String":
                                        string vals = Convert.ToString(propValue);
                                        if (vals == string.Empty)
                                        {
                                            isError = true;
                                        }
                                        break;
                                }

                            }

                            if (isError == true)
                            {
                                ModelValidationError error = new ModelValidationError();
                                error.field = pInfo.Name;
                                error.message = "The " + pInfo.Name + " field is required.";
                                errors.Add(error);

                            }
                        }
                    }
                }
            }

            return errors;


        }
    }


}

```
## Program.cs
```cs
using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Hosting;
using Microsoft.AspNetCore.Builder;
using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.Configuration.CommandLine;
using Microsoft.AspNetCore;

namespace AT.AT2017.Api
{
    public class Program
    {
        public static void Main(string[] args)
        {
            BuildWebHost(args).Run();
        }

        public static IWebHost BuildWebHost(string[] args) =>
            WebHost.CreateDefaultBuilder(args)
                .UseStartup<Startup>()
                .Build();
    }
}

```
## Startup.cs
```cs
using System;
using Microsoft.AspNetCore.Builder;
using Microsoft.AspNetCore.Hosting;
using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Repositories;
using AT.AT2017.Api.Repositories.AgentBooks;
using AT.AT2017.Api.Middlewares;
using Microsoft.AspNetCore.Http;
//using Swashbuckle.Swagger.Model;
using Microsoft.Extensions.Options;
using System.Runtime.InteropServices;
using Microsoft.Win32;
using System.Text;
using System.Net;
using Hangfire;
using Hangfire.SqlServer;
using Microsoft.ApplicationInsights.Extensibility;
using Microsoft.ApplicationInsights.DependencyCollector;
using System.Linq;
using Microsoft.AspNetCore.ResponseCompression;
using System.IO.Compression;
using AT.AT2017.Api.Hubs;

namespace AT.AT2017.Api
{
    public class Startup
    {
        readonly string CorsOriginsPolicy = "CorsOrigins";
        readonly string CorsDarwinClientPolicy = "CorsDarwinClient";

        public Startup(IHostingEnvironment env)
        {
            var builder = new ConfigurationBuilder()
                .SetBasePath(env.ContentRootPath)
                .AddJsonFile("appsettings.json", optional: true, reloadOnChange: true)
                .AddJsonFile($"appsettings.{env.EnvironmentName}.json", optional: true)
                .AddEnvironmentVariables();

            if (env.IsDevelopment())
            {
                builder.AddUserSecrets<Startup>();
            }

            Configuration = builder.Build();

        }

        public IConfigurationRoot Configuration { get; }

        // This method gets called by the runtime. Use this method to add services to the container.
        public void ConfigureServices(IServiceCollection services)
        {
            // Add application setting
            IConfigurationSection appSettingsSection = Configuration.GetSection("ApplicationSettings");
            services.Configure<ApplicationSettings>(appSettingsSection);

            // bind appSettings
            var appSettings = new ApplicationSettings();
            appSettingsSection.Bind(appSettings);

            string[] clientOrigins = appSettings.CorsClientOrigin;

            // Add default policy for CORS
            services.AddCors(options =>
                {
                    options.AddPolicy(CorsOriginsPolicy,
                        builder =>
                        {
                            builder
                                .AllowAnyOrigin()
                                .AllowCredentials()
                                .AllowAnyHeader()
                                .AllowAnyMethod();
                        });

                    options.AddPolicy(CorsDarwinClientPolicy,
                        builder =>
                        {
                            builder
                                .WithOrigins(clientOrigins)
                                .AllowCredentials()
                                .AllowAnyHeader()
                                .AllowAnyMethod();
                        });
                });

            // Add SignalR
            services.AddSignalR();

            // Add Hangfire services.
            services.AddHangfire(configuration => configuration
                .SetDataCompatibilityLevel(CompatibilityLevel.Version_170)
                .UseSimpleAssemblyNameTypeSerializer()
                .UseRecommendedSerializerSettings()
                .UseSqlServerStorage(Configuration.GetConnectionString("HangfireConnection"), new SqlServerStorageOptions
                {
                    CommandBatchMaxTimeout = TimeSpan.FromMinutes(5),
                    SlidingInvisibilityTimeout = TimeSpan.FromMinutes(2),
                    QueuePollInterval = TimeSpan.Zero,
                    UseRecommendedIsolationLevel = true,
                    UsePageLocksOnDequeue = true,
                    DisableGlobalLocks = true
                }));

            // Add the processing server as IHostedService
            services.AddHangfireServer();

            // Add framework services.
            services.AddMvc();

            // Add compression
            services.Configure<GzipCompressionProviderOptions>(options =>
                options.Level = CompressionLevel.Optimal);
            services.AddResponseCompression(options =>
            {
                options.EnableForHttps = true;
                options.Providers.Add<GzipCompressionProvider>();
            });

            // Add custom services
            services.AddSingleton<UserConnectionManager>();

            services.AddSingleton<IHttpContextAccessor, HttpContextAccessor>();
            services.AddSingleton<IFeedProcessRepository, FeedProcessRepository>();
            services.AddSingleton<IInvoiceRepository, InvoiceRepository>();
            services.AddSingleton<IInvoiceDetailRepository, InvoiceDetailRepository>();
            services.AddSingleton<ICodeValueRepository, CodeValueRepository>();
            services.AddSingleton<IPropertyRepository, PropertyRepository>();
            services.AddSingleton<IGLAccountRepository, GLAccountRepository>();
            services.AddSingleton<IGLAccountCommissionRepository, GLAccountCommissionRepository>();
            services.AddSingleton<IGLAccountPeriodRepository, GLAccountPeriodRepository>();
            services.AddSingleton<IAuthRepository, AuthRepository>();
            services.AddSingleton<IPropertyFeatureRepository, PropertyFeatureRepository>();
            services.AddSingleton<IPropertySyndicationOptOutRepository, PropertySyndicationOptOutRepository>();
            services.AddSingleton<IPropertyInternalMessageRepository, PropertyInternalMessageRepository>();
            services.AddSingleton<IPropertyOpenhouseRepository, PropertyOpenhouseRepository>();
            services.AddSingleton<IPropertyPaymentOffTheTopRepository, PropertyPaymentOffTheTopRepository>();
            services.AddSingleton<IPropertyPeopleRepository, PropertyPeopleRepository>();
            services.AddSingleton<IPropertyReimbursementRepository, PropertyReimbursementRepository>();
            services.AddSingleton<IPropertyRemarkRepository, PropertyRemarkRepository>();
            services.AddSingleton<IPropertyRoomRepository, PropertyRoomRepository>();
            services.AddSingleton<IPropertyShowingRepository, PropertyShowingRepository>();
            services.AddSingleton<IPropertyShowingFeedbackRepository, PropertyShowingFeedbackRepository>();
            services.AddSingleton<IPropertyThirdPartyPaymentRepository, PropertyThirdPartyPaymentRepository>();
            services.AddSingleton<IPropertyTimelineTaskRepository, PropertyTimelineTaskRepository>();
            services.AddSingleton<IPropertyDeductionRepository, PropertyDeductionRepository>();
            services.AddSingleton<IPropertyDeductionOverrideRepository, PropertyDeductionOverrideRepository>();
            services.AddSingleton<IPropertyExtraVoucherRepository, PropertyExtraVoucherRepository>();
            services.AddSingleton<IPersonRepository, PersonRepository>();
            services.AddSingleton<IPersonAddressRepository, PersonAddressRepository>();
            services.AddSingleton<IPersonDeductionRepository, PersonDeductionRepository>();
            services.AddSingleton<IPersonDesignationRepository, PersonDesignationRepository>();
            services.AddSingleton<IPersonGroupRepository, PersonGroupRepository>();
            services.AddSingleton<IPersonInsuranceRepository, PersonInsuranceRepository>();
            services.AddSingleton<IPersonLanguageRepository, PersonLanguageRepository>();
            services.AddSingleton<IPersonLicenseRepository, PersonLicenseRepository>();
            services.AddSingleton<IPersonMediaRepository, PersonMediaRepository>();
            services.AddSingleton<IPersonMessageRepository, PersonMessageRepository>();
            services.AddSingleton<IPersonOnlinePaymentRepository, PersonOnlinePaymentRepository>();
            services.AddSingleton<IPersonPhoneRepository, PersonPhoneRepository>();
            services.AddSingleton<IPersonWebsiteRepository, PersonWebsiteRepository>();
            services.AddSingleton<IPersonPositionRepository, PersonPositionRepository>();
            services.AddSingleton<IPersonTimelineTaskRepository, PersonTimelineTaskRepository>();
            services.AddSingleton<IPersonUptimeRepository, PersonUptimeRepository>();
            services.AddSingleton<IPersonWebProfileRepository, PersonWebProfileRepository>();
            services.AddSingleton<IOfficeRepository, OfficeRepository>();
            services.AddSingleton<IJobCodeRepository, JobCodeRepository>();
            services.AddSingleton<IAuditTrailRepository, AuditTrailRepository>();
            services.AddSingleton<ISettingRepository, SettingRepository>();
            services.AddSingleton<IZipCodeRepository, ZipCodeRepository>();
            services.AddSingleton<IMenuRepository, MenuRepository>();
            services.AddSingleton<IMenuActionRepository, MenuActionRepository>();
            services.AddSingleton<IUserRepository, UserRepository>();
            services.AddSingleton<IRoleRepository, RoleRepository>();
            services.AddSingleton<IUserRoleRepository, UserRoleRepository>();
            services.AddSingleton<ISecurityRepository, SecurityRepository>();
            services.AddSingleton<IVoucherRepository, VoucherRepository>();
            services.AddSingleton<IVoucherScannedImageRepository, VoucherScannedImageRepository>();
            services.AddSingleton<IVoucherScannedImageViewHistoryRepository, VoucherScannedImageViewHistoryRepository>();
            services.AddSingleton<IJournalScannedImageRepository, JournalScannedImageRepository>();
            services.AddSingleton<IJournalScannedImageViewHistoryRepository, JournalScannedImageViewHistoryRepository>();
            services.AddSingleton<IInvoiceScannedImageRepository, InvoiceScannedImageRepository>();
            services.AddSingleton<IInvoiceScannedImageViewHistoryRepository, InvoiceScannedImageViewHistoryRepository>();
            services.AddSingleton<ICheckbookScannedImageRepository, CheckbookScannedImageRepository>();
            services.AddSingleton<ICheckbookScannedImageViewHistoryRepository, CheckbookScannedImageViewHistoryRepository>();
            services.AddSingleton<IArPaymentScannedImageRepository, ArPaymentScannedImageRepository>();
            services.AddSingleton<IArPaymentScannedImageViewHistoryRepository, ArPaymentScannedImageViewHistoryRepository>();
            services.AddSingleton<IApPaymentScannedImageRepository, ApPaymentScannedImageRepository>();
            services.AddSingleton<IApPaymentScannedImageViewHistoryRepository, ApPaymentScannedImageViewHistoryRepository>();
            services.AddSingleton<ICheckbookRepository, CheckbookRepository>();
            services.AddSingleton<IJournalRepository, JournalRepository>();
            services.AddSingleton<IArPaymentRepository, ArPaymentRepository>();
            services.AddSingleton<IApPaymentRepository, ApPaymentRepository>();
            services.AddSingleton<IBudgetRepository, BudgetRepository>();
            services.AddSingleton<IBankReconciliationRepository, BankReconciliationRepository>();
            services.AddSingleton<IDeductionRepository, DeductionRepository>();
            services.AddSingleton<IDeductionFormulaRepository, DeductionFormulaRepository>();
            services.AddSingleton<IDeductionPlanRepository, DeductionPlanRepository>();
            services.AddSingleton<IDeductionScaleRepository, DeductionScaleRepository>();
            services.AddSingleton<IPersonOverrideRepository, PersonOverrideRepository>();
            services.AddSingleton<ICompanyRepository, CompanyRepository>();
            services.AddSingleton<IBillingItemRepository, BillingItemRepository>();
            services.AddSingleton<IPersonBillingDetailRepository, PersonBillingDetailRepository>();
            services.AddSingleton<IRegionRepository, RegionRepository>();
            services.AddSingleton<IRegionOfficeRepository, RegionOfficeRepository>();
            services.AddSingleton<IUserCompanyRepository, UserCompanyRepository>();
            services.AddSingleton<IUserGLAccountRepository, UserGLAccountRepository>();
            services.AddSingleton<IUserOfficeRepository, UserOfficeRepository>();
            services.AddSingleton<ICheckTemplateRepository, CheckTemplateRepository>();
            services.AddSingleton<ICheckMergeFieldRepository, CheckMergeFieldRepository>();
            services.AddSingleton<ICheckWriterRepository, CheckWriterRepository>();
            services.AddSingleton<ICorrespondenceTemplateRepository, CorrespondenceTemplateRepository>();
            services.AddSingleton<ICorrespondenceMergeFieldRepository, CorrespondenceMergeFieldRepository>();
            services.AddSingleton<IPropertyCubeRepository, PropertyCubeRepository>();
            services.AddSingleton<IPropertyByAgentCubeRepository, PropertyByAgentCubeRepository>();
            services.AddSingleton<IGLAccountPeriodLockRepository, GLAccountPeriodLockRepository>();
            services.AddSingleton<IGLAccountSettingRepository, GLAccountSettingRepository>();
            services.AddSingleton<ITotalRepository, TotalRepository>();
            services.AddSingleton<ISubmissionScheduleRepository, SubmissionScheduleRepository>();
            services.AddSingleton<IPersonTotalRepository, PersonTotalRepository>();
            services.AddSingleton<IVoucherDetailRepository, VoucherDetailRepository>();
            services.AddSingleton<IPropertyDeductionHistoryRepository, PropertyDeductionHistoryRepository>();
            services.AddSingleton<ICheckbookDetailRepository, CheckbookDetailRepository>();
            services.AddSingleton<IUIValidationRepository, UIValidationRepository>();
            services.AddSingleton<IUIValidationTableRepository, UIValidationTableRepository>();
            services.AddSingleton<IModelDictionaryRepository, ModelDictionaryRepository>();
            services.AddSingleton<IReportRepository, ReportRepository>();
            services.AddSingleton<IReportDataSourceRepository, ReportDataSourceRepository>();
            services.AddSingleton<IDashboardRepository , DashboardRepository >();
            services.AddSingleton<IDashboardColumnsRepository , DashboardColumnsRepository >();
            services.AddSingleton<IDashboardUserDetailRepository, DashboardUserDetailRepository>();
            services.AddSingleton<IPropertyOffsetRepository,PropertyOffsetRepository>();
            services.AddSingleton<IMigrationLogDetailRepository, MigrationLogDetailRepository>();
            services.AddSingleton<IPersonTotalDetailRepository, PersonTotalDetailRepository>();
            services.AddSingleton<ISubmissionRepository, SubmissionRepository>();
            services.AddSingleton<IInquiryRepository, InquiryRepository>();
            services.AddSingleton<IFortePaymentLogRepository, FortePaymentLogRepository>();
            services.AddSingleton<IMigrationRepository, MigrationRepository>();
            services.AddSingleton<IDropDownRepository, DropDownRepository >();
            services.AddSingleton<INotificationSettingRepository, NotificationSettingRepository>();
            services.AddSingleton<IPersonMlsRepository, PersonMlsRepository>();
            services.AddSingleton<ICampaignRepository, CampaignRepository>();
            services.AddSingleton<ICertificationRepository, CertificationRepository>();
            services.AddSingleton<ICertificationGroupRepository, CertificationGroupRepository>();
            services.AddSingleton<ICategoryRepository, CategoryRepository>();
            services.AddSingleton<IDatabaseRepository, DatabaseRepository>();
            services.AddSingleton<IBackupExecutionLogRepository , BackupExecutionLogRepository>();
            services.AddSingleton<IAgentTeamRepository, AgentTeamRepository>();
            services.AddSingleton<IPropertyReportRepository, PropertyReportRepository>();
            services.AddSingleton<ILedgerReportRepository, LedgerReportRepository>();
            services.AddSingleton<IPersonReportRepository, PersonReportRepository>();
            services.AddSingleton<IClientDeviceRepository, ClientDeviceRepository>();

            services.AddSingleton<IFeedRepository, FeedRepository>();
            services.AddSingleton<IFeedTypeRepository, FeedTypeRepository>();
            services.AddSingleton<IFeedSubTypeRepository, FeedSubTypeRepository>();
            services.AddSingleton<IFeedResourceRepository, FeedResourceRepository>();
            services.AddSingleton<IFeedSourceFieldRepository, FeedSourceFieldRepository>();
            services.AddSingleton<IFeedSourceFieldLookupRepository, FeedResourceFieldLookupRepository>();
            services.AddSingleton<IFeedAtTableRepository, FeedAtTableRepository>();
            services.AddSingleton<IFeedAtTableDetailRepository, FeedAtTableDetailRepository>();
            services.AddSingleton<IFeedAtFieldRepository, FeedAtFieldRepository>();
            services.AddSingleton<IFeedAtFunctionRepository, FeedAtFunctionRepository>();
            services.AddSingleton<IFeedFilterRepository, FeedFilterRepository>();
            services.AddSingleton<IFeedPODFilterRepository, FeedPODFilterRepository>();
            services.AddSingleton<IFeedMatchRepository, FeedMatchingRepository>();
            services.AddSingleton<IFeedFilterDetailRepository, FeedFilterDetailRepository>();
            services.AddSingleton<IFeedMappingRepository, FeedMappingRepository>();
            services.AddSingleton<IFeedMappingDetailRepository, FeedMappingDetailRepository>();
            services.AddSingleton<IFeedTransformationRepository, FeedTransformationRepository>();
            services.AddSingleton<IFeedScheduleRepository, FeedScheduleRepository>();
            services.AddSingleton<IFeedExecutionRepository, FeedExecutionRepository>();
            services.AddSingleton<IFeedExecutionDetailRepository, FeedExecutionDetailRepository>();
            services.AddSingleton<IFeedExecutionRecordRepository, FeedExecutionRecordRepository>();
            services.AddSingleton<IExtraVoucherRepository, ExtraVoucherRepository>();
            services.AddSingleton<IBackupExecutionRepository, BackupExecutionRepository>();
            services.AddSingleton<IErrorCodeRepository, ErrorCodeRepository>();
            services.AddSingleton<ISystemRepository, SystemRepository>();
            services.AddSingleton<IModuleRepository, ModuleRepository>();
            services.AddSingleton<IRepCubeRepository, RepCubeRepository>();
            services.AddSingleton<ILoginHistoryRepository, LoginHistoryRepository>();
            services.AddSingleton<IDeletedRecordRepository, DeletedRecordRepository>();
            services.AddSingleton<IReimbursementRepository, ReimbursementRepository>();
            services.AddSingleton<IApiCallLogRepository, ApiCallLogRepository>();
            services.AddSingleton<IQuickbookRepository, QuickbookRepository>();
            services.AddSingleton<IReplicationRepository, ReplicationRepository>();
            services.AddSingleton<IDatabaseRepository, DatabaseRepository>();
            services.AddSingleton<IServerRepository, ServerRepository>();
            services.AddSingleton<IGlobalSettingRepository, GlobalSettingRepository>();
            services.AddSingleton<IClientDeviceRepository, ClientDeviceRepository>();
            services.AddSingleton<IRecurringRepository, RecurringRepository>();
            services.AddSingleton<IDocumentRepository, DocumentRepository>();
            services.AddSingleton<I1099ReconciliationRepository, _1099ReconciliationRepository > ();
            services.AddSingleton<IReconciliationMergeFieldRepository, ReconciliationMergeFieldRepository>();
            services.AddSingleton<IReconciliationTemplateRepository, ReconciliationTemplateRepository>();
            services.AddSingleton<IReconciliationWriterRepository, ReconciliationWriterRepository>();
            services.AddSingleton<IPropertyCustomFieldRepository, PropertyCustomFieldRepository>();
            services.AddSingleton<IPersonCustomFieldRepository, PersonCustomFieldRepository>();
            services.AddSingleton<IPropertyTotalRepository, PropertyTotalRepository>();
            services.AddSingleton<IcampaigndatasourceRepository, campaigndatasourceRepository>();
            //services.AddSingleton<ICampaignDateRangeRepository, CampaignDateRangeRepository>();
            //services.AddSingleton<ICampaignDateTypeRepository, CampaignDateTypeRepository>();
            services.AddSingleton<ICampaignRecipientTypeRepository, CampaignRecipientTypeRepository>();
            services.AddSingleton<ICampaignReportRepository, CampaignReportRepository>();
            services.AddSingleton<ICampaignCompanyRepository, CampaignCompanyRepository>();
            services.AddSingleton<ICampaignOfficeRepository, CampaignOfficeRepository>();
            //services.AddSingleton<ICampaignReportParametersRepository, CampaignReportParametersRepository>();
            services.AddSingleton<ICampaignRecipientListRepository, CampaignRecipientListRepository>();
            services.AddSingleton<ICampaignRecipientListDetailRepository, CampaignRecipientListDetailRepository>();
            services.AddSingleton<ICampaignScheduleRepository, CampaignScheduleRepository>();
            //services.AddSingleton<ICampaignTemplateRepository, CampaignTemplateRepository>();
            services.AddSingleton<IOfficeMlsRepository, OfficeMlsRepository>();
            services.AddSingleton<ICampaignLogRepository, CampaignLogRepository>();
            services.AddSingleton<IBudgetRepository, BudgetRepository>();
            services.AddSingleton<IBudgetYearRepository, BudgetYearRepository>();
            services.AddSingleton<IBudgetDetailRepository, BudgetDetailRepository>();
            services.AddSingleton<ICertificationRoleRequirementRepository, CertificationRoleRequirementRepository>();
            services.AddSingleton<IPersonDuplicatesRepository, PersonDuplicatesRepository>();
            services.AddSingleton<IReportLaunchedRepository,ReportLaunchedRepository>();
            services.AddSingleton<IPersonPreferenceRepository, PersonPreferenceRepository>();
            services.AddSingleton<IMigrationLogRepository, MigrationLogRepository>();
            services.AddSingleton<IDataProblemRepository, DataProblemRepository>();
            services.AddSingleton<IAppClientRepository, AppClientRepository>();
            services.AddSingleton<ICheckbookReportRepository, CheckbookReportRepository>();
            services.AddSingleton<IAnalyticsDashboardRepository, AnalyticsDashboardRepository>();
            services.AddSingleton<IPackageRepository, PackageRepository>();
            services.AddSingleton<IOfficeGoalReportRepository, OfficeGoalReportRepository>();
            services.AddSingleton<IPersonAreaOfSpecializationRepository, PersonAreaOfSpecializationRepository>();
            services.AddSingleton<IClientNewRepository, ClientNewRepository>();
            services.AddSingleton<ITokenRepository, TokenRepository>();
            services.AddSingleton<IApiEndpointRepository, ApiEndpointRepository>();
            services.AddSingleton<ICodeValueCategoryRepository, CodeValueCategoryRepository>();
            services.AddSingleton<IUIExceptionLogRepository, UIExceptionLogRepository>();
            services.AddSingleton<IFeedRelationshipRepository, FeedRelationshipRepository>();
            services.AddSingleton<IDataImportRepository, DataImportRepository>();
            services.AddSingleton<IDataImportRepository, DataImportRepository>();
            services.AddSingleton<IDataImportRepository, DataImportRepository>();
            services.AddSingleton<IAgentRepository, AgentRepository>();
            services.AddSingleton<IAgentAssignmentRepository, AgentAssignmentRepository>();
            services.AddSingleton<IAgentBankAccountTransactionRepository, AgentBankAccountTransactionRepository>();
            services.AddSingleton<IAgentCategoryRepository, AgentCategoryRepository>();
            services.AddSingleton<IMasterCategoryRepository, MasterCategoryRepository>(); 
            services.AddSingleton<ICompanyReportRepository, CompanyReportRepository>();
            services.AddSingleton<IOfficeReportRepository, OfficeReportRepository>();
            services.AddSingleton<ICodeValueReportRepository, CodeValueReportRepository>();
            services.AddSingleton<Repositories.AgentBooks.IClassificationRuleRepository, Repositories.AgentBooks.ClassificationRuleRepository>();
            services.AddSingleton<IAgentMessageRepository, AgentMessageRepository>();
            services.AddSingleton<IMessageTemplateRepository, MessageTemplateRepository>();
            services.AddSingleton<ITransactionMappingRepository, TransactionMappingRepository>();
            services.AddSingleton<IAgentBankRepository, AgentBankRepository>();
            services.AddSingleton<IAgentBankAccountRepository, AgentBankAccountRepository>();
            services.AddSingleton<IReconciliationFireRepository, ReconciliationFireRepository>();
            services.AddSingleton<IBankAccountRepository, BankAccountRepository>();
            services.AddSingleton<IBankTransactionRepository, BankTransactionRepository>();
            services.AddSingleton<Repositories.IClassificationRuleRepository, Repositories.ClassificationRuleRepository>();
            services.AddSingleton<IBankStreamRepository, BankStreamRepository>();
            services.AddSingleton<IPlaidRepository, PlaidRepository>();
            services.AddSingleton<ICompanyBankRepository, CompanyBankRepository>();
            services.AddSingleton<IWebhookRepository, WebhookRepository>();
            services.AddSingleton<ICustomControlRepository, CustomControlRepository>();
            services.AddSingleton<IFormControlRepository, FormControlRepository>();

            //services.AddSingleton<IOfficeFormRepository, OfficeFormRepository>();
            //services.AddSingleton<IPropertyTimelineTaskManualRepository, PropertyTimelineTaskManualRepository>();
            //services.AddSingleton<IPersonTimelineTaskManualRepository, PersonTimelineTaskManualRepository>();
            //services.AddSingleton<IPropertyDocumentRepository, PropertyDocumentRepository>();
            //services.AddSingleton<IPropertyDocumentHistoryRepository, PropertyDocumentHistoryRepository>();
            services.AddSingleton<ITaskRepository, TaskRepository>();

            services.AddSingleton<IOfficeFormRepository, OfficeFormRepository>();
            services.AddSingleton<IPropertyTimelineTaskManualRepository, PropertyTimelineTaskManualRepository>();
            services.AddSingleton<IPersonTimelineTaskManualRepository, PersonTimelineTaskManualRepository>();
            services.AddSingleton<IPropertyDocumentRepository, PropertyDocumentRepository>();
            services.AddSingleton<IPropertyEmailRepository, PropertyEmailRepository>();
            services.AddSingleton<IReportFavoriteRepository, ReportFavoriteRepository>();
            services.AddSingleton<IPropertyDocumentHistoryRepository, PropertyDocumentHistoryRepository>();
            services.AddSingleton<ITaskGroupRepository, TaskGroupRepository>();
            services.AddSingleton<IPersonManageRepository, PersonManageRepository>();
            services.AddSingleton<IPropertyPictureRepository, PropertyPictureRepository>();
            services.AddSingleton<IPropertyTourRepository, PropertyTourRepository>();
            services.AddSingleton<IPropertyMlsRepository, PropertyMlsRepository>();
            services.AddSingleton<IPersonDocumentRepository, PersonDocumentRepository>();
            services.AddSingleton<IUserPhoneRepository, UserPhoneRepository>();
            services.AddSingleton<IDatabasePackageRepository, DatabasePackageRepository>();
            services.AddSingleton<IDatabaseLoggedUserRepository, DatabaseLoggedUserRepository>();
            services.AddSingleton<IPersonMerchantRepository, PersonMerchantRepository>();
            services.AddSingleton<IDeductionSubplanRepository, DeductionSubplanRepository>();
            services.AddSingleton<IBillingGroupRepository, BillingGroupRepository>();
            services.AddSingleton<IHelpArticleRepository, HelpArticleRepository>();
            services.AddSingleton<ICompanySettingRepository, CompanySettingRepository>();
            services.AddSingleton<IDivideExpenseTemplateRepository, DivideExpenseTemplateRepository>();
            services.AddSingleton<IMxUserRepository, MxUserRepository>();
            services.AddSingleton<IMxRepository, MxRepository>();
            services.AddSingleton<IChatRoomRepository, ChatRoomRepository>();
            services.AddSingleton<IChatContactRepository, ChatContactRepository>();
            services.AddSingleton<IChatMessageRepository, ChatMessageRepository>();
            services.AddSingleton<IItemForSaleRepository, ItemForSaleRepository>();
            services.AddSingleton<IStoreOrderRepository, StoreOrderRepository>();
            services.AddSingleton<INotificationRepository, NotificationRepository>();
            services.AddSingleton<INotificationScheduleRepository, NotificationScheduleRepository>();
            services.AddSingleton<IForteRepository, ForteRepository>();          

            //// Inject an implementation of ISwaggerProvider with defaulted settings applied
            //services.AddSwaggerGen();

            //services.ConfigureSwaggerGen(options =>
            //{
            //    options.SingleApiVersion(new Info
            //    {
            //        Version = "v1",
            //        Title = "AccountTech 2017 API",
            //        Description = "A simple example ASP.NET Core Web API",
            //        TermsOfService = "None",
            //        Contact = new Contact { Name = "Shayne Boyer", Email = "", Url = "http://twitter.com/spboyer" },
            //        License = new License { Name = "Use under LICX", Url = "http://url.com" }
            //    });

            //    //Determine base path for the application.
            //    var basePath = PlatformServices.Default.Application.ApplicationBasePath;

            //    //Set the comments path for the swagger json and ui.
            //    var xmlPath = Path.Combine(basePath, "AT.AT2017.Api.xml");
            //    options.IncludeXmlComments(xmlPath);

            //});

            // disable dependency tracking or correlationId headers;
            // prevent x-ms-request-id and x-msrequest-root-id headers added automatically to request
            // Reference:
            // - https://blog.wille-zone.de/post/disable-application-insights-correlation-id-headers-on-httpclient-requests-in-aspnet-core/
            // - https://github.com/BorisWilhelms/AI-DependencyTracking/blob/master/src/AI-DependencyTracking/Program.cs 
            DisableDependencyTracking(services);
            // DisableCorrelationIdHeaders(services);
        }

        // This method gets called by the runtime. Use this method to configure the HTTP request pipeline.
        public void Configure(IApplicationBuilder app, IHostingEnvironment env, ILoggerFactory loggerFactory, IOptions<ApplicationSettings> appSettings)
        {
            // set logger factory
            loggerFactory.AddConsole(Configuration.GetSection("Logging"));
            loggerFactory.AddDebug();
            loggerFactory.AddFile("Logs/app-{Date}.txt");

            // get application settings
            ApplicationSettings settings = appSettings.Value;

            // customize application settings
            settings.SubmissionServiceURL = settings.SubmissionServiceURL.Replace("{SERVER_NAME}", Dns.GetHostName().ToLower());

            // get database user credentials (only for Windows platform)
            if (RuntimeInformation.IsOSPlatform(OSPlatform.Windows))
            {
                using (var key = Registry.LocalMachine.OpenSubKey(@"Software\AccountTech\Darwin"))
                {
                    // set user and password credentials
                    if (key?.GetValue("admin_user") != null)
                    {
                        settings.AdminUser = key?.GetValue("admin_user").ToString();
                    }
                    if (key?.GetValue("admin_pwd") != null)
                    {
                        settings.AdminPassword = Encoding.UTF8.GetString(Convert.FromBase64String(key?.GetValue("admin_pwd").ToString()));
                    }
                }
            }

            // using an exception page in developemnt enviroment
            if (env.IsDevelopment() || env.IsStaging())
            {
                app.UseDeveloperExceptionPage();
            }

            // Compression
            app.UseResponseCompression();

            // Cors
            app.UseCors(CorsOriginsPolicy);

            // custom error handling (AT2017)
            app.UseMiddleware(typeof(ErrorHandlingMiddleware));

            // custom authentication / authorization (AT2017)
            app.UseMiddleware<AuthorizationMiddleware>();

            // logging request and response
            if (settings.enableApiCallLog)
            {
                app.UseMiddleware<RequestResponseLoggingMiddleware>();
            }

            // use Mvc
            app.UseMvc(routes =>
            {
                routes.MapRoute(
                    name: "default",
                    template: "{controller=Home}/{action=Index}/{id?}");
            });

            app.UseCors(CorsDarwinClientPolicy);

            // use SignalR
            app.UseSignalR(route =>
            {
                route.MapHub<ChatHub>("/hubs/chat");
            });

            //// Enable middleware to serve generated Swagger as a JSON endpoint
            //app.UseSwagger();

            //// Enable middleware to serve swagger-ui assets (HTML, JS, CSS etc.)
            //app.UseSwaggerUi();

            app.UseHangfireDashboard();

        }

        /// <summary>
        /// Disables dependency tracking completely
        /// </summary>
        /// <param name="services"></param>
        private void DisableDependencyTracking(IServiceCollection services)
        {
            var module = services.FirstOrDefault(t => t.ImplementationFactory?.GetType() == typeof(Func<IServiceProvider, DependencyTrackingTelemetryModule>));
            if (module != null)
            {
                services.Remove(module);
            }
        }

        /// <summary>
        /// Dsiables correlation id headers, but leaves dependency tracking on
        /// </summary>
        /// <param name="services"></param>
        private void DisableCorrelationIdHeaders(IServiceCollection services)
        {
            var module = services.FirstOrDefault(t => t.ImplementationFactory?.GetType() == typeof(Func<IServiceProvider, DependencyTrackingTelemetryModule>));
            if (module != null)
            {
                services.Remove(module);
                services.AddSingleton<ITelemetryModule>(provider => new DependencyTrackingTelemetryModule() { SetComponentCorrelationHttpHeaders = false });
            }
        }

    }
}
    
```
## ArPaymentHandler.cs
```cs
using AT.AT2017.Api.Core.Exceptions;
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Repositories;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Classes
{
    public class ArPaymentHandler
    {
        public IArPaymentRepository _arPaymentRepository;
        public IGlobalSettingRepository _globalSettingRepository;
        public IGLAccountRepository _glAccountRepository;
        public IPersonMerchantRepository _personMerchantRepository;
        public ICompanyRepository _companyRepository;
        public IFortePaymentLogRepository _forteLogRepository;
        public ISettingRepository _settingRepository;
        public IPersonRepository _personRepository;

        public ArPaymentHandler(IArPaymentRepository arPaymentRepository, IGlobalSettingRepository globalSettingRepository, IGLAccountRepository glAccountRepository, ISettingRepository settingRepository, IPersonRepository personRepository, IPersonMerchantRepository personMerchantRepository, ICompanyRepository companyRepository, IFortePaymentLogRepository forteLogRepository)
        {
            _arPaymentRepository = arPaymentRepository;
            _globalSettingRepository = globalSettingRepository;
            _glAccountRepository = glAccountRepository;
            _personMerchantRepository = personMerchantRepository;
            _companyRepository = companyRepository;
            _forteLogRepository = forteLogRepository;
            _settingRepository = settingRepository;
            _personRepository = personRepository;
        }

        public ArPayment add(ArPayment item, int isForte)
        {
            ForteClient client = new ForteClient();
            int id = 0;
            bool isForteByAccount = false;

            Person person = _personRepository.get(item.personId);
            int personTypeId = person.personTypeId.GetValueOrDefault();

            if (isForte > 0)
            {
                IEnumerable<Setting> settingList = _settingRepository.search("", "", "Forte", "");
                Setting settingC = settingList.First(s => s.name == "ENABLE_FORTE_BY_ACCOUNT");
                if (settingC != null)
                    if (settingC.value.ToLower() == "true")
                        isForteByAccount = true;
            }

            if (isForteByAccount == false)
            {
                Company company = _companyRepository.get(item.companyId);
                if (isForte > 0 && string.IsNullOrEmpty(company.merchantID_CC))
                {
                    throw new System.Exception("The company doesn't have a valid Forte Merchant ID value. Please enter in Settings\\Settings screen to continue.");
                }

                id = _arPaymentRepository.add(item);
                item = _arPaymentRepository.get(id);

                //isForte = 0 no forte
                //isForte = 1 by credit card uses CCID
                //isForte = 2 by direct deposit uses ACHID

                if (isForte > 0)
                {
                   
                    string forteAchId, forteCcId;

                    forteAchId = "";
                    forteCcId = "";

                    if (isForte == 1)
                    {
                        forteCcId = person.forteCcId;
                    }
                    else
                    {
                        forteAchId = person.forteAchId;
                    }

                    client = new ForteClient(_settingRepository, _globalSettingRepository, _companyRepository, item.companyId, "sale");
                    FortePaymentLog result = client.payTransaction(item.receivedAmount, item.arPaymentId, person.forteClientId, "sale", forteAchId, forteCcId);
                    result.paymentId = item.arPaymentId;
                    result.paymentType = "AR";
                    result.paymethodType = (isForte == 2 ? "ACH" : "CC");

                    _forteLogRepository.add(result);

                    if (result.responseCode != "A01")
                    {
                        _arPaymentRepository.unpost(item.arPaymentId);
                        _arPaymentRepository.delete(item.arPaymentId);
                        throw new ForteException(result.responseDescription, result.responseCode, item.arPaymentId);
                    }
                }
            }
            else
            {
                if (isForte > 0)
                {
                    client = new ForteClient(_globalSettingRepository, _companyRepository, _glAccountRepository, _personMerchantRepository, 0, item.personId, item.companyId, isForte, "sale",personTypeId);
                }

                id = _arPaymentRepository.add(item);
                item = _arPaymentRepository.get(id);

                //isForte = 0 no forte
                //isForte = 1 by credit card uses CCID
                //isForte = 2 by direct deposit uses ACHID

                if (isForte > 0)
                {
                    FortePaymentLog result = client.payTransaction(item.receivedAmount, item.arPaymentId, "sale", (isForte == 2 ? true : false));
                    result.paymentId = item.arPaymentId;
                    result.paymentType = "AR";
                    result.paymethodType = (isForte == 2 ? "ACH" : "CC");

                    _forteLogRepository.add(result);

                    if (result.responseCode != "A01")
                    {
                        _arPaymentRepository.unpost(item.arPaymentId);
                        _arPaymentRepository.delete(item.arPaymentId);
                        throw new ForteException("FORTE: " + result.responseDescription, result.responseCode, item.arPaymentId);
                    }
                }
            }


            return item;
        }
    }
}

```
## CustomResult.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Shared;
using Microsoft.AspNetCore.Http;
using Microsoft.AspNetCore.Mvc;
using Newtonsoft.Json;
using Newtonsoft.Json.Serialization;

namespace AT.AT2017.Api.Classes
{
    public class CustomResult : BaseCustomResult
    {
        public CustomResult(object data, string [] includeColums = null, string[] ignoreColumns = null)
        {
            if (includeColums == null && ignoreColumns == null)
            {
                _data = data;
            }

            if (includeColums != null)
            {
                _data = include(data, includeColums);
            }

            if (includeColums == null && ignoreColumns != null)
            {
                _data = ignore(data, ignoreColumns);
            }
        }

    }

    public class CustomPagedResult<T> : BaseCustomResult
    {
        public CustomPagedResult(PagedList<T> pagedData, string[] includeColums = null, string[] ignoreColumns = null)
        {
            PagedList<object> _pagedData = new PagedList<object>();

            _pagedData.pageIndex = pagedData.pageIndex;
            _pagedData.pageSize = pagedData.pageSize;
            _pagedData.totalPages = pagedData.totalPages;
            _pagedData.totalCount = pagedData.totalCount;
            _pagedData.balance = pagedData.balance;
            _pagedData.additionalData = pagedData.additionalData;

            if (includeColums == null && ignoreColumns == null)
            {
                _pagedData.data = pagedData.data.ToList().Select(x => (object)x);
            }

            if (includeColums != null)
            {
                _pagedData.data = include(pagedData.data, includeColums) as IEnumerable<object>;
            }

            if (includeColums == null && ignoreColumns != null)
            {
                _pagedData.data = ignore(pagedData.data, ignoreColumns) as IEnumerable<object>;
            }

            _data = _pagedData;
        }
    }

    public class BaseCustomResult : IActionResult
    {
        protected object _data;

        async Task IActionResult.ExecuteResultAsync(ActionContext context)
        {
            var response = context.HttpContext.Response;
            response.ContentType = "application/json";
            await response.WriteAsync(JsonConvert.SerializeObject(_data));
        }

        protected object include(object item, params string[] includeColumns)
        {
            JsonSerializerSettings settings = new JsonSerializerSettings
            {
                NullValueHandling = NullValueHandling.Include
            };

            settings.ContractResolver = new IncludeFieldsResolver(includeColumns);

            return JsonConvert.DeserializeObject(JsonConvert.SerializeObject(item, settings));
        }

        protected object ignore(object item, params string[] ignoreColumns)
        {
            JsonSerializerSettings settings = new JsonSerializerSettings
            {
                NullValueHandling = NullValueHandling.Include
            };

            settings.ContractResolver = new IgnoreFieldsResolver(ignoreColumns);

            return JsonConvert.DeserializeObject(JsonConvert.SerializeObject(item, settings));
        }
    }

    public class IgnoreFieldsResolver : DefaultContractResolver
    {
        private readonly string[] _fieldsToIgnore;

        public IgnoreFieldsResolver(params string[] fieldsToIgnore)
        {
            _fieldsToIgnore = fieldsToIgnore;
        }

        protected override IList<JsonProperty> CreateProperties(Type type, MemberSerialization memberSerialization)
        {
            IList<JsonProperty> properties = base.CreateProperties(type, memberSerialization);

            // Ignore fields specified in constructor
            properties = properties.Where(p => !_fieldsToIgnore.Contains(p.PropertyName)).ToList();

            return properties;
        }
    }

    public class IncludeFieldsResolver : DefaultContractResolver
    {
        private readonly string[] _fieldsToInclude;

        public IncludeFieldsResolver(params string[] fieldsToInclude)
        {
            _fieldsToInclude = fieldsToInclude;
        }

        protected override IList<JsonProperty> CreateProperties(Type type, MemberSerialization memberSerialization)
        {
            IList<JsonProperty> properties = base.CreateProperties(type, memberSerialization);

            // Ignore fields specified in constructor
            properties = properties.Where(p => _fieldsToInclude.Contains(p.PropertyName)).ToList();

            return properties;
        }
    }

}

```
## Duo.cs
```cs
using System;
using System.Collections.Generic;
using System.IO;
using System.Net;
using System.Security.Cryptography;
using System.Text.RegularExpressions;
using System.Text;
//using System.Web.Script.Serialization;
using System.Web;
using System.Globalization;
using System.Linq;
using System.Runtime.InteropServices;


namespace AT.AT2017.Api.Classes
{
    public class DuoApi
    {
        public string DEFAULT_AGENT = "DuoAPICSharp/1.0";

        private const int INITIAL_BACKOFF_MS = 1000;
        private const int MAX_BACKOFF_MS = 32000;
        private const int BACKOFF_FACTOR = 2;
        private const int RATE_LIMIT_HTTP_CODE = 429;
        private string ikey;
        private string skey;
        private string host;
        private string url_scheme;
        private string user_agent;
        private SleepService sleepService;
        private RandomService randomService;

        /// <param name="ikey">Duo integration key</param>
        /// <param name="skey">Duo secret key</param>
        /// <param name="host">Application secret key</param>
        public DuoApi(string ikey, string skey, string host)
            : this(ikey, skey, host, null)
        {
        }

        /// <param name="ikey">Duo integration key</param>
        /// <param name="skey">Duo secret key</param>
        /// <param name="host">Application secret key</param>
        /// <param name="user_agent">HTTP client User-Agent</param>
        public DuoApi(string ikey, string skey, string host, string user_agent)
            : this(ikey, skey, host, user_agent, "https", new ThreadSleepService(), new SystemRandomService())
        {
        }

        protected DuoApi(string ikey, string skey, string host, string user_agent, string url_scheme,
                SleepService sleepService, RandomService randomService)
        {
            this.ikey = ikey;
            this.skey = skey;
            this.host = host;
            this.url_scheme = url_scheme;
            this.sleepService = sleepService;
            this.randomService = randomService;
            if (String.IsNullOrEmpty(user_agent))
            {
                this.user_agent = FormatUserAgent(DEFAULT_AGENT);
            }
            else
            {
                this.user_agent = user_agent;
            }
        }

        public static string FinishCanonicalize(string p)
        {
            // Signatures require upper-case hex digits.
            p = Regex.Replace(p,
                            "(%[0-9A-Fa-f][0-9A-Fa-f])",
                            c => c.Value.ToUpperInvariant());
            // Escape only the expected characters.
            p = Regex.Replace(p,
                            "([!'()*])",
                            c => "%" + Convert.ToByte(c.Value[0]).ToString("X"));
            p = p.Replace("%7E", "~");
            // UrlEncode converts space (" ") to "+". The
            // signature algorithm requires "%20" instead. Actual
            // + has already been replaced with %2B.
            p = p.Replace("+", "%20");
            return p;
        }

        public static string CanonicalizeParams(Dictionary<string, string> parameters)
        {
            var ret = new List<String>();
            foreach (KeyValuePair<string, string> pair in parameters)
            {
                string p = String.Format("{0}={1}",
                                         HttpUtility.UrlEncode(pair.Key),
                                         HttpUtility.UrlEncode(pair.Value));

                p = FinishCanonicalize(p);
                ret.Add(p);
            }
            ret.Sort(StringComparer.Ordinal);
            return string.Join("&", ret.ToArray());
        }


        // handle value as an object eg. next_offset = ["123", "fdajkld"]
        public static string CanonicalizeParams(Dictionary<string, object> parameters)
        {
            var ret = new List<String>();
            foreach (KeyValuePair<string, object> pair in parameters)
            {
                string p = "";
                if (pair.Value.GetType() == typeof(string[]))
                {
                    string[] values = (string[])pair.Value;
                    string value1 = values[0];
                    string value2 = values[1];
                    p = String.Format("{0}={1}&{2}={3}",
                                        HttpUtility.UrlEncode(pair.Key),
                                        HttpUtility.UrlEncode(value1),
                                        HttpUtility.UrlEncode(pair.Key),
                                        HttpUtility.UrlEncode(value2));
                }
                else
                {
                    string val = (string)pair.Value;
                    p = String.Format("{0}={1}",
                                        HttpUtility.UrlEncode(pair.Key),
                                        HttpUtility.UrlEncode(val));
                }
                p = FinishCanonicalize(p);
                ret.Add(p);
            }
            ret.Sort(StringComparer.Ordinal);
            return string.Join("&", ret.ToArray());
        }


        protected string CanonicalizeRequest(string method,
                                             string path,
                                             string canon_params,
                                             string date)
        {
            string[] lines = {
                date,
                method.ToUpperInvariant(),
                this.host.ToLower(),
                path,
                canon_params,
            };
            string canon = String.Join("\n",
                                       lines);
            return canon;
        }

        public string Sign(string method,
                           string path,
                           string canon_params,
                           string date)
        {
            string canon = this.CanonicalizeRequest(method,
                                                    path,
                                                    canon_params,
                                                    date);
            string sig = this.HmacSign(canon);
            string auth = this.ikey + ':' + sig;
            return "Basic " + DuoApi.Encode64(auth);
        }

        public string ApiCall(string method,
                              string path,
                              Dictionary<string, string> parameters)
        {
            HttpStatusCode statusCode;
            return ApiCall(method, path, parameters, 0, DateTime.UtcNow, out statusCode);
        }

        /// <param name="timeout">The request timeout, in milliseconds.
        /// Specify 0 to use the system-default timeout. Use caution if
        /// you choose to specify a custom timeout - some API
        /// calls (particularly in the Auth APIs) will not
        /// return a response until an out-of-band authentication process
        /// has completed. In some cases, this may take as much as a
        /// small number of minutes.</param>
        public string ApiCall(string method,
                              string path,
                              Dictionary<string, string> parameters,
                              int timeout,
                              out HttpStatusCode statusCode)
        {
            return ApiCall(method, path, parameters, 0, DateTime.UtcNow, out statusCode);
        }

        /// <param name="date">The current date and time, used to authenticate
        /// the API request. Typically, you should specify DateTime.UtcNow,
        /// but if you do not wish to rely on the system-wide clock, you may
        /// determine the current date/time by some other means.</param>
        /// <param name="timeout">The request timeout, in milliseconds.
        /// Specify 0 to use the system-default timeout. Use caution if
        /// you choose to specify a custom timeout - some API
        /// calls (particularly in the Auth APIs) will not
        /// return a response until an out-of-band authentication process
        /// has completed. In some cases, this may take as much as a
        /// small number of minutes.</param>
        public string ApiCall(string method,
                              string path,
                              Dictionary<string, string> parameters,
                              int timeout,
                              DateTime date,
                              out HttpStatusCode statusCode)
        {
            string canon_params = DuoApi.CanonicalizeParams(parameters);
            string query = "";
            if (!method.Equals("POST") && !method.Equals("PUT"))
            {
                if (parameters.Count > 0)
                {
                    query = "?" + canon_params;
                }
            }
            string url = string.Format("{0}://{1}{2}{3}",
                                       this.url_scheme,
                                       this.host,
                                       path,
                                       query);

            string date_string = DuoApi.DateToRFC822(date);
            string auth = this.Sign(method, path, canon_params, date_string);



            HttpWebResponse response = AttemptRetriableHttpRequest(
                method, url, auth, date_string, canon_params, timeout);
            StreamReader reader
                = new StreamReader(response.GetResponseStream());
            statusCode = response.StatusCode;
            return reader.ReadToEnd();
        }

        private HttpWebRequest PrepareHttpRequest(String method, String url, String auth, String date,
            String cannonParams, int timeout)
        {
            HttpWebRequest request = (HttpWebRequest)WebRequest.Create(url);
            request.Method = method;
            request.Accept = "application/json";
            request.Headers.Add("Authorization", auth);
            request.Headers.Add("X-Duo-Date", date);
            request.UserAgent = this.user_agent;
            // If no proxy, check for and use WinHTTP proxy as autoconfig won't pick this up when run from a service
            /*if (!HasProxyServer(request))
                request.Proxy = GetWinhttpProxy();*/

            if (method.Equals("POST") || method.Equals("PUT"))
            {
                byte[] data = Encoding.UTF8.GetBytes(cannonParams);
                request.ContentType = "application/x-www-form-urlencoded";
                request.ContentLength = data.Length;
                using (Stream requestStream = request.GetRequestStream())
                {
                    requestStream.Write(data, 0, data.Length);
                }
            }
            if (timeout > 0)
            {
                request.Timeout = timeout;
            }

            return request;
        }

        private HttpWebResponse AttemptRetriableHttpRequest(
            String method, String url, String auth, String date, String cannonParams, int timeout)
        {
            int backoffMs = INITIAL_BACKOFF_MS;
            while (true)
            {
                // Do the request and process the result.
                HttpWebRequest request = PrepareHttpRequest(method, url, auth, date, cannonParams, timeout);
                HttpWebResponse response;
                try
                {
                    response = (HttpWebResponse)request.GetResponse();
                }
                catch (WebException ex)
                {
                    response = (HttpWebResponse)ex.Response;
                    if (response == null)
                    {
                        throw;
                    }
                }

                if (response.StatusCode != (HttpStatusCode)RATE_LIMIT_HTTP_CODE || backoffMs > MAX_BACKOFF_MS)
                {
                    return response;
                }

                sleepService.Sleep(backoffMs + randomService.GetInt(1001));
                backoffMs *= BACKOFF_FACTOR;
            }
        }

       
        /// Helper to format a User-Agent string with some information about
        /// the operating system / .NET runtime
        /// <param name="product_name">e.g. "FooClient/1.0"</param>
        public static string FormatUserAgent(string product_name)
        {
            return String.Format(
                 "{0} ({1}; .NET {2})", product_name, System.Environment.OSVersion,
                 System.Environment.Version);
        }

        #region Private Methods
        private string HmacSign(string data)
        {
            byte[] key_bytes = ASCIIEncoding.ASCII.GetBytes(this.skey);
            HMACSHA1 hmac = new HMACSHA1(key_bytes);

            byte[] data_bytes = ASCIIEncoding.ASCII.GetBytes(data);
            hmac.ComputeHash(data_bytes);

            string hex = BitConverter.ToString(hmac.Hash);
            return hex.Replace("-", "").ToLower();
        }

        private static string Encode64(string plaintext)
        {
            byte[] plaintext_bytes = ASCIIEncoding.ASCII.GetBytes(plaintext);
            string encoded = System.Convert.ToBase64String(plaintext_bytes);
            return encoded;
        }

        private static string DateToRFC822(DateTime date)
        {
            // Can't use the "zzzz" format because it adds a ":"
            // between the offset's hours and minutes.
            string date_string = date.ToString(
                "ddd, dd MMM yyyy HH:mm:ss", CultureInfo.InvariantCulture);
            int offset = TimeZone.CurrentTimeZone.GetUtcOffset(date).Hours;
            string zone;
            // + or -, then 0-pad, then offset, then more 0-padding.
            if (offset < 0)
            {
                offset *= -1;
                zone = "-";
            }
            else
            {
                zone = "+";
            }
            zone += offset.ToString(CultureInfo.InvariantCulture).PadLeft(2, '0');
            date_string += " " + zone.PadRight(5, '0');
            return date_string;
        }

        /// <summary>
        /// Gets the WinHTTP proxy.
        /// </summary>
        /// <remarks>
        /// Normally, C# picks up these proxy settings by default, but when run under the SYSTEM account, it does not.
        /// </remarks>
        /// <returns></returns>
        private static System.Net.WebProxy GetWinhttpProxy()
        {
            string[] proxyServerNames = null;
            string primaryProxyServer = null;
            string[] bypassHostnames = null;
            bool enableLocalBypass = false;
            System.Net.WebProxy winhttpProxy = null;

            // Has a proxy been configured?
            // No.  Is a WinHTTP proxy set?
            int internetHandle = WinHttpOpen("DuoTest", WinHttp_Access_Type.WINHTTP_ACCESS_TYPE_DEFAULT_PROXY, null, null, 0);
            if (internetHandle != 0)
            {
                // Yes, use it.  This is normal when run under the SYSTEM account and a WinHTTP proxy is configured.  When run as a normal user,
                // the Proxy property will already be configured correctly.  To resolve this for SYSTEM, manually read proxy settings and configure.
                var proxyInfo = new WINHTTP_PROXY_INFO();
                WinHttpGetDefaultProxyConfiguration(proxyInfo);
                if (proxyInfo.lpszProxy != null)
                {
                    if (proxyInfo.lpszProxy != null)
                    {
                        proxyServerNames = proxyInfo.lpszProxy.Split(new char[] { ' ', '\t', ';' });
                        if ((proxyServerNames == null) || (proxyServerNames.Length == 0))
                            primaryProxyServer = proxyInfo.lpszProxy;
                        else
                            primaryProxyServer = proxyServerNames[0];
                    }
                    if (proxyInfo.lpszProxyBypass != null)
                    {
                        bypassHostnames = proxyInfo.lpszProxyBypass.Split(new char[] { ' ', '\t', ';' });
                        if ((bypassHostnames == null) || (bypassHostnames.Length == 0))
                            bypassHostnames = new string[] { proxyInfo.lpszProxyBypass };
                        if (bypassHostnames != null)
                            enableLocalBypass = bypassHostnames.Contains("local", StringComparer.InvariantCultureIgnoreCase);
                    }
                    if (primaryProxyServer != null)
                        winhttpProxy = new System.Net.WebProxy(proxyServerNames[0], enableLocalBypass, bypassHostnames);
                }
                WinHttpCloseHandle(internetHandle);
                internetHandle = 0;
            }
            else
            {
                throw new Exception(String.Format("WinHttp init failed {0}", System.Runtime.InteropServices.Marshal.GetLastWin32Error()));
            }

            return winhttpProxy;
        }

        /// <summary>
        /// Determines if the specified web request is using a proxy server.
        /// </summary>
        /// <remarks>
        /// If no proxy is set, the Proxy member is typically non-null and set to an object type that includes but hides IWebProxy with no address,
        /// so it cannot be inspected.  Resolving this requires reflection to extract the hidden webProxy object and check it's Address member.
        /// </remarks>
        /// <param name="requestObject">Request to check</param>
        /// <returns>TRUE if a proxy is in use, else FALSE</returns>
        public static bool HasProxyServer(HttpWebRequest requestObject)
        {
            WebProxy actualProxy = null;
            bool hasProxyServer = false;

            if (requestObject.Proxy != null)
            {
                // WebProxy is described as the base class for IWebProxy, so we should always see this type as the field is initialized by the framework.
                if (!(requestObject.Proxy is WebProxy))
                {
                    var webProxyField = requestObject.Proxy.GetType().GetField("webProxy", System.Reflection.BindingFlags.Instance | System.Reflection.BindingFlags.NonPublic | System.Reflection.BindingFlags.Public);
                    if (webProxyField != null)
                        actualProxy = webProxyField.GetValue(requestObject.Proxy) as WebProxy;
                }
                else
                {
                    actualProxy = requestObject.Proxy as WebProxy;
                }
                hasProxyServer = (actualProxy.Address != null);
            }
            else
            {
                hasProxyServer = false;
            }

            return hasProxyServer;
        }
        #endregion Private Methods

        #region Private DllImport
        private enum WinHttp_Access_Type
        {
            WINHTTP_ACCESS_TYPE_DEFAULT_PROXY = 0,
            WINHTTP_ACCESS_TYPE_NO_PROXY = 1,
            WINHTTP_ACCESS_TYPE_NAMED_PROXY = 3,
            /// <summary>
            /// Undocumented; supported on Win8.1+ per NET framework source.
            /// </summary>
            WINHTTP_ACCESS_TYPE_AUTOMATIC_PROXY = 4
        }

        [StructLayout(LayoutKind.Sequential)]
        private class WINHTTP_PROXY_INFO
        {
            public int dwAccessType;
            [MarshalAs(UnmanagedType.LPWStr)]
            public string lpszProxy;
            [MarshalAs(UnmanagedType.LPWStr)]
            public string lpszProxyBypass;
        }
        [DllImport("winhttp.dll", CharSet = CharSet.Unicode)]
        private static extern bool WinHttpGetDefaultProxyConfiguration([In, Out] WINHTTP_PROXY_INFO proxyInfo);

        [DllImport("winhttp.dll", CharSet = CharSet.Unicode)]
        private static extern int WinHttpOpen([MarshalAs(UnmanagedType.LPWStr)] string pwszUserAgent,
          WinHttp_Access_Type dwAccessType,
          [MarshalAs(UnmanagedType.LPWStr)] string pwszProxyName,
          [MarshalAs(UnmanagedType.LPWStr)] string pwszProxyBypass,
          int dwFlags);

        [DllImport("winhttp.dll", CharSet = CharSet.Unicode)]
        private static extern bool WinHttpCloseHandle(int hInternet);
        #endregion Private DllImport
    }

    [Serializable]
    public class DuoException : Exception
    {
        public int HttpStatus { get; private set; }    
        public string message { get; private set; }

        public DuoException(int http_status, string message, Exception inner)
            : base(message, inner)
        {
            this.HttpStatus = http_status;
        }

        public DuoException( string message)
          : base(message)
        {           
            this.message = message;
        }

        protected DuoException(System.Runtime.Serialization.SerializationInfo info,
                               System.Runtime.Serialization.StreamingContext ctxt)
            : base(info, ctxt)
        { }
    }

    [Serializable]
    public class ApiException : DuoException
    {
        public int Code { get; private set; }
        public string ApiMessage { get; private set; }
        public string ApiMessageDetail { get; private set; }

        public ApiException(int code,
                            int http_status,
                            string api_message,
                            string api_message_detail)
            : base(http_status, FormatMessage(code, api_message, api_message_detail), null)
        {
            this.Code = code;
            this.ApiMessage = api_message;
            this.ApiMessageDetail = api_message_detail;
        }

        protected ApiException(System.Runtime.Serialization.SerializationInfo info,
                               System.Runtime.Serialization.StreamingContext ctxt)
            : base(info, ctxt)
        { }

        private static string FormatMessage(int code,
                                            string api_message,
                                            string api_message_detail)
        {
            return String.Format(
                "Duo API Error {0}: '{1}' ('{2}')", code, api_message, api_message_detail);
        }
    }
     

    public interface SleepService
    {
        void Sleep(int ms);
    }

    public interface RandomService
    {
        int GetInt(int maxInt);
    }

    class ThreadSleepService : SleepService
    {
        public void Sleep(int ms)
        {
            System.Threading.Thread.Sleep(ms);
        }
    }

    class SystemRandomService : RandomService
    {
        private Random rand = new Random();

        public int GetInt(int maxInt)
        {
            return rand.Next(maxInt);
        }
    }
}

```
## DuoClient.cs
```cs
using System;
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Core.Models.Duo;
using System.Collections.Generic;
using AT.AT2017.Api.Core.Exceptions;
using System.Linq;

namespace AT.AT2017.Api.Classes
{
    public class DuoClient
    {
        private string _integrationKey;
        private string _secretKey;
        private string _adminIntegrationKey;
        private string _adminSecretKey;
        private string _hostApi;
        private string _darwinGroupId;

        public DuoClient(string integrationKey, string secretKey, string hostApi)
        {
            _integrationKey = integrationKey;
            _secretKey = secretKey;
            _hostApi = hostApi;
        }

        public DuoClient(string integrationKey, string secretKey, string hostApi, string adminIntegrationKey, string adminSecretKey, string groupId)
        {
            _integrationKey = integrationKey;
            _secretKey = secretKey;
            _hostApi = hostApi;
            _adminIntegrationKey = adminIntegrationKey;
            _adminSecretKey = adminSecretKey;
            _darwinGroupId = groupId;
        }

        private bool Enroll(User user,DuoApi api)
        {
            Dictionary<string, string> par = new Dictionary<string, string>();
            bool result = false;
            string response = "";

            try {

                user.DuoActivationBarCode ="";
                user.DuoActivationCode = "";
                user.DuoUserId = "";
                user.DuoResult = "";

                //enroll the new user
                par.Add("username", user.userName);
                response = api.ApiCall("POST", "/auth/v2/enroll", par);

                EnrollResponse obj = Newtonsoft.Json.JsonConvert.DeserializeObject<EnrollResponse>(response);

                if (obj.stat == "OK")
                {
                    EnrollResponseDetail detail = obj.response;
                    user.DuoActivationBarCode = detail.activation_barcode;
                    user.DuoActivationCode = detail.activation_code;
                    user.DuoUserId = detail.user_id;
                    user.DuoResult = "ENROLLED";

                    result = true;
                }
                else
                {
                    if (obj.message_detail != "username already exists")
                    {
                        //throw exception                   
                        throw new DuoException(obj.message_detail);
                    }                   
                }
            }
            catch (Exception e)
            {
                throw new DuoException(e.Message);
            }           

            return result;
        }

        public bool DeleteUser(string userName, DuoApi apiAdmin,bool getUserId)
        {
            Dictionary<string, string> par = new Dictionary<string, string>();
            bool result = false;
            string response = "";
            MainResponse obj;

            try
            {
                if (getUserId == true)
                {
                    par.Add("username", userName);
                    response = apiAdmin.ApiCall("GET", "/admin/v1/users", par);

                    UserResponse objUser = Newtonsoft.Json.JsonConvert.DeserializeObject<UserResponse>(response);

                    if (objUser.stat == "OK")
                    {
                        IEnumerable<UserResponseDetail> detail = objUser.response;
                        UserResponseDetail item = detail.First();

                        if (item != null)
                        {
                            userName = item.user_id;
                        }
                    }
                }

                par.Clear();
                response = apiAdmin.ApiCall("DELETE", "/admin/v1/users/" + userName, par);
                obj = Newtonsoft.Json.JsonConvert.DeserializeObject<MainResponse>(response);

                if (obj.stat == "OK")
                {
                    result = true;
                 }
            }
            catch (Exception e)
            {
                throw new DuoException(e.Message);
             }    

            return result;
        }

        public void UserAddGroup(DuoApi apiAdmin, string userId,string groupId)
        {
            Dictionary<string, string> par = new Dictionary<string, string>();       
            string response = "";
            string url = "/admin/v1/users/" + userId + "/groups";
        
            try
            {
                par.Add("group_id", groupId);
                response = apiAdmin.ApiCall("POST", url, par);
            }
            catch (Exception e)
            {
                throw new DuoException(e.Message);
            }
        }

        public bool Login(User user)
        {
            Dictionary<string, string> par = new Dictionary<string, string>();
            bool result = false;
            string response = "";
            MainResponse obj;           

            try
            {
                DuoApi api = new DuoApi(_integrationKey, _secretKey, _hostApi);

                DuoApi apiAdmin = new DuoApi(_adminIntegrationKey, _adminSecretKey, _hostApi);

                if (user.DuoUserId == null  || user.DuoUserId == "")
                {
                    //1. if user has no duo user ID then start the enrollment process
                    if (this.Enroll(user, api))
                    {
                        //2.if SUCESSS then assign duo user to Darwin group
                        this.UserAddGroup(apiAdmin, user.DuoUserId, _darwinGroupId);
                        return true;
                    }
                    else
                    {
                        //username already exists ->delete it and enroll it again
                        if (this.DeleteUser(user.userName, apiAdmin, true))
                        {
                            //enroll again
                            if (this.Enroll(user, api))
                            {
                                this.UserAddGroup(apiAdmin, user.DuoUserId, _darwinGroupId);
                                return true;
                            }
                        }
                    }
                }

                //3. validate enrollment process
                par.Clear();
                par.Add("user_id", user.DuoUserId);
                par.Add("activation_code", user.DuoActivationCode);
                response = api.ApiCall("POST", "/auth/v2/enroll_status", par);

                 obj = Newtonsoft.Json.JsonConvert.DeserializeObject<MainResponse>(response);

                if (obj.stat == "OK")
                {
                    if (obj.response == "waiting")
                    {
                        //error message ans show the QR url
                        throw new UnauthorizedException(UnauthorizedException.reasonType.DuoEnrollmentWaiting,user.DuoActivationBarCode);
                    }

                    if (obj.response == "invalid")
                    {
                        //delete user
                        if (this.DeleteUser(user.DuoUserId,apiAdmin,false))
                        {
                            //enroll again
                            if (this.Enroll(user, api))
                            {
                                this.UserAddGroup(apiAdmin, user.DuoUserId, _darwinGroupId);
                                return true;
                            }
                        }                       
                    }

                    if (obj.response == "success")
                    {
                        //auth
                        par.Clear();
                        par.Add("user_id", user.DuoUserId);
                        response = api.ApiCall("POST", "/auth/v2/preauth", par);

                        PreAuthResponse objAuth = Newtonsoft.Json.JsonConvert.DeserializeObject<PreAuthResponse>(response);

                        if (objAuth.stat == "OK")
                        {
                            PreAuthResponseDetail detail = objAuth.response;

                            if (detail.result == "auth")
                            {
                                //return the devices list
                                user.DuoDevices = detail.devices;
                                user.DuoResult = "AUTHORIZED";
                                result = true;
                            }                          
                        }
                        else
                        {
                            throw new DuoException(objAuth.message);
                        }
                    }
                   
                }
                else
                {
                    //throw exception                   
                    throw new DuoException(obj.message);
                }

            }           
            catch (DuoException e)
            {
                throw e;
            }
            catch (UnauthorizedException e)
            {
                throw e;
            }
            catch (Exception e)
            {
                throw new DuoException(e.Message);
            }

            return result;
        }

        public bool Authorize(string duoUserID,string factor,string device,string passcode,string waiting)
        {
            Dictionary<string, string> par = new Dictionary<string, string>();
            bool result = false;
            string response = "";
            PreAuthResponse objR=new PreAuthResponse();            

            try
            {
                DuoApi api = new DuoApi(_integrationKey, _secretKey, _hostApi);
                par.Add("user_id", duoUserID);
                par.Add("factor", factor);
                //par.Add("async", "1");

                if (factor == "auto" || factor == "phone" || factor == "sms" || factor == "push")
                {
                    par.Add("device", device);
                }
              else
                {
                    par.Add("passcode", passcode);
                }
      
                response = api.ApiCall("POST", "/auth/v2/auth", par);

                objR = Newtonsoft.Json.JsonConvert.DeserializeObject<PreAuthResponse>(response);

                if (objR.stat == "OK")
                {
                    string resultStatus = objR.response.result;

                    if (factor == "sms")
                    {
                        if (objR.response.result == "deny" && objR.response.status == "sent")
                        {
                            result = true;
                        }
                        else
                        {
                            if (objR.response.status_msg != null)
                                throw new DuoException(objR.response.status_msg);
                        }
                    }
                    else {
                        if (resultStatus == "allow")
                        {
                            result = true;
                        }
                        else
                        {
                            if (objR.response.status_msg != null)
                                throw new DuoException(objR.response.status_msg);
                        }
                    }
                    
                }
                else
                {
                    //throw exception                   
                    throw new DuoException(objR.message);
                }

                /* obj = Newtonsoft.Json.JsonConvert.DeserializeObject<AuthResponse>(response);

                 if (obj.stat == "OK")
                 {
                     par.Clear();
                     par.Add("txid", obj.response.txid);
                     string resultStatus = "";

                     while (resultStatus!="allow" && resultStatus != "deny")
                     {
                         response = api.ApiCall("GET", "/auth/v2/auth_status", par);
                         objR = Newtonsoft.Json.JsonConvert.DeserializeObject<PreAuthResponse>(response);

                         if (objR.stat == "OK")
                         {
                             resultStatus = objR.response.result;                           
                         }
                         System.Threading.Thread.Sleep(2000);
                     }

                     if (resultStatus == "allow")
                     {
                         result = true;
                     }
                     else
                     {
                         if (objR.response.status_msg!=null)
                             throw new DuoException(objR.response.status_msg);
                     }
                 }
                 else
                 {
                     //throw exception                   
                     throw new DuoException(obj.message);                  
                 }*/
            }

            catch (DuoException e)
            {
                throw e;
            }
            catch (Exception e)
            {
                throw e;
            }

            return result;
        }
    }
}

```
## ForteClient.cs
```cs
using System;
using System.Net;
using System.Text;
using AT.AT2017.Api.Core.Models;
using System.IO;
using System.Net.Http;
using Newtonsoft.Json.Linq;
using Newtonsoft.Json;
using System.Security.Authentication;
using System.Collections.Generic;
using System.Linq;
using AT.AT2017.Api.Repositories;

namespace AT.AT2017.Api.Classes
{
    public class ForteClient
    {
        private string OrganizationId;
        private string LocationId;
        private string APIKey;
        private string APIId;
        private string ForteURI;
        private string ForteClientId;
        private string PersonPayMethod;
        private IForteRepository forteRepository;

        public ForteClient()
        {            
        }

        public ForteClient(string organizationId, string locationId, string apiKey, string apiId, string url)
        {
            ForteURI = url;
            OrganizationId = organizationId;
            LocationId = locationId;
            APIKey = apiKey;
            APIId = apiId;
        }

        #region Forte original    
        public ForteClient(ISettingRepository _settingRepository, IGlobalSettingRepository _globalSettingRepository, ICompanyRepository _companyRepository, int companyID, string action = "credit", IForteRepository _forteRepository = null)
        {
            this.forteRepository = _forteRepository;
            IEnumerable<Setting> settingList = _settingRepository.search("", "", "Forte", "");
            GlobalSetting setting;
            Setting settingC;
            string organizationId, locationId, apiKey, apiId, uri, name;

            IEnumerable<GlobalSetting> list = _globalSettingRepository.search();
            Company company = _companyRepository.get(companyID);

            if (action == "credit") locationId = company.merchantID_ACH.ToString();
            else locationId = string.IsNullOrEmpty(company.merchantID_CC) || company.merchantID_CC.ToString() == "0" ? company.merchantID_ACH.ToString() : company.merchantID_CC.ToString();

            setting = list.First(s => s.name == "FORTE_URI");
            uri = setting.value;

            if (company.taxRate > 0)
            {
                setting = list.First(s => s.name == "FORTE_OID_CANADA");
                organizationId = setting.value;

                setting = list.First(s => s.name == "FORTE_ID_CANADA");
                apiId = setting.value;

                setting = list.First(s => s.name == "FORTE_KEY_CANADA");
                apiKey = setting.value;
            }
            else
            {
                settingC = settingList.First(s => s.name == "NACHA_ACH_" + companyID.ToString());
                setting = list.First(s => s.name == "FORTE_OID");
                organizationId = setting.value;

                name = "FORTE_ACH_ID_" + companyID.ToString();
                settingC = settingList.First(s => s.name == name);
                apiId = settingC.value;

                name = "FORTE_ACH_KEY_" + companyID.ToString();
                settingC = settingList.First(s => s.name == name);
                apiKey = settingC.value;
            }

            this.ForteURI = uri;
            this.OrganizationId = organizationId;
            this.LocationId = locationId;
            this.APIKey = apiKey;
            this.APIId = apiId;

        }

        public FortePaymentLog payTransaction(decimal amount, int id, string forteClientId, string action, string personACHID, string personCCID)
        {
            FortePaymentLog result = new FortePaymentLog();
            paymentMethod resultPM = new paymentMethod();
            Transaction transaction = new Transaction();

            try
            {
                string resp = "";
                var clientHandler = new HttpClientHandler();
                clientHandler.SslProtocols = System.Security.Authentication.SslProtocols.Tls12;

                string url = this.ForteURI + "/organizations/org_" + this.OrganizationId + "/locations/loc_" + this.LocationId + "/transactions";
                HttpClient client = new HttpClient(clientHandler);
                client.DefaultRequestHeaders.Add("Authorization", "Basic " + Convert.ToBase64String(Encoding.UTF8.GetBytes(this.APIId + ":" + this.APIKey)).Trim());
                client.DefaultRequestHeaders.Add("X-Forte-Auth-Organization-Id", "org_" + this.OrganizationId);

                //{"action":"credit","authorization_amount": 109.49,"customer_token":"cst_3723524","order_number":"AP1","reference_id":"1212"}
                string payMethod = "";
                if (action == "credit")
                {
                    payMethod = personACHID;
                }
                else
                {
                    payMethod = string.IsNullOrEmpty(personCCID) ? personACHID : personCCID;
                }

                //get the info of echeck payment method
                if (string.IsNullOrEmpty(personACHID) == false && payMethod == personACHID)
                {
                    string urlPM = this.ForteURI + "/organizations/org_" + this.OrganizationId + "/locations/loc_" + this.LocationId + "/paymethods/mth_" + payMethod;
                    HttpResponseMessage responsePM = client.GetAsync(urlPM).Result;
                    resp = responsePM.Content.ReadAsStringAsync().Result;
                    resultPM = Newtonsoft.Json.JsonConvert.DeserializeObject<paymentMethod>(resp);

                    eCheck ech = new eCheck();

                    if (resultPM.paymethod_token != null)//return paymethod's info
                    {
                        if (resultPM.echeck != null && string.IsNullOrEmpty(resultPM.echeck.account_type) == false)
                        {
                            ech.sec_code = "PPD";
                            ech.routing_number = resultPM.echeck.routing_number;
                            ech.account_number = resultPM.echeck.masked_account_number;
                            ech.account_type = resultPM.echeck.account_type;
                        }
                        else
                        {
                            //error: It's a valid payment method but does not have echeck
                            throw new Exception("The payment method " + payMethod + " does not have the ECheck configured");
                        }
                    }
                    else
                    {
                        JObject jresp = JObject.Parse(resp);
                        var respErr = (string)jresp["response"]["response_desc"];
                        if (string.IsNullOrEmpty(respErr) == false)
                        {
                            throw new Exception(respErr);
                        }
                    }
                    transaction.echeck = ech;
                }

                transaction.action = action;
                transaction.authorization_amount = amount;
                transaction.customer_token = "cst_" + forteClientId.ToString();
                transaction.order_number = id.ToString();
                transaction.reference_id = id.ToString();
                if (string.IsNullOrEmpty(payMethod) == false)
                {
                    transaction.paymethod_token = "mth_" + payMethod;
                }

                string json = Newtonsoft.Json.JsonConvert.SerializeObject(transaction);
                var content = new StringContent(json, Encoding.UTF8, "application/json");

                HttpResponseMessage response = client.PostAsync(url, content).Result;
                resp = response.Content.ReadAsStringAsync().Result;
                result = Newtonsoft.Json.JsonConvert.DeserializeObject<FortePaymentLog>(resp);

                JObject o = JObject.Parse(resp);
                result.json = resp;

                if (response.IsSuccessStatusCode)
                {
                    result.authorization_code = (string)o["response"]["authorization_code"];
                    result.avs_result = (string)o["response"]["avs_result"];
                    result.customer_token = (string)o["response"]["customer_token"];
                    result.cvv_result = (string)o["response"]["cvv_result"];
                }

                if (o["response"]["response_code"] != null)
                    result.responseCode = (string)o["response"]["response_code"];
                else
                    result.responseCode = "";

                result.responseDescription = (string)o["response"]["response_desc"];
            }
            catch (Exception e)
            {
                result.responseDescription = e.Message;
            }

            return result;
        }

        #endregion Forte original

        #region Forte by account
        public ForteClient(IGlobalSettingRepository _globalSettingRepository, ICompanyRepository _companyRepository, IGLAccountRepository _gLAccountRepository,IPersonMerchantRepository _personMerchantRepository,int accountId,int personId, int companyId, int saleType, string action= "credit",int personTypeId=0)
        {            
            GlobalSetting setting;
            GLAccount bankAccount;
            PersonMerchant personForte;
            string organizationId, locationId,apiKey, apiId, uri;
            
            IEnumerable<GlobalSetting> list = _globalSettingRepository.searchSection("Forte");
            IEnumerable<PersonMerchant> listPersonMerchant = _personMerchantRepository.search(personId);
            IEnumerable<GLAccount> listAccount = _gLAccountRepository.search(companyId, "", "", "", "Checking","","",false);
            Company company = _companyRepository.get(companyId);           

            locationId = "";

            if (listPersonMerchant!=null && listPersonMerchant.Count()>0 )
            {
                if (action == "credit")
                {
                    //payment of voucher
                    //by direct deposit uses ACHID
                    //accountId is available
                    bankAccount = (from GLAccount pacc in listAccount
                                   join PersonMerchant pmch in listPersonMerchant
                                          on pacc.forteMerchantId.ToLower() equals pmch.merchantId.ToLower()  
                                   where pacc.accountId == accountId && string.IsNullOrEmpty(pmch.clientId) == false && string.IsNullOrEmpty(pmch.achId) == false
                                   select pacc).FirstOrDefault();

                    if (bankAccount != null)
                    {
                        personForte = listPersonMerchant.FirstOrDefault(s => s.merchantId == bankAccount.forteMerchantId && string.IsNullOrEmpty(s.achId) == false);

                        if (personForte != null)
                        {
                            locationId = bankAccount.forteMerchantId;
                            this.PersonPayMethod = personForte.achId;
                            this.ForteClientId = personForte.clientId;
                        }
                        else
                        {
                            //thow error
                            throw new System.Exception("This person doesn't have valid Forte credentials.");
                        }
                    }
                    else
                    {
                        //thow error
                        throw new System.Exception("The bank account doesn't have a valid Forte Merchant ID. Please go to Ledger\\Chart screen to continue.");
                    }
                }
                else
                {
                    //payment of invoices
                    //saleType = 1 by credit card uses CCID
                    //saleType = 2 by direct deposit uses ACHID
                    //in this case there is no an account,WE will use the personType
                    if (personTypeId > 0)
                    {
                        IEnumerable<GLAccountFortePersonType> listAccountPersonType = _gLAccountRepository.searchFortePersonType(0);

                        bankAccount = (from GLAccount acc in listAccount
                                       join PersonMerchant accM in listPersonMerchant
                                                          on acc.forteMerchantId.ToLower() equals accM.merchantId.ToLower()
                                       join GLAccountFortePersonType accPT in listAccountPersonType
                                                         on acc.accountId equals accPT.accountId
                                       where accPT.personTypeId == personTypeId
                                       select acc).FirstOrDefault();
                    }
                    else {
                        bankAccount = (from GLAccount acc in listAccount
                                       join PersonMerchant accM in listPersonMerchant
                                                          on acc.forteMerchantId.ToLower() equals accM.merchantId.ToLower()
                                       select acc).FirstOrDefault();
                    }

                    if (bankAccount == null)
                    {
                        //thow error
                        throw new System.Exception("There is no account configured with the customer's merchant id. Please go to Ledger\\Chart screen to continue.");
                    }
                    else
                    {
                        locationId = bankAccount.forteMerchantId;
                        if (saleType == 1)
                        {
                            personForte = listPersonMerchant.FirstOrDefault(s => s.merchantId == bankAccount.forteMerchantId && string.IsNullOrEmpty(s.clientId) == false && string.IsNullOrEmpty(s.ccId) == false);
                        }
                        else
                        {
                            personForte = listPersonMerchant.FirstOrDefault(s => s.merchantId == bankAccount.forteMerchantId && string.IsNullOrEmpty(s.clientId) == false && string.IsNullOrEmpty(s.achId) == false);
                        }

                        if (personForte != null)
                        {
                            if (saleType == 1)
                                this.PersonPayMethod = string.IsNullOrEmpty(personForte.ccId) == true ? personForte.achId : personForte.ccId;
                            if (saleType == 2)
                                this.PersonPayMethod = string.IsNullOrEmpty(personForte.achId) == true ? personForte.ccId : personForte.achId;

                            this.ForteClientId = personForte.clientId;
                        }
                        else
                        {
                            //thow error
                            throw new System.Exception("This customer doesn't have valid Forte credentials.");
                        }
                    }
                }
            }
            else {
                //thow error
                throw new System.Exception("This person doesn't have valid Forte credentials.");
            }
     
            setting = list.First(s => s.name == "FORTE_URI");
            uri = setting.value;

            if (company.taxRate > 0)//Canada's customers
            {
                setting = list.First(s => s.name == "FORTE_OID_CANADA");
                organizationId = setting.value;

                setting = list.First(s => s.name == "FORTE_ID_CANADA");
                apiId = setting.value;

                setting = list.First(s => s.name == "FORTE_KEY_CANADA");
                apiKey = setting.value;
            }
            else
            {
                setting = list.First(s => s.name == "FORTE_OID");
                organizationId = setting.value;

                setting = list.First(s => s.name == "FORTE_ID");
                apiId = setting.value;

                setting = list.First(s => s.name == "FORTE_KEY");
                apiKey = setting.value;
            }

            this.ForteURI = uri;
            this.OrganizationId = organizationId;
            this.LocationId = locationId;
            this.APIKey = apiKey;
            this.APIId = apiId;
           
        }       

        public FortePaymentLog payTransaction(decimal amount, int id,string action,bool isACH)
        {
            FortePaymentLog result = new FortePaymentLog();
            paymentMethod resultPM = new paymentMethod();
            Transaction transaction = new Transaction();

            try
            {
                string resp = "";
                var clientHandler = new HttpClientHandler();
                clientHandler.SslProtocols = System.Security.Authentication.SslProtocols.Tls12;

                string url = this.ForteURI + "/organizations/org_" + this.OrganizationId + "/locations/loc_" + this.LocationId + "/transactions";
                HttpClient client = new HttpClient(clientHandler);
                client.DefaultRequestHeaders.Add("Authorization", "Basic " + Convert.ToBase64String(Encoding.UTF8.GetBytes(this.APIId + ":" + this.APIKey)).Trim());
                client.DefaultRequestHeaders.Add("X-Forte-Auth-Organization-Id", "org_" + this.OrganizationId);

                //get the info of echeck payment method
                if (isACH==true)
                {
                    string urlPM = this.ForteURI + "/organizations/org_" + this.OrganizationId + "/locations/loc_" + this.LocationId + "/paymethods/mth_" + this.PersonPayMethod;
                    HttpResponseMessage responsePM = client.GetAsync(urlPM).Result;
                    resp = responsePM.Content.ReadAsStringAsync().Result;
                    resultPM = Newtonsoft.Json.JsonConvert.DeserializeObject<paymentMethod>(resp);

                    eCheck ech = new eCheck();

                    if (resultPM.paymethod_token != null)//return paymethod's info
                    {
                        if (resultPM.echeck != null && string.IsNullOrEmpty(resultPM.echeck.account_type) == false)
                        {
                            ech.sec_code = "PPD";
                            ech.routing_number = resultPM.echeck.routing_number;
                            ech.account_number = resultPM.echeck.masked_account_number;
                            ech.account_type = resultPM.echeck.account_type;
                        }
                        else
                        {
                            //error: It's a valid payment method but does not have echeck
                            throw new Exception("The payment method " + this.PersonPayMethod + " does not have the ECheck configured");
                        }
                    }
                    else
                    {
                        JObject jresp = JObject.Parse(resp);
                        var respErr = (string)jresp["response"]["response_desc"];
                        if (string.IsNullOrEmpty(respErr) == false)
                        {
                            throw new Exception(respErr);
                        }
                    }

                    transaction.echeck = ech;
                }

                transaction.action = action;
                transaction.authorization_amount = amount;
                transaction.customer_token = "cst_" + this.ForteClientId.ToString();
                transaction.order_number = id.ToString();
                transaction.reference_id = id.ToString();
                if (string.IsNullOrEmpty(this.PersonPayMethod) == false)
                {
                    transaction.paymethod_token = "mth_" + this.PersonPayMethod;
                }

                string json = Newtonsoft.Json.JsonConvert.SerializeObject(transaction);
                var content = new StringContent(json, Encoding.UTF8, "application/json");

                HttpResponseMessage response = client.PostAsync(url, content).Result;
                resp = response.Content.ReadAsStringAsync().Result;
                result = Newtonsoft.Json.JsonConvert.DeserializeObject<FortePaymentLog>(resp);

                JObject o = JObject.Parse(resp);
                result.json = resp;

                if (response.IsSuccessStatusCode)
                {
                    result.authorization_code = (string)o["response"]["authorization_code"];
                    result.avs_result = (string)o["response"]["avs_result"];
                    result.customer_token = (string)o["response"]["customer_token"];
                    result.cvv_result = (string)o["response"]["cvv_result"];
                }

                if (o["response"]["response_code"] != null)
                    result.responseCode = (string)o["response"]["response_code"];
                else
                    result.responseCode = "";

                result.responseDescription = (string)o["response"]["response_desc"];
            }
            catch (Exception e)
            {
                result.responseDescription = e.Message;
            }

            return result;
        }

        #endregion Forte by account

        #region Forte by merchant ID  
       
        public ForteClient(IGlobalSettingRepository _globalSettingRepository, ICompanyRepository _companyRepository, IGLAccountRepository _gLAccountRepository,string merchantId, IForteRepository _forteRepository = null)
        {
            this.forteRepository = _forteRepository;
            GlobalSetting setting;
            string organizationId, locationId, apiKey, apiId, uri;
            int  companyId;

            IEnumerable<GlobalSetting> list = _globalSettingRepository.searchSection("Forte");
            IEnumerable<GLAccount> listAccount = _gLAccountRepository.search(0, "", "", "", "Checking", "", "", false);
            GLAccount bankAccount = listAccount.First(s => s.forteMerchantId == merchantId);

            if (bankAccount == null)
            {
                //thow error
                throw new System.Exception("No account has been set up for Forte.");
            }

            companyId = bankAccount.companyId.GetValueOrDefault();

            var companies = _companyRepository.get(companyId);
           
            locationId = merchantId;           

            setting = list.First(s => s.name == "FORTE_URI");
            uri = setting.value;

            if (companies.taxRate>0) //Canada's customers          
            {
                setting = list.First(s => s.name == "FORTE_OID_CANADA");
                organizationId = setting.value;

                setting = list.First(s => s.name == "FORTE_ID_CANADA");
                apiId = setting.value;

                setting = list.First(s => s.name == "FORTE_KEY_CANADA");
                apiKey = setting.value;
            }
            else
            {
                setting = list.First(s => s.name == "FORTE_OID");
                organizationId = setting.value;

                setting = list.First(s => s.name == "FORTE_ID");
                apiId = setting.value;

                setting = list.First(s => s.name == "FORTE_KEY");
                apiKey = setting.value;
            }

            this.ForteURI = uri;
            this.OrganizationId = organizationId;
            this.LocationId = locationId;
            this.APIKey = apiKey;
            this.APIId = apiId;

        }
        #endregion

        #region Forte pay by email
        //For pay by Email
        public ForteClient(IGlobalSettingRepository _globalSettingRepository, ICompanyRepository _companyRepository, IGLAccountRepository _gLAccountRepository, IPersonMerchantRepository _personMerchantRepository, int personId, int companyId, int personTypeId, string merchantId,IForteRepository _forteRepository=null)
        {
            this.forteRepository = _forteRepository;

            GlobalSetting setting;
            GLAccount bankAccount;
            PersonMerchant personForte;
            string organizationId, locationId, apiKey, apiId, uri;

            IEnumerable<GlobalSetting> list = _globalSettingRepository.searchSection("Forte");
            IEnumerable<PersonMerchant> listPersonMerchant = _personMerchantRepository.search(personId);
            IEnumerable<GLAccount> listAccount = _gLAccountRepository.search(companyId, "", "", "", "Checking", "", "", false);
           
            Company company = _companyRepository.get(companyId);

            locationId = "";

            if (listPersonMerchant != null && listPersonMerchant.Count() > 0)
            {
                if (string.IsNullOrEmpty(merchantId))
                {
                    IEnumerable<GLAccountFortePersonType> listAccountPersonType = _gLAccountRepository.searchFortePersonType(0);
                    bankAccount = (from GLAccount acc in listAccount
                                   join PersonMerchant accM in listPersonMerchant
                                                       on acc.forteMerchantId.ToLower() equals accM.merchantId.ToLower()
                                   join GLAccountFortePersonType accPT in listAccountPersonType
                                                       on acc.accountId equals accPT.accountId 
                                   where accPT.personTypeId == personTypeId 
                                   select acc).FirstOrDefault();
                }
                else
                {
                    bankAccount = (from GLAccount acc in listAccount
                                   join PersonMerchant accM in listPersonMerchant
                                                       on acc.forteMerchantId.ToLower() equals accM.merchantId.ToLower()
                                   where accM.merchantId.ToLower() == merchantId.ToLower()
                                   select acc).FirstOrDefault();
                }
                                
                if (bankAccount != null)
                {
                    locationId = bankAccount.forteMerchantId;
                    this.ForteClientId = listPersonMerchant.FirstOrDefault(s => s.merchantId == bankAccount.forteMerchantId && string.IsNullOrEmpty(s.clientId) == false && (string.IsNullOrEmpty(s.achId) == false || string.IsNullOrEmpty(s.ccId) == false)).clientId;
                }
            }         

            setting = list.First(s => s.name == "FORTE_URI");
            uri = setting.value;

            if (company.taxRate > 0)//Canada's customers
            {
                setting = list.First(s => s.name == "FORTE_OID_CANADA");
                organizationId = setting.value;

                setting = list.First(s => s.name == "FORTE_ID_CANADA");
                apiId = setting.value;

                setting = list.First(s => s.name == "FORTE_KEY_CANADA");
                apiKey = setting.value;
            }
            else
            {
                setting = list.First(s => s.name == "FORTE_OID");
                organizationId = setting.value;

                setting = list.First(s => s.name == "FORTE_ID");
                apiId = setting.value;

                setting = list.First(s => s.name == "FORTE_KEY");
                apiKey = setting.value;
            }
           
            this.ForteURI = uri;
            this.OrganizationId = organizationId;
            this.LocationId = locationId;
            this.APIKey = apiKey;
            this.APIId = apiId;

        }

        public PaymentMethod getPaymethods(int personId,string forteCId ="")
        {
            var pm = new PaymentMethod();

            try
            {
                if (string.IsNullOrEmpty(this.ForteClientId)==false || string.IsNullOrEmpty(forteCId) == false)
                {
                    string resp = "";
                    var clientHandler = new HttpClientHandler();
                    clientHandler.SslProtocols = System.Security.Authentication.SslProtocols.Tls12;

                    string url = this.ForteURI + "/organizations/org_" + this.OrganizationId + "/locations/loc_" + this.LocationId + "/customers/cst_" + (string.IsNullOrEmpty(this.ForteClientId) ? forteCId : this.ForteClientId) + "/paymethods";
                    HttpClient client = new HttpClient(clientHandler);
                    client.DefaultRequestHeaders.Add("Authorization", "Basic " + Convert.ToBase64String(Encoding.UTF8.GetBytes(this.APIId + ":" + this.APIKey)).Trim());
                    client.DefaultRequestHeaders.Add("X-Forte-Auth-Organization-Id", "org_" + this.OrganizationId);

                    HttpResponseMessage response = client.GetAsync(url).Result;
                    resp = response.Content.ReadAsStringAsync().Result;
                    var result = Newtonsoft.Json.JsonConvert.DeserializeObject<resultPaymentMethod>(resp);

                    if (result != null && result.number_results > 0)
                    {
                        bool fillACH = false;
                        bool fillCC = false;                      
                        string paymenthodId = "";                      
                        string clienID = string.IsNullOrEmpty(this.ForteClientId) ? forteCId : this.ForteClientId;

                        foreach (paymentMethod item in result.results)
                        {
                            if (item.echeck != null && fillACH == false)
                            {
                                fillACH = true;
                                pm.labelACH = item.label;
                                pm.maskedAccountNumberACH = item.echeck.masked_account_number;
                                pm.last4AccountNumberACH = item.echeck.last_4_account_number;
                                pm.routingNumber = item.echeck.routing_number;
                                pm.accountType = item.echeck.account_type;
                                pm.accountHolder = item.echeck.account_holder;                               
                                paymenthodId = item.paymethod_token.Substring(4);

                                if(forteRepository != null) forteRepository.addPaymentMethod(personId, this.LocationId, clienID, "ACH", paymenthodId, item.is_default, pm.labelACH, pm.last4AccountNumberACH, pm.accountType, pm.routingNumber,"", pm.maskedAccountNumberACH, 0, 0,"",false,false, pm.accountHolder);
                            }
                            if (item.card != null && fillCC == false)
                            {
                                fillCC = true;
                                pm.labelCC = item.label;
                                pm.nameOnCard = item.card.name_on_card;
                                pm.last4AccountNumberCC = item.card.last_4_account_number;
                                pm.maskedAccountNumberCC = item.card.masked_account_number;
                                pm.expireMonth = item.card.expire_month;
                                pm.expireYear = item.card.expire_year;
                                pm.procurementCard = item.card.procurement_card;
                                pm.cardType = item.card.card_type;
                                pm.suppressAccountUpdate = item.card.suppress_account_update;                              
                                paymenthodId = item.paymethod_token.Substring(4);

                                if (forteRepository != null) forteRepository.addPaymentMethod(personId, this.LocationId, clienID, "CC", paymenthodId, item.is_default, pm.labelCC, pm.last4AccountNumberCC,"","",pm.nameOnCard ,pm.maskedAccountNumberCC,pm.expireYear,pm.expireMonth,pm.cardType, pm.procurementCard,pm.suppressAccountUpdate,"");
                            }                            
                        }
                    }
                }
            }
            catch (Exception e)
            {
                throw e;
            }

            return pm;


        }
        #endregion

        #region TP methods

        public string getCustomer(string id)
        {
            return this.exec(HttpMethod.Get, $"customers/cst_{id}");
        }

        public string createCustomer(PersonForte person)
        {
            var customer = new
            {
                first_name = person.firstName,
                last_name = person.lastName,
                company_name = person.companyName
                //addresses = new[]
                //{
                //    new {
                //        //"label": "Brown Shipping",
                //        //"first_name": "Emmett",
                //        //"last_name": "Brown",
                //        //"company_name": "Brown Associates",
                //        phone = person.phoneNumber,
                //        //"email": "e.brown@brown.net",
                //        shipping_address_type = "residential",
                //        address_type = "default_billing",
                //        physical_address = new {
                //            street_line1 = person.addressLine1,
                //            street_line2 = person.addressLine2,
                //            locality = person.city,
                //            region = person.state,
                //            postal_code = person.zip
                //        }
                //    }
                //}
            };

            var response = this.exec(HttpMethod.Post, "customers", customer,person.personID);
            JObject jObject = JObject.Parse(response);

            person.forteClientID = ((string)jObject["customer_token"]).Replace("cst_", string.Empty);

            if (!string.IsNullOrEmpty(person.addressLine1))
            {
                this.createAddress(person);
            }

            return person.forteClientID;
        }

        public void updateCustomer(PersonForte person)
        {
            if (!string.IsNullOrEmpty( person.addressLine1))
            {
                var customer = this.getCustomer(person.forteClientID);
                JObject jObject = JObject.Parse(customer);
                /*
                    JObject parsed = JObject.Parse(json);
                    JArray array = (JArray) jObject["addresses"];
                    Console.WriteLine(array.Count);
                 */
                var addressID = ((string)jObject["addresses"]?[0]?["address_token"])?.Replace("add_", string.Empty);

                if (string.IsNullOrEmpty(addressID))
                {
                    this.createAddress(person);
                }
                else
                {
                    this.updateAddress(addressID, person);
                }
            }
        }

        public void deleteCustomer(string id)
        {
            try
            {
                this.exec(HttpMethod.Delete, $"customers/cst_{id}");
            }
            catch { }
        }

        public void updateAddress(string id, PersonForte person)
        {
            var address = new
            {
                email = person.emailAddress,
                physical_address = new
                {
                    street_line1 = person.addressLine1,
                    street_line2 = person.addressLine2,
                    locality = person.city,
                    region = person.state,
                    postal_code = person.zip
                }
            };

            this.exec(HttpMethod.Put, $"customers/cst_{person.forteClientID}/addresses/add_{id}", address,person.personID);
        }

        public string createAddress(PersonForte person)
        {
            var address = new
            {
                email = person.emailAddress,
                address_type = "default_billing",        
                physical_address = new
                {
                    street_line1 = person.addressLine1,
                    street_line2 = person.addressLine2,
                    locality = person.city,
                    region = person.state,
                    postal_code = person.zip,
                }
            };

            var response = this.exec(HttpMethod.Post, $"customers/cst_{person.forteClientID}/addresses", address,person.personID);
            JObject jObject = JObject.Parse(response);

            return ((string)jObject["address_token"]).Replace("add_", string.Empty);
        }

        public string createCreditCard(PersonForte person)
        {
            var creditCard = new
            {
                //"notes":"Brwn Work Card",
                card = new
                {
                    name_on_card = person.ccNameOnCard,
                    card_type = person.ccCardType,
                    account_number = person.ccCardNumber,
                    expire_month = person.ccExpDateMonth,
                    expire_year = person.ccExpDateYear,
                    //card_verification_value = "123"
                }
            };

            var response = this.exec(HttpMethod.Post, $"customers/cst_{person.forteClientID}/paymethods", creditCard,person.personID);
            JObject jObject = JObject.Parse(response);

            return ((string)jObject["paymethod_token"]).Replace("mth_", string.Empty);
        }

        public string createECheck(PersonForte person)
        {
            var eCheck = new
            {
                //"notes":"Brwn echeck",
                echeck = new
                {
                    account_holder = person.achHolderName,
                    account_number = person.achAccountNumber,
                    routing_number = person.achRouterNumber,
                    account_type = person.achAccountType
                }
            };

            var response = this.exec(HttpMethod.Post, $"customers/cst_{person.forteClientID}/paymethods", eCheck, person.personID);
            JObject jObject = JObject.Parse(response);

            return ((string)jObject["paymethod_token"]).Replace("mth_", string.Empty);
        }

        public string getPaymentMethod(string id)
        {
            return this.exec(HttpMethod.Get, $"paymethods/mth_{id}");
        }

        public void deletePaymentMethod(string id)
        {
            try
            {
                this.exec(HttpMethod.Delete, $"paymethods/mth_{id}");

                forteRepository.deletePaymentMethod(id);
            }
            catch { }
        }

        private string exec(HttpMethod method, string endpoint, object request = null,int id=0)
        {
            string result = string.Empty;
            var response_desc = "";
            string err = "";
            string json = "";
            string url = "";
            try
            {
                var clientHandler = new HttpClientHandler();
                clientHandler.SslProtocols = SslProtocols.Tls12;

                url = $"{this.ForteURI}/organizations/org_{this.OrganizationId}/locations/loc_{this.LocationId}/{endpoint}";
                HttpClient client = new HttpClient(clientHandler);
                client.DefaultRequestHeaders.Add("Authorization", "Basic " + Convert.ToBase64String(Encoding.UTF8.GetBytes(this.APIId + ":" + this.APIKey)).Trim());
                client.DefaultRequestHeaders.Add("X-Forte-Auth-Organization-Id", "org_" + this.OrganizationId);

                StringContent content = null;
                if (request != null)
                {
                    json = JsonConvert.SerializeObject(request);
                    content = new StringContent(json, Encoding.UTF8, "application/json");
                }

                HttpResponseMessage response =
                    method == HttpMethod.Post ? client.PostAsync(url, content).Result :
                    method == HttpMethod.Put ? client.PutAsync(url, content).Result :
                    method == HttpMethod.Delete ? client.DeleteAsync(url).Result :
                    method == HttpMethod.Get ? client.GetAsync(url).Result :
                    throw new Exception();

                result = response.Content.ReadAsStringAsync().Result;
                response.EnsureSuccessStatusCode();

                return result;
            }
            catch (Exception e)
            {
                err = e.Message;

                if (!string.IsNullOrEmpty(result))
                {
                    var o = JObject.Parse(result);
                    response_desc = (string)o["response"]?["response_desc"];
                    throw new Exception(response_desc);
                }
                else
                {
                    throw e;
                }
            }
            finally
            {
                if (this.forteRepository != null)
                {
                    string t = "";
                    if (method == HttpMethod.Post) t = "POST ";
                    if (method == HttpMethod.Put) t = "PUT ";
                    if (method == HttpMethod.Delete) t = "DELETE ";
                    if (method == HttpMethod.Delete) t = "GET ";
                    url = t + url;

                    this.forteRepository.addLog(id,url, json, result,err);
                }
            }
        }

        #endregion TP methods
    }

    public class Transaction
    {
        public string action;
        public decimal authorization_amount;
        public string customer_token;
        public string order_number;
        public string reference_id;
        public string paymethod_token;
        public eCheck echeck;
    }

    public class TransactionNECH
    {
        public string action;
        public decimal authorization_amount;
        public string customer_token;
        public string order_number;
        public string reference_id;
        public string paymethod_token;
    }

    public class eCheck
    {
        public string account_holder;  
        public string sec_code;
        public string account_number;
        public string routing_number;
        public string account_type;
        public string masked_account_number;
        public string last_4_account_number;
    }


    public class card
    {
        public string name_on_card;
        public string last_4_account_number;
        public string masked_account_number;
        public int expire_month;
        public int expire_year;
        public string card_type;
        public bool procurement_card;
        public bool suppress_account_update;
    }

    public class paymentMethod
    {
        public string paymethod_token;
        public string customer_token;   
        public string label;
        public eCheck echeck;
        public card card;
        public bool is_default;
    }

    public class resultPaymentMethod
    {
        public int number_results;       
        public IEnumerable<paymentMethod> results;  
    }

    public class response
    {
        public string environment;
        public string response_desc;
    }
}




```
## RemaxClient.cs
```cs
using System;
using System.Text;
using AT.AT2017.Api.Core.Models;
using System.Net.Http;
using System.Collections.Generic;

namespace AT.AT2017.Api.Classes
{
    public class RemaxClient
    {
        private string Url;
        private string Usr;
        private string Pwd;

        public RemaxClient(string url, string usr, string pwd)
        {
            this.Url = url;
            this.Usr = usr;
            this.Pwd = pwd;
        }

        public RemaxApiLog saveStatistic( SaveStatisticInput item)
        {
            RemaxApiLog log = new RemaxApiLog();
            SaveStatisticOutput result = new SaveStatisticOutput();

            try
            {
                var clientHandler = new HttpClientHandler();
                string url = this.Url + "SaveStatistic";

                HttpClient client = new HttpClient(clientHandler);
                client.DefaultRequestHeaders.Add("Authorization", "Basic " + Convert.ToBase64String(Encoding.UTF8.GetBytes(this.Usr + ":" + this.Pwd)));

                var json = Newtonsoft.Json.JsonConvert.SerializeObject(item);
                var content = new StringContent(json, Encoding.UTF8, "application/json");
                log.jsonInput = json;

                HttpResponseMessage response = client.PostAsync(url, content).Result;
                response.EnsureSuccessStatusCode();

                var resp = response.Content.ReadAsStringAsync();
                log.jsonOutput = resp.Result;
                result = Newtonsoft.Json.JsonConvert.DeserializeObject<SaveStatisticOutput>(resp.Result);
            }
            catch (Exception e)
            {
                if (result == null)
                    result = new SaveStatisticOutput();

                result.success = false;
                result.errorMessage = e.Message;
            }
            finally
            {
                log.statisticId = result.statisticId;
                log.relatedStatisticId = result.relatedStatisticId;
                log.success = result.success;
                log.errorMessage = result.errorMessage;
            }

            return log;
        }
    }
}

```
## Response.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Classes
{
    public class ResultResponse
    {

        public int feedExecution { get; set; }
        public int feedId { get; set; }
        public int recordsProcess { get; set; }
        public int recordDone { get; set; }
        public int recordFailed { get; set; }
        public int propertyId { get; set; }
        public string message { get; set; }

    }
}

```
## TwilioClient.cs
```cs
using System;
using System.Net;
using System.Text;
using AT.AT2017.Api.Core.Models;
using System.IO;
using System.Net.Http;
using Newtonsoft.Json.Linq;
using Newtonsoft.Json;
using System.Security.Authentication;
using System.Collections.Generic;
using System.Linq;
using AT.AT2017.Api.Repositories;
using System.Net.Http.Headers;

namespace AT.AT2017.Api.Classes
{
    public class TwilioClient
    {
        private string accountId;
        private string token;
        private string fromNumber;
        private string api;
        private string smsBody;
        private string smsWelcomeBody;
        private string callBody;

        public TwilioClient( IGlobalSettingRepository _globalSettingRepository)
        {
             GlobalSetting setting;
            IEnumerable<GlobalSetting> list = _globalSettingRepository.searchSection("Twilio");

            setting = list.First(s => s.name == "TWILIO_ACCOUNT_ID");
            accountId = setting.value;

            setting = list.First(s => s.name == "TWILIO_AUTH_TOKEN");
            token = setting.value;

            setting = list.First(s => s.name == "TWILIO_PHONE_NUMBER");
            fromNumber = setting.value;

            setting = list.First(s => s.name == "TWILIO_API");
            api = setting.value;

            setting = list.First(s => s.name == "TWILIO_SMS_BODY");
            smsBody = setting.value;

            setting = list.First(s => s.name == "TWILIO_SMS_WELCOME_BODY");
            smsWelcomeBody = setting.value;

            setting = list.First(s => s.name == "TWILIO_CALL_BODY");
            callBody = setting.value;

        }

        public string SendCode(string toNumber,string typeCode,int typeMsg=1)
        {
            int code = new Random().Next(1111, 10000);
         
            try
            {
                var clientHandler = new HttpClientHandler();
         
                string endpoint = this.api + this.accountId  ;
                HttpContent content;
                string sms = typeMsg==1 ? smsBody : smsWelcomeBody;

                toNumber = toNumber.Trim();

                if (toNumber.StartsWith("+")==false)
                {
                    toNumber = "+" + toNumber;
                }

                if (typeCode == "SMS")
                {
                    endpoint = endpoint + "/Messages.json";

                    content = new FormUrlEncodedContent(
                    new List<KeyValuePair<string, string>> {
                        new KeyValuePair<string, string>("From",  this.fromNumber),
                        new KeyValuePair<string,string>("To",toNumber),
                        new KeyValuePair<string,string>("Body",string.Format(sms ,code))
                    });
                }
                else
                {
                    endpoint = endpoint + "/Calls.json";

                    content = new FormUrlEncodedContent(
                    new List<KeyValuePair<string, string>> {
                        new KeyValuePair<string, string>("From",  this.fromNumber),
                        new KeyValuePair<string,string>("To", toNumber),
                        new KeyValuePair<string,string>("Twiml",string.Format(callBody ,String.Format("{0:# # # #}", code)))
                    });
                }
                content.Headers.ContentType = new MediaTypeHeaderValue("application/x-www-form-urlencoded");
                content.Headers.ContentType.CharSet = "UTF-8";

                HttpClient client = new HttpClient(clientHandler);
                client.DefaultRequestHeaders.Add("Authorization", "Basic " + Convert.ToBase64String(Encoding.UTF8.GetBytes(this.accountId + ":" + this.token)).Trim());                          
                HttpResponseMessage response = client.PostAsync(endpoint, content).Result;
                 var resp = response.Content.ReadAsStringAsync();
            }
            catch (Exception e)
            {
                throw e;
            }

            return code.ToString() ;
        }
    }
}

```
## 1099ReconciliationController.cs
```cs
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Repositories;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Logging;
using System.Collections.Generic;
using AT.AT2017.Api.Classes;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class _1099ReconciliationController : Controller
    {
        public I1099ReconciliationRepository _repository;

        private ILogger<_1099ReconciliationController> _logger;

        public _1099ReconciliationController(I1099ReconciliationRepository repository, ILogger<_1099ReconciliationController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<_1099Reconciliation> search(int companyId =0, int year =0, string reconciled="")
        {
            return _repository.search(companyId, year, reconciled);
        }

        [HttpGet("searchBreakdown")]
        public IEnumerable<_1099ReconciliationDetail> searchBreakdown(int id, int personId,bool useCorporateTaxId)
        {
            return _repository.searchBreakdown(id,personId, useCorporateTaxId);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] _1099Reconciliation item)
        {
            int id = _repository.add(item);
             item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost("personAdd")]
        public IActionResult personAdd(int id, int personId, decimal amount)
        {
             _repository.personAdd(id,personId,amount);
            return new NoContentResult();
        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] _1099Reconciliation item)
        {
            if (item == null || item.reconciliationId != id)
            {
                return BadRequest();
            }

            _repository.update(item);       
            return new ObjectResult(item);
        }

        [HttpPut("refresh")]
        public IActionResult refresh(int id, string basedOn)
        {
            _repository.refresh(id, basedOn);
            var item = _repository.get(id);           
            return new ObjectResult(item);
        }

        [HttpGet("header")]
        public IActionResult getHeader(int id)
        {
            var item = _repository.getHeader(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpGet("detail/paginated")]
        public IActionResult searchDetailPaginated(int id, int pageIndex = 1, int pageSize = 50, string sortBy = "", string filterBy = "")
        {
            var detail = _repository.searchDetailPaginated(id, pageIndex, pageSize, sortBy, filterBy);

            return new CustomPagedResult<_1099ReconciliationDetail>(detail);

        }

        [HttpPut("refreshNoResult")]
        public IActionResult refreshNoResult(int id, string basedOn)
        {
            _repository.refresh(id, basedOn);           
            return new NoContentResult();
        }
       
    }
}

```
## AgentStoreItemController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class AgentStoreItemController : Controller
    {
        public IAgentStoreItemRepository _repository;
        private ILogger<AgentStoreItemController> _logger;

        public AgentStoreItemController(IAgentStoreItemRepository repository, ILogger<AgentStoreItemController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<AgentStoreItem> search()
        {
            return _repository.search();
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] AgentStoreItem item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] AgentStoreItem item)
        {
            if (item == null || item.agentStoreItemId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }
    }
}

```
## AgentTeamController.cs
```cs
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using System.Collections.Generic;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{

    [Route("api/[controller]")]
    public class AgentTeamController : Controller
    {

        public IAgentTeamRepository _repository;

        private ILogger<AgentTeamController> _logger;

        public AgentTeamController(IAgentTeamRepository repository, ILogger<AgentTeamController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<AgentTeam> search()
        {
            return _repository.search();
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] AgentTeam item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] AgentTeam item)
        {
            if (item == null || item.agentTeamId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }
    }
}

```
## AnalyticsDashboardController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Repositories;
using Microsoft.AspNetCore.Http;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Logging;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/analyticsdashboard")]
    public class AnalyticsDashboardController : Controller
    {
        private IAnalyticsDashboardRepository _repository;
        private ILogger<AnalyticsDashboardController> _logger;

        public AnalyticsDashboardController(IAnalyticsDashboardRepository repository, ILogger<AnalyticsDashboardController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<AnalyticsDashboard> search(string title = "", string url = "", bool applySecurity = false, int userID = 0)
        {
            return _repository.search(title, url, applySecurity, userID);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] AnalyticsDashboard item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] AnalyticsDashboard item)
        {
            if (item == null || item.dashboardID != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }

        [HttpGet("token")]
        public IActionResult getEmbedToken(int id, int userID)
        {
            var item = _repository.getEmbedToken(id, userID);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost("pbi/htmlviewer")]
        public AnalyticsDashboard getPBIReportHtml([FromBody] AnalyticsDashboard report)
        {
            return _repository.getPBIReportHtml(report.datasetID, report.groupID, report.reportGUID, report.url, report.userID);
        }

        [HttpGet("agentMetrics/{userID}")]
        public IActionResult getAgentMetrics(int userID, string startDate, string endDate)
        {
            var item = _repository.getAgentMetrics(userID, startDate, endDate);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }


    }
}
```
## ApiCallLogController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class ApiCallLogController : Controller
    {
        public IApiCallLogRepository _repository;
        private ILogger<ApiCallLogController> _logger;

        public ApiCallLogController(IApiCallLogRepository repository, ILogger<ApiCallLogController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<ApiCalllog> search(string dbName, string fromDate, string toDate, string basePath = "", string exceptionMessage = "")
        {
            return _repository.search(dbName, fromDate, toDate, basePath, exceptionMessage);
        }

        [HttpGet("activeconnections")]
        public IEnumerable<ActiveConnection> searchActiveConnections(string guid)
        {
            return _repository.searchActiveConnections(guid);
        }

        [HttpGet("record")]
        public ApiCalllog get(string guid)
        {
            return _repository.get(guid);
        }

        [HttpGet("cleanup")]
        public void cleanUp()
        {
            _repository.cleanUp();
        }
    }
}

```
## ApiEndpointController.cs
```cs
using System.Collections.Generic;
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Repositories;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Logging;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/ApiEndpoint")]
    public class ApiEndpointController : Controller
    {
        public IApiEndpointRepository _repository;
        private ILogger<ApiEndpointController> _logger;

        public ApiEndpointController(IApiEndpointRepository repository, ILogger<ApiEndpointController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<ApiEndpoint> search()
        {
            return _repository.search();
        }

    }
}
```
## ApPaymentController.cs
```cs
using System.Collections.Generic;
using System.Linq;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Exceptions;
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Classes;
using AT.AT2017.Api.Core.Shared;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class ApPaymentController : Controller
    {
        public IApPaymentRepository _repository;
        public IGlobalSettingRepository _globalSettingRepository;
        public IGLAccountRepository _glAccountRepository;       
        public IPersonMerchantRepository _personMerchantRepository;
        public IFortePaymentLogRepository _forteLogRepository;
        public ICompanyRepository _companyRepository;
        public ISettingRepository _settingRepository;
        public IPersonRepository _personRepository;
        private ILogger<ApPaymentController> _logger;

        public ApPaymentController(IApPaymentRepository repository, IGlobalSettingRepository globalSettingRepository, ISettingRepository settingRepository, IPersonRepository personRepository, ICompanyRepository companyRepository, IGLAccountRepository glAccountRepository, IPersonMerchantRepository personMerchantRepository,  IFortePaymentLogRepository forteLogRepository, ILogger<ApPaymentController> logger)
        {
            _repository = repository;
            _globalSettingRepository = globalSettingRepository;
            _glAccountRepository = glAccountRepository;
            _personMerchantRepository = personMerchantRepository;
            _forteLogRepository = forteLogRepository;
            _companyRepository = companyRepository;
            _settingRepository = settingRepository;
            _personRepository = personRepository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<ApPayment> search(int companyId,int personId = 0, int apPaymentId = 0, string checkNumber="",decimal amount=0,int accountId = 0, string posted = "", string cleared = "", string reconciled = "", string fromDate = "", string toDate = "", int propertyId =0,string memo="", int pageIndex = 0, int pageSize = 10, bool withTrash = false)
        {            
            return _repository.search(companyId, personId, apPaymentId,checkNumber,amount, accountId,posted, fromDate, toDate, cleared,reconciled , propertyId,memo, pageIndex, pageSize, withTrash);
        }

        [HttpGet("searchDuplicateCheckNumber")]
        public IEnumerable<ApPayment> searchDuplicateCheckNumber(int companyId, string checkNumber, int accountId)
        {
            return _repository.searchDuplicateCheckNumber(companyId, checkNumber,  accountId);
        }

        [HttpGet("deleted")]
        public IEnumerable<ApPayment> searchDeletedRecord(int pageIndex = 0, int pageSize = 10)
        {
            return _repository.searchDeletedRecord(pageIndex, pageSize);
        }

        [HttpGet("searchPrint")]
        public IEnumerable<ApPayment> searchPrint(int companyId=0, int accountId=0, string checkNumberFrom="", string checkNumberTo="")
        {
            return _repository.searchPrint( companyId,  accountId,  checkNumberFrom,  checkNumberTo);
        }

        [HttpGet("searchprint/paginated")]
        public PagedList<ApPayment> searchPrintPaginated(int companyId = 0, int accountId = 0, string checkNumberFrom = "", string checkNumberTo = "", int pageIndex = 1, int pageSize = 10)
        {
            return _repository.searchPrintPaginated(companyId, accountId, checkNumberFrom, checkNumberTo, pageIndex, pageSize);
        }

        [HttpGet("overpayment")]
        public IEnumerable<Voucher> validateOverpayment(int id)
        {
            return _repository.validateOverpayment(id);
        }

        [HttpGet("searchDirects")]
        public IEnumerable<ApPayment> searchDirects(string date)
        {
            return _repository.searchDirects(date);
        }
        
        [HttpGet("getNextCheckNumber")]
        public string getNextCheckNumber(int accountId = 0)
        {
            return _repository.getNextCheckNumber(accountId);
        }

        [HttpPost]
        public IActionResult add([FromBody] ApPayment item, bool isDirectDeposit)
        {
            if (item == null)
            {
                return BadRequest();
            }

            ForteClient client = new ForteClient();
            int id = 0;
            bool isForteByAccount = false;

            if (isDirectDeposit == true)
            { 
                IEnumerable<Setting> settingList = _settingRepository.search("", "", "Forte", "");
                Setting settingC = settingList.First(s => s.name == "ENABLE_FORTE_BY_ACCOUNT");
                if (settingC != null)
                    if (settingC.value.ToLower() =="true")
                        isForteByAccount = true;
            }

            if (isForteByAccount == false)
            {
                Company company = _companyRepository.get(item.companyId);
                if (isDirectDeposit == true && string.IsNullOrEmpty(company.merchantID_ACH))
                {
                    throw new System.Exception("The company doesn't have a valid Forte Merchant ID value. Please enter in Settings\\Settings screen to continue.");
                }

                id = _repository.add(item);
                item = _repository.get(id);

                if (isDirectDeposit == true)
                {
                    Person person = _personRepository.get(item.personId.GetValueOrDefault());
                    client = new ForteClient(_settingRepository, _globalSettingRepository, _companyRepository, item.companyId, "credit");
                    FortePaymentLog result = client.payTransaction(item.paidAmount, item.apPaymentId, person.forteClientId, "credit", person.forteAchId, person.forteCcId);
                    result.paymentId = item.apPaymentId;
                    result.paymentType = "AP";
                    result.paymethodType = "ACH";

                    _forteLogRepository.add(result);

                    if (result.responseCode != "A01")
                    {
                        _repository.unpost(item.apPaymentId);
                        _repository.delete(item.apPaymentId);
                        throw new ForteException(result.responseDescription, result.responseCode, item.apPaymentId);
                    }
                }
            }
            else
            {
                if (isDirectDeposit == true)
                {
                    client = new ForteClient(_globalSettingRepository, _companyRepository, _glAccountRepository, _personMerchantRepository, item.bankAccountId.GetValueOrDefault(), item.personId.GetValueOrDefault(), item.companyId, 0, "credit");
                }

                id = _repository.add(item);
                item = _repository.get(id);

                if (isDirectDeposit == true)
                {
                    FortePaymentLog result = client.payTransaction(item.paidAmount, item.apPaymentId, "credit", true);

                    result.paymentId = item.apPaymentId;
                    result.paymentType = "AP";
                    result.paymethodType = "ACH";

                    _forteLogRepository.add(result);

                    if (result.responseCode != "A01")
                    {
                        _repository.unpost(item.apPaymentId);
                        _repository.delete(item.apPaymentId);
                        throw new ForteException(result.responseDescription, result.responseCode, item.apPaymentId);
                    }
                }
            }

            return new ObjectResult(item);

        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] ApPayment item)
        {
            if (item == null || item.apPaymentId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpPut("voiding/{id}")]
        public IActionResult voiding(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.voiding(id);

            return new NoContentResult();
        }

        [HttpPut("updateTemplate")]
        public IActionResult updateTemplate(int id, int templateId)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.updateTemplate(id,templateId);

            return new NoContentResult();
        }

        [HttpPut("updatePaymentDate")]
        public IActionResult updatePaymentDate(int id, string paymentDate)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.updatePaymentDate(id, paymentDate);

            return new NoContentResult();
        }

        [HttpPut("updateCheckNumber")]
        public IActionResult updateCheckNumber(int id, string checkNumber)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.updateCheckNumber(id, checkNumber);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }
        [HttpPut("post/{id}")]
        public IActionResult post(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.post(id);

            return new NoContentResult();
        }

        [HttpPut("unpost/{id}")]
        public IActionResult unpost(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.unpost(id);

            return new NoContentResult();
        }

        [HttpPut("applycredit")]
        public IActionResult applyCredit(int customerId, int bankAccountId, decimal amount, string date, int companyId, string checkNumber)
        {
            int id = _repository.applyCredit(customerId, bankAccountId, amount, date, companyId, checkNumber);
            ApPayment item = _repository.get(id);
            return new ObjectResult(item);
        }

        [HttpPut("print/{id}")]
        public IActionResult print(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.print(id);

            return new NoContentResult();
        }

        [HttpGet("postingProperty")]
        public IEnumerable<ApPayment> searchPostingProperty(int propertyId)
        {
            return _repository.searchPostingProperty(propertyId);
        }
    }
}

```
## ApPaymentScannedImageController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using AT.AT2017.Api.Core.Models;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Validation;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/apPayment/scannedimage")]
    public class ApPaymentScannedImageController : Controller
    {
        public IApPaymentScannedImageRepository _repository;
        private ILogger<ApPaymentScannedImageController> _logger;

        public ApPaymentScannedImageController(IApPaymentScannedImageRepository repository, ILogger<ApPaymentScannedImageController> logger)
        {
            _repository = repository;
            _logger = logger;
        }
        
        [HttpGet]
        public IEnumerable<ApPaymentScannedImage> search(int apPaymentID)
        {
            return _repository.search(apPaymentID);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] ApPaymentScannedImage item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }
        
        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] ApPaymentScannedImage item)
        {
            if (item == null || item.scannedImageID != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }
    }
}

```
## ApPaymentScannedImageViewHistoryController.cs
```cs
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using System.Collections.Generic;
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/apPayment/scannedimage/history")]
    public class ApPaymentScannedImageViewHistoryController : Controller
    {
        public IApPaymentScannedImageViewHistoryRepository _repository;

        private ILogger<ApPaymentScannedImageViewHistoryController> _logger;

        public ApPaymentScannedImageViewHistoryController(IApPaymentScannedImageViewHistoryRepository repository, ILogger<ApPaymentScannedImageViewHistoryController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<ApPaymentScannedImage> search(int scannedImageID)
        {
            return _repository.search(scannedImageID);
        }

        [HttpPost]
        public IActionResult add([FromBody] ApPaymentScannedImage item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item.scannedImageID);

            //item = _repository.get(id);
            return new ObjectResult(item);

        }
    }
}
```
## AppClientController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Repositories;
using Microsoft.AspNetCore.Http;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Logging;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class AppClientController : Controller
    {
        public IAppClientRepository _repository;
        private ILogger<IAppClientRepository> _logger;

        public AppClientController(IAppClientRepository repository, ILogger<IAppClientRepository> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<AppClient> search(string name = "", int databaseID = 0)
        {
            return _repository.search(name, databaseID);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] AppClient item)
        {
            int id = _repository.add(item.name, item.clientID, item.clientSecret, item.allowedIps, item.databaseID);

            item = _repository.get(id);

            return new ObjectResult(item);
        }

        [HttpPut]
        public IActionResult update([FromBody] AppClient item)
        {
             _repository.update(item.appClientID, item.name, item.clientID, item.clientSecret, item.allowedIps, item.modifyBy);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }

        [HttpPost("endpoint")]
        public int addEndpoint([FromBody] AppClientEndpoint item)
        {
            return _repository.addEndpoint(item);
        }

        [HttpDelete("endpoint")]
        public void deleteEndpoint(int appClientID, int endpointID)
        {
            _repository.deleteEndpoint(appClientID, endpointID);
        }

    }
}
```
## AppFileController.cs
```cs
using HtmlAgilityPack;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Logging;
using Newtonsoft.Json;
using Newtonsoft.Json.Linq;
using System.Data;
using System.IO;
using System.Net;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class AppFileController : Controller
    {
        private ILogger<AppFileController> _logger;

        public AppFileController(ILogger<AppFileController> logger)
        {
            _logger = logger;
        }

        [HttpGet]
        public DataTable search(string searchTerms, string apiUrl)
        {
            // build result datatable
            DataTable dtResult = new DataTable();
            dtResult.Columns.Add(new DataColumn("record_id"));
            dtResult.Columns.Add(new DataColumn("property_address"));

            // set apiUrl
            apiUrl = apiUrl + string.Format("?action=search&search_terms={0}", searchTerms);

            WebRequest request = WebRequest.Create(apiUrl);
            WebResponse response = request.GetResponse();

            string jsonResponse = "";
            using (Stream dataStream = response.GetResponseStream())
            {
                // Open the stream using a StreamReader for easy access.
                StreamReader reader = new StreamReader(dataStream);
                // Read the content.
                jsonResponse = reader.ReadToEnd();
            }

            if (jsonResponse != "")
            {
                dynamic stuff = JsonConvert.DeserializeObject(jsonResponse);
                if (stuff.search_results != null) {
                    JArray resultsRecords = stuff.search_results;
                    foreach (JObject item in resultsRecords)
                    {
                        dynamic property = JsonConvert.DeserializeObject(item.ToString());

                        // get record_id and appFileName Html
                        string recordID = property.form_recordID;
                        string appFileNameHtml = property.appfile_name__HTML;

                        HtmlDocument document = new HtmlDocument();
                        document.LoadHtml(appFileNameHtml);
                        HtmlNodeCollection collection = document.DocumentNode.SelectNodes("//a");
                        if (collection.Count > 0)
                        {
                            HtmlNode a = collection[0];
                            string propertyAddress = a.InnerText;

                            // add row
                            DataRow row = dtResult.NewRow();
                            row["record_id"] = recordID;
                            row["property_address"] = propertyAddress;
                            dtResult.Rows.Add(row);
                        }
                    }

                }
            }

            return dtResult;
        }

    }
}
```
## ArPaymentController.cs
```cs
using System.Collections.Generic;
using System.Linq;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Exceptions;
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Classes;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class ArPaymentController : Controller
    {
        public IArPaymentRepository _repository;
        public IGlobalSettingRepository _globalSettingRepository;
        public IGLAccountRepository _glAccountRepository;
        public IPersonMerchantRepository _personMerchantRepository;
        public ICompanyRepository _companyRepository;
        public IFortePaymentLogRepository _forteLogRepository;
        private ILogger<ArPaymentController> _logger;
        public ISettingRepository _settingRepository;
        public IPersonRepository _personRepository;

        public ArPaymentController(IArPaymentRepository repository, IGlobalSettingRepository globalSettingRepository, IGLAccountRepository glAccountRepository, ISettingRepository settingRepository, IPersonRepository personRepository, IPersonMerchantRepository personMerchantRepository, ICompanyRepository companyRepository, IFortePaymentLogRepository forteLogRepository, ILogger<ArPaymentController> logger)
        {
            _repository = repository;
            _globalSettingRepository = globalSettingRepository;
            _glAccountRepository = glAccountRepository;
            _personMerchantRepository = personMerchantRepository;
            _companyRepository = companyRepository;
            _forteLogRepository = forteLogRepository;
            _settingRepository = settingRepository;
            _personRepository = personRepository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<ArPayment> search(int companyId, int accountID = 0, int personId = 0, decimal amount = 0, string fromDate = "", string toDate = "", string posted = "", string deposited = "", int customerTypeId = 0, string method = "", int pageIndex = 0, int pageSize = 10, bool withTrash = false, int propertyId = 0, string memo = "", string checkNumber = "", string payee="")
        {
            return _repository.search(companyId,accountID, personId, amount, fromDate, toDate, posted, deposited,customerTypeId, method, pageIndex, pageSize, withTrash, propertyId, memo, checkNumber, payee);
        }

        [HttpGet("deleted")]
        public IEnumerable<ArPayment> searchDeletedRecord(int pageIndex = 0, int pageSize = 10)
        {
            return _repository.searchDeletedRecord(pageIndex, pageSize);
        }

        [HttpGet("searchUndeposited")]
        public IActionResult searchUndeposited(int companyId=0, int accountId=0, string fromDate = "", string toDate = "", string paymentMethod = "", string includeColumns = null, string ignoreColumns = null)
        {
            IEnumerable<ArPayment> arPayments = _repository.searchUndeposited(companyId, accountId, fromDate, toDate, paymentMethod);
            return new CustomResult(arPayments, includeColumns?.Split(","), ignoreColumns?.Split(","));
        }

        [HttpGet("searchUndeposited/paginated")]
        public IActionResult searchUndepositedPaginated(int companyId = 0, int accountId = 0, string fromDate = "", string toDate = "", string paymentMethod = "", string includeColumns = null, string ignoreColumns = null, int pageIndex = 1, int pageSize = 50, string sortBy = "", string filterBy = "")
        {
            var arPayments = _repository.searchUndepositedPaginated(companyId, accountId, fromDate, toDate, paymentMethod, pageIndex, pageSize, sortBy, filterBy);

            return new CustomPagedResult<ArPayment>(arPayments, includeColumns?.Split(","), ignoreColumns?.Split(","));
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] ArPayment item, int isForte)
        {
            if (item == null)
            {
                return BadRequest();
            }

            var arPaymentHandler = new ArPaymentHandler(this._repository, this._globalSettingRepository, this._glAccountRepository, this._settingRepository, this._personRepository, this._personMerchantRepository, this._companyRepository, this._forteLogRepository);
            item = arPaymentHandler.add(item, isForte);

            return new ObjectResult(item);
        }
        
        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] ArPayment item)
        {
            if (item == null || item.arPaymentId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpPut("updatePaymentMethod")]
        public IActionResult updatePaymentMethod([FromBody] ArPayment item)
        {
            _repository.updatePaymentMethod(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }

        [HttpPut("post/{id}")]
        public IActionResult post(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.post(id);

            return new NoContentResult();
        }

        [HttpPut("unpost/{id}")]
        public IActionResult unpost(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.unpost(id);

            return new NoContentResult();
        }

        [HttpPut("applycredit")]
        public IActionResult applyCredit(int customerId, decimal amount, string date, int companyId, string memo, string checkNumber)
        {
            int id = _repository.applyCredit(customerId, amount, date, companyId, memo, checkNumber);
            ArPayment item = _repository.get(id);
            return new ObjectResult(item);
        }

        [HttpPut("invoiceapplycreditsbyperson")]
        public IActionResult invoiceApplyCreditsbyPerson(int personId, string userName, int companyId, bool onlyLegacy, bool transaction, bool output, bool audit)
        {
            ArPayment item = _repository.invoiceApplyCreditsbyPerson(personId, userName, companyId, onlyLegacy, transaction, output, audit);

            return new ObjectResult(item);
        }

        [HttpGet("postingProperty")]
        public IEnumerable<ArPayment> searchPostingProperty(int propertyId)
        {
            return _repository.searchPostingProperty(propertyId);
        }

        [HttpPost("move/{id}")]
        public IActionResult move(int id, int propertyId)
        {
            _repository.move(id, propertyId);

            return new NoContentResult();
        }
    }
}

```
## ArPaymentScannedImageController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using AT.AT2017.Api.Core.Models;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Validation;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/arPayment/scannedimage")]
    public class ArPaymentScannedImageController : Controller
    {
        public IArPaymentScannedImageRepository _repository;
        private ILogger<ArPaymentScannedImageController> _logger;

        public ArPaymentScannedImageController(IArPaymentScannedImageRepository repository, ILogger<ArPaymentScannedImageController> logger)
        {
            _repository = repository;
            _logger = logger;
        }
        
        [HttpGet]
        public IEnumerable<ArPaymentScannedImage> search(int arPaymentID)
        {
            return _repository.search(arPaymentID);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] ArPaymentScannedImage item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }
        
        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] ArPaymentScannedImage item)
        {
            if (item == null || item.scannedImageID != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }
    }
}

```
## ArPaymentScannedImageViewHistoryController.cs
```cs
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using System.Collections.Generic;
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/arPayment/scannedimage/history")]
    public class ArPaymentScannedImageViewHistoryController : Controller
    {
        public IArPaymentScannedImageViewHistoryRepository _repository;

        private ILogger<ArPaymentScannedImageViewHistoryController> _logger;

        public ArPaymentScannedImageViewHistoryController(IArPaymentScannedImageViewHistoryRepository repository, ILogger<ArPaymentScannedImageViewHistoryController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<ArPaymentScannedImage> search(int scannedImageID)
        {
            return _repository.search(scannedImageID);
        }

        [HttpPost]
        public IActionResult add([FromBody] ArPaymentScannedImage item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item.scannedImageID);

            //item = _repository.get(id);
            return new ObjectResult(item);

        }
    }
}
```
## AuditTrailController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class AuditTrailController : Controller
    {

        public IAuditTrailRepository _repository;

        private ILogger<AuditTrailController> _logger;

        public AuditTrailController(IAuditTrailRepository repository, ILogger<AuditTrailController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<AuditTrail> search(int entityId, string tableName, string fromDate = "", string endDate = "", string userName = "", string changeType = "", string hostName = "", string appName = "")
        {
            return _repository.search(entityId, tableName, fromDate, endDate, userName, changeType, hostName, appName);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpGet("searchCodeValue")]
        public IEnumerable<AuditTrail> searchCodeValue(string category)
        {
            return _repository.searchCodeValue(category);
        }
    }
}

```
## AuthController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Exceptions;
using Microsoft.AspNetCore.Http;
using System.Text;
using Microsoft.Extensions.Options;
using AT.AT2017.Api.Classes;
using AT.AT2017.Api.Util;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class AuthController : Controller
    {
        private IAuthRepository _repository;
        private ILoginHistoryRepository _loginHistoryRepository;
        private IClientDeviceRepository _clientDeviceRepository;
        private IUserRepository _userRepository;
        private ILogger<AuthController> _logger;
        private HttpContext _context;
        private ApplicationSettings _appSettings;
        public IGlobalSettingRepository _globalSettingRepository;


        public AuthController(IAuthRepository repository, ILoginHistoryRepository loginHistoryRepository, IClientDeviceRepository clientDeviceRepository, IUserRepository userRepository, ILogger<AuthController> logger, IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings, IGlobalSettingRepository globalSettingRepository)
        {
            _repository = repository;
            _loginHistoryRepository = loginHistoryRepository;
            _clientDeviceRepository = clientDeviceRepository;
            _userRepository = userRepository;
            _logger = logger;
            _context = httpContextAccessor.HttpContext;
            _appSettings = appSettings.Value;
            _globalSettingRepository = globalSettingRepository;
        }

        [HttpPost("loginExternal/{t}")]
        public IActionResult loginExternal(string t)
        {
            // validate request
            if (t==null)
            {
                return BadRequest();
            }            
            
            // get remote IP address
            string ipAddress = _context.Connection.RemoteIpAddress.MapToIPv4().ToString();

            // create loginHistory record
            LoginHistory loginHistory = new LoginHistory();           

            User loggedUser = _repository.loginExternal(t);

            loginHistory.userName = loggedUser.userName;
            loginHistory.attemptFailed = false;
            loginHistory.ipAddress = ipAddress;

            if (loggedUser == null)
            {
                // add attempt failed to login history
                loginHistory.attemptFailed = true;
                _loginHistoryRepository.add(loginHistory);
                throw new UnauthorizedException(UnauthorizedException.reasonType.InvalidCredentials);
            }           

            // validate is database server configurate is valid (based on username)
            Server server = _repository.validateServer(loggedUser.userName);
            if (server == null)
            {
                throw new UnauthorizedException(UnauthorizedException.reasonType.ServerInvalid);
            }           

            // add success record to login history (all validation rules passed)
            _loginHistoryRepository.add(loginHistory);

            
            return new ObjectResult(loggedUser);
        }

        [HttpPost("login/{username}")]
        public IActionResult login(string username, [FromBody] UserCredentials user, bool resetToken = false)
        {
            // validate request
            if (username == null || user.userName.ToLower() != username.ToLower())
            {
                return BadRequest();
            }

            // validate clientID and clientSecret from headers
            string clientID = _context.Request.Headers["client_id"];
            string clientSecret = _context.Request.Headers["client_secret"];

            if (clientID == null)
            {
                throw new UnauthorizedException(UnauthorizedException.reasonType.ClientIDHeaderNotPresent);
            }

            if (clientSecret == null)
            {
                throw new UnauthorizedException(UnauthorizedException.reasonType.ClientSecretHeaderNotPresent);
            }

            clientID = Encoding.UTF8.GetString(Convert.FromBase64String(clientID));
            clientSecret = Encoding.UTF8.GetString(Convert.FromBase64String(clientSecret));

            // search clientID and clientSecret credentials in database
            AppClient appClient = _repository.validateClientCredentials(clientID, clientSecret);
            if (appClient == null)
            {
                throw new UnauthorizedException(UnauthorizedException.reasonType.ClientCredentialsInvalid);
            }

            // get remote IP address
            string ipAddress = _context.Connection.RemoteIpAddress.MapToIPv4().ToString();

            // create loginHistory record
            LoginHistory loginHistory = new LoginHistory();
            loginHistory.userName = user.userName;
            loginHistory.attemptFailed = false;
            loginHistory.ipAddress = ipAddress;

            // validate username and password
            User loggedUser = _repository.login(user.userName, user.userPassword, ipAddress, resetToken, appClient.appClientID);

            if (loggedUser == null)
            {
                // add attempt failed to login history
                loginHistory.attemptFailed = true;
                _loginHistoryRepository.add(loginHistory);
                throw new UnauthorizedException(UnauthorizedException.reasonType.InvalidCredentials);
            }

            // validate if user is locked
            if (loggedUser.locked)
            {
                throw new UnauthorizedException(UnauthorizedException.reasonType.UserAccountLocked, loggedUser.userId.GetValueOrDefault());
            }

            // validate if password has expired
            if (loggedUser.passwordExpired)
            {
                throw new UnauthorizedException(UnauthorizedException.reasonType.PasswordExpired, loggedUser.userId.GetValueOrDefault());
            }

            // validate is database server configurate is valid (based on username)
            Server server = _repository.validateServer(username);
            if (server == null)
            {
                throw new UnauthorizedException(UnauthorizedException.reasonType.ServerInvalid);
            }

            // validate IP address
            bool isIPAddressValid = false;
            List<string> allowedIpRanges = appClient.allowedIps.Split(";").ToList();
            foreach (string allowedIpRange in allowedIpRanges)
            {
                if (ipAddress.StartsWith(allowedIpRange.Replace("*", "")))
                {
                    isIPAddressValid = true;
                    break;
                }
            }

            if (!isIPAddressValid)
            {
                throw new UnauthorizedException(UnauthorizedException.reasonType.IPInvalid);
            }

            // if Darwin is not hosted, validate api_key header
            bool isHosted = true;
            isHosted = appClient.isHosted;
            if (isHosted == false)
            {
                // validate api_key header
                string apiKeyHeaderEncoded = _context.Request.Headers["api_key"];
                if (apiKeyHeaderEncoded == null)
                {
                    throw new UnauthorizedException(UnauthorizedException.reasonType.ApiKeyHeaderNotPresent);
                }

                // get api_key 
                string apiKey = Encoding.UTF8.GetString(Convert.FromBase64String(apiKeyHeaderEncoded));

                // validate apiKey when is_hosted = false
                Database database = _repository.validateApiKey(username, apiKey);
                if (database == null)
                {
                    throw new UnauthorizedException(UnauthorizedException.reasonType.ApiNotFound);
                }

                // validate device
                string deviceEncoded = _context.Request.Headers["client_device"];
                if (deviceEncoded != null)
                {
                    string device = Encoding.UTF8.GetString(Convert.FromBase64String(deviceEncoded));
                    ClientDevice device1 = Newtonsoft.Json.JsonConvert.DeserializeObject<ClientDevice>(device);
                    ClientDevice deviceValid = _clientDeviceRepository.get(device1.processorId, device1.computerName, database.dbName);

                    loginHistory.computerName = device1.computerName;
                    loginHistory.processorId = device1.processorId;

                    if (deviceValid == null)
                    {
                        _clientDeviceRepository.add(device1);
                        throw new UnauthorizedException(UnauthorizedException.reasonType.UnauthorizedDevice);
                    }
                    else
                    {
                        if (deviceValid.status == "PENDING")
                        {
                            throw new UnauthorizedException(UnauthorizedException.reasonType.PendingAuthorization);
                        }
                        if (deviceValid.status != "PENDING" && deviceValid.authorized == false)
                        {
                            throw new UnauthorizedException(UnauthorizedException.reasonType.AuthorizationDenied);
                        }
                    }
                }
                else
                {
                    loginHistory.computerName = "-";
                    loginHistory.processorId = "-";
                }
            }
            else
            {
                loginHistory.computerName = null;
                loginHistory.processorId = null;
            }

            // validate if the user has companies to access
            int companiesCount = _repository.getCompaniesCount(loggedUser.serverName, loggedUser.dbName, loggedUser.userId.GetValueOrDefault());
            if (companiesCount == 0)
            {
                throw new UnauthorizedException(UnauthorizedException.reasonType.NoCompanies);
            }

            // add success record to login history (all validation rules passed)
            _loginHistoryRepository.add(loginHistory);

            // validate if user must change his password (first login)
            if (loggedUser.lastPasswordDate == null || loggedUser.firstLogin)
            {
                throw new UnauthorizedException(UnauthorizedException.reasonType.FirstLogin, loggedUser.userId.GetValueOrDefault());
            }

            string skipDuo = _context.Request.Headers["skipDuo"];

            if (skipDuo != null && skipDuo == "0")
            {
                bool roleIsSkipDuo = _repository.skipDuo(loggedUser.serverName, loggedUser.dbName, loggedUser.userId.GetValueOrDefault());

                if (!roleIsSkipDuo)
                {
                    loggedUser.token = null;
                    List<UserPhone> listPhones = (List<UserPhone>)_repository.getMobiles(loggedUser.serverName, loggedUser.dbName, loggedUser.userId.GetValueOrDefault());

                    if (listPhones != null && listPhones.Count > 0)
                    {
                        loggedUser.userPhoneNumbers = listPhones.AsEnumerable();
                        loggedUser.authenticationResult = "ALLOWED";
                    }
                    else
                    {
                        loggedUser.authenticationResult = "NO_MOBILE";
                    }                                        
                }
                else
                    loggedUser.authenticationResult = "AUTHORIZED";
            }
            return new ObjectResult(loggedUser);
        }

        [HttpPost("login")]
        public IActionResult loginWidget(Widget widget)
        {
            string widgetID = _context.Request.Headers["widgetID"];

            if (widgetID == null)
            {
                throw new UnauthorizedException(UnauthorizedException.reasonType.WidgetIDHeaderNotPresent);
            }

            widgetID = Encoding.UTF8.GetString(Convert.FromBase64String(widgetID));

            // create loginHistory record
            LoginHistory loginHistory = new LoginHistory();
            loginHistory.attemptFailed = false;

            // get remote IP address
            string ipAddress = _context.Connection.RemoteIpAddress.MapToIPv4().ToString();

            // validate username and password
            User loggedUser = _repository.login(widgetID, ipAddress, false);

            if (loggedUser == null)
            {
                // add attempt failed to login history
                throw new UnauthorizedException(UnauthorizedException.reasonType.WidgetIDNotFound);
            }

            // complete userName
            loginHistory.userID = loggedUser.userId.GetValueOrDefault();
            loginHistory.userName = loggedUser.userName;

            // validate if user is locked
            if (loggedUser.locked)
            {
                throw new UnauthorizedException(UnauthorizedException.reasonType.UserAccountLocked, loggedUser.userId.GetValueOrDefault());
            }

            // validate if password has expired
            if (loggedUser.passwordExpired)
            {
                throw new UnauthorizedException(UnauthorizedException.reasonType.PasswordExpired, loggedUser.userId.GetValueOrDefault());
            }

            // validate is database server configurate is valid (based on username)
            Server server = _repository.validateServer(loggedUser.userName);
            if (server == null)
            {
                throw new UnauthorizedException(UnauthorizedException.reasonType.ServerInvalid);
            }

            // validate if the user has companies to access
            User userInfo = _userRepository.get(loggedUser.userId.GetValueOrDefault());
            if (userInfo != null)
            {
                if (userInfo.userCompanies.Count() == 0)
                {
                    throw new UnauthorizedException(UnauthorizedException.reasonType.NoCompanies);
                }
            }

            // add success record to login history (all validation rules passed)
            _loginHistoryRepository.add(loginHistory);

            // validate if user must change his password (first login)
            if (loggedUser.lastPasswordDate == null || loggedUser.firstLogin)
            {
                throw new UnauthorizedException(UnauthorizedException.reasonType.FirstLogin, loggedUser.userId.GetValueOrDefault());
            }

            return new ObjectResult(loggedUser);
        }

        [HttpPost("refresh-token")]
        public IActionResult refreshToken([FromBody] UserCredentials user)
        {
            // validate request
            if (user == null)
            {
                return BadRequest();
            }

            // validate userName and refreshToken
            string userName = user.userName;
            string refreshTokenBase64 = user.refreshToken;

            if (string.IsNullOrEmpty(userName))
            {
                throw new UnauthorizedException(UnauthorizedException.reasonType.UserNameNotPresent);
            }

            if (string.IsNullOrEmpty(refreshTokenBase64))
            {
                throw new UnauthorizedException(UnauthorizedException.reasonType.RefreshTokenNotPresent);
            }

            string refreshToken = Encoding.UTF8.GetString(Convert.FromBase64String(refreshTokenBase64));

            User loggedUser = _repository.refreshToken(userName, refreshToken);

            if (loggedUser == null)
            {
                throw new UnauthorizedException(UnauthorizedException.reasonType.RefreshTokenNotFound);
            }

            if (loggedUser.locked)
            {
                throw new UnauthorizedException(UnauthorizedException.reasonType.UserAccountLocked, loggedUser.userId.GetValueOrDefault());
            }

            var response = new { loggedUser.userName, loggedUser.token, loggedUser.tokenExpiration, loggedUser.refreshToken };

            return new ObjectResult(response);

        }

        [HttpPost("updatepassword/{username}")]
        public IActionResult updatePassword(string username, [FromBody] UserCredentials user)
        {
            // validate clientID and clientSecret from headers
            string clientID = _context.Request.Headers["client_id"];
            string clientSecret = _context.Request.Headers["client_secret"];

            clientID = Encoding.UTF8.GetString(Convert.FromBase64String(clientID));
            clientSecret = Encoding.UTF8.GetString(Convert.FromBase64String(clientSecret));

            if (clientID == null)
            {
                throw new UnauthorizedException(UnauthorizedException.reasonType.ClientIDHeaderNotPresent);
            }

            if (clientSecret == null)
            {
                throw new UnauthorizedException(UnauthorizedException.reasonType.ClientSecretHeaderNotPresent);
            }

            // search clientID and clientSecret credentials in database
            AppClient appClient = _repository.validateClientCredentials(clientID, clientSecret);
            if (appClient == null)
            {
                throw new UnauthorizedException(UnauthorizedException.reasonType.ClientCredentialsInvalid);
            }

            // get remote IP address
            string ipAddress = _context.Connection.RemoteIpAddress.MapToIPv4().ToString();

            // update password
            _repository.updatePassword(user);

            // login user with new credentials
            User item = _repository.login(user.userName, user.userPassword, ipAddress, false, appClient.appClientID);

            return new ObjectResult(item);
        }

        [HttpPost("hosted")]
        public bool hosted([FromBody] AppClient appClient)
        {
            return _repository.isHosted(appClient.clientID, appClient.clientSecret);
        }

        [HttpPost("getclientcredentials")]
        public IActionResult getClientCredentials([FromBody] AppClient appClient)
        {
            var item = _repository.validateClientCredentials(appClient.clientID, appClient.clientSecret);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPut("updateclientcredentials")]
        public IActionResult updateClientCredentials([FromBody] AppClient client)
        {
            _repository.updateClientCredentials(client);

            return new NoContentResult();
        }

        [HttpPost("widget")]
        public IActionResult getWidgetToken([FromBody] Widget widget)
        {
            string screen = widget.screen;
            int userID = widget.userID;
            string systemIDBase64 = widget.systemID;

            string systemID = Encoding.UTF8.GetString(Convert.FromBase64String(systemIDBase64));

            Guid systemIDGuid;
            bool isSystemIDValid = Guid.TryParse(systemID, out systemIDGuid);

            if (isSystemIDValid == false)
            {
                throw new Exception("The systemID is not a valid GUID");
            }

            Widget widgetToken = _repository.getWidgetToken(screen, userID, systemID);

            var plainTextBytes = Encoding.UTF8.GetBytes(widgetToken.token);
            string widBase64 = Convert.ToBase64String(plainTextBytes);

            string widgetUrl = _appSettings.DarwinCloudWidgetUrl;
            widgetUrl = widgetUrl.Replace("{WIDGET_ID}", widBase64);

            return new ObjectResult(new
            {
                widgetUrl
            });

        }

        [HttpPut("widget/uploadcss")]
        public IActionResult uploadCss([FromBody] ExternalSystem system)
        {
            string systemIDBase64 = system.systemID;
            string css = system.css;

            string systemID = Encoding.UTF8.GetString(Convert.FromBase64String(systemIDBase64));

            Guid systemIDGuid;
            bool isSystemIDValid = Guid.TryParse(systemID, out systemIDGuid);

            if (isSystemIDValid == false)
            {
                throw new Exception("The systemID is not a valid GUID");
            }

            _repository.updateExternalSystemCss(systemID, css);

            return new NoContentResult();

        }

        //get pass code
        [HttpPost("sendPassCode")]
        public IActionResult sendPassCode([FromBody] UserCredentials user, int id, string typeCode, string phoneNumber)
        {
            //send welcome sms
            TwilioClient client = new TwilioClient(_globalSettingRepository);
            string code = client.SendCode(phoneNumber, typeCode, 2);

            //save sent code
            string clientID = _context.Request.Headers["client_id"];
            string clientSecret = _context.Request.Headers["client_secret"];

            clientID = Encoding.UTF8.GetString(Convert.FromBase64String(clientID));
            clientSecret = Encoding.UTF8.GetString(Convert.FromBase64String(clientSecret));

            string ipAddress = _context.Connection.RemoteIpAddress.MapToIPv4().ToString();

            AppClient appClient = _repository.validateClientCredentials(clientID, clientSecret);
            User loggedUser = _repository.login(user.userName, user.userPassword, ipAddress, false, appClient.appClientID);
            _repository.updateCodeLogin(loggedUser.serverName, loggedUser.dbName, id, code);

            return new NoContentResult();
        }

        //validate pass code
        [HttpPost("validatePassCode")]
        public IActionResult validatePassCode([FromBody] UserCredentials user,int id, string enteredPassCode)
        {
            string clientID = _context.Request.Headers["client_id"];
            string clientSecret = _context.Request.Headers["client_secret"];

            clientID = Encoding.UTF8.GetString(Convert.FromBase64String(clientID));
            clientSecret = Encoding.UTF8.GetString(Convert.FromBase64String(clientSecret));

            string ipAddress = _context.Connection.RemoteIpAddress.MapToIPv4().ToString();

            AppClient appClient = _repository.validateClientCredentials(clientID, clientSecret);
            User loggedUser = _repository.login(user.userName, user.userPassword, ipAddress, false, appClient.appClientID);

            if (_repository.verifyMobileLogin(loggedUser.serverName, loggedUser.dbName, id,enteredPassCode))
            {
                loggedUser.authenticationResult = "AUTHORIZED";
            }
            else
            {
                List<UserPhone> listPhones = (List<UserPhone>)_repository.getMobiles(loggedUser.serverName, loggedUser.dbName, loggedUser.userId.GetValueOrDefault());
                loggedUser.userPhoneNumbers = listPhones.AsEnumerable();
                loggedUser.authenticationResult = "DENIED";
                loggedUser.token = null;
            }

            return new ObjectResult(loggedUser);
        }

        [HttpPost("addUserMobile")]
        public IActionResult addUserMobile([FromBody] UserCredentials user, string mobileCountryCode, string mobileNumber, string mobileName)
        {
            string clientID = _context.Request.Headers["client_id"];
            string clientSecret = _context.Request.Headers["client_secret"];

            clientID = Encoding.UTF8.GetString(Convert.FromBase64String(clientID));
            clientSecret = Encoding.UTF8.GetString(Convert.FromBase64String(clientSecret));

            string ipAddress = _context.Connection.RemoteIpAddress.MapToIPv4().ToString();

            AppClient appClient = _repository.validateClientCredentials(clientID, clientSecret);
            User loggedUser = _repository.login(user.userName, user.userPassword, ipAddress, false, appClient.appClientID);

            //send the code and save the new phone number
            UserPhone mobile = new UserPhone();
            TwilioClient client = new TwilioClient(_globalSettingRepository);

            mobile.userId = loggedUser.userId.GetValueOrDefault();
            mobile.phoneCountryCode = mobileCountryCode;
            mobile.phoneName = mobileName;
            mobile.phoneNumber = mobileNumber;
            mobile.verificationCode = "";

            int id = 0;

            try
            {
                id = _repository.addMobile(loggedUser.serverName, loggedUser.dbName, mobile);
            }
            catch
            {
                //number already exists
                id = 0;
            }

            //send welcome sms
            string code = client.SendCode(mobileCountryCode + mobileNumber, "SMS", 2);

            //return loggedUser NO AUTHENTICATED
            List<UserPhone> listPhones = (List<UserPhone>)_repository.getMobiles(loggedUser.serverName, loggedUser.dbName, loggedUser.userId.GetValueOrDefault());
            loggedUser.userPhoneNumbers = listPhones.AsEnumerable();
            loggedUser.authenticationResult = "ALLOWED";
            loggedUser.token = null;

            if (id == 0 && listPhones.Count() > 0)
            {
                id = listPhones.FirstOrDefault(s => s.phoneNumber.ToUpper() == mobileNumber.ToUpper()).userPhoneId;
            }

            //save code
            _repository.updateCodeLogin(loggedUser.serverName, loggedUser.dbName, id, code);

            return new ObjectResult(loggedUser);
        }


        [HttpPut("resetpassword/request/{userName}")]
        public IActionResult resetPasswordRequest(string userName, string urlHost)
        {
             _repository.resetPasswordRequest(userName, urlHost);

            return new NoContentResult();
        }
    }

}

```
## BackupExecutionController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class BackupExecutionController : Controller
    {
        public IBackupExecutionRepository _repository;
        private ILogger<BackupExecutionController> _logger;

        public BackupExecutionController(IBackupExecutionRepository repository, ILogger<BackupExecutionController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<BackupExecution> search(int day = 0)
        {
            return _repository.search(day);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPut("rerunbackups")]
        public IActionResult reRunBackups(string indexIds , string frecuency)
        {
            _repository.reRunBackups(indexIds, frecuency);

            return new NoContentResult();
        }

        [HttpPost]
        public IActionResult add([FromBody] BackupExecution item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] BackupExecution item)
        {
            if (item == null || item.backupExecutionID != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }
    }
}

```
## BackupExecutionLogController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class BackupExecutionLogController : Controller
    {
        public IBackupExecutionLogRepository _repository;
        private ILogger<BackupExecutionLogController> _logger;

        public BackupExecutionLogController(IBackupExecutionLogRepository repository, ILogger<BackupExecutionLogController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<BackupExecutionLog> search(int id)
        {
            return _repository.search(id);
        }

    }
}

```
## BankAccountController.cs
```cs
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Repositories;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Logging;
using System.Collections.Generic;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/bankstream/[controller]")]
    public class BankAccountController : Controller
    {

        public IBankAccountRepository _repository;
        private ILogger<BankAccountController> _logger;

        public BankAccountController(IBankAccountRepository repository, ILogger<BankAccountController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<BankAccount> search(string accountName = "")
        {
            return _repository.search(accountName);
        }

        [HttpGet("glaccounts")]
        public IEnumerable<GLAccount> searchGLAccounts(string bankAccountType, int companyId = 0)
        {
            return _repository.searchGLAccounts(bankAccountType,companyId);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] BankAccount item)
        {
            if (item == null || item.bankID != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpPut("update")]
        public IActionResult update([FromBody] IEnumerable<BankAccount> table)
        {
            foreach (BankAccount item in table)
            {
                _repository.update(item);
            }

            return new NoContentResult();
        }
    }
}
```
## BankReconciliationController.cs
```cs
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using System.Collections.Generic;
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Classes;
using System.Linq;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class BankReconciliationController : Controller
    {

        public IBankReconciliationRepository _repository;

        private ILogger<BankReconciliationController> _logger;

        public BankReconciliationController(IBankReconciliationRepository repository, ILogger<BankReconciliationController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<BankReconciliation> search(int companyId, int accountId = 0, int bankrecId=0,string reconciled = "")
        {
            return _repository.search( companyId, accountId, bankrecId,   reconciled);
        }


        [HttpGet("searchdetail")]
        public IEnumerable<BankReconciliationDetail> searchDetail(int companyId,int accountId, string limitDate)
        {
            return _repository.searchDetail(companyId, accountId, limitDate);
        }

        [HttpGet("get")]
        public IActionResult get(int id, string limitDate="")
        {
            var item = _repository.get(id,limitDate);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpGet("getReconciled")]
        public IActionResult getReconciled(int id)
        {
            var item = _repository.getReconciled(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] BankReconciliation item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id,"");
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] BankReconciliation item)
        {
            if (item == null || item.bankRecId != id)
            {
                return BadRequest();
            }

            _repository.update(item);
            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id,"");
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }

        [HttpPost("autoCleared")]
        public IActionResult autoCleared(int id, [FromBody] BankReconciliation item)
        {
            // autocleared
            _repository.autoCleared(item);

            // reload bank reconciliation
            item = _repository.get(id, item.toDate.ToString("yyyyMMdd"));
           
            return new ObjectResult(item);
        }

        [HttpPost("autoCleared/paginated/{id}")]
        public IActionResult autoClearedPaginated(int id)
        {
            var item = _repository.getHeader(id);
            item = _repository.get(id,item.toDate.ToString("yyyyMMdd"));

            item.detail = item.detail.Where(a => a.cleared == false).ToList();

            // autocleared
            _repository.autoCleared(item);

            return new NoContentResult();
        }

        [HttpPost("addunreconcileLog")]
        public IActionResult addUnreconcileLog([FromBody] UnreconcileLog log)
        {
            _repository.addUnreconcileLog(log);

            return new NoContentResult();
        }

        [HttpPut("unreconcile/{id}")]
        public IActionResult unreconcile(int id)
        {
            _repository.unreconcile(id);

            return new NoContentResult();
        }

        [HttpGet("header")]
        public IActionResult getHeader(int id)
        {
            var item = _repository.getHeader(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpGet("detail/paginated")]
        public IActionResult searchDetailPaginated(int id, bool reconciled, int companyId, int accountId = 0, string limitDate = "",int filterUser=0,  int pageIndex = 1, int pageSize = 50, string sortBy = "", string filterBy = "")
        {
            var detail = _repository.searchDetailPaginated(id,reconciled,companyId,accountId,limitDate, filterUser, pageIndex, pageSize, sortBy, filterBy);

            return new CustomPagedResult<BankReconciliationDetail>(detail);

        }

        [HttpPut("update/paginated")]
        public IActionResult updatePaginated(int id, [FromBody] BankReconciliation item)
        {
            if (item == null || item.bankRecId != id)
            {
                return BadRequest();
            }

            var page = _repository.searchDetailPaginated(id,false, item.companyId, item.accountId, item.toDate.ToShortDateString(), 0, 0, -1,"","");
            IEnumerable<BankReconciliationDetail> detailOld = page.data;

            //in the array of full details(detailOld) update with the modified details(item.detail)
            foreach (BankReconciliationDetail det in item.detail)
            {
                BankReconciliationDetail old = detailOld.FirstOrDefault(p => p.recordID == det.recordID && p.recordType == det.recordType); ;
                old.cleared = det.cleared;
                old.clearRef = det.clearRef;
            }

            item.detail = detailOld;
            _repository.update(item);

            return new NoContentResult();
        }
    }
}

```
## BankStreamController.cs
```cs
using System.Collections.Generic;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class BankStreamController : Controller
    {
        private IBankStreamRepository _repository;
        private ILogger<BankStreamController> _logger;

        public BankStreamController(IBankStreamRepository repository, ILogger<BankStreamController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet("offices")]
        public IEnumerable<Office> searchOffice(int companyId)
        {
            return _repository.searchOffice(companyId);
        }

        [HttpGet("webhook")]
        public ObjectResult searchWebhook(string item_id, string platform = "plaid")
        {
            object result = null;
            if (platform.ToLower() == "plaid")
                result = _repository.searchPlaidWebhook(item_id);

            if (platform.ToLower() == "mx")
                result = _repository.searchMxWebhook(item_id);

            return new ObjectResult(result);
        }

        // TODO: remove this method from this controller; moved to PlaidController
        [HttpGet("connectlog")]
        public IEnumerable<PlaidConnectLog> searchConnectLog()
        {
            return _repository.searchConnectLogs();
        }
    }
}

```
## BankTransactionController.cs
```cs
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Repositories;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Logging;
using System;
using System.Collections.Generic;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/bankstream/[controller]")]
    public class BankTransactionController : Controller
    {

        public IBankTransactionRepository _repository;
        private ILogger<BankTransactionController> _logger;

        public BankTransactionController(IBankTransactionRepository repository, ILogger<BankTransactionController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet("noclassified")]
        public IEnumerable<BankTransaction> searchNoClassifed(DateTime? dateFrom, DateTime? dateTo, int companyID = 0, int bankAccountID = 0)
        {
            return _repository.searchNoClassifed(dateFrom, dateTo, companyID, bankAccountID);
        }

        [HttpGet("classified")]
        public IEnumerable<BankTransaction> searchClassifed(DateTime? dateFrom, DateTime? dateTo, int companyID = 0, int bankAccountID = 0, string status = "all", int linkedAccountID = 0, int bankAccountLinkedGLAcctID = 0)
        {
            return _repository.searchClassifed(dateFrom, dateTo, companyID, bankAccountID, status, linkedAccountID, bankAccountLinkedGLAcctID);
        }

        [HttpGet("matches")]
        public IEnumerable<BankTransaction> searchMatchesRecords(int ruleId, bool isApply, bool applyAllEntries)
        {
            return _repository.searchMatchesRecords(ruleId, isApply, applyAllEntries);
        }

        [HttpGet("{parentID}/childtransactions")]
        public IEnumerable<BankTransaction> searchChildTransactions(int parentID)
        {
            return _repository.searchChildTransactions(parentID);
        }

        [HttpGet("glaccounts")]
        public IEnumerable<GLAccount> searchGLAccount(string transactionType)
        {
            return _repository.searchGLAccount(transactionType);
        }
        [HttpPut("{id}/classify")]
        public ActionResult classify([FromBody] BankTransaction item, int id, bool createAsRule, string condition)
        {
            if (id != item.transactionID)
            {
                return BadRequest();
            }

            _repository.classify(item, createAsRule, condition);

            return new NoContentResult();
        }

        [HttpPut("approve")]
        public ActionResult approve([FromBody] List<BankTransaction> transactions)
        {
            _repository.approve(transactions);

            return new NoContentResult();
        }

        [HttpPut("post")]
        public ActionResult post([FromBody] List<BankTransaction> transactions)
        {
            _repository.post(transactions);

            return new NoContentResult();
        }

        [HttpPut("{id}/split")]
        public ActionResult split(int id, [FromBody] List<BankTransaction> childTransactions, bool createAsRule, string memo)
        {
            _repository.split(id, childTransactions, createAsRule, memo);

            return new NoContentResult();
        }

        [HttpPut("{id}/unsplit")]
        public ActionResult unsplit(int id)
        {
            _repository.unsplit(id);

            return new NoContentResult();
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }
    }
}
```
## BillingGroupController.cs
```cs
using System.Collections.Generic;
using System.Linq;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Exceptions;
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Classes;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class BillingGroupController : Controller
    {
        public IBillingGroupRepository _repository;
        private ILogger<BillingGroupController> _logger;

        public BillingGroupController(IBillingGroupRepository repository,  ILogger<BillingGroupController> logger)
        {
            _repository = repository;            
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<BillingGroup> search(int companyId = 0,int hasDetail=0)
        {
            return _repository.search(companyId, hasDetail);
        }

        [HttpPost("searchOffices")]
        public IEnumerable<BillingGroupOffice> searchOffices( string option, [FromBody] BillingGroup item)
        {
            return _repository.searchOffices(item,option);
        }

        [HttpPost]
        public IActionResult add([FromBody] BillingGroup item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] BillingGroup item)
        {
            if (item == null || item.billingGroupId != id)
            {
                return BadRequest();
            }

            _repository.update(item);
            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            _repository.delete(id);

            return new NoContentResult();

        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }
    }
}

```
## BillingItemController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class BillingItemController : Controller
    {
        public IBillingItemRepository _repository;
        private ILogger<BillingItemController> _logger;

        public BillingItemController(IBillingItemRepository repository, ILogger<BillingItemController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<BillingItem> search()
        {
            return _repository.search();
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] BillingItem item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] BillingItem item)
        {
            if (item == null || item.billingItemId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }
    }
}

```
## BudgetController.cs
```cs
using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Logging;
using System.Collections.Generic;
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Repositories;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class BudgetController : Controller
    {

        public IBudgetRepository _repository;

        private ILogger<BudgetController> _logger;

        public BudgetController(IBudgetRepository repository, ILogger<BudgetController> logger)
        {
            _repository = repository;
            _logger = logger;
        }
        
        //[HttpGet]
        //public IEnumerable<Budget> search(int companyId = 0, int accountId = 0, int officeId = 0, int year = 0, int month = 0)
        //{
        //    return _repository.search(companyId, accountId, officeId, year, month);

        //}

        [HttpGet]
        public IEnumerable<Budget> search()
        {
            return _repository.search();

        }



        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }


        [HttpGet("budgetbydescription/{desc}")]
        public IActionResult getbydescription(string desc)
        {
            var item = _repository.getbydescription(desc);
            if (item == null)
            {
                //return NotFound();
                return new NoContentResult();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] Budget item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] Budget item)
        {
            if (item == null || item.budgetID != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }

    }
}

```
## BudgetDetailController.cs
```cs
using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Logging;
using System.Collections.Generic;
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Repositories;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class BudgetDetailController : Controller
    {

        public IBudgetDetailRepository _repository;

        private ILogger<BudgetDetailController> _logger;

        public BudgetDetailController(IBudgetDetailRepository repository, ILogger<BudgetDetailController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet()]
        public IActionResult get(int budgetID , int officeID, int personid, int year,int accountID, decimal totalGoalYear = 0)
        {
            var itemResult = _repository.get(budgetID, officeID, personid, year, accountID, totalGoalYear);
            if (itemResult == null)
            {
                return NotFound();
            }
            return new ObjectResult(itemResult);
        }


        [HttpPost]
        public IActionResult add([FromBody] BudgetDetail item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            _repository.add(item);

            return new NoContentResult();

        }


        [HttpPut()]
        public IActionResult update([FromBody] BudgetDetail item)
        {
                        
            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete()]
        public IActionResult delete(int budgetID, int officeID, int personid, int year, int accountID)
        {

            _repository.delete(budgetID, officeID, personid, year, accountID);

            return new NoContentResult();

        }

    }

}

```
## BudgetYearController.cs
```cs
using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Logging;
using System.Collections.Generic;
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Repositories;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class BudgetYearController : Controller
    {
        public IBudgetYearRepository _repository;

        private ILogger<BudgetYearController> _logger;

        public BudgetYearController(IBudgetYearRepository repository, ILogger<BudgetYearController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        //[HttpGet]
        //public IEnumerable<Budget> search(int companyId = 0, int accountId = 0, int officeId = 0, int year = 0, int month = 0)
        //{
        //    return _repository.search(companyId, accountId, officeId, year, month);

        //}

        [HttpGet("{id}")]
        public IEnumerable<BudgetYear> search(int id)
        {
            return _repository.search(id);

        }

        [HttpGet("add")]
        public IEnumerable<BudgetYear> add()
        {
            return _repository.add();

        }
    }
}
```
## CampaignCompanyController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class CampaignCompanyController : Controller
    {
        public ICampaignCompanyRepository _repository;

        private ILogger<CampaignCompanyController> _logger;

        public CampaignCompanyController(ICampaignCompanyRepository repository, ILogger<CampaignCompanyController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<CampaignCompany> search()
        {
            return _repository.search();
        }
    }
}
```
## CampaignController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;
using System.Data;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class CampaignController : Controller
    {
        private ICampaignRepository _repository;
        private ILogger<CampaignController> _logger;

        public CampaignController(ICampaignRepository repository, ILogger<CampaignController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<Campaign> search(string isPropertyRelated = "", string documentRelated = "")
        {
            return _repository.search(isPropertyRelated,documentRelated);
        }

        [HttpGet("validate")]
        public DataTable validate(int id)
        {
            return _repository.validate(id);
        }

        [HttpGet("runondemand")]
        public int runOnDemand(int campaignID, string emailForTesting, int propertyID = 0, string personID = "0", int documentID =0)
        {
            return _repository.runOnDemand(campaignID, emailForTesting, propertyID, personID, documentID);
        }

        [HttpGet("execute")]
        public DataTable execute(int id, string execution_Type, bool preview = true, string email = "", int propertyID = 0, string personID = "" )
        {
            return _repository.execute(id, execution_Type, email, propertyID, personID,preview);
        }    

        [HttpGet("mergefield")]
        public IEnumerable<CampaignMergeField> searchMergeFields(int id, string full = "1")
        {
            return _repository.searchMergeFields(id, full);
        }

        [HttpGet("function")]
        public IEnumerable<CampaignFunction> searchFunctions(string type)
        {
            return _repository.searchFunctions(type);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] Campaign item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPost("copy")]
        public int copy(int id,string name)
        {
            int newId = _repository.copy(id,name);
            return newId;
        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] Campaign item)
        {
            if (item == null || item.campaignID != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }

        [HttpPut("{id}/exporttomaster")]
        public IActionResult exportToMaster(int id)
        {
            _repository.exportToMaster(id);

            return new NoContentResult();
        }


        [HttpPost("{id}/importfrommaster")]
        public IActionResult importFromMaster(int id)
        {
            int newid = _repository.importFromMaster(id);
            
            var item = _repository.get(newid);

            return new ObjectResult(item);
        }

        [HttpGet("searchfrommaster")]
        public IEnumerable<Campaign> searchFromMaster()
        {
            return _repository.searchFromMaster();
        }
    }
}

```
## CampaignDatasourceController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    //[Route("api/campaigndatasource")]
    [Route("api/[controller]")]
    public class CampaigndatasourceController : Controller
    {

        public IcampaigndatasourceRepository _repository;

        private ILogger<CampaigndatasourceController> _logger;

        public CampaigndatasourceController(IcampaigndatasourceRepository repository, ILogger<CampaigndatasourceController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<campaigndatasource> search()
        {
            return _repository.search();
        }

        [HttpGet("searchTypes")]
        public IEnumerable<CodeValue> searchTypes(int id=0)
        {
            return _repository.searchTypes(id);
        }

        [HttpGet("searchOrderTypes")]
        public IEnumerable<CodeValue> searchOrderTypes(int id = 0)
        {
            return _repository.searchOrderTypes(id);
        }

    }
}
```
## CampaignDateRangeController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    //[Route("api/campaigndaterange")]
    public class CampaignDateRangeController : Controller
    {
        public ICampaignDateRangeRepository _repository;

        private ILogger<CampaignDateRangeController> _logger;

        public CampaignDateRangeController(ICampaignDateRangeRepository repository, ILogger<CampaignDateRangeController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<CampaignDateRange> search()
        {
            return _repository.search();
        }
    }
}
```
## CampaignDateTypeController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Controllers
{
    //[Produces("application/json")]
    //[Route("api/campaigndatetye")]
    [Route("api/[controller]")]
    public class CampaignDateTypeController : Controller
    {
        public ICampaignDateTypeRepository _repository;

        private ILogger<CampaignDateTypeController> _logger;

        public CampaignDateTypeController(ICampaignDateTypeRepository repository, ILogger<CampaignDateTypeController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        //[HttpGet]
        [HttpGet("search/{id}")]
        public IEnumerable<CampaignDateType> search(int id)
        {
            return _repository.search(id);
        }
    }
}
```
## CampaignLogController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class CampaignLogController : Controller
    {
        public ICampaignLogRepository _repository;

        private ILogger<CampaignLogController> _logger;

        public CampaignLogController(ICampaignLogRepository repository, ILogger<CampaignLogController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet("{id}")]
        public ActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpGet("search")]
        public IEnumerable<CampaignLog> search(int id)
        {
            return _repository.search(id);
        }

        [HttpGet("searchDetail")]
        public IEnumerable<EmailLog> searchDetail(int id,string result = "")
        {
            return _repository.searchDetail(id, result);
        }

        [HttpPost("resendDetail")]
        public IActionResult resendDetail(int emailLogId)
        {
           _repository.resendDetail(emailLogId);

            return new NoContentResult();

        }
    }
}
```
## CampaignOfficeController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class CampaignOfficeController : Controller
    {
        public ICampaignOfficeRepository _repository;

        private ILogger<CampaignOfficeController> _logger;

        public CampaignOfficeController(ICampaignOfficeRepository repository, ILogger<CampaignOfficeController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        //[HttpGet]
        [HttpGet("search/{id}")]
        public IEnumerable<CampaignOffice> search(int id)
        {
            return _repository.search(id);
        }

    }
}
```
## CampaignRecipientListController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class CampaignRecipientListController : Controller
    {
        public ICampaignRecipientListRepository _repository;

        private ILogger<CampaignRecipientListController> _logger;

        public CampaignRecipientListController(ICampaignRecipientListRepository repository, ILogger<CampaignRecipientListController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<CampaignRecipientList> search()
        {
            return _repository.search();
        }
        
        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] CampaignRecipientList item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }

        [HttpPut()]
        public IActionResult update([FromBody] CampaignRecipientList item)
        {
          _repository.update(item);

            return new NoContentResult();
        }

        [HttpPut("refresh")]
        public IActionResult refresh(int id)
        {
            _repository.refresh(id);

            return new NoContentResult();
        }

    }
}
```
## CampaignRecipientListDetailController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class CampaignRecipientListDetailController : Controller
    {
        public ICampaignRecipientListDetailRepository _repository;

        private ILogger<CampaignRecipientListDetailController> _logger;

        public CampaignRecipientListDetailController(ICampaignRecipientListDetailRepository repository, ILogger<CampaignRecipientListDetailController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet("{id}")]
        public IEnumerable<CampaignRecipientListDetail> search(int id, int personId)
        {
            return _repository.search(id, personId);
        }

        [HttpGet]
        public IEnumerable<CampaignRecipientListDetail> searchByProperty(int recipientListID, int propertyID)
        {
            return _repository.searchByProperty(recipientListID, propertyID);
        }

        [HttpPost]
        public IActionResult add([FromBody] CampaignRecipientListDetail item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);


            return new NoContentResult();

        }

        //[HttpDelete("{id}")]
        [HttpDelete("delete")]
        public IActionResult delete(int id)
        {            
            _repository.delete(id);

            return new NoContentResult();

        }
    }
}
```
## CampaignRecipientTypeController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    //[Route("api/campaignrecipienttype")]
    public class CampaignRecipientTypeController : Controller
    {
        public ICampaignRecipientTypeRepository _repository;

        private ILogger<CampaignRecipientTypeController> _logger;

        public CampaignRecipientTypeController(ICampaignRecipientTypeRepository repository, ILogger<CampaignRecipientTypeController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<CampaignRecipientType> search()
        {
            return _repository.search();
        }

    }
}
```
## CampaignReportController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class CampaignReportController : Controller
    {
        public ICampaignReportRepository _repository;

        private ILogger<CampaignReportController> _logger;

        public CampaignReportController(ICampaignReportRepository repository, ILogger<CampaignReportController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<CampaignReport> search(string linkFieldName = "")
        {
            return _repository.search(linkFieldName);
        }

        [HttpPut]
        public IActionResult update([FromBody] ReportCustom item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int value = _repository.update(item);
            return new ObjectResult(value);
        }
    }
}
```
## CampaignReportParametersController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class CampaignReportParametersController : Controller
    {
        public ICampaignReportParametersRepository _repository;

        private ILogger<CampaignReportParametersController> _logger;

        public CampaignReportParametersController(ICampaignReportParametersRepository repository, ILogger<CampaignReportParametersController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        //[HttpGet]
        [HttpGet("searchintblreportparameter/{id}")]
        public IEnumerable<CampaignReportParameters> searchintblreportparameter(int id)
        {
            return _repository.searchintblreportparameter(id);
        }

        [HttpGet("searchincmpreportparameter/{id}")]
        public IEnumerable<CampaignReportParameters> searchincmpreportparameter(int id)
        {
            return _repository.searchincmpreportparameter(id);
        }

        [HttpPost]
        public IActionResult add([FromBody] CampaignReportParameters item)
        {
            if (item == null)
            {
                return BadRequest();
            }

             _repository.add(item);


            return new NoContentResult();

        }


        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            
            _repository.delete(id);

            return new NoContentResult();

        }

    }
}
```
## CampaignScheduleController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class CampaignScheduleController : Controller
    {

        public ICampaignScheduleRepository _repository;

        private ILogger<CampaignScheduleController> _logger;

        public CampaignScheduleController(ICampaignScheduleRepository repository, ILogger<CampaignScheduleController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet("search/{id}")]
        public IEnumerable<CampaignSchedule> search(int id)
        {
            return _repository.search(id);
        }


        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] CampaignSchedule item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] CampaignSchedule item)
        {
            if (item == null || item.scheduleID != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }
    }
}
```
## CampaignTemplateController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class CampaignTemplateController : Controller
    {
        public ICampaignTemplateRepository _repository;

        private ILogger<CampaignTemplateController> _logger;

        public CampaignTemplateController(ICampaignTemplateRepository repository, ILogger<CampaignTemplateController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<CampaignTemplate> search()
        {
            return _repository.search();
        }

        [HttpGet("searchbydescription")]
        public IEnumerable<CampaignTemplate> searchbydescription(string desc)
        {
            return _repository.searchbydescription(desc);
        }


        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }
    }
}
```
## CategoryController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Repositories;
using Microsoft.AspNetCore.Http;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Logging;

namespace AT.AT2017.Api.Controllers
{
    [Produces("application/json")]
    [Route("api/Category")]
    public class CategoryController : Controller
    {
        public ICategoryRepository _repository;

        private ILogger<CategoryController> _logger;

        public CategoryController(ICategoryRepository repository, ILogger<CategoryController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<Category> search()
        {
            return _repository.search();
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] Category item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] Category item)
        {
            if (item == null || item.CategoryID != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }
    }
}
```
## CertificationController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class CertificationController : Controller
    {
        public ICertificationRepository _repository;

        private ILogger<CertificationController> _logger;

        public CertificationController(ICertificationRepository repository, ILogger<CertificationController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet("groups/{groupID}")]
        public IEnumerable<Certification> search(int groupID)
        {
            return _repository.search(groupID);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] Certification item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] Certification item)
        {
            if (item == null || item.CertificationID != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }

    }
}

```
## CertificationGroupController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class CertificationGroupController : Controller
    {
        public ICertificationGroupRepository _repository;

        private ILogger<ICertificationGroupRepository> _logger;

        public CertificationGroupController(ICertificationGroupRepository repository, ILogger<ICertificationGroupRepository> logger)
        {
            _repository = repository;
            _logger = logger;
        }
        
        [HttpGet]
        public IEnumerable<CertificationGroup> search()
        {
            return _repository.search();
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] CertificationGroup item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] CertificationGroup item)
        {
            if (item == null || item.CertificationGroupID != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }

    }
}

```
## CertificationRoleRequirementController.cs
```cs
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using System.Collections.Generic;
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class CertificationRoleRequirementController : Controller
    {

        public ICertificationRoleRequirementRepository _repository;

        private ILogger<CertificationRoleRequirementController> _logger;

        public CertificationRoleRequirementController(ICertificationRoleRequirementRepository repository, ILogger<CertificationRoleRequirementController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<CertificationRoleRequirement> search(int certificationId)
        {
            return _repository.search(certificationId);
        }


        [HttpPut]
        public IActionResult update(int certificationId,[FromBody] IEnumerable<CertificationRoleRequirement> table)
        {
            _repository.update(certificationId,table);

            return new NoContentResult();
        }

    }
}

```
## ChatMessageController.cs
```cs
using AT.AT2017.Api.Classes;
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Hubs;
using AT.AT2017.Api.Hubs.Clients;
using AT.AT2017.Api.Repositories;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.SignalR;
using Microsoft.Extensions.Logging;
using System.Collections.Generic;
using System.Linq;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/chat/message")]
    public class ChatMessageController : Controller
    {

        private IChatMessageRepository _repository;
        private ISettingRepository _settingRepository;
        private IChatContactRepository _chatContactRepository;
        private ILogger<ChatMessageController> _logger;
        private readonly IHubContext<ChatHub, IChatClient> _hubContext;
        private UserConnectionManager _connectionManager;

        public ChatMessageController(IChatMessageRepository repository, ISettingRepository settingRepository, IChatContactRepository chatContactRepository, ILogger<ChatMessageController> logger, IHubContext<ChatHub, IChatClient> hubContext, UserConnectionManager connectionManager)
        {
            _repository = repository;
            _settingRepository = settingRepository;
            _chatContactRepository = chatContactRepository;
            _logger = logger;
            _hubContext = hubContext;
            _connectionManager = connectionManager;
        }

        [HttpGet]
        public IActionResult search(int roomID, int userID, string query = null, int pageIndex = 1, int pageSize = 10, string includeColumns = null, string ignoreColumns = null)
        {
            var messages = _repository.search(roomID, userID, query, pageIndex, pageSize);

            return new CustomPagedResult<ChatMessage>(messages, includeColumns?.Split(","), ignoreColumns?.Split(","));

        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] ChatMessage message)
        {
            if (message == null)
            {
                return BadRequest();
            }

            string currentConnectId = message.connectionId;

            Setting sendSmsEnabledSetting = _settingRepository.get("CHAT_SEND_SMS_ENABLED");

            bool sendSmsEnabled = false;
            if (sendSmsEnabledSetting != null)
            {
                sendSmsEnabled = bool.Parse(sendSmsEnabledSetting.value);
            }

            int id = _repository.add(message, sendSmsEnabled);

            message = _repository.get(id);

            // get chat contacts by roomID
            List<ChatContact> contacts = _chatContactRepository.search(message.roomID).ToList();

            // iterate and send message to all "users" excluding this connection
            foreach (ChatContact contact in contacts)
            {
                if (contact.entityType == "user")
                {
                    int userId = contact.entityID;

                    IReadOnlyCollection<string> connections = _connectionManager.GetConnections(userId);

                    foreach (string connectionId in connections)
                    {
                        if (connectionId != currentConnectId)
                        {
                            _hubContext.Clients.Client(connectionId).ReceiveMessage(message);
                        }
                    }
                }
            }

            return new ObjectResult(message);

        }

        [HttpPost("hub/test")]
        public IActionResult test([FromBody] ChatMessage message)
        {
            int id = _repository.add(message, sendSMSEnabled: false);

            message = _repository.get(id);

            int userId = 22248;

            IReadOnlyCollection<string> connections = _connectionManager.GetConnections(userId);

            foreach (string connectionId in connections)
            {
                _hubContext.Clients.Client(connectionId).ReceiveMessage(message);
            }

            return new ObjectResult(message);
        }
    }
}

```
## ChatRoomController.cs
```cs
using AT.AT2017.Api.Classes;
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Repositories;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Logging;
using System.Collections.Generic;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/chat/room")]
    public class ChatRoomController : Controller
    {
        public IChatRoomRepository _repository;
        private ILogger<ChatRoomController> _logger;

        public ChatRoomController(IChatRoomRepository repository, ILogger<ChatRoomController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IActionResult search(int userID, int? topicID = null, string query = null, int pageIndex = 1, int pageSize = 10, string includeColumns = null, string ignoreColumns = null)
        {
            var rooms = _repository.search(userID, topicID, query, pageIndex, pageSize);

            return new CustomPagedResult<ChatRoom>(rooms, includeColumns?.Split(","), ignoreColumns?.Split(","));

        }

        [HttpGet("person")]
        public IActionResult searchPerson(string query = null, int? personTypeID = null, int pageIndex = 1, int pageSize = 10, string includeColumns = null, string ignoreColumns = null)
        {
            var persons = _repository.searchPerson(query, personTypeID, pageIndex, pageSize);

            return new CustomPagedResult<Person>(persons, includeColumns?.Split(","), ignoreColumns?.Split(","));

        }

        [HttpGet("entity")]
        public IActionResult searchEntity(int topicID, string query = null, int? companyID = null, int pageIndex = 1, int pageSize = 10)
        {
            var entities = _repository.searchEntity(query, topicID, companyID, pageIndex, pageSize);

            return new CustomPagedResult<ChatRoomEntity>(entities);

        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] ChatRoom item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] ChatRoom item)
        {
            if (item == null || item.roomID != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }

    }
}

```
## CheckbookController.cs
```cs
using System.Collections.Generic;
using System.Linq;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Exceptions;
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Classes;
using System;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class CheckbookController : Controller
    {
        public ICheckbookRepository _repository;
        public IGlobalSettingRepository _globalSettingRepository;
        public IGLAccountRepository _glAccountRepository;
        public IPersonMerchantRepository _personMerchantRepository;
        public IFortePaymentLogRepository _forteLogRepository;
        public ICompanyRepository _companyRepository;
        private ILogger<CheckbookController> _logger;
        public ISettingRepository _settingRepository;
        public IPersonRepository _personRepository;

        public CheckbookController(ICheckbookRepository repository, IGlobalSettingRepository globalSettingRepository, IGLAccountRepository glAccountRepository, ISettingRepository settingRepository, IPersonRepository personRepository, IPersonMerchantRepository personMerchantRepository, ICompanyRepository companyRepository, IFortePaymentLogRepository forteLogRepository, ILogger<CheckbookController> logger)
        {
            _repository = repository;
            _globalSettingRepository = globalSettingRepository;
            _glAccountRepository = glAccountRepository;
            _settingRepository = settingRepository;
            _personRepository = personRepository;
            _personMerchantRepository = personMerchantRepository;
            _forteLogRepository = forteLogRepository;
            _companyRepository = companyRepository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<Checkbook> search(int companyId, int personId = 0, int propertyId = 0, int accountId = 0, int checkbookId = 0, decimal amount = 0, string checkNumber = "", string type = "", string posted = "", string printed = "", string fromDate = "", string toDate = "", string memoAndDescription = "", int pageIndex = 0, int pageSize = 10, bool withTrash = false)
        {
            return _repository.search(companyId, personId, propertyId, accountId, checkbookId, amount, checkNumber, type, posted, printed, fromDate, toDate, memoAndDescription, pageIndex, pageSize, withTrash);
        }

        [HttpGet("getNextCheckNumber")]
        public string getNextCheckNumber(int accountId = 0)
        {
            return _repository.getNextCheckNumber(accountId);
        }

        [HttpGet("deleted")]
        public IEnumerable<Checkbook> searchDeletedRecord(int pageIndex = 0, int pageSize = 10)
        {
            return _repository.searchDeletedRecord(pageIndex, pageSize);
        }

        [HttpGet("escrows")]
        public IEnumerable<Checkbook> searchEscrow(int propertyId = 0, int personId = 0, bool onlyCheck = false)
        {
            return _repository.searchEscrow(propertyId, personId, onlyCheck);
        }

        [HttpGet("escrows/searchDuplicateCheckNumber")]
        public IEnumerable<Checkbook> searchDuplicateCheckNumber(int id, int accountID, string checkNumber)
        {
            return _repository.searchDuplicateCheckNumber(id, accountID, checkNumber);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] Checkbook item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPost("escrow/add")]
        public IActionResult addEscrow([FromBody] Checkbook item, bool isDirectDeposit)
        {
            if (item == null)
            {
                return BadRequest();
            }

            bool isForteByAccount = false;
            int id = 0;

            if (isDirectDeposit == true)
            {
                IEnumerable<Setting> settingList = _settingRepository.search("", "", "Forte", "");
                Setting settingC = settingList.First(s => s.name == "ENABLE_FORTE_BY_ACCOUNT");
                if (settingC != null)
                    if (settingC.value.ToLower() == "true")
                        isForteByAccount = true;
            }

            if (isForteByAccount == false)
            {
                Company company = _companyRepository.get(item.companyId);
                if (isDirectDeposit == true && string.IsNullOrEmpty(company.merchantID_ACH))
                {
                    throw new System.Exception("The company doesn't have a valid Forte Merchant ID value. Please enter in Settings\\Settings screen to continue.");
                }

                id = _repository.addEscrow(item);
                item.checkbookId = id;

                if (isDirectDeposit == true)
                {
                    try
                    {
                        _repository.addAutoDeposit(item);
                        sendForte(item, company);
                    }
                    catch (Exception e)
                    {
                        _repository.undoAutoDeposit(id);
                        throw e;
                    }
                }
            }
            else
            {
                ForteClient client = new ForteClient();
                if (isDirectDeposit == true)
                {
                    client = new ForteClient(_globalSettingRepository, _companyRepository, _glAccountRepository, _personMerchantRepository, item.accountId.GetValueOrDefault(), item.personId.GetValueOrDefault(), item.companyId, 0, "credit");
                }

                id = _repository.addEscrow(item);
                item.checkbookId = id;

                if (isDirectDeposit == true)
                {
                    try
                    {
                        _repository.addAutoDeposit(item);
                        sendForte(client, item);
                    }
                    catch (Exception e)
                    {
                        _repository.undoAutoDeposit(id);
                        throw e;
                    }
                }
            }

            return new ObjectResult(id);

        }


        private void sendForte(ForteClient client, Checkbook item)
        {
            FortePaymentLog result = client.payTransaction(item.amount, item.checkbookId, "credit", true);
            result.paymentId = item.checkbookId;
            result.paymentType = "CH";//check
            result.paymethodType = "ACH";//use the forte ACH

            _forteLogRepository.add(result);

            if (result.responseCode != "A01")
            {
                throw new ForteException(result.responseDescription, result.responseCode, item.checkbookId);
            }
        }

        private void sendForte(Checkbook item, Company company)
        {
            Person person = _personRepository.get(item.personId.GetValueOrDefault());
            ForteClient client = new ForteClient(_settingRepository, _globalSettingRepository, _companyRepository, item.companyId, "credit");
            FortePaymentLog result = client.payTransaction(item.amount, item.checkbookId, person.forteClientId, "credit", person.forteAchId, person.forteCcId);
            result.paymentId = item.checkbookId;
            result.paymentType = "CH";
            result.paymethodType = "ACH";

            _forteLogRepository.add(result);

            if (result.responseCode != "A01")
            {
                throw new ForteException(result.responseDescription, result.responseCode, item.checkbookId);
            }
        }

        [HttpPut("updateFlag1099")]
        public IActionResult updateFlag1099(int id, int flag1099)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.updateFlag1099(id, flag1099);

            return new NoContentResult();
        }

        [HttpPut("escrow/update")]
        public IActionResult updateEscrow([FromBody] Checkbook item, bool isDirectDeposit)
        {
            if (item == null)
            {
                return BadRequest();
            }

            bool isForteByAccount = false;

            if (isDirectDeposit == true)
            {
                IEnumerable<Setting> settingList = _settingRepository.search("", "", "Forte", "");
                Setting settingC = settingList.First(s => s.name == "ENABLE_FORTE_BY_ACCOUNT");
                if (settingC != null)
                    if (settingC.value.ToLower() == "true")
                        isForteByAccount = true;
            }

            if (isForteByAccount == false)
            {
                Company company = _companyRepository.get(item.companyId);
                if (isDirectDeposit == true && string.IsNullOrEmpty(company.merchantID_ACH))
                {
                    throw new System.Exception("The company doesn't have a valid Forte Merchant ID value. Please enter in Settings\\Settings screen to continue.");
                }

                _repository.updateEscrow(item);

                if (isDirectDeposit == true)
                {
                    sendForte(item, company);
                }
            }
            else
            {
                ForteClient client = new ForteClient();
                if (isDirectDeposit == true)
                {
                    client = new ForteClient(_globalSettingRepository, _companyRepository, _glAccountRepository, _personMerchantRepository, item.accountId.GetValueOrDefault(), item.personId.GetValueOrDefault(), item.companyId, 0, "credit");
                }

                _repository.updateEscrow(item);

                if (isDirectDeposit == true)
                {
                    sendForte(client, item);
                }
            }

            return new NoContentResult();
        }

        [HttpDelete("escrow/delete")]
        public IActionResult deleteEscrow(int id, string type)
        {
            _repository.deleteEscrow(id, type);

            return new NoContentResult();

        }


        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] Checkbook item)
        {
            if (item == null || item.checkbookId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }

        [HttpPut("post/{id}")]
        public IActionResult post(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.post(id);

            return new NoContentResult();
        }

        [HttpPut("voiding/{id}")]
        public IActionResult voiding(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.voiding(id);

            return new NoContentResult();
        }

        [HttpPut("unpost/{id}")]
        public IActionResult unpost(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.unpost(id);

            return new NoContentResult();
        }

        [HttpPut("print/{id}")]
        public IActionResult print(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.print(id);

            return new NoContentResult();
        }


        [HttpGet("escrow/searchReassign")]
        public IEnumerable<Checkbook> searchReassign(int propertyId = 0, int accountId = 0)
        {
            return _repository.searchReassign(propertyId, accountId);
        }


        [HttpPut("escrow/reassign")]
        public IActionResult reassign([FromBody] Checkbook item, int propertyId)
        {
            if (item == null)
            {
                return BadRequest();
            }

            _repository.reassign(item, propertyId);

            return new NoContentResult();
        }

        [HttpPut("reclassify/{id}")]
        public IActionResult reclassify(int id, [FromBody] Checkbook item)
        {
            if (item == null || item.checkbookId != id)
            {
                return BadRequest();
            }

            _repository.reclassify(item);

            return new NoContentResult();
        }


    }
}

```
## CheckbookDetailController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/checkbook/detail")]
    public class CheckbookDetailController : Controller
    {
        public ICheckbookDetailRepository _repository;
        private ILogger<CheckbookDetailController> _logger;

        public CheckbookDetailController(ICheckbookDetailRepository repository, ILogger<CheckbookDetailController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<CheckbookDetail> search(int checkbookId = 0, int personId = 0, int agentId = 0, string reimb = "", int expenseJobId=0, int pageIndex = 0, int pageSize = 10, bool withTrash = false)
        {
            return _repository.search(checkbookId, personId, agentId, reimb, expenseJobId, pageIndex, pageSize, withTrash);
        }

        [HttpGet("postingProperty")]
        public IEnumerable<CheckbookDetail> searchPostingProperty(int propertyId)
        {
            return _repository.searchPostingProperty(propertyId);
        }

    }
}

```
## CheckbookReportController.cs
```cs
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Repositories;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Logging;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class CheckbookReportController : Controller
    {

        public ICheckbookReportRepository _repository;
        private ILogger<CheckbookReportController> _logger;

        public CheckbookReportController(ICheckbookReportRepository repository, ILogger<CheckbookReportController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<CheckbookReport> search(int companyId = 0, string dateStart = "", string dateEnd = "", int pageIndex = 0, int pageSize = 100)
        {
            return _repository.search(companyId, dateStart, dateEnd, pageIndex, pageSize);
        }
    }
}

```
## CheckbookScannedImageController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using AT.AT2017.Api.Core.Models;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Validation;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/checkbook/scannedimage")]
    public class CheckbookScannedImageController : Controller
    {
        public ICheckbookScannedImageRepository _repository;
        private ILogger<CheckbookScannedImageController> _logger;

        public CheckbookScannedImageController(ICheckbookScannedImageRepository repository, ILogger<CheckbookScannedImageController> logger)
        {
            _repository = repository;
            _logger = logger;
        }
        
        [HttpGet]
        public IEnumerable<CheckbookScannedImage> search(int checkbookID)
        {
            return _repository.search(checkbookID);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] CheckbookScannedImage item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }
        
        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] CheckbookScannedImage item)
        {
            if (item == null || item.scannedImageID != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }
    }
}

```
## CheckbookScannedImageViewHistoryController.cs
```cs
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using System.Collections.Generic;
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/checkbook/scannedimage/history")]
    public class CheckbookScannedImageViewHistoryController : Controller
    {
        public ICheckbookScannedImageViewHistoryRepository _repository;

        private ILogger<CheckbookScannedImageViewHistoryController> _logger;

        public CheckbookScannedImageViewHistoryController(ICheckbookScannedImageViewHistoryRepository repository, ILogger<CheckbookScannedImageViewHistoryController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<CheckbookScannedImage> search(int scannedImageID)
        {
            return _repository.search(scannedImageID);
        }

        [HttpPost]
        public IActionResult add([FromBody] CheckbookScannedImage item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item.scannedImageID);

            //item = _repository.get(id);
            return new ObjectResult(item);

        }
    }
}
```
## CheckMergeFieldController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling MVC for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class CheckMergeFieldController : Controller
    {
        public ICheckMergeFieldRepository _repository;
        private ILogger<CheckMergeFieldController> _logger;

        public CheckMergeFieldController(ICheckMergeFieldRepository repository, ILogger<CheckMergeFieldController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<CheckMergeField> search()
        {
            return _repository.search();
        }
        
    }
}

```
## CheckTemplateController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;
using System.IO;

// For more information on enabling MVC for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class CheckTemplateController : Controller
    {
        public ICheckTemplateRepository _repository;
        private ILogger<CheckTemplateController> _logger;

        public CheckTemplateController(ICheckTemplateRepository repository, ILogger<CheckTemplateController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<CheckTemplate> search(string name = "")
        {
            return _repository.search(name);
        }

        [HttpPost("copy")]
        public int copy(int id)
        {
            id = _repository.copy(id);

            return id;
        }

        [HttpGet("frommaster")]
        public IEnumerable<CheckTemplate> searchFromMaster()
        {
            return _repository.searchFromMaster();
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            string path = _repository.getImagesPath();
            foreach (CheckMergeField field in item.mergeFields.ToList())
            {
                if (field.name.StartsWith("{picture") && field.picturePath != "" )
                {
                    string imagePath = path + "\\" + field.picturePath;

                    try
                    {
                        using (System.Drawing.Image image = System.Drawing.Image.FromFile(imagePath))
                        {
                            using (MemoryStream m = new MemoryStream())
                            {
                                image.Save(m, image.RawFormat);
                                byte[] imageBytes = m.ToArray();
                                field.imageBase64 = Convert.ToBase64String(imageBytes);
                            }
                        }
                    }
                    catch
                    {
                    }                    
                }
            }
           
            return new ObjectResult(item);
        }

        [HttpGet("images")]
        public IEnumerable<SignatureImage> searchUploadedImages()
        {
            string path = _repository.getImagesPath();

            DirectoryInfo dirInfo = new DirectoryInfo(path);
            IEnumerable<FileInfo> fileList = dirInfo.GetFiles("*.*");

            //Create the query
            IEnumerable<FileInfo> fileQuery = from file in fileList
                                              where (file.Extension.ToLower() == ".jpg" || file.Extension.ToLower() == ".png" || file.Extension.ToLower() == ".jpg" || file.Extension.ToLower() == ".png")
                                              orderby file.LastWriteTime
                                              select file;


            List<SignatureImage> SignatureImageList = new List<SignatureImage>();
            foreach (FileInfo file in fileQuery)
            {
                try
                {
                    SignatureImage image = new SignatureImage();
                    image.fileName = file.Name;
                    image.fullName = file.FullName;
                    image.extension = file.Extension;

                    SignatureImageList.Add(image);

                    using (System.Drawing.Image imageDraw = System.Drawing.Image.FromFile(file.FullName))
                    {
                        using (MemoryStream m = new MemoryStream())
                        {
                            imageDraw.Save(m, imageDraw.RawFormat);
                            byte[] imageBytes = m.ToArray();
                            image.imageBase64 = Convert.ToBase64String(imageBytes);
                        }
                    }
                }
                catch
                {
                }
            }
            return SignatureImageList.AsEnumerable();
        }

        [HttpPut("{id}/exporttomaster")]
        public IActionResult exportToMaster(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.exportToMaster(id);

            return new NoContentResult();
        }

        [HttpGet("{id}/frommaster")]
        public IActionResult getFromMaster(int id)
        {
            var item = _repository.getFromMaster(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] CheckTemplate item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] CheckTemplate item)
        {
            if (item == null || item.checkTemplateId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }

    }
}

```
## CheckWriterController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling MVC for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class CheckWriterController : Controller
    {
        public ICheckWriterRepository _repository;
        private ILogger<CheckWriterController> _logger;

        public CheckWriterController(ICheckWriterRepository repository, ILogger<CheckWriterController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<CheckWriter> search(int companyId = 0, string source = "", int entityID = 0, string fromDate = "", string toDate = "", int topNumber = 0, int pageIndex = 0, int pageSize = 10)
        {
            return _repository.search(companyId, source, entityID, fromDate, toDate, topNumber, pageIndex, pageSize);
        }

    }
}

```
## ClassificationRuleController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Core.Models.BankStream;
using AT.AT2017.Api.Repositories;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Logging;

// For more information on enabling Web API for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/bankstream/[controller]")]
    public class ClassificationRuleController : Controller
    {
        public IClassificationRuleRepository _repository;

        private ILogger<ClassificationRuleController> _logger;

        public ClassificationRuleController(IClassificationRuleRepository repository, ILogger<ClassificationRuleController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<ClassificationRule> search(string searchRule = "", int transactionID = 0)
        {
            return _repository.search(searchRule, transactionID);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] ClassificationRule item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] ClassificationRule item)
        {
            if (item == null || item.ruleId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("deleted")]
        public IActionResult delete(int id, string userName)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }

        [HttpPost("apply")]
        public IActionResult apply(int ruleId, [FromBody] IEnumerable<BankTransaction> table)
        {
            _repository.apply (ruleId, table);

            return new NoContentResult();
        }

        [HttpPost("unapply")]
        public IActionResult unapply(int ruleId, [FromBody] IEnumerable<BankTransaction> table)
        {
            _repository.unapply(ruleId, table);

            return new NoContentResult();
        }

    }



}
```
## ClientDeviceController.cs
```cs
using System.Collections.Generic;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;
namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class ClientDeviceController : Controller
    {
        public IClientDeviceRepository _repository;

        private ILogger<ClientDeviceController> _logger;

        public ClientDeviceController(IClientDeviceRepository repository, ILogger<ClientDeviceController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<ClientDevice> search(string dbName = "", string status ="", string authorized="", string fromDate="", string toDate="")
        {
            return _repository.search(dbName,status, authorized, fromDate, toDate);
        }       

        [HttpPost]
        public IActionResult add([FromBody] ClientDevice item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(item.processorId, item.computerName, item.dbName);
            return new ObjectResult(item);
        }

        [HttpPut]
        public IActionResult update( [FromBody] ClientDevice item)
        {          
            _repository.update(item);

            return new NoContentResult();
        }
    }
}

```
## ClientNewController.cs
```cs
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using AT.AT2017.Api.Core.Models;
using Microsoft.Extensions.Logging;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class ClientNewController : Controller
    {
        public IClientNewRepository _repository;
        private ILogger<ClientNewController> _logger;

        public ClientNewController(IClientNewRepository repository, ILogger<ClientNewController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<ClientNew> search()
        {
            return _repository.search();
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] ClientNew item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpGet("view")]
        public string view(string code="",int id =0)
        {
           
           return _repository.view(code,id);
        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] ClientNew item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            _repository.delete(id);

            return new NoContentResult();

        }
    }
}

```
## CodeValueCategoryController.cs
```cs
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using System.Collections.Generic;
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class CodeValueCategoryController : Controller
    {
        public ICodeValueCategoryRepository _repository;

        private ILogger<CodeValueCategoryController> _logger;

        public CodeValueCategoryController(ICodeValueCategoryRepository repository, ILogger<CodeValueCategoryController> logger)
        {
            _repository = repository;
            _logger = logger;
        }


        [HttpGet]
        public IEnumerable<CodeValueCategory> search(string section="")
        {
            return _repository.search(section);
        }

        [HttpGet("{name}")]
        public IActionResult get(string name)
        {
            var item = _repository.get(name);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] CodeValueCategory item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            item = _repository.get(item.categoryName);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] CodeValueCategory item)
        {
            if (item == null || item.codeValueCategoryID != id)
            {
                return BadRequest();
            }

            _repository.update(item);

            return new NoContentResult();
        }
    }
}

```
## CodeValueController.cs
```cs
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using System.Collections.Generic;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{

    [Route("api/[controller]")]
    public class CodeValueController : Controller
    {

        public ICodeValueRepository _repository;

        private ILogger<CodeValueController> _logger;

        public CodeValueController(ICodeValueRepository repository, ILogger<CodeValueController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<CodeValue> search(string category, string custom = "all", bool withTrash = false, string group = "", bool includeNotMaster = false, bool applySecurity = false, string accessType = "edit")
        {
            return _repository.search(category, custom, withTrash, group, includeNotMaster, applySecurity, accessType);
        }

        [HttpGet("deleted")]
        public IEnumerable<CodeValue> searchDeletedRecord(int pageIndex = 0, int pageSize = 10)
        {
            return _repository.searchDeletedRecord(pageIndex, pageSize);
        }

        [HttpGet("deletedByCategory")]
        public IEnumerable<CodeValue> searchDeletedByCategory(string category)
        {
            return _repository.searchDeletedByCategory(category);
        }

        [HttpGet("recurring")]
        public IEnumerable<CodeValue> searchRecurringCodes()
        {
            return _repository.searchRecurringCodes();
        }

        [HttpGet("forteCodes")]
        public IEnumerable<CodeValue> searchForteCodes()
        {
            return _repository.searchForteCodes();
        }

        [HttpGet("brandcodes")]
        public IEnumerable<CodeValue> searchBrandCodes()
        {
            return _repository.searchBrandCodes();
        }

        [HttpGet("protected")]
        public IEnumerable<CodeValue> searchProtectedCategories()
        {
            return _repository.searchProtectedCategories();
        }        

        [HttpGet("invalidcodes")]
        public IEnumerable<CodeValue> searchInvalidCodes(string category = "")
        {
            return _repository.searchInvalidCodes(category);
        }

        [HttpGet("categorycodes")]
        public IEnumerable<CodeValue> searchCategoryCodes(string category = "")
        {
            return _repository.searchCategoryCodes(category);
        }

        [HttpGet("categorycustom1")]
        public IEnumerable<CodeValue> searchCategoryCustom1(string category = "")
        {
            return _repository.searchCategoryCustom1(category);
        }

        [HttpGet("personTypeAccess")]
        public IEnumerable<PersonTypeAccess> searchPersonTypeAccess()
        {
            return _repository.searchPersonTypeAccess();
        }

        [HttpPut("invalidcodes")]
        public IActionResult updateInvalidCodes(int invalidCodeId, int validCodeId)
        {

            _repository.updateInvalidCodes(invalidCodeId, validCodeId);

            return new NoContentResult();

        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] CodeValue item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }
        
        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] CodeValue item)
        {
            if (item == null || item.codeValueId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpPut]
        public IActionResult update([FromBody] IEnumerable<CodeValue> table, string category = "")
        {
            _repository.update(table,category);

            return new NoContentResult();
        }

        [HttpPut("reactive")]
        public IActionResult reactive(int id)
        {
            _repository.reactive(id);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id, bool forceDelete = false)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id, forceDelete);

            return new NoContentResult();

        }

        [HttpGet("search/persontype")]
        public IEnumerable<CodeValue> searchPersonType(int id = 0)
        {
            return _repository.searchPersonType(id);
        }

    }
}

```
## CodeValueReportController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Core.Model_Report;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class CodeValueReportController : Controller
    {
        public ICodeValueReportRepository _repository;
        private ILogger<CodeValueReportController> _logger;

        public CodeValueReportController(ICodeValueReportRepository repository, ILogger<CodeValueReportController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<CodeValueReport> search(int id=0, string name="", string category = "", int showDeleted = 0, int pageIndex = 0, int pageSize = 100)
        {
            return _repository.search( id, name,category , showDeleted, pageIndex, pageSize);
        }
    }
}

```
## CompanyBankController.cs
```cs
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Repositories;
using AT.AT2017.Api.Util;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Logging;
using System.Collections.Generic;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/plaid/[controller]")]
    public class CompanyBankController : Controller
    {
        private ICompanyBankRepository _repository;
        private ISettingRepository _settingRepository;
        private IGlobalSettingRepository _globalSettingRepository;
        private ILogger<CompanyBankController> _logger;

        public CompanyBankController(ICompanyBankRepository repository, ISettingRepository settingRepository, IGlobalSettingRepository globalSettingRepository, ILogger<CompanyBankController> logger)
        {
            _repository = repository;
            _settingRepository = settingRepository;
            _globalSettingRepository = globalSettingRepository;
            _logger = logger;
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] CompanyBank item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            _repository.add(item);

            return new ObjectResult(item);

        }

        [HttpPut("{id}/reconnect")]
        public IActionResult reconnect(int id)
        {
            _repository.reconnect(id);
            return new NoContentResult();
        }


        [HttpPut("{id}/disconnect")]
        public IActionResult disconnect(int id)
        {
            CompanyBank item = _repository.get(id);

            // disconnect accounts soft deleting records on database
            _repository.disconnect(id);

            // remove item
            if (item.platform.ToLower()  == "plaid")
            {
                removeItemFromPlaid(item.access_token);
            }

            // remove connected item from Plaid
            return new NoContentResult();
        }

        private void removeItemFromPlaid(string accessToken)
        {
            try
            {
                Setting bankStreamEnvSetting = _settingRepository.get(name: "BANKSTREAM_ENVIRONMENT");
                List<GlobalSetting> globalSettings = (List<GlobalSetting>)_globalSettingRepository.search(section: "bankstream");

                string baseUrl;
                string clientId;
                string clientSecret;

                if (bankStreamEnvSetting.value.ToLower() == "production")
                {
                    baseUrl = GlobalSettings.getSettingValue(globalSettings, "BANKSTREAM_ENVIRONMENT_URL_PRODUCTION");
                    clientId = GlobalSettings.getSettingValue(globalSettings, "BANKSTREAM_CLIENT_ID_PRODUCTION");
                    clientSecret = GlobalSettings.getSettingValue(globalSettings, "BANKSTREAM_CLIENT_SECRET_PRODUCTION");
                }
                else
                {
                    baseUrl = GlobalSettings.getSettingValue(globalSettings, "BANKSTREAM_ENVIRONMENT_URL_SANDBOX");
                    clientId = GlobalSettings.getSettingValue(globalSettings, "BANKSTREAM_CLIENT_ID_SANDBOX");
                    clientSecret = GlobalSettings.getSettingValue(globalSettings, "BANKSTREAM_CLIENT_SECRET_SANDBOX");
                }

                string endpointUrl = baseUrl + "/item/remove";

                PlaidHelper.plaidRequest("POST", endpointUrl, new
                {
                    client_id = clientId,
                    secret = clientSecret,
                    access_token = accessToken,
                });
            }
            catch
            {
                // TODO: log this error
            }
        }
    }
}
```
## CompanyController.cs
```cs
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Repositories;
using AT.AT2017.Api.Validation;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Logging;
using System.Collections.Generic;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class CompanyController : Controller
    {
        public ICompanyRepository _repository;
        private ILogger<CompanyController> _logger;

        public CompanyController(ICompanyRepository repository, ILogger<CompanyController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpPut("validate")]
        public IActionResult validateModel([FromBody] Company  item)
        {
            ModelState.Clear();
            if (TryValidateModel(item))
                return new NoContentResult();
            else
            {               
                if (ModelState.ErrorCount == 0)
                    return new NoContentResult();
                else
                    return new ValidationFailedResult(ModelState);
            }
        }

        [HttpGet]
        public IEnumerable<Company> search(bool withTrash = false)
        {
            return _repository.search(withTrash);
        }

        [HttpGet("adminSearch")]
        public IEnumerable<Company> adminSearch()
        {
            return _repository.adminSearch();
        }

        [HttpGet("deleted")]
        public IEnumerable<Company> searchDeletedRecord(int pageIndex = 0, int pageSize = 10)
        {
            return _repository.searchDeletedRecord(pageIndex, pageSize);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        [ValidateModel]
        public IActionResult add([FromBody] Company item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        [ValidateModel]
        public IActionResult update(int id, [FromBody] Company item)
        {
            if (item == null || item.companyId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }
    }
}

```
## CompanyReportController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Core.Model_Report;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using System.Data;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class CompanyReportController : Controller
    {
        public ICompanyReportRepository _repository;
        private ILogger<CompanyReportController> _logger;

        public CompanyReportController(ICompanyReportRepository repository, ILogger<CompanyReportController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<CompanyReport> search(string name="", int id=0, int showDeleted=0, int dateType=0, string dateStart="", string dateEnd="",int pageIndex = 0, int pageSize = 100)
        {
            return _repository.search(name, id, showDeleted, dateType, dateStart,dateEnd, pageIndex, pageSize);
        }
    }
}

```
## CompanySettingController.cs
```cs
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Repositories;
using AT.AT2017.Api.Validation;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Logging;
using System.Collections.Generic;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class CompanySettingController : Controller
    {
        public ICompanySettingRepository _repository;
        private ILogger<CompanySettingController> _logger;

        public CompanySettingController(ICompanySettingRepository repository, ILogger<CompanySettingController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<Setting> search()
        {
            return _repository.search();
        }

        [HttpGet("action/{actionID}")]
        public IEnumerable<Setting> searchByAction(int actionID)
        {
            return _repository.searchByAction(actionID);
        }

        [HttpPut("actions")]
        public IActionResult updateActions(int actionID, [FromBody] List<Setting> settings)
        {
            _repository.updateActions(actionID, settings);

            return new NoContentResult();
        }
    }
}

```
## CorrespondenceMergeFieldController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class CorrespondenceMergeFieldController : Controller
    {
        public ICorrespondenceMergeFieldRepository _repository;
        private ILogger<CorrespondenceMergeFieldController> _logger;

        public CorrespondenceMergeFieldController(ICorrespondenceMergeFieldRepository repository, ILogger<CorrespondenceMergeFieldController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<CorrespondenceMergeField> search(string type = "")
        {
            return _repository.search(type );
        }
    }
}

```
## CorrespondenceTemplateController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Repositories;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class CorrespondenceTemplateController : Controller
    {
        public ICorrespondenceTemplateRepository _repository;
        private ILogger<CorrespondenceTemplate> _logger;

        public CorrespondenceTemplateController(ICorrespondenceTemplateRepository repository, ILogger<CorrespondenceTemplate> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<CorrespondenceTemplate> search(string name = "")
        {
            return _repository.search(name);
        }

        [HttpGet("{id}/frommastertype")]
        public IEnumerable<CorrespondenceTemplate> searchFromMaster(int typeId=0)
        {
            return _repository.searchFromMaster(typeId );
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPut("{id}/exporttomaster")]
        public IActionResult exportToMaster(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.exportToMaster(id);

            return new NoContentResult();
        }

        [HttpGet("{id}/frommaster")]
        public IActionResult getFromMaster(int id)
        {
            var item = _repository.getFromMaster(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] CorrespondenceTemplate item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] CorrespondenceTemplate item)
        {
            if (item == null || item.correspondenceTemplateId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }
    }
}

```
## CustomControlController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class CustomControlController : Controller
    {
        public ICustomControlRepository _repository;
        private ILogger<CustomControlController> _logger;

        public CustomControlController(ICustomControlRepository repository, ILogger<CustomControlController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<CustomControl> search(int packageID, string formName = "")
        {
            return _repository.search(packageID, formName);
        }

        [HttpPost]
        public IActionResult addOrUpdate([FromBody] CustomControl item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.addOrUpdate(item);

            item = _repository.get(id);

            return new ObjectResult(item);

        }

        [HttpPost("list")]
        public IActionResult addControlList(int packageID, string formName, [FromBody] IList<CustomControl> controls)
        {

            IList<CustomControl> existingControls = _repository.search(packageID, formName).ToList();

            foreach(CustomControl control in controls)
            {
                // search if control exists or not
                CustomControl foundControl = existingControls.FirstOrDefault((p) => p.name == control.name);
                if (foundControl is null)
                {
                    // save new custom control
                    _repository.addOrUpdate(control);
                }
            }

            return new NoContentResult();
        }
    }
}
```
## DashboardColumnsController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/dashboard/columns")]
    public class DashboardColumnsController : Controller
    {
        public IDashboardColumnsRepository  _repository;
        private ILogger<DashboardColumnsController > _logger;

        public DashboardColumnsController(IDashboardColumnsRepository repository, ILogger<DashboardColumnsController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<DashboardColumns> search(int dashboardID=0)
        {
            return _repository.search(dashboardID);
        }




      }
}

```
## DashboardController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class DashboardController : Controller
    {
        public IDashboardRepository _repository;
        private ILogger<DashboardController> _logger;

        public DashboardController(IDashboardRepository repository, ILogger<DashboardController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<Dashboard> search(int userId, string sectionName = "", string visible= "")
        {
            return _repository.search(userId, sectionName, visible);
        }

        [HttpGet("{id}")]
        public Dashboard get(int id)
        {
            return _repository.get(id);
        }

        [HttpPost]
        public IActionResult add([FromBody] Dashboard item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] Dashboard item)
        {
            if (item == null || item.dashboardId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpPut("columns/{id}")]
        public IActionResult update_columns(int id, [FromBody] Dashboard item)
        {
            if (item == null || item.dashboardId  != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update_columns (item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }
    }
}

```
## DashboardUserDetail.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/dashboard/userDetail")]
    public class DashboardUserDetailController : Controller
    {
        public IDashboardUserDetailRepository   _repository;
        private ILogger<DashboardUserDetailController> _logger;
        
        public DashboardUserDetailController(IDashboardUserDetailRepository repository, ILogger<DashboardUserDetailController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<DashboardUserDetail> search(int dashboardID=0, int userID=0)
        {
            return _repository.search(dashboardID, userID);
        }

    }
}

```
## DatabaseController.cs
```cs
using System.Collections.Generic;
using System.Linq;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;
using Microsoft.Extensions.Options;
using System.Data;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class DatabaseController : Controller
    {
        private IDatabaseRepository _repository;

        private ILogger<DatabaseController> _logger;

        private ApplicationSettings _appSettings;

        public DatabaseController(IDatabaseRepository repository, ILogger<DatabaseController> logger, IOptions<ApplicationSettings> appSettings)
        {
            _repository = repository;
            _logger = logger;
            _appSettings = appSettings.Value;
        }

        [HttpGet]
        public IEnumerable<Database> search(string corporateName = "", string active = "", string mode = "")
        {
            return _repository.search(corporateName, active, mode);
        }

        [HttpGet("active")]
        public IEnumerable<Database> searchActive()
        {
            return _repository.searchActive();
        }

        [HttpGet("bypackages")]
        public IEnumerable<Database> searchByPackages(int databaseID = 0, int packageID = 0, string expiresOn = "")
        {
            return _repository.searchByPackages(databaseID, packageID, expiresOn);
        }

        [HttpGet("servers")]
        public IEnumerable<Server> searchServers()
        {
            List <Server> serversList = new List<Server>();
            List<string> servers = _appSettings.DatabaseServers.Split(",").ToList();
            foreach (string server in servers)
            {
                serversList.Add(new Server { name = server });
            }
            return serversList;
        }

        [HttpGet("modes")]
        public IEnumerable<DatabaseMode> searchModes()
        {
            List<DatabaseMode> modesList = new List<DatabaseMode>();
            List<string> modes = _appSettings.DatabaseModes.Split(",").ToList();
            foreach (string mode in modes)
            {
                modesList.Add(new DatabaseMode { code = mode, description = mode });
            }
            return modesList;
        }

        [HttpGet("brandcodes")]
        public IEnumerable<BrandCode> searchBrandcodesFromSettings()
        {
            List<BrandCode> brandcodesList = new List<BrandCode>();
            List<string> brandcodes = _appSettings.BrandCodes.Split(",").ToList();
            foreach (string brandcode in brandcodes)
            {
                brandcodesList.Add(new BrandCode { code = brandcode, description = brandcode });
            }
            return brandcodesList;
        }

        [HttpGet("brandcodes/global")]
        public IEnumerable<BrandCode> searchBrandcodes()
        {
            return _repository.searchBrandCodes();
        }

        [HttpPut("{databaseId}")]
        public IActionResult update(int databaseId, [FromBody] Database item)
        {
            _repository.update(item);
            return NoContent();
        }

        [HttpPut("{databaseId}/contactinfo")]
        public IActionResult updateContactInfo(int databaseId, [FromBody] Database item)
        {
            _repository.updateContactInfo(item);
            return NoContent();
        }

        [HttpPut("triggers/enable")]
        public IActionResult enableTriggers()
        {
            _repository.enableTriggers();

            return new NoContentResult();
        }

        [HttpPut("servicebroker/enable")]
        public IActionResult enableServiceBroker()
        {
            _repository.enableServiceBroker();

            return new NoContentResult();
        }

        [HttpPut("fix/glaccountsetting")]
        public IActionResult fixGlAccountSetting()
        {
            _repository.fixGlAccountSetting();

            return new NoContentResult();
        }

        [HttpPut("synonyms/validate/{id}")]
        public IActionResult validateSynonyms(string nameServer)
        {
            _repository.validateSynonyms(nameServer);

            return new NoContentResult();
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost("{id}/package")]
        public int addPackage([FromBody] DatabasePackage item)
        {
            return _repository.addPackage(item);
        }

        [HttpPut("{id}/package")]
        public void updatePackage([FromBody] DatabasePackage item)
        {
            _repository.updatePackage(item);
        }

        [HttpPut("{id}/package/{databasePackageId}/cancel")]
        public void cancelPackage(int id, int databasePackageId)
        {
            _repository.cancelPackage(databasePackageId);
        }

        [HttpGet("newclient/steps")]
        public DataTable searchNewClientSetupSteps()
        {
            return _repository.searchNewClientSetupSteps();
        }

        [HttpGet("newclient/log/{logID}")]
        public NewClientSetupLog getNewClientSetupLog(int logID)
        {
            return _repository.getNewClientSetupLog(logID);
        }

        [HttpPost("newclient/setup")]
        public int runNewClientSetup(string serverName, string newDatabaseName, string mode, string brandCode, bool isDash, string contactFirstName, string contactLastName, string contactEmail, string executedBy, string originalDbName = null)
        {
            return _repository.runNewClientSetup(serverName, newDatabaseName, mode, brandCode, isDash, contactFirstName, contactLastName, contactEmail, executedBy, originalDbName);
        }

        [HttpGet("goingtolive/start")]
        public int startGoingToLive(string serverName, string dbName, string executedBy)
        {
            return _repository.startGoingTolive(serverName, dbName, executedBy);
        }

        [HttpPost("goingtolive/run")]
        public int runGoingToLive(string serverName, string dbName, string executedBy, int logID, bool keepAgentData, bool keepOtherPeopleData, bool keepPropertyData, bool keepPropertyACData, bool keepPropertyOPData, bool keepPropertyCLData, bool keepPropertyWDData, bool keepPropertyXPData, bool keepAccountingData, bool keepSettings)
        {
            return _repository.runGoingTolive(serverName, dbName, executedBy, logID, keepAgentData, keepOtherPeopleData, keepPropertyData, keepPropertyACData, keepPropertyOPData, keepPropertyCLData, keepPropertyWDData, keepPropertyXPData, keepAccountingData, keepSettings);
        }

        [HttpGet("goingtolive/log")]
        public GoingToLiveLog searchGoingToLiveLog(int logID)
        {
            return _repository.searchGoingToLiveLog(logID);
        }
    }
}

```
## DatabaseLoggedUserController.cs
```cs
using System.Collections.Generic;
using System.Linq;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;
using Microsoft.Extensions.Options;
using System.Data;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class DatabaseLoggedUserController : Controller
    {
        private IDatabaseLoggedUserRepository _repository;

        private ILogger<DatabaseLoggedUserController> _logger;

        public DatabaseLoggedUserController(IDatabaseLoggedUserRepository repository, ILogger<DatabaseLoggedUserController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet("summary/{id}")]
        public IEnumerable<DatabaseLoggedUser> searchSummary(int id = 0)
        {
            return _repository.searchSummary(id);
        }
    }
}

```
## DatabasePackageController.cs
```cs
using System.Collections.Generic;
using System.Linq;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;
using Microsoft.Extensions.Options;
using System.Data;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class DatabasePackageController : Controller
    {
        private IDatabasePackageRepository _repository;

        private ILogger<DatabasePackageController> _logger;

        private ApplicationSettings _appSettings;

        public DatabasePackageController(IDatabasePackageRepository repository, ILogger<DatabasePackageController> logger, IOptions<ApplicationSettings> appSettings)
        {
            _repository = repository;
            _logger = logger;
            _appSettings = appSettings.Value;
        }

        [HttpGet("lastpackage/{id}")]
        public IActionResult getLastPackage(int id, int userId)
        {
            var item = _repository.getLastPackage(id, userId);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }
    }
}

```
## DataImportController.cs
```cs
using System.Collections.Generic;
using System.Linq;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Classes;
using AT.AT2017.Api.Validation;
using System.Data;
using Newtonsoft.Json;
using Newtonsoft.Json.Linq;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class DataImportController : Controller
    {
        public IDataImportRepository _repository;
        private ILogger<DataImportController> _logger;

        public DataImportController(IDataImportRepository repository, ILogger<DataImportController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<DataImport> search(string type = "")
        {
            return _repository.search(type);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            DataImport item = _repository.get(id);
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] DataImport item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);

            return new ObjectResult(item);
        }

        [HttpPut]
        public IActionResult update([FromBody] DataImport item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpPut("{id}/process")]
        public IActionResult process(int id)
        {
            _repository.process(id);
            return new NoContentResult();
        }

        [HttpGet("{id}/processlog")]
        public IActionResult getProcessLog(int id)
        {
            List<DataImportLog> log = _repository.getProcessLog(id).ToList();
            return new ObjectResult(log);
        }

        [HttpGet("{id}/validate")]
        public IActionResult validate(int id)
        {
            List<DataImportRecord> records = _repository.validate(id).ToList();
            return new ObjectResult(records);
        }

        [HttpPost("processImportHistorical")]
        public int processImportHistorical(int id,[FromBody] IEnumerable<DataImportHistorical> detail)
        {
            int newId = _repository.processImportHistorical(id,detail);
            return newId;
        }

        [HttpPost("updateImportHistorical")]
        public int updateImportHistorical(int id, [FromBody] IEnumerable<DataImportHistorical> detail)
        {
            int newId = _repository.updateImportHistorical(id, detail);
            return newId;
        }

        [HttpGet("getImportHistorical")]
        public IActionResult getImportHistorical(int id)
        {
            var item = _repository.getImportHistorical(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }       
    }
}

```
## DataProblemController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Repositories;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Logging;

// For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class DataProblemController : Controller
    {

        public IDataProblemRepository _repository;

        private ILogger<DataProblemController> _logger;

        public DataProblemController(IDataProblemRepository repository, ILogger<DataProblemController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<DataProblem> search(string dbName, string errorCode, string resultType)
        {
            return _repository.search(dbName, errorCode, resultType);
        }

        [HttpGet("databases")]
        public IEnumerable<DataProblem> searchDatabases()
        {
            return _repository.searchDatabases();
        }


        [HttpGet("types")]
        public IEnumerable<DataProblem> searchDataProblemTypes(string dbName)
        {
            return _repository.searchDataProblemTypes(dbName);
        }

        [HttpPost]
        public void run(string dbName)
        {
            _repository.run(dbName);
        }

    }
}

```
## DeductionController.cs
```cs
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using System.Collections.Generic;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class DeductionController : Controller
    {

        public IDeductionRepository _repository;

        private ILogger<DeductionController> _logger;

        public DeductionController(IDeductionRepository repository, ILogger<DeductionController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<Deduction> search()
        {
            return _repository.search();
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] Deduction item)
        {
            if (item == null || item.deductionId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

    }
}

```
## DeductionFormulaController.cs
```cs
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using System.Collections.Generic;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/deduction/formula")]
    public class DeductionFormulaController : Controller
    {

        public IDeductionFormulaRepository _repository;

        private ILogger<DeductionFormulaController> _logger;

        public DeductionFormulaController(IDeductionFormulaRepository repository, ILogger<DeductionFormulaController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<DeductionFormula> search (int deductionId = 0)
        {
            return _repository.search(deductionId);
        }

        [HttpGet("research")]
        public IEnumerable<DeductionFormula> research (string deductionIDs = "", string formula = "", string officeIDs = "", string planIDs = "", string usedForClassificationIDs = "", string usedForTRTypes = "",
                                                       string sides = "", string sellerLeadSourceIDs = "", string buyerLeadSourceIDs = "")
        {
            return _repository.research(deductionIDs, formula, officeIDs, planIDs, usedForClassificationIDs, usedForTRTypes, sides, sellerLeadSourceIDs, buyerLeadSourceIDs);
        }

        [HttpGet("frommaster")]
        public IEnumerable<DeductionFormula> searchFromMaster()
        {
            return _repository.searchFromMaster();
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpGet("{id}/frommaster")]
        public IActionResult getFromMaster(int id)
        {
            var item = _repository.getFromMaster(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPut("{id}/exporttomaster")]
        public IActionResult exportToMaster(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.exportToMaster(id);

            return new NoContentResult();
        }

        [HttpGet("mergefield")]
        public IEnumerable<DeductionFormulaMergeField> searchMergeFields(string type = "deductionBased")
        {
            return _repository.searchMergeFields(type);
        }

        [HttpGet("operator")]
        public IEnumerable<DeductionFormulaOperator> searchOperators(string type = "deductionBased")
        {
            return _repository.searchOperators(type);
        }

        [HttpGet("functions")]
        public IEnumerable<DeductionFormulaFunction> searchFunctions()
        {
            return _repository.searchFunctions();
        }

        [HttpPost]
        public IActionResult add([FromBody] DeductionFormula item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] DeductionFormula item)
        {
            if (item == null || item.formulaId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }
    }
}

```
## DeductionPlanController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/deduction/plan")]
    public class DeductionPlanController : Controller
    {

        public IDeductionPlanRepository _repository;

        private ILogger<DeductionPlanController> _logger;

        public DeductionPlanController(IDeductionPlanRepository repository, ILogger<DeductionPlanController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<DeductionPlan> search(int companyId = 0, bool isAgent = false)
        {
            return _repository.search(companyId, isAgent);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] DeductionPlan item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut]
        public IActionResult update([FromBody] IEnumerable<DeductionPlan> table, bool includeTotals = false)
        {
            _repository.update(table,includeTotals);

            return new NoContentResult();
        }


        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }

    }
}

```
## DeductionScaleController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/deduction/scale")]
    public class DeductionScaleController : Controller
    {

        public IDeductionScaleRepository _repository;

        private ILogger<DeductionScaleController> _logger;

        public DeductionScaleController(IDeductionScaleRepository repository, ILogger<DeductionScaleController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<DeductionScale> search(string scaleName = "")
        {
            return _repository.search(scaleName);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] DeductionScale item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] DeductionScale item)
        {
            if (item == null || item.deductionScaleID != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }

    }
}

```
## DeductionSubplanController.cs
```cs
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Repositories;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Logging;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/deduction/subplan")]
    public class DeductionSubplanController : Controller
    {

        public IDeductionSubplanRepository _repository;

        private ILogger<DeductionSubplanController> _logger;

        public DeductionSubplanController(IDeductionSubplanRepository repository, ILogger<DeductionSubplanController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<DeductionSubplan> search(int companyId = 0, bool isAgent = false)
        {
            return _repository.search(companyId, isAgent);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] DeductionSubplan item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut]
        public IActionResult update([FromBody] IEnumerable<DeductionSubplan> table)
        {
            _repository.update(table);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }
    }
}

```
## DeletedRecordController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class DeletedRecordController : Controller
    {
        public IDeletedRecordRepository _repository;
        private ILogger<DeletedRecordController> _logger;

        public DeletedRecordController(IDeletedRecordRepository repository, ILogger<DeletedRecordController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<DeletedRecord> search()
        {            
            return _repository.search();
        }

     }
}

```
## DivideExpenseTemplateController.cs
```cs
using System.Collections.Generic;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class DivideExpenseTemplateController : Controller
    {
        public IDivideExpenseTemplateRepository _repository;
        public IVoucherRepository _voucherRepository;
        private ILogger<DivideExpenseTemplateController> _logger;

        public DivideExpenseTemplateController(IDivideExpenseTemplateRepository repository, ILogger<DivideExpenseTemplateController> logger, IVoucherRepository voucherRepository)
        {
            _repository = repository;
            _logger = logger;
            _voucherRepository= voucherRepository;
        }


        [HttpGet]
        public IEnumerable<DivideExpenseTemplate> search()
        {
            return _repository.search();
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] DivideExpenseTemplate item)
        {
            if (item == null)
            {
                return BadRequest();
            }
           
            int idV = _repository.add(item);
            var itemV = _voucherRepository.get(idV);

            return new ObjectResult(itemV);
        }
    }
}

```
## DocumentController.cs
```cs
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using System.Collections.Generic;
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class DocumentController : Controller
    {
        public IDocumentRepository _repository;

        private ILogger<DocumentController> _logger;

        public DocumentController(IDocumentRepository repository, ILogger<DocumentController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet("searchPending")]
        public IEnumerable<Document> searchPending(string docType ="")
        {
            return _repository.searchPending(docType);
        }

        [HttpPut()]
        public IActionResult update( [FromBody] Document item)
        {
            if (item == null )
            {
                return BadRequest();
            }         

            _repository.update(item);

            return new NoContentResult();
        }
    }
}
```
## DropDownController.cs
```cs
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using System.Collections.Generic;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{

    [Route("api/[controller]")]
    public class DropDownController : Controller
    {

        public IDropDownRepository _repository;

        private ILogger<DropDownController> _logger;

        public DropDownController(IDropDownRepository repository, ILogger<DropDownController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<Dropdown> search(string type)
        {
            return _repository.search(type);
        }
     }
}

```
## ErrorCodeController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class ErrorCodeController : Controller
    {
        public IErrorCodeRepository _repository;
        private ILogger<ErrorCodeController> _logger;

        public ErrorCodeController(IErrorCodeRepository repository, ILogger<ErrorCodeController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<ErrorCode> search(int systemID, int moduleID, int errorCodeID)
        {
            return _repository.search(systemID,moduleID,errorCodeID);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] ErrorCode item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] ErrorCode item)
        {
            if (item == null || item.errorCodeID != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }
    }

    [Route("api/[controller]")]
    public class SystemController : Controller
    {
        public ISystemRepository _repository;
        private ILogger<SystemController> _logger;

        public SystemController(ISystemRepository repository, ILogger<SystemController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<SystemErrorCode> search(int systemID)
        {
            return _repository.search(systemID);
        }
    }

    [Route("api/[controller]")]
    public class ModuleController : Controller
    {
        public IModuleRepository _repository;
        private ILogger<ModuleController> _logger;

        public ModuleController(IModuleRepository repository, ILogger<ModuleController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<ModuleErrorCode> search(int systemID, int moduleID)
        {
            return _repository.search(systemID, moduleID);
        }

    }
}

```
## ExtraVoucherController.cs
```cs
using System;
using System.Collections.Generic;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using AT.AT2017.Api.Core.Models;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Validation;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class ExtraVoucherController : Controller
    {
        public IExtraVoucherRepository _repository;
        private ILogger<ExtraVoucherController> _logger;

        public ExtraVoucherController(IExtraVoucherRepository repository, ILogger<ExtraVoucherController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<ExtraVoucher> search(int companyID, bool withTrash = false)
        {
            return _repository.search(companyID, withTrash);
        }

        [HttpGet("deleted")]
        public IEnumerable<ExtraVoucher> searchDeletedRecord(int pageIndex = 0, int pageSize = 10)
        {
            return _repository.searchDeletedRecord(pageIndex, pageSize);
        }


        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        [ValidateModel]
        public IActionResult add([FromBody] ExtraVoucher item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        [ValidateModel]
        public IActionResult update(int id, [FromBody] ExtraVoucher item)
        {
            if (item == null || item.extraVoucherID != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }
    }
}


```
## FeedController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;
using System.Data.Odbc;
using System.Net;
using System.IO;
using Newtonsoft.Json.Linq;
using System.Text;
using System.Web;
using System.Data.SqlClient;
using System.Data;
using AT.AT2017.Api.Core.Models.Feeds;
using Newtonsoft.Json;
using AT.AT2017.Api.Classes;

namespace AT.AT2017.Api.Controllers
{

    [Route("api/[controller]")]
    public class FeedController : Controller
    {
        private IFeedRepository _repository;
        private ISettingRepository _settingRepository;
        private ILogger<FeedController> _logger;

        public FeedController(IFeedRepository repository, ISettingRepository settingRepository, ILogger<FeedController> logger)
        {
            _repository = repository;
            _settingRepository = settingRepository;
            _logger = logger;
        }

        [HttpPost]
        public IActionResult add([FromBody] Feed feed)
        {
            if (feed == null)
            {
                return BadRequest();
            }

            int id = _repository.add(feed);

            feed = _repository.get(id);
            return new ObjectResult(feed);
        }

        [HttpGet("add_submit_init")]
        public int add_submit_init(int id)
        {

            return _repository.add_submit_init(id);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] Feed feed)
        {
            if (feed == null || feed.feedID != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(feed);

            return new NoContentResult();
        }

        [HttpPut("updateinit")]
        public IActionResult update_init(int feedID, string companyID, string companyGUID, string brandCode)
        {
            _repository.update_init(feedID, companyID, companyGUID, brandCode);
            return new NoContentResult();
        }

        [HttpGet]
        public IEnumerable<Feed> search(int feedTypeID, int feedSubtypeID, int feedResourceID)
        {
            return _repository.search(feedTypeID, feedSubtypeID, feedResourceID);
        }

        [HttpPut("{id}/exporttomaster")]
        public IActionResult exportToMaster(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.exportToMaster(id);

            return new NoContentResult();
        }

        [HttpGet("frommaster")]
        public IEnumerable<Feed> search_from_master(int feedTypeID, int feedSubtypeID, int feedResourceID)
        {
            return _repository.search_from_master(feedTypeID, feedSubtypeID, feedResourceID);
        }

        [HttpGet("search_submit_init")]
        public IEnumerable<Feed> search_submit_init(int feedTypeID, int feedSubtypeID, string process = "", string brandCode = "")
        {
            return _repository.search_from_submit_init(feedTypeID, feedSubtypeID, process, brandCode);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpGet("by_setting/{setting}/{propID}")]
        public IActionResult get_by_setting(string setting, int propID)
        {
            var item = _repository.get_by_setting(propID, setting);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpGet("{id}/frommaster")]
        public IActionResult get_from_master(int id)
        {
            var item = _repository.get_from_master(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();
        }

        [HttpPost("{feedType}/{feedSubType}/test")]
        public IActionResult test(string feedType, string feedSubType, [FromBody] Feed feed)
        {
            if (feed == null)
            {
                return BadRequest();
            }

            bool bExec = false;
            try
            {
                switch (feedType)
                {
                    case "DOTLOOP":
                        bExec = getConexionDOTLOOP(feed);
                        break;
                    case "ERELO":
                        bExec = getConexionERELO(feed);
                        break;
                    case "SKYSLOPE":
                        bExec = getConexionSKYSLOPE(feed);
                        break;
                    case "MLS":
                        bExec = getConexionMLS(feed);
                        break;
                    case "DASH":
                        bExec = getConexionDASH(feed, feedSubType);
                        break;
                    case "CATYLIST":
                        bExec = getConexionCATYLIST(feed);
                        break;
                    default:
                        break;
                }
            }
            catch (Exception)
            {
                throw;
            }

            return new ObjectResult(bExec);
        }

        [HttpPut("{id}/copy")]
        public IActionResult copy(int id, string feedNameDest, int feedTypeIDDest, int feedSubTypeIDDest, int feedResourceIDDest)
        {

            int feedID = _repository.copy(id, feedNameDest, feedTypeIDDest, feedSubTypeIDDest, feedResourceIDDest);
            Feed feed = _repository.get(feedID);

            return new ObjectResult(feed);

        }

        private bool getConexionMLS(Feed feed)
        {
            try
            {
                var strCon = "Driver=ezRETS ODBC Driver" +
                                ";LoginUrl=" + feed.url +
                                ";UID=" + feed.username +
                                ";PWD=" + feed.password +
                                ";StandardNames=" + feed.StandardNames +
                                ";UserAgent=" + feed.RetsUserAgent +
                                ";UseHttpGet=" + feed.UseHttpGet +
                                ";RetsVersion=" + feed.RetsVersion +
                                ";UseBulkMetadata=" + feed.UseBulkMetadata +
                                ";IgnoreMetadataType=" + feed.IgnoreMetadataType +
                                ";UseCompactFormat=" + feed.UseCompactFormat + ";";

                if (feed.EnableUserAgentAuth.ToUpper() == "TRUE")
                {
                    strCon += "EnableUserAgentAuth=" + feed.EnableUserAgentAuth.ToUpper() + ";UserAgentAuthType=" + feed.UserAgentAuthType.ToUpper() + ";UserAgentPassword=" + feed.UserAgentPassword + ";";
                }
                if (feed.UseHttpLogging.ToUpper() == "TRUE")
                {
                    strCon += "UseHttpLogging=" + feed.UseHttpLogging + ";HttpLogFile=" + feed.UseHttpLogging + ";";
                }
                if (feed.UseDebugLogging.ToUpper() == "TRUE")
                {
                    strCon += "UseDebugLogging=" + feed.UseDebugLogging + ";DebugLogFile=" + feed.UseDebugLogging + ";";
                }

                using (var cnRest = new OdbcConnection(strCon))
                {
                    cnRest.Open();
                    cnRest.Close();
                }

                return true;
            }
            catch (Exception ex)
            {
                throw ex;
            }
        }

        private bool getConexionDOTLOOP(Feed feed)
        {
            try
            {
                string api_url = feed.url;
                string api_key = feed.password;
                string profile_Id = feed.username;

                //string auth_header_name = "Authorization";
                string auth_header_value = "Bearer " + api_key;
                string endpoint_loops = api_url + "profile/" + profile_Id + "/loop?batchNumber=1&batchSize=50&sortBy=4&sortDirection=0";

                //create http request
                var req = (HttpWebRequest)WebRequest.Create(endpoint_loops);
                req.Accept = "application/json";
                req.Headers.Add("Authorization", auth_header_value);
                req.PreAuthenticate = true;

                var res = (WebResponse)req.GetResponse();
                string jsonResponse;
                using (var stream = res.GetResponseStream())
                {
                    var str = new StreamReader(stream);
                    jsonResponse = str.ReadToEnd();
                }

                //build json object with API response
                jsonResponse = "{\"response\":" + jsonResponse + "}";
                var obj = JObject.Parse(jsonResponse);
                return true;
            }
            catch (Exception ex)
            {
                throw ex;
            }
        }

        private bool getConexionDASH(Feed feed, string subType)
        {
            try
            {

                // get Dash settings
                List<Setting> dashSettings = _settingRepository.searchDashSettings().ToList();

                //string companyStatus = getSettingValue(dashSettings, "COMPANY_STATUS").ToLower();
                //string dashSandbox = getSettingValue(dashSettings, "DASH_SANDBOX");

                //string suffix = "_PROD";
                //if (!(companyStatus == "live" || companyStatus == "production" || companyStatus == "prod"))
                //{
                //    suffix = "_NONPROD"; // sandbox suffix by default
                //    if (!string.IsNullOrEmpty(dashSandbox))
                //        suffix = "_" + dashSandbox;
                //}

                //string baseUrl = getSettingValue(dashSettings, "DASH_API_APIGEE_BASE_URL" + suffix);
                //string apiKey = getSettingValue(dashSettings, "DASH_API_APIGEE_API_KEY" + suffix);

                //string tokenUrl = getSettingValue(dashSettings, "DASH_API_TOKEN_URL" + suffix);
                //string grantType = getSettingValue(dashSettings, "DASH_API_TOKEN_GRANT_TYPE" + suffix);
                //string scope = getSettingValue(dashSettings, "DASH_API_TOKEN_SCOPE" + suffix);
                //string clientId = getSettingValue(dashSettings, "DASH_API_TOKEN_CLIENT_ID" + suffix);
                //string clientSecret = getSettingValue(dashSettings, "DASH_API_TOKEN_CLIENT_SECRET" + suffix);

                // use always PROD settings for Feeds (required by Adam)
                string baseUrl = getSettingValue(dashSettings, "DASH_API_APIGEE_BASE_URL_PROD");
                string apiKey = getSettingValue(dashSettings, "DASH_API_APIGEE_API_KEY_PROD");

                string tokenUrl = getSettingValue(dashSettings, "DASH_API_TOKEN_URL_PROD");
                string grantType = getSettingValue(dashSettings, "DASH_API_TOKEN_GRANT_TYPE_PROD");
                string scope = getSettingValue(dashSettings, "DASH_API_TOKEN_SCOPE_PROD");
                string clientId = getSettingValue(dashSettings, "DASH_API_TOKEN_CLIENT_ID_PROD");
                string clientSecret = getSettingValue(dashSettings, "DASH_API_TOKEN_CLIENT_SECRET_PROD");

                string accessToken = getDashAccessToken(tokenUrl, grantType, scope, clientId, clientSecret);

                // get feed configuration
                string api_url = feed.url;
                string profile_Id = feed.username;
                string brand = feed.dashBrandCode;
                string brand1 = feed.dashBrandCode;
                string categoryName = feed.dashCategoryname;
                string fromDate = feed.dashFromDate;
                string toDate = feed.dashToDate;
                string typeId = feed.dashTypeId;
                string valueId = feed.dashValueId;
                string secondaryURL = feed.dashSecondaryURL;
                string ids = feed.dashValueId;
                string companyID = feed.dashCompanyId;

                // remove last /
                if (baseUrl.EndsWith("/")) {
                    baseUrl = baseUrl.Substring(0, baseUrl.Length - 1);
                }

                // replace {BASE_URL}
                api_url = api_url.Replace("{BASE_URL}", baseUrl);

                // build final URL (endpoint)
                string endpoint;

                switch (subType) //cboSubType.Text'
                {
                    case "CodeValue":
                        if (string.IsNullOrEmpty(brand) || string.IsNullOrEmpty(categoryName))
                        {
                            throw new InvalidDataException("The dash parameters: brand, category Name are required.");
                        }
                        endpoint = string.Format(api_url + "?brand={0}&{1}", brand, categoryName);
                        break;
                    case "Company":
                        if (string.IsNullOrEmpty(typeId) || string.IsNullOrEmpty(valueId))
                        {
                            throw new InvalidDataException("The dash parameter: id type and id value are required.");
                        }
                        endpoint = string.Format(api_url + "{0}?idType={1}", valueId, typeId);
                        break;
                    case "OfficeMarketing":
                        if (string.IsNullOrEmpty(fromDate) && string.IsNullOrEmpty(brand))
                        {
                            throw new InvalidDataException("The dash parameter: from date and secondary URL are required.");
                        }
                        endpoint = string.Format(api_url + "?fromDate={0}{1}", fromDate, (brand1 == "" ? "" : "&brandCode=" + brand1));
                        break;
                    case "CompanyStaff":
                    case "CommercialSaleListing":
                    case "ResidentialSaleListing":
                    case "SaleTransaction":
                    case "OtherIncomeTransaction":
                        if (string.IsNullOrEmpty(brand1) && string.IsNullOrEmpty(companyID))
                        {
                            throw new InvalidDataException("The dash parameter: from date, company id and secondary URL are required.");
                        }
                        switch (subType)
                        {
                            case "CompanyStaff":
                                endpoint = string.Format(api_url + "?fromDate={0}{1}{2}", fromDate, (brand1 == "" ? "" : "&brandCode=" + brand1), (companyID == "" ? "" : "&companyIds=" + companyID));
                                break;
                            case "CommercialSaleListing":
                                endpoint = string.Format(api_url + "?companyGuid={0}", companyID);
                                break;
                            case "ResidentialSaleListing":
                                endpoint = string.Format(api_url + "?companyGuid={0}", companyID);
                                break;
                            case "SaleTransaction":
                                endpoint = string.Format(api_url + "?criteria.officeGuid={0}", companyID);
                                break;
                            case "OtherIncomeTransaction":
                                endpoint = string.Format(api_url + "?criteria.officeGuid={0}", companyID);
                                break;
                            default:
                                endpoint = "";
                                break;
                        }
                        break;
                    default:
                        endpoint = "";
                        break;
                }

                // create http request
                HttpWebRequest req = (HttpWebRequest)WebRequest.Create(endpoint);
                req.Method = "GET";

                // add authorization headers
                req.Headers.Add("apiKey", apiKey);
                req.Headers.Add("Authorization", "Bearer " + accessToken);

                using (WebResponse response = req.GetResponse())
                {
                    using (Stream responseStream = response.GetResponseStream())
                    {
                        StreamReader responseReader = new StreamReader(response.GetResponseStream());
                        string strResponseText = responseReader.ReadToEnd();
                    }
                }

                return true;
            }
            catch (WebException ex)
            {
                string errorMessage = ProcessWebException(ex);
                throw new Exception(errorMessage);
            }
            catch (Exception ex)
            {
                throw ex;
            }
        }

        private bool getConexionERELO(Feed feed)
        {
            try
            {
                //var dtResult = new DataTable();
                var api_url = feed.url;
                var username = feed.username;
                var password = feed.password;

                var dFrom = "2016-12-27T19:09:00";
                var dTo = "2017-12-27T19:09:00";

                var httpReq = (HttpWebRequest)WebRequest.Create("https://api.erelocation.net/default.asmx/GetReferrals");
                var encoded = System.Convert.ToBase64String(Encoding.GetEncoding("ISO-8859-1").GetBytes(username + ":" + password));
                httpReq.Headers.Add("Authorization", "Basic " + encoded);
                var encoding = new ASCIIEncoding();
                var postData = encoding.GetBytes("RefSeqIDCSVString=&ThirdPartyReferralIDCSVString=&ReferralGUIDCSVString=&UpdatedSinceUTC=" + HttpUtility.UrlEncode(dFrom) + "&UpdatedTilUTC=" + HttpUtility.UrlEncode(dTo) + "&FormatName=");
                httpReq.ContentType = "application/x-www-form-urlencoded";
                httpReq.Method = "POST";
                httpReq.ContentLength = postData.Length;
                var ReqStrm = httpReq.GetRequestStream();
                ReqStrm.Write(postData, 0, postData.Length);
                ReqStrm.Close();
                var httpResp = (HttpWebResponse)httpReq.GetResponse();
                var respStrm = new StreamReader(httpResp.GetResponseStream(), Encoding.ASCII);
                // Dim result As String = respStrm.ReadToEnd()
                // Dim xml = System.Xml.Linq.XElement.Parse(result)
                httpResp.Close();
                respStrm.Close();
                return true;
            }
            catch (Exception ex)
            {
                throw ex;
            }
        }

        private bool getConexionSKYSLOPE(Feed feed)
        {
            try
            {
                var api_url = feed.url;
                var email = feed.username;
                var password = feed.password;
                var startDate = "1/1/" + DateTime.Now.Year.ToString();
                startDate = DateTime.Parse(startDate).ToShortDateString();
                var endDate = DateTime.Now.Month.ToString() + "/" + DateTime.Now.Day.ToString() + "/" + DateTime.Now.Year.ToString();
                var postData = "{\"Email\":\"" + email + "\",\"Password\":\"" + password + "\",\"StartDate\": \"" + startDate + "\",\"EndDate\": \"" + endDate + "\"}";
                var data = Encoding.UTF8.GetBytes(postData);

                var req = (HttpWebRequest)WebRequest.Create(api_url);
                req.Method = "POST";
                req.Headers.Add("cache-control", "no-cache");
                // req.Headers.Add("content-type", "application/json");
                req.ContentType = "application/json; charset=UTF-8";
                req.ContentLength = data.Length;
                req.Accept = "application/json";

                var st = req.GetRequestStream();
                st.Write(data, 0, data.Length);
                st.Close();

                var res = (WebResponse)req.GetResponse();
                string jsonResponse;
                using (var stream = res.GetResponseStream())
                {
                    var str = new StreamReader(stream);
                    jsonResponse = str.ReadToEnd();
                }

                jsonResponse = "{\"response\":" + jsonResponse + "}";
                var obj = JObject.Parse(jsonResponse);
                var txs = obj.SelectToken("response").Children();
                return true;
            }
            catch (Exception ex)
            {
                throw ex;
            }
        }

        private bool getConexionCATYLIST(Feed feed)
        {
            return _repository.getConexionCATYLIST(feed);
        }

        private string getDashAccessToken(string tokenUrl, string grantType, string scope, string clientId, string clientSecret)
        {
            string accessToken = "";
            try
            {
                Uri uri = new Uri(tokenUrl);

                // create web request
                HttpWebRequest request = (HttpWebRequest)WebRequest.Create(uri.AbsoluteUri.ToString());
                request.Method = "POST";

                request.ContentType = "application/x-www-form-urlencoded";

                request.Headers.Add("grant_type", grantType);
                request.Headers.Add("scope", scope);
                request.Headers.Add("client_id", clientId);
                request.Headers.Add("client_secret", clientSecret);

                List<string> keyValueList = new List<string>();
                keyValueList.Add(string.Format("{0}={1}", "grant_type", grantType));
                keyValueList.Add(string.Format("{0}={1}", "scope", scope));
                keyValueList.Add(string.Format("{0}={1}", "client_id", clientId));
                keyValueList.Add(string.Format("{0}={1}", "client_secret", clientSecret));

                ASCIIEncoding encoding = new ASCIIEncoding();
                byte[] postData = encoding.GetBytes(string.Join("&", keyValueList));

                // add headers
                request.ContentType = "application/x-www-form-urlencoded";
                request.ContentLength = postData.Length;

                Stream reqStrm = request.GetRequestStream();
                reqStrm.Write(postData, 0, postData.Length);
                reqStrm.Close();

                // get response
                string tokenResponse = string.Empty;
                using (HttpWebResponse webResponse = (HttpWebResponse)request.GetResponse())
                {
                    using (Stream stream = webResponse.GetResponseStream())
                    {
                        using (StreamReader reader = new StreamReader(stream))
                        {
                            tokenResponse = reader.ReadToEnd();
                        }
                    }
                }

                object oResponse = JsonConvert.DeserializeObject(tokenResponse);

                if (oResponse is JObject)
                {
                    accessToken = ((JObject)oResponse).SelectToken("access_token").ToString();
                }

            }
            catch
            {
                accessToken = string.Empty;
            }

            return accessToken;

        }

        private string getSettingValue(List<Setting> settings, string name)
        {
            string value = string.Empty;
            Setting setting = settings.Find(p => p.name == name);
            if (setting != null)
                value = setting.value;
            return value;
        }

        private string ProcessWebException(WebException e)
        {
            string errorMessage = "";
            try
            {
                string strResponse = string.Empty;
                using (HttpWebResponse response = (HttpWebResponse)e.Response)
                {
                    using (Stream responseStream = response.GetResponseStream())
                    {
                        StreamReader responseReader = new StreamReader(response.GetResponseStream());
                        string json = responseReader.ReadToEnd();
                        JObject jsonResponse = JsonConvert.DeserializeObject<JObject>(json);
                        errorMessage = jsonResponse.SelectToken("message").ToString();
                    }
                }
            }
            catch (Exception ex)
            {
                errorMessage = ex.Message;
            }
            return errorMessage;
        }

    }

    [Route("api/[controller]")]
    public class FeedExecutionController : Controller
    {
        public IFeedExecutionRepository _repository;
        private ILogger<FeedExecutionController> _logger;

        public FeedExecutionController(IFeedExecutionRepository repository, ILogger<FeedExecutionController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<FeedExecution> search(int feedID)
        {
            return _repository.search(feedID);
        }

    }

    [Route("api/[controller]")]
    public class FeedExecutionDetailController : Controller
    {
        public IFeedExecutionDetailRepository _repository;
        private ILogger<FeedExecutionDetailController> _logger;

        public FeedExecutionDetailController(IFeedExecutionDetailRepository repository, ILogger<FeedExecutionDetailController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<FeedExecutionDetail> search(int executionID, int parentExecutionDetailID = 0)
        {
            return _repository.search(executionID, parentExecutionDetailID);
        }

        [HttpGet("searchcustom")]
        public IEnumerable<FeedExecutionDetail> search_custom(int executionID)
        {
            return _repository.search_custom(executionID);
        }

        [HttpGet("sourcedata")]
        public IEnumerable<FeedExecutionSourceRecordField> getSourceData(int sourceRecordID)
        {
            return _repository.getSourceData(sourceRecordID);
        }

    }

    [Route("api/[controller]")]
    public class FeedExecutionRecordController : Controller
    {
        public IFeedExecutionRecordRepository _repository;
        private ILogger<FeedExecutionRecordController> _logger;

        public FeedExecutionRecordController(IFeedExecutionRecordRepository repository, ILogger<FeedExecutionRecordController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<FeedExecutionRecord> search(int executionID, string type)
        {
            return _repository.search(executionID, type);
        }


        [HttpGet("parentRecords/{executionID}")]
        public IEnumerable<FeedExecutionRecord> searchParentRecords(int executionID)
        {
            return _repository.searchParentRecords(executionID);
        }

        [HttpGet("executeRecordChild")]
        public IEnumerable<FeedExecutionRecordChild> searchChild(int executionID, int executionRecordId, string type)
        {
            return _repository.searchChild(executionID, executionRecordId, type);
        }

        [HttpGet("executeTransformationView")]
        public IEnumerable<FeedExecutionTransformationView> searchTransformation(int executionID, string executionRecordId, string type)
        {
            return _repository.searchTransformation(executionID, executionRecordId, type);
        }

        [HttpGet("executeTransformationDetail")]
        public IEnumerable<FeedExecutionTransformationDetail> searchTransformationDetail(int executionID, int executionRecordId)
        {
            return _repository.searchTransformationDetail(executionID, executionRecordId);
        }

    }

    [Route("api/[controller]")]
    public class FeedFilterController : Controller
    {
        public IFeedFilterRepository _repository;
        private ILogger<FeedFilterController> _logger;

        public FeedFilterController(IFeedFilterRepository repository, ILogger<FeedFilterController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpGet("executeSentence")]
        public string executeSentence(string sentence)
        {
            return _repository.executeSentence(sentence);
        }

        [HttpGet]
        public IEnumerable<FeedFilter> search(int feedID)
        {
            return _repository.search(feedID);
        }

        [HttpGet("frommaster")]
        public IEnumerable<FeedFilter> search_from_master(int feedID)
        {
            return _repository.search_from_master(feedID);
        }

    }

    [Route("api/[controller]")]
    public class FeedPODFilterController : Controller
    {
        public IFeedPODFilterRepository _repository;
        private ILogger<FeedPODFilterController> _logger;

        public FeedPODFilterController(IFeedPODFilterRepository repository, ILogger<FeedPODFilterController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<FeedPODFilter> search(int feedID)
        {
            return _repository.search(feedID);
        }

        [HttpGet("frommaster")]
        public IEnumerable<FeedPODFilter> search_from_master(int feedID)
        {
            return _repository.search_from_master(feedID);
        }


        [HttpGet("byname")]
        public FeedPODFilter getByName(int feedResourceID, string sourceField)
        {
            return _repository.getByName(feedResourceID, sourceField);
        }

        [HttpPost]
        public IActionResult add([FromBody] FeedPODFilter item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] FeedPODFilter item)
        {
            if (item == null || item.feedFilterID != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }

    }

    [Route("api/[controller]")]
    public class FeedFilterDetailController : Controller
    {
        public IFeedFilterDetailRepository _repository;
        private ILogger<FeedFilterDetailController> _logger;

        public FeedFilterDetailController(IFeedFilterDetailRepository repository, ILogger<FeedFilterDetailController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpGet]
        public IEnumerable<FeedFilterDetail> search(int feedID, int feedFilterID)
        {
            return _repository.search(feedID, feedFilterID);
        }

        [HttpGet("frommaster")]
        public IEnumerable<FeedFilterDetail> search_from_master(int feedID, int feedFilterID)
        {
            return _repository.search_from_master(feedID, feedFilterID);
        }

    }

    [Route("api/[controller]")]
    public class FeedMappingController : Controller
    {
        public IFeedMappingRepository _repository;
        private ILogger<FeedMappingController> _logger;

        public FeedMappingController(IFeedMappingRepository repository, ILogger<FeedMappingController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpGet]
        public IEnumerable<FeedMapping> search(int feedID)
        {
            return _repository.search(feedID);
        }

        [HttpGet("frommaster")]
        public IEnumerable<FeedMapping> search_from_master(int feedID)
        {
            return _repository.search_from_master(feedID);
        }

    }

    [Route("api/[controller]")]
    public class FeedMappingDetailController : Controller
    {
        public IFeedMappingDetailRepository _repository;
        private ILogger<FeedMappingDetailController> _logger;

        public FeedMappingDetailController(IFeedMappingDetailRepository repository, ILogger<FeedMappingDetailController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpGet]
        public IEnumerable<FeedMappingDetail> search(int feedID, int mappingID)
        {
            return _repository.search(feedID, mappingID);
        }

        [HttpGet("frommaster")]
        public IEnumerable<FeedMappingDetail> search_from_master(int feedID, int mappingID)
        {
            return _repository.search_from_master(feedID, mappingID);
        }

    }

    [Route("api/[controller]")]
    public class FeedTransformationController : Controller
    {
        public IFeedTransformationRepository _repository;
        private ILogger<FeedTransformationController> _logger;

        public FeedTransformationController(IFeedTransformationRepository repository, ILogger<FeedTransformationController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpGet]
        public IEnumerable<FeedTransformation> search(int feedID, int mappingID)
        {
            return _repository.search(feedID, mappingID);
        }

        [HttpGet("frommaster")]
        public IEnumerable<FeedTransformation> search_from_master(int feedID, int mappingID)
        {
            return _repository.search_from_master(feedID, mappingID);
        }

        [HttpPost("evalCondition")]
        public string evalCondition([FromBody] string condition)
        {
            return _repository.evalCondition(condition);
        }

        [HttpPost("evalReplaceWith")]
        public string evalReplaceWith([FromBody] string condition)
        {
            return _repository.evalReplaceWith(condition);
        }

        [HttpGet("templates")]
        public IEnumerable<FeedTransformation> getTemplates(int feedID, int mappingID, int sourceFieldID, int atFieldID)
        {
            return _repository.getTemplates(feedID, mappingID, sourceFieldID, atFieldID);
        }

    }

    [Route("api/[controller]")]
    public class FeedScheduleController : Controller
    {
        public IFeedScheduleRepository _repository;
        private ILogger<FeedScheduleController> _logger;

        public FeedScheduleController(IFeedScheduleRepository repository, ILogger<FeedScheduleController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpGet]
        public IEnumerable<FeedSchedule> search(int feedID)
        {
            return _repository.search(feedID);
        }

        [HttpGet("frommaster")]
        public IEnumerable<FeedSchedule> search_from_master(int feedID)
        {
            return _repository.search_from_master(feedID);
        }

    }

    [Route("api/[controller]")]
    public class FeedTypeController : Controller
    {
        public IFeedTypeRepository _repository;
        private ILogger<FeedTypeController> _logger;

        public FeedTypeController(IFeedTypeRepository repository, ILogger<FeedTypeController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<FeedType> search(string type = "")
        {
            return _repository.search(type);
        }

        [HttpPost]
        public int add([FromBody] FeedType item)
        {
            return _repository.add(item);
        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] FeedType item)
        {
            _repository.update(item);

            return new NoContentResult();
        }      

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
           _repository.delete(id);

            return new NoContentResult();

        }
    }

    [Route("api/[controller]")]
    public class FeedMatchingController : Controller
    {
        public IFeedMatchRepository _repository;
        private ILogger<FeedMatchingController> _logger;

        public FeedMatchingController(IFeedMatchRepository repository, ILogger<FeedMatchingController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpGet]
        public IEnumerable<FeedMatching> search(int feedID)
        {
            return _repository.search(feedID);
        }

        [HttpGet("frommaster")]
        public IEnumerable<FeedMatching> search_from_master(int feedID)
        {
            return _repository.search_from_master(feedID);
        }

    }

    [Route("api/[controller]")]
    public class FeedSubTypeController : Controller
    {
        public IFeedSubTypeRepository _repository;
        private ILogger<FeedSubTypeController> _logger;

        public FeedSubTypeController(IFeedSubTypeRepository repository, ILogger<FeedSubTypeController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IActionResult search(int feedTypeID, string includeColumns = null, string ignoreColumns = null)
        {
            IEnumerable<FeedSubtype> feedSubtypes = _repository.search(feedTypeID);

            return new CustomResult(feedSubtypes, includeColumns?.Split(","), ignoreColumns?.Split(","));
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public int add([FromBody] FeedSubtype item)
        {
            return _repository.add(item);
        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] FeedSubtype item)
        {
            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            _repository.delete(id);

            return new NoContentResult();

        }
    }

    [Route("api/[controller]")]
    public class FeedResourceController : Controller
    {
        public IFeedResourceRepository _repository;
        private ILogger<FeedResourceController> _logger;

        public FeedResourceController(IFeedResourceRepository repository, ILogger<FeedResourceController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IActionResult search(int feedSubTypeID, string includeColumns = null, string ignoreColumns = null)
        {
            IEnumerable<FeedResource> feedResources = _repository.search(feedSubTypeID);

            return new CustomResult(feedResources, includeColumns?.Split(","), ignoreColumns?.Split(","));
        }

        [HttpPut("refreshmetadata")]
        public IActionResult refreshMetaData([FromBody] FeedResourceMetaData feedResourcesMetaData)
        {
            _repository.refreshMetaData(feedResourcesMetaData);
            return new NoContentResult();
        }

        [HttpPost]
        public int add([FromBody] FeedResource item)
        {
            return _repository.add(item);
        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] FeedResource item)
        {
            _repository.update(item);

            return new NoContentResult();
        }

        [HttpPost("addFull")]
        public int addFull([FromBody] FeedResource item)
        {
            return _repository.addFull(item);
        }

        [HttpPut("updateFull")]
        public IActionResult updateFull( [FromBody] FeedResource item)
        {
            _repository.updateFull(item);

            return new NoContentResult();
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            _repository.delete(id);

            return new NoContentResult();

        }
    }

    [Route("api/[controller]")]
    public class FeedSourceFieldController : Controller
    {
        public IFeedSourceFieldRepository _repository;
        private ILogger<FeedSourceFieldController> _logger;

        public FeedSourceFieldController(IFeedSourceFieldRepository repository, ILogger<FeedSourceFieldController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<FeedSourceField> search(int feedResourceID)
        {
            return _repository.search(feedResourceID);
        }

        [HttpPost("add")]
        public void add(int feedResourceID, [FromBody] List<FeedSourceField> sourceFields)
        {
            _repository.add(feedResourceID, sourceFields);
        }

        [HttpPost("addItem")]
        public int add([FromBody] FeedSourceField item)
        {
            return _repository.add(item);
        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] FeedSourceField item)
        {
            _repository.update(item);

            return new NoContentResult();
        }

        [HttpPut("{id}/sampledata")]
        public void updateSampleData(int feedResourceID, [FromBody] List<FeedSourceField> sourceFields)
        {
            _repository.updateSampleData(feedResourceID, sourceFields);
        }

    }

    [Route("api/[controller]")]
    public class FeedSourceFieldLookupController : Controller
    {
        public IFeedSourceFieldLookupRepository _repository;
        private ILogger<FeedSourceFieldLookupController> _logger;

        public FeedSourceFieldLookupController(IFeedSourceFieldLookupRepository repository, ILogger<FeedSourceFieldLookupController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<FeedSourceFieldLookup> search(int subTypeID, string lookupName)
        {
            return _repository.search(subTypeID, lookupName);
        }
    }

    [Route("api/[controller]")]
    public class FeedAtTableController : Controller
    {
        public IFeedAtTableRepository _repository;
        private ILogger<FeedAtTableController> _logger;

        public FeedAtTableController(IFeedAtTableRepository repository, ILogger<FeedAtTableController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<FeedAtTable> search(string tableName,int type)
        {
            return _repository.search(tableName, type);
        }
    }

    [Route("api/[controller]")]
    public class FeedAtTableDetailController : Controller
    {
        public IFeedAtTableDetailRepository _repository;
        private ILogger<FeedAtTableDetailController> _logger;

        public FeedAtTableDetailController(IFeedAtTableDetailRepository repository, ILogger<FeedAtTableDetailController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<FeedAtTableDetail> search(int tableID)
        {
            return _repository.search(tableID);
        }
    }

    [Route("api/[controller]")]
    public class FeedAtFieldController : Controller
    {
        public IFeedAtFieldRepository _repository;
        private ILogger<FeedAtFieldController> _logger;

        public FeedAtFieldController(IFeedAtFieldRepository repository, ILogger<FeedAtFieldController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<FeedAtField> search(string tableName)
        {
            return _repository.search(tableName);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }
    }

    [Route("api/[controller]")]
    public class FeedAtFunctionController : Controller
    {
        public IFeedAtFunctionRepository _repository;
        private ILogger<FeedAtFunctionController> _logger;

        public FeedAtFunctionController(IFeedAtFunctionRepository repository, ILogger<FeedAtFunctionController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<FeedAtFunction> search(string functionName)
        {
            return _repository.search(functionName);
        }
    }
}

```
## FeedProcessController.cs
```cs
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.FeedComponents;
using System.Data;
using Newtonsoft.Json;
using Microsoft.Extensions.Logging;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using AT.AT2017.FeedComponents.Models;
using System.Collections.Generic;
using AT.AT2017.Api.Repositories;
using Newtonsoft.Json.Linq;
using AT.AT2017.Api.Core.Models.Feeds;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class FeedProcessController : Controller
    {
        private ILogger<ApiCallLogController> _logger;
        private IHttpContextAccessor _context;
        private ApplicationSettings _appSettings;
        private IFeedProcessRepository _repository;

        public FeedProcessController(ILogger<ApiCallLogController> logger, IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings, IFeedProcessRepository repository)
        {
            _logger = logger;
            _context = httpContextAccessor;
            _appSettings = appSettings.Value;
            _repository = repository;
        }

        protected ProcessorCredentials getProcessorCredentials()
        {
            var credentials = new ProcessorCredentials();
            credentials.companyServer = _context.HttpContext.User.FindFirst("server").Value;
            credentials.companyDatabase = _context.HttpContext.User.FindFirst("database").Value;
            credentials.adminServer = _appSettings.AdminServer;
            credentials.adminDatabase = _appSettings.AdminDatabase;
            credentials.adminUser = _appSettings.AdminUser;
            credentials.adminPassword = _appSettings.AdminPassword;
            return credentials;
        }

        [HttpPost("feedexecution")]
        public IActionResult runFeed(int id, bool pullOnDemand = false, string allowInserts = "-1", [FromBody] List<FeedPODFilter> feedPODFilters = null)
        {
            // allowInserts = -1 => this means should be used the value already stored on feed.allowInserts field
            // allowInserts =  0 => this means should be override the value to FALSE (do not allow inserts)
            // allowInserts =  1 => this means should be override the value to TRUE (allow inserts)
            Processor processor = new Processor(getProcessorCredentials());
            try
            {
                var _item = processor.runFeed(feedId: id, pullOnDemand: pullOnDemand, feedPODFilters: feedPODFilters, allowInserts: allowInserts);
                return new ObjectResult(_item);
            }
            finally
            {
                processor = null;
            }
        }

        [HttpPost("runinteractive/{feedID}")]
        public DataTable runInteractive(int feedID, [FromBody] List<FeedEndpointParam> mergeFields)
        {
            // run feed if interactive mode is enabled (only supported by Feed version 2)
            Processor processor = new Processor(getProcessorCredentials());
            try
            {
                return processor.runInteractive(feedID, mergeFields);
            }
            finally
            {
                processor = null;
            }
        }

        [HttpGet("feedvalidation")]
        public IActionResult validateFeed(int id)
        {
            Processor processor = new Processor(getProcessorCredentials());
            try
            {
                var _item = processor.validateFeed(id);
                return new ObjectResult(_item);
            }
            finally
            {
                processor = null;
            }           
        }

        [HttpGet("sourcedata")]
        public string getSourceData(int id, string field)
        {
            Processor processor = new Processor(getProcessorCredentials());
            try
            {
                DataTable _item = new DataTable();
                _item = processor.getSourceFieldData(id, field);
                string JSONresult;
                JSONresult = JsonConvert.SerializeObject(_item);
                return JSONresult;
            }
            finally
            {
                processor = null;
            }
        }

        [HttpGet("run/storedprocedure")]
        public string runStoredProcedure(string statement)
        {
            return _repository.runStoredProcedure(statement);
        }

        [HttpGet("run/resolvefunction")]
        public string resolveFunction(string statement)
        {
            return _repository.resolveFunction(statement);
        }

        [HttpPost("run/resolvescript")]
        public string resolveScript([FromBody] string script)
        {
            return _repository.resolveScript(script);
        }

        [HttpPost("run/transformresponse")]
        public string transformResponse([FromBody] JObject data)
        {
            string jsonToTransform = data.GetValue("jsonToTransform").ToString();
            string script = data.GetValue("script").ToString();

            return _repository.transformResponse(jsonToTransform, script);
        }
    }
}

```
## FeedRelationshipController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;
using System.Data.Odbc;
using System.Net;
using System.IO;
using Newtonsoft.Json.Linq;
using System.Text;
using System.Web;
using AT.AT2017.Api.Core.Models.Feeds;

namespace AT.AT2017.Api.Controllers
{

    [Route("api/[controller]")]
    public class FeedRelationshipController : Controller
    {
        public IFeedRelationshipRepository _repository;
        private ILogger<FeedRelationshipController> _logger;

        public FeedRelationshipController(IFeedRelationshipRepository repository, ILogger<FeedRelationshipController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<FeedRelationship> search(int feedID)
        {
            return _repository.search(feedID);
        }

        [HttpGet("frommaster")]
        public IEnumerable<FeedRelationship> search_from_master(int feedID)
        {
            return _repository.search_from_master(feedID);
        }
    }
}

```
## FormControlController.cs
```cs
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Repositories;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Logging;
using System.Collections.Generic;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class FormControlController : Controller
    {
        public IFormControlRepository _repository;
        private ILogger<FormControlController> _logger;

        public FormControlController(IFormControlRepository repository, ILogger<FormControlController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        public IEnumerable<FormControl> search(string formName)
        {
            return _repository.search(formName);
        }

        [HttpPost("savelist")]
        public IActionResult addControlList(string formName, [FromBody] IList<FormControl> controls)
        {

            foreach (FormControl control in controls)
            {
                // save new custom control
                _repository.addOrUpdate(control);
            }

            return new NoContentResult();
        }
    }
}
```
## FortePaymentLogController.cs
```cs
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class FortePaymentLogController : Controller
    {
        public IFortePaymentLogRepository _repository;       
        private ILogger<FortePaymentLogController> _logger;

        public FortePaymentLogController(IFortePaymentLogRepository repository, ILogger<FortePaymentLogController> logger)
        {
            _repository = repository;          
            _logger = logger;
        }       

        [HttpGet]
        public IActionResult get(int id, string type)
        {
            var item = _repository.get(id,type);
            
            return new ObjectResult(item);
        }
      
    }
}

```
## GLAccountCommissionController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/glaccount/commission")]
    public class GLAccountCommissionController : Controller
    {

        public IGLAccountCommissionRepository _repository;
        private ILogger<GLAccountCommissionController> _logger;

        public GLAccountCommissionController(IGLAccountCommissionRepository repository, ILogger<GLAccountCommissionController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<GLAccountCommission> search(int accountId = 0, int classificationId = 0, int deductionId = 0, string side = "")
        {
            return _repository.search(accountId, classificationId, deductionId, side);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] GLAccountCommission item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] GLAccountCommission item)
        {
            if (item == null || item.accountCommissionId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }

        [HttpPut("copy")]
        public IActionResult copy(int classificationId, int classificationCopyId)
        {
            _repository.copy(classificationId, classificationCopyId);

            return new NoContentResult();

        }
}
}

```
## GLAccountController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Repositories;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class GLAccountController : Controller
    {

        public IGLAccountRepository _repository;
        private ILogger<GLAccountController> _logger;

        public GLAccountController(IGLAccountRepository repository, ILogger<GLAccountController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<GLAccount> search(int companyId = 0, string accountNumber = "", string description = "", string accountType = "", string headerType = "", string isEscrow = "", string systemAccount = "", bool withTrash = false)
        {
            return _repository.search(companyId, accountNumber, description, accountType, headerType, isEscrow, systemAccount, withTrash);
        }

        [HttpGet("deleted")]
        public IEnumerable<GLAccount> searchDeletedRecord(int pageIndex = 0, int pageSize =10)
        {
            return _repository.searchDeletedRecord(pageIndex, pageSize);
        }

        [HttpGet("getBalance")]
        public decimal getBalance(int accountId,int companyId)
        {
            return _repository.getBalance(accountId,companyId);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpGet("getNACHA")]
        public IActionResult getNACHA(int id)
        {
            var item = _repository.getNACHA(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] GLAccount item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] GLAccount item)
        {
            if (item == null || item.accountId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpPut("updateNACHA")]
        public IActionResult updateNACHA(int id, [FromBody] GLAccount item)
        {
            if (item == null || item.accountId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.updateNACHA(item);

            return new NoContentResult();
        }

        [HttpPut("forte/update")]
        public IActionResult updateForte(int accountId,string merchantId, [FromBody] IEnumerable<GLAccountFortePersonType> table)
        {
            _repository.updateForte(accountId,merchantId,table);

            return new NoContentResult();
        }

        [HttpPost("forte/validate")]
        public string validateForte([FromBody] GLAccount item)
        {
            return _repository.validateForte(item);
        }

        [HttpGet("forte/personType")]
        public IEnumerable<GLAccountFortePersonType> searchFortePersonType(int id)
        {
            return _repository.searchFortePersonType(id);
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }

    }
}

```
## GLAccountFortePersonTypeController.cs
```cs
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using System.Collections.Generic;
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class GLAccountFortePersonTypeController : Controller    {

        public IGLAccountFortePersonTypeRepository _repository;

        private ILogger<GLAccountFortePersonTypeController> _logger;

        public GLAccountFortePersonTypeController(IGLAccountFortePersonTypeRepository repository, ILogger<GLAccountFortePersonTypeController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<GLAccountFortePersonType> search(int accountId)
        {
            return _repository.search(accountId);
        }      
    }
}

```
## GLAccountPeriodController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/glaccount/period")]
    public class GLAccountPeriodController : Controller
    {

        public IGLAccountPeriodRepository _repository;
        private ILogger<GLAccountPeriodController> _logger;

        public GLAccountPeriodController(IGLAccountPeriodRepository repository, ILogger<GLAccountPeriodController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<GLAccountPeriod> search(string active = "")
        {
            return _repository.search(active);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] GLAccountPeriod item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] GLAccountPeriod item)
        {
            if (item == null || item.periodId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }

    }
}

```
## GLAccountPeriodLockController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/glaccount/period/lock")]
    public class GLAccountPeriodLockController : Controller
    {

        public IGLAccountPeriodLockRepository _repository;
        private ILogger<GLAccountPeriodLockController> _logger;

        public GLAccountPeriodLockController(IGLAccountPeriodLockRepository repository, ILogger<GLAccountPeriodLockController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<GLAccountPeriodLock> search(int companyId = 0 )
        {
            return _repository.search(companyId);
        }

        [HttpPost]
        public IActionResult add([FromBody] GLAccountPeriodLock item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }

    }
}

```
## GLAccountSettingController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class GLAccountSettingController : Controller
    {
        public IGLAccountSettingRepository _repository;
        private ILogger<GLAccountSettingController> _logger;

        public GLAccountSettingController(IGLAccountSettingRepository repository, ILogger<GLAccountSettingController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<GLAccountSetting> search()
        {
            return _repository.search();
        }

        [HttpGet("columns")]
        public IEnumerable<GLAccountSetting> searchColumns(int companyID = 0)
        {
            return _repository.searchColumns(companyID);
        }

        [HttpGet("allowedAccounts")]
        public IEnumerable<GLAccountSetting> searchAllowedAccounts(int companyID = 0)
        {
            return _repository.searchAllowedAccounts(companyID);
        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] GLAccountSetting item)
        {
            if (item == null || item.accountSettingID != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }


        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }
    }
}

```
## GlobalSettingController.cs
```cs
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Repositories;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Logging;
using System.Collections.Generic;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class GlobalSettingController : Controller
    {
        public IGlobalSettingRepository _repository;
        private ILogger<GlobalSettingController> _logger;

        public GlobalSettingController(IGlobalSettingRepository repository, ILogger<GlobalSettingController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<GlobalSetting> search()
        {
            return _repository.search();
        }

    }
}
```
## HelpArticleController.cs
```cs
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Repositories;
using AT.AT2017.Api.Validation;
using Microsoft.AspNetCore.Http;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Logging;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class HelpArticleController : Controller
    {
        public IHelpArticleRepository _repository;
        private IHttpContextAccessor _context;
        private ILogger<HelpArticleController> _logger;

        public HelpArticleController(IHelpArticleRepository repository, ILogger<HelpArticleController> logger, IHttpContextAccessor httpContextAccessor)
        {
            _repository = repository;
            _context = httpContextAccessor;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<HelpArticle> search(string query, bool withTrash = false)
        {
            return _repository.search(query, withTrash);
        }

        [HttpGet("action/{actionID}")]
        public IEnumerable<HelpArticle> searchByAction(int actionID, string query = "", string corporateName = "")
        {
            return _repository.searchByAction(actionID, corporateName, query);
        }

        [HttpPost]
        [ValidateModel]
        public IActionResult add([FromBody] HelpArticle item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);

            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] HelpArticle item)
        {
            if (item == null || item.articleID != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpPut("actions")]
        public IActionResult updateActions(int actionID, [FromBody] List<HelpArticle> articles)
        {
            _repository.updateActions(actionID, articles);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }

        [HttpPost("{id}/log/add")]
        public IActionResult addLogEntry(int id, [FromBody] HelpArticleLog logData)
        {
            _repository.addLogEntry(id, logData);

            return new NoContentResult();
        }
    }
}

```
## HomeController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;

namespace AT.AT2017.Api.Controllers
{
    public class HomeController : Controller
    {
        public IActionResult Index()
        {
            return View();
        }
    }
}
```
## InquiryController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using AT.AT2017.Api.Core.Models;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Validation;
using AT.AT2017.Api.Classes;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class InquiryController : Controller
    {
        public IInquiryRepository _repository;
        private ILogger<InquiryController> _logger;

        public InquiryController(IInquiryRepository repository, ILogger<InquiryController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<Inquiry> search(int companyId, int accountId, int officeId=0, int incomeJobId=0, int expenseJobId=0, string fromDate="", string toDate="", decimal amount = 0, int transactionId=0, string description="")
        {
            return _repository.search( companyId,  accountId,  officeId,  incomeJobId,  expenseJobId,  fromDate,  toDate, amount,transactionId, description);
        }

        [HttpGet("paginated")]
        public IActionResult searchPaginated(int companyId, int accountId, int officeId= 0, int incomeJobId = 0, int expenseJobId = 0, string fromDate = "", string toDate = "", decimal amount = 0, int transactionId = 0, string description = "", string includeColumns = null, string ignoreColumns = null, int pageIndex = 1, int pageSize = 50, string sortBy = "", string filterBy = "")
        {
            var inquiries = _repository.searchPaginated(companyId, accountId, officeId, incomeJobId, expenseJobId, fromDate, toDate, amount, transactionId, description, pageIndex, pageSize, sortBy, filterBy);

            return new CustomPagedResult<Inquiry>(inquiries, includeColumns?.Split(","), ignoreColumns?.Split(","));
        }

        [HttpGet("balance")]
        public IActionResult searchCalculateBalance(int companyId, int accountId, int officeId = 0, int incomeJobId = 0, int expenseJobId = 0, string fromDate = "", string toDate = "", decimal amount = 0, int transactionId = 0, string description = "", string includeColumns = null, string ignoreColumns = null)
        {
            var item = _repository.searchCalculateBalance(companyId, accountId, officeId, incomeJobId, expenseJobId, fromDate, toDate, amount, transactionId, description);

            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }
    }
}

```
## InvoiceController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using AT.AT2017.Api.Core.Models;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Validation;
using AT.AT2017.Api.Core.Exceptions;
using AT.AT2017.Api.Classes;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{

    /// <summary>
    /// Class level summary documentation goes here.</summary>
    /// <remarks>
    /// Longer comments can be associated with a type or member 
    /// through the remarks tag</remarks>
    [Route("api/[controller]")]
    public class InvoiceController : Controller
    {

        public IInvoiceRepository _repository;
        private ILogger<InvoiceController> _logger;

        public IArPaymentRepository _arpaymentRepository;
        public IGlobalSettingRepository _globalSettingRepository;
        public IGLAccountRepository _glAccountRepository;
        public IPersonMerchantRepository _personMerchantRepository;
        public ICompanyRepository _companyRepository;
        public IFortePaymentLogRepository _forteLogRepository;
        public ISettingRepository _settingRepository;
        public IPersonRepository _personRepository;

        public InvoiceController(IInvoiceRepository repository, ILogger<InvoiceController> logger, IArPaymentRepository arpaymentRepository, IGlobalSettingRepository globalSettingRepository, IGLAccountRepository glAccountRepository, ISettingRepository settingRepository, IPersonRepository personRepository, IPersonMerchantRepository personMerchantRepository, ICompanyRepository companyRepository, IFortePaymentLogRepository forteLogRepository)
        {
            _repository = repository;
            _logger = logger;

            _arpaymentRepository = arpaymentRepository;
            _globalSettingRepository = globalSettingRepository;
            _glAccountRepository = glAccountRepository;
            _personMerchantRepository = personMerchantRepository;
            _companyRepository = companyRepository;
            _forteLogRepository = forteLogRepository;
            _settingRepository = settingRepository;
            _personRepository = personRepository;
        }

        [HttpPut("validate")]
        public IActionResult validateModel([FromBody] Invoice item, bool ignoreDetail = false)
        {
            ModelState.Clear();
            if (TryValidateModel(item))
                return new NoContentResult();
            else
            {
                if (ignoreDetail == true) ModelState.Remove("detail");
                if (ModelState.ErrorCount == 0)
                    return new NoContentResult();
                else
                    return  new ValidationFailedResult(ModelState);
            }
        }

        [HttpPut("validateDetail")]
        public IActionResult validateDetailModel([FromBody] InvoiceDetail item)
        {
            ModelState.Clear();
            if (TryValidateModel(item))
                return new NoContentResult();
            else
            {
                return new ValidationFailedResult(ModelState);
            }
        }

        /// <summary>
        /// Returns a list of Invoice items.
        /// </summary>
        /// <remarks>
        /// Filters items by passed paramaters. 
        /// All parameters are optional.
        /// </remarks>
        /// <param name="companyId"></param>
        /// <param name="personId"></param>
        /// <param name="propertyId"></param>
        /// <param name="orderTypeId"></param>
        /// <param name="personTypeId"></param>
        /// <param name="posted"></param>
        /// <param name="paid"></param>
        /// <param name="fromDate"></param>
        /// <param name="toDate"></param>
        /// <param name="amount"></param>
        /// <param name="pageIndex"></param>
        /// <param name="pageSize"></param>
        /// <param name="withTrash"></param>
        /// <returns>All the documents which were found</returns>
        [HttpGet]
        public IEnumerable<Invoice> search(int companyId, int personId = 0, int propertyId = 0, int orderTypeId = 0, int personTypeId = 0, string posted = "", string paid = "" , string fromDate = "", string toDate = "", decimal amount = 0, string isTemplate = "", int pageIndex = 0, int pageSize = 10, bool withTrash = false, string ids = "")
        {
            return _repository.search(companyId, personId, propertyId, orderTypeId, personTypeId, posted, paid, fromDate, toDate, amount,isTemplate, pageIndex, pageSize, withTrash, ids);
        }

        [HttpGet("fromvoucher")]
        public IEnumerable<Invoice> searchByVoucher(int voucherId)
        {
            return _repository.searchByVoucher(voucherId);
        }

        [HttpGet("detail")]
        public IEnumerable<InvoiceDetail> searchDetail(int personId = 0)
        {
            return _repository.searchDetail(personId);
        }

        [HttpGet("deleted")]
        public IEnumerable<Invoice> searchDeletedRecord(int pageIndex = 0, int pageSize = 10)
        {
            return _repository.searchDeletedRecord(pageIndex, pageSize);
        }

        [HttpGet("unpaid")]
        public IEnumerable<Invoice> searchUnpaid(int companyId, int personId = 0, int propertyId = 0, int orderTypeId = 0, int personTypeId = 0,string fromDate = "", string toDate = "", int isForte = 0, int officeId = 0)
        {
            return _repository.searchUnpaid(companyId, personId, propertyId, orderTypeId, personTypeId, fromDate, toDate, isForte, officeId);
        }

        [HttpGet("nopaids/paginated")]
        public IActionResult searchUnpaidPaginated(int companyId, int personId = 0, int propertyId = 0, int orderTypeId = 0, int personTypeId = 0, string fromDate = "", string toDate = "", int isForte = 0, int officeId = 0, string includeColumns = null, string ignoreColumns = null, int pageIndex = 1, int pageSize = 50, string sortBy = "", string filterBy = "")
        {
            var invoices = _repository.searchUnpaidPaginated(companyId, personId, propertyId, orderTypeId, personTypeId, fromDate, toDate, isForte, officeId, pageIndex, pageSize, sortBy, filterBy);

            return new CustomPagedResult<Invoice>(invoices, includeColumns?.Split(","), ignoreColumns?.Split(","));
        }

        [HttpGet("unpaid/byPerson")]
        public IEnumerable<Invoice> searchUnpaidByPerson(int personId = 0, int companyId = 0)
        {
            return _repository.searchUnpaidByPerson(personId, companyId);
        }

        [HttpGet("{id}/payments")]
        public IEnumerable<ArPaymentDetail> searchPayments(int id)
        {
            return _repository.searchPayments(id);
        }

        [HttpGet("{id}/deposits")]
        public IEnumerable<CheckbookDetail> searchDeposits(int id)
        {
            return _repository.searchDeposits(id);
        }

        /// <summary>
        /// Returns a specific Invoice item.
        /// </summary>
        /// <remarks>
        /// Find an Invoice item by ID
        /// </remarks>
        /// <param name="id">Invoice ID</param>
        /// <seealso cref="String">
        /// You can use the cref attribute on any tag to reference a type or member 
        /// and the compiler will check that the reference exists. </seealso>
        /// <returns>Invoice model in JSON format</returns>
        /// <response code="404">Not found</response>
        /// <response code="500">Internal Server Error</response>
        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPut("postbatch")]
        public IEnumerable<Invoice> postBatch( [FromBody] IEnumerable<Invoice> invoicesToPost)
        {
            return _repository.postBatch(invoicesToPost);
        }

        /// <summary>
        /// Create a new Invoice item.
        /// </summary>
        /// <param name="item"></param>
        [HttpPost]
        [ValidateModel]
        public IActionResult add([FromBody] Invoice item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        /// <summary>
        /// Create a new Invoice item from voucher detail
        /// </summary>
        /// <param name="voucherId"></param>
        [HttpPost("fromvoucher/{voucherId}")]
        public int  addFromVoucher(int voucherId)
        {
            int id = _repository.addFromVoucher(voucherId);

            Invoice item = _repository.get(id);
            //return new ObjectResult(item);
            return id;
        }

        /// <summary>
        /// Update a specific Invoice item.
        /// </summary>
        /// <param name="id">Invoice ID</param>
        /// <param name="item">Invoice model (JSON)</param>
        /// <response code="202">Not content</response>
        /// <response code="400">Bad request</response>
        /// <response code="404">Not found</response>
        /// <response code="500">Internal Server Error</response>
        [HttpPut("{id}")]
        [ValidateModel]
        public IActionResult update(int id, [FromBody] Invoice item)
        {
            if (item == null || item.invoiceId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        /// <summary>
        /// Deletes a specific Invoice item.
        /// </summary>
        /// <param name="id"></param>
        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();
            
        }

        [HttpPut("post/{id}")]
        [ValidateModel]
        public IActionResult post(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.post(id);

            return new NoContentResult();
        }

        [HttpPut("unpost/{id}")]
        public IActionResult unpost(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.unpost(id);

            return new NoContentResult();
        }

        [HttpPut("pay/{id}")]
        public IActionResult pay(int id, decimal howMuchToPay, string paymentDate, string paymentMethod,bool paidByNacha=false, int isForte=0)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            int arpaymentId = 0;
            arpaymentId = _repository.pay(id, howMuchToPay, paymentDate, paymentMethod, paidByNacha);

            if (isForte > 0 && paidByNacha==false)
            {
                ForteClient client = new ForteClient();
                bool isForteByAccount = false;

                IEnumerable<Setting> settingList = _settingRepository.search("", "", "Forte", "");
                Setting settingC = settingList.First(s => s.name == "ENABLE_FORTE_BY_ACCOUNT");
                if (settingC != null)
                    if (settingC.value.ToLower() == "true")
                        isForteByAccount = true;

                Person person = _personRepository.get(item.personId.GetValueOrDefault());

                if (isForteByAccount == false)
                {
                    Company company = _companyRepository.get(item.companyId);
                    if (string.IsNullOrEmpty(company.merchantID_CC) && string.IsNullOrEmpty(company.merchantID_ACH))
                    {
                        throw new System.Exception("The company doesn't have a valid Forte Merchant ID value. Please enter in Settings\\Settings screen to continue.");
                    }

                    string forteAchId, forteCcId;

                    forteAchId = "";
                    forteCcId = "";

                    if (isForte == 1)
                    {
                        forteCcId = person.forteCcId;
                    }
                    else
                    {
                        forteAchId = person.forteAchId;
                    }

                    client = new ForteClient(_settingRepository, _globalSettingRepository, _companyRepository, item.companyId, "sale");
                    FortePaymentLog result = client.payTransaction(howMuchToPay, arpaymentId, person.forteClientId, "sale", forteAchId, forteCcId);
                    result.paymentId = arpaymentId;
                    result.paymentType = "AR";
                    result.paymethodType = (isForte == 2 ? "ACH" : "CC");
                    result.byEmail = false;

                    _forteLogRepository.add(result);

                    if (result.responseCode != "A01")
                    {
                        _arpaymentRepository.unpost(arpaymentId);
                        _arpaymentRepository.delete(arpaymentId);
                        throw new System.Exception(result.responseDescription);
                    }
                }
                else
                {
                    client = new ForteClient(_globalSettingRepository, _companyRepository, _glAccountRepository, _personMerchantRepository, 0, item.personId.GetValueOrDefault(), item.companyId, isForte, "sale", person.personTypeId.GetValueOrDefault());
                  
                    //isForte = 1 by credit card uses CCID
                    //isForte = 2 by direct deposit uses ACHID

                    FortePaymentLog result = client.payTransaction(howMuchToPay, arpaymentId, "sale", (isForte == 2 ? true : false));
                    result.paymentId = arpaymentId;
                    result.paymentType = "AR";
                    result.paymethodType = (isForte == 2 ? "ACH" : "CC");
                    result.byEmail = false;

                    _forteLogRepository.add(result);

                    if (result.responseCode != "A01")
                    {
                        _arpaymentRepository.unpost(arpaymentId);
                        _arpaymentRepository.delete(arpaymentId);
                        throw new System.Exception(result.responseDescription);
                    }
                }
            }

            return new NoContentResult();
        }

        [HttpPut("reclassify/{id}")]
        public IActionResult reclassify(int id, [FromBody] Invoice item)
        {
            if (item == null || item.invoiceId != id)
            {
                return BadRequest();
            }

            _repository.reclassify(item);

            return new NoContentResult();
        }


        [HttpPut("payList")]
        public int payList(int isForte,bool byEmail, [FromBody] IEnumerable<Invoice> invoices)
        {
            Invoice item = invoices.FirstOrDefault();//all invoices are from the same person and company
            Person person = _personRepository.get(item.personId.GetValueOrDefault());
            int personTypeId = person.personTypeId.GetValueOrDefault();

            int arpaymentId = 0;
            var itemAR = new ArPayment();

            ForteClient client = new ForteClient();
            bool isForteByAccount = false;
         
            IEnumerable<Setting> settingList = _settingRepository.search("", "", "Forte", "");
            Setting settingC = settingList.First(s => s.name == "ENABLE_FORTE_BY_ACCOUNT");
            if (settingC != null)
                if (settingC.value.ToLower() == "true")
                    isForteByAccount = true;
         

            if (isForteByAccount == false)
            {
                Company company = _companyRepository.get(item.companyId);
                if (string.IsNullOrEmpty(company.merchantID_CC) && string.IsNullOrEmpty(company.merchantID_ACH))
                {
                    throw new System.Exception("The company doesn't have a valid Forte Merchant ID value. Please enter in Settings\\Settings screen to continue.");
                }

                 arpaymentId = _repository.payList(isForte,invoices);
                 itemAR = _arpaymentRepository.get(arpaymentId);
                
               
                string forteAchId, forteCcId;

                forteAchId = "";
                forteCcId = "";

                if (isForte == 1)
                {
                    forteCcId = person.forteCcId;
                }
                else
                {
                    forteAchId = person.forteAchId;
                }

                client = new ForteClient(_settingRepository, _globalSettingRepository, _companyRepository, item.companyId, "sale");
                FortePaymentLog result = client.payTransaction(itemAR.receivedAmount, arpaymentId, person.forteClientId, "sale", forteAchId, forteCcId);
                result.paymentId = arpaymentId;
                result.paymentType = "AR";
                result.paymethodType = (isForte == 2 ? "ACH" : "CC");
                result.byEmail = byEmail;

                _forteLogRepository.add(result);

                if (result.responseCode != "A01")
                {
                    _arpaymentRepository.unpost(arpaymentId);
                    _arpaymentRepository.delete(arpaymentId);
                    throw new System.Exception(result.responseDescription);
                }               
            }
            else
            {                
                client = new ForteClient(_globalSettingRepository, _companyRepository, _glAccountRepository, _personMerchantRepository, 0, item.personId.GetValueOrDefault(), item.companyId, isForte, "sale",personTypeId);
                arpaymentId = _repository.payList(isForte, invoices);
                itemAR = _arpaymentRepository.get(arpaymentId);
               
                //isForte = 1 by credit card uses CCID
                //isForte = 2 by direct deposit uses ACHID

                FortePaymentLog result = client.payTransaction(itemAR.receivedAmount, arpaymentId, "sale", (isForte == 2 ? true : false));
                result.paymentId = arpaymentId;
                result.paymentType = "AR";
                result.paymethodType = (isForte == 2 ? "ACH" : "CC");
                result.byEmail = byEmail;

                _forteLogRepository.add(result);

                if (result.responseCode != "A01")
                {
                    _arpaymentRepository.unpost(arpaymentId);
                    _arpaymentRepository.delete(arpaymentId);
                    throw new System.Exception(result.responseDescription);
                }                
            }

            return arpaymentId;
        }


        [HttpGet("searchTemplates")]
        public IEnumerable<Invoice> searchTemplates(int companyId)
        {
            return _repository.searchTemplates(companyId);
        }

        [HttpPut("updateAsTemplate")]
        public IActionResult updateAsTemplate([FromBody] Invoice item)
        {
            _repository.updateAsTemplate(item);

            return new NoContentResult();
        }

        [HttpPut("updateRecurring")]
        public IActionResult updateRecurring([FromBody] Invoice item)
        {
            _repository.updateRecurring(item);

            return new NoContentResult();
        }

        [HttpGet("agentbilling")] 
        public InvoiceBillingLog getAgentBilling(int invoiceBillingLogID)
        {
            return _repository.getAgentBilling(invoiceBillingLogID);
        }

        [HttpPut("agentbilling")]
        public InvoiceBillingLog addAgentBilling(int companyId, int officeId, int personTypeId, string orderDate, bool includeBillingItems, bool includeReimbItems, bool posted, [FromBody] IEnumerable<Person> persons)
        {
            return _repository.addAgentBilling(companyId, officeId, personTypeId, orderDate, includeBillingItems, includeReimbItems, posted, persons);
        }

        [HttpGet("frombilling")]
        public IEnumerable<Invoice> searchInvoicesFromBilling(int invoiceBillingLogID, int pageIndex=1, int pageSize=-1)
        {
            return _repository.searchInvoicesFromBilling(invoiceBillingLogID, pageIndex, pageSize);
        }

        [HttpGet("postingPropertySummary")]
        public IEnumerable<Invoice> searchInvoicesPostingPropertySummary(int propertyId)
        {
            return _repository.searchInvoicesPostingPropertySummary(propertyId);
        }

        [HttpPost("copy")]
        public IActionResult copy(int id)
        {
            id = _repository.copy(id);

            var item = _repository.get(id);
            return new ObjectResult(item);
        }
       
        [HttpGet("billingSummary/paginated")]
        public IActionResult searchBillingLogDetailPaginated(int invoiceBillingLogID, int pageIndex = 1, int pageSize = 10, string sortBy = "", string filterBy = "")
        {
            var invoices = _repository.searchBillingLogDetailPaginated(invoiceBillingLogID, pageIndex, pageSize, sortBy, filterBy);

            return new CustomPagedResult<InvoiceBillingLogDetail>(invoices);
        }
        [HttpGet("billingSummary")]
        public IActionResult getBillingLog(int invoiceBillingLogID)
        {
            var item = _repository.getBillingLog(invoiceBillingLogID);

            return new ObjectResult(item);
        }
    }
}

```
## InvoiceScannedImageController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using AT.AT2017.Api.Core.Models;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Validation;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/invoice/scannedimage")]
    public class InvoiceScannedImageController : Controller
    {
        public IInvoiceScannedImageRepository _repository;
        private ILogger<InvoiceScannedImageController> _logger;

        public InvoiceScannedImageController(IInvoiceScannedImageRepository repository, ILogger<InvoiceScannedImageController> logger)
        {
            _repository = repository;
            _logger = logger;
        }
        
        [HttpGet]
        public IEnumerable<InvoiceScannedImage> search(int invoiceID)
        {
            return _repository.search(invoiceID);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] InvoiceScannedImage item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }
        
        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] InvoiceScannedImage item)
        {
            if (item == null || item.scannedImageID != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

    }
}

```
## InvoiceScannedImageViewHistoryController.cs
```cs
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using System.Collections.Generic;
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/invoice/scannedimage/history")]
    public class InvoiceScannedImageViewHistoryController : Controller
    {
        public IInvoiceScannedImageViewHistoryRepository _repository;

        private ILogger<InvoiceScannedImageViewHistoryController> _logger;

        public InvoiceScannedImageViewHistoryController(IInvoiceScannedImageViewHistoryRepository repository, ILogger<InvoiceScannedImageViewHistoryController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<InvoiceScannedImage> search(int scannedImageID)
        {
            return _repository.search(scannedImageID);
        }

        [HttpPost]
        public IActionResult add([FromBody] InvoiceScannedImage item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item.scannedImageID);

            //item = _repository.get(id);
            return new ObjectResult(item);

        }
    }
}
```
## ItemForSaleController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;
using System.Net.Mail;
using AT.AT2017.Api.Core.Shared;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class ItemForSaleController : Controller
    {

        public IItemForSaleRepository _repository;
        private ILogger<ItemForSaleController> _logger;

        public ItemForSaleController(IItemForSaleRepository repository, ILogger<ItemForSaleController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        /*
         * 	@item VARCHAR(100) = '',
	        @inStock BIT = NULL,
	        @priceStart INT=NULL,
	        @priceEnd INT=NULL,
	        @sortBy VARCHAR(20) = 'DATE'
         */
        [HttpGet]
        public PagedList<ItemForSale> search(int pageIndex, int pageSize, string item, bool? inStock, int? priceStart, int? priceEnd, string sortBy)
        {
            return _repository.search(pageIndex, pageSize, item, inStock, priceStart, priceEnd, sortBy);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] ItemForSale item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            _repository.add(item);

            return new NoContentResult();
        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] ItemForSale item)
        {
            if (item == null || item.inventoryId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();
        }
    }
}

```
## JobCodeController.cs
```cs
using System.Collections.Generic;
using System.Linq;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using AT.AT2017.Api.Core.Models;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Classes;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class JobCodeController : Controller
    {

        public IJobCodeRepository _repository;
        private ILogger<JobCodeController> _logger;

        public JobCodeController(IJobCodeRepository repository, ILogger<JobCodeController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IActionResult search(string description = "", string jobType = "", int companyId = 0, int officeId = 0, int personId= 0, string active = "1", int pageIndex = 0, int pageSize = 10,int includeTerminated = 1, int includeIntercompany = 0, string includeColumns = null, string ignoreColumns = null)
        {
            IList<JobCode> jobCodes = _repository.search(description, jobType, companyId, officeId, personId, active, pageIndex, pageSize, includeTerminated, includeIntercompany).ToList();

            return new CustomResult(jobCodes, includeColumns?.Split(","), ignoreColumns?.Split(","));
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] JobCode item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] JobCode item)
        {
            if (item == null || item.jobId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }

    }
    
}

```
## JournalController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using AT.AT2017.Api.Core.Models;
using Microsoft.Extensions.Logging;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class JournalController : Controller
    {
        public IJournalRepository _repository;
        private ILogger<JournalController> _logger;

        public JournalController(IJournalRepository repository, ILogger<JournalController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<Journal> search(int companyId, string reference = "", string posted = "", string fromDate = "", string toDate = "", string isTemplate = "", int pageIndex = 0, int pageSize = 10, bool withTrash = false, int officeId=0, int accountId = 0, int divisionId = 0, decimal amount = 0, string postedDate="", int personId = 0, string ids = "")
        {
            return _repository.search(companyId,reference, posted, fromDate, toDate,isTemplate,pageIndex, pageSize, withTrash,officeId,accountId,divisionId,amount, postedDate,personId,ids);
        }

        [HttpGet("deleted")]
        public IEnumerable<Journal> searchDeletedRecord(int pageIndex = 0, int pageSize = 10)
        {
            return _repository.searchDeletedRecord(pageIndex, pageSize);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] Journal item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPost("reverse/{id}")]
        public IActionResult reverse(int id)
        {
            id = _repository.reverse(id);

            var item  = _repository.get(id);
            return new ObjectResult(item);
        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] Journal item)
        {
            if (item == null || item.journalId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }

        [HttpPut("post/{id}")]
        public IActionResult post(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.post(id);

            return new NoContentResult();
        }

        [HttpPut("unpost/{id}")]
        public IActionResult unpost(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.unpost(id);

            return new NoContentResult();
        }

        [HttpPut("reclassify/{id}")]
        public IActionResult reclassify(int id, [FromBody] Journal item)
        {
            if (item == null || item.journalId != id)
            {
                return BadRequest();
            }

            _repository.reclassify(item);

            return new NoContentResult();
        }

        [HttpGet("searchTemplates")]
        public IEnumerable<Journal> searchTemplates(int companyId)
        {
            return _repository.searchTemplates(companyId);
        }
        
        [HttpPut("updateAsTemplate")]
        public IActionResult updateAsTemplate([FromBody] Journal item)
        {
            _repository.updateAsTemplate(item);

            return new NoContentResult();
        }

        [HttpPut("updateRecurring")]
        public IActionResult updateRecurring([FromBody] Journal item)
        {
            _repository.updateRecurring(item);

            return new NoContentResult();
        }

        [HttpPut("updateFlag1099")]
        public IActionResult updateFlag1099(int id, int flag1099)
        {
            _repository.updateFlag1099(id, flag1099);

            return new NoContentResult();
        }
    }
}

```
## JournalScannedImageController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using AT.AT2017.Api.Core.Models;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Validation;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/journal/scannedimage")]
    public class JournalScannedImageController : Controller
    {
        public IJournalScannedImageRepository _repository;
        private ILogger<JournalScannedImageController> _logger;

        public JournalScannedImageController(IJournalScannedImageRepository repository, ILogger<JournalScannedImageController> logger)
        {
            _repository = repository;
            _logger = logger;
        }
        
        [HttpGet]
        public IEnumerable<JournalScannedImage> search(int journalID)
        {
            return _repository.search(journalID);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] JournalScannedImage item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }
        
        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] JournalScannedImage item)
        {
            if (item == null || item.scannedImageID != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }
    }
}

```
## JournalScannedImageViewHistoryController.cs
```cs
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using System.Collections.Generic;
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/journal/scannedimage/history")]
    public class JournalScannedImageViewHistoryController : Controller
    {
        public IJournalScannedImageViewHistoryRepository _repository;

        private ILogger<JournalScannedImageViewHistoryController> _logger;

        public JournalScannedImageViewHistoryController(IJournalScannedImageViewHistoryRepository repository, ILogger<JournalScannedImageViewHistoryController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<JournalScannedImage> search(int scannedImageID)
        {
            return _repository.search(scannedImageID);
        }

        [HttpPost]
        public IActionResult add([FromBody] JournalScannedImage item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item.scannedImageID);

            //item = _repository.get(id);
            return new ObjectResult(item);

        }
    }
}
```
## LedgerReportController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Core.Model_Report;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class LedgerReportController : Controller
    {

        public ILedgerReportRepository _repository;
        private ILogger<LedgerReportController> _logger;

        public LedgerReportController(ILedgerReportRepository repository, ILogger<LedgerReportController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet("GL")]
        public IActionResult searchGL(
            string dateStart, string dateEnd, string companyID, string officeID, string ledgerType = "SUMMARY",
            string accountID = "", string transactionID = "", string code = "", int pageIndex=0, int pageSize=100)
        {
            int cid = 0;
            int oid = 0;
            int aid = 0;
            try
            {
                cid = string.IsNullOrEmpty(companyID) ? 0 : int.Parse(companyID);
                oid = string.IsNullOrEmpty(officeID) ? 0 : int.Parse(officeID);
                aid = string.IsNullOrEmpty(accountID) ? 0 : int.Parse(accountID);
            }
            catch (Exception)
            {
                return BadRequest();
            }

            if (String.IsNullOrWhiteSpace(ledgerType) || ledgerType.ToUpper() == "SUMMARY")
            {
                return new ObjectResult(_repository.searchGL(
                                                        dateStart: dateStart,
                                                        dateEnd: dateEnd,
                                                        officeID: oid,
                                                        companyID: cid,
                                                        ledgerType: ledgerType,
                                                        accountID: aid,
                                                        transactionID: transactionID,
                                                        code: code,
                                                        pageIndex: pageIndex,
                                                        pageSize: pageSize));
            } else
            {
                return new ObjectResult(_repository.searchGLDetail(
                                                        dateStart: dateStart,
                                                        dateEnd: dateEnd,
                                                        officeID: oid,
                                                        companyID: cid,
                                                        ledgerType: ledgerType,
                                                        accountID: aid,
                                                        transactionID: transactionID,
                                                        code: code,
                                                        pageIndex: pageIndex,
                                                        pageSize: pageSize));
            }
        }

        [HttpGet("PL")]
        public IActionResult searchPL(
            string dateStart, string dateEnd, string companyID, string officeID, string ledgerType = "SUMMARY",
            string accountID = "", string transactionID = "", string code = "", int pageIndex = 0, int pageSize = 100)
{
            int cid = 0;
            int oid = 0;
            int aid = 0;
            try
            {
                cid = string.IsNullOrEmpty(companyID) ? 0 : int.Parse(companyID);
                oid = string.IsNullOrEmpty(officeID) ? 0 : int.Parse(officeID);
                aid = string.IsNullOrEmpty(accountID) ? 0 : int.Parse(accountID);
            }
            catch (Exception)
            {
                return BadRequest();
            }

            if (String.IsNullOrWhiteSpace(ledgerType) || ledgerType.ToUpper() == "SUMMARY")
            {
                return new ObjectResult(_repository.searchPL(
                                                        dateStart: dateStart,
                                                        dateEnd: dateEnd,
                                                        officeID: oid,
                                                        companyID: cid,
                                                        ledgerType: ledgerType,
                                                        accountID: aid,
                                                        transactionID: transactionID,
                                                        code: code,
                                                        pageIndex: pageIndex,
                                                        pageSize: pageSize));
            } else
            {
                return new ObjectResult(_repository.searchPLDetail(
                                                        dateStart: dateStart,
                                                        dateEnd: dateEnd,
                                                        officeID: oid,
                                                        companyID: cid,
                                                        ledgerType: ledgerType,
                                                        accountID: aid,
                                                        transactionID: transactionID,
                                                        code: code,
                                                        pageIndex: pageIndex,
                                                        pageSize: pageSize));
            }
        }
    }
}

```
## LoginHistoryController.cs
```cs
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using System.Collections.Generic;
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Core.Shared;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{

    [Route("api/auth/[controller]")]
    public class LoginHistoryController : Controller
    {

        public ILoginHistoryRepository _repository;

        private ILogger<LoginHistoryController> _logger;

        public LoginHistoryController(ILoginHistoryRepository repository, ILogger<LoginHistoryController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet("{username}")]
        public IEnumerable<LoginHistory> search(string userName, string loginStartDate = "", string loginEndDate = "", string userNameSearch="", string email="", string ipAddress="", string serverName="", int pageIndex=0, int pageSize=10, string attemptFailed="all" )
        {
            return _repository.search(userName, loginStartDate, loginEndDate, userNameSearch, email, ipAddress, serverName, pageIndex, pageSize, attemptFailed);
        }

        [HttpGet("search/paginated")]
        public PagedList<LoginHistory> searchPaginated(string userName, string loginStartDate = "", string loginEndDate = "", string email = "", string ipAddress = "", string serverName = "", int pageIndex = 1, int pageSize = 10, string attemptFailed = "all" )
        {
            return _repository.searchPaginated(userName, loginStartDate, loginEndDate, email, ipAddress, serverName, pageIndex, pageSize, attemptFailed);
        }

    }
}

```
## MenuActionController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/menu/action")]
    public class MenuActionController : Controller
    {
        public IMenuActionRepository _repository;
        private ILogger<MenuActionController> _logger;

        public MenuActionController(IMenuActionRepository repository, ILogger<MenuActionController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<MenuAction> search(int menuId = 0, string name = "")
        {
            return _repository.search(menuId, name);
        }

        [HttpGet("notinpackage")]
        public IEnumerable<MenuAction> searchNotInPackage()
        {
            return _repository.searchNotInPackage();
        }

        [HttpGet("screens")]
        public IEnumerable<MenuAction> searchScreens()
        {
            return _repository.searchScreens();
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

    }
}

```
## MenuController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class MenuController : Controller
    {
        public IMenuRepository _repository;
        private ILogger<MenuController> _logger;

        public MenuController(IMenuRepository repository, ILogger<MenuController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<Menu> search(string name = "")
        {
            return _repository.search(name);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }
    }
}

```
## MigrationController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class MigrationController : Controller
    {

        public IMigrationRepository _repository;
        private ILogger<MigrationController> _logger;

        public MigrationController(IMigrationRepository repository, ILogger<MigrationController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet("company")]
        public IActionResult getCompany(string newServer, string newDatabase, string sourceDatabase)
        {
            var item = _repository.getCompany(newServer, newDatabase, sourceDatabase);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpGet("server")]
        public IEnumerable<Server> searchServers(bool includeOldServers = true, bool includeNewServers = true)
        {
            return _repository.searchServers(includeOldServers, includeNewServers);
        }

        [HttpGet("database")]
        public IEnumerable<Database> searchDatabases(string server, string type)
        {
            return _repository.searchDatabases(server, type);
        }

        [HttpGet("validate")]
        public IEnumerable<MigrationError> validate(string oldDatabaseName, bool appendDatabase)
        {
            return _repository.validate(oldDatabaseName, appendDatabase);
        }

        [HttpPut("database/new/create")]
        public IActionResult createDatabase(string newServer, string newDatabaseName, bool force = false)
        {
            _repository.createDatabase(newServer, newDatabaseName, force);

            return new NoContentResult();
        }

        [HttpPut("database/new/backup")]
        public IActionResult backupNewDatabase(string newServer, string newDatabaseName)
        {
            _repository.backupNewDatabase(newServer, newDatabaseName);

            return new NoContentResult();
        }

        [HttpPut("database/new/restore")]
        public IActionResult restoreNewDatabase(string newServer, string newDatabaseName)
        {
            _repository.restoreNewDatabase(newServer, newDatabaseName);

            return new NoContentResult();
        }

        [HttpPut("database/old/backup")]
        public IActionResult backupOldDatabase(string oldServer, string oldDatabaseName)
        {
            _repository.backupOldDatabase(oldServer, oldDatabaseName);

            return new NoContentResult();
        }

        [HttpPut("database/old/restore")]
        public IActionResult restoreOldDatabase(string newServer, string oldDatabaseName)
        {
            _repository.restoreOldDatabase(newServer, oldDatabaseName);

            return new NoContentResult();
        }

        [HttpPut("database/master/backup")]
        public IActionResult backupMasterDatabase()
        {
            _repository.backupMasterDatabase();

            return new NoContentResult();
        }

        [HttpPut("triggers/enable")]
        public IActionResult enableTriggers(string server, string dbDestName)
        {
            _repository.enableTriggers(server, dbDestName);

            return new NoContentResult();
        }

        [HttpPut("triggers/disable")]
        public IActionResult disableTriggers(string server, string dbDestName)
        {
            _repository.disableTriggers(server, dbDestName);

            return new NoContentResult();
        }

        [HttpGet("section/cleanup")]
        public IEnumerable<TableStatus> cleanUpSection(string newServer, string newDatabase, string section, bool showTableStatus)
        {
            return _repository.cleanUpSection(newServer, newDatabase, section, showTableStatus);
        }

        [HttpPut("table/transfer")]
        public IActionResult transferTable(string server, string dbDestName, string dbSourceName, string sectionName, string tableName, bool goLive, string brandCode = null)
        {
            _repository.transferTable(server, dbDestName, dbSourceName, sectionName, tableName, goLive, brandCode);
            return new NoContentResult();
        }

        [HttpGet("table")]
        public IEnumerable<MigrationTable> searchTables(string server, string dbDestName, string section)
        {
            return _repository.searchTables(server, dbDestName, section);
        }

        [HttpGet("table/status")]
        public IEnumerable<TableStatus> searchTableStatus(string server, string dbDestName)
        {
            return _repository.searchTableStatus(server, dbDestName);
        }

        [HttpGet("table/comparison")]
        public IEnumerable<ComparisonInfo> searchTableComparison(string server, string dbDestName,string dbSourceName)
        {
            return _repository.searchComparisonInfo(server,dbDestName, dbSourceName);
        }

        [HttpPut("table/preserve")]
        public IActionResult preserveTables(string newServer, string newDatabase)
        {
            _repository.preserveTables(newServer, newDatabase);

            return new NoContentResult();
        }

        [HttpPut("table/sync")]
        public IActionResult syncGlobalTables(string newServer, string newDatabase)
        {
            _repository.syncGlobalTables(newServer, newDatabase);

            return new NoContentResult();
        }

        [HttpPut("fixdata")]
        public IActionResult fixData(string server, string dbDestName, string dbSourceName, bool addCompany, bool goLive)
        {
            _repository.fixData(server, dbDestName, dbSourceName, addCompany, goLive);
            return new NoContentResult();
        }

        [HttpGet("account/columns")]
        public IEnumerable<GLAccountSetting> searchAccountColumns(string newServer, string newDatabase, int companyID)
        {
            return _repository.searchAccountColumns(newServer, newDatabase, companyID);
        }

        [HttpGet("account/allowed")]
        public IEnumerable<GLAccountSetting> searchAllowedAccounts(string newServer, string newDatabase, int companyID)
        {
            return _repository.searchAllowedAccounts(newServer, newDatabase, companyID);
        }

        [HttpPut("account/update")]
        public IActionResult updateAccountSettings(string newServer, string newDatabase, [FromBody] GLAccountSetting item)
        {
            _repository.updateAccountSettings(newServer, newDatabase, item);

            return new NoContentResult();
        }

    }
}

```
## MigrationLogController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class MigrationLogController : Controller
    {
        public IMigrationLogRepository _repository;
        private ILogger<MigrationLogController> _logger;

        public MigrationLogController(IMigrationLogRepository repository, ILogger<MigrationLogController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<MigrationLog> search(int submitID,string corporateName)
        {
            return _repository.search(submitID, corporateName);
        }
        
        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }
    }
}

```
## MigrationLogDetailController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class MigrationLogDetailController : Controller
    {
        public IMigrationLogDetailRepository _repository;
        private ILogger<MigrationLogDetailController> _logger;

        public MigrationLogDetailController(IMigrationLogDetailRepository repository, ILogger<MigrationLogDetailController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<MigrationLogDetail> search(int submitID)
        {
            return _repository.search(submitID);
        }
    }
}

```
## ModelDictionaryController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using AT.AT2017.Api.Core.Models;
using Microsoft.Extensions.Logging;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class ModelDictionaryController : Controller
    {
        public IModelDictionaryRepository _repository;
        private ILogger<ModelDictionaryController> _logger;

        public ModelDictionaryController(IModelDictionaryRepository repository, ILogger<ModelDictionaryController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<ModelDictionary> search()
        {
            return _repository.search();
        }

    }
}

```
## MxController.cs
```cs
using System;
using System.Collections.Generic;
using System.IO;
using System.Net;
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Core.Exceptions;
using AT.AT2017.Api.Repositories;
using AT.AT2017.Api.Util;
using Microsoft.AspNetCore.Http;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Logging;
using Newtonsoft.Json;
using Newtonsoft.Json.Linq;
using System.Linq;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class MxController : Controller
    {
        private IMxRepository _repository;
        private ILogger<PlaidController> _logger;
        private IMxUserRepository _mxUserRepository;
        private IGlobalSettingRepository _globalSettingRepository;
        private ISettingRepository _settingRepository;
        private ICompanyBankRepository _companyBankRepository;
        private IHttpContextAccessor _context;
        private Setting bankStreamEnvSetting;
        private List<GlobalSetting> globalSettings;

        public MxController (IMxRepository repository, IMxUserRepository mxUserRepository, ISettingRepository settingRepository, IGlobalSettingRepository globalSettingRepository, ILogger<PlaidController> logger, ICompanyBankRepository companyBankRepository, IHttpContextAccessor httpContextAccessor)
        {
            _logger = logger;
            _repository = repository;
            _mxUserRepository = mxUserRepository;
            _settingRepository = settingRepository;
            _globalSettingRepository = globalSettingRepository;
            _companyBankRepository = companyBankRepository;
            _context = httpContextAccessor;
        }

        [HttpGet("widget-url")]
        public ObjectResult createWidgetUrl(int? bankID)
        {
            string dbName = _context.HttpContext.User.FindFirst("database").Value;

            // 0. load MX settings
            loadMxSettings();

            // 1. get mxUser for this customer
            MxUser user = _mxUserRepository.firstOrCreate(dbName);

            if (string.IsNullOrEmpty(user.guid))
            {
                user = createUserOnMx(user);
            }

            // 2. get company bank
            CompanyBank bank;
            string institution_code = null;
            string member_guid = null;
            if (bankID != null)
            {
                bank = _companyBankRepository.get(bankID.GetValueOrDefault());
                if (bank != null)
                {
                    institution_code = bank.institution_id;
                    member_guid = bank.item_id;
                }
            }

            // 3. make request to MX
            // * endpoint
            string endpoint = "users/:user_guid/widget_urls";
            endpoint = endpoint.Replace(":user_guid", user.guid);

            // * payload
            object payload = generateWidgetConfig(institution_code, member_guid);

            // * additional headers
            Dictionary<string, string> additionalHeaders = new Dictionary<string, string>();
            additionalHeaders.Add("Accept-Language", "en-US");

            // * get response
            string widgetResponse = mxRequest("POST", endpoint, payload, additionalHeaders);

            return new ObjectResult(JsonConvert.DeserializeObject(widgetResponse));

        }

        [HttpPost("member")]
        public ObjectResult getMember([FromBody] dynamic payload)
        {
            string user_guid = payload.user_guid;
            string member_guid = payload.member_guid;

            // load settings
            loadMxSettings();

            // endpoint
            string endpoint = "users/:user_guid/members/:member_guid";
            endpoint = endpoint.Replace(":user_guid", user_guid).Replace(":member_guid", member_guid);

            string response = mxRequest("GET", endpoint, null);

            dynamic memberResponse = JsonConvert.DeserializeObject(response);

            return new ObjectResult(memberResponse.member);

        }

        [HttpPost("accounts")]
        public ObjectResult getAccounts([FromBody] dynamic payload)
        {
            string user_guid = payload.user_guid;
            string member_guid = payload.member_guid;

            // load settings
            loadMxSettings();

            // endpoint
            string endpoint = "users/:user_guid/members/:member_guid/accounts?member_is_managed_by_user=true&page=1&records_per_page=100";
            endpoint = endpoint.Replace(":user_guid", user_guid).Replace(":member_guid", member_guid);

            string response = mxRequest("GET", endpoint, null);

            dynamic accountsResponse = JsonConvert.DeserializeObject(response);
            JArray accounts = accountsResponse.accounts;

            string validTypes = getSettingByEnvironment("BANKSTREAM_MX_{ENVIRONMENT}_ACCOUNTS_VALID_TYPES");

            JArray validAccounts = new JArray(
                from item in accounts
                where Array.Exists(validTypes.Split(","), (p) => p.ToLower().Trim() == item["type"].ToString().ToLower().Trim())
                select item
            );

            return new ObjectResult(validAccounts);

        }

        [HttpGet("connect/log")]
        public IEnumerable<MxConnectLog> searchConnectLog()
        {
            return _repository.searchConnectLog();
        }

        [HttpPost("connect/log")]
        public IActionResult addConnectLog([FromBody] MxConnectLog item)
        {
            _repository.addConnectLog(item);

            return new NoContentResult();
        }

        private object generateWidgetConfig(string institution_code, string member_guid)
        {
            string widget_type = getSettingByEnvironment("BANKSTREAM_MX_{ENVIRONMENT}_WIDGET_TYPE");
            string client_redirect_url = getSettingByEnvironment("BANKSTREAM_MX_{ENVIRONMENT}_WIDGET_CLIENT_REDIRECT_URL");
            string color_scheme = getSettingByEnvironment("BANKSTREAM_MX_{ENVIRONMENT}_WIDGET_COLOR_SCHEME");
            string current_institution_code = institution_code;
            string current_member_guid = member_guid;
            bool disable_background_agg = Boolean.Parse(getSettingByEnvironment("BANKSTREAM_MX_{ENVIRONMENT}_WIDGET_DISABLE_BACKGROUND_AGG"));
            bool disable_institution_search = Boolean.Parse(getSettingByEnvironment("BANKSTREAM_MX_{ENVIRONMENT}_WIDGET_DISABLE_INSTITUTION_SEARCH"));
            bool include_identity = Boolean.Parse(getSettingByEnvironment("BANKSTREAM_MX_{ENVIRONMENT}_WIDGET_INCLUDE_IDENTITY"));
            bool include_transactions = Boolean.Parse(getSettingByEnvironment("BANKSTREAM_MX_{ENVIRONMENT}_WIDGET_INCLUDE_TRANSACTIONS"));
            bool is_mobile_webview = Boolean.Parse(getSettingByEnvironment("BANKSTREAM_MX_{ENVIRONMENT}_WIDGET_IS_MOBILE_WEBVIEW"));
            string mode = getSettingByEnvironment("BANKSTREAM_MX_{ENVIRONMENT}_WIDGET_MODE");
            string oauth_referral_source = getSettingByEnvironment("BANKSTREAM_MX_{ENVIRONMENT}_WIDGET_OAUTH_REFERRAL_SOURCE");
            string ui_message_version = getSettingByEnvironment("BANKSTREAM_MX_{ENVIRONMENT}_WIDGET_UI_MESSAGE_VERSION");
            string ui_message_webview_url_scheme = getSettingByEnvironment("BANKSTREAM_MX_{ENVIRONMENT}_WIDGET_UI_MESSAGE_WEBVIEW_URL_SCHEME");
            bool update_credentials = Boolean.Parse(getSettingByEnvironment("BANKSTREAM_MX_{ENVIRONMENT}_WIDGET_UPDATE_CREDENTIALS"));

            // https://docs.mx.com/api#widgets_mx_widgets_request_widget_url

            return new
            {
                widget_url = new
                {
                    widget_type,
                    client_redirect_url,
                    color_scheme,
                    current_institution_code,
                    current_member_guid,
                    disable_background_agg,
                    disable_institution_search,
                    // include_identity,
                    include_transactions,
                    is_mobile_webview,
                    mode,
                    oauth_referral_source,
                    ui_message_version,
                    ui_message_webview_url_scheme,
                    update_credentials,
                }
            };
        }

        private MxUser createUserOnMx(MxUser user)
        {
            // metadata
            string metadata = JsonConvert.SerializeObject(new
            {
                user.databaseID,
                user.corporateName,
                user.dbName,
            });

            // payload
            Object payload = new
            {
                user = new
                {
                    id = user.userID,
                    is_disabled = false,
                    metadata
                }
            };

            // make request
            string response = mxRequest("POST", "users", payload);
            
            // dynamic response
            dynamic r = JsonConvert.DeserializeObject(response);
            
            // set guid and metadata
            user.guid = r.user.guid;
            user.metadata = r.user.metadata;

            // update guid
            _mxUserRepository.update(user);

            return user;
        }

        private void loadMxSettings()
        {
            // get settings
            if (bankStreamEnvSetting == null)
            {
                bankStreamEnvSetting = _settingRepository.get(name: "BANKSTREAM_ENVIRONMENT");
            }
            if (globalSettings == null)
            {
                globalSettings = (List<GlobalSetting>)_globalSettingRepository.search(section: "bankstream-mx");
            }
        }

        private string getSettingByEnvironment(string name)
        {
            // get settings by environment
            string environment = bankStreamEnvSetting.value.ToUpper();

            name = name.Replace("{ENVIRONMENT}", environment.ToUpper());
            return GlobalSettings.getSettingValue(globalSettings, name);
        }

        private string mxRequest(string method, string endpoint, Object body, Dictionary<string, string> additionalHeaders = null)
        {
            string response = null;
            try
            {
                // get settings by environment
                string baseUrl;
                string basicAuthValue;
                if (bankStreamEnvSetting.value.ToLower() == "production")
                {
                    baseUrl = GlobalSettings.getSettingValue(globalSettings, "BANKSTREAM_MX_PRODUCTION_BASE_URL");
                    basicAuthValue = GlobalSettings.getSettingValue(globalSettings, "BANKSTREAM_MX_PRODUCTION_BASIC_AUTH_VALUE");
                }
                else
                {
                    baseUrl = GlobalSettings.getSettingValue(globalSettings, "BANKSTREAM_MX_SANDBOX_BASE_URL");
                    basicAuthValue = GlobalSettings.getSettingValue(globalSettings, "BANKSTREAM_MX_SANDBOX_BASIC_AUTH_VALUE");
                }

                // url
                Uri uri = new Uri(baseUrl + "/" + endpoint);

                // create web request
                HttpWebRequest request = (HttpWebRequest)WebRequest.Create(uri.AbsoluteUri.ToString());
                request.Method = method;

                // credentials
                string credentials = basicAuthValue;

                // add headers
                request.ContentType = "application/json";
                request.Accept = "application/vnd.mx.api.v1+json";
                request.Headers.Add("Authorization", "Basic " + credentials);

                if (additionalHeaders != null)
                {
                    foreach (KeyValuePair<string, string> item in additionalHeaders)
                    {
                        string name = item.Key;
                        string value = item.Value;
                        request.Headers.Add(name, value);
                    }
                }

                // write body json
                if (body != null)
                {
                    using (var streamWriter = new StreamWriter(request.GetRequestStream()))
                    {
                        //  write your json content here
                        string json = JsonConvert.SerializeObject(body);

                        streamWriter.Write(json);
                        streamWriter.Flush();
                        streamWriter.Close();
                    }
                }

                // get response
                using (HttpWebResponse webResponse = (HttpWebResponse)request.GetResponse())
                {
                    using (Stream stream = webResponse.GetResponseStream())
                    {
                        using (StreamReader reader = new StreamReader(stream))
                        {
                            response = reader.ReadToEnd();
                        }
                    }
                }
            }
            catch (WebException ex)
            {
                throw mxException(ex);
            }

            return response;
        }

        private MxException mxException(WebException e)
        {
            MxException error;
            try
            {
                string strResponse = string.Empty;
                using (HttpWebResponse response = (HttpWebResponse)e.Response)
                {
                    using (Stream responseStream = response.GetResponseStream())
                    {
                        StreamReader responseReader = new StreamReader(response.GetResponseStream());
                        string responseText = responseReader.ReadToEnd();

                        dynamic responseDynamic = JsonConvert.DeserializeObject(responseText);

                        error = new MxException((string)responseDynamic.error.message);
                        error.statusCode = response.StatusCode;
                        error.type = responseDynamic.error.type;
                    }
                }
            }
            catch
            {
                error = new MxException(e.Message);
            }

            return error;
        }

    }

}

```
## NotificationController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class NotificationController : Controller
    {
        public INotificationRepository _repository;
        private ILogger<NotificationController> _logger;

        public NotificationController(INotificationRepository repository, ILogger<NotificationController> logger)
        {
            _repository = repository;
            _logger = logger;
        }


        [HttpGet("preview")]
        public IActionResult getLastEmailLog(string token)
        {
            var item = _repository.getLastEmailLog(token);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }
    }
}

```
## NotificationScheduleController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;
using System.Data;


namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class NotificationScheduleController : Controller
    {
        public INotificationScheduleRepository _repository;

        private ILogger<NotificationScheduleController> _logger;

        public NotificationScheduleController(INotificationScheduleRepository repository, ILogger<NotificationScheduleController> logger)
        {
            _repository = repository;
            _logger = logger;
        }       

        [HttpGet("{settingId}")]
        public IActionResult get(int settingId)
        {
            var item = _repository.search(settingId);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] NotificationSchedule item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] NotificationSchedule item)
        {
            if (item == null || item.scheduleID != id)
            {
                return BadRequest();
            }            

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            _repository.delete(id);

            return new NoContentResult();

        }
    }
}

```
## NotificationSettingController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class NotificationSettingController : Controller
    {
        public INotificationSettingRepository _repository;
        private ILogger<NotificationSettingController> _logger;

        public NotificationSettingController(INotificationSettingRepository repository, ILogger<NotificationSettingController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<NotificationSetting> search()
        {
            return _repository.search();
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] NotificationSetting item)
        {
            if (item == null || item.notificationSettingId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

    }
}

```
## OfficeController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using AT.AT2017.Api.Core.Models;
using Microsoft.Extensions.Logging;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class OfficeController : Controller
    {

        public IOfficeRepository _repository;
        private ILogger<OfficeController> _logger;

        public OfficeController(IOfficeRepository repository, ILogger<OfficeController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<Office> search(int companyId = 0, string officeName = "", bool withTrash = false, bool applySecurity = false)
        {
            return _repository.search(companyId, officeName, withTrash, applySecurity);
        }

        [HttpGet("deleted")]
        public IEnumerable<Office> searchDeletedRecord(int pageIndex = 0, int pageSize = 10)
        {
            return _repository.searchDeletedRecord(pageIndex, pageSize);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpGet("office_getbynameormlsid")]
        public IActionResult get(string desc)
        {
            var item = _repository.office_getbynameormlsid(desc);
            if (item == null)
            {
                //return NotFound();
                return new NoContentResult();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] Office item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] Office item)
        {
            if (item == null || item.officeId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }

    }
}

```
## OfficeFormController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/officeform")]
    public class OfficeFormController : Controller
    {

        public IOfficeFormRepository _repository;
        private ILogger<OfficeFormController> _logger;

        public OfficeFormController(IOfficeFormRepository repository, ILogger<OfficeFormController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<OfficeForm> search()
        {
            return _repository.search();
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] OfficeForm item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);

            return new ObjectResult(item);
        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] OfficeForm item)
        {
            if (item == null || item.formID != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }
    }
}

```
## OfficeGoalReportController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;
using System.Data;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class OfficeGoalReportController : Controller
    {
        private IOfficeGoalReportRepository _repository;
        private ILogger<OfficeGoalReportController> _logger;

        public OfficeGoalReportController(IOfficeGoalReportRepository repository, ILogger<OfficeGoalReportController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public DataTable search()
        {
            return _repository.search();
        }
    }
}

```
## OfficeMlsController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/office/MlsID")]
    public class OfficeMlsController : Controller
    {

        public IOfficeMlsRepository _repository;
        private ILogger<OfficeMlsController> _logger;

        public OfficeMlsController(IOfficeMlsRepository repository, ILogger<OfficeMlsController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<OfficeMLS> search(int officeId = 0)
        {
            return _repository.search(officeId);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] OfficeMLS item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] OfficeMLS item)
        {
            if (item == null || item.officeMlsID != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }
    }
}

```
## OfficeReportController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Core.Model_Report;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class OfficeReportController : Controller
    {
        public IOfficeReportRepository _repository;
        private ILogger<OfficeReportController> _logger;

        public OfficeReportController(IOfficeReportRepository repository, ILogger<OfficeReportController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<OfficeReport> search( int id = 0, string crestCode = "", int companyId = 0, int showDeleted = 0, int dateType = 0, string dateStart = "", string dateEnd = "", int pageIndex = 0, int pageSize = 100)
        {
            return _repository.search(id, crestCode, companyId, showDeleted, dateType, dateStart, dateEnd, pageIndex, pageSize);
        }
    }
}

```
## PackageController.cs
```cs
using System.Collections.Generic;
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Repositories;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Logging;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class PackageController : Controller
    {
        public IPackageRepository _repository;
        private ILogger<PackageController> _logger;

        public PackageController(IPackageRepository repository, ILogger<PackageController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<Package> search(string name = "")
        {
            return _repository.search(name);
        }

        [HttpGet("actions")]
        public IEnumerable<MenuAction> searchActions(string name = "")
        {
            return _repository.searchActions(name);
        }


        [HttpGet("reports")]
        public IEnumerable<Report> searchReports(string name = "")
        {
            return _repository.searchReports(name);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] Package item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }
        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] Package item)
        {
            if (item == null || item.packageID != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }


        [HttpPost("{id}/copy")]
        public IActionResult copy(int id)
        {
            int newId = _repository.copy(id);

            Package item = _repository.get(newId);
            return new ObjectResult(item);

        }

        [HttpPut("{id}/actions/restore")]
        public IActionResult restoreDefaults(int id)
        {
            _repository.restoreDefaults(id);
            return new NoContentResult();
        }

    }
}
```
## PersonAddressController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/person/address")]
    public class PersonAddressController : Controller
    {
        public IPersonAddressRepository _repository;
        private ILogger<PersonAddressController> _logger;

        public PersonAddressController(IPersonAddressRepository repository, ILogger<PersonAddressController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<PersonAddress> search(int personId = 0)
        {
            return _repository.search(personId);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] PersonAddress item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] PersonAddress item)
        {
            if (item == null || item.addressId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }

    }
}

```
## PersonAreaOfSpecializationController.cs
```cs
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Repositories;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Logging;
using System.Collections.Generic;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/person/areaofspecialization")]
    public class PersonAreaOfSpecializationController : Controller
    {
        public IPersonAreaOfSpecializationRepository _repository;
        private ILogger<PersonAreaOfSpecializationController> _logger;

        public PersonAreaOfSpecializationController(IPersonAreaOfSpecializationRepository repository, ILogger<PersonAreaOfSpecializationController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<PersonAreaOfSpecialization> search(int personId = 0)
        {
            return _repository.search(personId);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] PersonAreaOfSpecialization item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] PersonAreaOfSpecialization item)
        {
            if (item == null || item.personAreaOfSpecializationId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }
    }
}

```
## PersonBillingDetailController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/person/billingdetail")]
    public class PersonBillingDetailController : Controller
    {
        public IPersonBillingDetailRepository _repository;
        private ILogger<PersonBillingDetailController> _logger;

        public PersonBillingDetailController(IPersonBillingDetailRepository repository, ILogger<PersonBillingDetailController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<PersonBillingDetail> search(int personId)
        {
            return _repository.search(personId);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] PersonBillingDetail item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] PersonBillingDetail item)
        {
            if (item == null || item.personBillingDetailId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }
        [HttpPut("list")]
        public IActionResult updateList(int personId, string saveOption,[FromBody] List<PersonBillingDetail> detail)
        {

            _repository.updateList(personId, saveOption,detail);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }
    }
}

```
## PersonController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Validation;
using AT.AT2017.Api.Core.Shared;
using Newtonsoft.Json;
using AT.AT2017.Api.Classes;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class PersonController : Controller
    {
        public IPersonRepository _repository;
        private ILogger<PersonController> _logger;
        public IGlobalSettingRepository _globalSettingRepository;
        public IGLAccountRepository _glAccountRepository;
        public IPersonMerchantRepository _personMerchantRepository;
        public ICompanyRepository _companyRepository;
        public ISettingRepository _settingRepository;
        public IForteRepository _forteRepository;

        public PersonController(IPersonRepository repository,IGlobalSettingRepository globalSettingRepository, IGLAccountRepository glAccountRepository, ISettingRepository settingRepository,  IPersonMerchantRepository personMerchantRepository, ICompanyRepository companyRepository, IForteRepository forteRepository, ILogger<PersonController> logger)
        {
            _repository = repository;
            _logger = logger;
            _globalSettingRepository = globalSettingRepository;
            _glAccountRepository = glAccountRepository;
            _personMerchantRepository = personMerchantRepository;
            _companyRepository = companyRepository;
            _settingRepository = settingRepository;
            _forteRepository = forteRepository;
        }

        [HttpGet]
        public IEnumerable<Person> search(string person = "", int personTypeID = 0, int userID = 0, int companyID = 0, int pageIndex = 0, int pageSize = 10, string sortedBy = "personName", string custom = "all", int officeID = 0, int propertyID = 0, string side = "", bool withTrash = false, string companyName = "", string mls="", string emailAddress="", string phoneNumber="", string filter1 = "", string filter2 = "", string licenseNumber="", string active = "", int cobrokeOfficeID = 0, string printedName = "", int personID = 0, bool applySecurity = false, string personTaxID="")
        {
            return _repository.search(person, personTypeID, userID, companyID, pageIndex, pageSize, sortedBy, custom, officeID, propertyID, side, companyName, mls, emailAddress, phoneNumber, licenseNumber, filter1, filter2, withTrash,active,cobrokeOfficeID,printedName, personID, applySecurity, personTaxID);
        }

        [HttpGet("search/paginated")]
        public PagedList<Person> searchPaginated(string person = "", int personTypeID = 0, int userID = 0, int companyID = 0, int pageIndex = 1, int pageSize = 10, string sortedBy = "personName", string custom = "all", int officeID = 0, int propertyID = 0, string side = "", bool withTrash = false, string companyName = "", string mls = "", string emailAddress = "", string phoneNumber = "", string filter1 = "", string filter2 = "", string licenseNumber = "", string active = "", int cobrokeOfficeID = 0, string printedName = "", int personID = 0, bool applySecurity = false, string personTaxID = "", string offices = "", string sortBy = "", string filterBy = "")
        {
            return _repository.searchPaginated(person, personTypeID, userID, companyID, pageIndex, pageSize, sortedBy, custom, officeID, propertyID, side, companyName, mls, emailAddress, phoneNumber, licenseNumber, filter1, filter2, withTrash, active, cobrokeOfficeID, printedName, personID, applySecurity, personTaxID, offices, sortBy, filterBy);
        }

        [HttpGet("deleted")]
        public IEnumerable<Person> searchDeletedRecord(int pageIndex = 0, int pageSize = 10)
        {
            return _repository.searchDeletedRecord(pageIndex, pageSize);
        }

        [HttpGet("searchRelatedProperties")]
        public IEnumerable<Property> searchRelatedProperties(int personId)
        {
            return _repository.searchRelatedProperties(personId);
        }

        [HttpGet("agents")]
        public IEnumerable<Person> searchAgents()
        {
            return _repository.searchAgents();
        }

        [HttpGet("property")]
        public IActionResult searchByProperty(int propertyID, string includeColumns = null)
        {
            var persons = _repository.searchByProperty(propertyID);
            return new CustomResult(persons, includeColumns?.Split(","), null);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpGet("fortePaymethods")]
        public IActionResult getFortePaymentMethods(int personId,int companyId =0,string merchantId="")
        {
            PaymentMethod itemPaymethods = new PaymentMethod();

            ForteClient client = new ForteClient();
            bool isForteByAccount = false;
            int personCompanyId = 0;
            int personTypeId = 0;
            string forteCId = "";

            Person item = _repository.get(personId);
            personTypeId = item.personTypeId.GetValueOrDefault();

            if (companyId > 0)
            {
                personCompanyId = companyId;
            }
            else
            {
                personCompanyId = item.companyId.GetValueOrDefault();               
                forteCId = item.forteClientId;
            }
           
            IEnumerable<Setting> settingList = _settingRepository.search("", "", "Forte", "");
            Setting settingC = settingList.First(s => s.name == "ENABLE_FORTE_BY_ACCOUNT");
            if (settingC != null)
                if (settingC.value.ToLower() == "true")
                    isForteByAccount = true;

            Company company = _companyRepository.get(personCompanyId);

            if (isForteByAccount == false)
            {
                if (personCompanyId == 0)
                {
                    throw new System.Exception("This person does not have a company assigned.");
                }

                if (string.IsNullOrEmpty(company.merchantID_ACH) && string.IsNullOrEmpty(company.merchantID_CC))
                {
                    throw new System.Exception("The company doesn't have a valid Forte Merchant ID value. Please enter in Settings\\Settings screen to continue.");
                }

                client = new ForteClient(_settingRepository, _globalSettingRepository, _companyRepository, personCompanyId, "", this._forteRepository);
                itemPaymethods = client.getPaymethods(personId, forteCId);
            }
            else
            {
                if (item.isForteImported==true)
                {
                    itemPaymethods = _forteRepository.getPaymentMethods(personId, merchantId);
                }
                else {
                    client = new ForteClient(_globalSettingRepository, _companyRepository, _glAccountRepository, _personMerchantRepository, personId, personCompanyId, personTypeId, merchantId,this._forteRepository);
                    itemPaymethods = client.getPaymethods(personId, forteCId);
                }
            }

            return new ObjectResult(itemPaymethods);                      
        }

        [HttpGet("escrowpayee")]
        public IActionResult getEscrowPayee(int companyID)
        {
            var item = _repository.getEscrowPayee(companyID);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpGet("person_getbypersonidormls")]
        public IActionResult person_getbypersonidormls(string desc)
        {
            var item = _repository.person_getbypersonidormls(desc);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        [ValidateModel]
        public IActionResult add([FromBody] Person item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut]
        public IActionResult update([FromBody] Person item, int id, string propIds = "",int updateOption= 0, int autoTerminatePositions=0)
        {
            if (item == null || item.personId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item,propIds, updateOption, autoTerminatePositions);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }

        [HttpPost("personmerge")]
        public IActionResult personmerge(int personidtokeep, int personidtoremove)
        {
            
         _repository.personmerge(personidtokeep, personidtoremove);

            return new NoContentResult();
        }

        [HttpGet("recipients")]
        public IEnumerable<Person> searchRecipients(int recipientId, string personName)
        {
            return _repository.searchRecipients( recipientId,  personName);
        }

        [HttpPut("import")]
        public int import([FromBody] IEnumerable<PersonImport> table)
        {
            return _repository.import(table);
        }

        [HttpGet("importLog")]
        public IEnumerable<PersonImport> getImportLog(int logId)
        {
            return _repository.getImportLog(logId);
        }

        [HttpPut("{id}/billing/notes")]
        public IActionResult updateBillingNotes(int id, [FromBody] Object item)
        {
            string str = JsonConvert.SerializeObject(item);
            Person person = JsonConvert.DeserializeObject<Person>(str);
            if (item == null || person.personId != id)
            {
                return BadRequest();
            }

            _repository.updateBillingNotes(id, person.billingNotes);

            return new NoContentResult();
        }

        [HttpGet("byOffice")]
        public IActionResult searchByOffice(int personTypeID = 0, int companyID = 0, string custom = "all", string officeList ="",string filter1 = "", string filter2 = "", string includeColumns = null, string ignoreColumns = null, int pageIndex = 0, int pageSize = -1)
        {
            IEnumerable<Person> list=null;  
            list = _repository.searchForAgentBilling(personTypeID,companyID, officeList, filter1, filter2, "", pageIndex, pageSize);

            return new CustomResult(list, includeColumns?.Split(","), ignoreColumns?.Split(","));
        }
    }
}

```
## PersonCustomFieldController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/person/custom")]
    public class PersonCustomFieldController : Controller
    {
        public IPersonCustomFieldRepository _repository;
        private ILogger<PersonCustomFieldController> _logger;

        public PersonCustomFieldController(IPersonCustomFieldRepository repository, ILogger<PersonCustomFieldController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<PersonCustomField> search(int personId)
        {
            return _repository.search(personId);
        }

        [HttpPost]
        public IActionResult add([FromBody] PersonCustomField item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            return new NoContentResult();
        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] PersonCustomField item)
        {
            if (item == null || item.customFieldId != id)
            {
                return BadRequest();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            _repository.delete(id);

            return new NoContentResult();

        }

    }
}

```
## PersonDeductionController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/person/deduction")]
    public class PersonDeductionController : Controller
    {

        public IPersonDeductionRepository _repository;
        private ILogger<PersonDeductionController> _logger;

        public PersonDeductionController(IPersonDeductionRepository repository, ILogger<PersonDeductionController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<PersonDeduction> search(int personId = 0)
        {
            return _repository.search(personId);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] PersonDeduction item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpGet("getScalePercent")]
        public decimal getScalePercent(int id, int propertyId,string side)
        {
            return _repository.getScalePercent(id, propertyId, side);
        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] PersonDeduction item)
        {
            if (item == null || item.personDeductionId != id)
            {
                return BadRequest();
            }

            //var itemFound = _repository.get(id);
            //if (itemFound == null)
            //{
            //    return NotFound();
            //}

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }

    }
}

```
## PersonDesignationController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/person/designation")]
    public class PersonDesignationController : Controller
    {

        public IPersonDesignationRepository _repository;
        private ILogger<PersonDesignationController> _logger;

        public PersonDesignationController(IPersonDesignationRepository repository, ILogger<PersonDesignationController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<PersonDesignation> search(int personId = 0)
        {
            return _repository.search(personId);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] PersonDesignation item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] PersonDesignation item)
        {
            if (item == null || item.personDesignationId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }
    }
}

```
## PersonDocumentController.cs
```cs
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using System.Collections.Generic;
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/person/document")]
    public class PersonDocumentController : Controller
    {
        public IPersonDocumentRepository _repository;

        private ILogger<PersonDocumentController> _logger;

        public PersonDocumentController(IPersonDocumentRepository repository, ILogger<PersonDocumentController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<PersonDocument> search(int personId)
        {
            return _repository.search(personId);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] PersonDocument item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);
        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] PersonDocument item)
        {
            if (item == null || item.documentID != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();
        }
    }
}
```
## PersonDuplicatesController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;
namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class PersonDuplicatesController : Controller
    {
        public IPersonDuplicatesRepository _repository;

        private ILogger<PersonDuplicatesController> _logger;

        public PersonDuplicatesController(IPersonDuplicatesRepository repository, ILogger<PersonDuplicatesController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet("{id}")]
        public IEnumerable<PersonDuplicates> search(int id, bool noSearch)
        {
            return _repository.search(id, noSearch);
        }

        [HttpGet("searchpeople")]
        public IEnumerable<PersonDuplicates> searchPeople()
        {
            return _repository.searchPeople();
        }
    }
}
```
## PersonGroupController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/person/group")]
    public class PersonGroupController : Controller
    {

        public IPersonGroupRepository _repository;
        private ILogger<PersonGroupController> _logger;

        public PersonGroupController(IPersonGroupRepository repository, ILogger<PersonGroupController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<PersonGroup> search(int personId = 0)
        {
            return _repository.search(personId);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] PersonGroup item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] PersonGroup item)
        {
            if (item == null || item.personGroupId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }
    }
}

```
## PersonInsuranceController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/person/insurance")]
    public class PersonInsuranceController : Controller
    {

        public IPersonInsuranceRepository _repository;
        private ILogger<PersonInsuranceController> _logger;

        public PersonInsuranceController(IPersonInsuranceRepository repository, ILogger<PersonInsuranceController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<PersonInsurance> search(int personId = 0)
        {
            return _repository.search(personId);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] PersonInsurance item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] PersonInsurance item)
        {
            if (item == null || item.personInsuranceId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }

    }
}

```
## PersonLanguageController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/person/language")]
    public class PersonLanguageController : Controller
    {

        public IPersonLanguageRepository _repository;
        private ILogger<PersonLanguageController> _logger;

        public PersonLanguageController(IPersonLanguageRepository repository, ILogger<PersonLanguageController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<PersonLanguage> search(int personId = 0)
        {
            return _repository.search(personId);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] PersonLanguage item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] PersonLanguage item)
        {
            if (item == null || item.personLanguageId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }
    }
}

```
## PersonLicenseController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Classes;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/person/license")]
    public class PersonLicenseController : Controller
    {

        public IPersonLicenseRepository _repository;
        private ILogger<PersonLicenseController> _logger;

        public PersonLicenseController(IPersonLicenseRepository repository, ILogger<PersonLicenseController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<PersonLicense> search(int personId = 0)
        {
            return _repository.search(personId);
        }

        [HttpGet("property")]
        public IEnumerable<PersonLicense> searchByProperty(int propertyID)
        {
            return _repository.searchByProperty(propertyID);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] PersonLicense item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] PersonLicense item)
        {
            if (item == null || item.personLicenseId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }

    }
}

```
## PersonManageController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Classes;
using AT.AT2017.Api.Core.Shared;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/person/manage")]
    public class PersonManageController : Controller
    {
        public IPersonRepository _personRepository;
        public IPersonAddressRepository _personAddressRepository;
        public IPersonManageRepository _repository;
        public ICompanyRepository _companyRepository;
        public ISettingRepository _settingRepository;
        public IGlobalSettingRepository _globalSettingRepository;
        public IGLAccountRepository _gLAccountRepository;
        public IPersonMerchantRepository _personMerchantRepository;
        public IForteRepository _forteRepository;
        private ILogger<PersonManageController> _logger;

        public PersonManageController(IPersonManageRepository repository, IPersonRepository personRepository, ICompanyRepository companyRepository, ISettingRepository settingRepository ,IGlobalSettingRepository globalSettingRepository, IGLAccountRepository gLAccountRepository, IPersonMerchantRepository personMerchantRepository, IPersonAddressRepository personAddressRepository, IForteRepository forteRepository,ILogger<PersonManageController> logger)
        {
            _repository = repository;
            _personRepository = personRepository;
            _companyRepository = companyRepository;
            _globalSettingRepository = globalSettingRepository;
            _settingRepository = settingRepository;
            _gLAccountRepository = gLAccountRepository;
            _personMerchantRepository = personMerchantRepository;         
            _personAddressRepository = personAddressRepository;
            _forteRepository = forteRepository;
            _logger = logger;
        }

        [HttpGet]
        public PagedList<PersonManage> search(int officeID, int personTypeID, int pageIndex, int pageSize, string person)
        {
            return _repository.search(officeID, personTypeID, pageIndex, pageSize, person);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] PersonManage item)
        {
            if (item == null || item.personID != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpPost("forte")]
        public IActionResult addForte([FromBody] PersonForte item)
        {           
            bool isForteByAccount = false;
            IEnumerable<Setting> settingList = _settingRepository.search("", "", "Forte", "");
            Setting settingC = settingList.FirstOrDefault(s => s.name == "ENABLE_FORTE_BY_ACCOUNT");
            if (settingC != null)
                if (settingC.value.ToLower() == "true")
                    isForteByAccount = true;

            Person person = _personRepository.get(item.personID);
            IEnumerable<PersonAddress> listAddr = _personAddressRepository.search(person.personId);
            Company company = _companyRepository.get(item.companyID);

            if (!isForteByAccount)
            {
               
                if (string.IsNullOrEmpty(company?.merchantID_ACH))
                {
                    throw new System.Exception("The company doesn't have a valid Forte Merchant ID value. Please enter in Settings\\Settings screen to continue.");
                }
                
                var client = new ForteClient(_settingRepository, _globalSettingRepository, _companyRepository, item.companyID, "credit", _forteRepository);

                //From Darwin the forte client ID is not sent, so the existing IDs are recovered
                if (string.IsNullOrEmpty(item.forteClientID))
                {
                    item.forteClientID = person.forteClientId;
                    item.forteACHID = person.forteAchId;
                    item.forteCCID = person.forteCcId;
                }

                if (string.IsNullOrEmpty(item.forteClientID))
                {
                    if (string.IsNullOrEmpty(item.firstName))
                    {
                        item.firstName = person.firstName;
                        item.lastName = person.lastName;
                        item.companyName = person.companyName;
                        item.emailAddress = person.emailAddress;
                    }

                    getAddress(item,company,listAddr);

                    item.forteClientID = client.createCustomer(item);
                }
                else
                {
                    try
                    {
                        client.updateCustomer(item);
                    }
                    catch (Exception e)
                    {
                        //this error comes up when the client has an invalid forte client ID
                        if ( e.Message.ToLower() == "this api access id does not have permission to access the requested customer_token.")
                        {
                            var newItem = item;
                            newItem.forteACHID = "";
                            newItem.forteCCID = "";

                            client.deleteCustomer(item.forteClientID);

                            //creates a new one so can save the paymethods
                            if (string.IsNullOrEmpty(item.firstName))
                            {
                                newItem.firstName = person.firstName;
                                newItem.lastName = person.lastName;
                                newItem.companyName = person.companyName;
                                newItem.emailAddress = person.emailAddress;
                            }

                            getAddress(newItem, company, listAddr);

                            item.forteClientID = client.createCustomer(newItem);
                        }
                        else
                        { throw e;
                        }
                    }                        
                }

                //only when new data is sent is the old payment ID deleted and/or a new payment ID created:
                if (!string.IsNullOrEmpty(item.ccCardType))
                {
                    if (!string.IsNullOrEmpty(item.forteCCID))
                    {
                        client.deletePaymentMethod(item.forteCCID);
                    }
                    item.forteCCID = client.createCreditCard(item);
                }
                
                if (!string.IsNullOrEmpty(item.achAccountType))
                {
                    if (!string.IsNullOrEmpty(item.forteACHID))
                    {
                        client.deletePaymentMethod(item.forteACHID);
                    }
                    item.forteACHID = client.createECheck(item);
                }

                // remove other payments methods that we don't have referenced in the database
                person.forteClientId = item.forteClientID;
                person.forteAchId = item.forteACHID;
                person.forteCcId = item.forteCCID;
                person.emailAddress = string.IsNullOrEmpty(item.emailAddress) ? person.emailAddress : item.emailAddress;
                _personRepository.update(person, string.Empty, 0, 0);
            }
            else
            {
                var forteRecords = _personMerchantRepository.search(item.personID);
                var forteIDs = new PersonMerchant();

                if (!string.IsNullOrEmpty(item.merchantID))
                {
                    forteIDs = forteRecords.FirstOrDefault(f => f.merchantId.ToLower() == item.merchantID.ToLower());
                    item.forteClientID = forteIDs?.clientId;
                    item.forteAddressID = forteIDs?.addressId;
                    item.forteCCID = forteIDs?.ccId;
                    item.forteACHID = forteIDs?.achId;
                }
                else
                {
                    IEnumerable<GLAccount> listAccount = _gLAccountRepository.search(item.companyID, "", "", "", "Checking", "", "", false);                    

                    if (forteRecords!=null && forteRecords.Count()>0)
                    {
                        forteIDs = (from PersonMerchant pmerchant in forteRecords
                                    join GLAccount paccount in listAccount
                                                      on pmerchant.merchantId.ToLower() equals paccount.forteMerchantId.ToLower()  
                                    select pmerchant).FirstOrDefault();
                    }
                    else{
                        IEnumerable<GLAccountFortePersonType> listAccountPT = _gLAccountRepository.searchFortePersonType(0);
                    
                        forteIDs.merchantId = (from GLAccount paccount in listAccount
                                              join GLAccountFortePersonType paccountType in listAccountPT
                                              on paccount.accountId equals paccountType.accountId
                                              where paccountType.personTypeId == person.personTypeId.GetValueOrDefault()
                                              select paccount).FirstOrDefault().forteMerchantId;
                    }
                    
                    item.merchantID = forteIDs?.merchantId;
                    item.forteClientID = forteIDs?.clientId;
                    item.forteAddressID = forteIDs?.addressId;
                    item.forteCCID = forteIDs?.ccId;
                    item.forteACHID = forteIDs?.achId;
                }               
                                   
                var client = new ForteClient(_globalSettingRepository, _companyRepository, _gLAccountRepository, item.merchantID, _forteRepository);

                if (string.IsNullOrEmpty(item.forteClientID))
                {
                    if (string.IsNullOrEmpty(item.firstName))
                    {
                        item.firstName = person.firstName;
                        item.lastName = person.lastName;
                        item.companyName = person.companyName;
                        item.emailAddress = person.emailAddress;
                    }

                    getAddress(item, company, listAddr);

                    item.forteClientID = client.createCustomer(item);
                }
                else
                {
                    //client.updateCustomer(item);
                    try
                    {
                        client.updateCustomer(item);
                    }
                    catch (Exception e)
                    {
                        //this error comes up when the client has an invalid forte client ID
                        if (e.Message.ToLower() == "this api access id does not have permission to access the requested customer_token.")
                        {
                            var newItem = item;
                            newItem.forteACHID = "";
                            newItem.forteCCID = "";

                            client.deleteCustomer(item.forteClientID);

                            //creates a new one so can save the paymethods
                            if (string.IsNullOrEmpty(item.firstName))
                            {
                                newItem.firstName = person.firstName;
                                newItem.lastName = person.lastName;
                                newItem.companyName = person.companyName;
                                newItem.emailAddress = person.emailAddress;
                            }

                            getAddress(item, company, listAddr);

                            item.forteClientID = client.createCustomer(newItem);
                        }
                        else
                        {
                            throw e;
                        }
                    }

                }

                if (!string.IsNullOrEmpty(item.ccCardType))
                {
                    if (!string.IsNullOrEmpty(item.forteCCID))
                    {
                        client.deletePaymentMethod(item.forteCCID);
                    }
                    item.forteCCID = client.createCreditCard(item);
                }

                if (!string.IsNullOrEmpty(item.achAccountType))
                {
                    if (!string.IsNullOrEmpty(item.forteACHID))
                    {
                        client.deletePaymentMethod(item.forteACHID);
                    }
                    item.forteACHID = client.createECheck(item);
                }

                // remove other payments methods that we don't have referenced in the database

                //_repository.addForteInfo(item);
                var personMerchant = new PersonMerchant()
                {
                    personMerchantId = forteIDs?.personMerchantId ?? 0,
                    personId = item.personID,
                    merchantId = item.merchantID,
                    clientId = item.forteClientID,
                    addressId = item.forteAddressID,
                    achId = item.forteACHID,
                    ccId = item.forteCCID
                };
                if (personMerchant.personMerchantId == 0)
                {
                    _personMerchantRepository.add(personMerchant);
                }
                else
                {
                    _personMerchantRepository.update(personMerchant);
                }
                         
                person.emailAddress = string.IsNullOrEmpty(item.emailAddress) ? person.emailAddress : item.emailAddress;
                _personRepository.update(person, string.Empty, 0, 0);

                try {
                    client.getPaymethods(item.personID, item.forteClientID);
                }
                catch (Exception e)
                { }
               
            }

            return new NoContentResult();
        }

        [HttpDelete("forte/{personId}/{merchantId}/")]
        public IActionResult removeForte(int personId, string merchantId, bool clientId, bool ccId, bool achId)
        {
            bool isForteByAccount = false;
            IEnumerable<Setting> settingList = _settingRepository.search("", "", "Forte", "");
            Setting settingC = settingList.FirstOrDefault(s => s.name == "ENABLE_FORTE_BY_ACCOUNT");
            if (settingC != null)
                if (settingC.value.ToLower() == "true")
                    isForteByAccount = true;

            if (!isForteByAccount)
            {
                var person = _personRepository.get(personId);
                var client = new ForteClient(_settingRepository, _globalSettingRepository, _companyRepository, person.companyId.Value, "credit", _forteRepository);

                if (achId && !string.IsNullOrEmpty(person.forteAchId))
                {
                    client.deletePaymentMethod(person.forteAchId);
                    person.forteAchId = string.Empty;
                }

                if (ccId && !string.IsNullOrEmpty(person.forteCcId))
                {
                    client.deletePaymentMethod(person.forteCcId);
                    person.forteCcId = string.Empty;
                }

                if (clientId)
                {
                    client.deleteCustomer(person.forteClientId);
                    person.forteClientId = string.Empty;
                }

                _personRepository.update(person, string.Empty, 0, 0);
            }
            else
            {
                //var accounts = _gLAccountRepository.search(0, string.Empty, string.Empty, string.Empty, string.Empty, string.Empty, string.Empty, false);
                var payMethods = _personMerchantRepository.search(personId);
                payMethods = (from pm in payMethods where pm.merchantId == merchantId select pm).ToList();

                foreach (var payMethod in payMethods)
                {
                    //var account = (from a in accounts where a.forteMerchantId == payMethod.merchantId select a).FirstOrDefault();
                    var client = new ForteClient(_globalSettingRepository, _companyRepository, _gLAccountRepository, merchantId, _forteRepository);

                    if (achId && !string.IsNullOrEmpty(payMethod.achId))
                    {
                        client.deletePaymentMethod(payMethod.achId);
                        payMethod.achId = string.Empty;
                    }

                    if (ccId && !string.IsNullOrEmpty(payMethod.ccId))
                    {
                        client.deletePaymentMethod(payMethod.ccId);
                        payMethod.ccId = string.Empty;
                    }

                    if (clientId)
                    {
                        client.deleteCustomer(payMethod.clientId);
                        payMethod.clientId = string.Empty;
                    }

                    if (clientId)
                    {
                        _personMerchantRepository.delete(payMethod.personMerchantId);
                    }
                    else
                    {
                        _personMerchantRepository.update(payMethod);
                    }
                }
            }

            return new NoContentResult();
        }

        [HttpPut("forte")]
        public IActionResult updateForte([FromBody] PersonMerchant item)
        {           
            var forteRecords = _personMerchantRepository.search(item.personId);               
            var oldItem = forteRecords.FirstOrDefault(f => f.personMerchantId == item.personMerchantId);
          
            var client = new ForteClient(_globalSettingRepository, _companyRepository, _gLAccountRepository, item.merchantId, _forteRepository);

            if (item.ccId != oldItem.ccId)
            {
                if (!string.IsNullOrEmpty(oldItem.ccId))
                {
                    client.deletePaymentMethod(oldItem.ccId);
                }               
            }

            if (item.achId != oldItem.achId)
            {
                if (!string.IsNullOrEmpty(oldItem.achId))
                {
                    client.deletePaymentMethod(oldItem.achId);
                }
            }

            if (item.clientId != oldItem.clientId)
            {
                if (!string.IsNullOrEmpty(oldItem.clientId))
                {
                    client.deleteCustomer(oldItem.clientId);
                }
            }
   
            _personMerchantRepository.update(item);

            return new NoContentResult();
        }


        [HttpGet("invoices")]
        public IEnumerable<PersonManageInvoice> searchInvoices(int personId)
        {
            return _repository.searchInvoices(personId);
        }


        private bool getAddress( PersonForte item,Company company, IEnumerable<PersonAddress> listAddr)
        {
            if (string.IsNullOrEmpty(item.addressLine1))
            {
                if (listAddr != null && listAddr.Count() > 0)
                {
                    item.city = listAddr.FirstOrDefault().city;
                    item.state = listAddr.FirstOrDefault().state;
                    item.zip = listAddr.FirstOrDefault().zip;
                    item.addressLine1 = listAddr.FirstOrDefault().personAddress1;
                }
                else
                {
                    if (!string.IsNullOrEmpty(company.address) && !string.IsNullOrEmpty(company.city))
                    {
                        item.city = company.city;
                        item.state = company.state;
                        item.zip = company.zip;
                        item.addressLine1 = company.address;
                    }
                }
            }
            return true;
        }
    }
}

```
## PersonMediaController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/person/media")]
    public class PersonMediaController : Controller
    {

        public IPersonMediaRepository _repository;
        private ILogger<PersonMediaController> _logger;

        public PersonMediaController(IPersonMediaRepository repository, ILogger<PersonMediaController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<PersonMedia> search(int personId = 0)
        {
            return _repository.search(personId);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] PersonMedia item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] PersonMedia item)
        {
            if (item == null || item.mediaId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }
    }
}

```
## PersonMerchantController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Validation;
using AT.AT2017.Api.Core.Shared;
using Newtonsoft.Json;
using AT.AT2017.Api.Classes;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/person/merchant")]
    public class PersonMerchantController : Controller
    {       
        public IPersonMerchantRepository _repository;
        private ILogger<PersonMerchantController> _logger;
        public IPersonRepository _personRepository;
        public IGlobalSettingRepository _globalSettingRepository;
        public IGLAccountRepository _glAccountRepository;       
        public ICompanyRepository _companyRepository;   
        public IForteRepository _forteRepository;

        public PersonMerchantController(IPersonMerchantRepository repository, IPersonRepository personRepository, IGlobalSettingRepository globalSettingRepository, IGLAccountRepository glAccountRepository, ICompanyRepository companyRepository, IForteRepository forteRepository, ILogger<PersonMerchantController> logger)
        {
            _personRepository = personRepository;
            _repository = repository;
            _globalSettingRepository = globalSettingRepository;
            _glAccountRepository = glAccountRepository;
            _companyRepository = companyRepository;
            _forteRepository = forteRepository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<PersonMerchant> search(int personId = 0)
        {
            var person = _personRepository.get(personId);

            if (!person.isForteImported)
            {
                var merchants = _repository.search(personId);
                foreach (PersonMerchant item in merchants)
                {
                    try {
                        ForteClient client = new ForteClient(_globalSettingRepository, _companyRepository, _glAccountRepository, _repository, item.personId, item.companyId, person.personTypeId.GetValueOrDefault(), item.merchantId, this._forteRepository);
                        client.getPaymethods(item.personId, item.clientId);
                    }
                    catch (Exception ex)
                    {                       
                    }                    
                }
            }

            return _repository.search(personId);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] PersonMerchant item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] PersonMerchant item)
        {
            if (item == null || item.personMerchantId != id)
            {
                return BadRequest();
            }
            
            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }

    }
}

```
## PersonMessageController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/person/message")]
    public class PersonMessageController : Controller
    {

        public IPersonMessageRepository _repository;
        private ILogger<PersonMessageController> _logger;

        public PersonMessageController(IPersonMessageRepository repository, ILogger<PersonMessageController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<PersonMessage> search(int fromPersonId = 0, int toPersonId = 0)
        {
            return _repository.search(fromPersonId, toPersonId);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] PersonMessage item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] PersonMessage item)
        {
            if (item == null || item.messageId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }

    }
}

```
## PersonMlsController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/person/MlsID")]
    public class PersonMlsController : Controller
    {

        public IPersonMlsRepository _repository;
        private ILogger<PersonMlsController> _logger;

        public PersonMlsController(IPersonMlsRepository repository, ILogger<PersonMlsController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<PersonMls> search(int personId = 0)
        {
            return _repository.search(personId);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] PersonMls item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] PersonMls item)
        {
            if (item == null || item.personMlsID != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }
    }
}

```
## PersonOnlinePaymentController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/person/onlinepayment")]
    public class PersonOnlinePaymentController : Controller
    {

        public IPersonOnlinePaymentRepository _repository;
        private ILogger<PersonOnlinePaymentController> _logger;

        public PersonOnlinePaymentController(IPersonOnlinePaymentRepository repository, ILogger<PersonOnlinePaymentController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<PersonOnlinePayment> search(int personId = 0)
        {
            return _repository.search(personId);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] PersonOnlinePayment item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] PersonOnlinePayment item)
        {
            if (item == null || item.onlinePaymentId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }
    }
}

```
## PersonOverrideController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/person/override")]
    public class PersonOverrideController : Controller
    {
        public IPersonOverrideRepository _repository;
        private ILogger<PersonOverrideController> _logger;

        public PersonOverrideController(IPersonOverrideRepository repository, ILogger<PersonOverrideController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<PersonOverride> search(int personAgentId, int overrideTypeId, int person3rdPartyId, int accountId, int officeId)
        {
            return _repository.search(personAgentId, overrideTypeId, person3rdPartyId, accountId, officeId);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] PersonOverride item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] PersonOverride item)
        {
            if (item == null || item.personOverrideId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }


    }
}

```
## PersonPhoneController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/person/phone")]
    public class PersonPhoneController : Controller
    {

        public IPersonPhoneRepository _repository;
        private ILogger<PersonPhoneController> _logger;

        public PersonPhoneController(IPersonPhoneRepository repository, ILogger<PersonPhoneController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<PersonPhone> search(int personId = 0)
        {
            return _repository.search(personId);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] PersonPhone item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] PersonPhone item)
        {
            if (item == null || item.personPhoneId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }
    }
}

```
## PersonPositionController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/person/position")]
    public class PersonPositionController : Controller
    {

        public IPersonPositionRepository _repository;
        private ILogger<PersonPositionController> _logger;

        public PersonPositionController(IPersonPositionRepository repository, ILogger<PersonPositionController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<PersonPosition> search(int personId = 0)
        {
            return _repository.search(personId);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] PersonPosition item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] PersonPosition item)
        {
            if (item == null || item.positionId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }
    }
}

```
## PersonPreferenceController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/person/preference")]
    public class PersonPreferenceController : Controller
    {
        public IPersonPreferenceRepository _repository;
        private ILogger<PersonPreferenceController> _logger;

        public PersonPreferenceController(IPersonPreferenceRepository repository, ILogger<PersonPreferenceController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<PersonPreference> search(int personId = 0)
        {
            return _repository.search(personId);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] PersonPreference item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] PersonPreference item)
        {
            if (item == null || item.personPreferenceId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }
    }
}

```
## PersonReportController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Repositories;
using Microsoft.AspNetCore.Http;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Logging;

namespace AT.AT2017.Api.Controllers
{
    [Produces("application/json")]
    [Route("api/PersonReport")]
    public class PersonReportController : Controller
    {
        public IPersonReportRepository _repository;
        private ILogger<PropertyReportController> _logger;

        public PersonReportController(IPersonReportRepository repository, ILogger<PropertyReportController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<PersonReport> search(string personId = "",string personType = "", string active = "", string dateType = "", string dateStart = "", string dateEnd = "", int pageIndex=0, int pageSize = 100,
            string showAddresses = "0", string showPhones = "0", string showPositions = "0", string showLicenses = "0", string showInsurances = "0", string showWebProfiles = "0", string showLanguages = "0",
            string showDesignations = "0", string showDeductions = "0", string showTotals = "0", string showExpensesToRecover = "0", string showExpensesRecovered = "0", string showOverrides = "0", 
            string showCustomFields = "0", string showDeleted = "0", string showLevels = "0")
        {
            return _repository.search(personId,personType, active, dateType, dateStart, dateEnd, pageIndex, pageSize,
                    showAddresses, showPhones, showPositions, showLicenses, showInsurances, showWebProfiles, showLanguages,
                    showDesignations, showDeductions, showTotals, showExpensesToRecover, showExpensesRecovered, showOverrides, showCustomFields, showDeleted, showLevels);
        }
    }
}
```
## PersonTimelineTaskController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/person/timelinetask")]
    public class PersonTimelineTaskController : Controller
    {

        public IPersonTimelineTaskRepository _repository;
        private ILogger<PersonTimelineTaskController> _logger;

        public PersonTimelineTaskController(IPersonTimelineTaskRepository repository, ILogger<PersonTimelineTaskController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<PersonTimelineTask> search(int personId = 0)
        {
            return _repository.search(personId);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] PersonTimelineTask item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] PersonTimelineTask item)
        {
            if (item == null || item.personTimelineTaskId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }

    }
}

```
## PersonTimelineTaskManualController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/person/timelinetask/manual")]
    public class PersonTimelineTaskManualController : Controller
    {

        public IPersonTimelineTaskManualRepository _repository;
        private ILogger<PersonTimelineTaskManualController> _logger;

        public PersonTimelineTaskManualController(IPersonTimelineTaskManualRepository repository, ILogger<PersonTimelineTaskManualController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] PersonTimelineTask item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] PersonTimelineTask item)
        {
            if (item == null || item.personTimelineTaskId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }

    }
}

```
## PersonTotalController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/person/total")]
    public class PersonTotalController : Controller
    {

        public IPersonTotalRepository _repository;

        private ILogger<PersonTotalController> _logger;

        public PersonTotalController(IPersonTotalRepository repository, ILogger<PersonTotalController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<PersonTotal> search(int personID)
        {
            return _repository.search(personID);
        }


        [HttpGet("property/{propertyID}")]
        public IEnumerable<PersonTotal> searchByPropertyID(int propertyID, string checkTemplateIDs)
        {
            return _repository.searchByPropertyID(propertyID, checkTemplateIDs);
        }

        [HttpGet("updatelog")]
        public IEnumerable<PersonTotal> searchUpdateLog(int propertyID, string processedDate)
        {
            return _repository.searchUpdateLog(propertyID, processedDate);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpGet("balance")]
        public IEnumerable<PersonTotal> total_get_balanceamount(int personId, int propertyId, int totalId)
        {
            return _repository.total_get_balanceamount(personId, propertyId, totalId);
         }

        [HttpPost]
        public IActionResult add([FromBody] PersonTotal item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut]
        public IActionResult update(int personId, int validateLogin)
        {
            
            _repository.update(personId,validateLogin);

            return new NoContentResult();
        }

        [HttpDelete]
        public IActionResult delete(int personID=0, int totalID= 0, int companyID = 0, int officeID = 0, int planID = 0,bool isForTerminated = false)
        {

            _repository.delete(personID, totalID, companyID, officeID, planID, isForTerminated);

            return new NoContentResult();

        }

        [HttpPut("updateOpeningBalance")]
        public IActionResult updateOpeningBalance(int id, decimal openingBalance,string balanceEndDate)
        {

            _repository.updateOpeningBalance(id,openingBalance, balanceEndDate);

            return new NoContentResult();
        }

        // total update on property post/unpost
        [HttpPut("updateall")]
        public IEnumerable<PersonTotal> updateOnPropertyPost(int propertyID, string processedDate, string checkTemplateIDs, string actionType)
        {
            return _repository.updateOnPropertyPost(propertyID, processedDate, checkTemplateIDs, actionType);
        }

        // total update on demand
        [HttpGet("ondemand/lastexecution")]
        public PersonTotalUpdateLog getLastOnDemandExecution(string processDate = "")
        {
            return _repository.getLastOnDemandExecution(processDate);
        }

        [HttpGet("ondemand/startexecution")]
        public PersonTotalUpdateLog startOnDemandExecution(string updateType)
        {
            return _repository.startOnDemandExecution(updateType);
        }

        [HttpPut("ondemand")]
        public IActionResult updateTotalOnDemand(int personTotalID, string processDate,  string updateType)
        {
            _repository.updateTotalOnDemand(personTotalID, processDate, updateType);

            return new NoContentResult();
        }
        
        [HttpGet("plan")]
        public IEnumerable<PersonTotal> searchPlan(int userID)
        {
            return _repository.searchPlan(userID);
        }

    }
}

```
## PersonTotalDetailController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/person/total/detail")]
    public class PersonTotalDetailController : Controller
    {

        public IPersonTotalDetailRepository _repository;

        private ILogger<PersonTotalDetailController> _logger;

        public PersonTotalDetailController(IPersonTotalDetailRepository repository, ILogger<PersonTotalDetailController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<PersonTotalDetail> search(int personTotalID)
        {
            return _repository.search(personTotalID);
        }

 
    }
}

```
## PersonUptimeController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/person/uptime")]
    public class PersonUptimeController : Controller
    {

        public IPersonUptimeRepository _repository;
        private ILogger<PersonUptimeController> _logger;

        public PersonUptimeController(IPersonUptimeRepository repository, ILogger<PersonUptimeController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<PersonUptime> search(int personId = 0)
        {
            return _repository.search(personId);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] PersonUptime item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] PersonUptime item)
        {
            if (item == null || item.personUptimeId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }
    }
}

```
## PersonWebProfileController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/person/webprofile")]
    public class PersonWebProfileController : Controller
    {

        public IPersonWebProfileRepository _repository;
        private ILogger<PersonWebProfileController> _logger;

        public PersonWebProfileController(IPersonWebProfileRepository repository, ILogger<PersonWebProfileController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<PersonWebProfile> search(int personId = 0)
        {
            return _repository.search(personId);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] PersonWebProfile item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] PersonWebProfile item)
        {
            if (item == null || item.personWebProfileId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }
    }
}

```
## PersonWebsiteController.cs
```cs
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Repositories;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Logging;
using System.Collections.Generic;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/person/website")]
    public class PersonWebsiteController : Controller
    {

        public IPersonWebsiteRepository _repository;
        private ILogger<PersonWebsiteController> _logger;

        public PersonWebsiteController(IPersonWebsiteRepository repository, ILogger<PersonWebsiteController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<PersonWebsite> search(int personId = 0)
        {
            return _repository.search(personId);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] PersonWebsite item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] PersonWebsite item)
        {
            if (item == null || item.personWebsiteID != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }
    }
}
```
## PlaidController.cs
```cs
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Repositories;
using AT.AT2017.Api.Util;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Logging;
using Newtonsoft.Json;
using Newtonsoft.Json.Linq;
using System;
using System.Collections.Generic;
using System.IO;
using System.Net;
using System.Reflection;
using System.Text;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class PlaidController : Controller
    {

        private IPlaidRepository _repository;
        private IGlobalSettingRepository _globalSettingRepository;
        private ISettingRepository _settingRepository;
        private ILogger<PlaidController> _logger;
        private ICompanyBankRepository _companyBankRepository;

        public PlaidController(IPlaidRepository repository, ISettingRepository settingRepository, IGlobalSettingRepository globalSettingRepository, ILogger<PlaidController> logger, ICompanyBankRepository companyBankRepository)
        {
            _repository = repository;
            _logger = logger;
            _settingRepository = settingRepository;
            _globalSettingRepository = globalSettingRepository;
            _companyBankRepository = companyBankRepository;
        }

        [HttpGet("linktoken/create")]
        public string createLinkToken(bool updateMode = false, int? id = null)
        {
            Setting bankStreamEnvSetting = _settingRepository.get(name: "BANKSTREAM_ENVIRONMENT");
            List<GlobalSetting> globalSettings = (List<GlobalSetting>)_globalSettingRepository.search(section: "bankstream");

            string baseUrl;
            string clientID;
            string clientSecret;

            if (bankStreamEnvSetting.value.ToLower() == "production")
            {
                baseUrl = GlobalSettings.getSettingValue(globalSettings, "BANKSTREAM_ENVIRONMENT_URL_PRODUCTION");
                clientID = GlobalSettings.getSettingValue(globalSettings, "BANKSTREAM_CLIENT_ID_PRODUCTION");
                clientSecret = GlobalSettings.getSettingValue(globalSettings, "BANKSTREAM_CLIENT_SECRET_PRODUCTION");
            }
            else
            {
                baseUrl = GlobalSettings.getSettingValue(globalSettings, "BANKSTREAM_ENVIRONMENT_URL_SANDBOX");
                clientID = GlobalSettings.getSettingValue(globalSettings, "BANKSTREAM_CLIENT_ID_SANDBOX");
                clientSecret = GlobalSettings.getSettingValue(globalSettings, "BANKSTREAM_CLIENT_SECRET_SANDBOX");
            }

            string clientName = GlobalSettings.getSettingValue(globalSettings, "BANKSTREAM_CLIENT_NAME");
            string countryCodes = GlobalSettings.getSettingValue(globalSettings, "BANKSTREAM_COUNTRY_CODES");
            string language = GlobalSettings.getSettingValue(globalSettings, "BANKSTREAM_LANGUAGE");
            string clientUserID = GlobalSettings.getSettingValue(globalSettings, "BANKSTREAM_CLIENT_USER_ID");
            string products = GlobalSettings.getSettingValue(globalSettings, "BANKSTREAM_PRODUCTS");
            string webhookUrl = GlobalSettings.getSettingValue(globalSettings, "BANKSTREAM_WEBHOOK_URL");
            string depositorySubTypes = GlobalSettings.getSettingValue(globalSettings, "BANKSTREAM_ACCOUNT_FILTERS_DEPOSITORY_SUBTYPES");
            string creditSubTypes = GlobalSettings.getSettingValue(globalSettings, "BANKSTREAM_ACCOUNT_FILTERS_CREDIT_SUBTYPES");

            string linkToken = "";

            if (updateMode == false)
            {
                linkToken = getPlaidLinkToken(
                    baseUrl,
                    clientID,
                    clientSecret,
                    clientName,
                    countryCodes,
                    language,
                    clientUserID,
                    products,
                    webhookUrl,
                    depositorySubTypes,
                    creditSubTypes);
            }
            else
            {
                CompanyBank bank = _companyBankRepository.get(id.GetValueOrDefault());
                string accessToken = bank.access_token;
                linkToken = getPlaidLinkTokenUpdate(
                    baseUrl,
                    clientID,
                    clientSecret,
                    clientName,
                    countryCodes,
                    language,
                    clientUserID,
                    webhookUrl,
                    accessToken);
            }


            return linkToken;
        }

        private string getPlaidLinkToken(
            string baseUrl,
            string clientId,
            string clientSecret,
            string clientName,
            string countryCodes,
            string language,
            string clientUserID,
            string products,
            string webhookUrl,
            string depositorySubTypes,
            string creditSubTypes)
        {
            string link_token = "";
            string request_id = "";
            string link_token_expiration = "";
            try
            {
                string tokenUrl = baseUrl + "/link/token/create";

                string tokenResponse = PlaidHelper.plaidRequest("POST", tokenUrl, new
                {
                    client_id = clientId,
                    secret = clientSecret,
                    client_name = clientName,
                    country_codes = countryCodes.Split(","),
                    language,
                    user = new { client_user_id = clientUserID.ToUpper() },
                    products = products.Split(","),
                    webhook = webhookUrl,
                    //account_filters = new
                    //{
                    //    depository = new
                    //    {
                    //        account_subtypes = depositorySubTypes.Split(","),
                    //    },
                    //    credit = new
                    //    {
                    //        account_subtypes = creditSubTypes.Split(","),
                    //    }
                    //},
                });

                object oResponse = JsonConvert.DeserializeObject(tokenResponse);

                if (oResponse is JObject)
                {
                    dynamic r = oResponse;
                    link_token = r.link_token;
                    request_id = r.request_id;
                    link_token_expiration = r.expiration;

                    _repository.saveConnectLog("create_link_token", request_id, link_token, link_token_expiration, null, null, null, null, null, null);
                }

            }
            catch
            {
                link_token = string.Empty;
            }

            return link_token;

        }

        private string getPlaidLinkTokenUpdate(
            string baseUrl,
            string clientId,
            string clientSecret,
            string clientName,
            string countryCodes,
            string language,
            string clientUserID,
            string webhookUrl,
            string accessToken)
        {
            string link_token = "";
            string request_id = "";
            string link_token_expiration = "";
            try
            {
                string tokenUrl = baseUrl + "/link/token/create";

                string tokenResponse = PlaidHelper.plaidRequest("POST", tokenUrl, new
                {
                    client_id = clientId,
                    secret = clientSecret,
                    client_name = clientName,
                    user = new { client_user_id = clientUserID.ToUpper() },
                    country_codes = countryCodes.Split(","),
                    language,
                    webhook = webhookUrl,
                    access_token = accessToken
                });

                object oResponse = JsonConvert.DeserializeObject(tokenResponse);

                if (oResponse is JObject)
                {
                    dynamic r = oResponse;
                    link_token = r.link_token;
                    request_id = r.request_id;
                    link_token_expiration = r.expiration;

                    _repository.saveConnectLog("create_link_token (u)", request_id, link_token, link_token_expiration, null, null, null, null, null, null);
                }
            }
            catch
            {
                link_token = string.Empty;
            }

            return link_token;
        }

        [HttpPost("publictoken/exchange")]
        public string exchangeToken([FromBody] Object token)
        {
            Setting bankStreamEnvSetting = _settingRepository.get(name: "BANKSTREAM_ENVIRONMENT");
            List<GlobalSetting> globalSettings = (List<GlobalSetting>)_globalSettingRepository.search(section: "bankstream");

            string baseUrl;
            string clientID;
            string clientSecret;

            if (bankStreamEnvSetting.value.ToLower() == "production")
            {
                baseUrl = GlobalSettings.getSettingValue(globalSettings, "BANKSTREAM_ENVIRONMENT_URL_PRODUCTION");
                clientID = GlobalSettings.getSettingValue(globalSettings, "BANKSTREAM_CLIENT_ID_PRODUCTION");
                clientSecret = GlobalSettings.getSettingValue(globalSettings, "BANKSTREAM_CLIENT_SECRET_PRODUCTION");
            }
            else
            {
                baseUrl = GlobalSettings.getSettingValue(globalSettings, "BANKSTREAM_ENVIRONMENT_URL_SANDBOX");
                clientID = GlobalSettings.getSettingValue(globalSettings, "BANKSTREAM_CLIENT_ID_SANDBOX");
                clientSecret = GlobalSettings.getSettingValue(globalSettings, "BANKSTREAM_CLIENT_SECRET_SANDBOX");
            }

            dynamic d = token;
            string public_token = d.publicToken;
            string metadata = d.metadata;
            string link_token = d.linkToken;

            string accessToken = getAccessToken(baseUrl, clientID, clientSecret, public_token, metadata, link_token);

            return accessToken;
        }

        private string getAccessToken(string baseUrl, string clientId, string clientSecret, string public_token, string metadata, string link_token)
        {
            string access_token = "";
            try
            {
                string tokenUrl = baseUrl + "/item/public_token/exchange";

                string tokenResponse = PlaidHelper.plaidRequest("POST", tokenUrl, new
                {
                    client_id = clientId,
                    secret = clientSecret,
                    public_token,
                });

                object oResponse = JsonConvert.DeserializeObject(tokenResponse);

                if (oResponse is JObject)
                {
                    dynamic r = oResponse;
                    access_token = r.access_token;

                    string request_id = r.request_id;
                    string item_id = r.item_id;

                    dynamic m = JsonConvert.DeserializeObject(metadata);
                    string link_session_id = m.link_session_id;
                    string institution_name = m.institution.name;
                    string institution_id = m.institution.institution_id;

                    _repository.saveConnectLog("exchange_token", request_id, link_token, null, public_token, link_session_id, institution_name, institution_id, item_id, access_token);
                }

            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message);
                access_token = string.Empty;
            }

            return access_token;
        }

        [HttpPost("accounts/get")]
        public string getAccounts([FromBody] Object token)
        {
            Setting bankStreamEnvSetting = _settingRepository.get(name: "BANKSTREAM_ENVIRONMENT");
            List<GlobalSetting> globalSettings = (List<GlobalSetting>)_globalSettingRepository.search(section: "bankstream");

            string baseUrl;
            string clientId;
            string clientSecret;

            if (bankStreamEnvSetting.value.ToLower() == "production")
            {
                baseUrl = GlobalSettings.getSettingValue(globalSettings, "BANKSTREAM_ENVIRONMENT_URL_PRODUCTION");
                clientId = GlobalSettings.getSettingValue(globalSettings, "BANKSTREAM_CLIENT_ID_PRODUCTION");
                clientSecret = GlobalSettings.getSettingValue(globalSettings, "BANKSTREAM_CLIENT_SECRET_PRODUCTION");
            }
            else
            {
                baseUrl = GlobalSettings.getSettingValue(globalSettings, "BANKSTREAM_ENVIRONMENT_URL_SANDBOX");
                clientId = GlobalSettings.getSettingValue(globalSettings, "BANKSTREAM_CLIENT_ID_SANDBOX");
                clientSecret = GlobalSettings.getSettingValue(globalSettings, "BANKSTREAM_CLIENT_SECRET_SANDBOX");
            }

            dynamic d = token;
            string accessToken = d.accessToken;

            string endpointUrl = baseUrl + "/accounts/get";

            string response = PlaidHelper.plaidRequest("POST", endpointUrl, new
            {
                client_id = clientId,
                secret = clientSecret,
                access_token = accessToken,
            });

            return response;

        }

        [HttpGet("connect/log")]
        public IEnumerable<PlaidConnectLog> searchConnectLog()
        {
            return _repository.searchConnectLog();
        }
    }
}
```
## PropertyByAgentCubeController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;
using System.Data;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class PropertyByAgentCubeController : Controller
    {
        public IPropertyByAgentCubeRepository _repository;
        private ILogger<PropertyByAgentCubeController> _logger;

        public PropertyByAgentCubeController(IPropertyByAgentCubeRepository repository, ILogger<PropertyByAgentCubeController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<PropertyByAgentCube> search(int propertyId)
        {
            return _repository.search(propertyId );
        }

        [HttpGet("selected")]
        public IActionResult getFieldsSelected(int propertyId, int personId=0, string side="", int columnNumber=0, int correspondenceTemplateId = 0, int formType=0)
        {
            var item =  _repository.getFieldsSelected(propertyId, personId, side, columnNumber, correspondenceTemplateId, formType);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpGet("formulas")]
        public DataTable processFormulas(int templateId, int propertyId = 0, int personId = 0, string side = "")
        {
            return _repository.processFormulas(templateId, propertyId, personId, side);
        }
    }
}

```
## PropertyController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Classes;
using AT.AT2017.Api.Validation;
using Hangfire;
using System.Data;
using Newtonsoft.Json.Linq;
using AT.AT2017.Api.Core.Exceptions;
using AT.AT2017.Api.Core.Shared;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class PropertyController : Controller
    {
        public IPropertyRepository _repository;
        public IPropertyDeductionRepository _propertyDeductionRepository;
        public IGlobalSettingRepository _globalSettingRepository;
        public IGLAccountRepository _glAccountRepository;
        public IPersonMerchantRepository _personMerchantRepository;
        public ICompanyRepository _companyRepository;
        public IFortePaymentLogRepository _forteLogRepository;
        private ILogger<PropertyController> _logger;
        private IBackgroundJobClient _backgroundJobs;
        private ISettingRepository _settingRepository;
        public IPersonRepository _personRepository;
        public ICheckbookRepository _checkbookRepository;
        public IArPaymentRepository _arPaymentRepository;

        public PropertyController(IPropertyRepository repository, IPropertyDeductionRepository propertyDeductionRepository, IGlobalSettingRepository globalSettingRepository, IPersonRepository personRepository, ISettingRepository settingRepository, IGLAccountRepository glAccountRepository, IPersonMerchantRepository personMerchantRepository, ICompanyRepository companyRepository, IFortePaymentLogRepository forteLogRepository, ICheckbookRepository checkbookRepository, IArPaymentRepository arPaymentRepository, ILogger<PropertyController> logger, IBackgroundJobClient backgroundJobs)
        {
            _repository = repository;
            _propertyDeductionRepository = propertyDeductionRepository;
            _globalSettingRepository = globalSettingRepository;
            _settingRepository = settingRepository;
            _glAccountRepository = glAccountRepository;
            _personMerchantRepository = personMerchantRepository;
            _companyRepository = companyRepository;
            _forteLogRepository = forteLogRepository;
            _personRepository = personRepository;
            _logger = logger;
            _backgroundJobs = backgroundJobs;
            _checkbookRepository = checkbookRepository;
            _arPaymentRepository = arPaymentRepository;
        }

        [HttpGet]
        public IEnumerable<Property> search(int companyId = 0, string filter = "", string address = "", string mls = "", string propId = "", string trType = "", int statusId = 0
            , int propertyTypeId = 0, int pageIndex = 0, int pageSize = 10, string sortedBy = "propertyAddress", string customCase = "all", bool withTrash = false, string statusCode = "")
        {
            return _repository.search(companyId, filter, address, mls, propId, trType, statusId, propertyTypeId, pageIndex, pageSize, sortedBy, customCase, withTrash, statusCode);
        }

        [HttpGet("paginated")]
        public PagedList<Property> searchPaginated(int companyId = 0, string filter = "", string address = "", string mls = "", string propId = "", string trType = "", int statusId = 0
            , int propertyTypeId = 0, int pageIndex = 0, int pageSize = 10, string sortedBy = "propertyAddress", string customCase = "all", bool withTrash = false, string statusCode = "")
        {
            return _repository.searchPaginated(companyId, filter, address, mls, propId, trType, statusId, propertyTypeId, pageIndex, pageSize, sortedBy, customCase, withTrash, statusCode);
        }

        [HttpGet("search/paginated")]
        public PagedList<PropertyMain> advance_searchPaginated(int companyId, string address = "", string mls = "", string propertyId = "", string status = "",
            int propertyTypeId = 0, string fromDate = "", string toDate = "", string qaControl1 = "", string qaControl2 = "", string buyer = "", string seller = "",
            string brokerReferenceNo = "", string escrowNo = "", int classificationId = 0, int pageIndex = 1, int pageSize = 10, string filterBy = "listDate", string trType = "",
            bool withTrash = false, string agent = "", int officeId = 0, string escrowPayeeName = "", string sortBy = "", string filter1By = "")
        {
            return _repository.advance_searchPaginated(companyId, address, mls, propertyId, status, propertyTypeId, fromDate, toDate, qaControl1, qaControl2, buyer, seller, brokerReferenceNo, escrowNo, classificationId, pageIndex, pageSize, filterBy, trType, withTrash, agent, officeId, escrowPayeeName, sortBy, filter1By);
        }

        [HttpGet("advance_search")]
        public IEnumerable<PropertyMain> advance_search(int companyId, string address = "", string mls = "", string propId = "", string status = "",
            int propertyTypeId = 0, string fromDate = "", string toDate = "", string qaControl1 = "", string qaControl2 = "", string buyer = "", string seller = "",
            string brokerReferenceNo = "", string escrowNo = "", int classificationId = 0, int pageIndex = 0, int pageSize = 10, string filterBy = "listDate", string trType = "",
            bool withTrash = false, string agent = "", int officeId = 0, string escrowPayeeName = "", string sortBy = "", string filter1By = "")
        {
            return _repository.advance_search(companyId, address, mls, propId, status, propertyTypeId, fromDate, toDate, qaControl1, qaControl2, buyer, seller, brokerReferenceNo, escrowNo, classificationId, pageIndex, pageSize, filterBy, trType, withTrash, agent, officeId, escrowPayeeName);
        }

        [HttpGet("deleted")]
        public IEnumerable<Property> searchDeletedRecord(int pageIndex = 0, int pageSize = 10)
        {
            return _repository.searchDeletedRecord(pageIndex, pageSize);
        }

        [HttpGet("searchByPerson")]
        public IActionResult searchByPerson(int personId, string status, string includeColumns = null, string ignoreColumns = null)
        {
            IList<Property> properties = _repository.searchByPerson(personId, status).ToList();

            return new CustomResult(properties, includeColumns?.Split(","), ignoreColumns?.Split(","));
        }

        [HttpGet("closeDateList")]
        public IEnumerable<CodeValue> closeDateList()
        {
            return _repository.closeDateList();
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        [ValidateModel]
        public IActionResult add([FromBody] Property item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        [ValidateModel]
        public IActionResult update(int id, [FromBody] Property item, bool onlyUpdateCommission = false, bool refreshListSide = true, bool refreshSellSide = true)
        {
            if (item == null || item.propertyId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            bool recalculateInParallel = false;
            Setting inParallelSetting = _settingRepository.get("ENABLE_RECALCULATE_DEDUCTIONS_IN_PARALLEL");
            if (inParallelSetting != null)
            {
                Boolean.TryParse(inParallelSetting.value, out recalculateInParallel);
            }

            bool updateTotals = false;
            Setting updateTotalsSetting = _settingRepository.get("UPDATE_TOTALS_AFTER_COMMISSION_RECALC");
            if (updateTotalsSetting != null)
            {
                Boolean.TryParse(updateTotalsSetting.value, out updateTotals);
            }

            _repository.update(item, onlyUpdateCommission, refreshListSide, refreshListSide, _propertyDeductionRepository, recalculateInParallel, updateTotals);

            itemFound = _repository.get(id);

            return new ObjectResult(itemFound);
        }

        [HttpPut("{id}/needrecalc")]
        public IActionResult updateNeedRecalc(int id)
        {
            _repository.updateNeedRecalc(id);

            return new NoContentResult();
        }

        [HttpPut("{id}/thirdpartyID")]
        public IActionResult updateThirdPartyID(int id, string thirdPartyIdField, string thirdPartyId)
        {
            _repository.updateThirdPartyID(id, thirdPartyIdField, thirdPartyId);

            return new NoContentResult();
        }

        [HttpPut("{id}/appfileID")]
        public IActionResult updateAppFileID(int id, int appFileID)
        {
            _repository.updateAppFileID(id, appFileID);

            return new NoContentResult();
        }

        [HttpPut("recalculatePendings")]
        public IActionResult recalculatePendings()
        {
            int executionID = _repository.recalculatePendings();
            var item = _repository.recalculatePendingsGetExecution(executionID);
            return new ObjectResult(item);
        }

        [HttpGet("recalculatePendings/last")]
        public IActionResult recalculatePendingsGetExecution()
        {
            var item = _repository.recalculatePendingsGetExecution();
            return new ObjectResult(item);
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }

        [HttpPost("copy")]
        public IActionResult copy(int id, string copyType)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            int newId = _repository.copy(id, copyType);

            item = _repository.get(newId);
            return new ObjectResult(item);
        }

        [HttpPut("unpost/{id}")]
        public IActionResult unpost(int id)
        {
            _repository.unpost(id);
            var item = _repository.get(id);

            return new ObjectResult(item);
        }

        [HttpPut("unpostRegional/{id}")]
        public IActionResult unpostRegional(int id)
        {
            _repository.unpostRegional(id);
            var item = _repository.get(id);

            return new ObjectResult(item);
        }

        [HttpPut("validatePost")]
        public IEnumerable<PropertyPostError> validatePost([FromBody] Property item, int id, string postDateAccounting, string postDateArPayment, string postDateApPayment, string postDateDeposit, bool directDeposit, string checkNumber, int commissionAccountId, bool recordCommission, bool onePayment, string payment1, string payment2, string payment3, bool recordAsSingleDeposit, int depositAccountId, bool writeEscrowCheck, string escrowCheckNumber, bool payEscrowByForte, string deposits, bool excludeRules)
        {

            return _repository.validatePost(item, postDateAccounting, postDateArPayment, postDateApPayment, postDateDeposit, directDeposit, checkNumber, commissionAccountId, recordCommission, onePayment, payment1, payment2, payment3, recordAsSingleDeposit, depositAccountId, writeEscrowCheck, escrowCheckNumber, payEscrowByForte, deposits, excludeRules);

        }

        [HttpPut("validatePostRegional")]
        public IEnumerable<PropertyPostError> validatePostRegional([FromBody] Property item, int id, string postDateAccounting)
        {

            return _repository.validatePostRegional(item, postDateAccounting);

        }

        [HttpPut("postRegional")]
        public IActionResult postRegional([FromBody] Property item, int id, string postDateAccounting)
        {
            _repository.postRegional(item, postDateAccounting);
            item = _repository.get(id);

            return new ObjectResult(item);
        }

        [HttpPut("post")]
        public PropertyPostResult post([FromBody] Property item, int id, string postDateAccounting,
            string postDateArPayment, string postDateApPayment, string postDateDeposit, bool directDeposit,
            string checkNumber, int commissionAccountId, bool recordCommission, bool onePayment,
            string payment1, string payment2, string payment3, bool recordAsSingleDeposit, int depositAccountId,
            bool writeEscrowCheck, string escrowCheckNumber, bool payEscrowByForte, string deposits, bool excludeRules
        )
        {
            List<FortePaymentLog> listResult = new List<FortePaymentLog>();
            IEnumerable<ApPayment> payments;
            bool isForteByAccount = false;

            PropertyPostResult previewResult = _repository.post(
                item,
                postDateAccounting,
                postDateArPayment,
                postDateApPayment,
                postDateDeposit,
                directDeposit,
                checkNumber,
                commissionAccountId,
                recordCommission,
                onePayment,
                payment1,
                payment2,
                payment3,
                recordAsSingleDeposit,
                depositAccountId,
                writeEscrowCheck,
                escrowCheckNumber,
                payEscrowByForte,
                deposits,
                excludeRules);

            payments = previewResult.apPayments;           

            IEnumerable<Setting> settingList = _settingRepository.search("", "", "Forte", "");
            Setting settingC;

            settingC = settingList.First(s => s.name == "NACHA_ACH_" + item.companyID.ToString());

            if (payments.Count() > 0 && settingC.value.ToLower() == "false")
            {
                settingC = settingList.First(s => s.name == "ENABLE_FORTE_BY_ACCOUNT");
                if (settingC != null)
                    if (settingC.value.ToLower() == "true")
                        isForteByAccount = true;

                if (isForteByAccount == false)
                {
                    ForteClient client = new ForteClient(_settingRepository, _globalSettingRepository, _companyRepository, item.companyID, "credit");

                    foreach (ApPayment payment in payments)
                    {
                        if (payment.withDirectDeposit)
                        {
                            Person person = _personRepository.get(payment.personId.GetValueOrDefault());
                            FortePaymentLog result = client.payTransaction(payment.paidAmount, payment.apPaymentId, person.forteClientId, "credit", person.forteAchId, person.forteCcId);

                            result.paymentId = payment.apPaymentId;
                            result.paymentType = "AP";
                            result.paymethodType = "ACH";
                            _forteLogRepository.add(result);
                            listResult.Add(result);
                        }
                    }
                }
                else
                {
                    foreach (ApPayment payment in payments)
                    {
                        if (payment.withDirectDeposit)
                        {
                            FortePaymentLog result = new FortePaymentLog();
                            try
                            {
                                ForteClient client = new ForteClient(_globalSettingRepository, _companyRepository, _glAccountRepository, _personMerchantRepository, payment.bankAccountId.GetValueOrDefault(), payment.personId.GetValueOrDefault(), payment.companyId, 0, "credit");
                                result = client.payTransaction(payment.paidAmount, payment.apPaymentId, "credit", true);

                            }
                            catch (Exception e)
                            {                               
                                result.responseCode = "Failed";
                                result.responseDescription = e.Message;
                            }
                            finally
                            {
                                result.paymentId = payment.apPaymentId;
                                result.paymentType = "AP";
                                result.paymethodType = "ACH";
                            }

                            _forteLogRepository.add(result);
                            listResult.Add(result);
                        }
                    }

                }                
            }

            if (payEscrowByForte == true && previewResult.escrowCheckIDForEscrowHeld>0 && previewResult.arPaymentIDForEscrowHeld > 0)
            {
                Checkbook escrowCheck = _checkbookRepository.get(previewResult.escrowCheckIDForEscrowHeld);

                if (escrowCheck != null)
                {
                    int depositId = 0;
                    bool undoAll = false;

                    escrowCheck.amount = (escrowCheck.amount < 0 ? escrowCheck.amount * -1 : escrowCheck.amount);

                    // Create the autodeposit for the ARPayment of the amount of the escrow held (as undeposited items for the deposit)
                    //Pay electronically by FORTE for the amount of the escrow held(action = credit)
                    depositId = _checkbookRepository.addAutoDepositFromPost(previewResult.arPaymentIDForEscrowHeld, previewResult.escrowCheckIDForEscrowHeld, id, postDateDeposit, item.companyID);                
                    
                    FortePaymentLog autoDepositResult = new FortePaymentLog();
                    string forteAchId, forteCcId;

                    Person person = _personRepository.get(escrowCheck.personId.GetValueOrDefault());
                    forteAchId = person.forteAchId;
                    forteCcId = person.forteCcId;
                  
                    if (isForteByAccount == false)
                    {
                        try
                        {
                           ForteClient client = new ForteClient(_settingRepository, _globalSettingRepository, _companyRepository, item.companyID, "credit");
                            autoDepositResult = client.payTransaction(escrowCheck.amount, escrowCheck.checkbookId, person.forteClientId, "credit", person.forteAchId, person.forteCcId);
                            autoDepositResult.paymentId = escrowCheck.checkbookId;
                            autoDepositResult.paymentType = "CH";
                            autoDepositResult.paymethodType = (forteAchId != null && forteAchId != "" ? "ACH" : "CC"); 

                            if (autoDepositResult.responseCode != "A01")
                            {
                                undoAll = true;
                            }
                        }
                        catch (Exception e)
                        {
                            autoDepositResult.paymentType = "CH";                           
                            autoDepositResult.responseDescription = "Forte payment for Escrow held failed: " + e.Message;
                            undoAll = true;
                        }

                    }
                    else
                    {
                        try
                        {
                            int isForte = (forteAchId != null && forteAchId != "" ? 2 : 1);
                            ForteClient client = new ForteClient(_globalSettingRepository, _companyRepository, _glAccountRepository, _personMerchantRepository, escrowCheck.accountId.GetValueOrDefault(), escrowCheck.personId.GetValueOrDefault(), escrowCheck.companyId, 0, "credit");
                            autoDepositResult = client.payTransaction(escrowCheck.amount, escrowCheck.checkbookId, "credit", (isForte == 2 ? true :false));
                            autoDepositResult.paymentId = escrowCheck.checkbookId;
                            autoDepositResult.paymentType = "CH";
                            autoDepositResult.paymethodType = (isForte == 2 ? "ACH" : "CC");

                            if (autoDepositResult.responseCode != "A01")
                            {
                                undoAll = true;
                            }
                        }
                        catch (Exception e)
                        {
                            autoDepositResult.paymentType = "CH";                     
                            autoDepositResult.responseDescription = "Forte payment for Escrow held failed: " + e.Message;
                            undoAll = true;
                        }
                    }

                    if (autoDepositResult != null)
                    {
                        _forteLogRepository.add(autoDepositResult);
                        listResult.Add(autoDepositResult);
                    }

                    //if Forte payment fails, THEN rollback 5.2,(autodeposit for the ARPayment) escrow held ARpayment from 5.1(arpayments ) and 1 (escrow check)
                    if (undoAll == true)
                    {   //escrow check
                        _checkbookRepository.unpost(previewResult.escrowCheckIDForEscrowHeld);
                        _checkbookRepository.delete(previewResult.escrowCheckIDForEscrowHeld);
                        //auto deposit
                        _checkbookRepository.unpost(depositId);
                        _checkbookRepository.delete(depositId);
                        //arpayment
                        _arPaymentRepository.unpost(previewResult.arPaymentIDForEscrowHeld);
                        _arPaymentRepository.delete(previewResult.arPaymentIDForEscrowHeld);
                    }
                }
            }

            PropertyPostResult postResult = new PropertyPostResult();
            postResult.apPayments = payments;        
            postResult.fortePaymentLogs = listResult;

            return postResult;
        }

        [HttpPut("updatePostInfo/{id}")]
        public IActionResult updatePostInfo(int id, [FromBody] Property item)
        {
            if (item == null || item.propertyId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.updatePostInfo(item);

            return new NoContentResult();
        }

        [HttpGet("previewInvoice")]
        public Invoice previewInvoice(int id, string postDate)
        {
            return _repository.previewInvoice(id, postDate);
        }

        [HttpGet("previewVoucherxAgent")]
        public IEnumerable<Voucher> previewVoucherxAgent(int id, string postDate, decimal taxCollected = 0)
        {
            return _repository.previewVoucherxAgent(id, postDate, taxCollected);
        }

        [HttpGet("previewVoucherxReferral")]
        public IEnumerable<Voucher> previewVoucherxReferral(int id, string postDate, decimal taxCollected = 0)
        {
            return _repository.previewVoucherxReferral(id, postDate, taxCollected);
        }

        [HttpGet("previewVoucherxThirdParty")]
        public IEnumerable<Voucher> previewVoucherxThirdParty(int id, string postDate, decimal taxCollected = 0)
        {
            return _repository.previewVoucherxThirdParty(id, postDate, taxCollected);
        }

        [HttpGet("previewVoucherxOverride")]
        public IEnumerable<Voucher> previewVoucherxOverride(int id, string postDate, decimal taxCollected = 0)
        {
            return _repository.previewVoucherxOverride(id, postDate, taxCollected);
        }

        [HttpGet("previewVoucherxReimbursement")]
        public IEnumerable<Voucher> previewVoucherxReimbursement(int id, string postDate, decimal taxCollected = 0)
        {
            return _repository.previewVoucherxReimbursement(id, postDate, taxCollected);
        }

        [HttpGet("previewVoucherxExtraVoucher")]
        public IEnumerable<Voucher> previewVoucherxExtraVoucher(int id, string postDate, decimal taxCollected = 0)
        {
            return _repository.previewVoucherxExtraVoucher(id, postDate, taxCollected);
        }

        [HttpGet("previewCheckbookEscrows")]
        public IEnumerable<Checkbook> previewCheckbookEscrows(int id, string postDate)
        {
            return _repository.previewCheckbookEscrows(id, postDate);
        }

        [HttpPut("{id}/updateAddCustomer")]
        public IActionResult updateAddCustomer(int id)
        {
            int customerId = _repository.updateAddCustomer(id);
            return new ObjectResult(customerId);
        }

        [HttpGet("previewInvoiceRegional")]
        public IEnumerable<InvoiceDetail> previewInvoiceRegional(int id)
        {
            return _repository.previewInvoiceRegional(id);
        }

        [HttpPost("payload")]
        public IActionResult payload([FromBody] PropertyPayload payload)
        {
            if (payload == null)
            {
                return new ObjectResult("Verify that valid values are sent in the attributes");
            }

            try
            {
                JObject jsonResult = null;
                DataTable dtPayload = _repository.payload(payload);
                if (dtPayload.Rows.Count > 0)
                {
                    jsonResult = new JObject(
                              dtPayload.Columns.Cast<DataColumn>()
                              .Select(c => new JProperty(c.ColumnName, JToken.FromObject(dtPayload.Rows[0][c])))
                              );
                }

                return Ok(jsonResult);
            }
            catch (Exception ex)
            {
                throw new ModelValidationException(ex.Message);
            }

        }

        [HttpPut("updateAgentTeam")]
        public IActionResult updateAgentTeam(int id, int agentTeamId, string side)
        {
            _repository.updateAgentTeam(id, agentTeamId, side);

            return new NoContentResult();
        }

        [HttpPut("updateAgentInfo")]
        public IActionResult updateAgentInfo(int id, int agentTeamListId, int agentTeamSellId, int listSubplanId, int sellSubplanId)
        {
            _repository.updateAgentInfo(id, agentTeamListId, agentTeamSellId, listSubplanId, sellSubplanId);

            return new NoContentResult();
        }

        [HttpGet("calculateCustomCommission")]
        public IActionResult calculateCustomCommission(double percentage, int codeValueId, int propertyId)
        {
            double calculatedCommission = _repository.calculateCustomCommission(percentage, codeValueId, propertyId);
            return new ObjectResult(calculatedCommission);
        }
    }
}

```
## PropertyCubeController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using System.Data;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class PropertyCubeController : Controller
    {
        public IPropertyCubeRepository _repository;
        private ILogger<PropertyController> _logger;

        public PropertyCubeController(IPropertyCubeRepository repository, ILogger<PropertyController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet("selected")]
        public IActionResult getFieldsSelected(int propertyId=0, int correspondenceTemplateId=0, int formType=0)
        {
            var item = _repository.getFieldsSelected (propertyId, correspondenceTemplateId, formType);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpGet("formulas")]
        public DataTable processFormulas(int templateId, int propertyId=0, int personId=0, string side="")
        {
            return _repository.processFormulas(templateId, propertyId, personId, side);
        }

    }
}

```
## PropertyCustomFieldController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/property/custom")]
    public class PropertyCustomFieldController : Controller
    {
        public IPropertyCustomFieldRepository _repository;
        private ILogger<PropertyCustomFieldController> _logger;

        public PropertyCustomFieldController(IPropertyCustomFieldRepository repository, ILogger<PropertyCustomFieldController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<PropertyCustomField> search(int propertyId )
        {
            return _repository.search(propertyId);
        }

        [HttpPost]
        public IActionResult add([FromBody] PropertyCustomField item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            return new NoContentResult();
        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] PropertyCustomField item)
        {
            if (item == null || item.customFieldId != id)
            {
                return BadRequest();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            _repository.delete(id);

            return new NoContentResult();

        }

    }
}

```
## PropertyDeductionController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/property/deduction")]
    public class PropertyDeductionController : Controller
    {
        public IPropertyDeductionRepository _repository;
        public IPropertyRepository _propertyRepository;
        public ISettingRepository _settingRepository;
        private ILogger<PropertyDeductionController> _logger;

        public PropertyDeductionController(IPropertyDeductionRepository repository, IPropertyRepository propertyRepository, ISettingRepository settingRepository, ILogger<PropertyDeductionController> logger)
        {
            _repository = repository;
            _propertyRepository = propertyRepository;
            _settingRepository = settingRepository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<PropertyDeduction> search(int propertyId, string side = "", bool applyTaxes = false, decimal? taxCollected = null)
        {
            return _repository.search(propertyId, side, applyTaxes, taxCollected);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] PropertyDeduction item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            bool recalculateInParallel = false;
            Setting inParallelSetting = _settingRepository.get("ENABLE_RECALCULATE_DEDUCTIONS_IN_PARALLEL");
            if (inParallelSetting != null)
            {
                Boolean.TryParse(inParallelSetting.value, out recalculateInParallel);
            }

            bool updateTotals = false;
            Setting updateTotalsSetting = _settingRepository.get("UPDATE_TOTALS_AFTER_COMMISSION_RECALC");
            if (updateTotalsSetting != null)
            {
                Boolean.TryParse(updateTotalsSetting.value, out updateTotals);
            }

            int id = _repository.add(item, recalculateInParallel, updateTotals);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update([FromBody] PropertyDeduction item, int id, string deductCodeUpdated = "", bool enableFlat = false)
        {
            if (item == null || item.propertyDeductionId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(item.propertyDeductionId);
            if (itemFound == null)
            {
                return NotFound();
            }

            bool recalculateInParallel = false;
            Setting inParallelSetting = _settingRepository.get("ENABLE_RECALCULATE_DEDUCTIONS_IN_PARALLEL");
            if (inParallelSetting != null)
            {
                Boolean.TryParse(inParallelSetting.value, out recalculateInParallel);
            }

            bool updateTotals = false;
            Setting updateTotalsSetting = _settingRepository.get("UPDATE_TOTALS_AFTER_COMMISSION_RECALC");
            if (updateTotalsSetting != null)
            {
                Boolean.TryParse(updateTotalsSetting.value, out updateTotals);
            }

            _repository.update(item, deductCodeUpdated, enableFlat, recalculateInParallel, updateTotals);

            return new NoContentResult();
        }

        [HttpPut("recalculate")]
        public IActionResult recalculate(int propertyId, string side, bool force, bool restart)
        {
            Property property = _propertyRepository.get(propertyId);
            if (property == null)
            {
                return NotFound();
            }

            // recalculate only when status is AC or OP
            if (property.statusCode == "AC" || property.statusCode == "OP")
            {
                bool recalculateInParallel = false;
                Setting inParallelSetting = _settingRepository.get("ENABLE_RECALCULATE_DEDUCTIONS_IN_PARALLEL");
                if (inParallelSetting != null)
                {
                    Boolean.TryParse(inParallelSetting.value, out recalculateInParallel);
                }

                bool updateTotals = false;
                Setting updateTotalsSetting = _settingRepository.get("UPDATE_TOTALS_AFTER_COMMISSION_RECALC");
                if (updateTotalsSetting != null)
                {
                    Boolean.TryParse(updateTotalsSetting.value, out updateTotals);
                }

                _repository.recalculate(propertyId, side, recalculateInParallel, force, restart, updateTotals);
            }

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            bool recalculateInParallel = false;
            Setting inParallelSetting = _settingRepository.get("ENABLE_RECALCULATE_DEDUCTIONS_IN_PARALLEL");
            if (inParallelSetting != null)
            {
                Boolean.TryParse(inParallelSetting.value, out recalculateInParallel);
            }

            bool updateTotals = false;
            Setting updateTotalsSetting = _settingRepository.get("UPDATE_TOTALS_AFTER_COMMISSION_RECALC");
            if (updateTotalsSetting != null)
            {
                Boolean.TryParse(updateTotalsSetting.value, out updateTotals);
            }

            _repository.delete(id, item.propertyId, item.side, recalculateInParallel, updateTotals);

            return new NoContentResult();

        }
        
        [HttpGet("calculateBillDeduct")]
        public string calculateBillDeduct(int personId)
        {
            return _repository.calculateBillDeduct(personId);
        }

        [HttpGet("agentsinvoices")]
        public IEnumerable<Invoice> searchPropertyDeductionAgentsInvoices(int propertyId)
        {
            return _repository.searchPropertyDeductionAgentsInvoices(propertyId);
        }

        [HttpPut("updateAgentOffice")]
        public IActionResult updateAgentOffice([FromBody] PropertyDeduction item)
        {
            if (item == null )
            {
                return BadRequest();
            }

           _repository.updateAgentOffice(item);

            return new NoContentResult();
        }
    }
}

```
## PropertyDeductionHistoryController.cs
```cs
using System.Collections.Generic;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/property/deduction/history")]
    public class PropertyDeductionHistoryController : Controller
    {
        public IPropertyDeductionHistoryRepository _repository;
        private ILogger<PropertyDeductionHistoryController> _logger;

        public PropertyDeductionHistoryController(IPropertyDeductionHistoryRepository repository, ILogger<PropertyDeductionHistoryController> logger)
        {
            _repository = repository;
            _logger = logger;
        }


        [HttpGet]
        public IEnumerable<PropertyDeductionHistory> search(int propertyDeductionId, int deductionId)
        {
            return _repository.search(propertyDeductionId, deductionId);
        }
    }
}

```
## PropertyDeductionOverrideController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/property/deduction/override")]
    public class PropertyDeductionOverrideController : Controller
    {
        public IPropertyDeductionOverrideRepository _repository;
        private ILogger<PropertyDeductionOverrideController> _logger;

        public PropertyDeductionOverrideController(IPropertyDeductionOverrideRepository repository, ILogger<PropertyDeductionOverrideController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<PropertyDeductionOverride> search(int propertyId, int propertyDeductionId = 0, int personOverrideId = 0, bool applyTaxes = false, decimal? taxCollected = null)
        {
            return _repository.search(propertyId, propertyDeductionId, personOverrideId, applyTaxes, taxCollected);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] PropertyDeductionOverride item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] PropertyDeductionOverride item)
        {
            if (item == null || item.propertyOverrideId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }

        [HttpPut("refresh/{propertyId}")]
        public IActionResult refresh(int propertyId)
        {     
            _repository.refresh(propertyId);

            return new NoContentResult();
        }
    }
}

```
## PropertyDocumentController.cs
```cs
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using System.Collections.Generic;
using AT.AT2017.Api.Core.Models;
using System.Net.Mail;
using System;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/property/document")]
    public class PropertyDocumentController : Controller
    {
        public IPropertyDocumentRepository _repository;

        private ILogger<PropertyDocumentController> _logger;

        public PropertyDocumentController(IPropertyDocumentRepository repository, ILogger<PropertyDocumentController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<PropertyDocument> search(int propertyId)
        {
            return _repository.search(propertyId);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] PropertyDocument item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] PropertyDocument item)
        {
            if (item == null || item.documentID != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }

        [HttpPost("delivery/{id}")]
        public IActionResult delivery(int id, string email)
        {
            var item = _repository.search(id);
            if (item == null)
            {
                return NotFound();
            }

            try
            {
                var m = new MailAddress(email);
            }
            catch (FormatException)
            {
                return BadRequest();
            }

            _repository.delivery(id, email);

            return new OkResult();

        }
    }
}
```
## PropertyDocumentHistoryController.cs
```cs
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using System.Collections.Generic;
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/property/document/history")]
    public class PropertyDocumentHistoryController : Controller
    {
        public IPropertyDocumentHistoryRepository _repository;

        private ILogger<PropertyDocumentHistoryController> _logger;

        public PropertyDocumentHistoryController(IPropertyDocumentHistoryRepository repository, ILogger<PropertyDocumentHistoryController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<PropertyDocument> search(int documentId)
        {
            return _repository.search(documentId);
        }

        [HttpPost]
        public IActionResult add([FromBody] PropertyDocument item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item.documentID);

            //item = _repository.get(id);
            return new ObjectResult(item);

        }
    }
}
```
## PropertyEmailController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/property/email")]
    public class PropertyEmailController : Controller
    {

        public IPropertyEmailRepository _repository;
        private ILogger<PropertyEmailController> _logger;

        public PropertyEmailController(IPropertyEmailRepository repository, ILogger<PropertyEmailController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpGet("suggest/{id}")]
        public IActionResult getSuggestion(int id)
        {
            var item = _repository.getSuggestion(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] PropertyEmail item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPost("check")]
        public IActionResult checkAvailability([FromBody] PropertyEmail item)
        {
            var value = _repository.checkAvailability(item);
            if (value)
            {
                return new OkResult();
            }
            else
            {
                return BadRequest();
            }
        }

    }
}

```
## PropertyExtraVoucherController.cs
```cs
using System.Collections.Generic;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860
namespace AT.AT2017.Api.Controllers
{
    [Route("api/property/extravoucher")]
    public class PropertyExtraVoucherController : Controller
    {
        public IPropertyExtraVoucherRepository _repository;
        private ILogger<PropertyExtraVoucherController> _logger;

        public PropertyExtraVoucherController(IPropertyExtraVoucherRepository repository, ILogger<PropertyExtraVoucherController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<PropertyExtraVoucher> search(int propertyId, bool applyTaxes = false, decimal? taxCollected = null)
        {
            return _repository.search(propertyId, applyTaxes, taxCollected);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] PropertyExtraVoucher item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] PropertyExtraVoucher item)
        {
            if (item == null || item.propertyExtraVoucherId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }

        [HttpPut("refresh/{propertyId}")]
        public IActionResult refresh(int propertyId)
        {
            _repository.refresh(propertyId);

            return new NoContentResult();
        }
    }
}

```
## PropertyFeatureController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/property/feature")]
    public class PropertyFeatureController : Controller
    {

        public IPropertyFeatureRepository _repository;
        private ILogger<PropertyFeatureController> _logger;

        public PropertyFeatureController(IPropertyFeatureRepository repository, ILogger<PropertyFeatureController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<PropertyFeature> search(int propertyId = 0)
        {
            return _repository.search(propertyId);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] PropertyFeature item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] PropertyFeature item)
        {
            if (item == null || item.propertyFeatureId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }

    }
}

```
## PropertyMessageController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/property/message")]
    public class PropertyMessageController : Controller
    {
        public IPropertyInternalMessageRepository _repository;
        private ILogger<PropertyMessageController> _logger;

        public PropertyMessageController(IPropertyInternalMessageRepository repository, ILogger<PropertyMessageController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<PropertyInternalMessage> search(int propertyId = 0)
        {
            return _repository.search(propertyId);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] PropertyInternalMessage item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] PropertyInternalMessage item)
        {
            if (item == null || item.internalMessageId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }

    }
}

```
## PropertyMlsController.cs
```cs
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Repositories;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Logging;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/property/mls")]
    public class PropertyMlsController : Controller
    {

        public IPropertyMlsRepository _repository;
        private ILogger<PropertyMlsController> _logger;

        public PropertyMlsController(IPropertyMlsRepository repository, ILogger<PropertyMlsController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<PropertyMls> search(int propertyID = 0)
        {
            return _repository.search(propertyID);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] PropertyMls item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] PropertyMls item)
        {
            if (item == null || item.propertyMlsID != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }
    }
}

```
## PropertyOffsetController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using AT.AT2017.Api.Core.Models;
using Microsoft.Extensions.Logging;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class PropertyOffsetController : Controller
    {

        public IPropertyOffsetRepository _repository;
        private ILogger<PropertyOffsetController> _logger;

        public PropertyOffsetController(IPropertyOffsetRepository repository, ILogger<PropertyOffsetController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<PropertyOffset> search(string side = "")
        {
            return _repository.search(side);
        }

        [HttpGet("reversible")]
        public IEnumerable<PropertyOffset> search_reversible()
        {
            return _repository.search_reversible();
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

         [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] PropertyOffset item)
        {
            if (item == null || item.propertyOffsetId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }
    }
}

```
## PropertyOpenhouseController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/property/openhouse")]
    public class PropertyOpenhouseController : Controller
    {

        public IPropertyOpenhouseRepository _repository;
        private ILogger<PropertyOpenhouseController> _logger;

        public PropertyOpenhouseController(IPropertyOpenhouseRepository repository, ILogger<PropertyOpenhouseController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<PropertyOpenhouse> search(int propertyId = 0)
        {
            return _repository.search(propertyId);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] PropertyOpenhouse item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] PropertyOpenhouse item)
        {
            if (item == null || item.propertyOpenhouseId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }

    }
}

```
## PropertyPaymentOffTheTopController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Repositories;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/property/paymentoffthetop")]
    public class PropertyPaymentOffTheTopController : Controller
    {

        public IPropertyPaymentOffTheTopRepository _repository;
        private ILogger<PropertyPaymentOffTheTopController> _logger;

        public PropertyPaymentOffTheTopController(IPropertyPaymentOffTheTopRepository repository, ILogger<PropertyPaymentOffTheTopController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<PropertyPaymentOffTheTop> search(int propertyId = 0, int personId = 0, bool includeCobroke = false, bool applyTaxes = false, decimal? taxCollected = null)
        {
            return _repository.search(propertyId, personId, includeCobroke, applyTaxes, taxCollected);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] PropertyPaymentOffTheTop item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] PropertyPaymentOffTheTop item)
        {
            if (item == null || item.topId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }


    }
}

```
## PropertyPeopleController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/property/people")]
    public class PropertyPeopleController : Controller
    {

        public IPropertyPeopleRepository _repository;
        private ILogger<PropertyPeopleController> _logger;
        
        public PropertyPeopleController(IPropertyPeopleRepository repository, ILogger<PropertyPeopleController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<PropertyPeople> search(int propertyId = 0, string typeName = "", string side = "")
        {
            return _repository.search(propertyId,typeName,side);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] PropertyPeople item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] PropertyPeople item)
        {
            if (item == null || item.propertyPeopleId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }

    }
}

```
## PropertyPictureController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;
using System.Net.Mail;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/property/picture")]
    public class PropertyPictureController : Controller
    {

        public IPropertyPictureRepository _repository;
        private ILogger<PropertyPictureController> _logger;

        public PropertyPictureController(IPropertyPictureRepository repository, ILogger<PropertyPictureController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<PropertyPicture> search(int propertyId = 0)
        {
            return _repository.search(propertyId);
        }

        //[HttpGet]
        //public IActionResult search(int propertyId = 0)
        //{
        //    var items = _repository.search(propertyId);
        //    return new ObjectResult(items);
        //}

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] IEnumerable<PropertyPicture> items)
        {
            if (items == null || items?.Count() == 0)
            {
                return BadRequest();
            }

            _repository.add(items);

            return new NoContentResult();
        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] PropertyPicture item)
        {
            if (item == null || item.pictureId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();
        }

        [HttpPost("delivery/{propertyId}")]
        public IActionResult delivery(int propertyId, string email)
        {
            var item = _repository.search(propertyId);
            if (item == null)
            {
                return NotFound();
            }

            try
            {
                var m = new MailAddress(email);
            }
            catch (FormatException)
            {
                return BadRequest();
            }

            _repository.delivery(propertyId, email);

            return new OkResult();

        }
    }
}

```
## PropertyReimbursementController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/property/reimbursement")]
    public class PropertyReimbursementController : Controller
    {
        public IPropertyReimbursementRepository _repository;
        private ILogger<PropertyReimbursementController> _logger;

        public PropertyReimbursementController(IPropertyReimbursementRepository repository, ILogger<PropertyReimbursementController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<PropertyReimbursement> search(int propertyId = 0, bool applyTaxes = false, decimal? taxCollected = null)
        {
            return _repository.search(propertyId, applyTaxes, taxCollected);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] PropertyReimbursement item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] PropertyReimbursement item)
        {
            if (item == null || item.propertyReimbursementId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }

    }
}

```
## PropertyRemarkController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/property/remark")]
    public class PropertyRemarkController : Controller
    {
        public IPropertyRemarkRepository _repository;
        private ILogger<PropertyRemarkController> _logger;

        public PropertyRemarkController(IPropertyRemarkRepository repository, ILogger<PropertyRemarkController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<PropertyRemark> search(int propertyId = 0)
        {
            return _repository.search(propertyId);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] PropertyRemark item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] PropertyRemark item)
        {
            if (item == null || item.propertyRemarkId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }

    }
}

```
## PropertyReportController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Core.Model_Report;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using System.Data;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class PropertyReportController : Controller
    {

        public IPropertyReportRepository _repository;
        private ILogger<PropertyReportController> _logger;

        public PropertyReportController(IPropertyReportRepository repository, ILogger<PropertyReportController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<PropertyReport> search(string propertyId = "", int officeID = 0, int companyID = 0,
                                                    string showBasicInfo ="0", string showAgentNetList = "0",
                                                    string showAgentNetSell = "0", string showSellerInfo = "0", string showBuyerInfo = "0", string showPeople= "0",
                                                    string showFeatures = "0", string showRemarks = "0", string showRooms = "0",
                                                    string showMedia = "0", string showOpenHouses = "0", string showShowings = "0",
                                                    string showTasks = "0", string showDocuments = "0",
                                                    string show3rdPartyPayments = "0", string showReimbs = "0", string showReferrals = "0",
                                                    string showExtravouchers = "0", string showOverrides = "0", string showAccounting = "0", string showFinancing = "0", 
                                                    string showDeleted = "0",string statusToShow="", int dateType=1, string dateStart = "", string dateEnd = "",
                                                    string providerType = "", string personProviderType = "",
                                                    int pageIndex=0, int pageSize=100,
                                                    string showCustomFields = "0", string listOffice = "", string sellOffice = "", string listAgent = "", string sellAgent = "", 
                                                    string sellerSendSurveyDelivery = "", string buyerSendSurveyDelivery = "", int agentOfficeID = 0, 
                                                    int agentID = 0)
        {
            return _repository.search(
                propertyId,
                officeID,
                companyID,
                showBasicInfo,
                showAgentNetList,
                showAgentNetSell,
                showSellerInfo,
                showBuyerInfo,
                showPeople,
                showFeatures,
                showRemarks,
                showRooms,
                showMedia,
                showOpenHouses,
                showShowings,
                showTasks,
                showDocuments,
                show3rdPartyPayments,
                showReimbs,
                showReferrals,
                showExtravouchers,
                showOverrides,
                showAccounting,
                showFinancing,
                showCustomFields,
                showDeleted,
                statusToShow,
                dateType,
                dateStart,
                dateEnd,
                providerType,
                listOffice,
                sellOffice,
                listAgent,
                sellAgent,
                sellerSendSurveyDelivery,
                buyerSendSurveyDelivery,
                personProviderType,
                agentOfficeID,
                agentID,
                pageIndex,
                pageSize
                );
        }


        [HttpGet("summary")]
        public DataTable searchSummary(string dateStart, string dateEnd, int companyID = 0, int officeID = 0, int pageIndex = 0, int pageSize = 100)
        {
            return _repository.searchSummary(dateStart, dateEnd, companyID, officeID, pageIndex, pageSize);
        }

    }
}

```
## PropertyRoomController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/property/room")]
    public class PropertyRoomController : Controller
    {

        public IPropertyRoomRepository _repository;
        private ILogger<PropertyRoomController> _logger;

        public PropertyRoomController(IPropertyRoomRepository repository, ILogger<PropertyRoomController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<PropertyRoom> search(int propertyId = 0)
        {
            return _repository.search(propertyId);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] PropertyRoom item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] PropertyRoom item)
        {
            if (item == null || item.propertyRoomId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }
    }
}

```
## PropertyShowingController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/property/showing")]
    public class PropertyShowingController : Controller
    {
        public IPropertyShowingRepository _repository;
        private ILogger<PropertyShowingController> _logger;

        public PropertyShowingController(IPropertyShowingRepository repository, ILogger<PropertyShowingController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<PropertyShowing> search(int propertyId = 0)
        {
            return _repository.search(propertyId);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] PropertyShowing item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] PropertyShowing item)
        {
            if (item == null || item.propertyShowingId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }
    }
}

```
## PropertyShowingFeedbackController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/property/showing/feedback")]
    public class PropertyShowingFeedbackController : Controller
    {
        public IPropertyShowingFeedbackRepository _repository;
        private ILogger<PropertyShowingFeedbackController> _logger;

        public PropertyShowingFeedbackController(IPropertyShowingFeedbackRepository repository, ILogger<PropertyShowingFeedbackController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<PropertyShowingFeedback> search(int propertyShowingId = 0)
        {
            return _repository.search(propertyShowingId);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] PropertyShowingFeedback item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] PropertyShowingFeedback item)
        {
            if (item == null || item.feedbackId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }
    }
}

```
## PropertySyndicationOptOutController.cs
```cs
using System;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using System.Collections.Generic;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/property/syndication-opt-out")]
    public class PropertySyndicationOptOutController : Controller
    {

        public IPropertySyndicationOptOutRepository _repository;
        private ILogger<PropertySyndicationOptOutController> _logger;

        public PropertySyndicationOptOutController(IPropertySyndicationOptOutRepository repository, ILogger<PropertySyndicationOptOutController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<PropertySyndicationOptOut> search(int propertyID = 0)
        {
            return _repository.search(propertyID);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] PropertySyndicationOptOut item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] PropertySyndicationOptOut item)
        {
            if (item == null || item.propertySyndicationID != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }
    }
}

```
## PropertyThirdPartyPaymentController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/property/thirdpartypayment")]
    public class PropertyThirdPartyPaymentController : Controller
    {
        public IPropertyThirdPartyPaymentRepository _repository;
        private ILogger<PropertyThirdPartyPaymentController> _logger;

        public PropertyThirdPartyPaymentController(IPropertyThirdPartyPaymentRepository repository, ILogger<PropertyThirdPartyPaymentController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<PropertyThirdPartyPayment> search(int propertyDeductionId = 0, bool applyTaxes = false, decimal? taxCollected = null)
        {
            return _repository.search(propertyDeductionId, applyTaxes, taxCollected);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] PropertyThirdPartyPayment item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] PropertyThirdPartyPayment item)
        {
            if (item == null || item.thirdPartyPaymentId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }
    }
}

```
## PropertyTimelineTaskController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/property/timelinetask")]
    public class PropertyTimelineTaskController : Controller
    {

        public IPropertyTimelineTaskRepository _repository;
        private ILogger<PropertyTimelineTaskController> _logger;

        public PropertyTimelineTaskController(IPropertyTimelineTaskRepository repository, ILogger<PropertyTimelineTaskController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<PropertyTimelineTask> search(int propertyId = 0)
        {
            return _repository.search(propertyId);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] PropertyTimelineTask item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPost("notify/{propertyId}/{side}")]
        public IActionResult notify(int propertyId, string side)
        {
            side = side.ToUpper();

            if (!(side == "S" || side == "L"))
            {
                return BadRequest();
            }

            _repository.notify(propertyId, side);

            return new NoContentResult();
        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] PropertyTimelineTask item)
        {
            if (item == null || item.propertyTimelineTaskId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }

    }
}

```
## PropertyTimelineTaskManualController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/property/timelinetask/manual")]
    public class PropertyTimelineTaskManualController : Controller
    {

        public IPropertyTimelineTaskManualRepository _repository;
        private ILogger<PropertyTimelineTaskManualController> _logger;

        public PropertyTimelineTaskManualController(IPropertyTimelineTaskManualRepository repository, ILogger<PropertyTimelineTaskManualController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] PropertyTimelineTask item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] PropertyTimelineTask item)
        {
            if (item == null || item.propertyTimelineTaskId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }

    }
}

```
## PropertyTotalController.cs
```cs
using System.Collections.Generic;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/property/total")]
    public class PropertyTotalController : Controller
    {

        public IPropertyTotalRepository _repository;

        private ILogger<PropertyTotalController> _logger;

        public PropertyTotalController(IPropertyTotalRepository repository, ILogger<PropertyTotalController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<PropertyTotal> search(int propertyID)
        {
            return _repository.search(propertyID);
        }

        [HttpGet("updatelog")]
        public IEnumerable<PropertyTotal> searchUpdateLog(int propertyID, string processedDate)
        {
            return _repository.searchUpdateLog(propertyID, processedDate);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }     

        [HttpPost]
        public IActionResult add([FromBody] PropertyTotal item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);
        }

        [HttpPut("updateall")]
        public IEnumerable<PropertyTotal> updateAll(int propertyId, string processedDate, string actionType)
        {
            return _repository.updateAll(propertyId, processedDate, actionType);
        }

        [HttpDelete]
        public IActionResult delete(int propertyID, int totalID)
        {
            _repository.delete(propertyID, totalID);

            return new NoContentResult();

        }
    }
}

```
## PropertyTourController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/property/tour")]
    public class PropertyTourController : Controller
    {

        public IPropertyTourRepository _repository;
        private ILogger<PropertyTourController> _logger;

        public PropertyTourController(IPropertyTourRepository repository, ILogger<PropertyTourController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<PropertyTour> search(int propertyId = 0)
        {
            return _repository.search(propertyId);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] PropertyTour items)
        {
            if (items == null)
            {
                return BadRequest();
            }

            _repository.add(items);

            return new NoContentResult();
        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] PropertyTour item)
        {
            if (item == null || item.tourID != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();
        }
    }
}

```
## QuickbookController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class QuickbookController : Controller
    {
        public IQuickbookRepository _repository;
        private ILogger<QuickbookController> _logger;

        public QuickbookController(IQuickbookRepository repository, ILogger<QuickbookController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet("{date}")]
        public IEnumerable<Quickbook> search(DateTime date)
        {
            return _repository.search(date,0);
        }

        [HttpGet]
        public IEnumerable<Quickbook> search(DateTime date, int companyId = 0)
        {
            return _repository.search(date, companyId);
        }

    }
}

```
## RealogyServiceController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using System.Text;
using System.Net.Http;
using Microsoft.AspNetCore.Mvc;
using System.ServiceModel;
using AT.AT2017.Api.Util;
using Microsoft.Extensions.Options;
using System.ServiceModel.Security;
using Microsoft.AspNetCore.Hosting;
using AT.AT2017.Api.Core.Submission;
using Microsoft.Extensions.Logging;

namespace AT.AT2017.Api.Controllers
{

    [Route("api/[controller]")]
    public class RealogyServiceController : Controller
    {
        private bool _isHttps;
        private string _serviceURL;
        private IHostingEnvironment _env;
        private ILogger<InvoiceController> _logger;

        public RealogyServiceController(IOptions<ApplicationSettings> appSettings, IHostingEnvironment env, ILogger<InvoiceController> logger)
        {
            _env = env;
            _logger = logger;
            _serviceURL = appSettings.Value.SubmissionServiceURL;
            _isHttps = _serviceURL.StartsWith("https://") ? true : false;
        }

        [HttpPost("batchsubmission")]
        public int sendSubmissionBatch([FromBody] BatchEntities entities, string api, string corporateName, string entityType = "All", bool autoFix = false, bool validateBeforeFix = false, bool initSubmission = false, int migrationLog = 0)
        {
            ChannelFactory<IRealogy> factory = null;
            try
            {
                IRealogy channel = getChannel(factory);
                int submitID = channel.sendSubmissionBatch(api, corporateName, entityType, entities.officeIDs, entities.propIDs, entities.personIDs, autoFix, validateBeforeFix, initSubmission, migrationLog);
                return submitID;
                
            }
            catch (Exception)
            {
                if (factory != null)
                    factory.Abort();
                return 0;
            }
        }

        [HttpGet("realtimesubmission")]
        public int sendSubmissionRealtime(string corporateName, string entityType, int entityID, int migrationLog = 0)
        {
            ChannelFactory<IRealogy> factory = null;
            try
            {
                IRealogy channel = getChannel(factory);
                return channel.sendSubmissionRealtime(corporateName, entityType, entityID, migrationLog = 0);
                
            }
            catch (CommunicationException ex)
            {
                _logger.LogError(ex.Message);
                if (factory != null)
                    factory.Abort();
                return -1;
            }
            catch (TimeoutException ex)
            {
                _logger.LogError(ex.Message);
                if (factory != null)
                    factory.Abort();
                return -2;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex.Message);
                if (factory != null)
                    factory.Abort();
                return 0;
            }
        }

        [HttpGet("getresult")]
        public bool getResult(string api, int submitID, string corporateName, string enviroment, string source, bool realtime)
        {
            ChannelFactory<IRealogy> factory = null;
            
            try
            {
                IRealogy channel = getChannel(factory);
                return channel.getResult(api, submitID, corporateName, enviroment, source, realtime);
            }
            catch (Exception ex)
            {
                if (factory != null)
                    factory.Abort();
                throw ex;
            }
        }

        private IRealogy getChannel(ChannelFactory<IRealogy> factory)
        {
            //_logger.LogInformation("SubmissionServiceURL: " + _serviceURL);

            if (_isHttps)
            {
                // Https
                BasicHttpsBinding binding = (BasicHttpsBinding)(new BasicHttpsBinding(BasicHttpsSecurityMode.Transport));

                binding.Security.Transport.ClientCredentialType = HttpClientCredentialType.None;
                EndpointAddress address = new EndpointAddress(_serviceURL);

                binding.CloseTimeout = TimeSpan.FromDays(1);
                binding.ReceiveTimeout = TimeSpan.FromDays(1);
                binding.OpenTimeout = TimeSpan.FromDays(1);
                binding.SendTimeout = TimeSpan.FromDays(1);

                factory = new ChannelFactory<IRealogy>(binding, address);

                factory.Credentials.ServiceCertificate.SslCertificateAuthentication = new X509ServiceCertificateAuthentication();
                factory.Credentials.ServiceCertificate.SslCertificateAuthentication.CertificateValidationMode = X509CertificateValidationMode.None;

            }
            else
            {
                // Http
                BasicHttpBinding binding = new BasicHttpBinding();

                binding.Security.Transport.ClientCredentialType = HttpClientCredentialType.None;
                EndpointAddress address = new EndpointAddress(_serviceURL);

                binding.CloseTimeout = TimeSpan.FromDays(1);
                binding.ReceiveTimeout = TimeSpan.FromDays(1);
                binding.OpenTimeout = TimeSpan.FromDays(1);
                binding.SendTimeout = TimeSpan.FromDays(1);

                factory = new ChannelFactory<IRealogy>(binding, address);


            }

            return factory.CreateChannel();
            
        }

    }
    
}

```
## ReconciliationFireController.cs
```cs
using System.Collections.Generic;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using System.IO;
using System;
using AT.AT2017.Api.Util;
using System.Net.Http;
using System.Threading.Tasks;
using System.Linq;
using Newtonsoft.Json;
using Newtonsoft.Json.Linq;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class ReconciliationFireController : Controller
    {
        public IReconciliationFireRepository _repository;
        public IGlobalSettingRepository _globalSettingRepository;
        private ILogger<ReconciliationFireController> _logger;
        private IHttpContextAccessor _context;

        public ReconciliationFireController(IReconciliationFireRepository repository, IGlobalSettingRepository globalSettingRepository, ILogger<ReconciliationFireController> logger, IHttpContextAccessor httpContextAccessor)
        {
            _repository = repository;
            _globalSettingRepository = globalSettingRepository;
            _logger = logger;
            _context = httpContextAccessor;
        }

        [HttpGet]
        public IEnumerable<ReconciliationFire> search(int reconciliationId = 0, int year = 0, int companyId = 0)
        {
            return _repository.search(reconciliationId, year, companyId);
        }

        [HttpGet("source")]
        public IEnumerable<ReconciliationFireSource> searchSource(string fileType)
        {
            return _repository.searchSource(fileType);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            ReconciliationFire item = _repository.get(id, onlyHeader: true);

            if (item.generated == false)
            {
                _repository.rebuild(id);
            }

            item = _repository.get(id);

            return new ObjectResult(item);
        }
        
        [HttpPost]
        public IActionResult add(string fileType, int reconciliationId, int reconciliationFireParentID, string formatType, string description, bool isForRental, string contactName, string contactEmail, string contactPhone)
        {
            int id = _repository.add(fileType, reconciliationId, reconciliationFireParentID, formatType, description, isForRental, contactName, contactEmail, contactPhone);

            ReconciliationFire item = _repository.get(id);

            return new ObjectResult(item);

        }
        
        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] ReconciliationFire item)
        {
            if (item == null || item.reconciliationFireId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id, onlyHeader: true);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpPut("{id}/donotupload")]
        public IActionResult updateDoNotUpload(int id, bool doNotUpload)
        {
            _repository.updateDoNotUpload(id, doNotUpload);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id, onlyHeader: true);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }

        [HttpPut("{id}/generate")]
        public async Task<IActionResult> generateAsync(int id, [FromBody] ReconciliationFire item)
        {
            DateTime generatedDate = DateTime.Now;

            string corporateName = _context.HttpContext.User.FindFirst("corporateName").Value;
            string userName = _context.HttpContext.User.FindFirst("userName").Value;
            string sigBase64 = "data:image/png;base64," + Convert.ToBase64String(item.signature);
            List<ReconciliationFireDetail> detail = item.detail.ToList();

            HttpClient client = new HttpClient();
            Dictionary<string, string> values = new Dictionary<string, string>();
            values.Add("receiptID", generatedDate.ToString("yyyyMMddHHmmss"));
            values.Add("company", item.companyName);
            values.Add("generatedBy", userName);
            values.Add("generatedDate", generatedDate.ToShortDateString());
            values.Add("generatedTime", generatedDate.ToShortTimeString());
            values.Add("format1099", item.formatType.Replace(" ", ""));
            values.Add("numberOfRecords", detail.Count.ToString());
            values.Add("fireFileID", item.reconciliationFireId.ToString());
            values.Add("pdfPath", "1DarwinMain/Darwin/" + corporateName  + "/Submission/IRS");
            values.Add("signature64", sigBase64);

            // get gapps url from global setting
            string gappsUrl = "";
            List<GlobalSetting> settings = _globalSettingRepository.search("IRS_FIRE_CONSTANCE_GAPPS_URL").ToList();
            if (settings.Count > 0)
            {
                GlobalSetting gappsSetting = settings[0];
                gappsUrl = gappsSetting.value;
            }
            else
            {
                throw new Exception("Gapps URL not found in global settings");
            }

            FormUrlEncodedContent content = new FormUrlEncodedContent(values);

            HttpResponseMessage gappsResponse = await client.PostAsync(gappsUrl, content);
            string jsonString = await gappsResponse.Content.ReadAsStringAsync();

            var json = JObject.Parse(jsonString);

            // update constance url
            item.constanceUrl = json["url"].ToString();
            item.generatedDate = DateTime.Now;
            item.generatedBy = userName;

            item = _repository.generate(item);

            return new ObjectResult(item);
        }

        [HttpPut("{id}/send")]
        public IActionResult send(int id, string emailAddress, string basePath, string gappsUrl)
        {
            // get reconciliation fire header
            ReconciliationFire item = _repository.get(id, onlyHeader: true);

            if (item.generated == false || string.IsNullOrEmpty(item.fileContent))
            {
                throw new Exception("This reconciliation fire is not generated yet or file content is empty");
            }

            if (string.IsNullOrEmpty(emailAddress))
            {
                throw new Exception("The email address is required");
            }
            
            // upload file if remoteUrl is null or empty
            string remoteUrl = item.remoteUrl;
            if (string.IsNullOrEmpty(item.remoteUrl))
            {
                remoteUrl = this.uploadToGoogleDrive(item.fileContent, basePath, gappsUrl);
            }

            // save and send email
            _repository.send(id, emailAddress, remoteUrl);

            // get reconciliation fire header
            item = _repository.get(id, onlyHeader: true);

            // return fire
            return new ObjectResult(item);
        }

        private string uploadToGoogleDrive(string fileContent, string basePath, string gappsUrl)
        {
            // local folder to save the file
            string corporateName = _context.HttpContext.User.FindFirst("corporateName").Value;
            string companyPath = Path.Combine(basePath, corporateName, "IRS");

            // create folder if not exists
            if (!Directory.Exists(companyPath))
            {
                Directory.CreateDirectory(companyPath);
            }

            // set filename
            string txtFilename = "IRSFIRE_Export_" + DateTime.Now.ToString("yyyyMMdd_HHmmss") + ".txt";

            // create physical file
            string filePath = Path.Combine(companyPath, txtFilename);
            System.IO.File.Create(filePath).Dispose();
            System.IO.File.AppendAllText(filePath, fileContent);

            // get bytes
            byte[] txtBytes = null;

            FileStream fs = new FileStream(filePath,
                                           FileMode.Open,
                                           FileAccess.Read);
            BinaryReader br = new BinaryReader(fs);
            long numBytes = new FileInfo(filePath).Length;
            txtBytes = br.ReadBytes((int)numBytes);

            // upload files to google drive and get urls
            string driveFolderPath = "DARWIN/" + corporateName + "/Submission/IRS";
            string txtURL = GoogleDrive.upload(driveFolderPath, txtFilename, "text/plain", gappsUrl, txtBytes);

            return txtURL;
        }

        [HttpPut("{id}/uploaded")]
        public IActionResult uploaded(int id, DateTime uploadedDate, string uploadedBy)
        {
            _repository.uploaded(id, uploadedDate, uploadedBy);

            return new NoContentResult();
        }

        [HttpGet("{id}/validate")]
        public IEnumerable<ReconciliationFireError> validate(int id)
        {
            return _repository.validate(id);
        }

    }
}


```
## ReconciliationMergeFieldController.cs
```cs
using System.Collections.Generic;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class ReconciliationMergeFieldController : Controller
    {
        public IReconciliationMergeFieldRepository _repository;
        private ILogger<ReconciliationMergeFieldController> _logger;

        public ReconciliationMergeFieldController(IReconciliationMergeFieldRepository repository, ILogger<ReconciliationMergeFieldController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<ReconciliationMergeField> search()
        {
            return _repository.search();
        }

    }
}

```
## ReconciliationTemplateController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class ReconciliationTemplateController : Controller
    {
        public IReconciliationTemplateRepository _repository;
        private ILogger<ReconciliationTemplateController> _logger;

        public ReconciliationTemplateController(IReconciliationTemplateRepository repository, ILogger<ReconciliationTemplateController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<ReconciliationTemplate> search(string name = "")
        {
            return _repository.search(name);
        }

        [HttpGet("frommaster")]
        public IEnumerable<ReconciliationTemplate> searchFromMaster()
        {
            return _repository.searchFromMaster();
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpGet("{id}/frommaster")]
        public IActionResult getFromMaster(int id)
        {
            var item = _repository.getFromMaster(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPut("{id}/exporttomaster")]
        public IActionResult exportToMaster(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.exportToMaster(id);

            return new NoContentResult();
        }

        [HttpPost]
        public IActionResult add([FromBody] ReconciliationTemplate item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] ReconciliationTemplate item)
        {
            if (item == null || item.templateId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }

    }
}

```
## ReconciliationWriterController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;
using Newtonsoft.Json;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class ReconciliationWriterController : Controller
    {
        public IReconciliationWriterRepository _repository;
        private ILogger<ReconciliationWriterController> _logger;

        public ReconciliationWriterController(IReconciliationWriterRepository repository, ILogger<ReconciliationWriterController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpPost]
        public IEnumerable<ReconciliationWriter> search([FromBody] object personIdContent, int companyId = 0, int reconciliationId = 0, int year = 0, int recordsByPage=2, bool repeatByPage=false)
        {
            string personId = "";
            if (personIdContent != null)
            {
                dynamic personIdJson = JsonConvert.DeserializeObject(personIdContent.ToString());
                personId = personIdJson.csv;
            }
            return _repository.search(companyId, reconciliationId, year, personId, recordsByPage, repeatByPage);
        }
    }
}

```
## RecurringController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Classes;
using AT.AT2017.Api.Validation;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class RecurringController : Controller
    {

        public IRecurringRepository _repository;
        private ILogger<RecurringController> _logger;

        public RecurringController(IRecurringRepository repository, ILogger<RecurringController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<Recurring> search(string docType = "", string recurringType = "", int recurringPayableGroupId=0)
        {
            return _repository.search(docType ,recurringType, recurringPayableGroupId);
        }


        [HttpDelete]
        public void delete(string docType, int entityID)
        {
            _repository.delete(docType, entityID);
        }

        [HttpPost]
        public int add([FromBody] Recurring item)
        {
           int id=0;

            switch (item.type)
            {
                case "VOUCHER":
                     id = _repository.addVoucher(item);
                    break;
                case "INVOICE":
                    id = _repository.addInvoice(item);
                    break;
                case "JOURNAL":
                    id = _repository.addJournal(item);
                    break;
            }

            return id;
        }

    }
}

```
## RegionController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class RegionController : Controller
    {
        public IRegionRepository _repository;
        private ILogger<RegionController> _logger;

        public RegionController(IRegionRepository repository, ILogger<RegionController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<Region> search()
        {
            return _repository.search();
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] Region item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] Region item)
        {
            if (item == null || item.regionId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }
    }
}

```
## RegionOfficeController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/region/office")]
    public class RegionOfficeController : Controller
    {
        public IRegionOfficeRepository _repository;
        private ILogger<RegionOfficeController> _logger;

        public RegionOfficeController(IRegionOfficeRepository repository, ILogger<RegionOfficeController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<RegionOffice> search(int regionId)
        {
            return _repository.search(regionId);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] RegionOffice item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }
        
        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }
    }
}

```
## ReimbursementController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Classes;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class ReimbursementController : Controller
    {

        public IReimbursementRepository _repository;

        private ILogger<ReimbursementController> _logger;

        public ReimbursementController(IReimbursementRepository repository, ILogger<ReimbursementController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<Reimbursement> search(int personId = 0, string reimb = "")
        {
            return _repository.search(personId, reimb);
        }

        [HttpGet("paginated")]
        public IActionResult searchPaginated(int personId = 0, string reimb = "", string includeColumns = null, string ignoreColumns = null, int pageIndex = 1, int pageSize = 50)
        {
            var reimbursements = _repository.searchPaginated(personId, reimb, pageIndex, pageSize);

            return new CustomPagedResult<Reimbursement>(reimbursements, includeColumns?.Split(","), ignoreColumns?.Split(","));
        }

        [HttpPut]
        public IActionResult update([FromBody] IEnumerable<Reimbursement> list)
        {
            if (list == null )
            {
                return BadRequest();
            }           

            _repository.update(list);

            return new NoContentResult();
        }
    }
}

```
## RepCubeController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using AT.AT2017.Api.Core.Models;
using Microsoft.Extensions.Logging;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class RepCubeController : Controller
    {

        public IRepCubeRepository _repository;
        private ILogger<RepCubeController> _logger;

        public RepCubeController(IRepCubeRepository repository, ILogger<RepCubeController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<RepCube> search()
        {
            return _repository.search();
        }

        [HttpGet("executionlog")]
        public IEnumerable<RepCube> searchExecutionLog(string cubeName)
        {
            return _repository.searchExecutionLog(cubeName);
        }

        [HttpGet("filltable")]
        public string fillTable(string cubeList, int userID, string updateType)
        {
            return _repository.fillTable(cubeList, userID, updateType);
        }

        [HttpGet("isrunning")]
        public bool isRunning()
        {
            return _repository.isRunninng();
        }

        [HttpGet("stopexecution")]
        public void stopExecution()
        {
            _repository.stopExecution();
        }

    }
}

```
## ReplicationController.cs
```cs
using System.Collections.Generic;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/replication")]
    public class ReplicationController : Controller
    {
        public IReplicationRepository _repository;
        private ILogger<ReplicationController> _logger;

        public ReplicationController(IReplicationRepository repository, ILogger<ReplicationController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<Database> searchAllDatabases()
        {
            return _repository.searchAllDatabases();
        }

        [HttpPut("execute")]
        public IActionResult execute(string server, string database, [FromBody] ReplicationLog replicationLog)
        {
            if (string.IsNullOrEmpty(server) || string.IsNullOrEmpty(database))
            {
                return BadRequest();
            }            

            _repository.execute(server, database, replicationLog.replicationId, replicationLog.script);

            return new NoContentResult();
        }

        [HttpPost("addLog")]
        public int addLog([FromBody] ReplicationLog log)
        {
            int id = _repository.addLog(log.script);
            return id;
        }
    }

}

```
## ReportController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;
using Newtonsoft.Json;
using System.IO;
using OfficeOpenXml;
using System.Text;
using System.Net;
using System.Data;
using OfficeOpenXml.Style;
using System.Drawing;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class ReportController : Controller
    {
        public IReportRepository _repository;
        private ILogger<ReportController> _logger;

        public IDashboardUserDetailRepository _dashboardUserDetailRepository;
        public IDashboardColumnsRepository _dashboardColumnsRepository;
        public IPropertyByAgentCubeRepository _propertyByAgentCubeRepository;

        public ReportController(IReportRepository repository, ILogger<ReportController> logger, IDashboardUserDetailRepository dashboardUserDetailRepository, IDashboardColumnsRepository dashboardColumnsRepository, IPropertyByAgentCubeRepository propertyByAgentCubeRepository)
        {
            _repository = repository;
            _logger = logger;
            _dashboardUserDetailRepository = dashboardUserDetailRepository;
            _dashboardColumnsRepository = dashboardColumnsRepository;
            _propertyByAgentCubeRepository = propertyByAgentCubeRepository;
        }

        [HttpGet]
        public IEnumerable<Report> search(int userId, string masterKeyName="")
        {
            return _repository.search(userId, masterKeyName);
        }

        [HttpGet("notinpackage")]
        public IEnumerable<Report> searchNotInPackage(int userId)
        {
            return _repository.searchNotInPackage(userId);
        }

        [HttpGet("bygroup")]
        public IEnumerable<Report> searchByGroup(string group)
        {
            return _repository.searchByGroup(group);
        }

        [HttpGet("fromurl")]
        public Report searchurl(string url)
        {
            return _repository.search(url);
        }

        [HttpGet("master")]
        public IEnumerable<Report> searchFromMaster()
        {
            return _repository.searchFromMaster();
        }

        [HttpGet("columns")]
        public IEnumerable<ReportColumn> searchColumns()
        {
            return _repository.searchColumns();
        }

        [HttpGet("columns/{id}/standar")]
        public IEnumerable<ReportColumn> searchStandarColumns(int id)
        {
            return _repository.searchStandarColumns(id);
        }

        [HttpGet("{id}/{type?}")]
        public IActionResult get(int id, string type)
        {
            var item = _repository.get(id, type == "raw");
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpGet("campaignReport")]
        public IActionResult getCampaignReport(int id, int campaignReportId)
        {
            var item = _repository.getCampaignReport( id,  campaignReportId);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpGet("{id}/master")]
        public IActionResult getFromMaster(int id, string type)
        {
            var item = _repository.getFromMaster(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] Report item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id, true);
            return new ObjectResult(item);

        }

        [HttpPost("custom")]
        public IActionResult addCustom([FromBody] ReportCustom item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int value = _repository.addCustom(item);

            //var newItem = _repository.get(value, false);
            //return new ObjectResult(newItem);

            return new ObjectResult(value);
        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] Report item)
        {
            if (item == null || item.reportId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id, true);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpPut("{id}/export")]
        public IActionResult exportToMaster(int id)
        {
            var item = _repository.get(id, true);
            if (item == null)
            {
                return NotFound();
            }

            _repository.exportToMaster(id);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id, true);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }

        [HttpPut("sendByEmail")]
        public IActionResult sendByEmail(int id, int userID, string email, string parameters, bool byExcel, string reportLink, string subject = "")
        {
           _repository.sendByEmail(id,userID,email,parameters, byExcel, reportLink, subject);
            return new NoContentResult();
        }

        [HttpPut("sendExcelRealLiving")]
        public IActionResult SendExcelRealLiving(int id, string monthYear, int userID, string parameters, string companyName, string title, string email, string gappsURL)
        {
            int processed = 0;

            //-------------------------------------------get RPT_RealLiving
            System.Data.DataTable propertyByAgent = _propertyByAgentCubeRepository.getRealLivingClosingsPrior (monthYear);

            DataTable dt = new DataTable();

            DataColumn col1 = new DataColumn("id");
            col1.DataType = System.Type.GetType("System.Int32");  
            dt.Columns.Add(col1);

            DataColumn col2 = new DataColumn("office");
            col2.DataType = System.Type.GetType("System.String");
            dt.Columns.Add(col2);

            DataColumn col3 = new DataColumn("classification");
            col3.DataType = System.Type.GetType("System.String");
            dt.Columns.Add(col3);

            DataColumn col4 = new DataColumn("propertyAddress");
            col4.DataType = System.Type.GetType("System.String");
            dt.Columns.Add(col4);

            DataColumn col5 = new DataColumn("TRType");
            col5.DataType = System.Type.GetType("System.String");
            dt.Columns.Add(col5);

            DataColumn col6 = new DataColumn("closingDate");
            col6.DataType = System.Type.GetType("System.DateTime");
            dt.Columns.Add(col6);

            DataColumn col7 = new DataColumn("transactionCount");
            col7.DataType = System.Type.GetType("System.Int32");
            dt.Columns.Add(col7);

            DataColumn col8 = new DataColumn("sellingPrice");
            col8.DataType = System.Type.GetType("System.Decimal");
            dt.Columns.Add(col8);

            DataColumn col9 = new DataColumn("sideCount");
            col9.DataType = System.Type.GetType("System.Int32");
            dt.Columns.Add(col9);

            DataColumn col10 = new DataColumn("sideVolume");
            col10.DataType = System.Type.GetType("System.Decimal");
            dt.Columns.Add(col10);

            DataColumn col11 = new DataColumn("netGCI");
            col11.DataType = System.Type.GetType("System.Decimal");
            dt.Columns.Add(col11);

            for (int i = 0; i < propertyByAgent.Rows.Count; i++)
            {
                DataRow rowA = dt.NewRow();

                rowA["id"] = propertyByAgent.Rows[i]["id"];
                rowA["office"] = propertyByAgent.Rows[i]["office"];
                rowA["classification"] = propertyByAgent.Rows[i]["classification"];
                rowA["propertyAddress"] = propertyByAgent.Rows[i]["propertyAddress"];
                rowA["TRType"] = propertyByAgent.Rows[i]["TRType"];
                rowA["closingDate"] = propertyByAgent.Rows[i]["closingDate"];
                rowA["transactionCount"] = propertyByAgent.Rows[i]["transactionCount"];
                rowA["sellingPrice"] = propertyByAgent.Rows[i]["sellingPrice"];
                rowA["sideCount"] = propertyByAgent.Rows[i]["sideCount"];
                rowA["sideVolume"] = propertyByAgent.Rows[i]["sideVolume"];
                rowA["netGCI"] = propertyByAgent.Rows[i]["netGCI"];
                dt.Rows.Add(rowA);
            }

            var list = dt;

            if (list.Rows.Count > 0)
            {
                //------------------------------------------create excel
                string fileName = "";
                byte[] arrFile;
                string filePath;

                processed = list.Rows.Count;

                fileName = "SC202 - Monthly Report Form Detail.xlsx";

                filePath = Path.Combine(Environment.CurrentDirectory , "Templates");
                if (!Directory.Exists(filePath))
                {
                    Directory.CreateDirectory(filePath);
                }

                string path = Path.Combine(filePath, fileName);  //string path = filePath + fileName;
                FileInfo file = new FileInfo(path);

                using (ExcelPackage package = new ExcelPackage(file))
                {

                    int initRow = 13;

                    ExcelWorksheet worksheet = package.Workbook.Worksheets[0];

                    // --------updte monthYear
                    worksheet.Cells["C5"].Value = monthYear;
                    worksheet.Cells["A1"].Value = "Real Living - Detailed List of Closings for Prior Month Report";

                    // --------updte detail
                    worksheet.Cells["A12"].LoadFromDataTable(list, true, OfficeOpenXml.Table.TableStyles.None);
                    worksheet.Row(12).Hidden = true;
                    worksheet.Cells["A12"].Clear();

                    using (ExcelRange Rng = worksheet.Cells[0 + initRow, 0 + 1, list.Rows.Count + initRow-1, list.Columns.Count])
                    {
                        //    Rng.Merge = true;
                        Rng.Style.Border.Top.Style = ExcelBorderStyle.Thin;
                        Rng.Style.Border.Top.Color.SetColor(Color.Black);
                        Rng.Style.Border.Left.Style = ExcelBorderStyle.Thin;
                        Rng.Style.Border.Left.Color.SetColor(Color.Black);
                        Rng.Style.Border.Right.Style = ExcelBorderStyle.Thin;
                        Rng.Style.Border.Right.Color.SetColor(Color.Black);
                        Rng.Style.Border.Bottom.Style = ExcelBorderStyle.Thin;
                        Rng.Style.Border.Bottom.Color.SetColor(Color.Black);
                        Rng.Style.Font.Size = 9;
                        Rng.Style.Font.Bold = false;
                    }

                    worksheet.Cells[initRow, 1, list.Rows.Count + initRow + 1, 3].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                    worksheet.Cells[initRow, 5, list.Rows.Count + initRow + 1, 6].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;

                    worksheet.Cells[initRow, 7, list.Rows.Count + initRow + 1, 7].Style.Numberformat.Format = "##0";
                    worksheet.Cells[initRow, 7, list.Rows.Count + initRow + 1, 7].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;

                    
                    worksheet.Cells[initRow, 9, list.Rows.Count + initRow + 1, 9].Style.Numberformat.Format = "##0";
                    worksheet.Cells[initRow, 9, list.Rows.Count + initRow + 1, 9].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;

                    worksheet.Cells[initRow, 8, list.Rows.Count + initRow + 1, 8].Style.Numberformat.Format = "$ #,##0.00";
                    worksheet.Cells[initRow, 10, list.Rows.Count + initRow + 1, 11].Style.Numberformat.Format = "$ #,##0.00";

                    worksheet.Cells[list.Rows.Count + initRow + 1, 1, list.Rows.Count + initRow + 1,11].Style.Font.Size = 10;
                    worksheet.Cells[list.Rows.Count + initRow + 1, 1, list.Rows.Count + initRow + 1, 11].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                    worksheet.Cells[list.Rows.Count + initRow + 1, 2].Value = "* If your company has more closings, please add additional rows. ";

                    worksheet.Cells[list.Rows.Count + initRow + 1, 6].Value = "TOTALS";
                    worksheet.Cells[list.Rows.Count + initRow + 1, 6].Style.Font.Bold = true;

                    using (ExcelRange Rng = worksheet.Cells[list.Rows.Count + initRow + 1, 6 , list.Rows.Count + initRow + 1,11])
                    {
                        //    Rng.Merge = true;
                        Rng.Style.Border.Top.Style = ExcelBorderStyle.Medium;
                        Rng.Style.Border.Top.Color.SetColor(Color.Black);
                        Rng.Style.Border.Left.Style = ExcelBorderStyle.Medium;
                        Rng.Style.Border.Left.Color.SetColor(Color.Black);
                        Rng.Style.Border.Right.Style = ExcelBorderStyle.Medium;
                        Rng.Style.Border.Right.Color.SetColor(Color.Black);
                        Rng.Style.Border.Bottom.Style = ExcelBorderStyle.Medium;
                        Rng.Style.Border.Bottom.Color.SetColor(Color.Black);
                        Rng.Style.Font.Size = 9;
                    }

                    worksheet.Cells[list.Rows.Count + initRow + 1, 7].Style.Numberformat.Format = "##0";
                    worksheet.Cells[list.Rows.Count + initRow + 1, 7].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                    worksheet.Cells[list.Rows.Count + initRow + 1, 8].Style.Numberformat.Format = "$ #,##0.00";
                    worksheet.Cells[list.Rows.Count + initRow + 1, 8].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                    worksheet.Cells[list.Rows.Count + initRow + 1, 9].Style.Numberformat.Format = "##0";
                    worksheet.Cells[list.Rows.Count + initRow + 1, 9].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                    worksheet.Cells[list.Rows.Count + initRow + 1, 10, list.Rows.Count + initRow + 1, 11].Style.Numberformat.Format = "$ #,##0.00";
                    worksheet.Cells[list.Rows.Count + initRow + 1, 10, list.Rows.Count + initRow + 1, 11].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;

                    worksheet.Cells[list.Rows.Count + initRow + 1, 7].FormulaR1C1 = "=Sum(" + worksheet.Cells[initRow, 7].Address + ":" + worksheet.Cells[(list.Rows.Count + initRow), 7].Address + ")";
                    worksheet.Cells[list.Rows.Count + initRow + 1, 9].FormulaR1C1 = "=Sum(" + worksheet.Cells[initRow, 9].Address + ":" + worksheet.Cells[(list.Rows.Count + initRow), 9].Address + ")";
                    worksheet.Cells[list.Rows.Count + initRow + 1, 8].FormulaR1C1 = "=Sum(" + worksheet.Cells[initRow, 8].Address + ":" + worksheet.Cells[(list.Rows.Count + initRow), 8].Address + ")";
                    worksheet.Cells[list.Rows.Count + initRow + 1, 10].FormulaR1C1 = "=Sum(" + worksheet.Cells[initRow, 10].Address + ":" + worksheet.Cells[(list.Rows.Count + initRow), 10].Address + ")";
                    worksheet.Cells[list.Rows.Count + initRow + 1, 11].FormulaR1C1 = "=Sum(" + worksheet.Cells[initRow, 11].Address + ":" + worksheet.Cells[(list.Rows.Count + initRow), 11].Address + ")";

                    package.Workbook.Properties.Author = "DARWIN";
                    package.Workbook.Properties.Title = "Real Living";
                    package.Workbook.Properties.Company = "ACCOUNTTECH";

                    //package.Save();
                    arrFile = package.GetAsByteArray();
                    package.Dispose();
                }

                //Shared.sendToGoogleDrive(); 
                //----------------------------------------upload gdrive            
                string strContent = "data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;base64," + System.Convert.ToBase64String(arrFile);
                string strPath = "DARWIN/" + companyName + "/RealLivingReport/";

                var postData = "content=" + System.Net.WebUtility.UrlEncode(strContent);
                postData += "&originalFileName=" + System.Net.WebUtility.UrlEncode(fileName);
                postData += "&path=" + System.Net.WebUtility.UrlEncode(strPath);
                postData += "&guidFlag=false";

                var send = Encoding.Default.GetBytes(postData);

                var req = WebRequest.Create(gappsURL);
                req.Method = "POST";
                req.ContentType = "application/x-www-form-urlencoded";
                req.ContentLength = send.Length;

                var sout = req.GetRequestStream();
                sout.Write(send, 0, send.Length);
                sout.Flush();
                sout.Close();

                var res = req.GetResponse();
                var sr = new StreamReader(res.GetResponseStream());
                var returnvalue = sr.ReadToEnd();

                Dictionary<string, string> values = JsonConvert.DeserializeObject<Dictionary<string, string>>(returnvalue);
                if (values.ContainsKey("url"))
                {
                    string urlFile = "https://drive.google.com/file/d/" + values["id"] + "/preview"; // values["url"];

                    //----------------------sendExcelByEmail
                    _repository.sendByEmail(id, userID, email, parameters, true, urlFile,"" );


                }
            }
                return new ObjectResult(processed);
        }

        [HttpPut("sendExcelRealLivingMonthly")]
        public IActionResult SendExcelRealLiving_Monthly(int id, string monthYear, int userID, string parameters, string companyName, string title, string email, string gappsURL)
        {
            //-------------------------------------------get RPT_RealLiving
            DataTable propertyCL = _propertyByAgentCubeRepository.getRealLivingMonthly(monthYear);

            var list = propertyCL;

            int countList = list.Rows.Count;

            if (countList > 0)
            {
                //------------------------------------------create excel
                string fileName = "";
                byte[] arrFile;
                string filePath;

                fileName = "MN202 Messina.xlsx";

                filePath = Path.Combine(Environment.CurrentDirectory, "Templates");
                if (!Directory.Exists(filePath))
                {
                    Directory.CreateDirectory(filePath);
                }

                string path = Path.Combine(filePath, fileName);  //string path = filePath + fileName;
                FileInfo file = new FileInfo(path);

                using (ExcelPackage package = new ExcelPackage(file))
                {

                    ExcelWorksheet worksheet = package.Workbook.Worksheets[0];

                    worksheet.Cells[4, 9].Value = title;

                    const int rowIntToCopy = 15;
                    const int rowCount = 39;

                    string sum22 = ""; string sum24 = ""; string sum26 = ""; string sum28 = ""; string sum30 = ""; string sum32 = "";
                    string sum36 = ""; string sum38 = ""; string sum40 = ""; string sum42 = ""; string sum44 = ""; string sum46 = "";
                    string sum221 = ""; string sum241 = ""; string sum261 = ""; string sum281 = ""; string sum301 = "";string sum321 = "";
                    string sum361 = ""; string sum381 = ""; string sum401 = "";string sum421 = ""; string sum441 = ""; string sum461 = "";
                    string sum222 = ""; string sum242 = ""; string sum362 = ""; string sum382 = "";string sumTotal1 = ""; string sumTotal2 = "";
                    string numAgent = ""; 



                    for (int i = 0; i < countList; i++)
                    {

                        worksheet.Cells[16,7].Value = list.Rows[i]["officeAddress"];
                        worksheet.Cells[18, 8].Value = list.Rows[i]["agentCount"];
                        worksheet.Cells[16, 15].Value = list.Rows[i]["id"];


                        worksheet.Cells[22, 10].Value = list.Rows[i]["salesTransactionsR"];
                        worksheet.Cells[24, 10].Value = list.Rows[i]["sideCountR"];
                        worksheet.Cells[26, 10].Value = list.Rows[i]["propertyManagementR"];
                        worksheet.Cells[28, 10].Value = list.Rows[i]["leaseR"];
                        worksheet.Cells[30, 10].Value = list.Rows[i]["referralR"];
                        worksheet.Cells[32, 10].Value = list.Rows[i]["otherIncomeR"];

                        worksheet.Cells[22, 12].Value = list.Rows[i]["sellingPriceR"];
                        worksheet.Cells[24, 12].Value = list.Rows[i]["sideVolumeR"];

                        worksheet.Cells[22, 14].Value = list.Rows[i]["AGCIsalesTransactionsR"];
                        worksheet.Cells[26, 14].Value = list.Rows[i]["AGCIpropertyManagementR"];
                        worksheet.Cells[28, 14].Value = list.Rows[i]["AGCIleaseR"];
                        worksheet.Cells[30, 14].Value = list.Rows[i]["AGCIreferralR"];
                        worksheet.Cells[32, 14].Value = list.Rows[i]["AGCIotherIncomeR"];

                        worksheet.Cells[36, 10].Value = list.Rows[i]["salesTransactionsC"];
                        worksheet.Cells[38, 10].Value = list.Rows[i]["sideCountC"];
                        worksheet.Cells[40, 10].Value = list.Rows[i]["propertyManagementC"];
                        worksheet.Cells[42, 10].Value = list.Rows[i]["leaseC"];
                        worksheet.Cells[44, 10].Value = list.Rows[i]["referralC"];
                        worksheet.Cells[46, 10].Value = list.Rows[i]["otherIncomeC"];

                        worksheet.Cells[36, 12].Value = list.Rows[i]["sellingPriceC"];
                        worksheet.Cells[38, 12].Value = list.Rows[i]["sideVolumeC"];

                        worksheet.Cells[36, 14].Value = list.Rows[i]["AGCIsalesTransactionsC"];
                        worksheet.Cells[40, 14].Value = list.Rows[i]["AGCIpropertyManagementC"];
                        worksheet.Cells[42, 14].Value = list.Rows[i]["AGCIleaseC"];
                        worksheet.Cells[44, 14].Value = list.Rows[i]["AGCIreferralC"];
                        worksheet.Cells[46, 14].Value = list.Rows[i]["AGCIotherIncomeC"];


                        if (countList > 1 && (i + 1) < countList)
                        {
                            int startRow = rowIntToCopy + (rowCount * (i + 1));
                            const int colCount = 15;
                            var row = 0;
                            var copyrow = 0;


                            worksheet.InsertRow(startRow, rowCount);

                            for (var x = 0; x < rowCount; x++)
                            {
                                row = startRow + x;
                                copyrow = colCount + x;

                                worksheet.Cells[String.Format("A{0}:Q{0}", copyrow)].Copy(worksheet.Cells[String.Format("A{0}:Q{0}", row)]);

                            }

                            worksheet.Cells.Worksheet.Workbook.Styles.UpdateXml();
                        }

                        // calculate sum items in summary
                        sum22 = sum22 + "+" + worksheet.Cells[22 + (rowCount * i), 10].Address;
                        sum24 = sum24 + "+" + worksheet.Cells[24 + (rowCount * i), 10].Address;
                        sum26 = sum26 + "+" + worksheet.Cells[26 + (rowCount * i), 10].Address;
                        sum28 = sum28 + "+" + worksheet.Cells[28 + (rowCount * i), 10].Address;
                        sum30 = sum30 + "+" + worksheet.Cells[30 + (rowCount * i), 10].Address;
                        sum32 = sum32 + "+" + worksheet.Cells[32 + (rowCount * i), 10].Address;

                        sum222 = sum222 + "+" + worksheet.Cells[22 + (rowCount * i), 12].Address;
                        sum242 = sum242 + "+" + worksheet.Cells[24 + (rowCount * i), 12].Address;

                        sum36 = sum36 + "+" + worksheet.Cells[36 + (rowCount * i), 10].Address;
                        sum38 = sum38 + "+" + worksheet.Cells[38 + (rowCount * i), 10].Address;
                        sum40 = sum40 + "+" + worksheet.Cells[40 + (rowCount * i), 10].Address;
                        sum42 = sum42 + "+" + worksheet.Cells[42 + (rowCount * i), 10].Address;
                        sum44 = sum44 + "+" + worksheet.Cells[44 + (rowCount * i), 10].Address;
                        sum46 = sum46 + "+" + worksheet.Cells[46 + (rowCount * i), 10].Address;

                        sum362 = sum362 + "+" + worksheet.Cells[36 + (rowCount * i), 12].Address;
                        sum382 = sum382 + "+" + worksheet.Cells[38 + (rowCount * i), 12].Address;

                        sum221 = sum221 + "+" + worksheet.Cells[22 + (rowCount * i), 14].Address;
                        sum261 = sum261 + "+" + worksheet.Cells[26 + (rowCount * i), 14].Address;
                        sum281 = sum281 + "+" + worksheet.Cells[28 + (rowCount * i), 14].Address;
                        sum301 = sum301 + "+" + worksheet.Cells[30 + (rowCount * i), 14].Address;
                        sum321 = sum321 + "+" + worksheet.Cells[32 + (rowCount * i), 14].Address;

                        sum361 = sum361 + "+" + worksheet.Cells[36 + (rowCount * i), 14].Address;
                        sum401 = sum401 + "+" + worksheet.Cells[40 + (rowCount * i), 14].Address;
                        sum421 = sum421 + "+" + worksheet.Cells[42 + (rowCount * i), 14].Address;
                        sum441 = sum441 + "+" + worksheet.Cells[44 + (rowCount * i), 14].Address;
                        sum461 = sum461 + "+" + worksheet.Cells[46 + (rowCount * i), 14].Address;

                        sumTotal1 = sumTotal1 + "+" + worksheet.Cells[48 + (rowCount * i), 14].Address;
                        sumTotal2 = sumTotal2 + "+" + worksheet.Cells[50 + (rowCount * i), 14].Address;
                        numAgent = numAgent + "+" + worksheet.Cells[18 + (rowCount * i), 8].Address;
                    }

                    var rowSum = rowIntToCopy + (rowCount * countList);

                    worksheet.Cells[rowSum + 7, 10].FormulaR1C1 = sum22;
                    worksheet.Cells[rowSum + 9, 10].FormulaR1C1 = sum24;
                    worksheet.Cells[rowSum + 11, 10].FormulaR1C1 = sum26;
                    worksheet.Cells[rowSum + 13, 10].FormulaR1C1 = sum28;
                    worksheet.Cells[rowSum + 15, 10].FormulaR1C1 = sum30;
                    worksheet.Cells[rowSum + 17, 10].FormulaR1C1 = sum32;

                    worksheet.Cells[rowSum + 7, 12].FormulaR1C1 = sum222;
                    worksheet.Cells[rowSum + 9, 12].FormulaR1C1 = sum242;

                    worksheet.Cells[rowSum + 21, 10].FormulaR1C1 = sum36;
                    worksheet.Cells[rowSum + 23, 10].FormulaR1C1 = sum38;
                    worksheet.Cells[rowSum + 25, 10].FormulaR1C1 = sum40;
                    worksheet.Cells[rowSum + 27, 10].FormulaR1C1 = sum42;
                    worksheet.Cells[rowSum + 29, 10].FormulaR1C1 = sum44;
                    worksheet.Cells[rowSum + 31, 10].FormulaR1C1 = sum46;

                    worksheet.Cells[rowSum + 21, 12].FormulaR1C1 = sum362;
                    worksheet.Cells[rowSum + 23, 12].FormulaR1C1 = sum382;

                    worksheet.Cells[rowSum + 7, 14].FormulaR1C1 = sum221;
                    worksheet.Cells[rowSum + 9, 14].FormulaR1C1 = sum241;
                    worksheet.Cells[rowSum + 11, 14].FormulaR1C1 = sum261;
                    worksheet.Cells[rowSum + 13, 14].FormulaR1C1 = sum281;
                    worksheet.Cells[rowSum + 15, 14].FormulaR1C1 = sum301;
                    worksheet.Cells[rowSum + 17, 14].FormulaR1C1 = sum321;

                    worksheet.Cells[rowSum + 21, 14].FormulaR1C1 = sum361;
                    worksheet.Cells[rowSum + 23, 14].FormulaR1C1 = sum381;
                    worksheet.Cells[rowSum + 25, 14].FormulaR1C1 = sum401;
                    worksheet.Cells[rowSum + 27, 14].FormulaR1C1 = sum421;
                    worksheet.Cells[rowSum + 29, 14].FormulaR1C1 = sum441;
                    worksheet.Cells[rowSum + 31, 14].FormulaR1C1 = sum461;

                    worksheet.Cells[rowSum + 33, 14].FormulaR1C1 = sumTotal1;
                    worksheet.Cells[rowSum + 35, 14].FormulaR1C1 = sumTotal2;
                    worksheet.Cells[rowSum + 42, 8].FormulaR1C1 = numAgent;
                    worksheet.Cells[rowSum + 40, 8].Value = countList;

                    package.Workbook.Properties.Author = "DARWIN";
                    package.Workbook.Properties.Title = "Real Living";
                    package.Workbook.Properties.Company = "ACCOUNTTECH";

                    //package.Save();
                    arrFile = package.GetAsByteArray();
                    package.Dispose();

                }

                //----------------------------------------upload gdrive            
                string strContent = "data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;base64," + System.Convert.ToBase64String(arrFile);
                string strPath = "DARWIN/" + companyName + "/RealLiving/";

                var postData = "content=" + System.Net.WebUtility.UrlEncode(strContent);
                postData += "&originalFileName=" + System.Net.WebUtility.UrlEncode(fileName);
                postData += "&path=" + System.Net.WebUtility.UrlEncode(strPath);
                postData += "&guidFlag=false";

                var send = Encoding.Default.GetBytes(postData);

                var req = WebRequest.Create(gappsURL);
                req.Method = "POST";
                req.ContentType = "application/x-www-form-urlencoded";
                req.ContentLength = send.Length;

                var sout = req.GetRequestStream();
                sout.Write(send, 0, send.Length);
                sout.Flush();
                sout.Close();

                var res = req.GetResponse();
                var sr = new StreamReader(res.GetResponseStream());
                var returnvalue = sr.ReadToEnd();

                Dictionary<string, string> values = JsonConvert.DeserializeObject<Dictionary<string, string>>(returnvalue);
                if (values.ContainsKey("url"))
                {
                    string urlFile = "https://drive.google.com/file/d/" + values["id"] + "/preview"; // values["url"];

                    //----------------------sendExcelByEmail
                    _repository.sendByEmail(id, userID, email, parameters, true, urlFile,"");

                }

            }
            return new ObjectResult(countList);
        }

        [HttpPut("sendExcelByGDrive")]
        public IActionResult sendExcelByGDrive(int id, int dashboardID, int userID, string parameters, string companyName, string title, string email, string gappsURL, string subject = "")
        {

            int processed = 0;

            //-------------------------------------------get dashboardUserDetail
            IEnumerable<DashboardUserDetail> dashboardUserDetail = _dashboardUserDetailRepository.search (dashboardID, userID);
            IEnumerable<DashboardColumns> columns = _dashboardColumnsRepository.search(dashboardID);

            var list = from x in dashboardUserDetail
                       select new {x.entityID, x.description, x.custom1, x.custom2, x.custom3, x.custom4, x.custom5, x.custom6, x.custom7, x.custom8, x.custom9};
            //--count fields = 9
            int columnList = 11;

            if (list.Count() > 0)
            {
                processed = list.Count();

                //------------------------------------------create excel
                string fileName = "";
                byte[] arrFile;

                using (ExcelPackage package = new ExcelPackage())
                {
                    ExcelWorksheet worksheet = package.Workbook.Worksheets.Add("data");

                    // --------dashboard title
                    worksheet.Cells["A1"].Value = title;
                    worksheet.Cells["A1"].Style.Font.Bold = true;
                    worksheet.Cells["A1"].Style.Font.Size = 14;

                    //--------------------dashboard detail
                    worksheet.Cells["A2"].LoadFromCollection(list, true, OfficeOpenXml.Table.TableStyles.Light1);
                    worksheet.Cells[worksheet.Dimension.Address].AutoFitColumns();
                    //worksheet.Column(1).Hidden = true; // hidden dashboardID

                    var columnsNames = new List<string[]>();
                    columnsNames.Add(columns.Select((p) => p.headerName).ToArray()); 

                    //------ update headerRow
                    string headerRange = "C2:" + Char.ConvertFromUtf32(columnsNames[0].Length + 66) + "";
                    worksheet.Cells[headerRange].LoadFromArrays(columnsNames.ToArray() );

                    //------ update bold letter headerRow
                    headerRange = "A2:" + Char.ConvertFromUtf32(columnsNames[0].Length + 66) + "2";
                    worksheet.Cells[headerRange].Style.Font.Bold = true;

                    int columnHeader = worksheet.Cells[headerRange].Columns;

                    int i = columnList;

                    while (i > columnHeader)
                    {
                        worksheet.DeleteColumn(i);
                        i -=1;
                    }

                    package.Workbook.Properties.Author = "DARWIN";
                    package.Workbook.Properties.Title = "DASHBOARD";
                    package.Workbook.Properties.Company = "ACCOUNTTECH";

                    arrFile = package.GetAsByteArray();
                    package.Dispose();
                }

                //----------------------------------------upload gdrive            
                string strContent = "data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;base64," + System.Convert.ToBase64String(arrFile);
                string strPath = "DARWIN/" + companyName + "/Dashboard/";

                var postData = "content=" + System.Net.WebUtility.UrlEncode(strContent);
                postData += "&originalFileName=" + System.Net.WebUtility.UrlEncode(fileName);
                postData += "&path=" + System.Net.WebUtility.UrlEncode(strPath);
                postData += "&guidFlag=false";

                var send = Encoding.Default.GetBytes(postData);

                var req = WebRequest.Create(gappsURL);
                req.Method = "POST";
                req.ContentType = "application/x-www-form-urlencoded";
                req.ContentLength = send.Length;

                var sout = req.GetRequestStream();
                sout.Write(send, 0, send.Length);
                sout.Flush();
                sout.Close();

                var res = req.GetResponse();
                var sr = new StreamReader(res.GetResponseStream());
                var returnvalue = sr.ReadToEnd();

                Dictionary<string, string> values = JsonConvert.DeserializeObject<Dictionary<string, string>>(returnvalue);
                if (values.ContainsKey("url"))
                {
                    string urlFile = "https://drive.google.com/file/d/" + values["id"] + "/preview"; // values["url"];

                    //----------------------sendExcelByEmail
                    _repository.sendByEmail(id, userID, email, parameters,true, urlFile,subject );

                }
            }

            return new NoContentResult();
        }

        [HttpGet("{id}/packages")]
        public IEnumerable<Package> searchPackages(int id)
        {
            return _repository.searchPackages(id);
        }

        [HttpPost("{id}/packages/{packages}")]
        public IActionResult addPachages(int id, string packages)
        {
            if (string.IsNullOrEmpty(packages))
            {
                return BadRequest();
            }

            _repository.addPachages(id, packages);

            return new ObjectResult(id);
        }
    }

}

```
## ReportDataSourceController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/report/datasource")]
    public class ReportDataSourceController : Controller
    {
        public IReportDataSourceRepository  _repository;
        private ILogger<ReportDataSourceController> _logger;

        public ReportDataSourceController(IReportDataSourceRepository repository, ILogger<ReportDataSourceController> logger)
        {
            _repository = repository;
            _logger = logger;
        }
        
        [HttpGet]
        public IEnumerable<ReportDataSource> search(string dataSource = "", int type=0, string filter = "")
        {
            return _repository.search(dataSource, type,filter);
        }

        [HttpGet("all")]
        public IEnumerable<string> all(string type = "")
        {
            return _repository.all(type);
        }
    }
}

```
## ReportFavoriteController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/report/favorite")]
    public class ReportFavoriteController : Controller
    {
        public IReportFavoriteRepository _repository;
        private ILogger<ReportFavoriteController> _logger;

        public ReportFavoriteController(IReportFavoriteRepository repository, ILogger<ReportFavoriteController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpPost]
        public IActionResult add(int id)
        {
            if (id == 0)
            {
                return BadRequest();
            }

            _repository.add(id);

            return new NoContentResult();

        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            _repository.delete(id);

            return new NoContentResult();

        }
    }
}

```
## ReportLaunchedController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Classes;
using AT.AT2017.Api.Validation;
namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class ReportLaunchedController : Controller
    {
        public IReportLaunchedRepository _repository;
        private ILogger<ReportLaunchedController> _logger;

        public ReportLaunchedController(IReportLaunchedRepository repository,  ILogger<ReportLaunchedController> logger)
        {
            _repository = repository;           
            _logger = logger;
        }

        [HttpGet("{id}")]
        public ReportLaunched get(int id)
        {
            return _repository.get(id);
        }

        [HttpPost]     
        public IActionResult add([FromBody] ReportLaunched item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            _repository.add(item);
            return new NoContentResult();
        }
    }
}

```
## RoleController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class RoleController : Controller
    {

        public IRoleRepository _repository;
        private ILogger<RoleController> _logger;

        public RoleController(IRoleRepository repository, ILogger<RoleController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<Role> search(string name = "")
        {
            return _repository.search(name);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] Role item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] Role item)
        {
            if (item == null || item.roleId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }
    }
}

```
## SecurityController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class SecurityController : Controller
    {

        public ISecurityRepository _repository;
        private ILogger<SecurityController> _logger;

        public SecurityController(ISecurityRepository repository, ILogger<SecurityController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<Security> search(int roleId = 0, int actionId = 0, int userId = 0)
        {
            return _repository.search(roleId, actionId, userId);
        }

        [HttpGet("actions")]
        public IEnumerable<MenuAction> searchActions(int userId, bool retrieveControls = false)
        {
            return _repository.searchActions(userId, retrieveControls).ToList();
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] Security item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }
    }
}

```
## ServerController.cs
```cs
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;
using System.Collections.Generic;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class ServerController : Controller
    {

        public IServerRepository _repository;
        private ILogger<ServerController> _logger;

        public ServerController(IServerRepository repository, ILogger<ServerController> logger)
        {
            _repository = repository;
            _logger = logger;
        }
        
        [HttpGet("server")]
        public IEnumerable<Server> searchServers(bool isActive = true)
        {
            return _repository.searchServers(isActive);
        }
        
    }
}

```
## SettingController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class SettingController : Controller
    {

        public ISettingRepository _repository;

        private ILogger<SettingController> _logger;

        public SettingController(ISettingRepository repository, ILogger<SettingController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<Setting> search(string name = "", string description = "", string section = "", string type = "")
        {
            return _repository.search(name, description, section, type);
        }

        [HttpGet("list")]
        public IEnumerable<Setting> searchList(string procedure = "")
        {
            return _repository.searchList(procedure);
        }

        [HttpGet("listbycompany")]
        public IEnumerable<Setting> searchListByCompany(string procedure, int companyID)
        {
            return _repository.searchListByCompany(procedure, companyID);
        }

        [HttpGet("listFields")]
        public IEnumerable<Setting> searchListFields(string tableName)
        {
            return _repository.searchListFields(tableName);
        }

        [HttpGet("listbyaction")]
        public IEnumerable<Setting> searchByAction(int actionID)
        {
            return _repository.searchByAction(actionID);
        }

        [HttpPost]
        public IActionResult add([FromBody] Setting item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);
            item = _repository.get(id);
            return new ObjectResult(item);
        }

        [HttpGet("{name}")]
        public IActionResult get(string name)
        {
            Setting item = null;
            int id;
            if (Int32.TryParse(name, out id))
            {
                item = _repository.get(id);
            }
            else
            {
                item = _repository.get(name);
            }

            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] Setting item)
        {
            if (item == null || item.settingId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpGet("wccheckdetailcolumns")]
        public IEnumerable<SettingWCCheckDetail> searchWCCheckDetailColumns(int id)
        {
            return _repository.searchWCCheckDetailColumns(id);
        }

        [HttpGet("wccheckdetailfields")]
        public IEnumerable<Setting> searchWCCheckDetailFields(int id)
        {
            return _repository.searchWCCheckDetailFields(id);
        }
    }
}

```
## StoreOrderController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;
using System.Net.Mail;
using AT.AT2017.Api.Core.Shared;
using AT.AT2017.Api.Classes;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class StoreOrderController : Controller
    {

        public IStoreOrderRepository _repository;
        private ILogger<StoreOrderController> _logger;

        public IArPaymentRepository _arPaymentRepository;
        public IGlobalSettingRepository _globalSettingRepository;
        public IGLAccountRepository _glAccountRepository;
        public IPersonMerchantRepository _personMerchantRepository;
        public ICompanyRepository _companyRepository;
        public IFortePaymentLogRepository _forteLogRepository;
        public ISettingRepository _settingRepository;
        public IPersonRepository _personRepository;
        public IInvoiceRepository _invoiceRepository;

        public StoreOrderController(IStoreOrderRepository repository, IArPaymentRepository arPaymentRepository, IGlobalSettingRepository globalSettingRepository, IGLAccountRepository glAccountRepository, ISettingRepository settingRepository, IPersonRepository personRepository, IPersonMerchantRepository personMerchantRepository, ICompanyRepository companyRepository, IFortePaymentLogRepository forteLogRepository, IInvoiceRepository invoiceRepository,ILogger<StoreOrderController> logger)
        {
            _repository = repository;
            _logger = logger;

            _arPaymentRepository = arPaymentRepository;
            _globalSettingRepository = globalSettingRepository;
            _glAccountRepository = glAccountRepository;
            _personMerchantRepository = personMerchantRepository;
            _companyRepository = companyRepository;
            _forteLogRepository = forteLogRepository;
            _settingRepository = settingRepository;
            _personRepository = personRepository;
            _invoiceRepository = invoiceRepository;
        }
        
        [HttpGet]
        public PagedList<StoreOrderSearchResult> search(int orderId, int invoiceId, int inventoryId, int companyId, int personId, 
            int propertyId, string descriptiveText, string fromDate, string toDate, bool? filled, decimal? saleTotal, bool? paid, int pageIndex, int pageSize, string item)
        {
            return _repository.search(orderId, invoiceId, inventoryId, companyId, personId, propertyId,
                descriptiveText, fromDate, toDate, filled, saleTotal, paid, pageIndex, pageSize, item);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] StoreOrder item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            var id = _repository.add(item);

            string payBy = item.paidBy;

            item = _repository.get(id);

            if (!string.IsNullOrEmpty(payBy)) {
                var invoice = _invoiceRepository.get(item.invoiceId.Value);

                var arPayment = new ArPayment()
                {
                    arPaymentId = 0,
                    accountId = 0, //PRE CONFIRMED
                    personId = item.personId,
                    datePaid = DateTime.Now,
                    paymentMethod = payBy == "CC" ? "Credit Card" : "Direct Deposit", //CONFIRM
                    creditAmount = 0,
                    escrowBankAccountID = 0,
                    companyId = invoice.companyId, //PRE CONFIRMED
                    detail = new List<ArPaymentDetail>()
                    {
                        new ArPaymentDetail()
                        {
                            arPaymentDetailId = 0,
                            arPaymentId = 0,
                            invoiceId = item.invoiceId.Value,
                            paymentAmount = item.saleTotal.Value, //PRE CONFIRMED
                            propertyId = null, //PRE CONFIRMED
                            locked = false
                        }
                    }
                };

                try
                {
                    var arPaymentHandler = new ArPaymentHandler(this._arPaymentRepository, this._globalSettingRepository, this._glAccountRepository, this._settingRepository, this._personRepository, this._personMerchantRepository, this._companyRepository, this._forteLogRepository);
                    arPayment = arPaymentHandler.add(arPayment, payBy == "CC" ? 1 : 2);
                }
                catch(Exception e)
                {
                    _repository.delete(item.orderId);
                    throw e;
                }
            }

            return new ObjectResult(item);
        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] StoreOrder item)
        {
            if (item == null || item.orderId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();
        }

        [HttpPost("filled/{id}")]
        public IActionResult filled(int id, bool value)
        {
            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            itemFound.filled = value;

            _repository.update(itemFound);

            return new NoContentResult();
        }
    }
}

```
## SubmissionController.cs
```cs
using System.Collections.Generic;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;
using System.Linq;
using OfficeOpenXml;
using System;
using System.IO;
using System.Text;
using System.Net;
using Newtonsoft.Json;
using System.Web;
using System.Xml;
using AT.AT2017.Api.Classes;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/submission")]
    public class SubmissionController : Controller
    {
        public ISubmissionRepository _repository;
        private ILogger<SubmissionController> _logger;
        public IGlobalSettingRepository _globalSettingRepository;

        public SubmissionController(ISubmissionRepository repository, IGlobalSettingRepository globalSettingRepository, ILogger<SubmissionController> logger)
        {
            _repository = repository;
            _globalSettingRepository = globalSettingRepository;
            _logger = logger;
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpGet("searchIdsSQL8")]
        public IEnumerable<SubmissionBatch> searchIdsSQL8(int submitId, string dbName)
        {
            return _repository.searchIdsSQL8(submitId, dbName);
        }

        [HttpGet("getSQL8Results")]
        public IActionResult getSQL8Results(int submitId, string dbName)
        {
            var item = _repository.getSQL8Results(submitId, dbName);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpGet("remax/search")]
        public IEnumerable<SubmissionRemax> searchRemax(int companyId=0, int year=0, int month=0, int submitId=0)
        {
            return _repository.searchRemax(companyId, year, month, submitId);
        }


        [HttpPost("remax/resend")]
        public int resendSubmissionRemax(int id)
        {
            return _repository.resendSubmissionRemax(id);           
        }

        [HttpGet("remax")]
        public IEnumerable<SubmissionRemax> searchRemaxIds(int companyId, int year = 0, int month = 0)
        {
            return _repository.searchRemaxIds(companyId, year,month);
        }

        [HttpGet]
        public IEnumerable<Submission> search(int entityId, string entityType, int submitId=0, string submitType="")
        {
            return _repository.search(entityId, entityType, submitId, submitType);
        }

		[HttpGet("searchIds")]
		public IEnumerable<Submission> searchIds()
		{
			return _repository.searchIds();
		}

		[HttpGet("searchXml")]
        public string searchXml(int entityId, string entityType, int detailId, string command, bool dash)
        {
            string xml = _repository.searchXml(entityId, entityType, detailId, command, dash);
           
            return xml;
        }

        [HttpPost("remax/resendStatistic")]
        public IActionResult resendStatistic(int id)
        {
            IEnumerable<GlobalSetting> list = _globalSettingRepository.searchSection("Remax API");
            GlobalSetting setting;
            string url, usr, pwd;

            setting = list.First(s => s.name == "REMAX_API_URL");
            url = setting == null ? "" : setting.value;

            setting = list.First(s => s.name == "REMAX_API_USR");
            usr = setting == null ? "" : setting.value;

            setting = list.First(s => s.name == "REMAX_API_PWD");
            pwd = setting == null ? "" : setting.value;

            SaveStatisticInput item = _repository.refreshItemStatistic(id);
            RemaxClient client = new RemaxClient(url, usr, pwd);

            RemaxApiLog log = client.saveStatistic(item);
            log.detailId = id;
            _repository.addRemaxLog(id, log);

            return new NoContentResult();
        }      

        [HttpPost("remax/process")]
        public string processSubmissionRemax(int companyId, int year, int month, string companyName, string email, string filePath, string gappsURL, bool sendToAPI)
        {
            string result = "";
            int submitId = _repository.addSubmissionRemax(companyId, year, month, sendToAPI);
            int processed = 0;

            if (sendToAPI)
            {
                IEnumerable<GlobalSetting> list = _globalSettingRepository.searchSection("Remax API");
                GlobalSetting setting;
                string url, usr, pwd;

                setting = list.First(s => s.name == "REMAX_API_URL");
                url = setting==null? "" :setting.value;

                setting = list.First(s => s.name == "REMAX_API_USR");
                usr = setting == null ? "" : setting.value;

                setting = list.First(s => s.name == "REMAX_API_PWD");
                pwd = setting == null ? "" : setting.value;

                IEnumerable<SaveStatisticInput> listStatistic = _repository.getSubmissionRemaxStatistic(submitId);
                RemaxClient client = new RemaxClient(url,usr,pwd);

                if (listStatistic.Count() > 0)
                {
                    processed = listStatistic.Count();

                    foreach (SaveStatisticInput item in listStatistic)
                    {
                        long detailID = item.teamSubcustomerId;
                        item.teamSubcustomerId = 0;
                        RemaxApiLog log = client.saveStatistic(item);
                        log.detailId = detailID;
                        _repository.addRemaxLog(detailID, log);
                    }                      
                }                   

            }
            else
            {
               //-------------------------------------------get submission
                IEnumerable<SubmissionRemax> list = _repository.getSubmissionRemax(submitId);

                if (list.Count() > 0)
                {
                    processed = list.Count();

                    //------------------------------------------create excel
                    string fileName = "";
                    byte[] arrFile;
                    fileName = "submission_" + month.ToString() + "_" + year.ToString() + "_" + DateTime.Now.ToString("yyyyMMdd_HHmmss") + ".xlsx";

                    filePath = Path.Combine(filePath, companyName);
                    filePath = Path.Combine(filePath, "REMAX");
                    if (!Directory.Exists(filePath))
                    {
                        Directory.CreateDirectory(filePath);
                    }

                    string path = Path.Combine(filePath, fileName);  //string path = filePath + fileName;
                    FileInfo file = new FileInfo(path);

                    using (ExcelPackage package = new ExcelPackage(file))
                    {
                        ExcelWorksheet worksheet = package.Workbook.Worksheets.Add("data");
                        worksheet.Cells["A1"].LoadFromCollection(list, true, OfficeOpenXml.Table.TableStyles.None);
                        worksheet.Column(1).Hidden = true;//remove "Submit ID"
                        package.Workbook.Properties.Author = "DARWIN";
                        package.Workbook.Properties.Title = "Remax submission";
                        package.Workbook.Properties.Company = "ACCOUNTTECH";

                        //package.Save();
                        arrFile = package.GetAsByteArray();
                        package.Dispose();
                    }

                    //----------------------------------------upload gdrive            
                    string strContent = "data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;base64," + System.Convert.ToBase64String(arrFile);
                    string strPath = "DARWIN/" + companyName + "/Submission/REMAX";

                    var postData = "content=" + System.Net.WebUtility.UrlEncode(strContent);
                    postData += "&originalFileName=" + System.Net.WebUtility.UrlEncode(fileName);
                    postData += "&path=" + System.Net.WebUtility.UrlEncode(strPath);
                    postData += "&guidFlag=false";

                    var send = Encoding.Default.GetBytes(postData);

                    var req = WebRequest.Create(gappsURL);
                    req.Method = "POST";
                    req.ContentType = "application/x-www-form-urlencoded";
                    req.ContentLength = send.Length;

                    var sout = req.GetRequestStream();
                    sout.Write(send, 0, send.Length);
                    sout.Flush();
                    sout.Close();

                    var res = req.GetResponse();
                    var sr = new StreamReader(res.GetResponseStream());
                    var returnvalue = sr.ReadToEnd();

                    Dictionary<string, string> values = JsonConvert.DeserializeObject<Dictionary<string, string>>(returnvalue);
                    if (values.ContainsKey("url"))
                    {
                        string urlFile = "https://drive.google.com/file/d/" + values["id"] + "/preview"; // values["url"];
                                                                                                         //-----------------------------------------------update submission
                        _repository.updateSubmissionRemax(submitId, email, urlFile);
                    }
                }                
            }

            result = submitId.ToString() + ":" + processed.ToString();
            return result;
        }

        // Berkshire Hataway
        [HttpGet("bhs")]
        public IEnumerable<SubmissionBHS> searchBHSIds(int companyId, string fromDate = "", string endDate = "")
        {
            return _repository.searchBHSIds(companyId, fromDate, endDate);
        }

        [HttpGet("bhs/{id}")]
        public SubmissionBHS getBHS(int id)
        {
            return _repository.getSubmissionBHS(id);
        }

        [HttpPost("bhs/resend")]
        public int resendSubmissionBHS(int id, string email)
        {
            return _repository.resendSubmissionBHS(id,email);
        }

        [HttpDelete("bhs/delete")]
        public IActionResult deleteSubmissionBHS(int id)
        {
             _repository.deleteSubmissionBHS(id);
            return new NoContentResult();
        }

        [HttpGet("bhs/preview")]
        public SubmissionBHS previewBHS(int companyId, string endDate, int validate)
        {
            return _repository.previewSubmissionBHS(companyId,endDate, validate);
        }

        [HttpPost("bhs/process")]
        public SubmissionBHS processSubmissionBHS([FromBody]  SubmissionBHS submisssion,string basePath, string gappsURL)
        {
            int submitID = 0;
            bool isSubmit = submisssion.isSubmit;
            SubmissionBHS submissionBHS = null;

            if (submisssion.submitID > 0)
            {
                // create submissionBHS
                 submitID = _repository.refreshSubmissionBHS(submisssion);
            }
            else
            {
                // create submissionBHS
                 submitID = _repository.addSubmissionBHS(submisssion);
            }

            if (isSubmit)
            {
                if (submitID != 0)
                {
                    // get submissionBHS
                    submissionBHS = _repository.getSubmissionBHS(submitID);

                    // get submission lines
                    IList<string> lines = this.getSubmissionLines(submissionBHS);

                    // create corporate directory if not exists
                    //string basePath = @"C:\Runtime\Submission\Berkshire";               
                    string companyPath = Path.Combine(basePath, submisssion.company);
                    companyPath = Path.Combine(companyPath, "BHS");

                    if (!Directory.Exists(companyPath))
                    {
                        Directory.CreateDirectory(companyPath);
                    }

                    // create TXT file
                    string txtFilename = "BHS_Export_" + DateTime.Now.ToString("yyyyMMdd_HHmmss") + ".txt";
                    this.createSubmissionBHSTxt(lines, companyPath, txtFilename);
                    byte[] txtBytes = this.FileToByteArray(Path.Combine(companyPath, txtFilename));

                    // create XML file (sales associates roster)
                    string xmlFilename = "BHS_Roster_" + DateTime.Now.ToString("yyyyMMdd_HHmmss") + ".xml";
                    this.createSaleAssociatesRosterXML(submissionBHS.salesAssociateDetail, companyPath, xmlFilename);
                    byte[] xmlBytes = this.FileToByteArray(Path.Combine(companyPath, xmlFilename));

                    // upload files to google drive and get urls
                    string driveFolderPath = "DARWIN/" + submisssion.company + "/Submission/BHS";
                    string txtURL = this.uploadToGoogleDrive(driveFolderPath, txtFilename, "text/plain", gappsURL, txtBytes);
                    string xmlURL = this.uploadToGoogleDrive(driveFolderPath, xmlFilename, "text/xml", gappsURL, xmlBytes);

                    // update submission (procedure is already created)
                    _repository.updateSubmissionBHS(submitID, submisssion.emailAddress, txtURL, xmlURL);
                }
            }
            else
            {
                // get submissionBHS
                submissionBHS = _repository.getSubmissionBHS(submitID);
            }

            return submissionBHS;
        }

        private IList<string> getSubmissionLines(SubmissionBHS submissionBHS)
        {
            // text file lines string
            IList<string> lines = new List<string>();

            // submission header (00)
            string header = this.getHeaderLine(submissionBHS.headerDetail.FirstOrDefault());
            lines.Add(header);


            string transaction = "";
            IEnumerable<SubmissionDetailBHSSalesCustomer> listSalesCustomer;
            IEnumerable<SubmissionDetailBHSAssociateProduction> listAssociateProduction;
            IList<string> saleCustomerLines = new List<string>();
            IList<string> associateProductionLines = new List<string>();

            //order:10->30->45          
            if (submissionBHS.salesTransactionDetail != null && submissionBHS.salesTransactionDetail.Count() > 0)
            {
                // submission sales transactions (10)
                foreach (SubmissionDetailBHSSalesTransaction item in  submissionBHS.salesTransactionDetail)
                {
                    transaction = this.getSalesTransactionLine(item);
                    lines.Add(transaction);

                    saleCustomerLines = new List<string>();
                    associateProductionLines = new List<string>();

                    // submission sales customers (30)
                    if (submissionBHS.salesCustomerDetail != null && submissionBHS.salesCustomerDetail.Count() > 0)
                    {
                       listSalesCustomer  = submissionBHS.salesCustomerDetail.Where(a => a.transNo == item.transNo).ToList();
                       if (listSalesCustomer!=null && listSalesCustomer.Count ()>0)  saleCustomerLines = this.getSalesCustomerLines(listSalesCustomer);
                    }

                    // submission associate productions (45)
                    if (submissionBHS.associateProductionDetail != null && submissionBHS.associateProductionDetail.Count() > 0)
                    {
                        listAssociateProduction = submissionBHS.associateProductionDetail.Where(a => a.transNo == item.transNo).ToList();
                        if (listAssociateProduction != null && listAssociateProduction.Count() > 0) associateProductionLines = this.getAssociateProductionLines(listAssociateProduction);
                    }
                   
                    lines = lines.Concat(saleCustomerLines).ToList();                  
                    lines = lines.Concat(associateProductionLines).ToList();
                }                  
            }

            //order:20->30->45
            if (submissionBHS.miscIncomeDetail != null && submissionBHS.miscIncomeDetail.Count() > 0)
            {
                // submission misc income transactions (20)
                foreach (SubmissionDetailBHSMiscIncome item in submissionBHS.miscIncomeDetail)
                {
                    transaction = this.getMiscIncomeTransLine(item);
                    lines.Add(transaction);

                    saleCustomerLines = new List<string>();
                    associateProductionLines = new List<string>();

                    // submission sales customers (30)
                    if (submissionBHS.salesCustomerDetail != null && submissionBHS.salesCustomerDetail.Count() > 0)
                    {
                        listSalesCustomer = submissionBHS.salesCustomerDetail.Where(a => a.transNo == item.transNo).ToList();
                        if (listSalesCustomer != null && listSalesCustomer.Count() > 0) saleCustomerLines = this.getSalesCustomerLines(listSalesCustomer);
                    }

                    // submission associate productions (45)
                    if (submissionBHS.associateProductionDetail != null && submissionBHS.associateProductionDetail.Count() > 0)
                    {
                        listAssociateProduction = submissionBHS.associateProductionDetail.Where(a => a.transNo == item.transNo).ToList();
                        if (listAssociateProduction != null && listAssociateProduction.Count() > 0) associateProductionLines = this.getAssociateProductionLines(listAssociateProduction);
                    }

                    lines = lines.Concat(saleCustomerLines).ToList();
                    lines = lines.Concat(associateProductionLines).ToList();
                }
            }

          /*  // submission sales transactions (10)
            IList<string> saleTransactionLines = new List<string>();
            if (submissionBHS.salesTransactionDetail != null && submissionBHS.salesTransactionDetail.Count() >0)
            {
               saleTransactionLines = this.getSalesTransactionLines(submissionBHS.salesTransactionDetail);
               lines = lines.Union(saleTransactionLines).ToList();
            }

            // submission misc income transactions (20)
            IList<string> miscIncomeLines = new List<string>();
            if (submissionBHS.miscIncomeDetail != null && submissionBHS.miscIncomeDetail.Count() > 0)
            {
                miscIncomeLines = this.getMiscIncomeTransLines(submissionBHS.miscIncomeDetail);
                lines = lines.Union(miscIncomeLines).ToList();
            }

            // submission sales customers (30)
                      if (submissionBHS.salesCustomerDetail != null && submissionBHS.salesCustomerDetail.Count() > 0)
            {
                saleCustomerLines = this.getSalesCustomerLines(submissionBHS.salesCustomerDetail);
                lines = lines.Union(saleCustomerLines).ToList();
            }           

            // submission associate productions (45)
           
            if (submissionBHS.associateProductionDetail != null && submissionBHS.associateProductionDetail.Count() > 0)
            {
                associateProductionLines = this.getAssociateProductionLines(submissionBHS.associateProductionDetail);
                lines = lines.Union(associateProductionLines).ToList();
            }*/

            // submission monthly listings (40)
            IList<string> monthLisintingsLines = new List<string>();
            if (submissionBHS.monthlyListingsDetail != null && submissionBHS.monthlyListingsDetail.Count() > 0)
            {
                monthLisintingsLines = this.getMonthlyListingsLines(submissionBHS.monthlyListingsDetail);
                lines = lines.Concat(monthLisintingsLines).ToList();
            }

            // trailer (99)
            if (submissionBHS.trailerDetail != null && submissionBHS.trailerDetail.Count() > 0)
            {
                string trailer = this.getTrailerLines(submissionBHS.trailerDetail.FirstOrDefault());
                lines.Add(trailer);
            }           

            return lines;
        }

        private string getHeaderLine(SubmissionDetailBHSHeader header)
        {
            // 0000000036IN304AT2000    50.0  DB4.0
            return header.recordType.PadLeft(2, '0')                // recordType
                + header.batchID.ToString().PadLeft(8, '0')         // batchID
                + header.affiliateID.PadRight(5, ' ')               // affiliatedID
                + header.softwareName.PadRight(10, ' ')             // software name
                + header.softwareVersion.PadRight(6, ' ')           // software version
                + header.dataBridgeVersion.PadRight(5, ' ');        // databridge version
        }

        private string getTrailerLines(SubmissionDetailBHSTrailer trailer)
        {
            // 9900000036IN30400001678650
            return trailer.recordType.PadLeft(2, '0')                // recordType
                + trailer.batchID.ToString().PadLeft(8, '0')         // batchID
                + trailer.affiliateID.PadRight(5, ' ')               // affiliatedID
                + trailer.totalGCI.ToString("F2").Replace(".", "").PadLeft(11, '0');      // total GCI
        }

        private IList<string> getSalesTransactionLines(IEnumerable<SubmissionDetailBHSSalesTransaction> salesTransactions)
        {
            // 1000000036IN3040010000012069CL00120180606201805128700 Raven Way , Cedar Lake, IN 46303                                      Cedar Lake                                        IN46303     USARN000212500000000034000000000000000IN304001IN304001       
            IList<string> lines = new List<string>();
            foreach(SubmissionDetailBHSSalesTransaction item in salesTransactions)
            {
                string line = item.recordType.PadLeft(2, '0')                           // recordType
                    + item.batchID.ToString().PadLeft(8, '0')                           // batchID
                    + item.officeID.PadRight(8, ' ')                                    // officeID
                    + item.transNo.PadLeft(10, '0')                                     // transNo
                    + item.status.ToString()                                            // status
                    + item.sequenceNumber.ToString().PadLeft(3, '0')                    // sequence number
                    + item.closeDate.ToString("yyyyMMdd")                               // close date
                    + item.soldDate.ToString("yyyyMMdd")                                // sold date
                    + item.propertyAddress.PadRight(75, ' ')                            // property address
                    + item.city.PadRight(50, ' ')                                       // city
                    + item.state.PadRight(2, ' ')                                       // state
                    + item.zipCode.PadRight(10, ' ')                                    // zip code
                    + item.country.PadRight(3, ' ')                                     // country
                    + item.propertyType.PadRight(1, ' ')                                // property type
                    + item.unimprovedLandFlag.PadRight(1, ' ')                          // unimproved land flag
                    + item.salesPrice.ToString("F2").Replace(".", "").PadLeft(11, '0')      // sales price
                    + item.gci.ToString("F2").Replace(".", "").PadLeft(11, '0')             // gci
                    + item.gciDeductions.ToString("F2").Replace(".", "").PadLeft(11, '0')   // gdc deductions
                    + item.listingOfficeID.PadRight(8, ' ')                             // listing office id
                    + item.sellingOfficeID.PadRight(8, ' ')                             // selling office id
                    + item.referredTran.PadRight(1, ' ')                                // referred tran
                    + item.inNetworkReferral.PadRight(1, ' ')                           // in network referral
                    + item.referralSource.PadRight(5, ' ');                             // referral source

                lines.Add(line);

            }

            return lines;

        }

        private string getSalesTransactionLine(SubmissionDetailBHSSalesTransaction item)
        {
            string closeDate = "";
            if (item.closeDate != null && item.closeDate > DateTime.MinValue) closeDate = item.closeDate.ToString("yyyyMMdd");

                string line = item.recordType.PadLeft(2, '0')                           // recordType
                    + item.batchID.ToString().PadLeft(8, '0')                           // batchID
                    + item.officeID.PadRight(8, ' ')                                    // officeID
                    + item.transNo.PadLeft(10, '0')                                     // transNo
                    + item.status.ToString()                                            // status
                    + item.sequenceNumber.ToString().PadLeft(3, '0')                    // sequence number
                    + closeDate.PadRight(8, ' ')                              // close date
                    + item.soldDate.ToString("yyyyMMdd")                                // sold date
                    + item.propertyAddress.PadRight(75, ' ')                            // property address
                    + item.city.PadRight(50, ' ')                                       // city
                    + item.state.PadRight(2, ' ')                                       // state
                    + item.zipCode.PadRight(10, ' ')                                    // zip code
                    + item.country.PadRight(3, ' ')                                     // country
                    + item.propertyType.PadRight(1, ' ')                                // property type
                    + item.unimprovedLandFlag.PadRight(1, ' ')                          // unimproved land flag
                    + item.salesPrice.ToString("F2").Replace(".", "").PadLeft(11, '0')      // sales price
                    + item.gci.ToString("F2").Replace(".", "").PadLeft(11, '0')             // gci
                    + item.gciDeductions.ToString("F2").Replace(".", "").PadLeft(11, '0')   // gdc deductions
                    + item.listingOfficeID.PadRight(8, ' ')                             // listing office id
                    + item.sellingOfficeID.PadRight(8, ' ')                             // selling office id
                    + item.referredTran.PadRight(1, ' ')                                // referred tran
                    + item.inNetworkReferral.PadRight(1, ' ')                           // in network referral
                    + item.referralSource.PadRight(5, ' ');                             // referral source

            return line;
        }

        private string getMiscIncomeTransLine(SubmissionDetailBHSMiscIncome item)
        {
           
                string line = item.recordType.PadLeft(2, '0')                           // recordType
                    + item.batchID.ToString().PadLeft(8, '0')                           // batchID
                    + item.officeID.PadRight(8, ' ')                                    // officeID
                    + item.transType.PadRight(2, ' ')                                   // transType
                    + item.transNo.PadLeft(10, '0')                                     // transNo
                    + item.sequenceNumber.ToString().PadLeft(3, '0')                    // sequence number
                    + item.commissionDate.ToString("yyyyMMdd")                          // commission date
                    + item.propertyType.PadRight(1, ' ')                                // property type
                    + item.unimprovedLandFlag.PadRight(1, ' ')                          // unimproved land flag
                    + item.gci.ToString("F2").Replace(".", "").PadLeft(11, '0')             // gci
                    + item.gciDeductions.ToString("F2").Replace(".", "").PadLeft(11, '0')   // gci deductions
                    + item.referredTran.PadRight(1, ' ')                                // referred tran
                    + item.inNetworkReferral.PadRight(1, ' ')                           // in network referral
                    + item.referralSource.PadRight(5, ' ');                             // referral source
              
            return line;
        }

        private IList<string> getMiscIncomeTransLines(IEnumerable<SubmissionDetailBHSMiscIncome> miscIncomeTransactions)
        {
            IList<string> lines = new List<string>();
            foreach (SubmissionDetailBHSMiscIncome item in miscIncomeTransactions)
            {
                string line = item.recordType.PadLeft(2, '0')                           // recordType
                    + item.batchID.ToString().PadLeft(8, '0')                           // batchID
                    + item.officeID.PadRight(8, ' ')                                    // officeID
                    + item.transType.PadRight(2, ' ')                                   // transType
                    + item.transNo.PadLeft(10, '0')                                     // transNo
                    + item.sequenceNumber.ToString().PadLeft(3, '0')                    // sequence number
                    + item.commissionDate.ToString("yyyyMMdd")                          // commission date
                    + item.propertyType.PadRight(1, ' ')                                // property type
                    + item.unimprovedLandFlag.PadRight(1, ' ')                          // unimproved land flag
                    + item.gci.ToString("F2").Replace(".", "").PadLeft(11, '0')             // gci
                    + item.gciDeductions.ToString("F2").Replace(".", "").PadLeft(11, '0')   // gci deductions
                    + item.referredTran.PadRight(1, ' ')                                // referred tran
                    + item.inNetworkReferral.PadRight(1, ' ')                           // in network referral
                    + item.referralSource.PadRight(5, ' ');                             // referral source

                lines.Add(line);

            }
            return lines;
        }

        private IList<string> getSalesCustomerLines(IEnumerable<SubmissionDetailBHSSalesCustomer> salesCustomers)
        {
            // 3000000036IN304001ST0000012069001000000001997000001067428S1                                                   EMPTY                                             M
            IList<string> lines = new List<string>();
            foreach (SubmissionDetailBHSSalesCustomer item in salesCustomers)
            {
                string line = item.recordType.PadLeft(2, '0')                           // recordType
                    + item.batchID.ToString().PadLeft(8, '0')                           // batchID
                    + item.officeID.PadRight(8, ' ')                                    // officeID
                    + item.transType.PadRight(2, ' ')                                   // transType
                    + item.transNo.PadLeft(10, '0')                                     // transNo
                    + item.sequenceNumber.ToString().PadLeft(3, '0')                    // sequence number
                    + item.associateID.PadLeft(12, '0')                                 // assocID
                    + item.preaID.ToString().PadLeft(12, '0')                           // preaID
                    + item.buyerSellerCode.PadRight(2, ' ')                             // buyser seller code
                    + item.firstName.PadRight(50, ' ')                                  // first name
                    + item.middleInitial.PadRight(1, ' ')                               // middle initial
                    + item.lastName.PadRight(50, ' ')                                   // last name
                    + item.genderCode.PadRight(1, ' ');                                 // gender code

                lines.Add(line);

            }
            return lines;
        }

        private IList<string> getMonthlyListingsLines(IEnumerable<SubmissionDetailBHSMonthlyListings> monthlyListings)
        {
            // 4000000036IN3040022018060000000049
            IList<string> lines = new List<string>();
            foreach (SubmissionDetailBHSMonthlyListings item in monthlyListings)
            {
                string line = item.recordType.PadLeft(2, '0')                           // recordType
                    + item.batchID.ToString().PadLeft(8, '0')                           // batchID
                    + item.officeID.PadRight(8, ' ')                                    // officeID
                    + item.yearMonth.PadRight(6, ' ')                                   // year-month
                    + item.listingsTaken.ToString().PadLeft(5, '0')                     // listings taken
                    + item.listingsInventory.ToString().PadLeft(5, '0');                // listings inventory

                lines.Add(line);

            }
            return lines;
        }

        private IList<string> getAssociateProductionLines(IEnumerable<SubmissionDetailBHSAssociateProduction> associateProductions)
        {
            // 4500000036IN304002ST0000012236001000000002034000001067483S040000000135460
            IList<string> lines = new List<string>();
            foreach (SubmissionDetailBHSAssociateProduction item in associateProductions)
            {
                string line = item.recordType.PadLeft(2, '0')                           // recordType
                    + item.batchID.ToString().PadLeft(8, '0')                           // batchID
                    + item.officeID.PadRight(8, ' ')                                    // officeID
                    + item.transType.PadRight(2, ' ')                                   // transType
                    + item.transNo.PadLeft(10, '0')                                     // transNo
                    + item.sequenceNumber.ToString().PadLeft(3, '0')                    // sequence number
                    + item.associateID.PadLeft(12, '0')                                 // assocID
                    + item.preaID.ToString().PadLeft(12, '0')                           // preaID
                    + item.listSellCode.PadRight(1, ' ')                                // list sell code
                    + item.assocProductionUnit.ToString().PadLeft(4, '0')               // assoc production unit
                    + item.assocProductionGCI.ToString("F2").Replace(".", "").PadLeft(11, '0');              // assoc production gci


                lines.Add(line);

            }
            return lines;
        }

        private void createSubmissionBHSTxt(IList<string> lines, string companyPath, string filename)
        {
            // create file text
            string path = Path.Combine(companyPath, filename);
            System.IO.File.Create(path).Dispose();
            System.IO.File.AppendAllLines(path, lines);
        }

        private void createSaleAssociatesRosterXML(IEnumerable<SubmissionDetailBHSSalesAssociate> salesAssociates, string companyPath, string fileName)
        {
            string xml = String.Empty;

            XmlDocument doc = new XmlDocument();
            XmlNode docNode = doc.CreateXmlDeclaration("1.0", "UTF-8", null);
            doc.AppendChild(docNode);

            XmlNode rootNode = doc.CreateElement("UploadAssociates");
            doc.AppendChild(rootNode);

            foreach (SubmissionDetailBHSSalesAssociate item in salesAssociates)
            {
                // create associate node
                XmlNode associateNode = doc.CreateElement("UploadAssociate");
                rootNode.AppendChild(associateNode);

                this.appendAssociateInfoNode(doc, associateNode, "AffiliateId", item.affiliateID);
                this.appendAssociateInfoNode(doc, associateNode, "AssignedToOffice", item.assignedToOffice);
                this.appendAssociateInfoNode(doc, associateNode, "BmsId", item.bmsID);
                this.appendAssociateInfoNode(doc, associateNode, "PREAId", item.preaID);
                this.appendAssociateInfoNode(doc, associateNode, "FirstName", item.firstName);
                this.appendAssociateInfoNode(doc, associateNode, "MiddleName", item.middleInitial);
                this.appendAssociateInfoNode(doc, associateNode, "LastName", item.lastName);
                this.appendAssociateInfoNode(doc, associateNode, "PrimaryEmail", item.primaryEmail);
                this.appendAssociateInfoNode(doc, associateNode, "EmployeeType", item.employeeType);
                this.appendAssociateInfoNode(doc, associateNode, "EmployeeStatus", item.employeeStatus);
                this.appendAssociateInfoNode(doc, associateNode, "MobilePhone", item.mobilePhone);
                this.appendAssociateInfoNode(doc, associateNode, "AlternateEmail", item.alternateEmail);
                this.appendAssociateInfoNode(doc, associateNode, "StatusUpdateDate", this.getAssociateDateString(item.statusUpdateDate));
                this.appendAssociateInfoNode(doc, associateNode, "HireDate", this.getAssociateDateString(item.hireDate));
                this.appendAssociateInfoNode(doc, associateNode, "TerminationDate", this.getAssociateDateString(item.terminationDate));

            }

            doc.Save(Path.Combine(companyPath, fileName));
                
        }

        private void appendAssociateInfoNode(XmlDocument doc, XmlNode associateNode, string nodeName, string nodeValue)
        {
            XmlNode node = doc.CreateElement(nodeName);
            if (nodeValue != "")
            {
                node.AppendChild(doc.CreateTextNode(nodeValue));
            }
            associateNode.AppendChild(node);
        }

        private string getAssociateDateString(DateTime? date) 
        {
            string dateString = String.Empty;
            if (date != null)
            {
                dateString = date.GetValueOrDefault().ToString("MM/dd/yyyy");
            }

            return dateString;
        }

        public byte[] FileToByteArray(string fileName)
        {
            byte[] buff = null;
            FileStream fs = new FileStream(fileName,
                                           FileMode.Open,
                                           FileAccess.Read);
            BinaryReader br = new BinaryReader(fs);
            long numBytes = new FileInfo(fileName).Length;
            buff = br.ReadBytes((int)numBytes);
            return buff;
        }

        private string uploadToGoogleDrive(string folderPath, string fileName, string mimeType, string gappsURL, byte[] arrFile)
        {
            // mime-types
            //  "xls" =>'application/vnd.ms-excel',
            //  "xlsx" =>'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
            //  "xml" =>'text/xml',
            //  "ods"=>'application/vnd.oasis.opendocument.spreadsheet',
            //  "csv"=>'text/plain',
            //  "tmpl"=>'text/plain',
            //  "pdf"=> 'application/pdf',
            //  "php"=>'application/x-httpd-php',
            //  "jpg"=>'image/jpeg',
            //  "png"=>'image/png',
            //  "gif"=>'image/gif',
            //  "bmp"=>'image/bmp',
            //  "txt"=>'text/plain',
            //  "doc"=>'application/msword',
            //  "js"=>'text/js',
            //  "swf"=>'application/x-shockwave-flash',
            //  "mp3"=>'audio/mpeg',
            //  "zip"=>'application/zip',
            //  "rar"=>'application/rar',
            //  "tar"=>'application/tar',
            //  "arj"=>'application/arj',
            //  "cab"=>'application/cab',
            //  "html"=>'text/html',
            //  "htm"=>'text/html',
            //  "default"=>'application/octet-stream',
            //  "folder"=>'application/vnd.google-apps.folder'
            
            string content = "data:" + mimeType + ";base64," + System.Convert.ToBase64String(arrFile);

            var postData = "content=" + System.Net.WebUtility.UrlEncode(content);
            postData += "&originalFileName=" + System.Net.WebUtility.UrlEncode(fileName);
            postData += "&path=" + System.Net.WebUtility.UrlEncode(folderPath);
            postData += "&guidFlag=false";

            var send = Encoding.Default.GetBytes(postData);

            var req = WebRequest.Create(gappsURL);
            req.Method = "POST";
            req.ContentType = "application/x-www-form-urlencoded";
            req.ContentLength = send.Length;

            var sout = req.GetRequestStream();
            sout.Write(send, 0, send.Length);
            sout.Flush();
            sout.Close();

            var res = req.GetResponse();
            var sr = new StreamReader(res.GetResponseStream());
            var returnvalue = sr.ReadToEnd();

            string urlFile = string.Empty;
            Dictionary<string, string> values = JsonConvert.DeserializeObject<Dictionary<string, string>>(returnvalue);
            if (values.ContainsKey("url"))
            {
                urlFile = "https://drive.google.com/file/d/" + values["id"] + "/preview";
            }

            return urlFile;

        }


        // NACHA
        [HttpGet("nacha")]
        public IEnumerable<SubmissionNACHA> searchNacha(int companyId, int accountId = 0, string startDate="", string endDate="")
        {
            return _repository.searchNacha(companyId, accountId, startDate, endDate);
        }

        [HttpGet("nacha/{id}")]
        public SubmissionNACHA getNacha(int id)
        {
            return _repository.getNacha(id);
        }

        [HttpPost("nacha/{id}")]
        public IActionResult deleteNacha(int id)
        {
            _repository.deleteNacha(id);
            return new NoContentResult();
        }

        [HttpPost("nacha/finish")]
        public IActionResult finishNacha(int id)
        {
            _repository.finishNacha(id);
            return new NoContentResult();
        }

        [HttpGet("nacha/preview")]
        public SubmissionNACHA previewNacha(int companyId, int accountId, string startDate, string endDate, string processDate="", string email="", int isBalanced=0)
        {
            return _repository.previewNacha(companyId, accountId, startDate, endDate, processDate,email, isBalanced);
        }

        [HttpGet("nacha/validate")]
        public IEnumerable<SubmissionNachaDetail> validateNacha(int companyId, int accountId, string startDate, string endDate)
        {
            return _repository.validateNacha(companyId, accountId, startDate, endDate);
        }

        [HttpPost("nacha/process")]
        public SubmissionNACHA processNacha([FromBody]  SubmissionNACHA submisssion, string basePath="", string gappsURL="")
        {
            int submitID = 0;
            SubmissionNACHA item = null;

            // text file lines string
            IList<string> lines = new List<string>();           

            if (submisssion.emailAddress != "")
            {
                string companyPath = Path.Combine(basePath, submisssion.company);
                companyPath = Path.Combine(companyPath, "NACHA");

                if (!Directory.Exists(companyPath))
                {
                    Directory.CreateDirectory(companyPath);
                }

                lines = getNACHALines(submisssion);
                string txtFilename = "NACHA_Export_" + DateTime.Now.ToString("yyyyMMdd_HHmmss") + ".txt";
                this.createSubmissionBHSTxt(lines, companyPath, txtFilename);
                byte[] txtBytes = this.FileToByteArray(Path.Combine(companyPath, txtFilename));

                // upload files to google drive and get urls
                string driveFolderPath = "DARWIN/" + submisssion.company + "/Submission/NACHA";
                string txtURL = this.uploadToGoogleDrive(driveFolderPath, txtFilename, "text/plain", gappsURL, txtBytes);

                submisssion.urlFile = txtURL;
            }

            submitID = _repository.addNacha(submisssion);
            item = _repository.getNacha(submitID);

            return item;
        }

        private IList<string> getNACHALines(SubmissionNACHA submission)
        {
            IList<string> lines = new List<string>();
            foreach (SubmissionNachaFileHeader item in submission.fileHeaderDetail)
            {
                string line = item.recordTypeCode
                    + item.priorityCode
                    + item.immediateDestination
                    + item.immediateOrigin
                    + item.fileCreationDate
                    + item.fileCreationTime
                    + item.fileIdModifier
                    + item.recordSize
                    + item.blockingFactor
                    + item.formatCode
                    + item.immediateDestinationName
                    + item.immediateOriginName
                    + item.referenceCode;

                lines.Add(line);
            }

            foreach (SubmissionNachaBatchHeader item in submission.batchHeaderDetail)
            {
                string line = item.recordTypeCode
                    + item.serviceClassCode
                    + item.companyName
                    + item.companyDiscretionaryData
                    + item.companyIdentification
                    + item.standardEntryClassCode
                    + item.companyEntryDescription
                    + item.companyDescriptiveDate
                    + item.effectiveEntryDate
                    + item.settlementDate
                    + item.originatorStatusCode
                    + item.originatingDfiIdentification
                    + item.batchNumber;
                lines.Add(line);
            }

            foreach (SubmissionNachaEntryDetail item in submission.entryDetail)
            {
                string line = item.recordTypeCode
                    + item.transactionCode
                    + item.receivingDfiIdentification
                    + item.checkDigit
                    + item.dfiAccountNumber
                    + item.amount
                    + item.identificationNumber
                    + item.individualName
                    + item.discretionaryData
                    + item.addendaRecordIndicator
                    + item.traceNumber;
                lines.Add(line);
            }

            foreach (SubmissionNachaBatchControl item in submission.batchControlDetail)
            {
                string line = item.recordTypeCode
                    + item.serviceClassCode
                    + item.addendaCount
                    + item.entryHash
                    + item.totalDebitDollarAmount
                    + item.totalCreditDollarAmount
                    + item.companyIdentification
                    + item.messageAuthenticationCode
                    + item.reserved
                    + item.originatingDfiIdentification
                    + item.batchNumber;
                lines.Add(line);
            }

            foreach (SubmissionNachaFileControl item in submission.fileControlDetail)
            {
                string line = item.recordTypeCode
                    + item.batchCount
                    + item.blockCount
                    + item.entryAddendaCount
                    + item.entryHash
                    + item.totalDebitDollarAmount
                    + item.totalCreditDollarAmount
                    + item.reserved;
                lines.Add(line);
            }


            return lines;
        }

      
    }
}

```
## SubmissionScheduleController.cs
```cs
using System.Collections.Generic;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Controllers
{

    [Route("api/[controller]")]
    public class SubmissionScheduleController : Controller
    {
        public ISubmissionScheduleRepository _repository;
        private ILogger<SubmissionScheduleController> _logger;

        public SubmissionScheduleController(ISubmissionScheduleRepository repository, ILogger<SubmissionScheduleController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<SubmissionSchedule> search(int companyId = 0)
        {
            return _repository.search(companyId);
        }

        [HttpGet("searchServer")]
        public IEnumerable<Server> searchServer()
        {
            return _repository.searchServer();
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] SubmissionSchedule item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] SubmissionSchedule item)
        {
            if (item == null || item.submissionScheduleId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }
    }
}

```
## TaskController.cs
```cs
using System.Collections.Generic;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class TaskController : Controller
    {

        public ITaskRepository _repository;
        private ILogger<TaskController> _logger;

        public TaskController(ITaskRepository repository, ILogger<TaskController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<Task> search(string source)
        {
            return _repository.search(source);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] Task item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] Task item)
        {
            if (item == null || item.taskID != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }

    }
}

```
## TaskGroupController.cs
```cs
using System.Collections.Generic;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/task/group")]
    public class TaskGroupController : Controller
    {

        public ITaskGroupRepository _repository;
        private ILogger<TaskGroupController> _logger;

        public TaskGroupController(ITaskGroupRepository repository, ILogger<TaskGroupController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<TaskGroup> search(int groupID)
        {
            return _repository.search(groupID);
        }

        [HttpPost]
        public IActionResult add([FromBody] TaskGroup item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            return new NoContentResult();

        }

        [HttpDelete]
        public IActionResult delete([FromBody] TaskGroup item)
        {
            _repository.delete(item);

            return new NoContentResult();

        }

    }
}

```
## TokenController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Repositories;
using Microsoft.AspNetCore.Http;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Logging;

namespace AT.AT2017.Api.Controllers
{

    [Route("api/[controller]")]
    public class TokenController : Controller
    {
        public ITokenRepository _repository;

        private ILogger<TokenController> _logger;

        public TokenController(ITokenRepository repository, ILogger<TokenController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<Token> search(int userID = 0, string userName = "", int appClientID = 0)
        {
            return _repository.search(userID, userName, appClientID);
        }

    }

}
```
## TotalController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class TotalController : Controller
    {
        public ITotalRepository _repository;

        private ILogger<TotalController> _logger;

        public TotalController(ITotalRepository repository, ILogger<TotalController> logger)
        {
            _repository = repository;
            _logger = logger;
        }
        
        [HttpGet]
        public IEnumerable<Total> search()
        {
            return _repository.search();
        }

        [HttpGet("searchreportid")]
        public IEnumerable<int> searchReportId()
        {
            return _repository.searchReportId();
        }

        [HttpGet("searchcommissionindex")]
        public IEnumerable<int> searchCommissionIndex()
        {
            return _repository.searchCommissionIndex();
        }

        [HttpGet("deleted")]
        public IEnumerable<Total> searchDeletedRecord(int pageIndex = 0, int pageSize = 10)
        {
            return _repository.searchDeletedRecord(pageIndex, pageSize);
        }

        [HttpGet("frommaster")]
        public IEnumerable<Total> searchFromMaster()
        {
            return _repository.searchFromMaster();
        }

        [HttpGet("dateTypes")]
        public IEnumerable<PropertyDateType> searchDateTypes(string statuses)
        {
            return _repository.searchDateTypes(statuses);
        }

        [HttpGet("{id}/frommaster")]
        public IActionResult getFromMaster(int id)
        {
            var item = _repository.getFromMaster(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPut("{id}/exporttomaster")]
        public IActionResult exportToMaster(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.exportToMaster(id);

            return new NoContentResult();
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            //if (item == null)
            //{
            //    return NotFound();
            //}
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] Total item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] Total item)
        {
            if (item == null || item.totalId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }

        [HttpGet("translateformula")]
        public string translateFormula(string formula, bool reverse = false)
        {
            return _repository.translateFormula(formula, reverse);
        }

        [HttpGet("validateformula")]
        public bool validateFormula(string formula, string type = "deductionBased")
        {
            return _repository.validateFormula(formula, type);
        }

        [HttpGet("calculate")]
        public decimal calculate(int totalID, int personID, int propertyID,int agentTeamID)
        {

            return _repository.calculate(totalID, personID, propertyID, agentTeamID);

        }

    }
}

```
## UIExceptionLogController.cs
```cs
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Repositories;
using Microsoft.AspNetCore.Mvc;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class UIExceptionLogController : Controller
    {

        private IUIExceptionLogRepository _repository;

        public UIExceptionLogController(IUIExceptionLogRepository repository)
        {
            _repository = repository;
        }

        [HttpPost]
        public IActionResult add([FromBody] UIExceptionLog item)
        {
            _repository.add(item);
            return new ObjectResult(item);
        }
    }
}
```
## UIValidationController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class UIValidationController : Controller
    {
        public IUIValidationRepository _repository;
        private ILogger<UIValidationController> _logger;

        public UIValidationController(IUIValidationRepository repository, ILogger<UIValidationController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<UIValidation> search(string table = "")
        {
            return _repository.search(table);
        }

        [HttpGet("bymodule")]
        public IEnumerable<UIValidation> searchByModule(string moduleTable = "")
        {
            return _repository.searchByModule(moduleTable);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }


        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] UIValidation item)
        {
            if (item == null || item.validationID != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }
    }
}

```
## UIValidationTableController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class UIValidationTableController : Controller
    {
        public IUIValidationTableRepository  _repository;
        private ILogger<UIValidationTableController> _logger;

        public UIValidationTableController(IUIValidationTableRepository repository, ILogger<UIValidationTableController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<UIValidationTable> search()
        {
            return _repository.search();
        }

      }
}

```
## UserCompanyController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/user/company")]
    public class UserCompanyController : Controller
    {
        public IUserCompanyRepository _repository;
        private ILogger<UserCompanyController> _logger;

        public UserCompanyController(IUserCompanyRepository repository, ILogger<UserCompanyController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<UserCompany> search(int companyId = 0, int userId = 0)
        {
            return _repository.search(companyId, userId);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] UserCompany item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }
    }
}

```
## UserController.cs
```cs
using System.Collections.Generic;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Validation;
using AT.AT2017.Api.Core.Shared;
using AT.AT2017.Api.Core.Exceptions;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class UserController : Controller
    {

        public IUserRepository _repository;
        private ILogger<UserController> _logger;

        public UserController(IUserRepository repository, ILogger<UserController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<User> search(string fullName = "", string userName = "", string email= "", string corporateName = "", int companyId = 0, int officeId = 0, int roleId = 0, int pageIndex = 0, int pageSize = 10)
        {
            return _repository.search(fullName, userName, email, corporateName, companyId, officeId, roleId,pageIndex, pageSize);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        [ValidateModel]
        public IActionResult add([FromBody] UserCredentials item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            User user = _repository.get(id);
            return new ObjectResult(user);

        }

        [HttpPut("{id}")]
        [ValidateModel]
        public IActionResult update(int id, [FromBody] User item)
        {
            if (item == null || item.userId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item, itemFound.userName);

            return new NoContentResult();
        }


        [HttpPut("{id}/password")]
        public IActionResult updatePassword(int id, [FromBody] UserCredentials item)
        {
            if (item == null || item.userId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.updatePassword(item);

            return new NoContentResult();
        }

        [HttpPut("{id}/password/cloud")]
        public IActionResult updatePasswordCloud(int id, [FromBody] UserCredentials item)
        {
            if (item == null || item.userId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            if (item.userPassword == item.confirmUserPassword)
            {
                _repository.validateCurrentPassword(item); 
                _repository.updatePassword(item);
            }
            else
            {
                throw new NewPasswordException(id);
            }

            return new NoContentResult();
        }

        [HttpPost("password/bulk")]
        public string updatePasswordBulk([FromBody] UsersNewPassword data)
        {
            return _repository.updatePasswordBulk(data.usersCsv, data.newPassword);
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }

        [HttpGet("password/bulk/update")]
        public IEnumerable<BulkPasswordUpdateLog> bulkPasswordUpdateSearch(string executionGUID, string status = null)
        {
            return _repository.bulkPasswordUpdateSearch(executionGUID, status);
        }


    }
}

```
## UserGLAccountController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/user/glaccount")]
    public class UserGLAccountController : Controller
    {
        public IUserGLAccountRepository _repository;
        private ILogger<UserGLAccountController> _logger;

        public UserGLAccountController(IUserGLAccountRepository repository, ILogger<UserGLAccountController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<UserGLAccount> search(int companyId = 0, int userId = 0, int accountId = 0)
        {
            return _repository.search(companyId, userId, accountId);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] UserGLAccount item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }
    }
}

```
## UserOfficeController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/user/office")]
    public class UserOfficeController : Controller
    {
        public IUserOfficeRepository _repository;
        private ILogger<UserOfficeController> _logger;

        public UserOfficeController(IUserOfficeRepository repository, ILogger<UserOfficeController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<UserOffice> search(int companyId = 0, int userId = 0, int officeId = 0)
        {
            return _repository.search(companyId, userId, officeId);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] UserOffice item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }
    }
}

```
## UserPhoneController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Classes;
using AT.AT2017.Api.Core.Exceptions;

namespace AT.AT2017.Api.Controllers
{

    [Route("api/user/phone")]
    public class UserPhoneController : Controller
    {

        public IUserPhoneRepository _repository;
        private ILogger<UserPhoneController> _logger;
        public IGlobalSettingRepository _globalSettingRepository;

        public UserPhoneController(IUserPhoneRepository repository, IGlobalSettingRepository globalSettingRepository, ILogger<UserPhoneController> logger)
        {
            _repository = repository;
            _logger = logger;
            _globalSettingRepository = globalSettingRepository;
        }

        [HttpGet]
        public IEnumerable<UserPhone> search(int userId = 0, int onlyVerified=0)
        {
            return _repository.search(userId, onlyVerified);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] UserPhone item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            item.userPhoneId = _repository.add(item);

            //send sms for verification
            TwilioClient client = new TwilioClient(_globalSettingRepository);
            item.verificationCode = client.SendCode(item.phoneCountryCode + item.phoneNumber, "SMS",1);
            _repository.updateCode(item);
            
            item = _repository.get(item.userPhoneId);
            return new ObjectResult(item);
        }

        //verifyMobile
        [HttpPut("verify")]
        public bool verify([FromBody] UserPhone item, string enteredCode)
        {
            return _repository.verify(item.userPhoneId, enteredCode);
        }

        [HttpPut("resendCode")]
        public bool resendCode(int id)
        {
            bool result = false;
            var item = _repository.get(id);

            try
            {
                //send sms for verification
                TwilioClient client = new TwilioClient(_globalSettingRepository);
                item.verificationCode = client.SendCode(item.phoneCountryCode + item.phoneNumber, "SMS",1);
            }
            catch
            { }

            _repository.updateCode(item);

            return result;
        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] UserPhone item)
        {
            if (item == null || item.userPhoneId != id)
            {
                return BadRequest();
            }

            var userPhone = _repository.get(id);

            if ((userPhone.phoneCountryCode != item.phoneCountryCode || userPhone.phoneNumber != item.phoneNumber) || 
                    (userPhone.phoneName == item.phoneName && userPhone.phoneCountryCode == item.phoneCountryCode && userPhone.phoneNumber == item.phoneNumber && userPhone.verified == false))
            {
                item.verified = false;
                item.verificationCode = null;

                _repository.update(item);

                try
                {
                    //send sms for verification
                    TwilioClient client = new TwilioClient(_globalSettingRepository);
                    item.verificationCode = client.SendCode(item.phoneCountryCode + item.phoneNumber, "SMS", 1);
                }
                catch
                { }

                _repository.updateCode(item);
            }
            else
            {
                if (userPhone.phoneName != item.phoneName && userPhone.verified == true)
                {
                    _repository.updatePhoneName(item);
                }
                else
                {
                    throw new UserPhoneException(item.userPhoneId);
                }
            }

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }
    }
}

```
## UserRoleController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/user/role")]
    public class UserRoleController : Controller
    {

        public IUserRoleRepository _repository;
        private ILogger<UserRoleController> _logger;

        public UserRoleController(IUserRoleRepository repository, ILogger<UserRoleController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<UserRole> search(int userId = 0, int roleId = 0)
        {
            return _repository.search(userId, roleId);
        }

        [HttpGet("persontypes")]
        public IEnumerable<RolePersonType> searchPersonTypes(int userId = 0, int roleId = 0)
        {
            return _repository.searchPersonTypes(userId, roleId);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] UserRole item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }
        
        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }

    }
}

```
## ValuesController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class ValuesController : Controller
    {
        // GET: api/values
        [HttpGet]
        public IEnumerable<string> Get()
        {
            return new string[] { "value1", "value2" };
        }

        // GET api/values/5
        [HttpGet("{id}")]
        public string Get(int id)
        {
            return "value";
        }

        // POST api/values
        [HttpPost]
        public void Post([FromBody]string value)
        {
        }

        // PUT api/values/5
        [HttpPut("{id}")]
        public void Put(int id, [FromBody]string value)
        {
        }

        // DELETE api/values/5
        [HttpDelete("{id}")]
        public void Delete(int id)
        {
        }
    }
}

```
## VoucherController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using AT.AT2017.Api.Core.Models;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Validation;
using AT.AT2017.Api.Classes;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class VoucherController : Controller
    {
        public IVoucherRepository _repository;
        private ILogger<VoucherController> _logger;

        public VoucherController(IVoucherRepository repository, ILogger<VoucherController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpPut("validate")]
        public IActionResult validateModel([FromBody] Voucher item, bool ignoreDetail = false)
        {
            ModelState.Clear();
            if (TryValidateModel(item))
                return new NoContentResult();
            else
            {
                if (ignoreDetail == true) ModelState.Remove("detail");
                if (ModelState.ErrorCount == 0)
                    return new NoContentResult();
                else
                    return new ValidationFailedResult(ModelState);
            }
        }

        [HttpPut("validateDetail")]
        public IActionResult validateDetailModel([FromBody] VoucherDetail item)
        {
            ModelState.Clear();
            if (TryValidateModel(item))
                return new NoContentResult();
            else
            {
                return new ValidationFailedResult(ModelState);
            }
        }

        /// <summary>
        /// Returns a list of Voucher items.
        /// </summary>
        /// <remarks>
        /// Filters items by passed paramaters. 
        /// All parameters are optional.
        /// </remarks>
        /// <param name="personId"></param>
        /// <param name="propertyId"></param>
        /// <param name="orderTypeId"></param>
        /// <param name="personTypeId"></param>
        /// <param name="companyId"></param>
        /// <param name="posted"></param>
        /// <param name="paid"></param>
        /// <param name="fromDate"></param>
        /// <param name="toDate"></param>
        /// <param name="pageIndex"></param>
        /// <param name="pageSize"></param>
        /// <returns>All the documents which were found</returns>
        [HttpGet]
        public IEnumerable<Voucher> search(int companyId = 0, int personId = 0, int propertyId = 0, int orderTypeId = 0, int personTypeId = 0, string posted = "", string paid = "", decimal amount=0, string fromDate = "", string toDate = "", string memo = "", string isTemplate = "", string poNumber = "", int pageIndex = 0, int pageSize = 10, bool withTrash = false, string ids = "")
        {
            return _repository.search(companyId, personId, propertyId, orderTypeId, personTypeId, posted, paid,amount, fromDate, toDate,memo, isTemplate, poNumber, pageIndex, pageSize, withTrash, ids);
        }

        [HttpGet("deleted")]
        public IEnumerable<Voucher> searchDeletedRecord(int pageIndex = 0, int pageSize = 10)
        {
            return _repository.searchDeletedRecord(pageIndex, pageSize);
        }

        /// <summary>
        /// Returns a list of Voucher no paids.
        /// </summary>
        /// <remarks>
        /// Filters items by passed paramaters. 
        /// All parameters are optional.
        /// </remarks>
        /// <param name="companyId"></param>
        /// <param name="personId"></param>
        /// <param name="propertyId"></param>       
        /// <param name="fromDate"></param>
        /// <param name="toDate"></param>
        /// <param name="isForte"></param>
        /// <param name="officeId"></param>
        /// <param name="accountId"></param>
        /// <param name="includeColumns"></param>
        /// <param name="ignoreColumns"></param>
        /// <returns>All the documents which were found</returns>
        [HttpGet("searchNoPaids")]
        public IActionResult searchNoPaids(int companyId = 0, int propertyId = 0, int personId = 0, int voucherId = 0, string poNumber="", decimal amount = 0, string fromDate = "", string toDate = "", bool isForte = false, int officeId = 0, int accountId = 0, string includeColumns = null, string ignoreColumns = null)
        {
            IList<Voucher> vouchers = _repository.searchNoPaids(companyId, propertyId,personId,voucherId, poNumber,amount, fromDate, toDate,  isForte, officeId, accountId).ToList();

            return new CustomResult(vouchers, includeColumns?.Split(","), ignoreColumns?.Split(","));
        }

        /// <summary>
        /// Returns a list of Voucher no paids (paginated version)
        /// </summary>
        /// <remarks>
        /// Filters items by passed paramaters. 
        /// All parameters are optional.
        /// </remarks>     
        /// <param name="companyId"></param>
        /// <param name="personId"></param>
        /// <param name="propertyId"></param>       
        /// <param name="fromDate"></param>
        /// <param name="toDate"></param>       
        /// <param name="isForte"></param>
        /// <param name="officeId"></param>
        /// <param name="accountId"></param>
        /// <param name="includeColumns"></param>
        /// <param name="ignoreColumns"></param>
        /// <returns>All the documents which were found</returns>
        [HttpGet("nopaids/paginated")]
        public IActionResult searchNoPaidsPaginated(int companyId = 0, int propertyId = 0, int personId = 0, int voucherId = 0, string poNumber = "", decimal amount = 0, string fromDate = "", string toDate = "", bool isForte = false, int officeId = 0, int accountId = 0, string includeColumns = null, string ignoreColumns = null, int pageIndex = 0, int pageSize = 50, string sortBy = "", string filterBy = "")
        {
            var vouchers = _repository.searchNoPaidsPaginated(companyId, propertyId, personId, voucherId, poNumber, amount, fromDate, toDate, isForte, officeId, accountId, pageIndex, pageSize, sortBy,filterBy);

            return new CustomPagedResult<Voucher>(vouchers, includeColumns?.Split(","), ignoreColumns?.Split(","));
        }

        [HttpGet("searchVendorPONumber")]
        public int searchVendorPONumber( int voucherId = 0, int companyId = 0,int personId = 0, string poNumber = "" )
        {
            return _repository.searchVendorPONumber(voucherId,companyId, personId, poNumber);
        }

        /// <summary>
        /// Returns a specific Voucher item.
        /// </summary>
        /// <remarks>
        /// Find a Voucher item by ID
        /// </remarks>
        /// <param name="id">Voucher ID</param>
        /// <seealso cref="String">
        /// You can use the cref attribute on any tag to reference a type or member 
        /// and the compiler will check that the reference exists. </seealso>
        /// <returns>Voucher model in JSON format</returns>
        /// <response code="404">Not found</response>
        /// <response code="500">Internal Server Error</response>
        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        /// <summary>
        /// Create a new Voucher item.
        /// </summary>
        /// <param name="item"></param>
        [HttpPost]
        [ValidateModel]
        public IActionResult add([FromBody] Voucher item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPost("copy")]
        public IActionResult copy(int id)
        {            
             id = _repository.copy(id);

            var item = _repository.get(id);
            return new ObjectResult(item);
        }

        [HttpPost("reverse")]
        public IActionResult reverse(int id)
        {
            id = _repository.reverse(id);

            var item = _repository.get(id);
            return new ObjectResult(item);
        }

        /// <summary>
        /// Update a specific Voucher item.
        /// </summary>
        /// <param name="id">Voucher ID</param>
        /// <param name="item">Voucher model (JSON)</param>
        /// <response code="202">Not content</response>
        /// <response code="400">Bad request</response>
        /// <response code="404">Not found</response>
        /// <response code="500">Internal Server Error</response>
        [HttpPut("{id}")]
        [ValidateModel]
        public IActionResult update(int id, [FromBody] Voucher item)
        {
            if (item == null || item.voucherId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpPut("updateFlag1099")]
        public IActionResult updateFlag1099(int id, int flag1099, int personId)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.updateFlag1099(id, flag1099,personId);

            return new NoContentResult();
        }

        [HttpPut("updateAsTemplate")]
        public IActionResult updateAsTemplate([FromBody] Voucher item)
        {            
            _repository.updateAsTemplate(item);

            return new NoContentResult();
        }

        /// <summary>
        /// Deletes a specific Voucher item.
        /// </summary>
        /// <param name="id"></param>
        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }

        [HttpPut("post/{id}")]
        [ValidateModel]
        public IActionResult post(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.post(id);

            return new NoContentResult();
        }

        [HttpPut("unpost/{id}")]
        public IActionResult unpost(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.unpost(id);

            return new NoContentResult();
        }

        [HttpPut("pay/{id}")]
        public int pay(int id, [FromBody] VoucherPay item)
        {
            if (item == null || item.voucherId != id)
            {
                return -1;
            }            

          return   _repository.pay(item);
        }

        [HttpPut("reclassify/{id}")]
        public IActionResult reclassify(int id, [FromBody] Voucher item)
        {
            if (item == null || item.voucherId != id)
            {
                return BadRequest();
            }

            _repository.reclassify(item);

            return new NoContentResult();
        }

        /// <summary>
        /// Returns a list of payments of an Voucher items.
        /// </summary>
        /// <remarks>
        /// Filters items by passed paramaters. 
        /// All parameters are optional.
        /// </remarks>
        /// <param name="id"></param>     
        /// <returns>All the documents which were found</returns>
        [HttpGet("{id}/payments")]
        public IEnumerable<ApPaymentDetail> searchPayments(int id = 0)
        {
            return _repository.searchPayments(id);
        }

        [HttpGet("searchTemplates")]
        public IEnumerable<Voucher> searchTemplates(int companyId)
        {
            return _repository.searchTemplates(companyId);
        }

        [HttpPut("updateRecurring")]
        public IActionResult updateRecurring([FromBody] Voucher item)
        {
            _repository.updateRecurring(item);

            return new NoContentResult();
        }

        [HttpGet("postingPropertySummary")]
        public IEnumerable<Voucher> searchVouchersPostingPropertySummary(int propertyId)
        {
            return _repository.searchVouchersPostingPropertySummary(propertyId);
        }

    }
}

```
## VoucherDetailController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/voucher/detail")]
    public class VoucherDetailController : Controller
    {
        public IVoucherDetailRepository _repository;
        private ILogger<VoucherDetailController> _logger;

        public VoucherDetailController(IVoucherDetailRepository repository, ILogger<VoucherDetailController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<VoucherDetail> search(int voucherId = 0, int personId = 0, int agentId = 0, bool excludeCommission = false, string reimb = "", int expenseJobId = 0, int pageIndex = 0, int pageSize = 10, bool withTrash = false)
        {
            return _repository.search(voucherId, personId, agentId, reimb, excludeCommission, expenseJobId, pageIndex, pageSize, withTrash);
        }

        [HttpGet("divide")]
        public IEnumerable<VoucherDetail> divideByBillingGroup(int billingGroupId, int voucherID = 0, decimal amount = 0, int companyID = 0, int? accountID = null, string description = null)
        {
            return _repository.divideByBillingGroup(billingGroupId, voucherID, amount, companyID, accountID, description);
        }

    }
}

```
## VoucherScannedImageController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using AT.AT2017.Api.Core.Models;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Validation;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/voucher/scannedimage")]
    public class VoucherScannedImageController : Controller
    {
        public IVoucherScannedImageRepository _repository;
        private ILogger<VoucherScannedImageController> _logger;

        public VoucherScannedImageController(IVoucherScannedImageRepository repository, ILogger<VoucherScannedImageController> logger)
        {
            _repository = repository;
            _logger = logger;
        }
        
        [HttpGet]
        public IEnumerable<VoucherScannedImage> search(int voucherID)
        {
            return _repository.search(voucherID);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] VoucherScannedImage item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }
        
        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] VoucherScannedImage item)
        {
            if (item == null || item.scannedImageID != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }
    }
}

```
## VoucherScannedImageViewHistoryController.cs
```cs
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using System.Collections.Generic;
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Controllers
{
    [Route("api/voucher/scannedimage/history")]
    public class VoucherScannedImageViewHistoryController : Controller
    {
        public IVoucherScannedImageViewHistoryRepository _repository;

        private ILogger<VoucherScannedImageViewHistoryController> _logger;

        public VoucherScannedImageViewHistoryController(IVoucherScannedImageViewHistoryRepository repository, ILogger<VoucherScannedImageViewHistoryController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<VoucherScannedImage> search(int scannedImageID)
        {
            return _repository.search(scannedImageID);
        }

        [HttpPost]
        public IActionResult add([FromBody] VoucherScannedImage item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item.scannedImageID);

            //item = _repository.get(id);
            return new ObjectResult(item);

        }
    }
}
```
## WebhookController.cs
```cs
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Repositories;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Logging;

namespace AT.AT2017.Api.Controllers
{
    [Route("[controller]")]
    public class WebhookController : Controller
    {
        public IWebhookRepository _repository;
        private ILogger<WebhookController> _logger;

        public WebhookController(IWebhookRepository repository, ILogger<WebhookController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpPost("plaid/bankstream")]
        public void plaidWebhook([FromBody] PlaidWebhook item)
        {
            _repository.addPlaidWebhook(item);
        }


        [HttpPost("mx/bankstream")]
        public void mxWebhook([FromBody] object item)
        {
            dynamic dynamicItem = item;

            MxWebhook mxItem = new MxWebhook();
            mxItem.webhook_type = dynamicItem.type;
            mxItem.webhook_action = dynamicItem.action;
            mxItem.member_guid = dynamicItem.member_guid;
            mxItem.user_guid = dynamicItem.user_guid;

            if (((string)dynamicItem.type).ToUpper() == "AGGREGATION")
            {
                mxItem.transactions_created_count = dynamicItem.transactions_created_count;
                mxItem.transactions_updated_count = dynamicItem.transactions_updated_count;
                mxItem.user_id = dynamicItem.user_id;
            }

            if (((string)dynamicItem.type).ToUpper() == "CONNECTION_STATUS")
            {
                mxItem.connection_status = dynamicItem.connection_status;
            }

            _repository.addMxWebhook(mxItem);
        }

        [HttpGet("twilio/chat")]
        public void twilioWebhook([FromQuery] TwilioWebhook item)
        {
            _repository.addTwilioWebhook(item);
        }
    }

}
```
## ZipCodeController.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Core.Shared;

// For more information on enabling Web API for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Controllers
{
    [Route("api/[controller]")]
    public class ZipCodeController : Controller
    {
        public IZipCodeRepository _repository;

        private ILogger<ZipCodeController> _logger;

        public ZipCodeController(IZipCodeRepository repository, ILogger<ZipCodeController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<ZipCode> search(string state = "", string city = "", string county = "", string country = "", string zipCode = "", int pageIndex = 0, int pageSize = 10)
        {
            return _repository.search(state, city, county, country, zipCode, pageIndex, pageSize);
        }

        [HttpGet("search/paginated")]
        public PagedList<ZipCode> searchPaginated(string state = "", string city = "", string county = "", string country = "", string zipCode = "", int pageIndex = 1, int pageSize = 10)
        {
            return _repository.searchPaginated(state, city, county, country, zipCode, pageIndex, pageSize);
        }

        [HttpGet("states")]
        public IEnumerable<ZipCode> states()
        {
            return _repository.states();
        }

        [HttpGet("cities")]
        public IEnumerable<ZipCode> cities(string city)
        {
            return _repository.cities(city);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] ZipCode item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }
        
        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] ZipCode item)
        {
            if (item == null || item.zipCodeId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }

        [HttpDelete("{id}")]
        public IActionResult delete(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id);

            return new NoContentResult();

        }
    }
}

```
## AgentAssignmentController.cs
```cs
using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Logging;
using System.Collections.Generic;
using AT.AT2017.Api.Repositories.AgentBooks;
using AT.AT2017.Api.Core.Models.agentBooks;

namespace AT.AT2017.Api.Controllers.AgentBooks
{
    [Route("api/[controller]")]

    public class AgentAssignmentController : Controller
    {

        public IAgentAssignmentRepository _repository;

        private ILogger<AgentAssignmentController> _logger;

        public AgentAssignmentController(IAgentAssignmentRepository repository, ILogger<AgentAssignmentController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<AgentAssignments> search(int userID, int typeSearch = 0)
        {
            return _repository.search(userID, typeSearch);
        }

        [HttpGet("database")]
        public IEnumerable<AgentAssignments> search_database(int userID)
        {
            return _repository.search_database(userID);
        }

        [HttpGet("groupby")]
        public IEnumerable<AgentAssignments> search_groupBy_UserDatabase(int userID = 0, int databaseID = 0, int typeSearch=0)
        {
            return _repository.search_groupBy_UserDatabase(userID, databaseID, typeSearch);
        }

        [HttpPost]
        public IActionResult add([FromBody] AgentAssignments item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            return new NoContentResult();

        }

    }

}
```
## AgentBankAccountController.cs
```cs
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using System.Collections.Generic;
using AT.AT2017.Api.Repositories.AgentBooks;
using AT.AT2017.Api.Core.Models.agentBooks;

namespace AT.AT2017.Api.Controllers.AgentBooks
{
    [Route("api/[controller]")]

    public class AgentBankAccountController : Controller
    {
        public IAgentBankAccountRepository _repository;

        private ILogger<AgentBankAccountController> _logger;

        public AgentBankAccountController(IAgentBankAccountRepository repository, ILogger<AgentBankAccountController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<AgentBankAccount> search(int agentId = 0)
        {
            return _repository.search(agentId);
        }
    }
}

```
## AgentBankAccountTransactionController.cs
```cs
using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Logging;
using System.Collections.Generic;
using AT.AT2017.Api.Repositories.AgentBooks;
using AT.AT2017.Api.Core.Models.agentBooks;
using System.Data;

namespace AT.AT2017.Api.Controllers.AgentBooks
{
    [Route("api/[controller]")]
    public class AgentBankAccountTransactionController : Controller
    {

        public IAgentBankAccountTransactionRepository _repository;

        private ILogger<AgentBankAccountTransactionController> _logger;

        public AgentBankAccountTransactionController(IAgentBankAccountTransactionRepository repository, ILogger<AgentBankAccountTransactionController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<AgentBankAccountTransaction> search(int month, int year, int databaseID, int personID, int userID, string approved="", string excluded="", string databaseName = "", int bankAccountId =0)
        {
            return _repository.search(month, year, databaseID, personID, userID, approved,excluded, databaseName, bankAccountId);
        }

        [HttpGet("year")]
        public IEnumerable<AgentBankAccountTransaction> search_year()
        {
            return _repository.search_year();
        }

        [HttpGet("masterCategory")]
        public IEnumerable<AgentBankAccountTransaction> search_masterCategory(int categoryId)
        {
            return _repository.search_masterCategory(categoryId);
        }

        [HttpGet("fieldName")]
        public IEnumerable<AgentBankAccountTransaction> search_FieldName()
        {
            return _repository.search_FieldName();
        }

        [HttpGet("fieldName_value")]
        public IEnumerable<AgentBankAccountTransaction> search_FieldName_value(string fieldName)
        {
            return _repository.search_FieldName_value(fieldName);
        }


        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpGet("mergeFields_Value")]
        public DataTable get_mergeFields_values(int id)
        {
            return _repository.get_mergeFields_values(id);
        }

        [HttpPut("{id}")]
        public IActionResult update(int id, [FromBody] AgentBankAccountTransaction item)
        {
            if (item == null || item.transactionId != id)
            {
                return BadRequest();
            }

            var itemFound = _repository.get(id);
            if (itemFound == null)
            {
                return NotFound();
            }

            _repository.update(item);

            return new NoContentResult();
        }
    }

}
```
## AgentBankController.cs
```cs
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using System.Collections.Generic;
using AT.AT2017.Api.Repositories.AgentBooks;
using AT.AT2017.Api.Core.Models.agentBooks;

namespace AT.AT2017.Api.Controllers.AgentBooks
{
    [Route("api/[controller]")]

    public class AgentBankController : Controller
    {

        public IAgentBankRepository _repository;

        private ILogger<AgentBankController> _logger;

        public AgentBankController(IAgentBankRepository repository, ILogger<AgentBankController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<AgentBank> search(int agentId = 0)
        {
            return _repository.search(agentId);
        }

    }

}
```
## AgentCategoryController.cs
```cs
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using System.Collections.Generic;
using AT.AT2017.Api.Repositories.AgentBooks;
using AT.AT2017.Api.Core.Models.agentBooks;

namespace AT.AT2017.Api.Controllers.AgentBooks
{
    [Route("api/[controller]")]

    public class AgentCategoryController : Controller
    {

        public IAgentCategoryRepository _repository;

        private ILogger<AgentCategoryController> _logger;

        public AgentCategoryController(IAgentCategoryRepository repository, ILogger<AgentCategoryController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<AgentCategory> search(int agentID = 0, string type = "")
        {
            return _repository.search(agentID, type);
        }

        [HttpPut]
        public IActionResult addUpdate([FromBody] IEnumerable<AgentCategory> table, int agentID)
        {
            _repository.addUpdate(table, agentID);

            return new NoContentResult();
        }

    }

}
```
## AgentController.cs
```cs
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using System.Collections.Generic;
using AT.AT2017.Api.Repositories.AgentBooks;
using AT.AT2017.Api.Core.Models.agentBooks;

namespace AT.AT2017.Api.Controllers.AgentBooks
{
    [Route("api/[controller]")]

    public class AgentController : Controller
    {

        public IAgentRepository _repository;

        private ILogger<AgentController> _logger;

        public AgentController(IAgentRepository repository, ILogger<AgentController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<Agent> search(int databaseID = 0, string agent = "", int userID = 0, int companyID = 0, int pageIndex = 0, int pageSize = 10, string emailAddress = "",
                                            int agentID = 0, int categoryID = 0, int typeSearch = 0)
        {
            return _repository.search(databaseID,agent, userID, companyID, pageIndex, pageSize,emailAddress,agentID, categoryID, typeSearch);
        }

        [HttpGet("company")]
        public IEnumerable<Agent> search_company(int databaseID)
        {
            return _repository.search_company(databaseID);
        }

        [HttpGet("companyAllDarwin")]
        public IEnumerable<AgentAssignmentsDarwin> searchCompanyAllDarwin(string databaseName, string serverName, int databaseID, int companyID = 0, int officeID = 0, int personID = 0)
        {
            return _repository.searchCompanyAllDarwin(databaseName, serverName, databaseID, companyID, officeID, personID);
        }

        [HttpGet("companyDarwin")]
        public IEnumerable<AgentCompany> searchCompanyDarwin(string databaseName, string serverName)
        {
            return _repository.searchCompanyDarwin(databaseName, serverName);
        }

        [HttpGet("officeDarwin")]
        public IEnumerable<AgentOffice> searchOfficeDarwin(string databaseName, string serverName, int companyId = 0)
        {
            return _repository.searchOfficeDarwin(databaseName, serverName, companyId);
        }

        [HttpGet("agentDarwin")]
        public IEnumerable<AgentDarwin> searchAgentDarwin(string databaseName, string serverName, int officeId)
        {
            return _repository.searchAgentDarwin(databaseName, serverName, officeId);
        }

        [HttpGet("arPayments")]
        public IEnumerable<AgentArPayments> search_ArPayment(string databaseName, string serverName, int companyId = 0, int accountID = 0, int personId = 0, decimal amount = 0, string fromDate = "", string toDate = "", string posted = "", string deposited = "", int customerTypeId = 0, string method = "", int pageIndex = 0, int pageSize = 10, bool withTrash = false, int propertyId = 0, bool isAgentBook = true)
        {
            return _repository.search_ArPayment(databaseName, serverName, companyId, accountID, personId, amount, fromDate, toDate, posted, deposited, customerTypeId, method, pageIndex, pageSize, withTrash, propertyId, isAgentBook);
        }

        [HttpGet("apPayments")]
        public IEnumerable<AgentApPayments> search_ApPayment(string databaseName, string serverName, int companyId = 0, int personId = 0, int apPaymentId = 0, string checkNumber = "", decimal amount = 0, int accountId = 0, string posted = "", string cleared = "", string reconciled = "", string fromDate = "", string toDate = "", int propertyId = 0, string memo = "", int pageIndex = 0, int pageSize = 10, bool withTrash = false, bool isAgentBook = true)
        {
            return _repository.search_ApPayment(databaseName, serverName, companyId, personId, apPaymentId, checkNumber, amount, accountId, posted, fromDate, toDate, cleared, reconciled, propertyId, memo, pageIndex, pageSize, withTrash,isAgentBook );
        }

    }



}
```
## AgentMessageController.cs
```cs
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using System.Collections.Generic;
using AT.AT2017.Api.Repositories.AgentBooks;
using AT.AT2017.Api.Core.Models.agentBooks;

namespace AT.AT2017.Api.Controllers.AgentBooks
{
    [Route("api/[controller]")]

    public class AgentMessageController : Controller
    {

        public IAgentMessageRepository _repository;

        private ILogger<AgentMessageController> _logger;

        public AgentMessageController(IAgentMessageRepository repository, ILogger<AgentMessageController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<AgentMessage> search(int agentId, int transactionId = 0, int pageIndex = 1, int pageSize = 50, string order = "DESC")
        {
            return _repository.search(agentId, transactionId, pageIndex, pageSize, order);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult add([FromBody] AgentMessage item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            item = _repository.add(item);

            return new ObjectResult(item);

        }
    }
}
```
## ClassificationRuleController.cs
```cs
using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Logging;
using System.Collections.Generic;
using AT.AT2017.Api.Repositories.AgentBooks;
using AT.AT2017.Api.Core.Models.agentBooks;

namespace AT.AT2017.Api.Controllers.AgentBooks
{
    [Route("api/[controller]")]

    public class ClassificationRuleController : Controller
    {

        public IClassificationRuleRepository _repository;

        private ILogger<ClassificationRuleController> _logger;

        public ClassificationRuleController(IClassificationRuleRepository repository, ILogger<ClassificationRuleController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<ClassificationRule> search(int type = 0, string searchRule = "", int userId = 0)
        {
            return _repository.search(type, searchRule, userId);
        }

        [HttpPost("preview")]
        public IEnumerable<AgentBankAccountTransaction> search_preview([FromBody] ClassificationRule item)
        {
            return _repository.search_preview(item);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }
        
        [HttpPost]
        public IActionResult add([FromBody] ClassificationRule item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.add(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPost("apply")]
        public IActionResult apply([FromBody] ClassificationRule item)
        {
            _repository.apply(item);

            return new NoContentResult();

        }

        [HttpPost("preview_unapply")]
        public IEnumerable<AgentBankAccountTransaction> preview_unapply([FromBody] ClassificationRule item)
        {
            return _repository.preview_unapply (item);
        }

        [HttpPost("unapply")]
        public IActionResult unapply([FromBody] ClassificationRule item)
        {
            _repository.unapply(item);

            return new NoContentResult();

        }

        [HttpDelete("deleted")]
        public IActionResult delete(int id, string userName)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id, userName);

            return new NoContentResult();

        }

        [HttpGet("copy{id}")]
        public IActionResult copy(int id)
        {
            int ruleId = _repository.copy(id);

            ClassificationRule item = _repository.get(ruleId);

            if (item == null)
            {
                return BadRequest();
            }

            return new ObjectResult(item);
        }

    }



}
```
## MasterCategoryController.cs
```cs
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using System.Collections.Generic;
using AT.AT2017.Api.Repositories.AgentBooks;
using AT.AT2017.Api.Core.Models.agentBooks;

namespace AT.AT2017.Api.Controllers.AgentBooks
{
    [Route("api/[controller]")]

    public class MasterCategoryController : Controller
    {

        public IMasterCategoryRepository _repository;

        private ILogger<MasterCategoryController> _logger;

        public MasterCategoryController(IMasterCategoryRepository repository, ILogger<MasterCategoryController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<MasterCategory> search(string type = "")
        {
            return _repository.search(type);
        }

        [HttpGet("{id}")]
        public IActionResult get(int id)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }
            return new ObjectResult(item);
        }

        [HttpPost]
        public IActionResult addUpdate([FromBody] MasterCategory item)
        {
            if (item == null)
            {
                return BadRequest();
            }

            int id = _repository.addUpdate(item);

            item = _repository.get(id);
            return new ObjectResult(item);

        }

        [HttpPut]
        public IActionResult addUpdate([FromBody] IEnumerable<MasterCategory> table)
        {
            _repository.addUpdate(table);

            return new NoContentResult();
        }

        [HttpDelete("deleted")]
        public IActionResult delete(int id, string userName)
        {
            var item = _repository.get(id);
            if (item == null)
            {
                return NotFound();
            }

            _repository.delete(id, userName);

            return new NoContentResult();

        }
    }



}
```
## MessageTemplateController.cs
```cs
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Repositories;
using Microsoft.Extensions.Logging;
using System.Collections.Generic;
using AT.AT2017.Api.Repositories.AgentBooks;
using AT.AT2017.Api.Core.Models.agentBooks;

namespace AT.AT2017.Api.Controllers.AgentBooks
{
    [Route("api/[controller]")]

    public class MessageTemplateController : Controller
    {

        public IMessageTemplateRepository _repository;

        private ILogger<MessageTemplateController> _logger;

        public MessageTemplateController(IMessageTemplateRepository repository, ILogger<MessageTemplateController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<MessageTemplate> search()
        {
            return _repository.search();
        }

    }
}
```
## TransactionMappingController.cs
```cs
using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Logging;
using System.Collections.Generic;
using AT.AT2017.Api.Repositories.AgentBooks;
using AT.AT2017.Api.Core.Models.agentBooks;
using System;

namespace AT.AT2017.Api.Controllers.AgentBooks
{
    [Route("api/[controller]")]

    public class TransactionMappingController : Controller
    {
         public ITransactionMappingRepository _repository;

        private ILogger<TransactionMappingController> _logger;

        public TransactionMappingController(ITransactionMappingRepository repository, ILogger<TransactionMappingController> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        [HttpGet]
        public IEnumerable<TransactionMapping> search(int transactionId, int agentId, int apPaymentId)
        {
            return _repository.search(transactionId, agentId, apPaymentId);
        }

        [HttpPost]
        public IActionResult add([FromBody] TransactionMapping item)
        {
            if (item == null)
            {
                return BadRequest();
            }

             _repository.add(item);

            return new NoContentResult();

        }

        [HttpDelete("deleted")]
        public IActionResult delete(int transactionId = 0, int apPaymentId = 0)
        {
            _repository.delete(transactionId, apPaymentId);

            return new NoContentResult();

        }
    }
}
```
## 1099ReconciliationDynamicParameter.cs
```cs
using Dapper;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using System.Data;
using AT.AT2017.Api.Core.Models;
using System.Data.SqlClient;
using Microsoft.SqlServer.Server;

namespace AT.AT2017.Api.DynamicParameters
{
    public class _1099ReconciliationDynamicParameter : SqlMapper.IDynamicParameters
    {
        private readonly _1099Reconciliation _reconciliation;

        public _1099ReconciliationDynamicParameter(_1099Reconciliation reconciliation)
        {
            _reconciliation = reconciliation;
        }

        void SqlMapper.IDynamicParameters.AddParameters(IDbCommand command, SqlMapper.Identity identity)
        {
            SqlParameter p;
            var sqlCommand = (SqlCommand)command;
            sqlCommand.CommandType = CommandType.StoredProcedure;

            p = sqlCommand.Parameters.Add("@reconciliationId", SqlDbType.Int);
            p.Value = _reconciliation.reconciliationId;
            p = sqlCommand.Parameters.Add("@reconciled", SqlDbType.Bit);
            p.Value = _reconciliation.reconciled;           
           // detail
            p = sqlCommand.Parameters.Add("@detail", SqlDbType.Structured);
            p.Direction = ParameterDirection.Input;
            p.TypeName = "1099reconciliationDetailTableType";
            p.Value = mapReconciliationDetail(_reconciliation.detail);
        }

        protected List<SqlDataRecord> mapReconciliationDetail(IEnumerable<_1099ReconciliationDetail> detail)
        {
            SqlMetaData[] tvpReconciliationDetail =
            {
                new SqlMetaData("reconciliationDetailID", SqlDbType.Int),
                new SqlMetaData("reconciliationID", SqlDbType.Int), 
                new SqlMetaData("alternateAmount", SqlDbType.Decimal, 18, 2),
                new SqlMetaData("excluded", SqlDbType.Bit),
                new SqlMetaData("corrected", SqlDbType.Bit)
            };

            List<SqlDataRecord> records = new List<SqlDataRecord>();

            foreach (_1099ReconciliationDetail itemDetail in detail)
            {
                var record = new SqlDataRecord(tvpReconciliationDetail);

                record.SetInt32(0, itemDetail.reconciliationDetailId);
                record.SetInt32(1, itemDetail.reconciliationId);  
                if (itemDetail.alternateAmount.GetValueOrDefault() > 0)
                {
                    record.SetDecimal(2, itemDetail.alternateAmount.GetValueOrDefault());
                }
                record.SetSqlBoolean(3, itemDetail.excluded);
                record.SetSqlBoolean(4, itemDetail.corrected);
                records.Add(record);
            }

            return records;
        }

    }
}

```
## ActionHelpArticleDynamicParameter.cs
```cs
using AT.AT2017.Api.Core.Models;
using Dapper;
using Microsoft.SqlServer.Server;
using System.Collections.Generic;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.DynamicParameters
{
    public class ActionHelpArticleDynamicParameter : SqlMapper.IDynamicParameters
    {
        private readonly IEnumerable<HelpArticle> _articles;
        private int _actionId;

        public ActionHelpArticleDynamicParameter(IEnumerable<HelpArticle> articles, int actionId)
        {
            _articles = articles;
            _actionId = actionId;
        }

        void SqlMapper.IDynamicParameters.AddParameters(IDbCommand command, SqlMapper.Identity identity)
        {
            SqlParameter p;
            var sqlCommand = (SqlCommand)command;
            sqlCommand.CommandType = CommandType.StoredProcedure;

            p = sqlCommand.Parameters.Add("@actionID", SqlDbType.Int);
            p.Value = _actionId;

            // articles
            p = sqlCommand.Parameters.Add("@articles", SqlDbType.Structured);
            p.Direction = ParameterDirection.Input;
            p.TypeName = "helpArticleTableType";
            List<HelpArticle> articles = (List<HelpArticle>)_articles;
            if (articles.Count > 0)
            {
                p.Value = mapArticles(articles);
            }
            else
            {
                p.Value = null;
            }
        }
        protected List<SqlDataRecord> mapArticles(IEnumerable<HelpArticle> articles)
        {
            SqlMetaData[] tvp =
            {
                new SqlMetaData("articleID", SqlDbType.Int),
                new SqlMetaData("title", SqlDbType.VarChar, 100),
                new SqlMetaData("sortOrder", SqlDbType.Int),
            };

            List<SqlDataRecord> list = new List<SqlDataRecord>();

            foreach (HelpArticle article in articles)
            {
                var record = new SqlDataRecord(tvp);
                record.SetInt32(0, article.articleID);
                if (article.title != null)
                {
                    record.SetString(1, article.title);
                }
                if (article.sortOrder != null)
                {
                    record.SetInt32(2, article.sortOrder.Value);
                }

                list.Add(record);
            }

            return list;
        }
    }
}

```
## ActionSettingDynamicParameter.cs
```cs
using Dapper;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using System.Data;
using AT.AT2017.Api.Core.Models;
using System.Data.SqlClient;
using Microsoft.SqlServer.Server;

namespace AT.AT2017.Api.DynamicParameters
{
    public class ActionSettingsDynamicParameter : SqlMapper.IDynamicParameters
    {

        private readonly IEnumerable<Setting> _settings;
        private int _actionId;

        public ActionSettingsDynamicParameter(IEnumerable<Setting> settings, int actionId)
        {
            _settings = settings;
            _actionId = actionId;
        }
        
        void SqlMapper.IDynamicParameters.AddParameters(IDbCommand command, SqlMapper.Identity identity)
        {
            SqlParameter p;
            var sqlCommand = (SqlCommand)command;
            sqlCommand.CommandType = CommandType.StoredProcedure;

            p = sqlCommand.Parameters.Add("@actionID", SqlDbType.Int);
            p.Value = _actionId;

            // settings
            p = sqlCommand.Parameters.Add("@settings", SqlDbType.Structured);
            p.Direction = ParameterDirection.Input;
            p.TypeName = "settingTableType";
            List<Setting> settings = (List<Setting>)_settings;
            if (settings.Count > 0)
            {
                p.Value = mapSettings(_settings);
            }
            else
            {
                p.Value = null;
            }           
        }
        
        protected List<SqlDataRecord> mapSettings(IEnumerable<Setting> settings)
        {
            SqlMetaData[] tvp =
            {
                new SqlMetaData("settingID", SqlDbType.Int),
                new SqlMetaData("name", SqlDbType.VarChar, 100),
            };

            List<SqlDataRecord> list = new List<SqlDataRecord>();

            foreach (Setting setting in settings)
            {
                var record = new SqlDataRecord(tvp);
                record.SetInt32(0, setting.settingId);
                if (setting.name != null)
                {
                    record.SetString(1, setting.name);
                }

                list.Add(record);
            }

            return list;
        }
    }
}

```
## ApPaymentDynamicParameter.cs
```cs
using Dapper;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using System.Data;
using AT.AT2017.Api.Core.Models;
using System.Data.SqlClient;
using Microsoft.SqlServer.Server;

namespace AT.AT2017.Api.DynamicParameters
{
    public class ApPaymentDynamicParameter : SqlMapper.IDynamicParameters
    {
        private readonly ApPayment _appayment;

        public ApPaymentDynamicParameter(ApPayment appayment)
        {
            _appayment = appayment;
        }

        void SqlMapper.IDynamicParameters.AddParameters(IDbCommand command, SqlMapper.Identity identity)
        {
            SqlParameter p;
            var sqlCommand = (SqlCommand)command;
            sqlCommand.CommandType = CommandType.StoredProcedure;

            p = sqlCommand.Parameters.Add("@apPaymentID", SqlDbType.Int);
            p.Value = _appayment.apPaymentId;
            p = sqlCommand.Parameters.Add("@bankAccountID", SqlDbType.Int);
            p.Value = _appayment.bankAccountId;
            p = sqlCommand.Parameters.Add("@accountId", SqlDbType.Int);
            p.Value = _appayment.accountId;
            p = sqlCommand.Parameters.Add("@personId", SqlDbType.Int);
            p.Value = _appayment.personId;
            p = sqlCommand.Parameters.Add("@datePaid", SqlDbType.DateTime);
            p.Value = _appayment.datePaid;
            p = sqlCommand.Parameters.Add("@creditAmount", SqlDbType.Decimal);
            p.Value = _appayment.creditAmount;
            p = sqlCommand.Parameters.Add("@description", SqlDbType.VarChar, 200);
            p.Value = _appayment.description;
            p = sqlCommand.Parameters.Add("@void", SqlDbType.Bit);
            p.Value = _appayment.isVoid;
            p = sqlCommand.Parameters.Add("@bankRecID", SqlDbType.Int);
            p.Value = _appayment.bankRecId;
            p = sqlCommand.Parameters.Add("@clearRef", SqlDbType.VarChar, 10);
            p.Value = _appayment.clearRef;
            p = sqlCommand.Parameters.Add("@cleared", SqlDbType.Bit);
            p.Value = _appayment.cleared;
            p = sqlCommand.Parameters.Add("@checkNumber", SqlDbType.VarChar, 100);
            p.Value = _appayment.checkNumber;
            p = sqlCommand.Parameters.Add("@companyId", SqlDbType.Int);
            p.Value = _appayment.companyId;
            p = sqlCommand.Parameters.Add("@checkTemplateID", SqlDbType.Int);
            if (_appayment.checkTemplateId.GetValueOrDefault() > 0)
            {
                p.Value = _appayment.checkTemplateId;
            }
            p = sqlCommand.Parameters.Add("@paidByNacha", SqlDbType.Bit);
            p.Value = _appayment.paidByNacha;

            // detail
            p = sqlCommand.Parameters.Add("@detail", SqlDbType.Structured);
            p.Direction = ParameterDirection.Input;
            p.TypeName = "apPaymentDetailTableType";
            p.Value = mapApPaymentDetail(_appayment.detail);

        }


        protected List<SqlDataRecord> mapApPaymentDetail(IEnumerable<ApPaymentDetail> detail)
        {
            SqlMetaData[] tvpApPaymentDetail =
            {
                new SqlMetaData("apPaymentDetailId", SqlDbType.Int),
                new SqlMetaData("apPaymentId", SqlDbType.Int),
                new SqlMetaData("voucherId", SqlDbType.Int),
                new SqlMetaData("paymentAmount", SqlDbType.Decimal, 18, 2),
                new SqlMetaData("propertyId", SqlDbType.Int),
                new SqlMetaData("locked", SqlDbType.Bit),
            };

            List<SqlDataRecord> records = new List<SqlDataRecord>();

            foreach (ApPaymentDetail itemDetail in detail)
            {
                var record = new SqlDataRecord(tvpApPaymentDetail);

                record.SetInt32(0, itemDetail.apPaymentDetailId);
                record.SetInt32(1, itemDetail.apPaymentId.GetValueOrDefault());
                record.SetInt32(2, itemDetail.voucherId.GetValueOrDefault());
                record.SetDecimal(3, itemDetail.paymentAmount);
                if (itemDetail.propertyId.GetValueOrDefault() > 0)
                {
                    record.SetInt32(4, itemDetail.propertyId.GetValueOrDefault());
                }                
                record.SetSqlBoolean(5, itemDetail.locked.GetValueOrDefault());

                records.Add(record);

            }

            return records;
        }

    }
}

```
## ArPaymentDynamicParameter.cs
```cs
using Dapper;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using System.Data;
using AT.AT2017.Api.Core.Models;
using System.Data.SqlClient;
using Microsoft.SqlServer.Server;

namespace AT.AT2017.Api.DynamicParameters
{
    public class ArPaymentDynamicParameter : SqlMapper.IDynamicParameters
    {

        private readonly ArPayment _arpayment;

        public ArPaymentDynamicParameter(ArPayment arpayment)
        {
            _arpayment = arpayment;
        }

        void SqlMapper.IDynamicParameters.AddParameters(IDbCommand command, SqlMapper.Identity identity)
        {
            SqlParameter p;
            var sqlCommand = (SqlCommand)command;
            sqlCommand.CommandType = CommandType.StoredProcedure;

            p = sqlCommand.Parameters.Add("@arPaymentID", SqlDbType.Int);
            p.Value = _arpayment.arPaymentId;
            p = sqlCommand.Parameters.Add("@accountId", SqlDbType.Int);
            p.Value = _arpayment.accountId;
            p = sqlCommand.Parameters.Add("@personId", SqlDbType.Int);
            p.Value = _arpayment.personId;
            p = sqlCommand.Parameters.Add("@datePaid", SqlDbType.DateTime);
            p.Value = _arpayment.datePaid;
            p = sqlCommand.Parameters.Add("@paymentMethod", SqlDbType.VarChar, 20);
            p.Value = _arpayment.paymentMethod;
            p = sqlCommand.Parameters.Add("@creditAmount", SqlDbType.Decimal);
            p.Value = _arpayment.creditAmount;
            p = sqlCommand.Parameters.Add("@escrowBankAccountID", SqlDbType.Int);
            p.Value = _arpayment.escrowBankAccountID;
            p = sqlCommand.Parameters.Add("@companyID", SqlDbType.Int);
            p.Value = _arpayment.companyId;
            p = sqlCommand.Parameters.Add("@paidByNacha", SqlDbType.Bit);
            p.Value = _arpayment.paidByNacha;
            p = sqlCommand.Parameters.Add("@checkNumber", SqlDbType.VarChar, 20);
            p.Value = _arpayment.checkNumber;
            p = sqlCommand.Parameters.Add("@paymentMemo", SqlDbType.VarChar, 500);
            p.Value = _arpayment.paymentMemo;
            // detail
            p = sqlCommand.Parameters.Add("@detail", SqlDbType.Structured);
            p.Direction = ParameterDirection.Input;
            p.TypeName = "arPaymentDetailTableType";
            p.Value = mapArPaymentDetail(_arpayment.detail);
        }

        protected List<SqlDataRecord> mapArPaymentDetail(IEnumerable<ArPaymentDetail> detail)
        {
            SqlMetaData[] tvpArPaymentDetail =
            {
                new SqlMetaData("arPaymentDetailId", SqlDbType.Int),
                new SqlMetaData("arPaymentId", SqlDbType.Int),
                new SqlMetaData("invoiceId", SqlDbType.Int),
                new SqlMetaData("paymentAmount", SqlDbType.Decimal , 18, 2),
                new SqlMetaData("propertyId", SqlDbType.Int),
                new SqlMetaData("locked", SqlDbType.Bit),
            };

            List<SqlDataRecord> records = new List<SqlDataRecord>();

            foreach (ArPaymentDetail itemDetail in detail)
            {
                var record = new SqlDataRecord(tvpArPaymentDetail);

                record.SetInt32(0, itemDetail.arPaymentDetailId);
                record.SetInt32(1, itemDetail.arPaymentId);
                record.SetInt32(2, itemDetail.invoiceId);
                record.SetDecimal(3, itemDetail.paymentAmount);
                if  (itemDetail.propertyId != null)
                {
                    record.SetInt32(4, (int)itemDetail.propertyId);
                }
                record.SetSqlBoolean(5, itemDetail.locked);
                
                records.Add(record);

            }

            return records;
        }


    }
}

```
## BankAccountDynamicParameter.cs
```cs
using AT.AT2017.Api.Core.Models;
using Dapper;
using Microsoft.SqlServer.Server;
using System.Collections.Generic;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.DynamicParameters
{
    public class BankAccountDynamicParameter : SqlMapper.IDynamicParameters
    {
        private readonly string _itemId;
        private readonly string _institutionId;
        private readonly string _accessToken;
        private readonly string _bankName;
        private readonly string _platform;
        private readonly IEnumerable<BankAccount> _accounts;

        public BankAccountDynamicParameter(string itemId, string institutionId, string accessToken, string bankName, string platform, IEnumerable<BankAccount> accounts)
        {
            _itemId = itemId;
            _institutionId = institutionId;
            _accessToken = accessToken;
            _accounts = accounts;
            _bankName = bankName;
            _platform = platform;
        }

        void SqlMapper.IDynamicParameters.AddParameters(IDbCommand command, SqlMapper.Identity identity)
        {
            SqlParameter p;
            var sqlCommand = (SqlCommand)command;
            sqlCommand.CommandType = CommandType.StoredProcedure;
        
            p = sqlCommand.Parameters.Add("@item_id", SqlDbType.VarChar, 300);
            p.Value = _itemId;

            p = sqlCommand.Parameters.Add("@institution_id", SqlDbType.VarChar, 100);
            p.Value = _institutionId;

            p = sqlCommand.Parameters.Add("@access_token", SqlDbType.VarChar, 500);
            p.Value = _accessToken;

            p = sqlCommand.Parameters.Add("@bankName", SqlDbType.VarChar, 200);
            p.Value = _bankName;

            p = sqlCommand.Parameters.Add("@platform", SqlDbType.VarChar, 10);
            p.Value = _platform;

            p = sqlCommand.Parameters.Add("@accounts", SqlDbType.Structured);
            p.Direction = ParameterDirection.Input;
            p.TypeName = "bankAccountTableType";
            p.Value = mapBankAccounts(_accounts);

        }


        protected List<SqlDataRecord> mapBankAccounts(IEnumerable<BankAccount> accounts)
        {
            SqlMetaData[] tvp =
            {
                new SqlMetaData("bankAccountID", SqlDbType.Int), // 0
                new SqlMetaData("accountName", SqlDbType.VarChar, 500), // 1
                new SqlMetaData("accountNumber", SqlDbType.VarChar, 100), // 2
                new SqlMetaData("officialName", SqlDbType.VarChar, 100), // 3
                new SqlMetaData("type", SqlDbType.VarChar, 50), // 4
                new SqlMetaData("bankID", SqlDbType.Int), // 5
                new SqlMetaData("balance", SqlDbType.Decimal, 18, 2), // 6
                new SqlMetaData("isConnected", SqlDbType.Bit), // 7
                new SqlMetaData("linkedAccountID", SqlDbType.Int), // 8
                new SqlMetaData("companyID", SqlDbType.Int), // 9 
                new SqlMetaData("fromDate", SqlDbType.DateTime), // 10
                new SqlMetaData("lastCheckDate", SqlDbType.DateTime), // 11
                new SqlMetaData("mask", SqlDbType.VarChar, 20) // 12
            };

            List<SqlDataRecord> list = new List<SqlDataRecord>();

            foreach (BankAccount account in accounts)
            {
                var record = new SqlDataRecord(tvp);

                // 0 - bankAccountID
                record.SetString(1, account.accountName);
                record.SetString(2, account.accountNumber);
                if (account.officialName != null)
                    record.SetString(3, account.officialName);
                record.SetString(4, account.type);
                // 5 - bankID
                record.SetDecimal(6, account.balance);
                record.SetBoolean(7, account.isConnected);
                record.SetInt32(8, account.linkedAccountID);
                record.SetInt32(9, account.companyId);
                if (account.fromDate != null)
                    record.SetDateTime(10, account.fromDate.GetValueOrDefault());
                // 11. lastCheckDate
                if (account.mask != null)
                    record.SetString(12, account.mask);

                list.Add(record);
            }

            return list;
        }
    }
}

```
## BankReconciliationDynamicParameter.cs
```cs
using AT.AT2017.Api.Core.Models;
using Dapper;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using System.Data;
using System.Data.SqlClient;
using Microsoft.SqlServer.Server;

namespace AT.AT2017.Api.DynamicParameters
{
    public class BankReconciliationDynamicParameter : SqlMapper.IDynamicParameters
    {
        private readonly BankReconciliation _bankreconciliation;      

        public BankReconciliationDynamicParameter(BankReconciliation bankreconciliation)
        {
            _bankreconciliation = bankreconciliation;          
        }

        void SqlMapper.IDynamicParameters.AddParameters(IDbCommand command, SqlMapper.Identity identity)
        {
            SqlParameter p;
            var sqlCommand = (SqlCommand)command;
            sqlCommand.CommandType = CommandType.StoredProcedure;

            p = sqlCommand.Parameters.Add("@bankRecID", SqlDbType.Int);
            p.Value = _bankreconciliation.bankRecId;
            p = sqlCommand.Parameters.Add("@companyId", SqlDbType.Int);
            p.Value = _bankreconciliation.companyId;
            p = sqlCommand.Parameters.Add("@accountId", SqlDbType.Int);
            p.Value = _bankreconciliation.accountId;
            p = sqlCommand.Parameters.Add("@startingBalance", SqlDbType.Decimal);
            p.Value = _bankreconciliation.startingBalance;
            p = sqlCommand.Parameters.Add("@endingBalance", SqlDbType.Decimal);
            p.Value = _bankreconciliation.endingBalance;
            p = sqlCommand.Parameters.Add("@toDate", SqlDbType.DateTime);
            p.Value = _bankreconciliation.toDate;
            p = sqlCommand.Parameters.Add("@reconciled", SqlDbType.Bit);
            p.Value = _bankreconciliation.reconciled;           
            // detail
            p = sqlCommand.Parameters.Add("@detail", SqlDbType.Structured);
            p.Direction = ParameterDirection.Input;
            p.TypeName = "bankReconciliationDetailTableType";
          
            List<BankReconciliationDetail> detail = (List<BankReconciliationDetail>)_bankreconciliation.detail;
            if (detail.Count > 0)
            {
                p.Value = mapBankReconciliationDetail(_bankreconciliation.detail);
            }
            else
            {
                p.Value = null;
            }
        }

        protected List<SqlDataRecord> mapBankReconciliationDetail(IEnumerable<BankReconciliationDetail> detail)
        {
            SqlMetaData[] tvp =
            {
                new SqlMetaData("reconciliationDetailID", SqlDbType.Int),
                new SqlMetaData("bankRecID", SqlDbType.Int),
                new SqlMetaData("recordType", SqlDbType.VarChar, 20),
                new SqlMetaData("recordID", SqlDbType.Int),
                new SqlMetaData("cleared", SqlDbType.Bit),
                new SqlMetaData("clearRef", SqlDbType.VarChar,100),
                new SqlMetaData("checkNumber", SqlDbType.VarChar,100),
                new SqlMetaData("description", SqlDbType.VarChar,500),
                new SqlMetaData("bankDate", SqlDbType.DateTime),              
                new SqlMetaData("checkAmount", SqlDbType.Decimal,18,2),
                new SqlMetaData("depositAmount", SqlDbType.Decimal,18,2)
            };

            List<SqlDataRecord> bankReconciliationDetail = new List<SqlDataRecord>();

            foreach (BankReconciliationDetail itemDetail in detail)
            {
                var record = new SqlDataRecord(tvp);
                record.SetInt32(0, itemDetail.reconciliationDetailID);
                record.SetInt32(1, itemDetail.bankRecID);
                record.SetString(2, itemDetail.recordType);
                record.SetInt32(3, itemDetail.recordID);
                record.SetBoolean(4, itemDetail.cleared);
                if (itemDetail.clearRef != null)
                       record.SetString(5, itemDetail.clearRef);
                if (itemDetail.checkNumber != null)
                    record.SetString(6, itemDetail.checkNumber);
                if (itemDetail.description != null)
                    record.SetString(7, itemDetail.description);
                record.SetDateTime(8, itemDetail.bankDate.GetValueOrDefault());
                record.SetDecimal(9, itemDetail.checkAmount);
                record.SetDecimal(10, itemDetail.depositAmount);
                bankReconciliationDetail.Add(record);
            }

            return bankReconciliationDetail;
        }


    }
}

```
## BankTransactionPostDynamicParameter.cs
```cs
using Dapper;
using System.Collections.Generic;
using AT.AT2017.Api.Core.Models;
using System.Data;
using System.Data.SqlClient;
using Microsoft.SqlServer.Server;

namespace AT.AT2017.Api.DynamicParameters
{
    public class BankTransactionPostDynamicParameter : SqlMapper.IDynamicParameters
    {
        private readonly IEnumerable<BankTransaction> _transactions;

        public BankTransactionPostDynamicParameter(IEnumerable<BankTransaction> transactions)
        {
            _transactions = transactions;
        }

        void SqlMapper.IDynamicParameters.AddParameters(IDbCommand command, SqlMapper.Identity identity)
        {
            SqlParameter p;
            var sqlCommand = (SqlCommand)command;
            sqlCommand.CommandType = CommandType.StoredProcedure;

            p = sqlCommand.Parameters.Add("@transactions", SqlDbType.Structured);
            p.Direction = ParameterDirection.Input;
            p.TypeName = "bankTransactionTableType";
            p.Value = mapBankTransactions(_transactions);

        }

        protected List<SqlDataRecord> mapBankTransactions(IEnumerable<BankTransaction> bankTransactions)
        {
            SqlMetaData[] tvp =
            {
                new SqlMetaData("transactionID", SqlDbType.Int),
                new SqlMetaData("date", SqlDbType.DateTime),
                new SqlMetaData("description", SqlDbType.VarChar, 1000),
                new SqlMetaData("amount", SqlDbType.Decimal),
                new SqlMetaData("bankAccountID", SqlDbType.Int),
                new SqlMetaData("linkedAccountID", SqlDbType.Int),
                new SqlMetaData("linkedOfficeID", SqlDbType.Int),
                new SqlMetaData("linkedDivisionID", SqlDbType.Int),
                new SqlMetaData("linkedPersonID", SqlDbType.Int),
                new SqlMetaData("approved", SqlDbType.Bit),
                new SqlMetaData("approvedDate", SqlDbType.DateTime),
                new SqlMetaData("posted", SqlDbType.Bit),
                new SqlMetaData("postedDate", SqlDbType.DateTime),
                new SqlMetaData("journalID", SqlDbType.Int),
                new SqlMetaData("voucherID", SqlDbType.Int),
            };

            List<SqlDataRecord> list = new List<SqlDataRecord>();

            foreach (BankTransaction bankTransaction in bankTransactions)
            {
                var record = new SqlDataRecord(tvp);
                record.SetInt32(0, bankTransaction.transactionID);
                list.Add(record);
            }

            return list;
        }

    }
}

```
## BankTransactionSplitDynamicParameter.cs
```cs
using AT.AT2017.Api.Core.Models;
using Dapper;
using Microsoft.SqlServer.Server;
using System;
using System.Collections.Generic;
using System.Data;
using System.Data.SqlClient;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.DynamicParameters
{
    public class BankTransactionSplitDynamicParameter : SqlMapper.IDynamicParameters
    {
        private readonly int _transactionID;
        private readonly IEnumerable<BankTransaction> _childTransactions;
        private readonly bool _createAsRule;
        private readonly string _memo;

        public BankTransactionSplitDynamicParameter(int transactionID, IEnumerable<BankTransaction> childTransactions, bool createAsRule, string memo)
        {
            _transactionID = transactionID;
            _childTransactions = childTransactions;
            _createAsRule = createAsRule;
            _memo = memo;
        }

        void SqlMapper.IDynamicParameters.AddParameters(IDbCommand command, SqlMapper.Identity identity)
        {
            SqlParameter p;
            var sqlCommand = (SqlCommand)command;
            sqlCommand.CommandType = CommandType.StoredProcedure;

            p = sqlCommand.Parameters.Add("transactionID", SqlDbType.Int);
            p.Value = _transactionID;

            p = sqlCommand.Parameters.Add("@childTransactions", SqlDbType.Structured);
            p.Direction = ParameterDirection.Input;
            p.TypeName = "bankTransactionTableType";
            p.Value = mapChildTransactions(_childTransactions);

            p = sqlCommand.Parameters.Add("createAsRule", SqlDbType.Bit);
            p.Value = _createAsRule;

            p = sqlCommand.Parameters.Add("memo", SqlDbType.VarChar,500);
            p.Value = _memo;
        }

        protected List<SqlDataRecord> mapChildTransactions(IEnumerable<BankTransaction> bankTransactions)
        {
            SqlMetaData[] tvp =
            {
                new SqlMetaData("transactionID", SqlDbType.Int),
                new SqlMetaData("date", SqlDbType.DateTime),
                new SqlMetaData("description", SqlDbType.VarChar, 1000),
                new SqlMetaData("amount", SqlDbType.Decimal, 18, 2),
                new SqlMetaData("bankAccountID", SqlDbType.Int),
                new SqlMetaData("linkedAccountID", SqlDbType.Int),
                new SqlMetaData("linkedOfficeID", SqlDbType.Int),
                new SqlMetaData("linkedDivisionID", SqlDbType.Int),
                new SqlMetaData("linkedPersonID", SqlDbType.Int),
                new SqlMetaData("approved", SqlDbType.Bit),
                new SqlMetaData("approvedDate", SqlDbType.DateTime),
                new SqlMetaData("posted", SqlDbType.Bit),
                new SqlMetaData("postedDate", SqlDbType.DateTime),
                new SqlMetaData("journalID", SqlDbType.Int),
                new SqlMetaData("voucherID", SqlDbType.Int),
            };

            List<SqlDataRecord> list = new List<SqlDataRecord>();

            foreach (BankTransaction bankTransaction in bankTransactions)
            {
                var record = new SqlDataRecord(tvp);
                // transactionID
                record.SetInt32(0, bankTransaction.transactionID);
                // description
                record.SetString(2, bankTransaction.description);
                // amount
                record.SetDecimal(3, bankTransaction.amount);
                // accountId
                record.SetInt32(5, bankTransaction.linkedAccountID.GetValueOrDefault());
                // officeId
                if (bankTransaction.linkedOfficeID != null)
                    record.SetInt32(6, bankTransaction.linkedOfficeID.GetValueOrDefault());
                // divisionId
                if (bankTransaction.linkedDivisionID != null)
                    record.SetInt32(7, bankTransaction.linkedDivisionID.GetValueOrDefault());
                // personId
                if (bankTransaction.linkedPersonID != null)
                    record.SetInt32(8, bankTransaction.linkedPersonID.GetValueOrDefault());
                list.Add(record);
            }

            return list;
        }

    }
}

```
## BillingGroupOfficeDynamicParameter.cs
```cs
using Dapper;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using System.Data;
using AT.AT2017.Api.Core.Models;
using System.Data.SqlClient;
using Microsoft.SqlServer.Server;

namespace AT.AT2017.Api.DynamicParameters
{
    public class BillingGroupOfficeDynamicParameter : SqlMapper.IDynamicParameters
    {

        private readonly BillingGroup _billingGroup;
        private string _option;

        public BillingGroupOfficeDynamicParameter(BillingGroup billingGroup,string option)
        {
            _billingGroup = billingGroup;
            _option = option;
        }

        void SqlMapper.IDynamicParameters.AddParameters(IDbCommand command, SqlMapper.Identity identity)
        {
            SqlParameter p;
            var sqlCommand = (SqlCommand)command;
            sqlCommand.CommandType = CommandType.StoredProcedure;

            p = sqlCommand.Parameters.Add("@id", SqlDbType.Int);
            p.Value = _billingGroup.billingGroupId;
            p = sqlCommand.Parameters.Add("@name", SqlDbType.VarChar, 500);
            p.Value = _billingGroup.name;
            p = sqlCommand.Parameters.Add("@companyId", SqlDbType.Int);
            p.Value = _billingGroup.companyId;
            p = sqlCommand.Parameters.Add("@option", SqlDbType.VarChar, 10);
            p.Value = _option;
            // detail
            p = sqlCommand.Parameters.Add("@detail", SqlDbType.Structured);
            p.Direction = ParameterDirection.Input;
            p.TypeName = "billingGroupOfficeTableType";

            List<BillingGroupOffice> detail = (List<BillingGroupOffice>)_billingGroup.detail;
            if (detail.Count > 0)
            {
                p.Value = mapBillingGroupDetail(_billingGroup.detail);
            }
            else
            {
                p.Value = null;
            }

        }

        protected List<SqlDataRecord> mapBillingGroupDetail(IEnumerable<BillingGroupOffice> detail)
        {            
            SqlMetaData[] tvpCheckbookDetail =
            {
                new SqlMetaData("billingGroupOfficeId", SqlDbType.Int),
                new SqlMetaData("billingGroupId", SqlDbType.Int),
                new SqlMetaData("officeId", SqlDbType.Int),
                new SqlMetaData("office", SqlDbType.NVarChar, 200),
                new SqlMetaData("percentage", SqlDbType.Decimal , 18, 4)
            };

            List<SqlDataRecord> records = new List<SqlDataRecord>();

            foreach (BillingGroupOffice itemDetail in detail)
            {
                var record = new SqlDataRecord(tvpCheckbookDetail);

                record.SetInt32(0, itemDetail.billingGroupOfficeId);
                record.SetInt32(1, itemDetail.billingGroupId);
                record.SetInt32(2, itemDetail.officeId);
                if (!string.IsNullOrEmpty(itemDetail.office))
                {
                    record.SetString(3, itemDetail.office);
                }                
                record.SetDecimal(4, itemDetail.percentage);
                
                records.Add(record);

            }

            return records;
        }

    }
}

```
## CertificationRoleRequirementParameter.cs
```cs
using Dapper;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using System.Data;
using AT.AT2017.Api.Core.Models;
using System.Data.SqlClient;
using Microsoft.SqlServer.Server;
using System.Data.SqlTypes;

namespace AT.AT2017.Api.DynamicParameters
{
    public class CertificationRoleRequirementParameter : SqlMapper.IDynamicParameters
    {
        private int _certificationId;
        private IEnumerable<CertificationRoleRequirement> _table;

        public CertificationRoleRequirementParameter( int certificationId, IEnumerable<CertificationRoleRequirement> table)
        {
            _certificationId = certificationId;
            _table = table;            
        }

        void SqlMapper.IDynamicParameters.AddParameters(IDbCommand command, SqlMapper.Identity identity)
        {
            SqlParameter p;
            var sqlCommand = (SqlCommand)command;
            sqlCommand.CommandType = CommandType.StoredProcedure;

            p = sqlCommand.Parameters.Add("@certificationId", SqlDbType.Int);
            p.Value = _certificationId;
            p = sqlCommand.Parameters.Add("@userCertificationRolRequirements", SqlDbType.Structured);
            p.Direction = ParameterDirection.Input;
            p.TypeName = "certificationRoleRequirementsTableType";
            List<CertificationRoleRequirement> list = (List<CertificationRoleRequirement>)_table;
            if (list.Count > 0)
            {
                p.Value = mapTable(_table);
            }
        }


        protected List<SqlDataRecord> mapTable(IEnumerable<CertificationRoleRequirement> table)
        {
            SqlMetaData[] tvp =
            {
                new SqlMetaData("id", SqlDbType.Int),
                new SqlMetaData("certificationID", SqlDbType.Int),
                new SqlMetaData("roleID", SqlDbType.Int)
            };

            List<SqlDataRecord> records = new List<SqlDataRecord>();

            foreach (CertificationRoleRequirement item in table)
            {
                var record = new SqlDataRecord(tvp);
                record.SetInt32(0, item.id);
                record.SetInt32(1, item.certificationID);
                record.SetInt32(2, item.roleID);
                records.Add(record);
            }

            return records;
        }

    }
}

```
## CheckbookDynamicParameter.cs
```cs
using Dapper;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using System.Data;
using AT.AT2017.Api.Core.Models;
using System.Data.SqlClient;
using Microsoft.SqlServer.Server;

namespace AT.AT2017.Api.DynamicParameters
{
    public class CheckbookDynamicParameter : SqlMapper.IDynamicParameters
    {

        private readonly Checkbook _checkbook;

        public CheckbookDynamicParameter(Checkbook checkbook)
        {
            _checkbook = checkbook;
        }

        void SqlMapper.IDynamicParameters.AddParameters(IDbCommand command, SqlMapper.Identity identity)
        {
            SqlParameter p;
            var sqlCommand = (SqlCommand)command;
            sqlCommand.CommandType = CommandType.StoredProcedure;

            p = sqlCommand.Parameters.Add("@companyId", SqlDbType.Int);
            p.Value = _checkbook.companyId;
            p = sqlCommand.Parameters.Add("@checkbookId", SqlDbType.Int);
            p.Value = _checkbook.checkbookId;
            p = sqlCommand.Parameters.Add("@accountId", SqlDbType.Int);
            p.Value = _checkbook.accountId;
            p = sqlCommand.Parameters.Add("@personId", SqlDbType.Int);
            if (_checkbook.personId > 0)
            { p.Value = _checkbook.personId;
            }           
            p = sqlCommand.Parameters.Add("@checkDate", SqlDbType.DateTime);
            p.Value = _checkbook.checkDate;
            p = sqlCommand.Parameters.Add("@checkNumber", SqlDbType.VarChar, 20);
            p.Value = _checkbook.checkNumber;
            p = sqlCommand.Parameters.Add("@checkMemo", SqlDbType.VarChar, 200);
            p.Value = _checkbook.checkMemo;
            p = sqlCommand.Parameters.Add("@clearRef", SqlDbType.VarChar, 10);
            p.Value = _checkbook.clearRef;
            p = sqlCommand.Parameters.Add("@propertyId", SqlDbType.Int);
            p.Value = _checkbook.propertyId;
            p = sqlCommand.Parameters.Add("@type", SqlDbType.VarChar, 10);
            p.Value = _checkbook.type;
            p = sqlCommand.Parameters.Add("@flag1099", SqlDbType.Int);
            p.Value = _checkbook.flag1099;
            p = sqlCommand.Parameters.Add("@paidByNacha", SqlDbType.Bit);
            p.Value = _checkbook.paidByNacha;
            // detail
            p = sqlCommand.Parameters.Add("@detail", SqlDbType.Structured);
            p.Direction = ParameterDirection.Input;
            p.TypeName = "checkbookDetailTableType";
            p.Value = mapCheckbookDetail(_checkbook.detail);

        }

        protected List<SqlDataRecord> mapCheckbookDetail(IEnumerable<CheckbookDetail> detail)
        {
            SqlMetaData[] tvpCheckbookDetail =
            {
                new SqlMetaData("checkbookDetailId", SqlDbType.Int),
                new SqlMetaData("checkbookId", SqlDbType.Int),
                new SqlMetaData("description", SqlDbType.NVarChar, 200),
                new SqlMetaData("accountId", SqlDbType.Int),
                new SqlMetaData("jobId", SqlDbType.Int),
                new SqlMetaData("amount", SqlDbType.Decimal , 18, 2),
                new SqlMetaData("arPaymentID", SqlDbType.Int),
                new SqlMetaData("divisionId", SqlDbType.Int),
                new SqlMetaData("locked", SqlDbType.Bit),
                new SqlMetaData("strLink", SqlDbType.VarChar, 50),
            };

            List<SqlDataRecord> records = new List<SqlDataRecord>();

            foreach (CheckbookDetail itemDetail in detail)
            {
                var record = new SqlDataRecord(tvpCheckbookDetail);

                record.SetInt32(0, itemDetail.checkbookDetailId);
                record.SetInt32(1, itemDetail.checkbookId);
                if (!string.IsNullOrEmpty(itemDetail.description))
                {
                    record.SetString(2, itemDetail.description);
                }
                record.SetInt32(3, itemDetail.accountId.GetValueOrDefault());
                record.SetInt32(4, itemDetail.jobId.GetValueOrDefault());
                record.SetDecimal(5, itemDetail.amount);
                if (itemDetail.arPaymentId > 0)
                {
                    record.SetInt32(6, itemDetail.arPaymentId.GetValueOrDefault());
                }                
                if (itemDetail.divisionId > 0)
                {
                    record.SetInt32(7, itemDetail.divisionId.GetValueOrDefault());
                }
                record.SetSqlBoolean(8, itemDetail.locked.GetValueOrDefault());
                if (!string.IsNullOrEmpty(itemDetail.strLink))
                {
                    record.SetString(9, itemDetail.strLink);
                }                

                records.Add(record);

            }

            return records;
        }

    }
}

```
## CheckTemplateDynamicParameter.cs
```cs
using AT.AT2017.Api.Core.Models;
using Dapper;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using System.Data;
using System.Data.SqlClient;
using Microsoft.SqlServer.Server;

namespace AT.AT2017.Api.DynamicParameters
{
    public class CheckTemplateDynamicParameter : SqlMapper.IDynamicParameters
    {
        private readonly CheckTemplate _item;

        public CheckTemplateDynamicParameter(CheckTemplate item)
        {
            _item = item;
        }

        void SqlMapper.IDynamicParameters.AddParameters(IDbCommand command, SqlMapper.Identity identity)
        {
            SqlParameter p;
            var sqlCommand = (SqlCommand)command;
            sqlCommand.CommandType = CommandType.StoredProcedure;

            p = sqlCommand.Parameters.Add("@checkTemplateId", SqlDbType.Int);
            p.Value = _item.checkTemplateId;
            p = sqlCommand.Parameters.Add("@name", SqlDbType.VarChar, 100);
            p.Value = _item.name;
            p = sqlCommand.Parameters.Add("@checkTypeId", SqlDbType.Int);
            if (_item.checkTypeId == null)
            {
                p.Value = DBNull.Value;
            }
            else
            {
                p.Value = _item.checkTypeId;
            }
            p = sqlCommand.Parameters.Add("@background", SqlDbType.Image);
            if (_item.background == null) {
                p.Value = DBNull.Value;
            }
            else
            {
                p.Value = _item.background;
            }
            p = sqlCommand.Parameters.Add("@backgroundPosition", SqlDbType.VarChar, 50);
            if (_item.backgroundPosition == null)
            {
                p.Value = DBNull.Value;
            }
            else
            {
                p.Value = _item.backgroundPosition;
            }
            p = sqlCommand.Parameters.Add("@width", SqlDbType.Int);
            p.Value = _item.width;
            p = sqlCommand.Parameters.Add("@height", SqlDbType.Int);
            p.Value = _item.height;
            p = sqlCommand.Parameters.Add("@paper_kind", SqlDbType.Int);
            p.Value = _item.paper_kind;
            p = sqlCommand.Parameters.Add("@paper_width", SqlDbType.Int);
            p.Value = _item.paper_width;
            p = sqlCommand.Parameters.Add("@paper_height", SqlDbType.Int);
            p.Value = _item.paper_height;
            p = sqlCommand.Parameters.Add("@margin_top", SqlDbType.Int);
            p.Value = _item.margin_top;
            p = sqlCommand.Parameters.Add("@margin_bottom", SqlDbType.Int);
            p.Value = _item.margin_bottom;
            p = sqlCommand.Parameters.Add("@margin_left", SqlDbType.Int);
            p.Value = _item.margin_left;
            p = sqlCommand.Parameters.Add("@margin_right", SqlDbType.Int);
            p.Value = _item.margin_right;
            p = sqlCommand.Parameters.Add("@landscape", SqlDbType.Bit);
            p.Value = _item.landscape;

            // merge fields
            p = sqlCommand.Parameters.Add("@mergeFields", SqlDbType.Structured);
            p.Direction = ParameterDirection.Input;
            p.TypeName = "checkMergeFieldTableType";
            List<CheckMergeField> mergeFields = (List<CheckMergeField>)_item.mergeFields;
            if (mergeFields.Count > 0)
            {
                p.Value = mapMergeFieldsDetail(_item.mergeFields);
            }
            else
            {
                p.Value = null;
            }
        }

        protected List<SqlDataRecord> mapMergeFieldsDetail(IEnumerable<CheckMergeField> mergeFields)
        {
            SqlMetaData[] tvp =
            {
                new SqlMetaData("checkMergeFieldID", SqlDbType.Int),
                new SqlMetaData("name", SqlDbType.NVarChar, 100),
                new SqlMetaData("fontname", SqlDbType.NVarChar, 50),
                new SqlMetaData("fontsize", SqlDbType.Decimal, 18, 2),
                new SqlMetaData("bold", SqlDbType.Bit),
                new SqlMetaData("underline", SqlDbType.Bit),
                new SqlMetaData("italic", SqlDbType.Bit),
                new SqlMetaData("unit", SqlDbType.Int),
                new SqlMetaData("forecolor_alpha", SqlDbType.Int),
                new SqlMetaData("forecolor_red", SqlDbType.Int),
                new SqlMetaData("forecolor_green", SqlDbType.Int),
                new SqlMetaData("forecolor_blue", SqlDbType.Int),
                new SqlMetaData("width", SqlDbType.Int),
                new SqlMetaData("height", SqlDbType.Int),
                new SqlMetaData("x", SqlDbType.Int),
                new SqlMetaData("y", SqlDbType.Int),
                new SqlMetaData("checkTemplateID", SqlDbType.Int),
                new SqlMetaData("isLabel", SqlDbType.Bit),
                 new SqlMetaData("totalID", SqlDbType.Int),
                new SqlMetaData("picturePath", SqlDbType.VarChar,500)

            };

            List<SqlDataRecord> list = new List<SqlDataRecord>();

            foreach (CheckMergeField item in mergeFields)
            {
                var record = new SqlDataRecord(tvp);
                record.SetInt32(0, item.checkMergeFieldID);
                record.SetString(1, item.name);
                record.SetString(2, item.fontname);
                record.SetDecimal(3, item.fontsize.GetValueOrDefault());
                record.SetBoolean(4, item.bold.GetValueOrDefault());
                record.SetBoolean(5, item.underline.GetValueOrDefault());
                record.SetBoolean(6, item.italic.GetValueOrDefault());
                record.SetInt32(7, item.unit);
                record.SetInt32(8, item.forecolor_alpha);
                record.SetInt32(9, item.forecolor_red);
                record.SetInt32(10, item.forecolor_green);
                record.SetInt32(11, item.forecolor_blue);
                record.SetInt32(12, item.width.GetValueOrDefault());
                record.SetInt32(13, item.height.GetValueOrDefault());
                record.SetInt32(14, item.x.GetValueOrDefault());
                record.SetInt32(15, item.y.GetValueOrDefault());
                record.SetInt32(16, item.checkTemplateID.GetValueOrDefault());
                record.SetBoolean(17, item.isLabel.GetValueOrDefault());
                if (item.totalID != null && item.totalID>0)
                    record.SetInt32(18, item.totalID.GetValueOrDefault());
                if (!string.IsNullOrEmpty(item.picturePath))
                    record.SetString(19, item.picturePath);
             
                list.Add(record);

            }

            return list;
        }


    }
}

```
## ClassificationRuleApplyDynamicParameter.cs
```cs
using Dapper;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using System.Data;
using System.Data.SqlClient;
using Microsoft.SqlServer.Server;
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.DynamicParameters
{
    public class ClassificationRuleApplyDynamicParameter : SqlMapper.IDynamicParameters
    {
        private readonly IEnumerable<BankTransaction> _bankTransactions;
        private readonly int _ruleID;

        public ClassificationRuleApplyDynamicParameter(int ruleID, IEnumerable<BankTransaction> bankTransactions)
        {
            _ruleID = ruleID;
            _bankTransactions = bankTransactions;
        }

        void SqlMapper.IDynamicParameters.AddParameters(IDbCommand command, SqlMapper.Identity identity)
        {
            SqlParameter p;
            var sqlCommand = (SqlCommand)command;
            sqlCommand.CommandType = CommandType.StoredProcedure;

            p = sqlCommand.Parameters.Add("@ruleID", SqlDbType.Int);
            p.Value = _ruleID;

            p = sqlCommand.Parameters.Add("@bankTransactions", SqlDbType.Structured);
            p.Direction = ParameterDirection.Input;
            p.TypeName = "bankTransactionTableType";
            List<BankTransaction> bankTransactions = (List<BankTransaction>)_bankTransactions;
            if (bankTransactions.Count > 0)
            {
                p.Value = mapBankTransactions(_bankTransactions);
            }
        }


        protected List<SqlDataRecord> mapBankTransactions(IEnumerable<BankTransaction> bankTransactions)
        {
            SqlMetaData[] tvp =
            {
                new SqlMetaData("transactionID", SqlDbType.Int),
                new SqlMetaData("date", SqlDbType.DateTime),
                new SqlMetaData("description", SqlDbType.VarChar, 1000),
                new SqlMetaData("amount", SqlDbType.Decimal,18,2),
                new SqlMetaData("bankAccountID", SqlDbType.Int),
                new SqlMetaData("linkedAccountID", SqlDbType.Int),
                new SqlMetaData("linkedOfficeID", SqlDbType.Int),
                new SqlMetaData("linkedDivisionID", SqlDbType.Int),
                new SqlMetaData("linkedPersonID", SqlDbType.Int),
                new SqlMetaData("approved", SqlDbType.Bit),
                new SqlMetaData("approvedDate", SqlDbType.DateTime),
                new SqlMetaData("posted", SqlDbType.Bit),
                new SqlMetaData("postedDate", SqlDbType.DateTime),
                new SqlMetaData("journalID", SqlDbType.Int),
                new SqlMetaData("voucherID", SqlDbType.Int)
            };

            List<SqlDataRecord> list = new List<SqlDataRecord>();

            foreach (BankTransaction bankTransaction in bankTransactions)
            {
                var record = new SqlDataRecord(tvp);
                record.SetInt32(0, bankTransaction.transactionID);
                list.Add(record);
            }

            return list;
        }

    }
}

```
## ClassificationRuleDynamicParameter.cs
```cs
using Dapper;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using System.Data;
using AT.AT2017.Api.Core.Models.BankStream;
using System.Data.SqlClient;
using Microsoft.SqlServer.Server;

namespace AT.AT2017.Api.DynamicParameters
{
    public class ClassificationRuleDynamicParameter : SqlMapper.IDynamicParameters
    {
        private readonly ClassificationRule _classificationRule;

        public ClassificationRuleDynamicParameter(ClassificationRule classificationRule)
        {
            _classificationRule = classificationRule;
        }

        void SqlMapper.IDynamicParameters.AddParameters(IDbCommand command, SqlMapper.Identity identity)
        {
            SqlParameter p;
            var sqlCommand = (SqlCommand)command;
            sqlCommand.CommandType = CommandType.StoredProcedure;

            p = sqlCommand.Parameters.Add("@ruleID", SqlDbType.Int);
            p.Value = _classificationRule.ruleId;
            p = sqlCommand.Parameters.Add("@ruleName", SqlDbType.VarChar,100);
            p.Value = _classificationRule.ruleName;
            p = sqlCommand.Parameters.Add("@actionType", SqlDbType.VarChar,50);
            p.Value = _classificationRule.actionType;
            p = sqlCommand.Parameters.Add("@linkAccountID", SqlDbType.Int);
            p.Value = _classificationRule.linkedAccountId;
            p = sqlCommand.Parameters.Add("@linkPersonID", SqlDbType.Int);
            p.Value = _classificationRule.linkedPersonId;
            p = sqlCommand.Parameters.Add("@linkOfficeID", SqlDbType.Int);
            p.Value = _classificationRule.linkedOfficeId;
            p = sqlCommand.Parameters.Add("@bankAccountID", SqlDbType.Int);
            p.Value = _classificationRule.bankAccountId;
            p = sqlCommand.Parameters.Add("@transactionType", SqlDbType.VarChar,100);
            p.Value = _classificationRule.transactionType;
            //// detail
            p = sqlCommand.Parameters.Add("@detail", SqlDbType.Structured);
            p.Direction = ParameterDirection.Input;
            p.TypeName = "classificationRuleDetailTableType";
            List<ClassificationRuleDetail> detail = (List<ClassificationRuleDetail>)_classificationRule.detail;
            if (detail.Count > 0)
            {
                p.Value = mapClassificationRuleDetail(_classificationRule.detail);
            }
            else
            {
                p.Value = null;
            }
        }

        protected List<SqlDataRecord> mapClassificationRuleDetail(IEnumerable<ClassificationRuleDetail> detail)
        {
            SqlMetaData[] tvpClassificationRuleDetail =
            {
                new SqlMetaData("ruleDetailID", SqlDbType.Int),
                new SqlMetaData("ruleID", SqlDbType.Int),
                new SqlMetaData("startParenthesis", SqlDbType.VarChar, 1),
                new SqlMetaData("fieldName", SqlDbType.VarChar,100),
                new SqlMetaData("operator",SqlDbType.VarChar,100),
                new SqlMetaData("value", SqlDbType.VarChar,1000),
                new SqlMetaData("endParenthesis", SqlDbType.VarChar,1),
                new SqlMetaData("concat", SqlDbType.VarChar,3),
                new SqlMetaData("sortOrder", SqlDbType.Int)
             };

            List<SqlDataRecord> classificationRuleDetail = new List<SqlDataRecord>();

            foreach (ClassificationRuleDetail itemDetail in detail)
            {
                var record = new SqlDataRecord(tvpClassificationRuleDetail);
                record.SetInt32(0, itemDetail.ruleDetailId);
                record.SetInt32(1, itemDetail.ruleId);
                if (itemDetail.startParenthesis != null)
                    record.SetString(2, itemDetail.startParenthesis);
                if (itemDetail.fieldName != null)
                    record.SetString(3, itemDetail.fieldName);
                if (itemDetail.@operator != null)
                    record.SetString(4, itemDetail.@operator);
                if (itemDetail.value != null)
                    record.SetString(5, itemDetail.value);
                if (itemDetail.endParenthesis != null)
                    record.SetString(6, itemDetail.endParenthesis);
                if (itemDetail.concat != null)
                    record.SetString(7, itemDetail.concat);
                record.SetInt32(8, itemDetail.sortOrder);

                // add record
                classificationRuleDetail.Add(record);
            }

            return classificationRuleDetail;
        }

    }
}

```
## CodeValueDynamicParameter.cs
```cs
using Dapper;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using System.Data;
using AT.AT2017.Api.Core.Models;
using System.Data.SqlClient;
using Microsoft.SqlServer.Server;

namespace AT.AT2017.Api.DynamicParameters
{
    public class CodeValueDynamicParameter : SqlMapper.IDynamicParameters
    {
        private readonly IEnumerable<CodeValue> _codeValues;
        private string _category;

        public CodeValueDynamicParameter(IEnumerable<CodeValue> codeValues, string category)
        {
            _codeValues = codeValues;
            _category = category;
        }

        void SqlMapper.IDynamicParameters.AddParameters(IDbCommand command, SqlMapper.Identity identity)
        {
            SqlParameter p;
            var sqlCommand = (SqlCommand)command;
            sqlCommand.CommandType = CommandType.StoredProcedure;

            p = sqlCommand.Parameters.Add("@codeValues", SqlDbType.Structured);
            p.Direction = ParameterDirection.Input;
            p.TypeName = "codeValueTableType";
            List<CodeValue> codeValues = (List<CodeValue>)_codeValues;
            if (codeValues.Count > 0)
            {
                p.Value = mapCodeValues(_codeValues);
            }
            p = sqlCommand.Parameters.Add("@category", SqlDbType.VarChar, 100);
            p.Value = _category;
        }


        protected List<SqlDataRecord> mapCodeValues(IEnumerable<CodeValue> codeValues)
        {
            SqlMetaData[] tvp =
            {
                new SqlMetaData("codeValueId", SqlDbType.Int),
                new SqlMetaData("name", SqlDbType.NVarChar, 100),
                new SqlMetaData("code", SqlDbType.NVarChar, 100),
                new SqlMetaData("group", SqlDbType.NVarChar, 100),
                new SqlMetaData("category", SqlDbType.NVarChar, 100),
                new SqlMetaData("custom1", SqlDbType.NVarChar, 100),
                new SqlMetaData("custom2", SqlDbType.NVarChar, 100),
                new SqlMetaData("custom3", SqlDbType.NVarChar, 100),
                new SqlMetaData("feedID", SqlDbType.Int),
                new SqlMetaData("isMaster", SqlDbType.Bit),
                new SqlMetaData("brandCode", SqlDbType.NVarChar, 200),
                new SqlMetaData("createDate", SqlDbType.DateTime),
                new SqlMetaData("createdBy", SqlDbType.NVarChar, 100),
                new SqlMetaData("modifyDate", SqlDbType.DateTime),
                new SqlMetaData("modifyBy", SqlDbType.NVarChar, 100),
                new SqlMetaData("deleteDate", SqlDbType.DateTime),
                new SqlMetaData("deletedBy", SqlDbType.NVarChar, 100),
    };

            List<SqlDataRecord> list = new List<SqlDataRecord>();

            foreach (CodeValue codeValue in codeValues)
            {
                var record = new SqlDataRecord(tvp);
                record.SetInt32(0, codeValue.codeValueId);
                record.SetString(1, codeValue.name);
                if (codeValue.code != null)
                    record.SetString(2, codeValue.code);
                if (codeValue.group != null)
                    record.SetString(3, codeValue.group);
                record.SetString(4, codeValue.category);
                if (codeValue.custom1 != null)
                    record.SetString(5, codeValue.custom1);
                if (codeValue.custom2 != null)
                    record.SetString(6, codeValue.custom2);
                if (codeValue.custom3 != null)
                    record.SetString(7, codeValue.custom3);
                if (codeValue.deleteDate != null)
                    record.SetDateTime(15, Convert.ToDateTime(codeValue.deleteDate));
                if (codeValue.deletedBy != null)
                    record.SetString(16, codeValue.deletedBy);
                list.Add(record);
            }

            return list;
        }

    }
}

```
## DataImportDynamicParameter.cs
```cs
using Dapper;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using System.Data;
using System.Data.SqlClient;
using Microsoft.SqlServer.Server;

namespace AT.AT2017.Api.DynamicParameters
{
    public class DataImportDynamicParameter : SqlMapper.IDynamicParameters
    {
        private readonly DataImport _dataImport;

        public DataImportDynamicParameter(DataImport dataImport)
        {
            _dataImport = dataImport;
        }

        void SqlMapper.IDynamicParameters.AddParameters(IDbCommand command, SqlMapper.Identity identity)
        {
            SqlParameter p;
            var sqlCommand = (SqlCommand)command;
            sqlCommand.CommandType = CommandType.StoredProcedure;

            p = sqlCommand.Parameters.Add("@dataImportID", SqlDbType.Int);
            p.Value = _dataImport.dataImportID;

            p = sqlCommand.Parameters.Add("@importType", SqlDbType.VarChar);
            p.Value = _dataImport.importType;

            p = sqlCommand.Parameters.Add("@name", SqlDbType.VarChar);
            p.Value = _dataImport.name;

            p = sqlCommand.Parameters.Add("@fileName", SqlDbType.VarChar);
            p.Value = _dataImport.fileName;

            p = sqlCommand.Parameters.Add("@columns", SqlDbType.Structured);
            p.Direction = ParameterDirection.Input;
            p.TypeName = "dataImportColumnTableType";
            List<DataImportColumn> columns = (List<DataImportColumn>)_dataImport.columns;
            if (columns.Count > 0)
            {
                p.Value = mapDataImportColumns(columns);
            }
            else
            {
                p.Value = null;
            }

            p = sqlCommand.Parameters.Add("@records", SqlDbType.Structured);
            p.Direction = ParameterDirection.Input;
            p.TypeName = "dataImportRecordTableType";
            List<DataImportRecord> records = (List<DataImportRecord>)_dataImport.records;
            if (records.Count > 0)
            {
                p.Value = mapDataImportRecords(records);
            }
            else
            {
                p.Value = null;
            }

            p = sqlCommand.Parameters.Add("@recordValues", SqlDbType.Structured);
            p.Direction = ParameterDirection.Input;
            p.TypeName = "dataImportRecordValueTableType";
            List<DataImportRecordValue> recordValues = new List<DataImportRecordValue>();
            foreach (DataImportRecord importRecord in records)
            {
                recordValues.AddRange(importRecord.values);
            }
            if (recordValues.Count > 0)
            {
                p.Value = mapDataImportRecordValues(recordValues);
            }
            else
            {
                p.Value = null;
            }

        }

        protected List<SqlDataRecord> mapDataImportColumns(IEnumerable<DataImportColumn> dataImportColumns)
        {
            SqlMetaData[] tvpRecords =
            {
                new SqlMetaData("dataImportID", SqlDbType.Int),
                new SqlMetaData("columnName", SqlDbType.VarChar, 100),
                new SqlMetaData("dataType", SqlDbType.VarChar, 50),
                new SqlMetaData("width",SqlDbType.Int),
                new SqlMetaData("sortOrder",SqlDbType.Int),
                new SqlMetaData("status",SqlDbType.VarChar, 100),
                new SqlMetaData("isRequired",SqlDbType.Bit)
             };

            List<SqlDataRecord> sqlRecords = new List<SqlDataRecord>();

            foreach (DataImportColumn dataImportColumn in dataImportColumns)
            {
                var record = new SqlDataRecord(tvpRecords);
                record.SetInt32(0, dataImportColumn.dataImportID);
                record.SetString(1, dataImportColumn.columnName);
                record.SetString(2, dataImportColumn.dataType);
                record.SetInt32(3, dataImportColumn.width);
                record.SetInt32(4, dataImportColumn.sortOrder);
                record.SetString(5, dataImportColumn.status);
                record.SetBoolean(6, dataImportColumn.isRequired);
                // add record
                sqlRecords.Add(record);
            }

            return sqlRecords;
        }

        protected List<SqlDataRecord> mapDataImportRecords(IEnumerable<DataImportRecord> dataImportRecords)
        {
            SqlMetaData[] tvpRecords =
            {
                new SqlMetaData("sourceRecordID", SqlDbType.Int),
                new SqlMetaData("dataImportID", SqlDbType.Int),
                new SqlMetaData("status", SqlDbType.Char, 1),
                new SqlMetaData("errorMessage", SqlDbType.VarChar, -1),
                new SqlMetaData("recordDestPK",SqlDbType.Int),
                new SqlMetaData("proccessedDate", SqlDbType.DateTime),
                new SqlMetaData("processedBy", SqlDbType.VarChar, 100)
             };

            List<SqlDataRecord> sqlRecords = new List<SqlDataRecord>();

            foreach (DataImportRecord dataImportRecord in dataImportRecords)
            {
                var record = new SqlDataRecord(tvpRecords);
                record.SetInt32(0, dataImportRecord.sourceRecordID);
                record.SetInt32(1, dataImportRecord.dataImportID);
                record.SetString(2, dataImportRecord.status);
                if (dataImportRecord.errorMessage != null)
                    record.SetString(3, dataImportRecord.errorMessage);
                // add record
                sqlRecords.Add(record);
            }

            return sqlRecords;
        }

        protected List<SqlDataRecord> mapDataImportRecordValues(IEnumerable<DataImportRecordValue> dataImportRecordValues)
        {
            SqlMetaData[] tvpRecordValues =
            {
                new SqlMetaData("sourceRecordID", SqlDbType.Int),
                new SqlMetaData("columnName", SqlDbType.VarChar, 100),
                new SqlMetaData("value", SqlDbType.VarChar, -1),
                new SqlMetaData("originalvalue", SqlDbType.VarChar, -1),
                new SqlMetaData("modifyDate",SqlDbType.DateTime),
                new SqlMetaData("modifyBy", SqlDbType.VarChar, 100)
             };

            List<SqlDataRecord> sqlRecordValues = new List<SqlDataRecord>();

            foreach (DataImportRecordValue recordValue in dataImportRecordValues)
            {
                var record = new SqlDataRecord(tvpRecordValues);
                record.SetInt32(0, recordValue.sourceRecordID);
                record.SetString(1, recordValue.columnName);
                if (recordValue.value != null)
                    record.SetString(2, recordValue.value);
                if (recordValue.originalValue != null)
                    record.SetString(3, recordValue.originalValue);
                if (recordValue.modifyDate != null)
                    record.SetDateTime(4, recordValue.modifyDate.GetValueOrDefault());
                if (recordValue.modifyBy != null)
                    record.SetString(5, recordValue.modifyBy);
                // add record
                sqlRecordValues.Add(record);
            }

            return sqlRecordValues;
        }

    }
}

```
## DataImportHistoricalDynamicParameter.cs
```cs
using Dapper;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using System.Data;
using AT.AT2017.Api.Core.Models;
using System.Data.SqlClient;
using Microsoft.SqlServer.Server;


namespace AT.AT2017.Api.DynamicParameters
{
    public class DataImportHistoricalDynamicParameter : SqlMapper.IDynamicParameters
    {
        private readonly IEnumerable<DataImportHistorical> _table;
        private int _id;

        public DataImportHistoricalDynamicParameter(int id,IEnumerable<DataImportHistorical> table)
        {
            _id = id;
            _table = table;
        }

        void SqlMapper.IDynamicParameters.AddParameters(IDbCommand command, SqlMapper.Identity identity)
        {
            SqlParameter p;
            var sqlCommand = (SqlCommand)command;
            sqlCommand.CommandType = CommandType.StoredProcedure;

            p = sqlCommand.Parameters.Add("@importID", SqlDbType.Int);
            p.Value = _id;
            
            p = sqlCommand.Parameters.Add("@detail", SqlDbType.Structured);
            p.Direction = ParameterDirection.Input;
            p.TypeName = "dataImportHistoricalTableType";
            List<DataImportHistorical> table = (List<DataImportHistorical>)_table;
            if (table.Count > 0)
            {
                p.Value = mapTable(_table);
            }           

        }


        protected List<SqlDataRecord> mapTable(IEnumerable<DataImportHistorical> table)
        {
            SqlMetaData[] tvp =
            {
                new SqlMetaData("rowID", SqlDbType.Int),
                new SqlMetaData("propID", SqlDbType.Int),
                new SqlMetaData("qaControl1", SqlDbType.NVarChar, 10),
                new SqlMetaData("excludeDuplicate", SqlDbType.NVarChar, 10),
                new SqlMetaData("excludeFromSubmission", SqlDbType.NVarChar, 5),
                new SqlMetaData("status", SqlDbType.NVarChar, 100),
                new SqlMetaData("statusCode", SqlDbType.NVarChar, 10),
                new SqlMetaData("companyID", SqlDbType.Int),
                new SqlMetaData("company", SqlDbType.NVarChar, 1000),
                new SqlMetaData("propertyID", SqlDbType.Int),
                new SqlMetaData("propertyAddress", SqlDbType.NVarChar, 1000),
                new SqlMetaData("closingDate", SqlDbType.NVarChar, 100),
                new SqlMetaData("pendingDate", SqlDbType.NVarChar, 100),
                new SqlMetaData("estimatedClosingDate", SqlDbType.NVarChar, 100),
                new SqlMetaData("sellingPrice", SqlDbType.NVarChar, 100),
                new SqlMetaData("personID",  SqlDbType.Int),
                new SqlMetaData("officeID", SqlDbType.Int),
                new SqlMetaData("office", SqlDbType.NVarChar, 1000),
                new SqlMetaData("agentName", SqlDbType.NVarChar, 500),
                new SqlMetaData("adjustedGross", SqlDbType.NVarChar, 100),
                new SqlMetaData("agentNet", SqlDbType.NVarChar, 100),
                new SqlMetaData("deduct1",SqlDbType.NVarChar, 100),
                new SqlMetaData("deduct2",SqlDbType.NVarChar, 100),
                new SqlMetaData("deduct3",SqlDbType.NVarChar, 100),
                new SqlMetaData("deduct4",SqlDbType.NVarChar, 100),
                new SqlMetaData("deduct5",SqlDbType.NVarChar, 100),
                new SqlMetaData("deduct6",SqlDbType.NVarChar, 100),
                new SqlMetaData("deduct7",SqlDbType.NVarChar, 100),
                new SqlMetaData("deduct8",SqlDbType.NVarChar, 100),
                new SqlMetaData("deduct9",SqlDbType.NVarChar, 100),
                new SqlMetaData("deduct10",SqlDbType.NVarChar, 100),
                new SqlMetaData("deduct11",SqlDbType.NVarChar, 100),
                new SqlMetaData("deduct12",SqlDbType.NVarChar, 100),
                new SqlMetaData("billDeduct",SqlDbType.NVarChar, 100),
                new SqlMetaData("listSide",SqlDbType.NVarChar, 5),
                new SqlMetaData("sellSide",SqlDbType.NVarChar, 5),
                new SqlMetaData("listSideVolume",SqlDbType.NVarChar, 100),
                new SqlMetaData("sellSideVolume",SqlDbType.NVarChar, 100),
                new SqlMetaData("transactionCountListSide",SqlDbType.NVarChar, 100),
                new SqlMetaData("transactionCountSellSide",SqlDbType.NVarChar, 100),
                new SqlMetaData("listGross",SqlDbType.NVarChar, 100),
                new SqlMetaData("sellGross",SqlDbType.NVarChar, 100),
                new SqlMetaData("personListReferralID", SqlDbType.Int),
                new SqlMetaData("personSellReferralID", SqlDbType.Int),
                new SqlMetaData("listReferralAmount",SqlDbType.NVarChar, 100),
                new SqlMetaData("sellReferralAmount",SqlDbType.NVarChar, 100),
                new SqlMetaData("listReferralName",SqlDbType.NVarChar, 500),
                new SqlMetaData("sellReferralName",SqlDbType.NVarChar, 500),
                new SqlMetaData("invoiceID", SqlDbType.Int),
                new SqlMetaData("typeCode",SqlDbType.NVarChar, 200),
                new SqlMetaData("accountingCode",SqlDbType.NVarChar, 200),
                new SqlMetaData("typeCodeID", SqlDbType.Int),
                new SqlMetaData("accountingCodeID", SqlDbType.Int),
                new SqlMetaData("result", SqlDbType.NVarChar, 50), 
                new SqlMetaData("error", SqlDbType.NVarChar, 3000) 
    };

            List<SqlDataRecord> list = new List<SqlDataRecord>();

            foreach (DataImportHistorical item in table)
            {
                var record = new SqlDataRecord(tvp);
                record.SetInt32(0, item.rowID);
                record.SetInt32(1, item.propID);
                if (item.qaControl1 != null) record.SetString(2, item.qaControl1);
                if (item.excludeDuplicate != null) record.SetString(3, item.excludeDuplicate);
                if (item.excludeFromSubmission != null) record.SetString(4, item.excludeFromSubmission);
                if (item.status != null) record.SetString(5, item.status);
                if (item.statusCode != null) record.SetString(6, item.statusCode);
                if (item.companyID >0) record.SetInt32(7, item.companyID);
                if (item.company != null) record.SetString(8, item.company);           
                if (item.propertyID > 0)   record.SetInt32(9, item.propertyID);
                if (item.propertyAddress != null) record.SetString(10, item.propertyAddress);
                if (item.closingDate != null) record.SetString(11, item.closingDate);
                if (item.pendingDate != null) record.SetString(12, item.pendingDate);
                if (item.estimatedClosingDate != null) record.SetString(13, item.estimatedClosingDate);
                if (item.sellingPrice != null) record.SetString(14, item.sellingPrice);
                if (item.personID > 0) record.SetInt32(15, item.personID);
                if (item.officeID > 0) record.SetInt32(16, item.officeID);
                if (item.office != null) record.SetString(17, item.office);
                if (item.agentName != null) record.SetString(18, item.agentName);
                if (item.adjustedGross != null) record.SetString(19, item.adjustedGross);
                if (item.agentNet != null) record.SetString(20, item.agentNet);
                if (item.deduct1 != null) record.SetString(21, item.deduct1);
                if (item.deduct2 != null) record.SetString(22, item.deduct2);
                if (item.deduct3 != null) record.SetString(23, item.deduct3);
                if (item.deduct4 != null) record.SetString(24, item.deduct4);
                if (item.deduct5 != null) record.SetString(25, item.deduct5);
                if (item.deduct6 != null) record.SetString(26, item.deduct6);
                if (item.deduct7 != null) record.SetString(27, item.deduct7);
                if (item.deduct8 != null) record.SetString(28, item.deduct8);
                if (item.deduct9 != null) record.SetString(29, item.deduct9);
                if (item.deduct10 != null) record.SetString(30, item.deduct10);
                if (item.deduct11 != null) record.SetString(31, item.deduct11);
                if (item.deduct12 != null) record.SetString(32, item.deduct12);
                if (item.billDeduct != null) record.SetString(33, item.billDeduct);
                if (item.listSide != null) record.SetString(34, item.listSide);
                if (item.sellSide != null) record.SetString(35, item.sellSide);
                if (item.listSideVolume != null) record.SetString(36, item.listSideVolume);
                if (item.sellSideVolume != null) record.SetString(37, item.sellSideVolume);
                if (item.transactionCountListSide != null) record.SetString(38, item.transactionCountListSide);
                if (item.transactionCountSellSide != null) record.SetString(39, item.transactionCountSellSide);
                if (item.listGross != null) record.SetString(40, item.listGross);
                if (item.sellGross != null) record.SetString(41, item.sellGross);
                if (item.personListReferralID > 0) record.SetInt32(42, item.personListReferralID);
                if (item.personSellReferralID > 0) record.SetInt32(43, item.personSellReferralID);
                if (item.listReferralAmount != null) record.SetString(44, item.listReferralAmount);
                if (item.sellReferralAmount != null) record.SetString(45, item.sellReferralAmount);
                if (item.listReferralName != null) record.SetString(46, item.listReferralName);
                if (item.sellReferralName != null) record.SetString(47, item.sellReferralName);
                if (item.invoiceID > 0) record.SetInt32(48, item.invoiceID);
                if (item.typeCode != null) record.SetString(49, item.typeCode);
                if (item.accountingCode != null) record.SetString(50, item.accountingCode);
                if (item.typeCodeID > 0) record.SetInt32(51, item.typeCodeID);
                if (item.accountingCodeID > 0) record.SetInt32(52, item.accountingCodeID);
                if (item.result != null) record.SetString(53, item.result);
                if (item.error != null) record.SetString(54, item.error);
                list.Add(record);
            }

            return list;
        }

    }
}
```
## DeductionPlanDynamicParameter.cs
```cs
using Dapper;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using System.Data;
using AT.AT2017.Api.Core.Models;
using System.Data.SqlClient;
using Microsoft.SqlServer.Server;

namespace AT.AT2017.Api.DynamicParameters
{
    public class DeductionPlanDynamicParameter : SqlMapper.IDynamicParameters
    {

        private readonly IEnumerable<DeductionPlan> _deductionPlans;

        public DeductionPlanDynamicParameter(IEnumerable<DeductionPlan> deductionPlans)
        {
            _deductionPlans = deductionPlans;
        }

        void SqlMapper.IDynamicParameters.AddParameters(IDbCommand command, SqlMapper.Identity identity)
        {
            SqlParameter p;
            var sqlCommand = (SqlCommand)command;
            sqlCommand.CommandType = CommandType.StoredProcedure;

            p = sqlCommand.Parameters.Add("@detail", SqlDbType.Structured);
            p.Direction = ParameterDirection.Input;
            p.TypeName = "DeductionPlanTableType";
            List<DeductionPlan> deductionPlans = (List<DeductionPlan>)_deductionPlans;
            if (deductionPlans.Count > 0)
            {
                p.Value = mapDeductionPlan(_deductionPlans);
            }
        }

        protected List<SqlDataRecord> mapDeductionPlan(IEnumerable<DeductionPlan> deductionPlans)
        {
            SqlMetaData[] tvpDeductionPlan =
            {
                new SqlMetaData("planId", SqlDbType.Int),
                new SqlMetaData("planName", SqlDbType.Text ),
                new SqlMetaData("planNotes", SqlDbType.Text ),
                 new SqlMetaData("companyID", SqlDbType.Int ),
            };

            List<SqlDataRecord> DeductionPlan = new List<SqlDataRecord>();

            foreach (DeductionPlan itemDetail in deductionPlans)
            {
                var record = new SqlDataRecord(tvpDeductionPlan);
                record.SetInt32(0, itemDetail.planId);
                record.SetString(1, itemDetail.planName);
                if (itemDetail.planNotes == null)
                {
                    record.SetString(2, "");
                }
                else
                {
                    record.SetString(2, itemDetail.planNotes);
                }
                if (itemDetail.companyId > 0)
                    record.SetInt32(3, itemDetail.companyId.GetValueOrDefault());
                DeductionPlan.Add(record);
            }

            return DeductionPlan;
        }

    }
}


```
## DeductionPlanWithTotalsDynamicParameter.cs
```cs
using Dapper;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using System.Data;
using AT.AT2017.Api.Core.Models;
using System.Data.SqlClient;
using Microsoft.SqlServer.Server;

namespace AT.AT2017.Api.DynamicParameters
{
    public class DeductionPlanWithTotalsDynamicParameter : SqlMapper.IDynamicParameters
    {

        private readonly IEnumerable<DeductionPlan> _deductionPlans;

        public DeductionPlanWithTotalsDynamicParameter(IEnumerable<DeductionPlan> deductionPlans)
        {
            _deductionPlans = deductionPlans;
        }

        void SqlMapper.IDynamicParameters.AddParameters(IDbCommand command, SqlMapper.Identity identity)
        {
            SqlParameter p;
            var sqlCommand = (SqlCommand)command;
            sqlCommand.CommandType = CommandType.StoredProcedure;

            p = sqlCommand.Parameters.Add("@detail", SqlDbType.Structured);
            p.Direction = ParameterDirection.Input;
            p.TypeName = "DeductionPlanWithTotalsTableType";
            List<DeductionPlan> deductionPlans = (List<DeductionPlan>)_deductionPlans;
            if (deductionPlans.Count > 0)
            {
                p.Value = mapDeductionPlan(_deductionPlans);
            }
        }

        protected List<SqlDataRecord> mapDeductionPlan(IEnumerable<DeductionPlan> deductionPlans)
        {
            SqlMetaData[] tvpDeductionPlan =
            {
                new SqlMetaData("planId", SqlDbType.Int),
                new SqlMetaData("planName", SqlDbType.Text ),
                new SqlMetaData("planNotes", SqlDbType.Text ),
                new SqlMetaData("companyID", SqlDbType.Int ),
                new SqlMetaData("totalIDs", SqlDbType.Text )
            };

            List<SqlDataRecord> DeductionPlan = new List<SqlDataRecord>();

            foreach (DeductionPlan itemDetail in deductionPlans)
            {
                var record = new SqlDataRecord(tvpDeductionPlan);
                record.SetInt32(0, itemDetail.planId);
                record.SetString(1, itemDetail.planName);
                if (itemDetail.planNotes == null)
                {
                    record.SetString(2, "");
                }
                else
                {
                    record.SetString(2, itemDetail.planNotes);
                }
                if (itemDetail.companyId > 0)
                    record.SetInt32(3, itemDetail.companyId.GetValueOrDefault());
                if (itemDetail.totalIDs == null)
                {
                    record.SetString(4, "");
                }
                else
                {
                    record.SetString(4, itemDetail.totalIDs);
                }
                DeductionPlan.Add(record);
            }

            return DeductionPlan;
        }

    }
}


```
## DeductionScaleDynamicParameter.cs
```cs
using Dapper;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using System.Data;
using AT.AT2017.Api.Core.Models;
using System.Data.SqlClient;
using Microsoft.SqlServer.Server;

namespace AT.AT2017.Api.DynamicParameters
{
    public class DeductionScaleDynamicParameter : SqlMapper.IDynamicParameters
    {

        private readonly DeductionScale _deductionScale;

        public DeductionScaleDynamicParameter(DeductionScale deductionScale)
        {
            _deductionScale = deductionScale;
        }

        void SqlMapper.IDynamicParameters.AddParameters(IDbCommand command, SqlMapper.Identity identity)
        {
            SqlParameter p;
            var sqlCommand = (SqlCommand)command;
            sqlCommand.CommandType = CommandType.StoredProcedure;

            p = sqlCommand.Parameters.Add("@deductionScaleID", SqlDbType.Int);
            p.Value = _deductionScale.deductionScaleID;
            p = sqlCommand.Parameters.Add("@scaleName", SqlDbType.VarChar, 300);
            p.Value = _deductionScale.scaleName;
            // detail
            p = sqlCommand.Parameters.Add("@detail", SqlDbType.Structured);
            p.Direction = ParameterDirection.Input;
            p.TypeName = "deductionScaleDetailTableType";
            p.Value = mapDeductionScaleDetail(_deductionScale.detail);
        }

        protected List<SqlDataRecord> mapDeductionScaleDetail(IEnumerable<DeductionScaleDetail> detail)
        {
            SqlMetaData[] tvpDeductionScaleDetail =
            {
                new SqlMetaData("deductionScaleDetailId", SqlDbType.Int),
                new SqlMetaData("deductionScaleId", SqlDbType.Int),
                new SqlMetaData("minAmount", SqlDbType.Decimal , 18, 2),
                new SqlMetaData("maxAmount", SqlDbType.Decimal, 18, 2),
                new SqlMetaData("fixedAmount", SqlDbType.Decimal, 18, 2),
                new SqlMetaData("percentage", SqlDbType.Decimal, 18, 4)
            };

            List<SqlDataRecord> deductionScaleDetail = new List<SqlDataRecord>();

            foreach (DeductionScaleDetail itemDetail in detail)
            {
                var record = new SqlDataRecord(tvpDeductionScaleDetail);
                record.SetInt32(0, itemDetail.deductionScaleDetailID);
                record.SetInt32(1, itemDetail.deductionScaleID);
                record.SetDecimal(2, itemDetail.minAmount);
                record.SetDecimal(3, itemDetail.maxAmount);
                record.SetDecimal(4, itemDetail.fixedAmount);
                record.SetDecimal(5, itemDetail.percentage);
                deductionScaleDetail.Add(record);
            }

            return deductionScaleDetail;
        }

    }
}

```
## DeductionSubplanDynamicParameter.cs
```cs
using AT.AT2017.Api.Core.Models;
using Dapper;
using Microsoft.SqlServer.Server;
using System;
using System.Collections.Generic;
using System.Data;
using System.Data.SqlClient;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.DynamicParameters
{
    public class DeductionSubplanDynamicParameter : SqlMapper.IDynamicParameters
    {

        private readonly IEnumerable<DeductionSubplan> _deductionSubplans;

        public DeductionSubplanDynamicParameter(IEnumerable<DeductionSubplan> deductionSubplans)
        {
            _deductionSubplans = deductionSubplans;
        }

        void SqlMapper.IDynamicParameters.AddParameters(IDbCommand command, SqlMapper.Identity identity)
        {
            SqlParameter p;
            var sqlCommand = (SqlCommand)command;
            sqlCommand.CommandType = CommandType.StoredProcedure;

            p = sqlCommand.Parameters.Add("@detail", SqlDbType.Structured);
            p.Direction = ParameterDirection.Input;
            p.TypeName = "DeductionSubplanTableType";
            List<DeductionSubplan> deductionSubplans = (List<DeductionSubplan>)_deductionSubplans;
            if (deductionSubplans.Count > 0)
            {
                p.Value = mapDeductionSubplan(_deductionSubplans);
            }
        }

        protected List<SqlDataRecord> mapDeductionSubplan(IEnumerable<DeductionSubplan> deductionSubplans)
        {
            SqlMetaData[] tvpDeductionSubplan =
            {
                new SqlMetaData("subplanId", SqlDbType.Int),
                new SqlMetaData("subplanName", SqlDbType.Text ),
                new SqlMetaData("notes", SqlDbType.Text ),
                 new SqlMetaData("companyID", SqlDbType.Int ),
            };

            List<SqlDataRecord> deductionSubplanRecords = new List<SqlDataRecord>();

            foreach (DeductionSubplan itemDetail in deductionSubplans)
            {
                var record = new SqlDataRecord(tvpDeductionSubplan);
                record.SetInt32(0, itemDetail.subplanId);
                if (itemDetail.subplanName != null)
                {
                    record.SetString(1, itemDetail.subplanName);
                }
                if (itemDetail.notes != null)
                {
                    record.SetString(2, itemDetail.notes);
                }
                if (itemDetail.companyID.GetValueOrDefault() > 0) { 
                    record.SetInt32(3, itemDetail.companyID.GetValueOrDefault());
                }
                deductionSubplanRecords.Add(record);
            }

            return deductionSubplanRecords;
        }

    }
}

```
## DivideExpenseTemplateDynamicParameter.cs
```cs
using AT.AT2017.Api.Core.Models;
using Dapper;
using System;
using System.Collections.Generic;
using System.Data;
using System.Data.SqlClient;
using Microsoft.SqlServer.Server;

namespace AT.AT2017.Api.DynamicParameters
{
    public class DivideExpenseTemplateDynamicParameter : SqlMapper.IDynamicParameters
    {
        private DivideExpenseTemplate _item;
        
        public DivideExpenseTemplateDynamicParameter(DivideExpenseTemplate item)
        {
            _item = item;
        }

        void SqlMapper.IDynamicParameters.AddParameters(IDbCommand command, SqlMapper.Identity identity)
        {
            SqlParameter p;
            var sqlCommand = (SqlCommand)command;
            sqlCommand.CommandType = CommandType.StoredProcedure;

            p = sqlCommand.Parameters.Add("@templateId", SqlDbType.Int);
            p.Value = _item.templateId;
            p = sqlCommand.Parameters.Add("@divideOption", SqlDbType.VarChar, 20);
            p.Value = _item.divideOption;
            p = sqlCommand.Parameters.Add("@companyId", SqlDbType.Int);
            p.Value = _item.companyId;
            p = sqlCommand.Parameters.Add("@billingGroupId", SqlDbType.Int);
            p.Value = _item.billingGroupId;
            p = sqlCommand.Parameters.Add("@accountIdByOffice", SqlDbType.Int);
            p.Value = _item.accountIdByOffice;
            p = sqlCommand.Parameters.Add("@amount", SqlDbType.Decimal);
            p.Value = _item.amount;
            p = sqlCommand.Parameters.Add("@chargeToVendor", SqlDbType.Bit);
            p.Value = _item.chargeToVendor;
            p = sqlCommand.Parameters.Add("@chargeToAgents", SqlDbType.Bit);
            p.Value = _item.chargeToAgents;
            p = sqlCommand.Parameters.Add("@divideAmountEqual", SqlDbType.Bit);
            p.Value = _item.divideAmountEqual;
            p = sqlCommand.Parameters.Add("@divideAmountTotal", SqlDbType.Bit);
            p.Value = _item.divideAmountTotal;
            p = sqlCommand.Parameters.Add("@vendorId", SqlDbType.Int);
            p.Value = _item.vendorId;
            p = sqlCommand.Parameters.Add("@orderDate", SqlDbType.VarChar, 50);
            p.Value = _item.orderDate;
            p = sqlCommand.Parameters.Add("@description", SqlDbType.VarChar, 1000);
            p.Value = _item.description;
            p = sqlCommand.Parameters.Add("@posted", SqlDbType.Bit);
            p.Value = _item.posted;
            p = sqlCommand.Parameters.Add("@saveAsTemplate", SqlDbType.Bit);
            p.Value = _item.saveAsTemplate;
            p = sqlCommand.Parameters.Add("@templateName", SqlDbType.VarChar, 1000);
            p.Value = _item.templateName;
            p = sqlCommand.Parameters.Add("@config", SqlDbType.Text);
            p.Value = _item.config;

            // detail
            p = sqlCommand.Parameters.Add("@items", SqlDbType.Structured);
            p.Direction = ParameterDirection.Input;
            p.TypeName = "itemsTableType";
            List<Item> listItems = (List<Item>)_item.detail;
            if (listItems.Count > 0)
            {
                p.Value = mapItems(listItems);
            }
            else
            {
                p.Value = null;
            }
        }

        protected List<SqlDataRecord> mapItems(IEnumerable<Item> items)
        {
            SqlMetaData[] tvpDetail =
            {
                new SqlMetaData("id", SqlDbType.Int),
                new SqlMetaData("type", SqlDbType.NVarChar, 100),
                new SqlMetaData("value", SqlDbType.NVarChar, 500),
            };

            List<SqlDataRecord> detail = new List<SqlDataRecord>();

            foreach (Item item in items)
            {
                var record = new SqlDataRecord(tvpDetail);

                record.SetInt32(0, item.id);
                if (!String.IsNullOrWhiteSpace(item.type))
                    record.SetString(1, item.type);
                if (!String.IsNullOrWhiteSpace(item.value))
                    record.SetString(2, item.value);
                detail.Add(record);
            }

            return detail;
        }
    }
}

```
## FeedDynamicParameter.cs
```cs
using Dapper;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using System.Data;
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Core.Models.Feeds;
using System.Data.SqlClient;
using Microsoft.SqlServer.Server;

namespace AT.AT2017.Api.DynamicParameters
{
    public class FeedDynamicParameter : SqlMapper.IDynamicParameters
    {
        private readonly Feed _feed;

        public FeedDynamicParameter(Feed feed)
        {
            _feed = feed;
        }

        void SqlMapper.IDynamicParameters.AddParameters(IDbCommand command, SqlMapper.Identity identity)
        {
            SqlParameter p;
            var sqlCommand = (SqlCommand)command;
            sqlCommand.CommandType = CommandType.StoredProcedure;

            p = sqlCommand.Parameters.Add("@feedID", SqlDbType.Int);
            p.Value = _feed.feedID;
            p = sqlCommand.Parameters.Add("@feedName", SqlDbType.VarChar, 100);
            p.Value = _feed.feedName;
            p = sqlCommand.Parameters.Add("@feedTypeID", SqlDbType.Int);
            p.Value = _feed.feedTypeID;
            p = sqlCommand.Parameters.Add("@feedSubtypeID", SqlDbType.Int);
            p.Value = _feed.feedSubtypeID;
            p = sqlCommand.Parameters.Add("@enableDataCleaned", SqlDbType.Bit);
            if (_feed.enabledDataCleanup == null)
            {
                p.Value = DBNull.Value;
            }
            else
            {
                p.Value = _feed.enabledDataCleanup;
            }
            p = sqlCommand.Parameters.Add("@allowInserts", SqlDbType.Bit);
            if (_feed.allowInserts == null)
            {
                p.Value = DBNull.Value;
            }
            else
            {
                p.Value = _feed.allowInserts;
            }
            p = sqlCommand.Parameters.Add("@autoApprove", SqlDbType.Bit);
            if(_feed.autoApprove == null)
            {
                p.Value = DBNull.Value;
            }
            else
            {
                p.Value = _feed.autoApprove;
            }
            p = sqlCommand.Parameters.Add("@feedCriteriaBefore", SqlDbType.VarChar);
            if (_feed.feedCriteriaBefore == null)
            {
                p.Value = DBNull.Value;
            }
            else
            {
                p.Value = _feed.feedCriteriaBefore;
            }
            p = sqlCommand.Parameters.Add("@feedCriteriaAfter", SqlDbType.VarChar);
            if (_feed.feedCriteriaAfter == null)
            {
                p.Value = DBNull.Value;
            }
            else
            {
                p.Value = _feed.feedCriteriaAfter;
            }
            p = sqlCommand.Parameters.Add("@feedResourceID", SqlDbType.Int);
            if (_feed.feedResourceID == null)
            {
                p.Value = DBNull.Value;
            }
            else
            {
                p.Value = _feed.feedResourceID;
            }
            p = sqlCommand.Parameters.Add("@url", SqlDbType.VarChar,800);
            p.Value = _feed.url;
            p = sqlCommand.Parameters.Add("@username", SqlDbType.VarChar, 800);
            p.Value = _feed.username;
            p = sqlCommand.Parameters.Add("@password", SqlDbType.VarChar,800);
            p.Value = _feed.password;
            p = sqlCommand.Parameters.Add("@additional", SqlDbType.VarChar, 800);
            if (_feed.additional == null)
            {
                p.Value = DBNull.Value;
            }
            else
            {
                p.Value = _feed.additional;
            }
            p = sqlCommand.Parameters.Add("@RetsUserAgent", SqlDbType.VarChar, 500);
            if (_feed.RetsUserAgent == null)
            {
                p.Value = DBNull.Value;
            }
            else
            {
                p.Value = _feed.RetsUserAgent;
            }
            p = sqlCommand.Parameters.Add("@EnableUserAgentAuth", SqlDbType.VarChar, 500);
            if (_feed.EnableUserAgentAuth == null)
            {
                p.Value = DBNull.Value;
            }
            else
            {
                p.Value = _feed.EnableUserAgentAuth;
            }
            p = sqlCommand.Parameters.Add("@UserAgentAuthType", SqlDbType.VarChar, 500);
            if (_feed.UserAgentAuthType == null)
            {
                p.Value = DBNull.Value;
            }
            else
            {
                p.Value = _feed.UserAgentAuthType;
            }
            p = sqlCommand.Parameters.Add("@UserAgentPassword", SqlDbType.VarChar, 500);
            if (_feed.UserAgentPassword == null)
            {
                p.Value = DBNull.Value;
            }
            else
            {
                p.Value = _feed.UserAgentPassword;
            }
            p = sqlCommand.Parameters.Add("@StandardNames", SqlDbType.VarChar, 500);
            if (_feed.StandardNames == null)
            {
                p.Value = DBNull.Value;
            }
            else
            {
                p.Value = _feed.StandardNames;
            }
            p = sqlCommand.Parameters.Add("@UseCompactFormat", SqlDbType.VarChar, 500);
            if (_feed.UseCompactFormat == null)
            {
                p.Value = DBNull.Value;
            }
            else
            {
                p.Value = _feed.UseCompactFormat;
            }
            p = sqlCommand.Parameters.Add("@UseBulkMetadata", SqlDbType.VarChar, 500);
            if (_feed.UseBulkMetadata == null)
            {
                p.Value = DBNull.Value;
            }
            else
            {
                p.Value = _feed.UseBulkMetadata;
            }
            p = sqlCommand.Parameters.Add("@IgnoreMetadataType", SqlDbType.VarChar, 500);
            if (_feed.IgnoreMetadataType == null)
            {
                p.Value = DBNull.Value;
            }
            else
            {
                p.Value = _feed.IgnoreMetadataType;
            }
            p = sqlCommand.Parameters.Add("@UseHttpLogging", SqlDbType.VarChar, 500);
            if (_feed.UseHttpLogging == null)
            {
                p.Value = DBNull.Value;
            }
            else
            {
                p.Value = _feed.UseHttpLogging;
            }
            p = sqlCommand.Parameters.Add("@HttpLogFile", SqlDbType.VarChar, 500);
            if (_feed.HttpLogFile == null)
            {
                p.Value = DBNull.Value;
            }
            else
            {
                p.Value = _feed.HttpLogFile;
            }
            p = sqlCommand.Parameters.Add("@UseDebugLogging", SqlDbType.VarChar, 500);
            if (_feed.UseDebugLogging == null)
            {
                p.Value = DBNull.Value;
            }
            else
            {
                p.Value = _feed.UseDebugLogging;
            }
            p = sqlCommand.Parameters.Add("@DebugLogFile", SqlDbType.VarChar, 500);
            if (_feed.DebugLogFile == null)
            {
                p.Value = DBNull.Value;
            }
            else
            {
                p.Value = _feed.DebugLogFile;
            }
            p = sqlCommand.Parameters.Add("@UseHttpGet", SqlDbType.VarChar, 500);
            if (_feed.UseHttpGet == null)
            {
                p.Value = DBNull.Value;
            }
            else
            {
                p.Value = _feed.UseHttpGet;
            }
            p = sqlCommand.Parameters.Add("@RetsVersion", SqlDbType.VarChar, 500);
            if (_feed.RetsVersion == null)
            {
                p.Value = DBNull.Value;
            }
            else
            {
                p.Value = _feed.RetsVersion;
            }
            p = sqlCommand.Parameters.Add("@sourcePrimaryKeyField1ID", SqlDbType.Int);
            if (_feed.sourcePrimaryKeyField1ID == null)
            {
                p.Value = DBNull.Value;
            }
            else
            {
                p.Value = _feed.sourcePrimaryKeyField1ID;
            }
            p = sqlCommand.Parameters.Add("@sourcePrimaryKeyField2ID", SqlDbType.Int);
            if (_feed.sourcePrimaryKeyField2ID == null)
            {
                p.Value = DBNull.Value;
            }
            else
            {
                p.Value = _feed.sourcePrimaryKeyField2ID;
            }
            p = sqlCommand.Parameters.Add("@destinationPrimaryKeyField1ID", SqlDbType.Int);
            if (_feed.destinationPrimaryKeyField1ID == null)
            {
                p.Value = DBNull.Value;
            }
            else
            {
                p.Value = _feed.destinationPrimaryKeyField1ID;
            }
            p = sqlCommand.Parameters.Add("@destinationPrimaryKeyField2ID", SqlDbType.Int);
            if (_feed.destinationPrimaryKeyField2ID == null)
            {
                p.Value = DBNull.Value;
            }
            else
            {
                p.Value = _feed.destinationPrimaryKeyField2ID;
            }
            p = sqlCommand.Parameters.Add("@sourceSecondaryKeyField1ID", SqlDbType.Int);
            if (_feed.sourceSecondaryKeyField1ID == null)
            {
                p.Value = DBNull.Value;
            }
            else
            {
                p.Value = _feed.sourceSecondaryKeyField1ID;
            }
            p = sqlCommand.Parameters.Add("@sourceSecondaryKeyField2ID", SqlDbType.Int);
            if (_feed.sourceSecondaryKeyField2ID == null)
            {
                p.Value = DBNull.Value;
            }
            else
            {
                p.Value = _feed.sourceSecondaryKeyField2ID;
            }
            p = sqlCommand.Parameters.Add("@destinationSecondaryKeyField1ID", SqlDbType.Int);
            if (_feed.destinationSecondaryKeyField1ID == null)
            {
                p.Value = DBNull.Value;
            }
            else
            {
                p.Value = _feed.destinationSecondaryKeyField1ID;
            }
            p = sqlCommand.Parameters.Add("@destinationSecondaryKeyField2ID", SqlDbType.Int);
            if (_feed.destinationSecondaryKeyField2ID == null)
            {
                p.Value = DBNull.Value;
            }
            else
            {
                p.Value = _feed.destinationSecondaryKeyField2ID;
            }
            p = sqlCommand.Parameters.Add("@sortOrder", SqlDbType.Int);
            if (_feed.sortOrder == null)
            {
                p.Value = DBNull.Value;
            }
            else
            {
                p.Value = _feed.sortOrder;
            }
            p = sqlCommand.Parameters.Add("@pullMode", SqlDbType.VarChar,20);
            p.Value = _feed.pullMode;
            p = sqlCommand.Parameters.Add("@timestampSourceFieldID", SqlDbType.Int);
            if (_feed.timestampSourceFieldID == null)
            { 
                p.Value = DBNull.Value;
            }
            else
            {
                p.Value = _feed.timestampSourceFieldID;
            }
            p = sqlCommand.Parameters.Add("@incrementalOverlapMins", SqlDbType.VarChar,50);
            if (_feed.incrementalOverlapMins == null)
            {
                p.Value = DBNull.Value;
            }
            else
            {
                p.Value = _feed.incrementalOverlapMins;
            }

            p = sqlCommand.Parameters.Add("@fullModeStartDate", SqlDbType.DateTime);
            if (_feed.fullModeStartDate == null)
            {
                p.Value = DBNull.Value;
            }
            else
            {
                p.Value = _feed.fullModeStartDate;
            }

            p = sqlCommand.Parameters.Add("@destinationTable", SqlDbType.VarChar, 100);
            if (_feed.destinationTable == null)
            {
                p.Value = DBNull.Value;
            }
            else
            {
                p.Value = _feed.destinationTable;
            }

            p = sqlCommand.Parameters.Add("@pullOnDemandSourceFieldID", SqlDbType.Int);
            if (_feed.pullOnDemandSourceFieldID == null)
            {
                p.Value = DBNull.Value;
            }
            else
            {
                p.Value = _feed.pullOnDemandSourceFieldID;
            }
            p = sqlCommand.Parameters.Add("@autoWithdraw", SqlDbType.Bit);
            p.Value = _feed.autoWithdraw;
            p = sqlCommand.Parameters.Add("@autoExpire", SqlDbType.Bit);
            p.Value = _feed.autoExpire;
            p = sqlCommand.Parameters.Add("@autoPend", SqlDbType.Bit);
            p.Value = _feed.autoPend;
            p = sqlCommand.Parameters.Add("@autoCancel", SqlDbType.Bit);
            p.Value = _feed.autoCancel;
            p = sqlCommand.Parameters.Add("@reactivateWithdrawn", SqlDbType.Bit);
            p.Value = _feed.reactivateWithdrawn;
            p = sqlCommand.Parameters.Add("@reactivateExpired", SqlDbType.Bit);
            p.Value = _feed.reactivateExpired;
            p = sqlCommand.Parameters.Add("@dashBrandCode", SqlDbType.VarChar, 50);
            if (_feed.dashBrandCode == null)
            {
                p.Value = DBNull.Value;
            }
            else
            {
                p.Value = _feed.dashBrandCode;
            }
            p = sqlCommand.Parameters.Add("@dashCategoryName", SqlDbType.VarChar, 50);
            if (_feed.dashCategoryname == null)
            {
                p.Value = DBNull.Value;
            }
            else
            {
                p.Value = _feed.dashCategoryname;
            }
            p = sqlCommand.Parameters.Add("@dashFromDate", SqlDbType.VarChar, 50);
            if (_feed.dashFromDate == null)
            {
                p.Value = DBNull.Value;
            }
            else
            {
                p.Value = _feed.dashFromDate;
            }
            p = sqlCommand.Parameters.Add("@dashToDate", SqlDbType.VarChar, 50);
            if (_feed.dashToDate == null)
            {
                p.Value = DBNull.Value;
            }
            else
            {
                p.Value = _feed.dashToDate;
            }
            p = sqlCommand.Parameters.Add("@dashTypeId", SqlDbType.VarChar, 50);
            if (_feed.dashTypeId == null)
            {
                p.Value = DBNull.Value;
            }
            else
            {
                p.Value = _feed.dashTypeId;
            }
            p = sqlCommand.Parameters.Add("@dashValueId", SqlDbType.VarChar, 50);
            if (_feed.dashValueId == null)
            {
                p.Value = DBNull.Value;
            }
            else
            {
                p.Value = _feed.dashValueId;
            }
            p = sqlCommand.Parameters.Add("@dashSecondaryURL", SqlDbType.VarChar, 500);
            if (_feed.dashSecondaryURL == null)
            {
                p.Value = DBNull.Value;
            }
            else
            {
                p.Value = _feed.dashSecondaryURL;
            }            
            p = sqlCommand.Parameters.Add("@dashATCategory", SqlDbType.VarChar, 50);
            if (_feed.dashATCategory== null)
            {
                p.Value = DBNull.Value;
            }
            else
            {
                p.Value = _feed.dashATCategory;
            }
            p = sqlCommand.Parameters.Add("@dashCompanyID", SqlDbType.VarChar, 50);
            if (_feed.dashCompanyId == null)
            {
                p.Value = DBNull.Value;
            }
            else
            {
                p.Value = _feed.dashCompanyId;
            }
            p = sqlCommand.Parameters.Add("@masterID", SqlDbType.Int);
            if (_feed.masterID == null)
            {
                p.Value = DBNull.Value;
            }
            else
            {
                p.Value = _feed.masterID;
            }
            p = sqlCommand.Parameters.Add("@sync", SqlDbType.Bit);
            p.Value = _feed.sync;
            p = sqlCommand.Parameters.Add("@syncConnection", SqlDbType.Bit);
            p.Value = _feed.syncConnection;
            p = sqlCommand.Parameters.Add("@syncMatching", SqlDbType.Bit);
            p.Value = _feed.syncMatching;
            p = sqlCommand.Parameters.Add("@syncPullDemand", SqlDbType.Bit);
            p.Value = _feed.syncPullDemand;
            p = sqlCommand.Parameters.Add("@syncSchedule", SqlDbType.Bit);
            p.Value = _feed.syncSchedule;
            p = sqlCommand.Parameters.Add("@syncFilter", SqlDbType.Bit);
            p.Value = _feed.syncFilter;
            p = sqlCommand.Parameters.Add("@syncMapping", SqlDbType.Bit);
            p.Value = _feed.syncMapping;
            p = sqlCommand.Parameters.Add("@syncTransformation", SqlDbType.Bit);
            p.Value = _feed.syncTransformation;
            p = sqlCommand.Parameters.Add("@syncPreferences", SqlDbType.Bit);
            p.Value = _feed.syncPreferences;

            p = sqlCommand.Parameters.Add("@initialCmd", SqlDbType.VarChar, 500);
            p.Value = _feed.initialCmd;
            p = sqlCommand.Parameters.Add("@supplementalResourceID", SqlDbType.Int);
            p.Value = _feed.supplementalResourceID;

            p = sqlCommand.Parameters.Add("@retryFailedRecords", SqlDbType.Bit);
            p.Value = _feed.retryFailedRecords;
            p = sqlCommand.Parameters.Add("@parentSourceFieldID1", SqlDbType.Int);
            p.Value = System.DBNull.Value;
            if (_feed.parentSourceFieldID1 != null)
            {
                p.Value = _feed.parentSourceFieldID1;
            }
            p = sqlCommand.Parameters.Add("@parentSourceFieldID2", SqlDbType.Int);
            p.Value = System.DBNull.Value;
            if (_feed.parentSourceFieldID2 != null)
            {
                p.Value = _feed.parentSourceFieldID2;
            }
            p = sqlCommand.Parameters.Add("@notes", SqlDbType.VarChar, 8000);
            if (_feed.notes == null)
            {
                p.Value = DBNull.Value;
            }
            else
            {
                p.Value = _feed.notes;
            }
            p = sqlCommand.Parameters.Add("@reviewedDate", SqlDbType.DateTime);
            if (_feed.reviewedDate == null)
            {
                p.Value = DBNull.Value;
            }
            else
            {
                p.Value = _feed.reviewedDate;
            }
            p = sqlCommand.Parameters.Add("@reviewedBy", SqlDbType.VarChar, 100);
            if (_feed.reviewedBy == null)
            {
                p.Value = DBNull.Value;
            }
            else
            {
                p.Value = _feed.reviewedBy;
            }

            p = sqlCommand.Parameters.Add("@limitNumber", SqlDbType.Int);
            if (_feed.limitNumber == null)
            {
                p.Value = DBNull.Value;
            }
            else
            {
                p.Value = _feed.limitNumber;
            }

            p = sqlCommand.Parameters.Add("@createExpired", SqlDbType.Bit);
            p.Value = _feed.createExpired;
            p = sqlCommand.Parameters.Add("@createWithdrawn", SqlDbType.Bit);
            p.Value = _feed.createWithdrawn;
            p = sqlCommand.Parameters.Add("@createClosed", SqlDbType.Bit);
            p.Value = _feed.createClosed;
            p = sqlCommand.Parameters.Add("@createCancelled", SqlDbType.Bit);
            p.Value = _feed.createCancelled;

            p = sqlCommand.Parameters.Add("@encodingTypeCode", SqlDbType.VarChar,50);
            if (_feed.encodingTypeCode == null)
            {
                p.Value = DBNull.Value;
            }
            else
            {
                p.Value = _feed.encodingTypeCode;
            }

            p = sqlCommand.Parameters.Add("@endpointList", SqlDbType.VarChar);
            if (_feed.endpointList == null)
            {
                p.Value = DBNull.Value;
            }
            else
            {
                p.Value = _feed.endpointList;
            }

            p = sqlCommand.Parameters.Add("@endpointDetail", SqlDbType.VarChar);
            if (_feed.endpointDetail == null)
            {
                p.Value = DBNull.Value;
            }
            else
            {
                p.Value = _feed.endpointDetail;
            }

            p = sqlCommand.Parameters.Add("@endpointPullOnDemand", SqlDbType.VarChar);
            if (_feed.endpointPullOnDemand == null)
            {
                p.Value = DBNull.Value;
            }
            else
            {
                p.Value = _feed.endpointPullOnDemand;
            }

            p = sqlCommand.Parameters.Add("@endpointToken", SqlDbType.VarChar);
            if (_feed.endpointToken == null)
            {
                p.Value = DBNull.Value;
            }
            else
            {
                p.Value = _feed.endpointToken;
            }

            p = sqlCommand.Parameters.Add("@primaryMatchingAdvanced", SqlDbType.VarChar);
            if (_feed.primaryMatchingAdvanced == null)
            {
                p.Value = DBNull.Value;
            }
            else
            {
                p.Value = _feed.primaryMatchingAdvanced;
            }

            p = sqlCommand.Parameters.Add("@secondaryMatchingAdvanced", SqlDbType.VarChar);
            if (_feed.secondaryMatchingAdvanced == null)
            {
                p.Value = DBNull.Value;
            }
            else
            {
                p.Value = _feed.secondaryMatchingAdvanced;
            }

            p = sqlCommand.Parameters.Add("@customFilterExpression", SqlDbType.VarChar, 500);
            if (string.IsNullOrEmpty(_feed.customFilterExpression))
            {
                p.Value = DBNull.Value;
            }
            else
            {
                p.Value = _feed.customFilterExpression;
            }

            //matching
            p = sqlCommand.Parameters.Add("@matching", SqlDbType.Structured);
            p.Direction = ParameterDirection.Input;
            p.TypeName = "feedMatchingTableType";
            List<FeedMatching> matching = (List<FeedMatching>)_feed.matching;
            if (matching.Count > 0)
            {
                p.Value = mapFeedMatching(_feed.matching);
            }
            else
            {
                p.Value = null;
            }

            //filter
            p = sqlCommand.Parameters.Add("@filter", SqlDbType.Structured);
            p.Direction = ParameterDirection.Input;
            p.TypeName = "feedFilterTableType";
            List<FeedFilter> filter = (List<FeedFilter>)_feed.filter;
            if (filter.Count > 0)
            {
                p.Value = mapFeedFilter(_feed.filter);
            }
            else
            {
                p.Value = null;
            }            

            //filterDetail
            p = sqlCommand.Parameters.Add("@filterDetail", SqlDbType.Structured);
            p.Direction = ParameterDirection.Input;
            p.TypeName = "feedFilterDetailTableType";
            List<FeedFilterDetail> filterDetail = (List<FeedFilterDetail>)_feed.filterDetail;
            if (filterDetail.Count > 0)
            {
                p.Value = mapFeedFilterDetail(_feed.filterDetail);
            }
            else
            {
                p.Value = null;
            }

            //podfilter
            p = sqlCommand.Parameters.Add("@podFilter", SqlDbType.Structured);
            p.Direction = ParameterDirection.Input;
            p.TypeName = "feedPODFilterTableType";
            List<FeedPODFilter> podFilter = (List<FeedPODFilter>)_feed.podFilter;
            if (podFilter.Count > 0)
            {
                p.Value = mapFeedPODFilter(_feed.podFilter);
            }
            else
            {
                p.Value = null;
            }

            //mapping
            p = sqlCommand.Parameters.Add("@mapping", SqlDbType.Structured);
            p.Direction = ParameterDirection.Input;
            p.TypeName = "feedMappingTableType";
            List<FeedMapping> mapping = (List<FeedMapping>)_feed.mapping;
            if (mapping.Count > 0)
            {
                p.Value = p.Value = mapFeedMapping(_feed.mapping);
            }
            else
            {
                p.Value = null;
            }            

            //mappingDetail
            p = sqlCommand.Parameters.Add("@mappingDetail", SqlDbType.Structured);
            p.Direction = ParameterDirection.Input;
            p.TypeName = "feedMappingDetailTableType";
            List<FeedMappingDetail> mappingDetail = (List<FeedMappingDetail>)_feed.mappingDetail;
            if (mappingDetail.Count > 0)
            {
                p.Value = mapFeedMappingDetail(_feed.mappingDetail);
            }
            else
            {
                p.Value = null;
            }            

            //transformation
            p = sqlCommand.Parameters.Add("@transformation", SqlDbType.Structured);
            p.Direction = ParameterDirection.Input;
            p.TypeName = "feedTransformationTableType";
            List<FeedTransformation> trasformation = (List<FeedTransformation>)_feed.transformation;
            if (trasformation.Count > 0)
            {
                p.Value = mapFeedTransformation(_feed.transformation);
            }
            else
            {
                p.Value = null;
            }
            
            //schedule
            p = sqlCommand.Parameters.Add("@schedule", SqlDbType.Structured);
            p.Direction = ParameterDirection.Input;
            p.TypeName = "feedScheduleTableType";
            List<FeedSchedule> schedule = (List<FeedSchedule>)_feed.schedule;
            if (schedule.Count > 0)
            {
                p.Value = mapFeedSchedule(_feed.schedule);
            }
            else
            {
                p.Value = null;
            }


            //relation
            p = sqlCommand.Parameters.Add("@relation", SqlDbType.Structured);
            p.Direction = ParameterDirection.Input;
            p.TypeName = "feedRelationshipTableType";
            List<FeedRelationship> relation = (List<FeedRelationship>)_feed.relation;
            if (relation.Count > 0)
            {
                p.Value = mapFeedRelationship(_feed.relation);
            }
            else
            {
                p.Value = null;
            }
        }

        protected List<SqlDataRecord> mapFeedMatching(IEnumerable<FeedMatching> matching)
        {
            SqlMetaData[] tvpMatching =
            {
                new SqlMetaData("feedMatchingID", SqlDbType.Int),                
                new SqlMetaData("feedID", SqlDbType.Int),
                new SqlMetaData("sort", SqlDbType.Int),
                new SqlMetaData("sourceFieldID", SqlDbType.Int),
                new SqlMetaData("atFieldID", SqlDbType.Int),
                new SqlMetaData("useFunctionSource", SqlDbType.Bit),
                new SqlMetaData("useFunctionDestination", SqlDbType.Bit),
                new SqlMetaData("functionSourceValue", SqlDbType.VarChar, 1000),
                new SqlMetaData("functionDestinationValue", SqlDbType.VarChar, 1000),
                new SqlMetaData("matchingType", SqlDbType.VarChar, 50)
            };

            List<SqlDataRecord> records = new List<SqlDataRecord>();

            foreach (FeedMatching item in matching)
            {
                var record = new SqlDataRecord(tvpMatching);

                record.SetInt32(0, item.feedMatchingID);
                record.SetInt32(1, item.feedID);
                record.SetInt32(2, item.sort);
                record.SetInt32(3, item.sourceFieldID);
                record.SetInt32(4, item.atFieldID.GetValueOrDefault());
                record.SetBoolean(5, item.useFunctionSource);
                record.SetBoolean(6, item.useFunctionDestination);
                record.SetString(7, item.functionSourceValue);
                record.SetString(8, item.functionDestinationValue);
                record.SetString(9, item.matchingType);
                records.Add(record);
            }

            return records;
        }

        protected List<SqlDataRecord> mapFeedFilter(IEnumerable<FeedFilter> filter)
        {
            SqlMetaData[] tvpFilter =
            {
                new SqlMetaData("feedFilterID", SqlDbType.Int),
                new SqlMetaData("feedId", SqlDbType.Int),
                new SqlMetaData("feedResourceID", SqlDbType.Int),
                new SqlMetaData("sourceFieldID", SqlDbType.Int),
                new SqlMetaData("feedOperator", SqlDbType.VarChar, 1000),
                new SqlMetaData("value", SqlDbType.VarChar, 1000),
                new SqlMetaData("connector", SqlDbType.VarChar,10),
                new SqlMetaData("useFunction", SqlDbType.Bit),
                new SqlMetaData("masterID", SqlDbType.Int),
                new SqlMetaData("sortOrder", SqlDbType.Int)
            };

            List<SqlDataRecord> records = new List<SqlDataRecord>();

            foreach (FeedFilter item in filter)
            {
                var record = new SqlDataRecord(tvpFilter);

                record.SetInt32(0, item.feedFilterID);
                record.SetInt32(1, item.feedId);
                record.SetInt32(2, item.feedResourceID.GetValueOrDefault());
                record.SetInt32(3, item.sourceFieldID.GetValueOrDefault());
                record.SetString(4, item.feedOperator);
                record.SetString(5, item.value);
                record.SetString(6, item.connector);
                record.SetBoolean(7, item.useFunction);
                if (item.masterID == null)
                {
                    record.SetDBNull(8);
                }
                else
                {
                    record.SetInt32(8, item.masterID.GetValueOrDefault());
                }
                if (item.sortOrder == 0)
                {
                    record.SetDBNull(9);
                }
                else
                {
                    record.SetInt32(9, item.sortOrder);
                }

                records.Add(record);
            }

            return records;
        }

        protected List<SqlDataRecord> mapFeedFilterDetail(IEnumerable<FeedFilterDetail> filterDetail)
        {
            SqlMetaData[] tvpFilterDetail =
            {
                new SqlMetaData("feedFilterDetailID", SqlDbType.Int),
                new SqlMetaData("feedFilterID", SqlDbType.Int),
                new SqlMetaData("lookupID", SqlDbType.Int),
                new SqlMetaData("value", SqlDbType.VarChar, 500),
                new SqlMetaData("masterID", SqlDbType.Int)
            };

            List<SqlDataRecord> records = new List<SqlDataRecord>();

            foreach (FeedFilterDetail item in filterDetail)
            {
                var record = new SqlDataRecord(tvpFilterDetail);

                record.SetInt32(0, item.feedFilterDetailID);
                record.SetInt32(1, item.feedFilterID);
                record.SetInt32(2, item.lookupID.GetValueOrDefault());
                record.SetString(3, item.value);
                if (item.masterID == null)
                {
                    record.SetDBNull(4);
                }
                else
                {
                    record.SetInt32(4, item.masterID.GetValueOrDefault());
                }
                records.Add(record);
            }

            return records;
        }

        protected List<SqlDataRecord> mapFeedPODFilter(IEnumerable<FeedPODFilter> podFilter)
        {
            SqlMetaData[] tvpFilter =
            {
                new SqlMetaData("feedFilterID", SqlDbType.Int),
                new SqlMetaData("feedId", SqlDbType.Int),
                new SqlMetaData("sourceFieldID", SqlDbType.Int),
                new SqlMetaData("masterID", SqlDbType.Int)
            };

            List<SqlDataRecord> records = new List<SqlDataRecord>();

            foreach (FeedPODFilter item in podFilter)
            {
                var record = new SqlDataRecord(tvpFilter);

                record.SetInt32(0, item.feedFilterID);
                record.SetInt32(1, item.feedID);
                record.SetInt32(2, item.sourceFieldID.GetValueOrDefault());
                if (item.masterID == null)
                {
                    record.SetDBNull(3);
                }
                else
                {
                    record.SetInt32(3, item.masterID.GetValueOrDefault());
                }

                records.Add(record);
            }

            return records;
        }
        protected List<SqlDataRecord> mapFeedMapping(IEnumerable<FeedMapping> mapping)
        {
            SqlMetaData[] tvpMapping =
            {
                new SqlMetaData("mappingID", SqlDbType.Int),
                new SqlMetaData("feedId", SqlDbType.Int),
                new SqlMetaData("sourceFieldID", SqlDbType.Int),
                new SqlMetaData("atFieldID", SqlDbType.Int),
                new SqlMetaData("at2000FieldName", SqlDbType.VarChar, 100),
                new SqlMetaData("tpFieldName", SqlDbType.VarChar, 100),
                new SqlMetaData("updateRule", SqlDbType.VarChar,100),
                new SqlMetaData("createMultipleRows", SqlDbType.Bit),
                new SqlMetaData("multiMappingRule", SqlDbType.VarChar,100),
                new SqlMetaData("masterID", SqlDbType.Int)
            };
            

        List<SqlDataRecord> records = new List<SqlDataRecord>();

            foreach (FeedMapping item in mapping)
            {
                var record = new SqlDataRecord(tvpMapping);

                record.SetInt32(0, item.mappingID);
                record.SetInt32(1, item.feedID.GetValueOrDefault());
                record.SetInt32(2, item.sourceFieldID.GetValueOrDefault());
                record.SetInt32(3, item.atFieldID.GetValueOrDefault());
                record.SetString(4, (item.at2000FieldName == null ? "" : item.at2000FieldName));
                record.SetString(5, (item.tpFieldName == null ? "" : item.tpFieldName));
                record.SetString(6, item.updateRule);
                record.SetSqlBoolean(7, item.createMultipleRows.GetValueOrDefault());
                record.SetString(8, item.multiMappingRule);
                if (item.masterID == null)
                {
                    record.SetDBNull(9);
                }
                else
                {
                    record.SetInt32(9, item.masterID.GetValueOrDefault());
                }

                records.Add(record);
            }

            return records;
        }

        protected List<SqlDataRecord> mapFeedMappingDetail(IEnumerable<FeedMappingDetail> mappingDetail)
        {
            SqlMetaData[] tvpMappingDetail =
            {
                new SqlMetaData("mappingDetailID", SqlDbType.Int),
                new SqlMetaData("mappingID", SqlDbType.Int),
                new SqlMetaData("atFieldID", SqlDbType.Int),
                new SqlMetaData("masterID", SqlDbType.Int),
                new SqlMetaData("multipleRows", SqlDbType.Bit)
            };
            
            List<SqlDataRecord> records = new List<SqlDataRecord>();

            foreach (FeedMappingDetail item in mappingDetail)
            {
                var record = new SqlDataRecord(tvpMappingDetail);
                record.SetInt32(0, item.mappingDetailID);
                record.SetInt32(1, item.mappingID.GetValueOrDefault());
                record.SetInt32(2, item.atFieldID.GetValueOrDefault());
                if (item.masterID == null)
                {
                    record.SetDBNull(3);
                }
                else
                {
                    record.SetInt32(3, item.masterID.GetValueOrDefault());
                }
                record.SetBoolean(4, item.multipleRows);
                records.Add(record);
            }

            return records;
        }

        protected List<SqlDataRecord> mapFeedTransformation(IEnumerable<FeedTransformation> transformation)
        {
            SqlMetaData[] tvpTransformation =
            {
                new SqlMetaData("transformationID", SqlDbType.Int),
                new SqlMetaData("mappingID", SqlDbType.Int),
                new SqlMetaData("condition", SqlDbType.VarChar, -1),
                new SqlMetaData("replaceWith", SqlDbType.VarChar, -1),
                new SqlMetaData("sourceFieldID", SqlDbType.Int),
                new SqlMetaData("operator", SqlDbType.VarChar, 50),
                new SqlMetaData("sourceValue", SqlDbType.VarChar, 500),
                new SqlMetaData("destinationValue", SqlDbType.VarChar, 500),
                new SqlMetaData("mappingDetailID", SqlDbType.Int),
                new SqlMetaData("isAdvanced", SqlDbType.Bit),
                new SqlMetaData("masterID", SqlDbType.Int),
                new SqlMetaData("sortOrder", SqlDbType.Int)
            };


            List<SqlDataRecord> records = new List<SqlDataRecord>();

            foreach (FeedTransformation item in transformation)
            {
                var record = new SqlDataRecord(tvpTransformation);

                record.SetInt32(0, item.transformationID);
                record.SetInt32(1, item.mappingID.GetValueOrDefault());
                record.SetString(2, item.condition);
                record.SetString(3, item.replaceWith);
                record.SetInt32(4, item.sourceFieldID);
                if (string.IsNullOrEmpty(item.feedOperator))
                {
                    record.SetDBNull(5);
                }
                else
                {
                    record.SetString(5, item.feedOperator);
                }
                if (string.IsNullOrEmpty(item.sourceValue))
                {
                    record.SetDBNull(6);
                }
                else
                {
                    record.SetString(6, item.sourceValue);
                }
                if (string.IsNullOrEmpty(item.destinationValue))
                {
                    record.SetDBNull(7);
                }
                else
                {
                    record.SetString(7, item.destinationValue);
                }
                if (item.mappingDetailID == null)
                {
                    record.SetDBNull(8);
                }
                else
                {
                    record.SetInt32(8, item.mappingDetailID.GetValueOrDefault());
                }
                record.SetBoolean(9, item.isAdvanced);
                if (item.masterID == null)
                {
                    record.SetDBNull(10);
                }
                else
                {
                    record.SetInt32(10, item.masterID.GetValueOrDefault());
                }
                record.SetInt32(11, item.sortOrder);
                records.Add(record);
            }

            return records;
        }

        protected List<SqlDataRecord> mapFeedSchedule(IEnumerable<FeedSchedule> schedule)
        {
            SqlMetaData[] tvpSchedule =
            {
                new SqlMetaData("scheduleID", SqlDbType.Int),
                new SqlMetaData("feedID", SqlDbType.Int),
                new SqlMetaData("startTime", SqlDbType.DateTime),
                new SqlMetaData("serverName", SqlDbType.VarChar, 100),
                new SqlMetaData("masterID", SqlDbType.Int)
            };


            List<SqlDataRecord> records = new List<SqlDataRecord>();

            foreach (FeedSchedule item in schedule)
            {
                var record = new SqlDataRecord(tvpSchedule);

                record.SetInt32(0, item.scheduleID);
                record.SetInt32(1, item.feedID);
                record.SetDateTime(2, item.startTime.GetValueOrDefault());
                record.SetString(3, item.serverName);
                if (item.masterID == null)
                {
                    record.SetDBNull(4);
                }
                else
                {
                    record.SetInt32(4, item.masterID.GetValueOrDefault());
                }
                records.Add(record);
            }

            return records;
        }

        protected List<SqlDataRecord> mapFeedRelationship(IEnumerable<FeedRelationship> relation)
        {
            SqlMetaData[] tvpRelation =
            {
                new SqlMetaData("feedRelationshipID", SqlDbType.Int),
                new SqlMetaData("sourceFieldID", SqlDbType.Int),
                new SqlMetaData("feedResourceID", SqlDbType.Int),
                new SqlMetaData("destinationTable", SqlDbType.VarChar, 50),
                new SqlMetaData("type", SqlDbType.VarChar, 50),
                new SqlMetaData("updateRule",SqlDbType.VarChar, 100),
                new SqlMetaData("condition",SqlDbType.VarChar, 1000),
                new SqlMetaData("where",SqlDbType.VarChar, 1000),
                new SqlMetaData("feedID", SqlDbType.Int)
            };

            List<SqlDataRecord> records = new List<SqlDataRecord>();

            foreach (FeedRelationship item in relation)
            {
                var record = new SqlDataRecord(tvpRelation);

                record.SetInt32(0, item.feedRelationshipID);
                record.SetInt32(1, item.sourceFieldID);
                record.SetInt32(2, item.feedResourceID);
                record.SetString(3, item.destinationTable);
                record.SetString(4, item.type);
                record.SetString(5, item.updateRule);
                if (item.condition!= null)
                {
                    record.SetString(6, item.condition);
                }
                if (item.where != null)
                {
                    record.SetString(7, item.where);
                }
                record.SetInt32(8, item.feedID);
                records.Add(record);
            }

            return records;
        }

    }
}

```
## FeedResourceDynamicParameter.cs
```cs
using Dapper;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using System.Data;
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Core.Models.Feeds;
using System.Data.SqlClient;
using Microsoft.SqlServer.Server;

namespace AT.AT2017.Api.DynamicParameters
{
    public class FeedResourceDynamicParameter : SqlMapper.IDynamicParameters
    {
        private readonly FeedResource _feedResource;

        public FeedResourceDynamicParameter(FeedResource feedResource)
        {
            _feedResource = feedResource;
        }

        void SqlMapper.IDynamicParameters.AddParameters(IDbCommand command, SqlMapper.Identity identity)
        {
            SqlParameter p;
            var sqlCommand = (SqlCommand)command;
            sqlCommand.CommandType = CommandType.StoredProcedure;
           
            p = sqlCommand.Parameters.Add("@feedResourceID", SqlDbType.Int);
            p.Value = _feedResource.feedResourceID;
            p = sqlCommand.Parameters.Add("@resource", SqlDbType.VarChar, 100);
            p.Value = _feedResource.resource;
            p = sqlCommand.Parameters.Add("@feedTypeID", SqlDbType.Int);
            p.Value = _feedResource.feedTypeID;
            p = sqlCommand.Parameters.Add("@feedSubtypeID", SqlDbType.Int);
            p.Value = _feedResource.feedSubtypeID;            

            //detail
            p = sqlCommand.Parameters.Add("@detail", SqlDbType.Structured);
            p.Direction = ParameterDirection.Input;
            p.TypeName = "feedSourceFieldsTableType";
            List<FeedSourceField> detail = (List<FeedSourceField>)_feedResource.feedSourceFields;
            if (detail.Count > 0)
            {
                p.Value = mapFeedSourceFieldDetail(_feedResource.feedSourceFields);
            }
            else
            {
                p.Value = null;
            }

        }

        protected List<SqlDataRecord> mapFeedSourceFieldDetail(IEnumerable<FeedSourceField> detail)
        {
            SqlMetaData[] tvpDetail =
            {
                new SqlMetaData("sourceFieldID", SqlDbType.Int),
                new SqlMetaData("feedResourceID", SqlDbType.Int),
                new SqlMetaData("sourceField",SqlDbType.NVarChar, 400),
                new SqlMetaData("resource", SqlDbType.NVarChar,400),
                new SqlMetaData("multiValue", SqlDbType.Bit ),
                new SqlMetaData("SystemName", SqlDbType.NVarChar,400),
                new SqlMetaData("StandardName", SqlDbType.NVarChar,400),
                new SqlMetaData("LongName", SqlDbType.NVarChar,400),
                new SqlMetaData("DBName", SqlDbType.NVarChar,400),
                new SqlMetaData("ShortName", SqlDbType.NVarChar,400),
                new SqlMetaData("LookupName", SqlDbType.NVarChar,400),
                new SqlMetaData("MaximumLength", SqlDbType.NVarChar,400),
                new SqlMetaData("DataType", SqlDbType.NVarChar,400),
                new SqlMetaData("Interpretation", SqlDbType.NVarChar,400),
                new SqlMetaData("Precision", SqlDbType.NVarChar,400),
                new SqlMetaData("Searchable", SqlDbType.NVarChar,400),
                new SqlMetaData("UseSeparator", SqlDbType.NVarChar,400),
            };

            List<SqlDataRecord> records = new List<SqlDataRecord>();

            foreach (FeedSourceField item in detail)
            {
                var record = new SqlDataRecord(tvpDetail);

                record.SetInt32(0, item.sourceFieldID);
                record.SetInt32(1, item.feedResourceID.GetValueOrDefault());
                record.SetString(2, item.sourceField);
                            
                records.Add(record);
            }

            return records;
        }

    }
}

```
## FeedResourceMetaDataDynamicParameter.cs
```cs
using AT.AT2017.Api.Core.Models;
using Dapper;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using System.Data;
using System.Data.SqlClient;
using Microsoft.SqlServer.Server;

namespace AT.AT2017.Api.DynamicParameters
{
    public class FeedResourceMetaDataDynamicParameter : SqlMapper.IDynamicParameters
    {

        private FeedResourceMetaData _feedResourcesMetaData;

        public FeedResourceMetaDataDynamicParameter(FeedResourceMetaData feedResourcesMetaData)
        {
            _feedResourcesMetaData = feedResourcesMetaData;
        }

        void SqlMapper.IDynamicParameters.AddParameters(IDbCommand command, SqlMapper.Identity identity)
        {
            SqlParameter p;
            var sqlCommand = (SqlCommand)command;
            sqlCommand.CommandType = CommandType.StoredProcedure;

            // feedResources
            p = sqlCommand.Parameters.Add("@feedResources", SqlDbType.Structured);
            p.Direction = ParameterDirection.Input;
            p.TypeName = "feedResourcesTableType";
            List<FeedResource> feedResources = (List<FeedResource>)_feedResourcesMetaData.feedResources;
            if (feedResources.Count > 0)
            {
                p.Value = mapfeedResource(feedResources);
            }
            else
            {
                p.Value = null;
            }

            // feedSourceFields
            p = sqlCommand.Parameters.Add("@feedSourceFields", SqlDbType.Structured);
            p.Direction = ParameterDirection.Input;
            p.TypeName = "feedSourceFieldsTableType";
            List<FeedSourceField> feedSourceFields = (List<FeedSourceField>)_feedResourcesMetaData.feedSourceFields;
            if (feedSourceFields.Count > 0)
            {
                p.Value = mapfeedSourceField(feedSourceFields);
            }
            else
            {
                p.Value = null;
            }

            // feedSourceFieldsLookup
            p = sqlCommand.Parameters.Add("@feedSourceFieldsLookup", SqlDbType.Structured);
            p.Direction = ParameterDirection.Input;
            p.TypeName = "feedSourceFieldsLookupTableType";
            List<FeedSourceFieldLookup> feedSourceFieldsLookup = (List<FeedSourceFieldLookup>)_feedResourcesMetaData.feedSourceFieldsLookup ;
            if (feedSourceFieldsLookup.Count > 0)
            {
                p.Value = mapfeedSourceFieldsLookup(feedSourceFieldsLookup);
            }
            else
            {
                p.Value = null;
            }

        }

        protected List<SqlDataRecord> mapfeedResource(IEnumerable<FeedResource> feedResources)
        {
            SqlMetaData[] tvpDetail =
            {
                new SqlMetaData("feedResourceID", SqlDbType.Int),
                new SqlMetaData("feedSubtypeID", SqlDbType.Int),
                new SqlMetaData("feedTypeID", SqlDbType.Int),
                new SqlMetaData("resource",SqlDbType.NVarChar, 400),
                new SqlMetaData("resourceDescription", SqlDbType.NVarChar,400),
            };

            List<SqlDataRecord> detail = new List<SqlDataRecord>();

            foreach (FeedResource itemFeedResources in feedResources)
            {
                var record = new SqlDataRecord(tvpDetail);
                record.SetInt32(0, itemFeedResources.feedResourceID);
                if (itemFeedResources.feedSubtypeID != null)
                    record.SetInt32(1, itemFeedResources.feedSubtypeID.GetValueOrDefault());
                if (itemFeedResources.feedTypeID != null)
                    record.SetInt32(2, itemFeedResources.feedTypeID.GetValueOrDefault());
                if (itemFeedResources.resource != null)
                    record.SetSqlString(3, itemFeedResources.resource);
                if (itemFeedResources.resourceDescription != null)
                    record.SetSqlString(4, itemFeedResources.resourceDescription);
                detail.Add(record);
            }


            return detail;
        }

        protected List<SqlDataRecord> mapfeedSourceField(IEnumerable<FeedSourceField> feedSourceFields)
        {
            SqlMetaData[] tvpDetail =
            {
                new SqlMetaData("sourceFieldID", SqlDbType.Int),
                new SqlMetaData("feedResourceID", SqlDbType.Int),
                new SqlMetaData("sourceField",SqlDbType.NVarChar, 400),
                new SqlMetaData("resource", SqlDbType.NVarChar,400),
                new SqlMetaData("multiValue", SqlDbType.Bit ),
                new SqlMetaData("SystemName", SqlDbType.NVarChar,400),
                new SqlMetaData("StandardName", SqlDbType.NVarChar,400),
                new SqlMetaData("LongName", SqlDbType.NVarChar,400),
                new SqlMetaData("DBName", SqlDbType.NVarChar,400),
                new SqlMetaData("ShortName", SqlDbType.NVarChar,400),
                new SqlMetaData("LookupName", SqlDbType.NVarChar,400),
                new SqlMetaData("MaximumLength", SqlDbType.NVarChar,400),
                new SqlMetaData("DataType", SqlDbType.NVarChar,400),
                new SqlMetaData("Interpretation", SqlDbType.NVarChar,400),
                new SqlMetaData("Precision", SqlDbType.NVarChar,400),
                new SqlMetaData("Searchable", SqlDbType.NVarChar,400),
                new SqlMetaData("UseSeparator", SqlDbType.NVarChar,400),
            };

            List<SqlDataRecord> detail = new List<SqlDataRecord>();

            foreach (FeedSourceField itemfeedSourceFields in feedSourceFields)
            {
                var record = new SqlDataRecord(tvpDetail);
                record.SetInt32(0, itemfeedSourceFields.sourceFieldID);
                if (itemfeedSourceFields.feedResourceID != null)
                    record.SetInt32(1, itemfeedSourceFields.feedResourceID.GetValueOrDefault());
                if (itemfeedSourceFields.sourceField != null)
                    record.SetSqlString(2, itemfeedSourceFields.sourceField);
                if (itemfeedSourceFields.resource != null)
                    record.SetSqlString(3, itemfeedSourceFields.resource );
                if (itemfeedSourceFields.multiValue != null)
                    record.SetSqlBoolean(4, itemfeedSourceFields.multiValue.GetValueOrDefault());
                if (itemfeedSourceFields.SystemName != null)
                    record.SetSqlString(5, itemfeedSourceFields.SystemName);
                if (itemfeedSourceFields.StandardName != null)
                    record.SetSqlString(6, itemfeedSourceFields.StandardName);
                if (itemfeedSourceFields.LongName != null)
                    record.SetSqlString(7, itemfeedSourceFields.LongName);
                if (itemfeedSourceFields.DBName != null)
                    record.SetSqlString(8, itemfeedSourceFields.DBName);
                if (itemfeedSourceFields.ShortName != null)
                    record.SetSqlString(9, itemfeedSourceFields.ShortName);
                if (itemfeedSourceFields.LookupName != null)
                    record.SetSqlString(10, itemfeedSourceFields.LookupName);
                if (itemfeedSourceFields.MaximumLength != null)
                    record.SetSqlString(11, itemfeedSourceFields.MaximumLength);
                if (itemfeedSourceFields.DataType != null)
                    record.SetSqlString(12, itemfeedSourceFields.DataType);
                if (itemfeedSourceFields.Interpretation != null)
                    record.SetSqlString(13, itemfeedSourceFields.Interpretation);
                if (itemfeedSourceFields.Precision != null)
                    record.SetSqlString(14, itemfeedSourceFields.Precision);
                if (itemfeedSourceFields.Searchable != null)
                    record.SetSqlString(15, itemfeedSourceFields.Searchable);
                if (itemfeedSourceFields.UseSeparator != null)
                    record.SetSqlString(16, itemfeedSourceFields.UseSeparator);
                detail.Add(record);
            }


            return detail;
        }

        protected List<SqlDataRecord> mapfeedSourceFieldsLookup(IEnumerable<FeedSourceFieldLookup> feedSourceFieldsLookup)
        {
            SqlMetaData[] tvpDetail =
            {
                new SqlMetaData("lookupID", SqlDbType.Int),
                new SqlMetaData("feedSubtypeId", SqlDbType.Int),
                new SqlMetaData("lookupName",SqlDbType.NVarChar, 400),
                new SqlMetaData("longValue",SqlDbType.NVarChar, 400),
                new SqlMetaData("shortValue",SqlDbType.NVarChar, 400),
                new SqlMetaData("value",SqlDbType.NVarChar, 400),
            };

            List<SqlDataRecord> detail = new List<SqlDataRecord>();

            foreach (FeedSourceFieldLookup itemfeedSourceFieldsLookup in feedSourceFieldsLookup)
            {
                var record = new SqlDataRecord(tvpDetail);
                record.SetInt32(0, itemfeedSourceFieldsLookup.lookupID);
                if (itemfeedSourceFieldsLookup.feedSubtypeId != null)
                    record.SetInt32(1, itemfeedSourceFieldsLookup.feedSubtypeId.GetValueOrDefault());
                if (itemfeedSourceFieldsLookup.lookupName != null)
                    record.SetSqlString(2, itemfeedSourceFieldsLookup.lookupName);
                if (itemfeedSourceFieldsLookup.longValue != null)
                    record.SetSqlString(3, itemfeedSourceFieldsLookup.longValue);
                if (itemfeedSourceFieldsLookup.shortValue != null)
                    record.SetSqlString(4, itemfeedSourceFieldsLookup.shortValue);
                if (itemfeedSourceFieldsLookup.value != null)
                    record.SetSqlString(5, itemfeedSourceFieldsLookup.value );

                detail.Add(record);
            }


            return detail;
        }
    }
}

```
## GLAccountFortePersonTypeDynamicParameter.cs
```cs
using Dapper;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using System.Data;
using AT.AT2017.Api.Core.Models;
using System.Data.SqlClient;
using Microsoft.SqlServer.Server;

namespace AT.AT2017.Api.DynamicParameters
{
    public class GLAccountFortePersonTypeDynamicParameter : SqlMapper.IDynamicParameters
    {
        private readonly IEnumerable<GLAccountFortePersonType> _items;
        private int _accountId;
        private string _forteMerchantId;

        public GLAccountFortePersonTypeDynamicParameter(IEnumerable<GLAccountFortePersonType> items,int accountId, string forteMerchantId)
        {
            _items = items;
            _accountId = accountId;
            _forteMerchantId = forteMerchantId;
        }

        void SqlMapper.IDynamicParameters.AddParameters(IDbCommand command, SqlMapper.Identity identity)
        {
            SqlParameter p;
            var sqlCommand = (SqlCommand)command;
            sqlCommand.CommandType = CommandType.StoredProcedure;

            p = sqlCommand.Parameters.Add("@accountId", SqlDbType.Int);
            p.Value = _accountId;

            p = sqlCommand.Parameters.Add("@forteMerchantId", SqlDbType.VarChar, 100);
            p.Value = _forteMerchantId;

            p = sqlCommand.Parameters.Add("@items", SqlDbType.Structured);
            p.Direction = ParameterDirection.Input;
            p.TypeName = "glAccountFortePersonTypeTableType";
            List<GLAccountFortePersonType> items = (List<GLAccountFortePersonType>)_items;
            if (items.Count > 0)
            {
                p.Value = mapDetail(_items);
            }
        }


        protected List<SqlDataRecord> mapDetail(IEnumerable<GLAccountFortePersonType> items)
        {           
            SqlMetaData[] tvp =
            {
                new SqlMetaData("accountFortePersonTypeId", SqlDbType.Int),
                new SqlMetaData("accountId", SqlDbType.Int),
                new SqlMetaData("personTypeId",SqlDbType.Int)
             };

            List<SqlDataRecord> list = new List<SqlDataRecord>();

            foreach (GLAccountFortePersonType item in items)
            {
                var record = new SqlDataRecord(tvp);
                record.SetInt32(0, item.accountFortePersonTypeId);
                record.SetInt32(1, item.accountId);
                record.SetInt32(2, item.personTypeId);
                list.Add(record);
            }

            return list;
        }

    }
}

```
## InvoiceBillingAgentStoreDynamicParameter.cs
```cs
using AT.AT2017.Api.Core.Models;
using Dapper;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using System.Data;
using System.Data.SqlClient;
using Microsoft.SqlServer.Server;

namespace AT.AT2017.Api.DynamicParameters
{
    public class InvoiceBillingAgentStoreDynamicParameter : SqlMapper.IDynamicParameters
    {

        private DateTime _orderDate;
        private IEnumerable<BillingAgentStore> _billingAgentStores;

        public InvoiceBillingAgentStoreDynamicParameter(DateTime orderDate, IEnumerable<BillingAgentStore> billingAgentStores)
        {
            _orderDate = orderDate;
            _billingAgentStores = billingAgentStores;

        }

        void SqlMapper.IDynamicParameters.AddParameters(IDbCommand command, SqlMapper.Identity identity)
        {
            SqlParameter p;
            var sqlCommand = (SqlCommand)command;
            sqlCommand.CommandType = CommandType.StoredProcedure;

            p = sqlCommand.Parameters.Add("@orderDate", SqlDbType.DateTime);
            p.Value = _orderDate;
            // detail
            p = sqlCommand.Parameters.Add("@billingAgentStores", SqlDbType.Structured);
            p.Direction = ParameterDirection.Input;
            p.TypeName = "billingAgentStoresTableType";
            List<BillingAgentStore> billingAgentStores = (List<BillingAgentStore>)_billingAgentStores;
            if (billingAgentStores.Count > 0)
            {
                p.Value = mapBillingAgentStore(billingAgentStores);
            }
            else
            {
                p.Value = null;
            }
        }

        protected List<SqlDataRecord> mapBillingAgentStore(IEnumerable<BillingAgentStore> detail)
        {
            SqlMetaData[] tvpBillingAgentStore =
            {
                new SqlMetaData("agentStoreItemId", SqlDbType.Int),
                new SqlMetaData("description", SqlDbType.NVarChar, 1000),
                new SqlMetaData("personID", SqlDbType.Int),
                new SqlMetaData("quantity", SqlDbType.Decimal,18,2),
                new SqlMetaData("additionalDescription", SqlDbType.NVarChar, 1000)
             };

            List<SqlDataRecord> BillingAgentStoreDetail = new List<SqlDataRecord>();

            foreach (BillingAgentStore itemDetail in detail)
            {
                var record = new SqlDataRecord(tvpBillingAgentStore);
                record.SetInt32(0, itemDetail.agentStoreItemId);
                if (itemDetail.description != null)
                    record.SetString(1, itemDetail.description);
                record.SetInt32(2, itemDetail.personID);
                record.SetDecimal(3, itemDetail.quantity);
                if (itemDetail.additionalDescription != null)
                    record.SetString(4, itemDetail.additionalDescription);
                //add record
                BillingAgentStoreDetail.Add(record);
            }

            return BillingAgentStoreDetail;
        }
    }
}

```
## InvoiceBillingDynamicParameter.cs
```cs
using AT.AT2017.Api.Core.Models;
using Dapper;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using System.Data;
using System.Data.SqlClient;
using Microsoft.SqlServer.Server;

namespace AT.AT2017.Api.DynamicParameters
{
    public class InvoiceBillingDynamicParameter : SqlMapper.IDynamicParameters
    {

        private int _companyId;
        private int _officeId;
        private int _personTypeId;
        private string _orderDate;
        private bool _includeBillingItems;
        private bool _includeReimbItems;
        private bool _posted;
        private IEnumerable<Person> _persons;

        public InvoiceBillingDynamicParameter(int companyId, int officeId, int personTypeId, string orderDate, bool includeBillingItems, bool includeReimbItems, bool posted, IEnumerable<Person> persons)
        {
            _companyId = companyId;
            _officeId = officeId;
            _personTypeId = personTypeId;
            _orderDate = orderDate;
            _includeBillingItems = includeBillingItems;
            _includeReimbItems = includeReimbItems;
            _posted = posted;
            _persons = persons;

        }

        void SqlMapper.IDynamicParameters.AddParameters(IDbCommand command, SqlMapper.Identity identity)
        {
            SqlParameter p;
            var sqlCommand = (SqlCommand)command;
            sqlCommand.CommandType = CommandType.StoredProcedure;

            p = sqlCommand.Parameters.Add("@processDate", SqlDbType.DateTime);
            p.Value = DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss.ms");
            p = sqlCommand.Parameters.Add("@companyId", SqlDbType.Int);
            p.Value = _companyId;
            p = sqlCommand.Parameters.Add("@officeId", SqlDbType.Int);
            p.Value = _officeId;
            p = sqlCommand.Parameters.Add("@personTypeId", SqlDbType.Int);
            p.Value = _personTypeId;
            p = sqlCommand.Parameters.Add("@orderDate", SqlDbType.VarChar, 20);
            p.Value = _orderDate;
            p = sqlCommand.Parameters.Add("@includeBillingItems", SqlDbType.Bit);
            p.Value = _includeBillingItems;
            p = sqlCommand.Parameters.Add("@includeReimbItems", SqlDbType.Bit);
            p.Value = _includeReimbItems;
            p = sqlCommand.Parameters.Add("@posted", SqlDbType.Bit);
            p.Value = _posted;
            // detail
            p = sqlCommand.Parameters.Add("@persons", SqlDbType.Structured);
            p.Direction = ParameterDirection.Input;
            p.TypeName = "invoiceBillingTableType";
            List<Person> persons = (List<Person>)_persons;
            if (persons.Count > 0)
            {
                p.Value = mapPerson(persons);
            }
            else
            {
                p.Value = null;
            }
        }

        protected List<SqlDataRecord> mapPerson(IEnumerable<Person> persons)
        {
            SqlMetaData[] tvpDetail =
            {
                new SqlMetaData("personId", SqlDbType.Int),
            };

            List<SqlDataRecord> detail = new List<SqlDataRecord>();

            foreach (Person item in persons)
            {
                var record = new SqlDataRecord(tvpDetail);
                record.SetInt32(0, item.personId);
                detail.Add(record);
            }


            return detail;
        }
    }
}

```
## InvoiceDynamicParameter.cs
```cs
using Dapper;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using System.Data;
using AT.AT2017.Api.Core.Models;
using System.Data.SqlClient;
using Microsoft.SqlServer.Server;

namespace AT.AT2017.Api.DynamicParameters
{
    public class InvoiceDynamicParameter : SqlMapper.IDynamicParameters
    {
        private readonly Invoice _invoice;

        public InvoiceDynamicParameter(Invoice invoice)
        {
            _invoice = invoice;
        }

        void SqlMapper.IDynamicParameters.AddParameters(IDbCommand command, SqlMapper.Identity identity)
        {
            SqlParameter p;
            var sqlCommand = (SqlCommand)command;
            sqlCommand.CommandType = CommandType.StoredProcedure;

            p = sqlCommand.Parameters.Add("@companyId", SqlDbType.Int);
            p.Value = _invoice.companyId;
            p = sqlCommand.Parameters.Add("@invoiceId", SqlDbType.Int);
            p.Value = _invoice.invoiceId;
            p = sqlCommand.Parameters.Add("@personId", SqlDbType.Int);
            p.Value = _invoice.personId;
            p = sqlCommand.Parameters.Add("@orderDate", SqlDbType.DateTime);
            p.Value = _invoice.orderDate;
            p = sqlCommand.Parameters.Add("@orderTypeId", SqlDbType.Int);
            p.Value = _invoice.orderTypeId;
            p = sqlCommand.Parameters.Add("@termId", SqlDbType.Int);
            p.Value = _invoice.termId;
            p = sqlCommand.Parameters.Add("@originalARPaymentId", SqlDbType.Int);
            p.Value = _invoice.originalARPaymentId;
            p = sqlCommand.Parameters.Add("@propertyId", SqlDbType.Int);
            p.Value = _invoice.propertyId;
            p = sqlCommand.Parameters.Add("@isTemplate", SqlDbType.Bit);
            p.Value = _invoice.isTemplate;
            p = sqlCommand.Parameters.Add("@templateName", SqlDbType.VarChar, 100);
            p.Value = _invoice.templateName;
            p = sqlCommand.Parameters.Add("@taxFlat", SqlDbType.Bit);
            p.Value = _invoice.taxFlat;
            // detail
            p = sqlCommand.Parameters.Add("@detail", SqlDbType.Structured);
            p.Direction = ParameterDirection.Input;
            p.TypeName = "invoiceDetailTableType";
            List<InvoiceDetail> detail = (List<InvoiceDetail>)_invoice.detail;
            if (detail.Count > 0)
            {
                p.Value = mapInvoiceDetail(_invoice.detail);
            }
            else
            {
                p.Value = null;
            }

        }

        protected List<SqlDataRecord> mapInvoiceDetail(IEnumerable<InvoiceDetail> detail)
        {
            SqlMetaData[] tvpInvoiceDetail =
            {
                new SqlMetaData("invoiceDetailId", SqlDbType.Int),
                new SqlMetaData("invoiceId", SqlDbType.Int),
                new SqlMetaData("description", SqlDbType.NVarChar, 1000),
                new SqlMetaData("reimbursementDetailId", SqlDbType.Int),
                new SqlMetaData("reimbursementType",SqlDbType.NVarChar, 50),
                new SqlMetaData("accountId", SqlDbType.Int),
                new SqlMetaData("jobId", SqlDbType.Int),
                new SqlMetaData("divisionId", SqlDbType.Int),
                new SqlMetaData("salesPrice", SqlDbType.Decimal,18,2),
                new SqlMetaData("columnNumber", SqlDbType.Int),
                new SqlMetaData("side", SqlDbType.NVarChar, 10),
                new SqlMetaData("deductType", SqlDbType.NVarChar, 50),
                new SqlMetaData("locked", SqlDbType.Bit),
                new SqlMetaData("referenceSource", SqlDbType.NVarChar, 100),
                new SqlMetaData("referenceID", SqlDbType.Int),
                new SqlMetaData("isTax", SqlDbType.Bit),
                new SqlMetaData("isTaxExempt", SqlDbType.Bit)
             };

            List<SqlDataRecord> invoiceDetail = new List<SqlDataRecord>();

            foreach (InvoiceDetail itemDetail in detail)
            {
                var record = new SqlDataRecord(tvpInvoiceDetail);
                record.SetInt32(0, itemDetail.invoiceDetailId);
                record.SetInt32(1, itemDetail.invoiceId);
                if (itemDetail.description != null)
                    record.SetString(2, itemDetail.description);
                if (itemDetail.reimbursementDetailId != null)
                    record.SetInt32(3, itemDetail.reimbursementDetailId.GetValueOrDefault());
                record.SetSqlString(4, itemDetail.reimbursementType);
                if (itemDetail.accountId != null)
                    record.SetInt32(5, itemDetail.accountId.GetValueOrDefault());
                if (itemDetail.jobId != null)
                    record.SetInt32(6, itemDetail.jobId.GetValueOrDefault());
                if (itemDetail.divisionId > 0)
                    record.SetInt32(7, itemDetail.divisionId.GetValueOrDefault());
                record.SetDecimal(8, itemDetail.salesPrice);
                record.SetInt32(9, itemDetail.columnNumber.GetValueOrDefault());
                if (itemDetail.side != null)
                    record.SetSqlString(10, itemDetail.side);
                if (itemDetail.deductType != null)
                    record.SetSqlString(11, itemDetail.deductType);
                if (itemDetail.locked != null)
                    record.SetSqlBoolean(12, itemDetail.locked.GetValueOrDefault());
                // reference
                if (!String.IsNullOrWhiteSpace(itemDetail.referenceSource))
                    record.SetString(13, itemDetail.referenceSource);
                if (itemDetail.referenceID != null)
                    record.SetInt32(14, itemDetail.referenceID.GetValueOrDefault());
                    record.SetSqlBoolean(15, itemDetail.isTax);
                    record.SetSqlBoolean(16, itemDetail.isTaxExempt);
                // add record
                invoiceDetail.Add(record);
            }

            return invoiceDetail;
        }

    }
}

```
## InvoicePayDynamicParameter.cs
```cs
using Dapper;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using System.Data;
using AT.AT2017.Api.Core.Models;
using System.Data.SqlClient;
using Microsoft.SqlServer.Server;

namespace AT.AT2017.Api.DynamicParameters
{
    public class InvoicePayDynamicParameter : SqlMapper.IDynamicParameters
    {
        private readonly IEnumerable<Invoice> _invoices;
        private int _isForte;

        public InvoicePayDynamicParameter(int isForte, IEnumerable<Invoice> invoices)
        {
            _isForte = isForte;
            _invoices = invoices;
        }

        void SqlMapper.IDynamicParameters.AddParameters(IDbCommand command, SqlMapper.Identity identity)
        {
            SqlParameter p;
            var sqlCommand = (SqlCommand)command;
            sqlCommand.CommandType = CommandType.StoredProcedure;

            p = sqlCommand.Parameters.Add("@isForte", SqlDbType.Int);
            p.Value = _isForte;
           
            // list
            p = sqlCommand.Parameters.Add("@invoices", SqlDbType.Structured);
            p.Direction = ParameterDirection.Input;
            p.TypeName = "invoiceToPayType";
            p.Value = mapInvoicesList(_invoices);
        }

        protected List<SqlDataRecord> mapInvoicesList(IEnumerable<Invoice> list)
        {
            SqlMetaData[] tvpInvoices =
            {
                new SqlMetaData("invoiceID", SqlDbType.Int),       
                new SqlMetaData("amountToPay", SqlDbType.Decimal,18,2)
             };

            List<SqlDataRecord> invoices = new List<SqlDataRecord>();

            foreach (Invoice item in list)
            {
                var record = new SqlDataRecord(tvpInvoices);
                record.SetInt32(0, item.invoiceId);
                record.SetDecimal(1, item.amountToPay);
                // add record
                invoices.Add(record);
            }

            return invoices;
        }

    }
}

```
## InvoicePostBatchDynamicParameter.cs
```cs
using AT.AT2017.Api.Core.Models;
using Dapper;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using System.Data;
using System.Data.SqlClient;
using Microsoft.SqlServer.Server;

namespace AT.AT2017.Api.DynamicParameters
{
    public class InvoicePostBatchDynamicParameter : SqlMapper.IDynamicParameters
    {

        private IEnumerable<Invoice> _invoicesToPost;

        public InvoicePostBatchDynamicParameter(IEnumerable<Invoice> invoicesToPost)
        {
            _invoicesToPost = invoicesToPost;
        }

        void SqlMapper.IDynamicParameters.AddParameters(IDbCommand command, SqlMapper.Identity identity)
        {
            SqlParameter p;
            var sqlCommand = (SqlCommand)command;
            sqlCommand.CommandType = CommandType.StoredProcedure;

            // detail
            p = sqlCommand.Parameters.Add("@invoices", SqlDbType.Structured);
            p.Direction = ParameterDirection.Input;
            p.TypeName = "invoiceTableType";
            List<Invoice> invoicesToPost = (List<Invoice>)_invoicesToPost;
            if (invoicesToPost.Count > 0)
            {
                p.Value = mapInvoice(invoicesToPost);
            }
            else
            {
                p.Value = null;
            }
        }

        protected List<SqlDataRecord> mapInvoice(IEnumerable<Invoice> invoicesToPost)
        {
            SqlMetaData[] tvpDetail =
            {
                new SqlMetaData("invoiceId", SqlDbType.Int),
                new SqlMetaData("personId", SqlDbType.Int),
                new SqlMetaData("personName",SqlDbType.NVarChar, 100),
                new SqlMetaData("orderDate", SqlDbType.DateTime),
                new SqlMetaData("posted", SqlDbType.Bit),
                new SqlMetaData("postedDate", SqlDbType.DateTime ),
                new SqlMetaData("orderTypeId", SqlDbType.Int),
                new SqlMetaData("orderType", SqlDbType.NVarChar,50),
                new SqlMetaData("termId", SqlDbType.Int),
                new SqlMetaData("originalARPaymentId", SqlDbType.Int),
                new SqlMetaData("propertyId", SqlDbType.Int),
                new SqlMetaData("propertyAddress", SqlDbType.NVarChar,100),
                new SqlMetaData("orderNumber", SqlDbType.NVarChar ,20),
                new SqlMetaData("locked", SqlDbType.Bit ),
                new SqlMetaData("dueDate", SqlDbType.Date ),
                new SqlMetaData("orderTotal", SqlDbType.Decimal,18,2),
                new SqlMetaData("amountPaid", SqlDbType.Decimal,18,2),
                new SqlMetaData("paid", SqlDbType.Bit ),
                new SqlMetaData("companyId", SqlDbType.Int),
                new SqlMetaData("companyName", SqlDbType.NVarChar ,100),
            };

            List<SqlDataRecord> detail = new List<SqlDataRecord>();

            foreach (Invoice itemInvoices in invoicesToPost)
            {
                var record = new SqlDataRecord(tvpDetail);
                record.SetInt32(0, itemInvoices.invoiceId);
                detail.Add(record);
            }


            return detail;
        }
    }
}

```
## JournalDynamicParameter.cs
```cs
using Dapper;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using System.Data;
using AT.AT2017.Api.Core.Models;
using System.Data.SqlClient;
using Microsoft.SqlServer.Server;

namespace AT.AT2017.Api.DynamicParameters
{
    public class JournalDynamicParameter : SqlMapper.IDynamicParameters
    {
        private readonly Journal _journal;

        public JournalDynamicParameter(Journal journal)
        {
            _journal = journal;
        }
        void SqlMapper.IDynamicParameters.AddParameters(IDbCommand command, SqlMapper.Identity identity)
        {
            SqlParameter p;
            var sqlCommand = (SqlCommand)command;
            sqlCommand.CommandType = CommandType.StoredProcedure;

            p = sqlCommand.Parameters.Add("@companyId", SqlDbType.Int);
            p.Value = _journal.companyId;
            p = sqlCommand.Parameters.Add("@journalId", SqlDbType.Int);
            p.Value = _journal.journalId;
            p = sqlCommand.Parameters.Add("@journalDate", SqlDbType.DateTime);
            p.Value = _journal.journalDate;
            p = sqlCommand.Parameters.Add("@reference", SqlDbType.VarChar, 200);
            p.Value = _journal.reference;
            p = sqlCommand.Parameters.Add("@isTemplate", SqlDbType.Bit);
            p.Value = _journal.isTemplate;
            p = sqlCommand.Parameters.Add("@templateName", SqlDbType.VarChar, 100);
            p.Value = _journal.templateName;
            p = sqlCommand.Parameters.Add("@flag1099", SqlDbType.Int);
            if (_journal.flag1099 > 0)
            {
                p.Value = _journal.flag1099;
            }
            // detail
            p = sqlCommand.Parameters.Add("@detail", SqlDbType.Structured);
            p.Direction = ParameterDirection.Input;
            p.TypeName = "journalDetailTableType";
            p.Value = mapJournalDetail(_journal.detail);
        }

        protected List<SqlDataRecord> mapJournalDetail(IEnumerable<JournalDetail> detail)
        {
            SqlMetaData[] tvpJournalDetail =
            {
                new SqlMetaData("journalDetailId", SqlDbType.Int),
                new SqlMetaData("journalId", SqlDbType.Int),
                new SqlMetaData("accountId", SqlDbType.Int),
                new SqlMetaData("debit", SqlDbType.Decimal , 18, 2),
                new SqlMetaData("credit", SqlDbType.Decimal, 18, 2),
                new SqlMetaData("jobId", SqlDbType.Int),
                new SqlMetaData("memoReference", SqlDbType.VarChar, 200),
                new SqlMetaData("divisionId", SqlDbType.Int),
                new SqlMetaData("bankRecId", SqlDbType.Int),
                new SqlMetaData("clearRef", SqlDbType.VarChar, 10),
                new SqlMetaData("printed", SqlDbType.Bit),
                new SqlMetaData("locked", SqlDbType.Bit),
                new SqlMetaData("reconciled", SqlDbType.Bit),
                new SqlMetaData("cleared", SqlDbType.Bit),
                new SqlMetaData("void", SqlDbType.Bit),
                new SqlMetaData("personId", SqlDbType.Int),
            };

            List<SqlDataRecord> records = new List<SqlDataRecord>();

            foreach (JournalDetail itemDetail in detail)
            {
                var record = new SqlDataRecord(tvpJournalDetail);

                record.SetInt32(0, itemDetail.journalDetailId);
                record.SetInt32(1, itemDetail.journalId);
                record.SetInt32(2, itemDetail.accountId.GetValueOrDefault());
                record.SetDecimal(3, itemDetail.debit);
                record.SetDecimal(4, itemDetail.credit);
                record.SetInt32(5, itemDetail.jobId.GetValueOrDefault());
                if (itemDetail.memoReference != null) { 
                    record.SetString(6, itemDetail.memoReference);
                }
                if (itemDetail.divisionId.GetValueOrDefault() > 0) {
                    record.SetInt32(7, itemDetail.divisionId.GetValueOrDefault());
                }
                if(itemDetail.bankRecId.GetValueOrDefault() > 0)
                {
                    record.SetInt32(8, itemDetail.bankRecId.GetValueOrDefault());
                }
                if (!string.IsNullOrEmpty(itemDetail.clearRef))
                {
                    record.SetString(9, itemDetail.clearRef);
                }
                record.SetSqlBoolean(10, itemDetail.printed.GetValueOrDefault());
                record.SetSqlBoolean(11, itemDetail.locked.GetValueOrDefault());
                record.SetSqlBoolean(12, itemDetail.reconciled.GetValueOrDefault());
                record.SetSqlBoolean(13, itemDetail.cleared.GetValueOrDefault());
                record.SetSqlBoolean(14, itemDetail.isVoid.GetValueOrDefault());
                if (itemDetail.personId.GetValueOrDefault() > 0)
                {
                    record.SetInt32(15, itemDetail.personId.GetValueOrDefault());
                }

                records.Add(record);

            }

            return records;
        }
    }
}

```
## PackageDynamicParameter.cs
```cs
using AT.AT2017.Api.Core.Models;
using Dapper;
using Microsoft.SqlServer.Server;
using System.Collections.Generic;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.DynamicParameters
{
    public class PackageDynamicParameter : SqlMapper.IDynamicParameters
    {
        private readonly Package _package;

        public PackageDynamicParameter(Package package)
        {
            _package = package;
        }
        void SqlMapper.IDynamicParameters.AddParameters(IDbCommand command, SqlMapper.Identity identity)
        {
            SqlParameter p;
            var sqlCommand = (SqlCommand)command;
            sqlCommand.CommandType = CommandType.StoredProcedure;

            p = sqlCommand.Parameters.Add("@packageID", SqlDbType.Int);
            p.Value = _package.packageID;

            p = sqlCommand.Parameters.Add("@name", SqlDbType.VarChar, 100);
            p.Value = _package.name;

            p = sqlCommand.Parameters.Add("@description", SqlDbType.VarChar, 500);
            p.Value = _package.description;

            // actions
            p = sqlCommand.Parameters.Add("@actions", SqlDbType.Structured);
            p.Direction = ParameterDirection.Input;
            p.TypeName = "packageActionTableType";
            List<PackageAction> actions = (List<PackageAction>)_package.actions;
            if (actions.Count > 0)
            {
                p.Value = mapPackageActions(_package.actions);
            }
            else
            {
                p.Value = null;
            }

            // reports
            p = sqlCommand.Parameters.Add("@reports", SqlDbType.Structured);
            p.Direction = ParameterDirection.Input;
            p.TypeName = "packageReportTableType";
            List<PackageReport> reports = (List<PackageReport>)_package.reports;
            if (reports.Count > 0)
            {
                p.Value = mapPackageReports(_package.reports);
            }
            else
            {
                p.Value = null;
            }

            // prices
            p = sqlCommand.Parameters.Add("@prices", SqlDbType.Structured);
            p.Direction = ParameterDirection.Input;
            p.TypeName = "packagePriceTableType";
            List<PackagePrice> prices = (List<PackagePrice>)_package.prices;
            if (prices.Count > 0)
            {
                p.Value = mapPackagePrices(_package.prices);
            } else
            {
                p.Value = null;
            }
        }

        protected List<SqlDataRecord> mapPackageActions(IEnumerable<PackageAction> actions)
        {
            SqlMetaData[] tvp =
            {
                new SqlMetaData("packageActionID", SqlDbType.Int),
                new SqlMetaData("packageID", SqlDbType.Int),
                new SqlMetaData("actionID", SqlDbType.Int),
                new SqlMetaData("customLabel", SqlDbType.VarChar, 500),
                new SqlMetaData("customOrder", SqlDbType.VarChar, 500),
                new SqlMetaData("permission", SqlDbType.VarChar, 20),
            };

            List<SqlDataRecord> list = new List<SqlDataRecord>();

            foreach (PackageAction item in actions)
            {
                var record = new SqlDataRecord(tvp);
                record.SetInt32(0, item.packageActionID);
                record.SetInt32(1, item.packageID);
                record.SetInt32(2, item.actionID);
                if (item.customLabel != null)
                {
                    record.SetString(3, item.customLabel);
                }
                if (item.customOrder != null)
                {
                    record.SetString(4, item.customOrder);
                }
                record.SetString(5, item.permission);

                list.Add(record);
            }

            return list;
        }

        protected List<SqlDataRecord> mapPackageReports(IEnumerable<PackageReport> reports)
        {
            SqlMetaData[] tvp =
            {
                new SqlMetaData("packageActionID", SqlDbType.Int),
                new SqlMetaData("packageID", SqlDbType.Int),
                new SqlMetaData("reportID", SqlDbType.Int),
            };

            List<SqlDataRecord> list = new List<SqlDataRecord>();

            foreach (PackageReport item in reports)
            {
                var record = new SqlDataRecord(tvp);
                record.SetInt32(0, item.packageReportID);
                record.SetInt32(1, item.packageID);
                record.SetInt32(2, item.reportID);

                list.Add(record);
            }

            return list;
        }

        protected List<SqlDataRecord> mapPackagePrices(IEnumerable<PackagePrice> prices)
        {
            SqlMetaData[] tvp =
            {
                new SqlMetaData("packagePriceID", SqlDbType.Int),
                new SqlMetaData("packageID", SqlDbType.Int),
                new SqlMetaData("from", SqlDbType.Int),
                new SqlMetaData("to", SqlDbType.Int),
                new SqlMetaData("price", SqlDbType.Decimal),
            };

            List<SqlDataRecord> list = new List<SqlDataRecord>();

            foreach (PackagePrice item in prices)
            {
                var record = new SqlDataRecord(tvp);
                record.SetInt32(0, item.packagePriceID);
                record.SetInt32(1, item.packageID);
                record.SetInt32(2, item.from);
                record.SetInt32(3, item.to);
                record.SetDecimal(4, item.price);

                list.Add(record);
            }

            return list;
        }

    }
}

```
## PersonBillingDetailDynamicParameter.cs
```cs
using AT.AT2017.Api.Core.Models;
using Dapper;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using System.Data;
using System.Data.SqlClient;
using Microsoft.SqlServer.Server;

namespace AT.AT2017.Api.DynamicParameters
{
    public class PersonBillingDetailDynamicParameter : SqlMapper.IDynamicParameters
    {

        private readonly int _personID;
        private readonly string _saveOption;
        private readonly List<PersonBillingDetail> _detail;

        public PersonBillingDetailDynamicParameter(int personID,string saveOption, List<PersonBillingDetail> detail)
        {
            _personID = personID;
            _detail = detail;
            _saveOption = saveOption;
        }

        void SqlMapper.IDynamicParameters.AddParameters(IDbCommand command, SqlMapper.Identity identity)
        {
            SqlParameter p;
            var sqlCommand = (SqlCommand)command;
            sqlCommand.CommandType = CommandType.StoredProcedure;

            // personID
            p = sqlCommand.Parameters.Add("@personID", SqlDbType.Int);
            p.Value = _personID;
            p = sqlCommand.Parameters.Add("@saveOption", SqlDbType.NVarChar, 100);
            p.Value = _saveOption;
            // detail
            p = sqlCommand.Parameters.Add("@personBillingDetail", SqlDbType.Structured);
            p.Direction = ParameterDirection.Input;
            p.TypeName = "personBillingDetailTableType";
            List<PersonBillingDetail> detail = (List<PersonBillingDetail>)_detail;
            if (detail.Count > 0)
            {
                p.Value = mapPersonBillingDetail(_detail);
            }
            else
            {
                p.Value = null;
            }
        }


        protected List<SqlDataRecord> mapPersonBillingDetail(IEnumerable<PersonBillingDetail> detail)
        {
            SqlMetaData[] tvp =
            {
                new SqlMetaData("personBillingDetailID", SqlDbType.Int),
                new SqlMetaData("personID", SqlDbType.Int),
                new SqlMetaData("billingItemID", SqlDbType.Int),
                new SqlMetaData("description", SqlDbType.NVarChar, 100),
                new SqlMetaData("accountID", SqlDbType.Int),
                new SqlMetaData("amount", SqlDbType.Decimal,18,2),
                new SqlMetaData("sortOrder", SqlDbType.Int),
                new SqlMetaData("include", SqlDbType.NVarChar, 100),
                new SqlMetaData("orderTypeID", SqlDbType.Int),
                new SqlMetaData("startDate", SqlDbType.DateTime),
                new SqlMetaData("endDate", SqlDbType.DateTime)
            };

            List<SqlDataRecord> list = new List<SqlDataRecord>();

            foreach (PersonBillingDetail itemDetail in detail)
            {
                var record = new SqlDataRecord(tvp);
                record.SetInt32(0, itemDetail.personBillingDetailId);
                record.SetInt32(1, itemDetail.personId);
                record.SetInt32(2, itemDetail.billingItemId.GetValueOrDefault());
                record.SetString(3, itemDetail.description);
                record.SetInt32(4, itemDetail.accountId.GetValueOrDefault());
                record.SetDecimal(5, itemDetail.amount);
                record.SetInt32(6, itemDetail.sortOrder.GetValueOrDefault());
                record.SetString(7, itemDetail.include);
                if (itemDetail.orderTypeId > 0)
                    record.SetInt32(8, itemDetail.orderTypeId);
                if (itemDetail.startDate != null)
                    record.SetDateTime(9, Convert.ToDateTime(itemDetail.startDate));
                if (itemDetail.endDate != null)
                    record.SetDateTime(10, Convert.ToDateTime(itemDetail.endDate));

                list.Add(record);

            }

            return list;
        }


    }
}

```
## PersonImportDynamicParameter.cs
```cs
using Dapper;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using System.Data;
using AT.AT2017.Api.Core.Models;
using System.Data.SqlClient;
using Microsoft.SqlServer.Server;

namespace AT.AT2017.Api.DynamicParameters
{
    public class PersonImportDynamicParameter : SqlMapper.IDynamicParameters
    {
        private readonly IEnumerable<PersonImport> _table;

        public PersonImportDynamicParameter(IEnumerable<PersonImport> table)
        {
            _table = table;
        }

        void SqlMapper.IDynamicParameters.AddParameters(IDbCommand command, SqlMapper.Identity identity)
        {
            SqlParameter p;
            var sqlCommand = (SqlCommand)command;
            sqlCommand.CommandType = CommandType.StoredProcedure;

            p = sqlCommand.Parameters.Add("@detail", SqlDbType.Structured);
            p.Direction = ParameterDirection.Input;
            p.TypeName = "personImportLogTableType";
            List<PersonImport> table = (List<PersonImport>)_table;
            if (table.Count > 0)
            {
                p.Value = mapTable(_table);
            }
        }


        protected List<SqlDataRecord> mapTable(IEnumerable<PersonImport> table)
        {
            SqlMetaData[] tvp =
            {
                new SqlMetaData("id", SqlDbType.Int),
                new SqlMetaData("office", SqlDbType.NVarChar, 100),
                new SqlMetaData("personID", SqlDbType.Int),
                new SqlMetaData("firstName", SqlDbType.NVarChar, 100),
                new SqlMetaData("lastName", SqlDbType.NVarChar, 100),
                new SqlMetaData("corporateName", SqlDbType.NVarChar, 100),
                new SqlMetaData("type", SqlDbType.NVarChar, 100),
                new SqlMetaData("gets1099", SqlDbType.NVarChar, 100),
                new SqlMetaData("1099Type", SqlDbType.NVarChar, 100),
                new SqlMetaData("taxID", SqlDbType.NVarChar, 100),
                new SqlMetaData("taxYear", SqlDbType.NVarChar, 100),
                new SqlMetaData("totalPaid",SqlDbType.NVarChar, 100),
                new SqlMetaData("emailAddress", SqlDbType.NVarChar, 100),
                new SqlMetaData("address", SqlDbType.NVarChar, 1000),
                new SqlMetaData("cityStateZip", SqlDbType.NVarChar, 500)
             };

            List<SqlDataRecord> list = new List<SqlDataRecord>();

            foreach (PersonImport item in table)
            {
                var record = new SqlDataRecord(tvp);
                record.SetInt32(0, item.id);
                record.SetString(1, item.office);
                if (item.personID != null)
                    record.SetInt32(2, item.personID);
                if (item.firstName != null) record.SetString(3, item.firstName);
                if (item.lastName != null) record.SetString(4, item.lastName);
                if (item.corporateName != null) record.SetString(5, item.corporateName);
                record.SetString(6, item.type);
                if (item.gets1099 != null) record.SetString(7, item.gets1099);
                if (item.type1099 != null) record.SetString(8, item.type1099);
                if (item.taxID != null) record.SetString(9, item.taxID);
                if (item.taxYear != null) record.SetString(10, item.taxYear);
                if (item.totalPaid != null) record.SetString(11, item.totalPaid);
                if (item.emailAddress != null) record.SetString(12, item.emailAddress);
                if (item.address != null) record.SetString(13, item.address);
                if (item.cityStateZip != null) record.SetString(14, item.cityStateZip);
                list.Add(record);
            }

            return list;
        }

    }
}

```
## PropertyDynamicParameter.cs
```cs
using Dapper;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using System.Data;
using AT.AT2017.Api.Core.Models;
using System.Data.SqlClient;
using Microsoft.SqlServer.Server;

namespace AT.AT2017.Api.DynamicParameters
{
    public class PropertyDynamicParameter : SqlMapper.IDynamicParameters
    {
        private readonly Property _property;            

        public PropertyDynamicParameter(Property property)
        {
            _property = property;         
          
        }
        void SqlMapper.IDynamicParameters.AddParameters(IDbCommand command, SqlMapper.Identity identity)
        {
            SqlParameter p;
            var sqlCommand = (SqlCommand)command;
            sqlCommand.CommandType = CommandType.StoredProcedure;

            p = sqlCommand.Parameters.Add("@propertyID", SqlDbType.Int);
            p.Value = _property.propertyId;        
            p = sqlCommand.Parameters.Add("@trans1", SqlDbType.Decimal);
            p.Value = _property.trans1;
            p = sqlCommand.Parameters.Add("@trans2", SqlDbType.Decimal);
            p.Value = _property.trans2;            
            p = sqlCommand.Parameters.Add("@offset", SqlDbType.Bit);
            p.Value = _property.offset;                 

            // agents
            if (_property.agents != null && _property.agents.Count()>0)
            {
                p = sqlCommand.Parameters.Add("@agents", SqlDbType.Structured);
                p.Direction = ParameterDirection.Input;
                p.TypeName = "propertyDeductionTableType";
                p.Value = mapAgentsDetail(_property.agents);
            }
            // referrals
            if (_property.referrals != null && _property.referrals.Count() > 0)
            {
                p = sqlCommand.Parameters.Add("@referrals", SqlDbType.Structured);
                p.Direction = ParameterDirection.Input;
                p.TypeName = "propertyPaymentOffTheTopTableType";
                p.Value = mapReferralsDetail(_property.referrals);
            }           
            // thirdPartyPayments
            if (_property.thirdPartyPayments != null && _property.thirdPartyPayments.Count() > 0)
            {
                p = sqlCommand.Parameters.Add("@thirdPayments", SqlDbType.Structured);
                p.Direction = ParameterDirection.Input;
                p.TypeName = "propertyThirdPartyPaymentTableType";
                p.Value = mapThridPaymentsDetail(_property.thirdPartyPayments);
            }
            // overrides
            if (_property.overrides != null && _property.overrides.Count() > 0)
            {
                p = sqlCommand.Parameters.Add("@overrides", SqlDbType.Structured);
                p.Direction = ParameterDirection.Input;
                p.TypeName = "propertyDeductionOverrideTableType";
                p.Value = mapOverridesDetail(_property.overrides);
            }
             // extraVouchers
            if (_property.extraVouchers != null && _property.extraVouchers.Count() > 0)
            {
                p = sqlCommand.Parameters.Add("@extravouchers", SqlDbType.Structured);
                p.Direction = ParameterDirection.Input;
                p.TypeName = "propertyExtraVoucherTableType";
                p.Value = mapExtraVouchersDetail(_property.extraVouchers);
            }
            // reimbursements
            if (_property.reimbursements != null && _property.reimbursements.Count() > 0)
            {
                p = sqlCommand.Parameters.Add("@reimbursements", SqlDbType.Structured);
                p.Direction = ParameterDirection.Input;
                p.TypeName = "propertyReimbursementTableType";
                p.Value = mapReimbursementsDetail(_property.reimbursements);
            }

        }


        protected List<SqlDataRecord> mapAgentsDetail(IEnumerable<PropertyDeduction> detail)
        {
            SqlMetaData[] tDetail =
            {
                new SqlMetaData("propertyDeductionID", SqlDbType.Int),
                new SqlMetaData("propertyID", SqlDbType.Int),
                new SqlMetaData("personID", SqlDbType.Int),
                new SqlMetaData("side", SqlDbType.VarChar,100),
                new SqlMetaData("columnNumber", SqlDbType.Int),
                new SqlMetaData("grossPercent", SqlDbType.Decimal,18,2),
                new SqlMetaData("grossCommission", SqlDbType.Decimal,18,2),
                new SqlMetaData("ignoreOffset", SqlDbType.Bit),
                new SqlMetaData("deposit", SqlDbType.Bit)
             };

            List<SqlDataRecord> records = new List<SqlDataRecord>();

            foreach (PropertyDeduction itemDetail in detail)
            {
                var record = new SqlDataRecord(tDetail);
                record.SetInt32(0, itemDetail.propertyDeductionId);
                record.SetInt32(1, itemDetail.propertyId);
                record.SetInt32(2, itemDetail.personId);
                record.SetString(3, itemDetail.side);
                record.SetInt32(4, itemDetail.columnNumber);
                record.SetDecimal(5, itemDetail.grossPercent);
                record.SetDecimal(6, itemDetail.grossCommission);
                record.SetSqlBoolean(7, itemDetail.ignoreOffset.GetValueOrDefault());
                record.SetSqlBoolean(8, itemDetail.deposit);
                records.Add(record);
            }

            return records;
        }

        protected List<SqlDataRecord> mapReferralsDetail(IEnumerable<PropertyPaymentOffTheTop> detail)
        {
            SqlMetaData[] tDetail =
             {
                new SqlMetaData("topID", SqlDbType.Int),
                new SqlMetaData("propertyID", SqlDbType.Int),
                new SqlMetaData("personID", SqlDbType.Int),
                new SqlMetaData("side", SqlDbType.Char,1),              
                new SqlMetaData("amount", SqlDbType.Decimal,18,2),
                new SqlMetaData("ignoreOffset", SqlDbType.Bit),
                new SqlMetaData("deposit", SqlDbType.Bit)
    };

            List<SqlDataRecord> records = new List<SqlDataRecord>();

            foreach (PropertyPaymentOffTheTop itemDetail in detail)
            {
                var record = new SqlDataRecord(tDetail);
                record.SetInt32(0, itemDetail.topId);
                record.SetInt32(1, itemDetail.propertyId.GetValueOrDefault());
                record.SetInt32(2, itemDetail.personId.GetValueOrDefault());
                record.SetString(3, itemDetail.side);             
                record.SetDecimal(4, itemDetail.amount.GetValueOrDefault() );
                record.SetSqlBoolean(5, itemDetail.ignoreOffset.GetValueOrDefault());
                record.SetSqlBoolean(6, itemDetail.deposit);
                records.Add(record);
            }

            return records;
        }   

        protected List<SqlDataRecord> mapThridPaymentsDetail(IEnumerable<PropertyThirdPartyPayment> detail)
        {
            SqlMetaData[] tDetail =
             {
                new SqlMetaData("thirdPartyPaymentID", SqlDbType.Int),
                new SqlMetaData("propertyDeductionID", SqlDbType.Int),
                new SqlMetaData("vendorPersonID", SqlDbType.Int),
                new SqlMetaData("amount", SqlDbType.Decimal,18,2),
                new SqlMetaData("ignoreOffset", SqlDbType.Bit),
                new SqlMetaData("deposit", SqlDbType.Bit)
    };

            List<SqlDataRecord> records = new List<SqlDataRecord>();

            foreach (PropertyThirdPartyPayment itemDetail in detail)
            {
                var record = new SqlDataRecord(tDetail);
                record.SetInt32(0, itemDetail.thirdPartyPaymentId);
                record.SetInt32(1, itemDetail.propertyDeductionId);
                record.SetInt32(2, itemDetail.vendorPersonId);             
                record.SetDecimal(3, itemDetail.amount.GetValueOrDefault());
                record.SetSqlBoolean(4, itemDetail.ignoreOffset.GetValueOrDefault());
                record.SetSqlBoolean(5, itemDetail.deposit);
                records.Add(record);
            }

            return records;
        }

        protected List<SqlDataRecord> mapReimbursementsDetail(IEnumerable<PropertyReimbursement> detail)
        {
            SqlMetaData[] tDetail =
            {
                new SqlMetaData("propertyReimbursementID", SqlDbType.Int),
                new SqlMetaData("propertyID", SqlDbType.Int),
                new SqlMetaData("personID", SqlDbType.Int),                  
                new SqlMetaData("amount", SqlDbType.Decimal,18,2),
                new SqlMetaData("deposit", SqlDbType.Bit),
                new SqlMetaData("flag1099", SqlDbType.Int),
                new SqlMetaData("taxExempt", SqlDbType.Bit)
             };

       List<SqlDataRecord> records = new List<SqlDataRecord>();

            foreach (PropertyReimbursement itemDetail in detail)
            {
                var record = new SqlDataRecord(tDetail);
                record.SetInt32(0, itemDetail.propertyReimbursementId);
                record.SetInt32(1, itemDetail.propertyId);
                record.SetInt32(2, itemDetail.personId);                          
                record.SetDecimal(3, itemDetail.amountBeforeTax);
                record.SetSqlBoolean(4, itemDetail.deposit);              
                record.SetInt32(5, itemDetail.flag1099.GetValueOrDefault());
                record.SetSqlBoolean(6, itemDetail.taxExempt);

                records.Add(record);
            }

            return records;
        }

        protected List<SqlDataRecord> mapExtraVouchersDetail(IEnumerable<PropertyExtraVoucher> detail)
        {
            SqlMetaData[] tDetail =
            {
                new SqlMetaData("propertyExtraVoucherID", SqlDbType.Int),
                new SqlMetaData("extraVoucherID", SqlDbType.Int),
                new SqlMetaData("propertyID", SqlDbType.Int),
                new SqlMetaData("personID", SqlDbType.Int),
                new SqlMetaData("officeID", SqlDbType.Int),
                new SqlMetaData("accountID", SqlDbType.Int),
                new SqlMetaData("amount", SqlDbType.Decimal,18,2),
                new SqlMetaData("deposit", SqlDbType.Bit),
                new SqlMetaData("unlocked", SqlDbType.Bit),
                new SqlMetaData("ignoreOffset", SqlDbType.Bit),
                new SqlMetaData("taxExempt", SqlDbType.Bit)
             };

            List<SqlDataRecord> records = new List<SqlDataRecord>();

            foreach (PropertyExtraVoucher itemDetail in detail)
            {
                var record = new SqlDataRecord(tDetail);
                record.SetInt32(0, itemDetail.propertyExtraVoucherId);
                record.SetInt32(1, itemDetail.extraVoucherId);
                record.SetInt32(2, itemDetail.propertyId);
                record.SetInt32(3, itemDetail.personId);
                if (itemDetail.officeId !=null )
                    record.SetInt32(4, itemDetail.officeId.GetValueOrDefault());
                record.SetInt32(5, itemDetail.accountId);
                record.SetDecimal(6, itemDetail.amountBeforeTax);
                record.SetSqlBoolean(7, itemDetail.deposit);
                record.SetSqlBoolean(8, itemDetail.unlocked);
                record.SetSqlBoolean(9, itemDetail.ignoreOffset);
                record.SetSqlBoolean(10, itemDetail.taxExempt);
                records.Add(record);
            }

            return records;
        }

        protected List<SqlDataRecord> mapOverridesDetail(IEnumerable<PropertyDeductionOverride> detail)
        {
            SqlMetaData[] tDetail =
            {
                new SqlMetaData("propertyOverrideID", SqlDbType.Int),
                new SqlMetaData("propertyDeductionID", SqlDbType.Int),
                new SqlMetaData("person3rdPartyID", SqlDbType.Int),               
                new SqlMetaData("percentage", SqlDbType.Decimal,18,2),
                new SqlMetaData("amount", SqlDbType.Decimal,18,2),
                new SqlMetaData("unlocked", SqlDbType.Bit),
                new SqlMetaData("basedOn", SqlDbType.VarChar,500),
                new SqlMetaData("personAgentID", SqlDbType.Int),               
                new SqlMetaData("deposit", SqlDbType.Bit)
             };

            List<SqlDataRecord> records = new List<SqlDataRecord>();

            foreach (PropertyDeductionOverride itemDetail in detail)
            {
                var record = new SqlDataRecord(tDetail);
                record.SetInt32(0, itemDetail.propertyOverrideId);
                record.SetInt32(1, itemDetail.propertyDeductionId);
                record.SetInt32(2, itemDetail.person3rdPartyId);               
                record.SetDecimal(3, itemDetail.percentage);
                record.SetDecimal(4, itemDetail.amountBeforeTax);
                record.SetSqlBoolean(5, itemDetail.unlocked);
                record.SetString(6, itemDetail.basedOn);
                record.SetInt32(7, itemDetail.personAgentId);              
                record.SetSqlBoolean(8, itemDetail.deposit);
                records.Add(record);
            }

            return records;
        }
    }
}

```
## PropertyPicturetParameter.cs
```cs
using Dapper;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using System.Data;
using AT.AT2017.Api.Core.Models;
using System.Data.SqlClient;
using Microsoft.SqlServer.Server;
using System.Data.SqlTypes;

namespace AT.AT2017.Api.DynamicParameters
{
    public class PropertyPicturetParameter : SqlMapper.IDynamicParameters
    {
        private IEnumerable<PropertyPicture> _table;

        public PropertyPicturetParameter(IEnumerable<PropertyPicture> table)
        {
            _table = table;            
        }

        void SqlMapper.IDynamicParameters.AddParameters(IDbCommand command, SqlMapper.Identity identity)
        {
            SqlParameter p;
            var sqlCommand = (SqlCommand)command;
            sqlCommand.CommandType = CommandType.StoredProcedure;
            
            p = sqlCommand.Parameters.Add("@records", SqlDbType.Structured);
            p.Direction = ParameterDirection.Input;
            p.TypeName = "propertyPictureTableType";
            p.Value = mapTable(_table);
        }


        protected List<SqlDataRecord> mapTable(IEnumerable<PropertyPicture> table)
        {
            SqlMetaData[] tvp =
            {
                new SqlMetaData("pictureId", SqlDbType.Int),
                new SqlMetaData("propertyID", SqlDbType.Int),
                new SqlMetaData("sequenceNumber", SqlDbType.Int),
                new SqlMetaData("url", SqlDbType.NVarChar, 500),
                new SqlMetaData("driveID", SqlDbType.NVarChar, 50),
                new SqlMetaData("fileName", SqlDbType.NVarChar, 1000),
                new SqlMetaData("caption", SqlDbType.NVarChar, 1000),
            };

            List<SqlDataRecord> records = new List<SqlDataRecord>();

            foreach (PropertyPicture item in table)
            {
                var record = new SqlDataRecord(tvp);
                record.SetInt32(0, item.pictureId);
                record.SetInt32(1, item.propertyId);
                record.SetInt32(2, item.sequenceNumber);
                record.SetString(3, item.url);
                record.SetString(4, item.driveID);
                record.SetString(5, item.fileName);
                record.SetString(6, item.caption);
                records.Add(record);
            }

            return records;
        }

    }
}

```
## PropertyPostDynamicParameter.cs
```cs
using Dapper;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using System.Data;
using AT.AT2017.Api.Core.Models;
using System.Data.SqlClient;
using Microsoft.SqlServer.Server;
using System.Data.SqlTypes;

namespace AT.AT2017.Api.DynamicParameters
{
    public class PropertyPostDynamicParameter : SqlMapper.IDynamicParameters
    {
        private readonly Property _property;       
        private string _postDateAccounting;
        private string _postDateArPayment;
        private string _postDateApPayment;
        private string _postDateDeposit;
        private bool _directDeposit;
        private string _checkNumber;
        private int _commissionAccountId;
        private bool _recordCommission;
        private bool _onePayment;
        private string _payment1;
        private string _payment2;
        private string _payment3;
        private bool _recordAsSingleDeposit;
        private int _depositAccountId;
        private bool _writeEscrowCheck;
        private string _escrowCheckNumber;
        private bool _payEscrowByForte;
        private string _deposits;
        private bool _excludeRules;

        public PropertyPostDynamicParameter(Property property,  string postDateAccounting, string postDateArPayment, string postDateApPayment, string postDateDeposit, bool directDeposit, string checkNumber, int commissionAccountId, bool recordCommission, bool onePayment, string payment1, string payment2, string payment3, bool recordAsSingleDeposit, int depositAccountId, bool writeEscrowCheck, string escrowCheckNumber, bool payEscrowByForte, string deposits, bool excludeRules)
        {
            _property = property;
          
            _postDateAccounting = postDateAccounting;
            _postDateArPayment = postDateArPayment;
            _postDateApPayment = postDateApPayment;
            _postDateDeposit = postDateDeposit;
            _directDeposit = directDeposit;
            _checkNumber = checkNumber;
            _commissionAccountId = commissionAccountId;
            _recordCommission = recordCommission;
            _onePayment = onePayment;
            _payment1 = payment1;
            _payment2 = payment2;
            _payment3 = payment3;
            _recordAsSingleDeposit = recordAsSingleDeposit;
            _depositAccountId = depositAccountId;
            _writeEscrowCheck = writeEscrowCheck;
            _escrowCheckNumber = escrowCheckNumber;
            _payEscrowByForte = payEscrowByForte;
            _deposits = deposits;
            _excludeRules = excludeRules;
        }
        void SqlMapper.IDynamicParameters.AddParameters(IDbCommand command, SqlMapper.Identity identity)
        {
            SqlParameter p;
            var sqlCommand = (SqlCommand)command;
            sqlCommand.CommandType = CommandType.StoredProcedure;

            p = sqlCommand.Parameters.Add("@propertyID", SqlDbType.Int);
            p.Value = _property.propertyId;           
            p = sqlCommand.Parameters.Add("@postDateAccounting", SqlDbType.VarChar, 100);
            p.Value = _postDateAccounting;
            p = sqlCommand.Parameters.Add("@postDateArPayment", SqlDbType.VarChar, 100);
            p.Value = _postDateArPayment;
            p = sqlCommand.Parameters.Add("@postDateApPayment", SqlDbType.VarChar, 100);
            p.Value = _postDateApPayment;
            p = sqlCommand.Parameters.Add("@postDateDeposit", SqlDbType.VarChar, 100);
            p.Value = _postDateDeposit;
            p = sqlCommand.Parameters.Add("@directDeposit", SqlDbType.Bit);
            p.Value = _directDeposit;
            p = sqlCommand.Parameters.Add("@checkNumber", SqlDbType.VarChar, 20);
            p.Value = _checkNumber;
            p = sqlCommand.Parameters.Add("@commissionAccountId", SqlDbType.Int);
            p.Value = _commissionAccountId;
            p = sqlCommand.Parameters.Add("@recordCommission", SqlDbType.Bit);
            p.Value = _recordCommission;
            p = sqlCommand.Parameters.Add("@onePayment", SqlDbType.Bit);
            p.Value = _onePayment;
            p = sqlCommand.Parameters.Add("@payment1", SqlDbType.VarChar, 800);
            p.Value = _payment1;
            p = sqlCommand.Parameters.Add("@payment2", SqlDbType.VarChar, 800);
            p.Value = _payment2;
            p = sqlCommand.Parameters.Add("@payment3", SqlDbType.VarChar, 800);
            p.Value = _payment3;
            p = sqlCommand.Parameters.Add("@recordAsSingleDeposit", SqlDbType.Bit);
            p.Value = _recordAsSingleDeposit;
            p = sqlCommand.Parameters.Add("@depositAccountId", SqlDbType.Int);
            p.Value = _depositAccountId;
            p = sqlCommand.Parameters.Add("@writeEscrowCheck", SqlDbType.Bit);
            p.Value = _writeEscrowCheck;
            p = sqlCommand.Parameters.Add("@escrowCheckNumber", SqlDbType.VarChar, 50);
            p.Value = _escrowCheckNumber;
            p = sqlCommand.Parameters.Add("@payEscrowByForte", SqlDbType.Bit);
            p.Value = _payEscrowByForte;
            p = sqlCommand.Parameters.Add("@deposits", SqlDbType.NVarChar, 2000);
            p.Value = _deposits;
            p = sqlCommand.Parameters.Add("@excludeRules", SqlDbType.Bit);
            p.Value = _excludeRules;

            // invoice
            if (_property.invoice != null && _property.invoice.Count() > 0)
            {
                p = sqlCommand.Parameters.Add("@invoice", SqlDbType.Structured);
                p.Direction = ParameterDirection.Input;
                p.TypeName = "invoiceTableType";
                p.Value = mapInvoice(_property.invoice);
            }
            if (_property.invoiceDetail != null && _property.invoiceDetail.Count() > 0)
            {
                p = sqlCommand.Parameters.Add("@invoiceDetail", SqlDbType.Structured);
                p.Direction = ParameterDirection.Input;
                p.TypeName = "invoiceDetailTableType";
                p.Value = mapInvoiceDetail(_property.invoiceDetail);
            }

            // agents
            if (_property.agentVouchers != null && _property.agentVouchers.Count() > 0)
            {
                p = sqlCommand.Parameters.Add("@agentVouchers", SqlDbType.Structured);
                p.Direction = ParameterDirection.Input;
                p.TypeName = "voucherTableType";
                p.Value = mapVoucher(_property.agentVouchers);
            }
            if (_property.agentVouchersDetail != null && _property.agentVouchersDetail.Count() > 0)
            {
                p = sqlCommand.Parameters.Add("@agentVoucherDetail", SqlDbType.Structured);
                p.Direction = ParameterDirection.Input;
                p.TypeName = "voucherDetailTableType";
                p.Value = mapVoucherDetail(_property.agentVouchersDetail);
            }

            // referrals
            if (_property.referralVouchers != null && _property.referralVouchers.Count() > 0)
            {
                p = sqlCommand.Parameters.Add("@referralVouchers", SqlDbType.Structured);
                p.Direction = ParameterDirection.Input;
                p.TypeName = "voucherTableType";
                p.Value = mapVoucher(_property.referralVouchers);
            }
            if (_property.referralVouchersDetail != null && _property.referralVouchersDetail.Count() > 0)
            {
                p = sqlCommand.Parameters.Add("@referralVoucherDetail", SqlDbType.Structured);
                p.Direction = ParameterDirection.Input;
                p.TypeName = "voucherDetailTableType";
                p.Value = mapVoucherDetail(_property.referralVouchersDetail);
            }

            // thirdPartyPayments
            if (_property.thirdPartyVouchers != null && _property.thirdPartyVouchers.Count() > 0)
            {
                p = sqlCommand.Parameters.Add("@thirdPartyVouchers", SqlDbType.Structured);
                p.Direction = ParameterDirection.Input;
                p.TypeName = "voucherTableType";
                p.Value = mapVoucher(_property.thirdPartyVouchers);
            }
            if (_property.thirdPartyVouchersDetail != null && _property.thirdPartyVouchersDetail.Count() > 0)
            {
                p = sqlCommand.Parameters.Add("@thirdPartyVoucherDetail", SqlDbType.Structured);
                p.Direction = ParameterDirection.Input;
                p.TypeName = "voucherDetailTableType";
                p.Value = mapVoucherDetail(_property.thirdPartyVouchersDetail);
            }

            // overrides
            if (_property.overrideVouchers != null && _property.overrideVouchers.Count() > 0)
            {
                p = sqlCommand.Parameters.Add("@overrideVouchers", SqlDbType.Structured);
                p.Direction = ParameterDirection.Input;
                p.TypeName = "voucherTableType";
                p.Value = mapVoucher(_property.overrideVouchers);
            }
            if (_property.overrideVouchersDetail != null && _property.overrideVouchersDetail.Count() > 0)
            {
                p = sqlCommand.Parameters.Add("@overrideVoucherDetail", SqlDbType.Structured);
                p.Direction = ParameterDirection.Input;
                p.TypeName = "voucherDetailTableType";
                p.Value = mapVoucherDetail(_property.overrideVouchersDetail);
            }

            // extraVouchers
            if (_property.extraVouchersMain != null && _property.extraVouchersMain.Count() > 0)
            {
                p = sqlCommand.Parameters.Add("@extraVouchers", SqlDbType.Structured);
                p.Direction = ParameterDirection.Input;
                p.TypeName = "voucherTableType";
                p.Value = mapVoucher(_property.extraVouchersMain);
            }
            if (_property.extraVouchersDetail != null && _property.extraVouchersDetail.Count() > 0)
            {
                p = sqlCommand.Parameters.Add("@extraVoucherDetail", SqlDbType.Structured);
                p.Direction = ParameterDirection.Input;
                p.TypeName = "voucherDetailTableType";
                p.Value = mapVoucherDetail(_property.extraVouchersDetail);
            }

            // reimbursements
            if (_property.reimbursementVouchers != null && _property.reimbursementVouchers.Count() > 0)
            {
                p = sqlCommand.Parameters.Add("@reimbVouchers", SqlDbType.Structured);
                p.Direction = ParameterDirection.Input;
                p.TypeName = "voucherTableType";
                p.Value = mapVoucher(_property.reimbursementVouchers);
            }
            if (_property.reimbursementVouchersDetail != null && _property.reimbursementVouchersDetail.Count() > 0)
            {
                p = sqlCommand.Parameters.Add("@reimbVoucherDetail", SqlDbType.Structured);
                p.Direction = ParameterDirection.Input;
                p.TypeName = "voucherDetailTableType";
                p.Value = mapVoucherDetail(_property.reimbursementVouchersDetail);
            }

            // billDeductInvoice
            if (_property.billDeductInvoice != null && _property.billDeductInvoice.Count() > 0)
            {
                p = sqlCommand.Parameters.Add("@billDeductInvoices", SqlDbType.Structured);
                p.Direction = ParameterDirection.Input;
                p.TypeName = "billDeductInvoiceTableType";
                p.Value = mapBillDeductInvoice(_property.billDeductInvoice);
            }
        }


        protected List<SqlDataRecord> mapInvoice(IEnumerable<Invoice> detail)
        {
            SqlMetaData[] tDetail =
            {
                new SqlMetaData("invoiceID", SqlDbType.Int),
                new SqlMetaData("personID", SqlDbType.Int),
                new SqlMetaData("personName", SqlDbType.VarChar,100),
                new SqlMetaData("orderDate", SqlDbType.DateTime),
                new SqlMetaData("posted", SqlDbType.Bit),
                new SqlMetaData("postedDate", SqlDbType.DateTime),
                new SqlMetaData("orderTypeID", SqlDbType.Int),
                new SqlMetaData("orderType", SqlDbType.VarChar,50),
                new SqlMetaData("termID", SqlDbType.Int),
                new SqlMetaData("originalARPaymentID", SqlDbType.Int),
                new SqlMetaData("propertyID", SqlDbType.Int),
                new SqlMetaData("propertyAddress", SqlDbType.VarChar,100),
                new SqlMetaData("orderNumber", SqlDbType.NVarChar,20),
                new SqlMetaData("locked", SqlDbType.Bit),
                new SqlMetaData("dueDate", SqlDbType.DateTime ),
                new SqlMetaData("orderTotal", SqlDbType.Decimal,18,2),
                new SqlMetaData("amountPaid", SqlDbType.Decimal,18,2),
                new SqlMetaData("paid", SqlDbType.Bit),
                new SqlMetaData("companyID", SqlDbType.Int),
                new SqlMetaData("companyName", SqlDbType.VarChar,100),
             };

            List<SqlDataRecord> records = new List<SqlDataRecord>();

            foreach (Invoice itemDetail in detail)
            {
                var record = new SqlDataRecord(tDetail);
                record.SetInt32(0, itemDetail.invoiceId);
                if (itemDetail.personId != null)
                {
                    record.SetInt32(1, itemDetail.personId.GetValueOrDefault());
                    record.SetString(2, itemDetail.personName);
                }
                if (itemDetail.orderDate != null && itemDetail.orderDate > DateTime.MinValue)
                    record.SetDateTime(3, itemDetail.orderDate.GetValueOrDefault());
                record.SetSqlBoolean(4, itemDetail.posted);
                if (itemDetail.postedDate != null && itemDetail.postedDate > DateTime.MinValue)
                    record.SetDateTime(5, itemDetail.postedDate.GetValueOrDefault());
                record.SetInt32(6, itemDetail.orderTypeId.GetValueOrDefault());
                record.SetString(7, itemDetail.orderType);
                if (itemDetail.termId != null)
                    record.SetInt32(8, itemDetail.termId.GetValueOrDefault());
                record.SetInt32(9, itemDetail.originalARPaymentId.GetValueOrDefault());
                if (itemDetail.propertyId != null)
                    record.SetInt32(10, itemDetail.propertyId.GetValueOrDefault());
                record.SetString(11, itemDetail.propertyAddress);
                if (itemDetail.orderNumber != null)
                    record.SetString(12, itemDetail.orderNumber);
                record.SetSqlBoolean(13, itemDetail.locked);
                if (itemDetail.dueDate != null && itemDetail.dueDate > DateTime.MinValue)
                    record.SetDateTime(14, itemDetail.dueDate.GetValueOrDefault());
                record.SetDecimal(15, itemDetail.orderTotal);
                record.SetDecimal(16, itemDetail.amountPaid);
                record.SetSqlBoolean(17, itemDetail.paid);
                record.SetInt32(18, itemDetail.companyId);
                record.SetString(19, itemDetail.companyName);
                records.Add(record);
            }

            return records;
        }

        protected List<SqlDataRecord> mapInvoiceDetail(IEnumerable<InvoiceDetail> detail)
        {
            SqlMetaData[] tDetail =
            {
                new SqlMetaData("invoiceDetailId", SqlDbType.Int),
                new SqlMetaData("invoiceId", SqlDbType.Int),
                new SqlMetaData("description", SqlDbType.VarChar,1000),
                new SqlMetaData("reimbursementDetailId", SqlDbType.Int),
                 new SqlMetaData("reimbursementType", SqlDbType.Int),
                new SqlMetaData("accountID", SqlDbType.Int),
                new SqlMetaData("jobID", SqlDbType.Int),
                new SqlMetaData("divisionID", SqlDbType.Int),
                new SqlMetaData("salesPrice", SqlDbType.Decimal,18,2),
                new SqlMetaData("columnNumber", SqlDbType.Int),
                new SqlMetaData("side", SqlDbType.VarChar,10),
                new SqlMetaData("deductType", SqlDbType.VarChar,50),
                new SqlMetaData("locked", SqlDbType.Bit),
                new SqlMetaData("referenceSource", SqlDbType.NVarChar, 100),
                new SqlMetaData("referenceID", SqlDbType.Int),
                new SqlMetaData("isTax", SqlDbType.Bit),
                new SqlMetaData("isTaxExempt", SqlDbType.Bit)
             };

            List<SqlDataRecord> records = new List<SqlDataRecord>();

            foreach (InvoiceDetail itemDetail in detail)
            {
                var record = new SqlDataRecord(tDetail);
                record.SetInt32(0, itemDetail.invoiceDetailId);
                record.SetInt32(1, itemDetail.invoiceId);
                if (itemDetail.description != null)
                    record.SetString(2, itemDetail.description);
                if (itemDetail.reimbursementDetailId != null)
                    record.SetInt32(3, itemDetail.reimbursementDetailId.GetValueOrDefault());
                if (itemDetail.reimbursementType != null)
                    record.SetString(4, itemDetail.reimbursementType);
                if (itemDetail.accountId != null)
                    record.SetInt32(5, itemDetail.accountId.GetValueOrDefault());
                if (itemDetail.jobId != null)
                    record.SetInt32(6, itemDetail.jobId.GetValueOrDefault());
                if (itemDetail.divisionId != null)
                    record.SetInt32(7, itemDetail.divisionId.GetValueOrDefault());
                record.SetDecimal(8, itemDetail.salesPrice);
                record.SetInt32(9, itemDetail.columnNumber.GetValueOrDefault());
                if (itemDetail.side != null)
                    record.SetString(10, itemDetail.side);
                record.SetString(11, itemDetail.deductType);
                record.SetSqlBoolean(12, itemDetail.locked.GetValueOrDefault());
                // reference
                if (!String.IsNullOrWhiteSpace(itemDetail.referenceSource))
                    record.SetString(13, itemDetail.referenceSource);
                if (itemDetail.referenceID != null)
                    record.SetInt32(14, itemDetail.referenceID.GetValueOrDefault());
                record.SetSqlBoolean(15, itemDetail.isTax);
                record.SetSqlBoolean(16, itemDetail.isTaxExempt);
                // add record            
                records.Add(record);
            }

            return records;
        }

        protected List<SqlDataRecord> mapVoucher(IEnumerable<Voucher> detail)
        {
            SqlMetaData[] tDetail =
            {
                new SqlMetaData("voucherID", SqlDbType.Int),
                new SqlMetaData("personID", SqlDbType.Int),
                new SqlMetaData("orderDate", SqlDbType.DateTime),
                new SqlMetaData("posted", SqlDbType.Bit),
                new SqlMetaData("postedDate", SqlDbType.DateTime),
                new SqlMetaData("orderTypeID", SqlDbType.Int),
                new SqlMetaData("termID", SqlDbType.Int),
                new SqlMetaData("originalAPPaymentID", SqlDbType.Int),
                new SqlMetaData("propertyID", SqlDbType.Int),
                new SqlMetaData("alt1099PersonID", SqlDbType.Int),
                new SqlMetaData("poNumber", SqlDbType.VarChar,50),
                new SqlMetaData("strOrderNumber", SqlDbType.NVarChar,20),
                new SqlMetaData("locked", SqlDbType.Bit),
                new SqlMetaData("dueDate", SqlDbType.DateTime ),
                new SqlMetaData("paid", SqlDbType.Bit),
                new SqlMetaData("orderTotal", SqlDbType.Decimal,18,2),
                new SqlMetaData("amountPaid", SqlDbType.Decimal,18,2),
                new SqlMetaData("sourcePost", SqlDbType.VarChar,50),
                new SqlMetaData("personOverrideID", SqlDbType.Int),
                new SqlMetaData("companyID", SqlDbType.Int),
                new SqlMetaData("flag1099", SqlDbType.Int)
             };

            List<SqlDataRecord> records = new List<SqlDataRecord>();

            foreach (Voucher itemDetail in detail)
            {
                var record = new SqlDataRecord(tDetail);
                record.SetInt32(0, itemDetail.voucherId);
                record.SetInt32(1, itemDetail.personId);
                if (itemDetail.orderDate != null && itemDetail.orderDate > DateTime.MinValue)
                    record.SetDateTime(2, itemDetail.orderDate);
                record.SetSqlBoolean(3, itemDetail.posted);
                if (itemDetail.postedDate != null && itemDetail.postedDate > DateTime.MinValue)
                    record.SetDateTime(4, itemDetail.postedDate.GetValueOrDefault());
                record.SetInt32(5, itemDetail.orderTypeId);
                if (itemDetail.termId != null)
                    record.SetInt32(6, itemDetail.termId.GetValueOrDefault());
                if (itemDetail.originalAPPaymentId != null)
                    record.SetInt32(7, itemDetail.originalAPPaymentId.GetValueOrDefault());
                record.SetInt32(8, itemDetail.propertyId.GetValueOrDefault());
                record.SetInt32(9, itemDetail.alt1099PersonId.GetValueOrDefault());
                if (itemDetail.poNumber != null)
                    record.SetString(10, itemDetail.poNumber);
                if (itemDetail.strOrderNumber != null)
                    record.SetString(11, itemDetail.strOrderNumber);
                record.SetSqlBoolean(12, itemDetail.locked);
                if (itemDetail.dueDate != null && itemDetail.dueDate > DateTime.MinValue)
                    record.SetDateTime(13, itemDetail.dueDate.GetValueOrDefault());
                record.SetSqlBoolean(14, itemDetail.paid);
                record.SetDecimal(15, itemDetail.orderTotal);
                record.SetDecimal(16, itemDetail.amountPaid);
                record.SetString(17, itemDetail.sourcePost);
                if (itemDetail.personOverrideID != null)
                    record.SetInt32(18, itemDetail.personOverrideID.GetValueOrDefault());
                record.SetInt32(19, itemDetail.companyId);
                if (itemDetail.flag1099 > 0)
                    record.SetInt32(20, itemDetail.flag1099);
                records.Add(record);
            }

            return records;
        }

        protected List<SqlDataRecord> mapVoucherDetail(IEnumerable<VoucherDetail> detail)
        {
            SqlMetaData[] tDetail =
            {
                new SqlMetaData("voucherDetailID", SqlDbType.Int),
                new SqlMetaData("voucherID", SqlDbType.Int),
                new SqlMetaData("salesPrice", SqlDbType.Decimal,18,2),
                new SqlMetaData("description", SqlDbType.VarChar,1000),
                new SqlMetaData("accountID", SqlDbType.Int),
                new SqlMetaData("jobID", SqlDbType.Int),
                new SqlMetaData("divisionID", SqlDbType.Int),
                new SqlMetaData("locked", SqlDbType.Bit),
                new SqlMetaData("deductType", SqlDbType.VarChar,50),
                new SqlMetaData("side", SqlDbType.VarChar,10),
                new SqlMetaData("columnNumber", SqlDbType.Int),
                new SqlMetaData("propertyID", SqlDbType.Int),
                new SqlMetaData("otherCompanyJobID", SqlDbType.Int),
                new SqlMetaData("isTax", SqlDbType.Bit),
                new SqlMetaData("isTaxExempt", SqlDbType.Bit)
             };

            List<SqlDataRecord> records = new List<SqlDataRecord>();

            foreach (VoucherDetail itemDetail in detail)
            {
                var record = new SqlDataRecord(tDetail);
                record.SetInt32(0, itemDetail.voucherDetailId);
                record.SetInt32(1, itemDetail.voucherId);
                record.SetDecimal(2, itemDetail.salesPrice);
                record.SetString(3, itemDetail.description);
                if (itemDetail.accountId != null)
                    record.SetInt32(4, itemDetail.accountId.GetValueOrDefault());
                record.SetInt32(5, itemDetail.jobId.GetValueOrDefault());
                if (itemDetail.divisionId != null)
                    record.SetInt32(6, itemDetail.divisionId.GetValueOrDefault());
                record.SetSqlBoolean(7, itemDetail.locked.GetValueOrDefault());
                record.SetString(8, itemDetail.deductType);
                if (itemDetail.side != null)
                    record.SetString(9, itemDetail.side);
                record.SetInt32(10, itemDetail.columnNumber.GetValueOrDefault());
                record.SetInt32(11, itemDetail.propertyId.GetValueOrDefault());
                record.SetInt32(12, itemDetail.columnNumber.GetValueOrDefault());
                record.SetSqlBoolean(13, itemDetail.isTax);
                record.SetSqlBoolean(14, itemDetail.isTaxExempt);
                records.Add(record);
            }

            return records;
        }

        protected List<SqlDataRecord> mapBillDeductInvoice(IEnumerable<Invoice> detail)
        {
            SqlMetaData[] tDetail =
            {
                new SqlMetaData("invoiceID", SqlDbType.Int),
                new SqlMetaData("personID", SqlDbType.Int),
                new SqlMetaData("propertyID", SqlDbType.Int),
                new SqlMetaData("orderTotal", SqlDbType.Decimal,18,2),
                new SqlMetaData("amountToPay", SqlDbType.Decimal,18,2),
                new SqlMetaData("billDeductAmount", SqlDbType.Decimal,18,2),
                new SqlMetaData("orderTypeID", SqlDbType.Int)
             };

            List<SqlDataRecord> records = new List<SqlDataRecord>();

            foreach (Invoice itemDetail in detail)
            {
                var record = new SqlDataRecord(tDetail);
                record.SetInt32(0, itemDetail.invoiceId);
                if (itemDetail.personId != null)
                {
                    record.SetInt32(1, itemDetail.personId.GetValueOrDefault());
                }
                if (itemDetail.propertyId != null)
                    record.SetInt32(2, itemDetail.propertyId.GetValueOrDefault());
                record.SetDecimal(3, itemDetail.orderTotal);
                record.SetDecimal(4, itemDetail.amountToPay);
                record.SetDecimal(5, itemDetail.billDeductAmount);
                record.SetInt32(6, itemDetail.orderTypeId.GetValueOrDefault());
                records.Add(record);
            }

            return records;
        }

    }
}

```
## PropertyPostRegionalDynamicParameter.cs
```cs
using Dapper;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Data;
using AT.AT2017.Api.Core.Models;
using System.Data.SqlClient;
using Microsoft.SqlServer.Server;

namespace AT.AT2017.Api.DynamicParameters
{
    public class PropertyPostRegionalDynamicParameter : SqlMapper.IDynamicParameters
    {
        private readonly Property _property;
        private string _postDateAccounting;

        public PropertyPostRegionalDynamicParameter(Property property, string postDateAccounting)
        {
            _property = property;
            _postDateAccounting = postDateAccounting;

        }
        void SqlMapper.IDynamicParameters.AddParameters(IDbCommand command, SqlMapper.Identity identity)
        {
            SqlParameter p;
            var sqlCommand = (SqlCommand)command;
            sqlCommand.CommandType = CommandType.StoredProcedure;

            p = sqlCommand.Parameters.Add("@propertyID", SqlDbType.Int);
            p.Value = _property.propertyId;
            p = sqlCommand.Parameters.Add("@postDateAccounting", SqlDbType.VarChar, 100);
            p.Value = _postDateAccounting;

            // invoice
            if (_property.invoice != null && _property.invoice.Count() > 0)
            {
                p = sqlCommand.Parameters.Add("@invoice", SqlDbType.Structured);
                p.Direction = ParameterDirection.Input;
                p.TypeName = "invoiceTableType";
                p.Value = mapInvoice(_property.invoice);
            }
            if (_property.invoiceDetail != null && _property.invoiceDetail.Count() > 0)
            {
                p = sqlCommand.Parameters.Add("@invoiceDetail", SqlDbType.Structured);
                p.Direction = ParameterDirection.Input;
                p.TypeName = "invoiceDetailTableType";
                p.Value = mapInvoiceDetail(_property.invoiceDetail);
            }

        }


        protected List<SqlDataRecord> mapInvoice(IEnumerable<Invoice> detail)
        {
            SqlMetaData[] tDetail =
            {
                new SqlMetaData("invoiceID", SqlDbType.Int),
                new SqlMetaData("personID", SqlDbType.Int),
                new SqlMetaData("personName", SqlDbType.VarChar,100),
                new SqlMetaData("orderDate", SqlDbType.DateTime),
                new SqlMetaData("posted", SqlDbType.Bit),
                new SqlMetaData("postedDate", SqlDbType.DateTime),
                new SqlMetaData("orderTypeID", SqlDbType.Int),
                new SqlMetaData("orderType", SqlDbType.VarChar,50),
                new SqlMetaData("termID", SqlDbType.Int),
                new SqlMetaData("originalARPaymentID", SqlDbType.Int),
                new SqlMetaData("propertyID", SqlDbType.Int),
                new SqlMetaData("propertyAddress", SqlDbType.VarChar,100),
                new SqlMetaData("orderNumber", SqlDbType.NVarChar,20),
                new SqlMetaData("locked", SqlDbType.Bit),
                new SqlMetaData("dueDate", SqlDbType.DateTime ),
                new SqlMetaData("orderTotal", SqlDbType.Decimal,18,2),
                new SqlMetaData("amountPaid", SqlDbType.Decimal,18,2),
                new SqlMetaData("paid", SqlDbType.Bit),
                new SqlMetaData("companyID", SqlDbType.Int),
                new SqlMetaData("companyName", SqlDbType.VarChar,100)
             };

            List<SqlDataRecord> records = new List<SqlDataRecord>();

            foreach (Invoice itemDetail in detail)
            {
                var record = new SqlDataRecord(tDetail);
                record.SetInt32(0, itemDetail.invoiceId);
                if (itemDetail.personId != null)
                {
                    record.SetInt32(1, itemDetail.personId.GetValueOrDefault());
                    record.SetString(2, itemDetail.personName);
                }
                if (itemDetail.orderDate != null && itemDetail.orderDate > DateTime.MinValue)
                    record.SetDateTime(3, itemDetail.orderDate.GetValueOrDefault());
                record.SetSqlBoolean(4, itemDetail.posted);
                if (itemDetail.postedDate != null && itemDetail.postedDate > DateTime.MinValue)
                    record.SetDateTime(5, itemDetail.postedDate.GetValueOrDefault());
                record.SetInt32(6, itemDetail.orderTypeId.GetValueOrDefault());
                record.SetString(7, itemDetail.orderType);
                if (itemDetail.termId != null)
                    record.SetInt32(8, itemDetail.termId.GetValueOrDefault());
                record.SetInt32(9, itemDetail.originalARPaymentId.GetValueOrDefault());
                if (itemDetail.propertyId != null)
                    record.SetInt32(10, itemDetail.propertyId.GetValueOrDefault());
                record.SetString(11, itemDetail.propertyAddress);
                if (itemDetail.orderNumber != null)
                    record.SetString(12, itemDetail.orderNumber);
                record.SetSqlBoolean(13, itemDetail.locked);
                if (itemDetail.dueDate != null && itemDetail.dueDate > DateTime.MinValue)
                    record.SetDateTime(14, itemDetail.dueDate.GetValueOrDefault());
                record.SetDecimal(15, itemDetail.orderTotal);
                record.SetDecimal(16, itemDetail.amountPaid);
                record.SetSqlBoolean(17, itemDetail.paid);
                record.SetInt32(18, itemDetail.companyId);
                record.SetString(19, itemDetail.companyName);
                records.Add(record);
            }

            return records;
        }

        protected List<SqlDataRecord> mapInvoiceDetail(IEnumerable<InvoiceDetail> detail)
        {
            SqlMetaData[] tDetail =
            {
                new SqlMetaData("invoiceDetailId", SqlDbType.Int),
                new SqlMetaData("invoiceId", SqlDbType.Int),
                new SqlMetaData("description", SqlDbType.VarChar,1000),
                new SqlMetaData("reimbursementDetailId", SqlDbType.Int),
                 new SqlMetaData("reimbursementType", SqlDbType.Int),
                new SqlMetaData("accountID", SqlDbType.Int),
                new SqlMetaData("jobID", SqlDbType.Int),
                new SqlMetaData("divisionID", SqlDbType.Int),
                new SqlMetaData("salesPrice", SqlDbType.Decimal,18,2),
                new SqlMetaData("columnNumber", SqlDbType.Int),
                new SqlMetaData("side", SqlDbType.VarChar,10),
                new SqlMetaData("deductType", SqlDbType.VarChar,50),
                new SqlMetaData("locked", SqlDbType.Bit),
                new SqlMetaData("referenceSource", SqlDbType.NVarChar, 100),
                new SqlMetaData("referenceID", SqlDbType.Int),
                new SqlMetaData("isTax", SqlDbType.Bit),
                new SqlMetaData("isTaxExempt", SqlDbType.Bit)
             };

            List<SqlDataRecord> records = new List<SqlDataRecord>();

            foreach (InvoiceDetail itemDetail in detail)
            {
                var record = new SqlDataRecord(tDetail);
                record.SetInt32(0, itemDetail.invoiceDetailId);
                record.SetInt32(1, itemDetail.invoiceId);
                if (itemDetail.description != null)
                    record.SetString(2, itemDetail.description);
                if (itemDetail.reimbursementDetailId != null)
                    record.SetInt32(3, itemDetail.reimbursementDetailId.GetValueOrDefault());
                if (itemDetail.reimbursementType != null)
                    record.SetString(4, itemDetail.reimbursementType);
                if (itemDetail.accountId != null)
                    record.SetInt32(5, itemDetail.accountId.GetValueOrDefault());
                if (itemDetail.jobId != null)
                    record.SetInt32(6, itemDetail.jobId.GetValueOrDefault());
                if (itemDetail.divisionId != null)
                    record.SetInt32(7, itemDetail.divisionId.GetValueOrDefault());
                record.SetDecimal(8, itemDetail.salesPrice);
                record.SetInt32(9, itemDetail.columnNumber.GetValueOrDefault());
                if (itemDetail.side != null)
                    record.SetString(10, itemDetail.side);
                record.SetString(11, itemDetail.deductType);
                record.SetSqlBoolean(12, itemDetail.locked.GetValueOrDefault());
                // reference
                if (!String.IsNullOrWhiteSpace(itemDetail.referenceSource))
                    record.SetString(13, itemDetail.referenceSource);
                if (itemDetail.referenceID != null)
                    record.SetInt32(14, itemDetail.referenceID.GetValueOrDefault());
                record.SetSqlBoolean(15, itemDetail.isTax);
                record.SetSqlBoolean(16, itemDetail.isTaxExempt);
                // add record            
                records.Add(record);
            }

            return records;
        }

    }
}

```
## ReconciliationFireDynamicParameter.cs
```cs
using Dapper;
using AT.AT2017.Api.Core.Models;
using System.Data;
using System.Data.SqlClient;
using System.Collections.Generic;
using Microsoft.SqlServer.Server;

namespace AT.AT2017.Api.DynamicParameters
{
    public class ReconciliationFireDynamicParameter : SqlMapper.IDynamicParameters
    {
        ReconciliationFire _item;

        public ReconciliationFireDynamicParameter(ReconciliationFire item)
        {
            _item = item;
        }

        void SqlMapper.IDynamicParameters.AddParameters(IDbCommand command, SqlMapper.Identity identity)
        {

            SqlParameter p;
            var sqlCommand = (SqlCommand)command;
            sqlCommand.CommandType = CommandType.StoredProcedure;

            p = sqlCommand.Parameters.Add("@reconciliationFireId", SqlDbType.Int);
            p.Value = _item.reconciliationFireId;
            p = sqlCommand.Parameters.Add("@formatType", SqlDbType.VarChar, 100);
            p.Value = _item.formatType;
            p = sqlCommand.Parameters.Add("@description", SqlDbType.VarChar, 1000);
            p.Value = _item.description;
            p = sqlCommand.Parameters.Add("@isForRental", SqlDbType.Bit);
            p.Value = _item.isForRental;
            p = sqlCommand.Parameters.Add("@contactName", SqlDbType.VarChar, 100);
            p.Value = _item.contactName;
            p = sqlCommand.Parameters.Add("@contactEmail", SqlDbType.VarChar, 100);
            p.Value = _item.contactEmail;
            p = sqlCommand.Parameters.Add("@contactPhone", SqlDbType.VarChar, 100);
            p.Value = _item.contactPhone;
            p = sqlCommand.Parameters.Add("@doNotUpload", SqlDbType.Bit);
            p.Value = _item.doNotUpload;

            // detail
            p = sqlCommand.Parameters.Add("@detail", SqlDbType.Structured);
            p.Direction = ParameterDirection.Input;
            p.TypeName = "reconciliationFireDetailTableType";
            List<ReconciliationFireDetail> detail = (List<ReconciliationFireDetail>)_item.detail;
            if (detail.Count > 0)
            {
                p.Value = mapReconciliationFireDetail(_item.detail);
            }
            else
            {
                p.Value = null;
            }
        }

        protected List<SqlDataRecord> mapReconciliationFireDetail(IEnumerable<ReconciliationFireDetail> detail)
        {
            SqlMetaData[] tvpItemDetail =
            {
                new SqlMetaData("reconciliationFireDetailID", SqlDbType.Int),
                new SqlMetaData("reconciliationFireID", SqlDbType.Int),
                new SqlMetaData("payeeID", SqlDbType.Int),
                new SqlMetaData("payeeName", SqlDbType.NVarChar, 305),
                new SqlMetaData("useCorporateTaxId", SqlDbType.Bit),
                new SqlMetaData("amount", SqlDbType.Decimal,18,2),
                new SqlMetaData("select", SqlDbType.Bit)
             };
            
            List<SqlDataRecord> recordDetail = new List<SqlDataRecord>();

            foreach (ReconciliationFireDetail itemDetail in detail)
            {
                var record = new SqlDataRecord(tvpItemDetail);

                record.SetInt32(0, itemDetail.reconciliationFireDetailId);

                record.SetInt32(1, itemDetail.reconciliationFireId);

                record.SetInt32(2, itemDetail.payeeId);

                record.SetString(3, itemDetail.payeeName);
                
                record.SetBoolean(4, itemDetail.useCorporateTaxId);

                record.SetDecimal(5, itemDetail.amount);

                record.SetBoolean(6, itemDetail.select);

                // add record
                recordDetail.Add(record);
            }

            return recordDetail;
        }
    }
}

```
## ReconciliationTemplateDynamicParameter.cs
```cs
using AT.AT2017.Api.Core.Models;
using Dapper;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using System.Data;
using System.Data.SqlClient;
using Microsoft.SqlServer.Server;

namespace AT.AT2017.Api.DynamicParameters
{
    public class ReconciliationTemplateDynamicParameter : SqlMapper.IDynamicParameters
    {
        private readonly ReconciliationTemplate _item;

        public ReconciliationTemplateDynamicParameter(ReconciliationTemplate item)
        {
            _item = item;
        }

        void SqlMapper.IDynamicParameters.AddParameters(IDbCommand command, SqlMapper.Identity identity)
        {
            SqlParameter p;
            var sqlCommand = (SqlCommand)command;
            sqlCommand.CommandType = CommandType.StoredProcedure;

            p = sqlCommand.Parameters.Add("@templateId", SqlDbType.Int);
            p.Value = _item.templateId;
            p = sqlCommand.Parameters.Add("@name", SqlDbType.VarChar, 100);
            p.Value = _item.name;
            p = sqlCommand.Parameters.Add("@background", SqlDbType.Image);
            if (_item.background == null)
            {
                p.Value = DBNull.Value;
            }
            else
            {
                p.Value = _item.background;
            }
            p = sqlCommand.Parameters.Add("@backgroundPosition", SqlDbType.VarChar, 50);
            if (_item.backgroundPosition == null)
            {
                p.Value = DBNull.Value;
            }
            else
            {
                p.Value = _item.backgroundPosition;
            }
            p = sqlCommand.Parameters.Add("@width", SqlDbType.Int);
            p.Value = _item.width;
            p = sqlCommand.Parameters.Add("@height", SqlDbType.Int);
            p.Value = _item.height;
            p = sqlCommand.Parameters.Add("@paper_kind", SqlDbType.Int);
            p.Value = _item.paper_kind;
            p = sqlCommand.Parameters.Add("@paper_width", SqlDbType.Int);
            p.Value = _item.paper_width;
            p = sqlCommand.Parameters.Add("@paper_height", SqlDbType.Int);
            p.Value = _item.paper_height;
            p = sqlCommand.Parameters.Add("@margin_top", SqlDbType.Int);
            p.Value = _item.margin_top;
            p = sqlCommand.Parameters.Add("@margin_bottom", SqlDbType.Int);
            p.Value = _item.margin_bottom;
            p = sqlCommand.Parameters.Add("@margin_left", SqlDbType.Int);
            p.Value = _item.margin_left;
            p = sqlCommand.Parameters.Add("@margin_right", SqlDbType.Int);
            p.Value = _item.margin_right;
            p = sqlCommand.Parameters.Add("@landscape", SqlDbType.Bit);
            p.Value = _item.landscape;
            p = sqlCommand.Parameters.Add("@printWithBackground", SqlDbType.Bit);
            p.Value = _item.printWithBackground;
            p = sqlCommand.Parameters.Add("@typeBackground", SqlDbType.VarChar, 30);
            p.Value = _item.typeBackground;
            p = sqlCommand.Parameters.Add("@recordsPerPage", SqlDbType.Int);
            p.Value = _item.recordsPerPage;

            // merge fields
            p = sqlCommand.Parameters.Add("@mergeFields", SqlDbType.Structured);
            p.Direction = ParameterDirection.Input;
            p.TypeName = "reconciliationMergeFieldTableType";
            List<ReconciliationMergeField> mergeFields = (List<ReconciliationMergeField>)_item.mergeFields;
            if (mergeFields.Count > 0)
            {
                p.Value = mapMergeFieldsDetail(_item.mergeFields);
            }
            else
            {
                p.Value = null;
            }
        }

        protected List<SqlDataRecord> mapMergeFieldsDetail(IEnumerable<ReconciliationMergeField> mergeFields)
        {
            SqlMetaData[] tvp =
            {
                new SqlMetaData("reconciliationMergeFieldID", SqlDbType.Int),
                new SqlMetaData("name", SqlDbType.NVarChar, 100),
                new SqlMetaData("fontname", SqlDbType.NVarChar, 50),
                new SqlMetaData("fontsize", SqlDbType.Decimal, 18, 2),
                new SqlMetaData("bold", SqlDbType.Bit),
                new SqlMetaData("underline", SqlDbType.Bit),
                new SqlMetaData("italic", SqlDbType.Bit),
                new SqlMetaData("unit", SqlDbType.Int),
                new SqlMetaData("forecolor_alpha", SqlDbType.Int),
                new SqlMetaData("forecolor_red", SqlDbType.Int),
                new SqlMetaData("forecolor_green", SqlDbType.Int),
                new SqlMetaData("forecolor_blue", SqlDbType.Int),
                new SqlMetaData("width", SqlDbType.Int),
                new SqlMetaData("height", SqlDbType.Int),
                new SqlMetaData("x", SqlDbType.Int),
                new SqlMetaData("y", SqlDbType.Int),
                new SqlMetaData("templateID", SqlDbType.Int),
                new SqlMetaData("isLabel", SqlDbType.Bit),
            };

            List<SqlDataRecord> list = new List<SqlDataRecord>();

            foreach (ReconciliationMergeField item in mergeFields)
            {
                var record = new SqlDataRecord(tvp);
                record.SetInt32(0, item.reconciliationMergeFieldID);
                record.SetString(1, item.name);
                record.SetString(2, item.fontname);
                record.SetDecimal(3, item.fontsize.GetValueOrDefault());
                record.SetBoolean(4, item.bold.GetValueOrDefault());
                record.SetBoolean(5, item.underline.GetValueOrDefault());
                record.SetBoolean(6, item.italic.GetValueOrDefault());
                record.SetInt32(7, item.unit);
                record.SetInt32(8, item.forecolor_alpha);
                record.SetInt32(9, item.forecolor_red);
                record.SetInt32(10, item.forecolor_green);
                record.SetInt32(11, item.forecolor_blue);
                record.SetInt32(12, item.width.GetValueOrDefault());
                record.SetInt32(13, item.height.GetValueOrDefault());
                record.SetInt32(14, item.x.GetValueOrDefault());
                record.SetInt32(15, item.y.GetValueOrDefault());
                record.SetInt32(16, item.templateID.GetValueOrDefault());
                record.SetBoolean(17, item.isLabel.GetValueOrDefault());

                list.Add(record);

            }

            return list;
        }


    }
}

```
## ReimbursementDynamicParameter.cs
```cs
using Dapper;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using System.Data;
using AT.AT2017.Api.Core.Models;
using System.Data.SqlClient;
using Microsoft.SqlServer.Server;



namespace AT.AT2017.Api.DynamicParameters
{
    public class ReimbursementDynamicParameter : SqlMapper.IDynamicParameters
    {
        private readonly IEnumerable<Reimbursement> _list;

        public ReimbursementDynamicParameter(IEnumerable<Reimbursement> list)
        {
            _list = list;
        }

        void SqlMapper.IDynamicParameters.AddParameters(IDbCommand command, SqlMapper.Identity identity)
        {
            SqlParameter p;
            var sqlCommand = (SqlCommand)command;
            sqlCommand.CommandType = CommandType.StoredProcedure;
           
            p = sqlCommand.Parameters.Add("@detail", SqlDbType.Structured);
            p.Direction = ParameterDirection.Input;
            p.TypeName = "reimbursementTableType";
            p.Value = mapReimbursementDetail(_list);
        }


        protected List<SqlDataRecord> mapReimbursementDetail(IEnumerable<Reimbursement> detail)
        {
            SqlMetaData[] tvpDetail =
            {
                 new SqlMetaData("type", SqlDbType.NVarChar, 15),
                new SqlMetaData("detailId", SqlDbType.Int),
                new SqlMetaData("id", SqlDbType.Int),
                new SqlMetaData("companyId", SqlDbType.Int),
                new SqlMetaData("amount", SqlDbType.Decimal,18,2),
                new SqlMetaData("description", SqlDbType.NVarChar, 1000),
                new SqlMetaData("date", SqlDbType.DateTime),
                new SqlMetaData("orderTypeId", SqlDbType.Int),
                new SqlMetaData("accountId", SqlDbType.Int),
                new SqlMetaData("jobId", SqlDbType.Int),
                new SqlMetaData("divisionId", SqlDbType.Int),
                new SqlMetaData("reimb", SqlDbType.Bit),
                new SqlMetaData("locked", SqlDbType.Bit),
                new SqlMetaData("deductType", SqlDbType.NVarChar, 50),
                new SqlMetaData("side", SqlDbType.NVarChar, 10),
                new SqlMetaData("columnNumber", SqlDbType.Int),
                new SqlMetaData("propertyId", SqlDbType.Int)
            };

            List<SqlDataRecord> records = new List<SqlDataRecord>();

            foreach (Reimbursement itemDetail in detail)
            {
                var record = new SqlDataRecord(tvpDetail);

                record.SetString(0, itemDetail.type);
                record.SetInt32(1, itemDetail.detailId);
                record.SetInt32(2, itemDetail.id);
                record.SetInt32(3, itemDetail.companyId);
                record.SetDecimal(4, itemDetail.amount);
                if (!string.IsNullOrEmpty(itemDetail.description))
                {
                    record.SetString(5, itemDetail.description);
                }
                if (itemDetail.date != null && itemDetail.date > DateTime.MinValue)
                {
                    record.SetDateTime(6, itemDetail.date);
                }
                record.SetInt32(7, itemDetail.orderTypeId);
                record.SetInt32(8, itemDetail.accountId.GetValueOrDefault());
                record.SetInt32(9, itemDetail.jobId.GetValueOrDefault());
                if (itemDetail.divisionId > 0)
                {
                    record.SetInt32(10, itemDetail.divisionId.GetValueOrDefault());
                }
                record.SetSqlBoolean(11, itemDetail.reimb);
                record.SetSqlBoolean(12, itemDetail.locked.GetValueOrDefault());
                if (!string.IsNullOrWhiteSpace(itemDetail.deductType))
                {
                    record.SetString(13, itemDetail.deductType);
                }
                if (!string.IsNullOrWhiteSpace(itemDetail.side))
                {
                    record.SetString(14, itemDetail.side);
                }
                if (itemDetail.columnNumber > 0)
                {
                    record.SetInt32(15, itemDetail.columnNumber.GetValueOrDefault());
                }
                if (itemDetail.propertyId != null)
                {
                    record.SetInt32(16, itemDetail.propertyId.GetValueOrDefault());
                }

                records.Add(record);

            }

            return records;
        }
    }
}


```
## RepCubeStartExecutionDynamicParameter.cs
```cs
using Dapper;
using System;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.DynamicParameters
{
    public class RepCubeStartExecutionDynamicParameter : SqlMapper.IDynamicParameters
    {
        private readonly string _cubeList;
        private readonly string _threadName;
        private readonly int _userID;
        private readonly DateTime _processDate;
        private readonly string _updateType;
        private readonly bool _silent;

        public RepCubeStartExecutionDynamicParameter(string cubeList, string threadName, int userID, DateTime processDate, string updateType, bool silent)
        {
            _cubeList = cubeList;
            _threadName = threadName;
            _userID = userID;
            _processDate = processDate;
            _updateType = updateType;
            _silent = silent;
        }

        void SqlMapper.IDynamicParameters.AddParameters(IDbCommand command, SqlMapper.Identity identity)
        {
            SqlParameter p;
            var sqlCommand = (SqlCommand)command;
            sqlCommand.CommandType = CommandType.StoredProcedure;

            p = sqlCommand.Parameters.Add("@cubeList", SqlDbType.VarChar, 100);
            p.Value = _cubeList;

            p = sqlCommand.Parameters.Add("@threadName", SqlDbType.VarChar, 100);
            p.Value = _threadName;

            p = sqlCommand.Parameters.Add("@userID", SqlDbType.Int);
            p.Value = _userID;

            p = sqlCommand.Parameters.Add("@processDate", SqlDbType.DateTime);
            p.Value = _processDate;

            p = sqlCommand.Parameters.Add("@updateType", SqlDbType.VarChar, 50);
            p.Value = _updateType;

            p = sqlCommand.Parameters.Add("@silent", SqlDbType.Bit);
            p.Value = _silent;

            p = sqlCommand.Parameters.Add("@executionGUID", SqlDbType.UniqueIdentifier);
            p.Direction = ParameterDirection.Output;
        }
    }
}

```
## ReportDynamicParameter.cs
```cs
using Dapper;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using System.Data;
using AT.AT2017.Api.Core.Models;
using System.Data.SqlClient;
using Microsoft.SqlServer.Server;

namespace AT.AT2017.Api.DynamicParameters
{
    public class ReportDynamicParameter : SqlMapper.IDynamicParameters
    {
        private readonly Report _report;

        public ReportDynamicParameter(Report item)
        {
            _report = item;
        }

        void SqlMapper.IDynamicParameters.AddParameters(IDbCommand command, SqlMapper.Identity identity)
        {
            SqlParameter p;
            var sqlCommand = (SqlCommand)command;
            sqlCommand.CommandType = CommandType.StoredProcedure;

            p = sqlCommand.Parameters.Add("@reportId", SqlDbType.Int);
            p.Value = _report.reportId;
            p = sqlCommand.Parameters.Add("@name", SqlDbType.VarChar);
            p.Value = _report.name;
            p = sqlCommand.Parameters.Add("@group", SqlDbType.VarChar);
            p.Value = _report.groupName;
            p = sqlCommand.Parameters.Add("@url", SqlDbType.VarChar);
            p.Value = _report.url;
            p = sqlCommand.Parameters.Add("@description", SqlDbType.VarChar);
            p.Value = _report.description ?? string.Empty;
            p = sqlCommand.Parameters.Add("@masterKeyName", SqlDbType.VarChar);
            p.Value = _report.masterKeyName ?? string.Empty;
            p = sqlCommand.Parameters.Add("@tags", SqlDbType.VarChar);
            p.Value = _report.tags ?? string.Empty;

            p = sqlCommand.Parameters.Add("@columns", SqlDbType.Structured);
            p.Direction = ParameterDirection.Input;
            p.TypeName = "reportColumnTableType";
            p.Value = _report.columns?.Count() > 0 ? mapColumns(_report.columns) : null;

            p = sqlCommand.Parameters.Add("@groups", SqlDbType.Structured);
            p.Direction = ParameterDirection.Input;
            p.TypeName = "reportGroupByTableType";
            p.Value = _report.groupers?.Count() > 0 ? mapGroups(_report.groupers) : null;

            p = sqlCommand.Parameters.Add("@parameters", SqlDbType.Structured);
            p.Direction = ParameterDirection.Input;
            p.TypeName = "reportParameterTableType";
            p.Value = _report.parameters?.Count() > 0 ? mapParameters(_report.parameters) : null;
        }

        protected List<SqlDataRecord> mapColumns(IEnumerable<ReportColumn> columns)
        {
            SqlMetaData[] tvpReportColumn =
            {
                new SqlMetaData("columnID", SqlDbType.Int),
                new SqlMetaData("name", SqlDbType.VarChar, 100),
                new SqlMetaData("label", SqlDbType.VarChar, 100),
                new SqlMetaData("sortOrder", SqlDbType.Int),
                new SqlMetaData("showByDefault", SqlDbType.Bit),
                new SqlMetaData("groupLabel", SqlDbType.VarChar, 100),
            };

            List<SqlDataRecord> records = new List<SqlDataRecord>();

            foreach (var column in columns)
            {
                var record = new SqlDataRecord(tvpReportColumn);
                record.SetInt32(0, column.columnID);
                record.SetString(1, column.name ?? string.Empty);
                record.SetString(2, column.label ?? string.Empty);
                record.SetInt32(3, column.sortOrder);
                record.SetBoolean(4, column.showByDefault);
                record.SetString(5, column.groupLabel ?? string.Empty);

                records.Add(record);
            }

            return records;
        }

        protected List<SqlDataRecord> mapParameters(IEnumerable<ReportParameter> parameters)
        {
            SqlMetaData[] tvpReportParameter =
            {
                new SqlMetaData("parameterID", SqlDbType.Int),
                new SqlMetaData("name", SqlDbType.VarChar, 100),
                new SqlMetaData("label", SqlDbType.VarChar, 100),
                new SqlMetaData("dataSource", SqlDbType.VarChar, 100),
                new SqlMetaData("sortOrder", SqlDbType.Int),
                new SqlMetaData("allowNulls", SqlDbType.Bit),
                new SqlMetaData("enable", SqlDbType.Bit),
                new SqlMetaData("defaultValue", SqlDbType.VarChar, SqlMetaData.Max),
                new SqlMetaData("typ", SqlDbType.VarChar, 20),
                new SqlMetaData("visible", SqlDbType.Bit),
                new SqlMetaData("required", SqlDbType.Bit),
                new SqlMetaData("groupLabel", SqlDbType.VarChar, 100),
            };

            List<SqlDataRecord> records = new List<SqlDataRecord>();

            foreach (var parameter in parameters)
            {
                var record = new SqlDataRecord(tvpReportParameter);
                record.SetInt32(0, int.Parse(parameter.parameterID ?? "0"));
                record.SetString(1, parameter.name ?? string.Empty);
                record.SetString(2, parameter.label ?? string.Empty);
                record.SetString(3, parameter.dataSource ?? string.Empty);
                record.SetInt32(4, parameter.sortOrder);
                record.SetBoolean(5, parameter.allowNulls);
                record.SetBoolean(6, Boolean.Parse(parameter.enable ?? false.ToString()));
                record.SetString(7, parameter.defaultValue ?? string.Empty);
                record.SetString(8, parameter.type ?? string.Empty);
                record.SetBoolean(9, Boolean.Parse(parameter.visible ?? false.ToString()));
                record.SetBoolean(10, Boolean.Parse(parameter.required ?? false.ToString()));
                record.SetString(11, parameter.groupLabel ?? string.Empty);

                records.Add(record);
            }

            return records;
        }

        protected List<SqlDataRecord> mapGroups(IEnumerable<ReportGroupBy> groups)
        {
            SqlMetaData[] tvpReportGroups =
            {
                new SqlMetaData("groupByID", SqlDbType.Int),
                new SqlMetaData("columnName", SqlDbType.VarChar, 100),
                new SqlMetaData("label", SqlDbType.VarChar, 100),
                new SqlMetaData("sortOrder", SqlDbType.Int),
                new SqlMetaData("byDefault", SqlDbType.Bit)
            };

            List<SqlDataRecord> records = new List<SqlDataRecord>();

            foreach (var group in groups)
            {
                var record = new SqlDataRecord(tvpReportGroups);
                record.SetInt32(0, group.groupByID);
                record.SetString(1, group.name ?? string.Empty);
                record.SetString(2, group.label ?? string.Empty);
                record.SetInt32(3, group.sortOrder);
                record.SetBoolean(4, group.byDefault);

                records.Add(record);
            }

            return records;
        }
    }
}

```
## RoleDynamicParameter.cs
```cs
using Dapper;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using System.Data;
using AT.AT2017.Api.Core.Models;
using System.Data.SqlClient;
using Microsoft.SqlServer.Server;

namespace AT.AT2017.Api.DynamicParameters
{
    public class RoleDynamicParameter : SqlMapper.IDynamicParameters
    {

        private readonly Role _item;

        public RoleDynamicParameter(Role item)
        {
            _item = item;
        }
        
        void SqlMapper.IDynamicParameters.AddParameters(IDbCommand command, SqlMapper.Identity identity)
        {
            SqlParameter p;
            var sqlCommand = (SqlCommand)command;
            sqlCommand.CommandType = CommandType.StoredProcedure;

            p = sqlCommand.Parameters.Add("@roleID", SqlDbType.Int);
            p.Value = _item.roleId;
            p = sqlCommand.Parameters.Add("@name", SqlDbType.NVarChar, 100);
            p.Value = _item.name;
            p = sqlCommand.Parameters.Add("@system", SqlDbType.NVarChar, 100);
            p.Value = _item.system;

            // users
            p = sqlCommand.Parameters.Add("@users", SqlDbType.Structured);
            p.Direction = ParameterDirection.Input;
            p.TypeName = "userRoleTableType";
            List<UserRole> users = (List<UserRole>)_item.users;
            if (users.Count > 0)
            {
                p.Value = mapUsers(_item.users);
            }
            else
            {
                p.Value = null;
            }

            // actions
            p = sqlCommand.Parameters.Add("@security", SqlDbType.Structured);
            p.Direction = ParameterDirection.Input;
            p.TypeName = "securityTableType";
            List<Security> security = (List<Security>)_item.security;
            if (security.Count > 0)
            {
                p.Value = mapSecurity(_item.security);
            }
            else
            {
                p.Value = null;
            }

            // reports
            p = sqlCommand.Parameters.Add("@reports", SqlDbType.Structured);
            p.Direction = ParameterDirection.Input;
            p.TypeName = "roleReportTableType";
            List<RoleReport> reports = (List<RoleReport>)_item.reports;
            if (reports.Count > 0)
            {
                p.Value = mapReports(_item.reports);
            }
            else
            {
                p.Value = null;
            }

            // person types
            p = sqlCommand.Parameters.Add("@personTypes", SqlDbType.Structured);
            p.Direction = ParameterDirection.Input;
            p.TypeName = "rolePersonTypeTableType";
            List<RolePersonType> personTypes = (List<RolePersonType>)_item.personTypes;
            if (personTypes.Count > 0)
            {
                p.Value = mapPersonTypes(_item.personTypes);
            }
            else
            {
                p.Value = null;
            }

            // analytics dashboards
            p = sqlCommand.Parameters.Add("@analyticsDashboard", SqlDbType.Structured);
            p.Direction = ParameterDirection.Input;
            p.TypeName = "roleAnalyticsDashboardTableType";
            List<RoleAnalyticsDashboard> analyticsDashboards = (List<RoleAnalyticsDashboard>)_item.analyticsDashboards;
            if (analyticsDashboards.Count > 0)
            {
                p.Value = mapAnalyticsDashboard(_item.analyticsDashboards);
            }
            else
            {
                p.Value = null;
            }
        }
        
        protected List<SqlDataRecord> mapUsers(IEnumerable<UserRole> users)
        {
            SqlMetaData[] tvp =
            {
                new SqlMetaData("userRoleID", SqlDbType.Int),
                new SqlMetaData("userID", SqlDbType.Int),
                new SqlMetaData("roleID", SqlDbType.Int),
            };

            List<SqlDataRecord> list = new List<SqlDataRecord>();

            foreach (UserRole user in users)
            {
                var record = new SqlDataRecord(tvp);
                record.SetInt32(0, user.userRoleId);
                record.SetInt32(1, user.userId);                
                record.SetInt32(2, user.roleId);

                list.Add(record);
            }

            return list;
        }

        protected List<SqlDataRecord> mapSecurity(IEnumerable<Security> security)
        {
            SqlMetaData[] tvp =
            {
                new SqlMetaData("securityID", SqlDbType.Int),
                new SqlMetaData("roleID", SqlDbType.Int),
                new SqlMetaData("actionID", SqlDbType.Int),
            };

            List<SqlDataRecord> list = new List<SqlDataRecord>();

            foreach (Security itemSecurity in security)
            {
                var record = new SqlDataRecord(tvp);
                record.SetInt32(0, itemSecurity.securityId);
                record.SetInt32(1, itemSecurity.roleId);
                record.SetInt32(2, itemSecurity.actionId);

                list.Add(record);
            }

            return list;
        }

        protected List<SqlDataRecord> mapReports(IEnumerable<RoleReport> reports)
        {
            SqlMetaData[] tvp =
            {
                new SqlMetaData("roleReportID", SqlDbType.Int),
                new SqlMetaData("roleID", SqlDbType.Int),
                new SqlMetaData("reportID", SqlDbType.Int),
            };

            List<SqlDataRecord> list = new List<SqlDataRecord>();

            foreach (RoleReport item in reports)
            {
                var record = new SqlDataRecord(tvp);
                record.SetInt32(0, item.roleReportId);
                record.SetInt32(1, item.roleId);
                record.SetInt32(2, item.reportId);

                list.Add(record);
            }

            return list;
        }

        protected List<SqlDataRecord> mapPersonTypes(IEnumerable<RolePersonType> personTypes)
        {
            SqlMetaData[] tvp =
            {
                new SqlMetaData("rolePersonTypeID", SqlDbType.Int),
                new SqlMetaData("roleID", SqlDbType.Int),
                new SqlMetaData("personTypeID", SqlDbType.Int),
                new SqlMetaData("accessType", SqlDbType.VarChar, 20),
            };

            List<SqlDataRecord> list = new List<SqlDataRecord>();

            foreach (RolePersonType item in personTypes)
            {
                var record = new SqlDataRecord(tvp);
                record.SetInt32(0, item.rolePersonTypeId);
                record.SetInt32(1, item.roleId);
                record.SetInt32(2, item.personTypeId);
                record.SetString(3, item.accessType);

                list.Add(record);
            }

            return list;
        }

        protected List<SqlDataRecord> mapAnalyticsDashboard(IEnumerable<RoleAnalyticsDashboard> analyticsDashboards)
        {
            SqlMetaData[] tvp =
            {
                new SqlMetaData("roleDashboardID", SqlDbType.Int),
                new SqlMetaData("roleID", SqlDbType.Int),
                new SqlMetaData("dashboardID", SqlDbType.Int),
            };

            List<SqlDataRecord> list = new List<SqlDataRecord>();

            foreach (RoleAnalyticsDashboard item in analyticsDashboards)
            {
                var record = new SqlDataRecord(tvp);
                record.SetInt32(0, item.roleDashboardID);
                record.SetInt32(1, item.roleID);
                record.SetInt32(2, item.dashboardID);

                list.Add(record);
            }

            return list;
        }
    }
}

```
## StoreOrderDynamicParameter.cs
```cs
using Dapper;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using System.Data;
using AT.AT2017.Api.Core.Models;
using System.Data.SqlClient;
using Microsoft.SqlServer.Server;
using System.Data.SqlTypes;

namespace AT.AT2017.Api.DynamicParameters
{
    public class StoreOrderDynamicParameter : SqlMapper.IDynamicParameters
    {
        private StoreOrder _storeOrder;

        public StoreOrderDynamicParameter(StoreOrder storeOrder)
        {
            _storeOrder = storeOrder;
        }

        void SqlMapper.IDynamicParameters.AddParameters(IDbCommand command, SqlMapper.Identity identity)
        {
            SqlParameter p;
            var sqlCommand = (SqlCommand)command;
            sqlCommand.CommandType = CommandType.StoredProcedure;

            p = sqlCommand.Parameters.Add("@orderId", SqlDbType.Int);
            p.Value = _storeOrder.orderId;

            p = sqlCommand.Parameters.Add("@inventoryId", SqlDbType.Int);
            p.Value = _storeOrder.inventoryId;

            p = sqlCommand.Parameters.Add("@personId", SqlDbType.Int);
            p.Value = _storeOrder.personId;

            p = sqlCommand.Parameters.Add("@invoiceId", SqlDbType.Int);
            p.Value = _storeOrder.invoiceId;

            p = sqlCommand.Parameters.Add("@saleTotal", SqlDbType.Decimal);
            p.Value = _storeOrder.saleTotal ?? 0;

            p = sqlCommand.Parameters.Add("@propertyId", SqlDbType.Int);
            p.Value = _storeOrder.propertyId ?? 0;

            p = sqlCommand.Parameters.Add("@descriptiveText", SqlDbType.VarChar, 1000);
            p.Value = _storeOrder.descriptiveText;

            p = sqlCommand.Parameters.Add("@currentInventory", SqlDbType.Int);
            p.Value = _storeOrder.currentInventory ?? 0;

            p = sqlCommand.Parameters.Add("@filled", SqlDbType.Bit);
            p.Value = _storeOrder.filled;

            p = sqlCommand.Parameters.Add("@paid", SqlDbType.Bit);
            p.Value = _storeOrder.paid;

            p = sqlCommand.Parameters.Add("@quantity", SqlDbType.Int);
            p.Value = _storeOrder.quantity;

            // detail

            p = sqlCommand.Parameters.Add("@pictures", SqlDbType.Structured);
            p.Direction = ParameterDirection.Input;
            p.TypeName = "storeOrderPictureTableType";
            if (_storeOrder.pictures?.Count() == 0)
            {
                p.Value = null;
            }
            else
            {
                p.Value = mapTable(_storeOrder.pictures);
            }
        }


        protected List<SqlDataRecord> mapTable(IEnumerable<StoreOrderPicture> table)
        {
            SqlMetaData[] tvp =
            {
                new SqlMetaData("pictureId", SqlDbType.Int),
                new SqlMetaData("propertyPictureId", SqlDbType.Int),
                new SqlMetaData("driveID", SqlDbType.NVarChar, 100),
                new SqlMetaData("videoUrl", SqlDbType.NVarChar, 500),
            };

            List<SqlDataRecord> records = new List<SqlDataRecord>();

            foreach (StoreOrderPicture item in table)
            {
                var record = new SqlDataRecord(tvp);
                record.SetInt32(0, item.pictureId);
                if (item.propertyPictureId.HasValue)
                {
                    record.SetInt32(1, item.propertyPictureId.Value);
                }
                else
                {
                    record.SetDBNull(1);
                }
                
                record.SetString(2, item.driveID ?? string.Empty);
                record.SetString(3, item.videoUrl ?? string.Empty);
                records.Add(record);
            }

            return records;
        }

    }
}

```
## SubmissionBHSDynamicParameter.cs
```cs
using Dapper;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using System.Data;
using AT.AT2017.Api.Core.Models;
using System.Data.SqlClient;
using Microsoft.SqlServer.Server;

namespace AT.AT2017.Api.DynamicParameters
{
    public class SubmissionBHSDynamicParameter : SqlMapper.IDynamicParameters
    {
        private readonly SubmissionBHS _submission;

        public SubmissionBHSDynamicParameter(SubmissionBHS submission)
        {
            _submission = submission;
        }

        void SqlMapper.IDynamicParameters.AddParameters(IDbCommand command, SqlMapper.Identity identity)
        {
            SqlParameter p;
            var sqlCommand = (SqlCommand)command;
            sqlCommand.CommandType = CommandType.StoredProcedure;

            if (  _submission.submitID>0)
            {
                p = sqlCommand.Parameters.Add("@submitID", SqlDbType.Int);
                p.Value = _submission.submitID;
                p = sqlCommand.Parameters.Add("@isSubmit", SqlDbType.Bit);
                p.Value = _submission.isSubmit;
            }
            else {
                p = sqlCommand.Parameters.Add("@companyId", SqlDbType.Int);
                p.Value = _submission.companyID;
                p = sqlCommand.Parameters.Add("@endDate", SqlDbType.VarChar, 100);
                p.Value = _submission.endDate.ToString("yyyyMMdd HH:mm:ss");
                p = sqlCommand.Parameters.Add("@isSubmit", SqlDbType.Bit);
                p.Value = _submission.isSubmit;
            }
          
            // submissionDetailBHSHeaderTableType
            if (_submission.headerDetail != null && _submission.headerDetail.Count() > 0)
            {
                p = sqlCommand.Parameters.Add("@bhsHeader", SqlDbType.Structured);
                p.Direction = ParameterDirection.Input;
                p.TypeName = "submissionDetailBHSHeaderTableType";
                p.Value = mapHeader(_submission.headerDetail);
            }

            // submissionDetailBHSSalesTransactionTableType
            if (_submission.salesTransactionDetail != null && _submission.salesTransactionDetail.Count() > 0)
            {
                p = sqlCommand.Parameters.Add("@bhsSalesTransaction", SqlDbType.Structured);
                p.Direction = ParameterDirection.Input;
                p.TypeName = "submissionDetailBHSSalesTransactionTableType";
                p.Value = mapSalesTransaction(_submission.salesTransactionDetail);
            }

            // submissionDetailBHSMiscIncomeTableType
            if (_submission.miscIncomeDetail != null && _submission.miscIncomeDetail.Count() > 0)
            {
                p = sqlCommand.Parameters.Add("@bhsMiscIncome", SqlDbType.Structured);
                p.Direction = ParameterDirection.Input;
                p.TypeName = "submissionDetailBHSMiscIncomeTableType";
                p.Value = mapMiscIncome(_submission.miscIncomeDetail);
            }

            // submissionDetailBHSSalesAssociateTableType
            if (_submission.salesAssociateDetail != null && _submission.salesAssociateDetail.Count() > 0)
            {
                p = sqlCommand.Parameters.Add("@bhsSalesAssociate", SqlDbType.Structured);
                p.Direction = ParameterDirection.Input;
                p.TypeName = "submissionDetailBHSSalesAssociateTableType";
                p.Value = mapSalesAssociate(_submission.salesAssociateDetail);
            }

            // submissionDetailBHSSalesCustomerTableType
            if (_submission.salesCustomerDetail != null && _submission.salesCustomerDetail.Count() > 0)
            {
                p = sqlCommand.Parameters.Add("@bhsSalesCustomer", SqlDbType.Structured);
                p.Direction = ParameterDirection.Input;
                p.TypeName = "submissionDetailBHSSalesCustomerTableType";
                p.Value = mapSalesCustomer(_submission.salesCustomerDetail);
            }

            // submissionDetailBHSAssociateProductionTableType
            if (_submission.associateProductionDetail != null && _submission.associateProductionDetail.Count() > 0)
            {
                p = sqlCommand.Parameters.Add("@bhsAssociateProduction", SqlDbType.Structured);
                p.Direction = ParameterDirection.Input;
                p.TypeName = "submissionDetailBHSAssociateProductionTableType";
                p.Value = mapAssociateProduction(_submission.associateProductionDetail);
            }

            // submissionDetailBHSMonthlyListingsTableType
            if (_submission.monthlyListingsDetail != null && _submission.monthlyListingsDetail.Count() > 0)
            {
                p = sqlCommand.Parameters.Add("@bhsMonthlyListings", SqlDbType.Structured);
                p.Direction = ParameterDirection.Input;
                p.TypeName = "submissionDetailBHSMonthlyListingsTableType";
                p.Value = mapMonthlyListings(_submission.monthlyListingsDetail);
            }

            // submissionDetailBHSTrailerTableType
            if (_submission.trailerDetail != null && _submission.trailerDetail.Count() > 0)
            {
                p = sqlCommand.Parameters.Add("@bhsTrailer", SqlDbType.Structured);
                p.Direction = ParameterDirection.Input;
                p.TypeName = "submissionDetailBHSTrailerTableType";
                p.Value = mapTrailer(_submission.trailerDetail);
            }
        }

        protected List<SqlDataRecord> mapHeader(IEnumerable<SubmissionDetailBHSHeader> detail)
        {
            SqlMetaData[] tDetail =
            {
                new SqlMetaData("submitID", SqlDbType.Int),
                new SqlMetaData("recordType", SqlDbType.VarChar,2),
                new SqlMetaData("batchID", SqlDbType.Int),
                new SqlMetaData("endDate", SqlDbType.DateTime),
                new SqlMetaData("affiliateID", SqlDbType.VarChar,100),
                new SqlMetaData("baseCurrencyCode", SqlDbType.VarChar,10),
                new SqlMetaData("softwareName", SqlDbType.VarChar,100),
                new SqlMetaData("softwareVersion", SqlDbType.VarChar,10),
                new SqlMetaData("dataBridgeVersion", SqlDbType.VarChar,10)               
             };

             List<SqlDataRecord> records = new List<SqlDataRecord>();

            foreach (SubmissionDetailBHSHeader itemDetail in detail)
            {
                var record = new SqlDataRecord(tDetail);
                record.SetInt32(0, itemDetail.submitID);
                record.SetString(1, itemDetail.recordType);
                record.SetInt32(2, itemDetail.batchID);
                if (itemDetail.endDate != null && itemDetail.endDate > DateTime.MinValue)
                    record.SetDateTime(3, itemDetail.endDate);
                record.SetString(4, itemDetail.affiliateID);
                record.SetString(5, itemDetail.baseCurrencyCode);
                record.SetString(6, itemDetail.softwareName);
                record.SetString(7, itemDetail.softwareVersion);
                record.SetString(8, itemDetail.dataBridgeVersion);
                records.Add(record);
            }

            return records;
        }

        protected List<SqlDataRecord> mapSalesTransaction(IEnumerable<SubmissionDetailBHSSalesTransaction> detail)
        {
            SqlMetaData[] tDetail =
            {
                new SqlMetaData("submitID", SqlDbType.Int),
                new SqlMetaData("recordType", SqlDbType.VarChar,2),
                new SqlMetaData("officeID", SqlDbType.VarChar,20),
                new SqlMetaData("transNo", SqlDbType.VarChar,20),
                new SqlMetaData("status", SqlDbType.VarChar,2),
                new SqlMetaData("batchID", SqlDbType.Int),
                new SqlMetaData("sequenceNumber", SqlDbType.Int),
                new SqlMetaData("closeDate", SqlDbType.DateTime),
                new SqlMetaData("soldDate", SqlDbType.DateTime),
                new SqlMetaData("propertyAddress", SqlDbType.VarChar,100),
                new SqlMetaData("city", SqlDbType.VarChar,50),
                new SqlMetaData("state", SqlDbType.VarChar,2),
                new SqlMetaData("zipCode", SqlDbType.VarChar,10),
                new SqlMetaData("country", SqlDbType.VarChar,3),
                new SqlMetaData("propertyType", SqlDbType.VarChar,1),
                new SqlMetaData("unimprovedLandFlag", SqlDbType.VarChar,10),
                new SqlMetaData("salesPrice", SqlDbType.Decimal,18,2),
                new SqlMetaData("productionUnit", SqlDbType.Decimal,18,2),
                new SqlMetaData("gci", SqlDbType.Decimal,18,2),
                new SqlMetaData("gdcDeductions", SqlDbType.Decimal,18,2),
                new SqlMetaData("listingOfficeID", SqlDbType.VarChar,20),
                new SqlMetaData("sellingOfficeID", SqlDbType.VarChar,20),
                new SqlMetaData("incrementalFlag", SqlDbType.VarChar,10),
                new SqlMetaData("incrementalGciPercent", SqlDbType.Decimal,18,2),
                new SqlMetaData("currencyCode", SqlDbType.VarChar,10),
                new SqlMetaData("referredTran", SqlDbType.VarChar,10),
                new SqlMetaData("inNetworkReferral", SqlDbType.VarChar,10),
                new SqlMetaData("referralSource", SqlDbType.VarChar,5)
             };

            List<SqlDataRecord> records = new List<SqlDataRecord>();

            foreach (SubmissionDetailBHSSalesTransaction itemDetail in detail)
            {
                var record = new SqlDataRecord(tDetail);
                record.SetInt32(0, itemDetail.submitID);
                record.SetString(1, itemDetail.recordType);
                if (string.IsNullOrEmpty( itemDetail.officeID)==false)
                    record.SetString(2, itemDetail.officeID);
                record.SetString(3, itemDetail.transNo);
                record.SetString(4, itemDetail.status);
                record.SetInt32(5, itemDetail.batchID);
                record.SetInt32(6, itemDetail.sequenceNumber);
                if (itemDetail.closeDate != null && itemDetail.closeDate > DateTime.MinValue)
                    record.SetDateTime(7, itemDetail.closeDate);
                if (itemDetail.soldDate != null && itemDetail.soldDate > DateTime.MinValue)
                    record.SetDateTime(8, itemDetail.soldDate);
                record.SetString(9, itemDetail.propertyAddress);
                if (string.IsNullOrEmpty(itemDetail.city) == false)
                    record.SetString(10, itemDetail.city);
                if (string.IsNullOrEmpty(itemDetail.state) == false)
                    record.SetString(11, itemDetail.state);
                if (string.IsNullOrEmpty(itemDetail.zipCode) == false)
                    record.SetString(12, itemDetail.zipCode);
                record.SetString(13, itemDetail.country);
                record.SetString(14, itemDetail.propertyType);
                record.SetString(15, itemDetail.unimprovedLandFlag);
                record.SetDecimal(16, itemDetail.salesPrice);
                record.SetDecimal(17, itemDetail.productionUnit);
                record.SetDecimal(18, itemDetail.gci);
                record.SetDecimal(19, itemDetail.gciDeductions);
                if (string.IsNullOrEmpty(itemDetail.listingOfficeID) == false)
                    record.SetString(20, itemDetail.listingOfficeID);
                if (string.IsNullOrEmpty(itemDetail.sellingOfficeID) == false)
                    record.SetString(21, itemDetail.sellingOfficeID);
                if (string.IsNullOrEmpty(itemDetail.incrementalFlag) == false)
                    record.SetString(22, itemDetail.incrementalFlag);             
                record.SetDecimal(23, itemDetail.incrementalGciPercent);
                if (string.IsNullOrEmpty(itemDetail.currencyCode) == false)
                    record.SetString(24, itemDetail.currencyCode);
                if (string.IsNullOrEmpty(itemDetail.referredTran) == false)
                    record.SetString(25, itemDetail.referredTran);
                if (string.IsNullOrEmpty(itemDetail.inNetworkReferral) == false)
                    record.SetString(26, itemDetail.inNetworkReferral);
                if (string.IsNullOrEmpty( itemDetail.referralSource) ==false)
                    record.SetString(27, itemDetail.referralSource);
                records.Add(record);
            }

            return records;
        }

        protected List<SqlDataRecord> mapMiscIncome(IEnumerable<SubmissionDetailBHSMiscIncome> detail)
        {
            SqlMetaData[] tDetail =
            {
                new SqlMetaData("submitID", SqlDbType.Int),
                new SqlMetaData("recordType", SqlDbType.VarChar,2),
                new SqlMetaData("officeID", SqlDbType.VarChar,20),
                new SqlMetaData("batchID", SqlDbType.Int),
                new SqlMetaData("transType", SqlDbType.VarChar,2),
                new SqlMetaData("transNo", SqlDbType.VarChar,20),
                new SqlMetaData("sequenceNumber", SqlDbType.Int),
                new SqlMetaData("commissionDate", SqlDbType.DateTime),
                new SqlMetaData("propertyType", SqlDbType.VarChar,1),
                new SqlMetaData("unimprovedLandFlag", SqlDbType.VarChar,10),
                new SqlMetaData("gci", SqlDbType.Decimal,18,2),
                new SqlMetaData("gdcDeductions", SqlDbType.Decimal,18,2),
                new SqlMetaData("currencyCode", SqlDbType.VarChar,10),
                new SqlMetaData("referredTran", SqlDbType.VarChar,10),
                new SqlMetaData("inNetworkReferral", SqlDbType.VarChar,10),
                new SqlMetaData("referralSource", SqlDbType.VarChar,5)
             };
       
             List<SqlDataRecord> records = new List<SqlDataRecord>();

            foreach (SubmissionDetailBHSMiscIncome itemDetail in detail)
            {
                var record = new SqlDataRecord(tDetail);
                record.SetInt32(0, itemDetail.submitID);
                record.SetString(1, itemDetail.recordType);
                if (string.IsNullOrEmpty(itemDetail.officeID) == false)
                    record.SetString(2, itemDetail.officeID);
                record.SetInt32(3, itemDetail.batchID);
                record.SetString(4, itemDetail.transType);
                record.SetString(5, itemDetail.transNo);
                record.SetInt32(6, itemDetail.sequenceNumber);
                if (itemDetail.commissionDate != null && itemDetail.commissionDate > DateTime.MinValue)
                    record.SetDateTime(7, itemDetail.commissionDate);
                record.SetString(8, itemDetail.propertyType);
                record.SetString(9, itemDetail.unimprovedLandFlag);
                record.SetDecimal(10, itemDetail.gci);
                record.SetDecimal(11, itemDetail.gciDeductions);
                if (itemDetail.currencyCode != null)
                    record.SetString(12, itemDetail.currencyCode);
                if (itemDetail.referredTran != null)
                    record.SetString(13, itemDetail.referredTran);
                if (itemDetail.inNetworkReferral != null)
                    record.SetString(14, itemDetail.inNetworkReferral);
                if (itemDetail.referralSource != null)
                    record.SetString(15, itemDetail.referralSource);
                records.Add(record);
            }

            return records;
        }

        protected List<SqlDataRecord> mapSalesAssociate(IEnumerable<SubmissionDetailBHSSalesAssociate> detail)
        {
            SqlMetaData[] tDetail =
            {
                new SqlMetaData("submitID", SqlDbType.Int),
                new SqlMetaData("recordType", SqlDbType.VarChar,2),
                new SqlMetaData("affiliateID", SqlDbType.VarChar,100),
                new SqlMetaData("assignedToOffice", SqlDbType.VarChar,20),
                new SqlMetaData("bmsID", SqlDbType.VarChar,100),              
                new SqlMetaData("preaID", SqlDbType.VarChar,10),
                new SqlMetaData("firstName", SqlDbType.VarChar,50),
                new SqlMetaData("middleInitial", SqlDbType.VarChar,1),
                new SqlMetaData("lastName", SqlDbType.VarChar,50),
                new SqlMetaData("primaryEmail", SqlDbType.VarChar,50),
                new SqlMetaData("employeeType", SqlDbType.VarChar,50),
                new SqlMetaData("employeeStatus", SqlDbType.VarChar,50),
                new SqlMetaData("mobilePhone", SqlDbType.VarChar,50),
                new SqlMetaData("alternateEmail", SqlDbType.VarChar,50),
                new SqlMetaData("statusUpdateDate", SqlDbType.DateTime),
                new SqlMetaData("hireDate", SqlDbType.DateTime),
                new SqlMetaData("terminationDate", SqlDbType.DateTime)
             };
            
            List<SqlDataRecord> records = new List<SqlDataRecord>();

            foreach (SubmissionDetailBHSSalesAssociate itemDetail in detail)
            {
                var record = new SqlDataRecord(tDetail);
                record.SetInt32(0, itemDetail.submitID);
                record.SetString(1, itemDetail.recordType);
                record.SetString(2, itemDetail.affiliateID);
                record.SetString(3, itemDetail.assignedToOffice);
                record.SetString(4, itemDetail.bmsID);
                if (string.IsNullOrEmpty(itemDetail.preaID) == false)
                    record.SetString(5, itemDetail.preaID);
                if (string.IsNullOrEmpty(itemDetail.firstName) == false)
                    record.SetString(6, itemDetail.firstName);
                record.SetString(7, itemDetail.middleInitial);
                record.SetString(8, itemDetail.lastName);
                if (string.IsNullOrEmpty(itemDetail.primaryEmail) == false)
                    record.SetString(9, itemDetail.primaryEmail);
                record.SetString(10, itemDetail.employeeType);
                record.SetString(11, itemDetail.employeeStatus);
                if (string.IsNullOrEmpty(itemDetail.mobilePhone) == false)
                    record.SetString(12, itemDetail.mobilePhone);
                if (string.IsNullOrEmpty(itemDetail.alternateEmail) == false)
                    record.SetString(13, itemDetail.alternateEmail);
                if (itemDetail.statusUpdateDate != null && itemDetail.statusUpdateDate > DateTime.MinValue)
                    record.SetDateTime(14, itemDetail.statusUpdateDate.GetValueOrDefault());
                if (itemDetail.hireDate != null && itemDetail.hireDate > DateTime.MinValue)
                    record.SetDateTime(15, itemDetail.hireDate.GetValueOrDefault());
                if (itemDetail.terminationDate != null && itemDetail.terminationDate > DateTime.MinValue)
                    record.SetDateTime(16, itemDetail.terminationDate.GetValueOrDefault()); 
                records.Add(record);
            }

            return records;
        }

        protected List<SqlDataRecord> mapSalesCustomer(IEnumerable<SubmissionDetailBHSSalesCustomer> detail)
        {
            SqlMetaData[] tDetail =
            {
                new SqlMetaData("submitID", SqlDbType.Int),
                new SqlMetaData("recordType", SqlDbType.VarChar,2),
                new SqlMetaData("officeID", SqlDbType.VarChar,20),
                new SqlMetaData("transType", SqlDbType.VarChar,2),
                new SqlMetaData("transNo", SqlDbType.VarChar,20),
                new SqlMetaData("sequenceNumber", SqlDbType.Int),
                new SqlMetaData("associateID", SqlDbType.VarChar,12),
                new SqlMetaData("preaID", SqlDbType.VarChar,10),
                new SqlMetaData("buyerSellerCode", SqlDbType.VarChar,2),
                new SqlMetaData("firstName", SqlDbType.VarChar,50),
                new SqlMetaData("middleInitial", SqlDbType.VarChar,1),
                new SqlMetaData("lastName", SqlDbType.VarChar,50),
                new SqlMetaData("genderCode", SqlDbType.VarChar,1),
                new SqlMetaData("batchID", SqlDbType.Int)
             };

             List<SqlDataRecord> records = new List<SqlDataRecord>();

            foreach (SubmissionDetailBHSSalesCustomer itemDetail in detail)
            {
                var record = new SqlDataRecord(tDetail);
                record.SetInt32(0, itemDetail.submitID);
                record.SetString(1, itemDetail.recordType);
                if (string.IsNullOrEmpty(itemDetail.officeID) == false)
                    record.SetString(2, itemDetail.officeID);
                record.SetString(3, itemDetail.transType);
                record.SetString(4, itemDetail.transNo);
                record.SetInt32(5, itemDetail.sequenceNumber);
                if (itemDetail.associateID != null)
                    record.SetString(6, itemDetail.associateID);
                if (string.IsNullOrEmpty(itemDetail.preaID) == false)
                    record.SetString(7, itemDetail.preaID);
                record.SetString(8, itemDetail.buyerSellerCode);
                if (string.IsNullOrEmpty(itemDetail.firstName) == false)
                    record.SetString(9, itemDetail.firstName);
                if (itemDetail.middleInitial != null)
                    record.SetString(10, itemDetail.middleInitial);
                record.SetString(11, itemDetail.lastName);
                if (string.IsNullOrEmpty(itemDetail.genderCode) == false)
                    record.SetString(12, itemDetail.genderCode);
                record.SetInt32(13, itemDetail.batchID);
                records.Add(record);
            }

            return records;
        }

        protected List<SqlDataRecord> mapAssociateProduction(IEnumerable<SubmissionDetailBHSAssociateProduction> detail)
        {
            SqlMetaData[] tDetail =
            {
                new SqlMetaData("submitID", SqlDbType.Int),
                new SqlMetaData("recordType", SqlDbType.VarChar,2),
                new SqlMetaData("officeID", SqlDbType.VarChar,20),
                new SqlMetaData("batchID", SqlDbType.Int),
                new SqlMetaData("transType", SqlDbType.VarChar,2),
                new SqlMetaData("transNo", SqlDbType.VarChar,20),
                new SqlMetaData("sequenceNumber", SqlDbType.Int),
                new SqlMetaData("associateID", SqlDbType.VarChar,12),
                new SqlMetaData("preaID", SqlDbType.VarChar,10),
                new SqlMetaData("listSellCode", SqlDbType.VarChar,1),
                new SqlMetaData("assocProductionUnit", SqlDbType.Int),
                new SqlMetaData("assocProductionGCI", SqlDbType.Decimal,18,2),
                new SqlMetaData("currencyCode", SqlDbType.VarChar,10)
             };

             List<SqlDataRecord> records = new List<SqlDataRecord>();

            foreach (SubmissionDetailBHSAssociateProduction itemDetail in detail)
            {
                var record = new SqlDataRecord(tDetail);
                record.SetInt32(0, itemDetail.submitID);
                record.SetString(1, itemDetail.recordType);
                if (string.IsNullOrEmpty(itemDetail.officeID) == false)
                    record.SetString(2, itemDetail.officeID);
                record.SetInt32(3, itemDetail.batchID);
                record.SetString(4, itemDetail.transType);
                record.SetString(5, itemDetail.transNo);
                record.SetInt32(6, itemDetail.sequenceNumber);
                if (itemDetail.associateID != null)
                    record.SetString(7, itemDetail.associateID);               
                if (string.IsNullOrEmpty(itemDetail.preaID) == false)
                    record.SetString(8, itemDetail.preaID);
                record.SetString(9, itemDetail.listSellCode);
                record.SetInt32(10, itemDetail.assocProductionUnit);
                record.SetDecimal(11,itemDetail.assocProductionGCI);
                if (itemDetail.currencyCode != null)
                    record.SetString(12, itemDetail.currencyCode);
                records.Add(record);
            }

            return records;
        }

        protected List<SqlDataRecord> mapMonthlyListings(IEnumerable<SubmissionDetailBHSMonthlyListings> detail)
        {
            SqlMetaData[] tDetail =
            {
                new SqlMetaData("submitID", SqlDbType.Int),
                new SqlMetaData("recordType", SqlDbType.VarChar,2),
                new SqlMetaData("officeID", SqlDbType.VarChar,20),
                new SqlMetaData("batchID", SqlDbType.Int),
                new SqlMetaData("yearMonth", SqlDbType.VarChar,6),
                new SqlMetaData("fullTimeCount", SqlDbType.Int),
                new SqlMetaData("partTimeCount", SqlDbType.Int),
                new SqlMetaData("listingsTaken", SqlDbType.Int),
                new SqlMetaData("listingsInventory", SqlDbType.Int)
             };
            
            List<SqlDataRecord> records = new List<SqlDataRecord>();

            foreach (SubmissionDetailBHSMonthlyListings itemDetail in detail)
            {
                var record = new SqlDataRecord(tDetail);
                record.SetInt32(0, itemDetail.submitID);
                record.SetString(1, itemDetail.recordType);
                if (string.IsNullOrEmpty(itemDetail.officeID) == false)
                    record.SetString(2, itemDetail.officeID);
                record.SetInt32(3, itemDetail.batchID);
                record.SetString(4, itemDetail.yearMonth);
                record.SetInt32(5, itemDetail.fullTimeCount);
                record.SetInt32(6, itemDetail.partTimeCount);
                record.SetInt32(7, itemDetail.listingsTaken);
                record.SetInt32(8, itemDetail.listingsInventory);
                records.Add(record);
            }

            return records;
        }

        protected List<SqlDataRecord> mapTrailer(IEnumerable<SubmissionDetailBHSTrailer> detail)
        {
            SqlMetaData[] tDetail =
            {
                new SqlMetaData("submitID", SqlDbType.Int),
                new SqlMetaData("recordType", SqlDbType.VarChar,2),
                new SqlMetaData("batchID", SqlDbType.Int),          
                new SqlMetaData("affiliateID", SqlDbType.VarChar,100),
                new SqlMetaData("dataRecords", SqlDbType.Int),
                new SqlMetaData("totalGCI", SqlDbType.Decimal,18,2)
             };

            List<SqlDataRecord> records = new List<SqlDataRecord>();

            foreach (SubmissionDetailBHSTrailer itemDetail in detail)
            {
                var record = new SqlDataRecord(tDetail);
                record.SetInt32(0, itemDetail.submitID);
                record.SetString(1, itemDetail.recordType);
                record.SetInt32(2, itemDetail.batchID);      
                record.SetString(3, itemDetail.affiliateID);
                record.SetInt32(4, itemDetail.dataRecords);
                record.SetDecimal(5, itemDetail.totalGCI);
                records.Add(record);
            }

            return records;
        }
    }
}

```
## SubmissionNACHADynamicParameter.cs
```cs
using Dapper;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using System.Data;
using AT.AT2017.Api.Core.Models;
using System.Data.SqlClient;
using Microsoft.SqlServer.Server;

namespace AT.AT2017.Api.DynamicParameters
{
    public class SubmissionNACHADynamicParameter : SqlMapper.IDynamicParameters
    {
        private readonly SubmissionNACHA _submission;

        public SubmissionNACHADynamicParameter(SubmissionNACHA submission)
        {
            _submission = submission;
        }

        void SqlMapper.IDynamicParameters.AddParameters(IDbCommand command, SqlMapper.Identity identity)
        {
            SqlParameter p;
            var sqlCommand = (SqlCommand)command;
            sqlCommand.CommandType = CommandType.StoredProcedure;


            p = sqlCommand.Parameters.Add("@companyID", SqlDbType.Int);
            p.Value = _submission.companyID;
            p = sqlCommand.Parameters.Add("@accountID", SqlDbType.Int);
            p.Value = _submission.accountID;
            p = sqlCommand.Parameters.Add("@startDate", SqlDbType.VarChar, 10);
            p.Value = _submission.startDate.ToString("MM/dd/yyyy");
            p = sqlCommand.Parameters.Add("@endDate", SqlDbType.VarChar, 10);
            p.Value = _submission.endDate.ToString("MM/dd/yyyy");
            p = sqlCommand.Parameters.Add("@processDate", SqlDbType.VarChar, 10);
            p.Value = _submission.processDate.ToString("MM/dd/yyyy");
            p = sqlCommand.Parameters.Add("@email", SqlDbType.VarChar, 100);
            p.Value = _submission.emailAddress;
            p = sqlCommand.Parameters.Add("@urlFile", SqlDbType.VarChar, 500);
            p.Value = _submission.urlFile;
            p = sqlCommand.Parameters.Add("@isBalanced", SqlDbType.Bit);
            p.Value = _submission.isBalanced;

            // submissionDetailNachaTableType
            if (_submission.detail != null && _submission.detail.Count() > 0)
            {
                p = sqlCommand.Parameters.Add("@detail", SqlDbType.Structured);
                p.Direction = ParameterDirection.Input;
                p.TypeName = "submissionDetailNachaTableType";
                p.Value = mapHeaderDetail(_submission.detail);
            }

            // submissionDetailNachaFileHeaderTableType
            if (_submission.fileHeaderDetail != null && _submission.fileHeaderDetail.Count() > 0)
            {
                p = sqlCommand.Parameters.Add("@fileHeader", SqlDbType.Structured);
                p.Direction = ParameterDirection.Input;
                p.TypeName = "submissionDetailNachaFileHeaderTableType";
                p.Value = mapFileHeader(_submission.fileHeaderDetail);
            }

            // submissionDetailNachaBatchHeaderTableType
            if (_submission.batchHeaderDetail != null && _submission.batchHeaderDetail.Count() > 0)
            {
                p = sqlCommand.Parameters.Add("@batchHeader", SqlDbType.Structured);
                p.Direction = ParameterDirection.Input;
                p.TypeName = "submissionDetailNachaBatchHeaderTableType";
                p.Value = mapBatchHeader(_submission.batchHeaderDetail);
            }

            // submissionDetailNachaEntryDetailTableType
            if (_submission.entryDetail != null && _submission.entryDetail.Count() > 0)
            {
                p = sqlCommand.Parameters.Add("@entryDetail", SqlDbType.Structured);
                p.Direction = ParameterDirection.Input;
                p.TypeName = "submissionDetailNachaEntryDetailTableType";
                p.Value = mapEntryDetail(_submission.entryDetail);
            }

            // submissionDetailNachaAddendaTableType
            if (_submission.addendaDetail != null && _submission.addendaDetail.Count() > 0)
            {
                p = sqlCommand.Parameters.Add("@addenda", SqlDbType.Structured);
                p.Direction = ParameterDirection.Input;
                p.TypeName = "submissionDetailNachaAddendaTableType";
                p.Value = mapAddenda(_submission.addendaDetail);
            }

            // submissionDetailNachaBatchControlTableType
            if (_submission.batchControlDetail != null && _submission.batchControlDetail.Count() > 0)
            {
                p = sqlCommand.Parameters.Add("@batchControl", SqlDbType.Structured);
                p.Direction = ParameterDirection.Input;
                p.TypeName = "submissionDetailNachaBatchControlTableType";
                p.Value = mapBatchControl(_submission.batchControlDetail);
            }

            // submissionDetailNachaFileControlTableType
            if (_submission.fileControlDetail != null && _submission.fileControlDetail.Count() > 0)
            {
                p = sqlCommand.Parameters.Add("@fileControl", SqlDbType.Structured);
                p.Direction = ParameterDirection.Input;
                p.TypeName = "submissionDetailNachaFileControlTableType";
                p.Value = mapFileControl(_submission.fileControlDetail);
            }
        }

        protected List<SqlDataRecord> mapHeaderDetail(IEnumerable<SubmissionNachaDetail> detail)
        {
            SqlMetaData[] tDetail =
            {
                new SqlMetaData("submitID", SqlDbType.Int),
                new SqlMetaData("docType", SqlDbType.VarChar,10),
                new SqlMetaData("docID", SqlDbType.Int),
                new SqlMetaData("total",  SqlDbType.Decimal,18,2),
                new SqlMetaData("personID", SqlDbType.Int),
                new SqlMetaData("personName", SqlDbType.VarChar,304),
                new SqlMetaData("propertyID", SqlDbType.Int),
                new SqlMetaData("propertyAddress", SqlDbType.VarChar,1000),
                new SqlMetaData("accountID", SqlDbType.Int),
                new SqlMetaData("bankDate", SqlDbType.DateTime),               
                new SqlMetaData("routingNumber", SqlDbType.VarChar,50),
                new SqlMetaData("bankAccountNumber", SqlDbType.VarChar,50),
                new SqlMetaData("isOffset", SqlDbType.Bit)
             };

            List<SqlDataRecord> records = new List<SqlDataRecord>();

            foreach (SubmissionNachaDetail itemDetail in detail)
            {
                var record = new SqlDataRecord(tDetail);
                record.SetInt32(0, itemDetail.submitID);
                record.SetString(1, itemDetail.docType);
                record.SetInt32(2, itemDetail.docID);
                record.SetDecimal(3, itemDetail.total);
                if (itemDetail.personID > 0)
                {
                    record.SetInt32(4, itemDetail.personID);
                    record.SetString(5, itemDetail.personName);
                }               
                if ( itemDetail.propertyID>0)
                {
                    record.SetInt32(6, itemDetail.propertyID);
                    record.SetString(7, itemDetail.propertyAddress);
                }                  
                record.SetInt32(8, itemDetail.accountID);
                if (itemDetail.bankDate != null && itemDetail.bankDate > DateTime.MinValue)
                    record.SetDateTime(9, itemDetail.bankDate);
                if (itemDetail.routingNumber != null) record.SetString(10, itemDetail.routingNumber);
                if (itemDetail.bankAccountNumber != null) record.SetString(11, itemDetail.bankAccountNumber);
                record.SetBoolean(12, itemDetail.isOffset);

                records.Add(record);
            }

            return records;
        }

        protected List<SqlDataRecord> mapFileHeader(IEnumerable<SubmissionNachaFileHeader> detail)
        {
            SqlMetaData[] tDetail =
            {
                new SqlMetaData("submitID", SqlDbType.Int),
                new SqlMetaData("recordTypeCode", SqlDbType.VarChar,1),
                new SqlMetaData("priorityCode",SqlDbType.VarChar,2),
                new SqlMetaData("immediateDestination",  SqlDbType.VarChar,10),
                new SqlMetaData("immediateOrigin", SqlDbType.VarChar,10),
                new SqlMetaData("fileCreationDate", SqlDbType.VarChar,6),
                new SqlMetaData("fileCreationTime", SqlDbType.VarChar,4),
                new SqlMetaData("fileIdModifier", SqlDbType.VarChar,1),
                new SqlMetaData("recordSize", SqlDbType.VarChar,3),
                new SqlMetaData("blockingFactor", SqlDbType.VarChar,2),
                new SqlMetaData("formatCode", SqlDbType.VarChar,1),
                new SqlMetaData("immediateDestinationName", SqlDbType.VarChar,23),
                new SqlMetaData("immediateOriginName", SqlDbType.VarChar,23),
                new SqlMetaData("referenceCode", SqlDbType.VarChar,8)
             };

            List<SqlDataRecord> records = new List<SqlDataRecord>();

            foreach (SubmissionNachaFileHeader itemDetail in detail)
            {
                var record = new SqlDataRecord(tDetail);
                record.SetInt32(0, itemDetail.submitID);
                record.SetString(1, itemDetail.recordTypeCode);
                record.SetString(2, itemDetail.priorityCode);
                record.SetString(3, itemDetail.immediateDestination);
                record.SetString(4, itemDetail.immediateOrigin);
                record.SetString(5, itemDetail.fileCreationDate);
                record.SetString(6, itemDetail.fileCreationTime);
                record.SetString(7, itemDetail.fileIdModifier);
                record.SetString(8, itemDetail.recordSize);               
                record.SetString(9, itemDetail.blockingFactor);
                record.SetString(10, itemDetail.formatCode);
                record.SetString(11, itemDetail.immediateDestinationName);
                record.SetString(12, itemDetail.immediateOriginName);
                record.SetString(13, itemDetail.referenceCode);

                records.Add(record);
            }

            return records;
        }

        protected List<SqlDataRecord> mapBatchHeader(IEnumerable<SubmissionNachaBatchHeader> detail)
        {
            SqlMetaData[] tDetail =
            {
                new SqlMetaData("submitID", SqlDbType.Int),
                new SqlMetaData("recordTypeCode", SqlDbType.VarChar,1),
                new SqlMetaData("serviceClassCode",SqlDbType.VarChar,3),
                new SqlMetaData("companyName",  SqlDbType.VarChar,16),
                new SqlMetaData("companyDiscretionaryData", SqlDbType.VarChar,20),
                new SqlMetaData("companyIdentification", SqlDbType.VarChar,10),
                new SqlMetaData("standardEntryClassCode", SqlDbType.VarChar,3),
                new SqlMetaData("companyEntryDescription", SqlDbType.VarChar,10),
                new SqlMetaData("companyDescriptiveDate", SqlDbType.VarChar,6),
                new SqlMetaData("effectiveEntryDate", SqlDbType.VarChar,6),
                new SqlMetaData("settlementDate", SqlDbType.VarChar,3),
                new SqlMetaData("originatorStatusCode", SqlDbType.VarChar,1),
                new SqlMetaData("originatingDfiIdentification", SqlDbType.VarChar,8),
                new SqlMetaData("batchNumber", SqlDbType.VarChar,7)
             };

            List<SqlDataRecord> records = new List<SqlDataRecord>();

            foreach (SubmissionNachaBatchHeader itemDetail in detail)
            {
                var record = new SqlDataRecord(tDetail);
                record.SetInt32(0, itemDetail.submitID);
                record.SetString(1, itemDetail.recordTypeCode);
                record.SetString(2, itemDetail.serviceClassCode);
                record.SetString(3, itemDetail.companyName);
                record.SetString(4, itemDetail.companyDiscretionaryData);
                record.SetString(5, itemDetail.companyIdentification);
                record.SetString(6, itemDetail.standardEntryClassCode);
                record.SetString(7, itemDetail.companyEntryDescription);
                record.SetString(8, itemDetail.companyDescriptiveDate);
                record.SetString(9, itemDetail.effectiveEntryDate);
                record.SetString(10, itemDetail.settlementDate);
                record.SetString(11, itemDetail.originatorStatusCode);
                record.SetString(12, itemDetail.originatingDfiIdentification);
                record.SetString(13, itemDetail.batchNumber);

                records.Add(record);
            }

            return records;
        }

        protected List<SqlDataRecord> mapEntryDetail(IEnumerable<SubmissionNachaEntryDetail> detail)
        {
            SqlMetaData[] tDetail =
            {
                new SqlMetaData("submitID", SqlDbType.Int),
                new SqlMetaData("recordTypeCode", SqlDbType.VarChar,1),
                new SqlMetaData("transactionCode",SqlDbType.VarChar,2),
                new SqlMetaData("receivingDfiIdentification",  SqlDbType.VarChar,8),
                new SqlMetaData("checkDigit", SqlDbType.VarChar,1),
                new SqlMetaData("dfiAccountNumber", SqlDbType.VarChar,17),
                new SqlMetaData("amount", SqlDbType.VarChar,10),
                new SqlMetaData("identificationNumber", SqlDbType.VarChar,15),
                new SqlMetaData("individualName", SqlDbType.VarChar,22),
                new SqlMetaData("discretionaryData", SqlDbType.VarChar,2),
                new SqlMetaData("addendaRecordIndicator", SqlDbType.VarChar,1),
                new SqlMetaData("traceNumber", SqlDbType.VarChar,15)
             };

            List<SqlDataRecord> records = new List<SqlDataRecord>();

            foreach (SubmissionNachaEntryDetail itemDetail in detail)
            {
                var record = new SqlDataRecord(tDetail);
                record.SetInt32(0, itemDetail.submitID);
                record.SetString(1, itemDetail.recordTypeCode);
                record.SetString(2, itemDetail.transactionCode);
                record.SetString(3, itemDetail.receivingDfiIdentification);
                record.SetString(4, itemDetail.checkDigit);
                record.SetString(5, itemDetail.dfiAccountNumber);
                record.SetString(6, itemDetail.amount);
                record.SetString(7, itemDetail.identificationNumber);
                record.SetString(8, itemDetail.individualName);
                record.SetString(9, itemDetail.discretionaryData);
                record.SetString(10, itemDetail.addendaRecordIndicator);
                record.SetString(11, itemDetail.traceNumber);

                records.Add(record);
            }

            return records;
        }

        protected List<SqlDataRecord> mapAddenda(IEnumerable<SubmissionNachaAddenda> detail)
        {
            SqlMetaData[] tDetail =
            {
                new SqlMetaData("submitID", SqlDbType.Int),
                new SqlMetaData("recordTypeCode", SqlDbType.VarChar,1),
                new SqlMetaData("addendaTypeCode",SqlDbType.VarChar,2),
                new SqlMetaData("paymentRelatedInformation",  SqlDbType.VarChar,80),
                new SqlMetaData("addendaSequenceNumber", SqlDbType.VarChar,4),
                new SqlMetaData("entryDetailSequenceNumber", SqlDbType.VarChar,7)
             };

            List<SqlDataRecord> records = new List<SqlDataRecord>();

            foreach (SubmissionNachaAddenda itemDetail in detail)
            {
                var record = new SqlDataRecord(tDetail);
                record.SetInt32(0, itemDetail.submitID);
                record.SetString(1, itemDetail.recordTypeCode);
                record.SetString(2, itemDetail.addendaTypeCode);
                record.SetString(3, itemDetail.paymentRelatedInformation);
                record.SetString(4, itemDetail.addendaSequenceNumber);
                record.SetString(5, itemDetail.entryDetailSequenceNumber);

                records.Add(record);
            }

            return records;
        }

        protected List<SqlDataRecord> mapBatchControl(IEnumerable<SubmissionNachaBatchControl> detail)
        {
            SqlMetaData[] tDetail =
            {
                new SqlMetaData("submitID", SqlDbType.Int),
                new SqlMetaData("recordTypeCode", SqlDbType.VarChar,1),
                new SqlMetaData("serviceClassCode",SqlDbType.VarChar,3),
                new SqlMetaData("addendaCount",  SqlDbType.VarChar,6),
                new SqlMetaData("entryHash", SqlDbType.VarChar,10),
                new SqlMetaData("totalDebitDollarAmount", SqlDbType.VarChar,12),
                new SqlMetaData("totalCreditDollarAmount", SqlDbType.VarChar,12),
                new SqlMetaData("companyIdentification", SqlDbType.VarChar,10),
                new SqlMetaData("messageAuthenticationCode", SqlDbType.VarChar,19),
                new SqlMetaData("reserved", SqlDbType.VarChar,6),
                new SqlMetaData("originatingDfiIdentification", SqlDbType.VarChar,8),
                new SqlMetaData("batchNumber", SqlDbType.VarChar,7)
             };

            List<SqlDataRecord> records = new List<SqlDataRecord>();

            foreach (SubmissionNachaBatchControl itemDetail in detail)
            {
                var record = new SqlDataRecord(tDetail);
                record.SetInt32(0, itemDetail.submitID);
                record.SetString(1, itemDetail.recordTypeCode);
                record.SetString(2, itemDetail.serviceClassCode);
                record.SetString(3, itemDetail.addendaCount);
                record.SetString(4, itemDetail.entryHash);
                record.SetString(5, itemDetail.totalDebitDollarAmount);
                record.SetString(6, itemDetail.totalCreditDollarAmount);
                record.SetString(7, itemDetail.companyIdentification);
                record.SetString(8, itemDetail.messageAuthenticationCode);
                record.SetString(9, itemDetail.reserved);
                record.SetString(10, itemDetail.originatingDfiIdentification);
                record.SetString(11, itemDetail.batchNumber);

                records.Add(record);
            }

            return records;
        }

        protected List<SqlDataRecord> mapFileControl(IEnumerable<SubmissionNachaFileControl> detail)
        {
            SqlMetaData[] tDetail =
            {
                new SqlMetaData("submitID", SqlDbType.Int),
                new SqlMetaData("recordTypeCode", SqlDbType.VarChar,1),
                new SqlMetaData("batchCount",SqlDbType.VarChar,6),
                new SqlMetaData("blockCount",  SqlDbType.VarChar,6),
                new SqlMetaData("entryAddendaCount", SqlDbType.VarChar,8),
                new SqlMetaData("entryHash", SqlDbType.VarChar,10),
                new SqlMetaData("totalDebitDollarAmount", SqlDbType.VarChar,12),
                new SqlMetaData("totalCreditDollarAmount", SqlDbType.VarChar,12),      
                new SqlMetaData("reserved", SqlDbType.VarChar,39)
             };

            List<SqlDataRecord> records = new List<SqlDataRecord>();

            foreach (SubmissionNachaFileControl itemDetail in detail)
            {
                var record = new SqlDataRecord(tDetail);
                record.SetInt32(0, itemDetail.submitID);
                record.SetString(1, itemDetail.recordTypeCode);
                record.SetString(2, itemDetail.batchCount);
                record.SetString(3, itemDetail.blockCount);
                record.SetString(4, itemDetail.entryAddendaCount);
                record.SetString(5, itemDetail.entryHash);
                record.SetString(6, itemDetail.totalDebitDollarAmount);
                record.SetString(7, itemDetail.totalCreditDollarAmount);          
                record.SetString(8, itemDetail.reserved);
                records.Add(record);
            }

            return records;
        }     
    }
}

```
## UserDynamicParameter.cs
```cs
using Dapper;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using System.Data;
using AT.AT2017.Api.Core.Models;
using System.Data.SqlClient;
using Microsoft.SqlServer.Server;

namespace AT.AT2017.Api.DynamicParameters
{
    public class UserDynamicParameter : SqlMapper.IDynamicParameters
    {
        private readonly User _user;

        public UserDynamicParameter(User user)
        {
            _user = user;
        }

        void SqlMapper.IDynamicParameters.AddParameters(IDbCommand command, SqlMapper.Identity identity)
        {
            SqlParameter p;
            var sqlCommand = (SqlCommand)command;
            sqlCommand.CommandType = CommandType.StoredProcedure;

            p = sqlCommand.Parameters.Add("@userId", SqlDbType.Int);
            p.Value = _user.userId;
            p = sqlCommand.Parameters.Add("@firstName", SqlDbType.VarChar);
            p.Value = _user.firstName;
            p = sqlCommand.Parameters.Add("@lastName", SqlDbType.VarChar);
            p.Value = _user.lastName;
            p = sqlCommand.Parameters.Add("@agentId", SqlDbType.Int);
            p.Value = DBNull.Value;
            if (_user.agentId != null)
            {
                p.Value = _user.agentId;

            }
            p = sqlCommand.Parameters.Add("@userName", SqlDbType.VarChar);
            p.Value = _user.userName;
            p = sqlCommand.Parameters.Add("@email", SqlDbType.VarChar);
            p.Value = DBNull.Value;
            if (_user.email != null)
            {
                p.Value = _user.email;

            }           
            p = sqlCommand.Parameters.Add("@modifyBy", SqlDbType.VarChar);
            p.Value = _user.modifyBy;
            p = sqlCommand.Parameters.Add("@locked", SqlDbType.Bit);
            p.Value = _user.locked;
            p = sqlCommand.Parameters.Add("@lockedDate", SqlDbType.DateTime);
            p.Value = DBNull.Value;
            if (_user.lockedDate != null)
            {
                p.Value = _user.lockedDate;

            }

            p = sqlCommand.Parameters.Add("@notifyOnPropertyMsg", SqlDbType.Bit);
            p.Value = _user.NotifyPropertyMsg;
            p = sqlCommand.Parameters.Add("@notifyOnContactMsg", SqlDbType.Bit);
            p.Value = _user.NotifyContactMsg;
            p = sqlCommand.Parameters.Add("@notifyOnPropertyDoc", SqlDbType.Bit);
            p.Value = _user.NotifyPropertyDoc;
            p = sqlCommand.Parameters.Add("@notifyOnContactDoc", SqlDbType.Bit);
            p.Value = _user.NotifyContactDoc;

            // userRoles
            p = sqlCommand.Parameters.Add("@userRoles", SqlDbType.Structured);
            p.Direction = ParameterDirection.Input;
            p.TypeName = "userRoleTableType";
            List<UserRole> userRoles = (List<UserRole>)_user.userRoles;
            if (userRoles.Count > 0)
            {
                p.Value = mapUserRoles(_user.userRoles);
            }
            else
            {
                p.Value = null;
            }

            // userCompanies
            p = sqlCommand.Parameters.Add("@userCompanies", SqlDbType.Structured);
            p.Direction = ParameterDirection.Input;
            p.TypeName = "userCompanyTableType";
            List<UserCompany> userCompanies = (List<UserCompany>)_user.userCompanies;
            if (userCompanies.Count > 0)
            {
                p.Value = mapUserCompanies(_user.userCompanies);
            }
            else
            {
                p.Value = null;
            }

            // userOffices
            p = sqlCommand.Parameters.Add("@userOffices", SqlDbType.Structured);
            p.Direction = ParameterDirection.Input;
            p.TypeName = "userOfficeTableType";
            List<UserOffice> userOffices = (List<UserOffice>)_user.userOffices;
            if (userOffices.Count > 0)
            {
                p.Value = mapUserOffices(_user.userOffices);
            }
            else
            {
                p.Value = null;
            }

            // userGLAccounts
            p = sqlCommand.Parameters.Add("@userGLAccounts", SqlDbType.Structured);
            p.Direction = ParameterDirection.Input;
            p.TypeName = "userGLAccountTableType";
            List<UserGLAccount> userGLAccounts = (List<UserGLAccount>)_user.userGLAccounts;
            if (userGLAccounts.Count > 0)
            {
                p.Value = mapUserGLAccounts(_user.userGLAccounts);
            }
            else
            {
                p.Value = null;
            }

            // userVoucherTypes
            p = sqlCommand.Parameters.Add("@userVoucherTypes", SqlDbType.Structured);
            p.Direction = ParameterDirection.Input;
            p.TypeName = "userVoucherTypeTableType";
            List<UserVoucherType> userVoucherTypes = (List<UserVoucherType>)_user.userVoucherTypes;
            if (userVoucherTypes.Count > 0)
            {
                p.Value = mapUserVoucherTypes(_user.userVoucherTypes);
            }
            else
            {
                p.Value = null;
            }

        }

        protected List<SqlDataRecord> mapUserRoles(IEnumerable<UserRole> userRoles)
        {
            SqlMetaData[] tvp =
            {
                new SqlMetaData("userRoleId", SqlDbType.Int),
                new SqlMetaData("userId", SqlDbType.Int),
                new SqlMetaData("roleId", SqlDbType.Int),
            };

            List<SqlDataRecord> list = new List<SqlDataRecord>();

            foreach (UserRole userRole in userRoles)
            {
                var record = new SqlDataRecord(tvp);
                record.SetInt32(0, userRole.userRoleId);
                record.SetInt32(1, userRole.userId);
                record.SetInt32(2, userRole.roleId);
                list.Add(record);
            }

            return list;
        }

        protected List<SqlDataRecord> mapUserCompanies(IEnumerable<UserCompany> userCompanies)
        {
            SqlMetaData[] tvp =
            {
                new SqlMetaData("userCompanyId", SqlDbType.Int),
                new SqlMetaData("userId", SqlDbType.Int),
                new SqlMetaData("companyId", SqlDbType.Int),
            };

            List<SqlDataRecord> list = new List<SqlDataRecord>();

            foreach (UserCompany userCompany in userCompanies)
            {
                var record = new SqlDataRecord(tvp);
                record.SetInt32(0, userCompany.userCompanyId);
                record.SetInt32(1, userCompany.userId);
                record.SetInt32(2, userCompany.companyId);
                list.Add(record);
            }

            return list;
        }

        protected List<SqlDataRecord> mapUserOffices(IEnumerable<UserOffice> userOffices)
        {
            SqlMetaData[] tvp =
            {
                new SqlMetaData("userOfficeId", SqlDbType.Int),
                new SqlMetaData("userId", SqlDbType.Int),
                new SqlMetaData("officeId", SqlDbType.Int),
            };

            List<SqlDataRecord> list = new List<SqlDataRecord>();

            foreach (UserOffice userOffice in userOffices)
            {
                var record = new SqlDataRecord(tvp);
                record.SetInt32(0, userOffice.userOfficeId);
                record.SetInt32(1, userOffice.userId);
                record.SetInt32(2, userOffice.officeId);
                list.Add(record);
            }

            return list;
        }

        protected List<SqlDataRecord> mapUserGLAccounts(IEnumerable<UserGLAccount> userGLAccounts)
        {
            SqlMetaData[] tvp =
            {
                new SqlMetaData("userGLAccountId", SqlDbType.Int),
                new SqlMetaData("userId", SqlDbType.Int),
                new SqlMetaData("accountId", SqlDbType.Int),
            };

            List<SqlDataRecord> list = new List<SqlDataRecord>();

            foreach (UserGLAccount userGLAccount in userGLAccounts)
            {
                var record = new SqlDataRecord(tvp);
                record.SetInt32(0, userGLAccount.userGLAccountId);
                record.SetInt32(1, userGLAccount.userId);
                record.SetInt32(2, userGLAccount.accountId);
                list.Add(record);
            }

            return list;
        }

        protected List<SqlDataRecord> mapUserVoucherTypes(IEnumerable<UserVoucherType> userVoucherTypes)
        {
            SqlMetaData[] tvp =
            {
                new SqlMetaData("userVoucherTypeId", SqlDbType.Int),
                new SqlMetaData("userId", SqlDbType.Int),
                new SqlMetaData("voucherTypeId", SqlDbType.Int),
            };

            List<SqlDataRecord> list = new List<SqlDataRecord>();

            foreach (UserVoucherType userVoucherType in userVoucherTypes)
            {
                var record = new SqlDataRecord(tvp);
                record.SetInt32(0, userVoucherType.userVoucherTypeId);
                record.SetInt32(1, userVoucherType.userId);
                record.SetInt32(2, userVoucherType.voucherTypeId);
                list.Add(record);
            }

            return list;
        }

    }

}


```
## VoucherDynamicParameter.cs
```cs
using Dapper;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using System.Data;
using AT.AT2017.Api.Core.Models;
using System.Data.SqlClient;
using Microsoft.SqlServer.Server;

namespace AT.AT2017.Api.DynamicParameters
{
    public class VoucherDynamicParameter : SqlMapper.IDynamicParameters
    {
        private readonly Voucher _voucher;

        public VoucherDynamicParameter(Voucher voucher)
        {
            _voucher = voucher;
        }

        void SqlMapper.IDynamicParameters.AddParameters(IDbCommand command, SqlMapper.Identity identity)
        {
            SqlParameter p;
            var sqlCommand = (SqlCommand)command;
            sqlCommand.CommandType = CommandType.StoredProcedure;

            p = sqlCommand.Parameters.Add("@companyId", SqlDbType.Int);
            p.Value = _voucher.companyId;
            p = sqlCommand.Parameters.Add("@voucherId", SqlDbType.Int);
            p.Value = _voucher.voucherId;
            p = sqlCommand.Parameters.Add("@personId", SqlDbType.Int);
            p.Value = _voucher.personId;
            p = sqlCommand.Parameters.Add("@orderDate", SqlDbType.DateTime);
            p.Value = _voucher.orderDate;
            p = sqlCommand.Parameters.Add("@orderTypeId", SqlDbType.Int);
            p.Value = _voucher.orderTypeId;
            p = sqlCommand.Parameters.Add("@termId", SqlDbType.Int);
            p.Value = _voucher.termId;
            p = sqlCommand.Parameters.Add("@originalAPPaymentId", SqlDbType.Int);
            p.Value = _voucher.originalAPPaymentId;
            p = sqlCommand.Parameters.Add("@propertyId", SqlDbType.Int);
            p.Value = _voucher.propertyId;
            p = sqlCommand.Parameters.Add("@poNumber", SqlDbType.VarChar,50);
            p.Value = _voucher.poNumber;
            p = sqlCommand.Parameters.Add("@flag1099", SqlDbType.Int);            
            p.Value = _voucher.flag1099;           
            p = sqlCommand.Parameters.Add("@checkMemo", SqlDbType.VarChar, 4000);
            p.Value = _voucher.checkMemo;
            p = sqlCommand.Parameters.Add("@isTemplate", SqlDbType.Bit);
            p.Value = _voucher.isTemplate;
            p = sqlCommand.Parameters.Add("@templateName", SqlDbType.VarChar, 100);
            p.Value = _voucher.templateName;
            p = sqlCommand.Parameters.Add("@taxFlat", SqlDbType.Bit);
            p.Value = _voucher.taxFlat;

            p = sqlCommand.Parameters.Add("@alt1099PersonID", SqlDbType.Int);
            if (_voucher.alt1099PersonId.GetValueOrDefault() > 0)
            {
                p.Value = _voucher.alt1099PersonId.GetValueOrDefault();
            }

            p = sqlCommand.Parameters.Add("@dueDate", SqlDbType.DateTime);
            p.Value = _voucher.dueDate;

            p = sqlCommand.Parameters.Add("@paymentMethodID", SqlDbType.Int);           
            if (_voucher.paymentMethodID.GetValueOrDefault() > 0)
            {
                p.Value = _voucher.paymentMethodID.GetValueOrDefault();
            }

            // detail
            p = sqlCommand.Parameters.Add("@detail", SqlDbType.Structured);
            p.Direction = ParameterDirection.Input;
            p.TypeName = "voucherDetailTableType";
            p.Value = mapVoucherDetail(_voucher.detail);
        }


        protected List<SqlDataRecord> mapVoucherDetail(IEnumerable<VoucherDetail> detail)
        {
            SqlMetaData[] tvpVoucherDetail =
            {
                new SqlMetaData("voucherDetailId", SqlDbType.Int),
                new SqlMetaData("voucherId", SqlDbType.Int),
                new SqlMetaData("salesPrice", SqlDbType.Decimal,18,2),
                new SqlMetaData("description", SqlDbType.NVarChar, 1000),
                new SqlMetaData("accountId", SqlDbType.Int),
                new SqlMetaData("jobId", SqlDbType.Int),
                new SqlMetaData("divisionId", SqlDbType.Int),
                new SqlMetaData("locked", SqlDbType.Bit),
                new SqlMetaData("deductType", SqlDbType.NVarChar, 50),
                new SqlMetaData("side", SqlDbType.NVarChar, 10),
                new SqlMetaData("columnNumber", SqlDbType.Int),
                new SqlMetaData("propertyId", SqlDbType.Int),
                new SqlMetaData("otherCompanyJobID", SqlDbType.Int),
                new SqlMetaData("isTax", SqlDbType.Bit),
                new SqlMetaData("isTaxExempt", SqlDbType.Bit)
            };

            List<SqlDataRecord> records = new List<SqlDataRecord>();

            foreach (VoucherDetail itemDetail in detail)
            {
                var record = new SqlDataRecord(tvpVoucherDetail);

                record.SetInt32(0, itemDetail.voucherDetailId);
                record.SetInt32(1, itemDetail.voucherId);
                record.SetDecimal(2, itemDetail.salesPrice);
                if (!string.IsNullOrEmpty(itemDetail.description)) {
                    record.SetString(3, itemDetail.description);
                }
                record.SetInt32(4, itemDetail.accountId.GetValueOrDefault());
                record.SetInt32(5, itemDetail.jobId.GetValueOrDefault());
                if (itemDetail.divisionId > 0)
                {
                    record.SetInt32(6, itemDetail.divisionId.GetValueOrDefault());
                }
                record.SetSqlBoolean(7, itemDetail.locked.GetValueOrDefault());
                if (!string.IsNullOrWhiteSpace(itemDetail.deductType)){
                    record.SetString(8, itemDetail.deductType);
                }
                if (!string.IsNullOrWhiteSpace(itemDetail.side)){
                    record.SetString(9, itemDetail.side);
                }
                if (itemDetail.columnNumber > 0)
                {
                    record.SetInt32(10, itemDetail.columnNumber.GetValueOrDefault());
                }
                if (itemDetail.propertyId != null)
                {
                    record.SetInt32(11, itemDetail.propertyId.GetValueOrDefault());
                }
                if (itemDetail.otherCompanyJobID != null)
                {
                    record.SetInt32(12, itemDetail.otherCompanyJobID.GetValueOrDefault());
                }
                    record.SetSqlBoolean(13, itemDetail.isTax);
                    record.SetSqlBoolean(14, itemDetail.isTaxExempt);
                // add record
                records.Add(record);

            }

            return records;
        }
    }
}

```
## VoucherPayDynamicParameter.cs
```cs
using Dapper;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using System.Data;
using AT.AT2017.Api.Core.Models;
using System.Data.SqlClient;
using Microsoft.SqlServer.Server;

namespace AT.AT2017.Api.DynamicParameters
{
    public class VoucherPayDynamicParameter : SqlMapper.IDynamicParameters
    {
        private readonly VoucherPay _voucher;

        public VoucherPayDynamicParameter(VoucherPay voucher)
        {
            _voucher = voucher;
        }

        void SqlMapper.IDynamicParameters.AddParameters(IDbCommand command, SqlMapper.Identity identity)
        {
            SqlParameter p;
            var sqlCommand = (SqlCommand)command;
            sqlCommand.CommandType = CommandType.StoredProcedure;

            p = sqlCommand.Parameters.Add("@voucherId", SqlDbType.Int);
            p.Value = _voucher.voucherId;
            p = sqlCommand.Parameters.Add("@paymentDate", SqlDbType.DateTime);
            p.Value = _voucher.paymentDate;
            p = sqlCommand.Parameters.Add("@bankAccountId", SqlDbType.Int);
            p.Value = _voucher.bankAccountId;
            p = sqlCommand.Parameters.Add("@checkTemplateId", SqlDbType.Int);
            if (_voucher.checkTemplateId != null )
            {
                p.Value = _voucher.checkTemplateId;
            }
            p = sqlCommand.Parameters.Add("@paymentAmount", SqlDbType.Decimal);
            p.Value = _voucher.paymentAmount;
            p = sqlCommand.Parameters.Add("@description", SqlDbType.VarChar);
            p.Value = _voucher.description;
            p = sqlCommand.Parameters.Add("@checkNumber", SqlDbType.VarChar);
            p.Value = _voucher.checkNumber;
        }
       
    }
}

```
## AgentAssignmentDynamicParameter.cs
```cs
using Dapper;
using System;
using System.Collections.Generic;
using System.Data;
using AT.AT2017.Api.Core.Models.agentBooks;
using System.Data.SqlClient;
using Microsoft.SqlServer.Server;

namespace AT.AT2017.Api.DynamicParameters
{
    public class AgentAssignmentDynamicParameter : SqlMapper.IDynamicParameters
    {
        private readonly AgentAssignments _agentsAssignments;

        public AgentAssignmentDynamicParameter(AgentAssignments agentsAssignments)
        {
            _agentsAssignments = agentsAssignments;
        }

        void SqlMapper.IDynamicParameters.AddParameters(IDbCommand command, SqlMapper.Identity identity)
        {
            SqlParameter p;
            var sqlCommand = (SqlCommand)command;
            sqlCommand.CommandType = CommandType.StoredProcedure;
            p = sqlCommand.Parameters.Add("@userId", SqlDbType.Int);
            p.Value = _agentsAssignments.userId;
            // detail
            p = sqlCommand.Parameters.Add("@agents", SqlDbType.Structured);
            p.Direction = ParameterDirection.Input;
            p.TypeName = "agentTableType";
            p.Value = mapagents(_agentsAssignments.detail);
        }

        protected List<SqlDataRecord> mapagents(IEnumerable<AgentAssignmentsDarwin> agents)
        {
            SqlMetaData[] tvp =
            {
                new SqlMetaData("agentID", SqlDbType.Int),
                new SqlMetaData("databaseID", SqlDbType.Int),
                new SqlMetaData("personID", SqlDbType.Int),
                new SqlMetaData("firstName", SqlDbType.NVarChar, 500),
                new SqlMetaData("lastName", SqlDbType.NVarChar, 500),
                new SqlMetaData("fullName", SqlDbType.NVarChar, 500),
                new SqlMetaData("emailAddress", SqlDbType.NVarChar, 500),
                new SqlMetaData("mobilePhoneNumber", SqlDbType.NVarChar, 500),
    };

            List<SqlDataRecord> list = new List<SqlDataRecord>();

            foreach (AgentAssignmentsDarwin agent in agents)
            {
                var record = new SqlDataRecord(tvp);
                record.SetInt32(0, agent.agentId);
                record.SetInt32(1, agent.databaseId);
                record.SetInt32(2, agent.personId);
                if (agent.firstName != null)
                    record.SetString(3, agent.firstName);
                if (agent.lastName != null)
                    record.SetString(4, agent.lastName);
                if (agent.personName != null)
                    record.SetString(5, agent.personName);
                if (agent.emailAddress != null)
                    record.SetString(6, agent.emailAddress);
                if (agent.mobilePhoneNumber != null)
                    record.SetString(7, agent.mobilePhoneNumber);
                list.Add(record);
            }

            return list;
        }

    }
}

```
## AgentCategoryDynamicParameter.cs
```cs
using Dapper;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using System.Data;
using AT.AT2017.Api.Core.Models.agentBooks;
using System.Data.SqlClient;
using Microsoft.SqlServer.Server;

namespace AT.AT2017.Api.DynamicParameters
{
    public class AgentCategoryDynamicParameter : SqlMapper.IDynamicParameters
    {
        private readonly IEnumerable<AgentCategory> _agentCategories;
        private readonly int _agentID;

        public AgentCategoryDynamicParameter(IEnumerable<AgentCategory> agentCategories, int agentID)
        {
            _agentCategories = agentCategories;
            _agentID = agentID;
        }

        void SqlMapper.IDynamicParameters.AddParameters(IDbCommand command, SqlMapper.Identity identity)
        {
            SqlParameter p;
            var sqlCommand = (SqlCommand)command;
            sqlCommand.CommandType = CommandType.StoredProcedure;

            p = sqlCommand.Parameters.Add("@agentCategories", SqlDbType.Structured);
            p.Direction = ParameterDirection.Input;
            p.TypeName = "agentCategoryTableType";
            List<AgentCategory> agentCategories = (List<AgentCategory>)_agentCategories;
            if (agentCategories.Count > 0)
            {
                p.Value = mapagentCategories(_agentCategories);
            }
            p = sqlCommand.Parameters.Add("@agentID", SqlDbType.Int);
            p.Value = _agentID;
        }


        protected List<SqlDataRecord> mapagentCategories(IEnumerable<AgentCategory> agentCategories)
        {
            SqlMetaData[] tvp =
            {
                new SqlMetaData("agentCategoryID", SqlDbType.Int),
                new SqlMetaData("agentID", SqlDbType.Int),
                new SqlMetaData("name", SqlDbType.NVarChar, 100),
                new SqlMetaData("type", SqlDbType.NVarChar, 100),
                new SqlMetaData("isSystem", SqlDbType.Bit),
                new SqlMetaData("categoryID", SqlDbType.Int),
                new SqlMetaData("createDate", SqlDbType.DateTime),
                new SqlMetaData("createdBy", SqlDbType.NVarChar, 100),
                new SqlMetaData("modifyDate", SqlDbType.DateTime),
                new SqlMetaData("modifyBy", SqlDbType.NVarChar, 100),
                new SqlMetaData("deleteDate", SqlDbType.DateTime),
                new SqlMetaData("deletedBy", SqlDbType.NVarChar, 100),
    };

            List<SqlDataRecord> list = new List<SqlDataRecord>();

            foreach (AgentCategory  agentCategory in agentCategories)
            {
                var record = new SqlDataRecord(tvp);
                record.SetInt32(0, agentCategory.agentCategoryId);
                record.SetInt32(1, agentCategory.agentId);
                record.SetString(2, agentCategory.name);
                record.SetString(3, agentCategory.type);
                record.SetBoolean(4, agentCategory.isSystem);
                record.SetInt32(5, agentCategory.categoryId);
                if (agentCategory.deleteDate != null)
                    record.SetDateTime(10, Convert.ToDateTime(agentCategory.deleteDate));
                if (agentCategory.deletedBy != null)
                    record.SetString(11, agentCategory.deletedBy);
                list.Add(record);
            }

            return list;
        }

    }
}

```
## MasterCategoryDynamicParameter.cs
```cs
using Dapper;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using System.Data;
using AT.AT2017.Api.Core.Models.agentBooks;
using System.Data.SqlClient;
using Microsoft.SqlServer.Server;

namespace AT.AT2017.Api.DynamicParameters
{
    public class MasterCategoryDynamicParameter : SqlMapper.IDynamicParameters
    {
        private readonly IEnumerable<MasterCategory> _masterCategories;

        public MasterCategoryDynamicParameter(IEnumerable<MasterCategory> masterCategories)
        {
            _masterCategories = masterCategories;
        }

        void SqlMapper.IDynamicParameters.AddParameters(IDbCommand command, SqlMapper.Identity identity)
        {
            SqlParameter p;
            var sqlCommand = (SqlCommand)command;
            sqlCommand.CommandType = CommandType.StoredProcedure;

            p = sqlCommand.Parameters.Add("@masterCategories", SqlDbType.Structured);
            p.Direction = ParameterDirection.Input;
            p.TypeName = "masterCategoryTableType";
            List<MasterCategory> masterCategories = (List<MasterCategory>)_masterCategories;
            if (masterCategories.Count > 0)
            {
                p.Value = mapMasterCategories(_masterCategories);
            }            
        }


        protected List<SqlDataRecord> mapMasterCategories(IEnumerable<MasterCategory> masterCategories)
        {
            SqlMetaData[] tvp =
            {
                new SqlMetaData("masterCategoryId", SqlDbType.Int),
                new SqlMetaData("name", SqlDbType.NVarChar, 100),
                new SqlMetaData("type", SqlDbType.NVarChar, 100),
                new SqlMetaData("isSystem", SqlDbType.Bit),
                new SqlMetaData("createDate", SqlDbType.DateTime),
                new SqlMetaData("createdBy", SqlDbType.NVarChar, 100),
                new SqlMetaData("modifyDate", SqlDbType.DateTime),
                new SqlMetaData("modifyBy", SqlDbType.NVarChar, 100),
                new SqlMetaData("deleteDate", SqlDbType.DateTime),
                new SqlMetaData("deletedBy", SqlDbType.NVarChar, 100),
    };

            List<SqlDataRecord> list = new List<SqlDataRecord>();

            foreach (MasterCategory masterCategory in masterCategories)
            {
                var record = new SqlDataRecord(tvp);
                record.SetInt32(0, masterCategory.categoryId);
                record.SetString(1, masterCategory.name);
                record.SetString(2, masterCategory.type);
                record.SetBoolean(3, masterCategory.isSystem);
                if (masterCategory.deleteDate != null)
                    record.SetDateTime(8, Convert.ToDateTime(masterCategory.deleteDate));
                if (masterCategory.deletedBy != null)
                    record.SetString(9, masterCategory.deletedBy);
                list.Add(record);
            }

            return list;
        }

    }
}

```
## ChatHelper.cs
```cs
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Util;
using Dapper;
using Newtonsoft.Json;
using System;
using System.Collections.Generic;
using System.Data;
using System.Data.SqlClient;
using System.Linq;
using AT.AT2017.Api.Core.Shared;

namespace AT.AT2017.Api.Helpers
{
    public class ChatHelper
    {
        const string baseConnectionString = "Server={0}; Database={1}; User Id = {2}; Password={3}; Max Pool Size=1024; Pooling=true; Application Name=ChatHelper; Connection Timeout = 60;";

        Credentials _credentials;
        List<GlobalSetting> _twilioSettings;

        string _adminConnectionString;
        string _connectionString;
        string _saConnectionString;

        public ChatHelper(Credentials credentials)
        {
            _credentials = credentials;
            _adminConnectionString = string.Format(baseConnectionString, credentials.adminServer, credentials.adminDatabase, credentials.adminUser, credentials.adminPassword);
            _connectionString = string.Format(baseConnectionString, credentials.serverName, credentials.dbName, credentials.adminUser, credentials.adminPassword);
            _saConnectionString = string.Format(baseConnectionString, credentials.serverName, credentials.dbName, credentials.adminUser, credentials.adminPassword);
            _twilioSettings = GlobalSettings.search(_adminConnectionString, section: "Twilio").ToList();
        }

        public void sendSMS(int messageID, string serverName, string dbName)
        {
            TwilioHelper helper = new TwilioHelper(_twilioSettings);

            // get message
            ChatMessage message = getMessage(messageID);

            // get room with conversationSid
            ChatRoom room = getChatRoom(message.roomID, serverName, dbName, helper);

            // get contacts with participantSid
            List<ChatContact> contacts = getChatContacts(room, helper);

            // send SMS
            dynamic twilioMessage = helper.createConversationMessage(room.conversationSid, message.userName, message.message);
            message.messageSid = twilioMessage.sid;
            updateMessageSid(messageID, message.messageSid);
        }

        public int? createMessage(int webhookID, TwilioWebhook webhook)
        {
            int? messageID = null;
            string status = null;
            string errorMessage = null;
            try
            {
                TwilioHelper helper = new TwilioHelper(_twilioSettings);

                // fetch conversation from Twilio
                dynamic conversation = helper.fetchConversation(webhook.ConversationSid);

                // load attributes
                dynamic attributes = JsonConvert.DeserializeObject<dynamic>((string)conversation.attributes);
                string serverName = attributes.serverName;
                string dbName = attributes.dbName;

                // save sms on chatMessage
                _saConnectionString = string.Format(baseConnectionString, serverName, dbName, _credentials.adminUser, _credentials.adminPassword);

                using (SqlConnection saConnection = new SqlConnection(_saConnectionString))
                {
                    messageID = saConnection.ExecuteScalar<int>("chat_message_add_from_webhook", new
                    {
                        webhookID,
                        conversationSid = webhook.ConversationSid,
                        participantSid = webhook.ParticipantSid,
                        messageSid = webhook.MessageSid,
                        message = webhook.Body,
                        createDate = webhook.DateCreated
                    }, commandType: CommandType.StoredProcedure);
                }

                status = "S";
                errorMessage = null;
            }
            catch (Exception e)
            {
                status = "F";
                errorMessage = e.Message;
            }

            updateWebookStatus(webhookID, status, errorMessage);

            return messageID;
        }

        public void updateWebookStatus(int WebhookID, string Status, string ErrorMessage)
        {
            using (SqlConnection connection = new SqlConnection(_adminConnectionString))
            {
                connection.Execute("twilio_webhook_update", new
                {
                    WebhookID,
                    Status,
                    ErrorMessage,
                }, commandType: CommandType.StoredProcedure);
            }
        }

        public ChatRoom getChatRoom(int roomID, string serverName, string dbName, TwilioHelper helper)
        {
            ChatRoom room;
            using (SqlConnection connection = new SqlConnection(_saConnectionString))
            {
                room = connection.QueryFirstOrDefault<ChatRoom>("chat_room_get", new { roomID }, commandType: CommandType.StoredProcedure);

                // get conversationSid or create if not exists
                string conversationSid = room.conversationSid;
                if (string.IsNullOrEmpty(conversationSid))
                {

                    string attributes = JsonConvert.SerializeObject(new
                    {
                        serverName,
                        dbName
                    });

                    dynamic conversation = helper.createConversation(room.title, attributes);
                    conversationSid = conversation.sid;

                    connection.ExecuteScalar<int>("chat_room_update",
                    new
                    {
                        roomID,
                        room.title,
                        conversationSid
                    },
                    commandType: CommandType.StoredProcedure);

                    room.conversationSid = conversationSid;
                }
            }
            return room;
        }

        public List<ChatContact> getChatContacts(int roomID)
        {
            // get contacts from chat room
            using (SqlConnection connection = new SqlConnection(_saConnectionString))
            {
                return connection.Query<ChatContact>("chat_contact_search",
                    new { roomID }, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        public List<ChatContact> getChatContacts(ChatRoom room, TwilioHelper helper)
        {
            List<ChatContact> contacts = new List<ChatContact>();

            // get contacts from chat room
            using (SqlConnection connection = new SqlConnection(_saConnectionString))
            {
                contacts = connection.Query<ChatContact>("chat_contact_search",
                    new { room.roomID }, commandType: CommandType.StoredProcedure).ToList();
            }

            // create participant if needed
            foreach (ChatContact contact in contacts)
            {
                if (string.IsNullOrEmpty(contact.participantSid))
                {
                    // if type = "user" create ConversationUser and Participant
                    if (contact.entityType.ToLower() == "user")
                    {
                        // create ConversationUser and update appUser table
                        if (contact.userSid == null)
                        {
                            // create on Twilio
                            dynamic conversartionUser = helper.createConversationUser(contact.userName, contact.userFriendlyName);
                            contact.userSid = conversartionUser.sid;

                            // update on appUser
                            int userID = contact.userID.GetValueOrDefault();
                            updateTwilioUserSid(userID, contact.userSid);
                        }

                        // create participant on conversation
                        dynamic participant = helper.createConversationParticipant(room.conversationSid, "user", contact.userName);
                        contact.participantSid = participant.sid;
                    }

                    // if type = "person" create Participant into conversation
                    if (contact.entityType.ToLower() == "person")
                    {
                        dynamic participant = helper.createConversationParticipant(room.conversationSid, "person", contact.personPhoneNumber, null);
                        contact.participantSid = participant.sid;
                    }

                    // update participantSid on chatContact record
                    updateParticipantSid(contact.contactID, contact.participantSid);
                }
            }

            return contacts;
        }

        public ChatMessage getMessage(int messageID)
        {
            using (SqlConnection connection = new SqlConnection(_saConnectionString))
            {
                return connection.QueryFirstOrDefault<ChatMessage>("chat_message_get", new
                {
                    messageID
                }, commandType: CommandType.StoredProcedure);
            }
        }

        private void updateTwilioUserSid(int userID, string twilioUserSid)
        {
            using (SqlConnection connection = new SqlConnection(_adminConnectionString))
            {
                connection.Execute("user_update_twilio_user_sid", new
                {
                    userID,
                    twilioUserSid,
                }, commandType: CommandType.StoredProcedure);
            }
        }

        private void updateParticipantSid(int contactID, string participantSid)
        {
            using (SqlConnection connection = new SqlConnection(_connectionString))
            {
                connection.Execute("chat_contact_update_participant_sid", new
                {
                    contactID,
                    participantSid,
                }, commandType: CommandType.StoredProcedure);
            }
        }

        private void updateMessageSid(int messageID, string messageSid)
        {
            using (SqlConnection connection = new SqlConnection(_connectionString))
            {
                connection.Execute("chat_message_update_message_sid", new
                {
                    messageID,
                    messageSid,
                }, commandType: CommandType.StoredProcedure);
            }
        }
    }
}

```
## TwilioHelper.cs
```cs
using System;
using System.IO;
using System.Net;
using System.Text;
using Newtonsoft.Json;
using System.Collections.Generic;
using AT.AT2017.Api.Util;
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Core.Exceptions;

namespace AT.AT2017.Api.Helpers
{
    public class TwilioHelper
    {
        List<GlobalSetting> _twilioSettings;

        string _accountSid;
        string _authToken;
        string _proxyAddress;

        string conversationBaseUrl = "https://conversations.twilio.com/v1";

        public TwilioHelper(List<GlobalSetting> twilioSettings)
        {
            // set MX global settings
            _twilioSettings = twilioSettings;

            _accountSid = GlobalSettings.getSettingValue(_twilioSettings, "TWILIO_ACCOUNT_ID");
            _authToken = GlobalSettings.getSettingValue(_twilioSettings, "TWILIO_AUTH_TOKEN");
            _proxyAddress = GlobalSettings.getSettingValue(_twilioSettings, "TWILIO_PHONE_NUMBER");

        }

        public dynamic fetchConversation(string conversationSid)
        {
            string baseUrl = conversationBaseUrl;
            string endpoint = $"/Conversations/{conversationSid}";

            string response = makeRequest("GET", baseUrl, endpoint);

            return JsonConvert.DeserializeObject<dynamic>(response);
        }

        public dynamic createConversation(string friendlyName, string attributes) {
            string baseUrl = conversationBaseUrl;
            string endpoint = "/Conversations";

            Dictionary<string, string> body = new Dictionary<string, string>();
            body.Add("FriendlyName", friendlyName);
            body.Add("Attributes", attributes);

            string response = makeRequest("POST", baseUrl, endpoint, body);

            return JsonConvert.DeserializeObject<dynamic>(response);
        }

        public dynamic fetchConversationUser(string identity)
        {
            string baseUrl = conversationBaseUrl;
            string endpoint = $"/Users/{identity}";

            string response = makeRequest("GET", baseUrl, endpoint);

            return JsonConvert.DeserializeObject<dynamic>(response);

        }

        public dynamic createConversationUser(string identity, string friendlyName)
        {
            dynamic user = null;
            try
            {
                string baseUrl = conversationBaseUrl;
                string endpoint = "/Users";

                Dictionary<string, string> body = new Dictionary<string, string>();
                body.Add("Identity", identity);
                body.Add("FriendlyName", friendlyName);

                string response = makeRequest("POST", baseUrl, endpoint, body);

                user = JsonConvert.DeserializeObject<dynamic>(response);
            }
            catch (TwilioException e)
            {
                if (e.statusCode.ToString() == "Conflict")
                    user = fetchConversationUser(identity);
                else
                    throw e;
            }
            return user;
        }

        public dynamic createConversationParticipant(string conversationSid, string type, string identity)
        {
            string baseUrl = conversationBaseUrl;
            string endpoint = $"/Conversations/{conversationSid}/Participants";

            string attributes = JsonConvert.SerializeObject(new { type });

            Dictionary<string, string> body = new Dictionary<string, string>();
            body.Add("Identity", identity);
            body.Add("Attributes", attributes);

            string response = makeRequest("POST", baseUrl, endpoint, body);

            return JsonConvert.DeserializeObject<dynamic>(response);
        }

        public dynamic createConversationParticipant(string conversationSid, string type, string address, string proxyAddress)
        {
            string baseUrl = conversationBaseUrl;
            string endpoint = $"/Conversations/{conversationSid}/Participants";

            if (string.IsNullOrEmpty(proxyAddress))
            {
                proxyAddress = _proxyAddress;
            }

            string attributes = JsonConvert.SerializeObject(new { type });

            Dictionary<string, string> body = new Dictionary<string, string>();
            body.Add("MessagingBinding.Address", address);
            body.Add("MessagingBinding.ProxyAddress", proxyAddress);
            body.Add("Attributes", attributes);

            string response = makeRequest("POST", baseUrl, endpoint, body);

            return JsonConvert.DeserializeObject<dynamic>(response);

        }

        public dynamic createConversationMessage(string conversationSid, string author, string message)
        {
            string baseUrl = conversationBaseUrl;
            string endpoint = $"/Conversations/{conversationSid}/Messages";

            Dictionary<string, string> body = new Dictionary<string, string>();
            body.Add("Author", author);
            body.Add("Body", message);

            string response = makeRequest("POST", baseUrl, endpoint, body);

            return JsonConvert.DeserializeObject<dynamic>(response);

        }

        private string makeRequest(string method, string baseUrl, string endpoint, Dictionary<string, string> body = null)
        {
            string response = null;
            try
            {
                // Create the request URL
                string url = baseUrl + endpoint;

                // Create the request object
                HttpWebRequest request = (HttpWebRequest)WebRequest.Create(url);

                // Set the request method
                request.Method = method;

                // Set the basic authentication header using your Twilio credentials
                string auth = Convert.ToBase64String(Encoding.UTF8.GetBytes($"{_accountSid}:{_authToken}"));
                request.Headers["Authorization"] = $"Basic {auth}";

                if (body != null)
                {
                    //// Define the request parameters
                    //string postData = "From=+1234567890" + // Twilio phone number
                    //                  "&To=+9876543210" + // Destination phone number
                    //                  "&Body=Hello, from Twilio!"; // Message body

                    string postData = "";

                    foreach (KeyValuePair<string, string> kvp in body)
                    {
                        if (!string.IsNullOrEmpty(postData)) postData += "&";
                        postData += $"{kvp.Key}={Uri.EscapeDataString(kvp.Value)}";
                    }

                    // Encode the parameters into bytes
                    byte[] dataBytes = Encoding.UTF8.GetBytes(postData);

                    // Set the content type and content length headers
                    request.ContentType = "application/x-www-form-urlencoded";
                    request.ContentLength = dataBytes.Length;

                    // Write the data bytes into the request stream
                    using (Stream requestStream = request.GetRequestStream())
                    {
                        requestStream.Write(dataBytes, 0, dataBytes.Length);
                    }
                }

                // get response
                using (HttpWebResponse webResponse = (HttpWebResponse)request.GetResponse())
                {
                    using (Stream stream = webResponse.GetResponseStream())
                    {
                        using (StreamReader reader = new StreamReader(stream))
                        {
                            response = reader.ReadToEnd();
                        }
                    }
                }
            }
            catch (WebException e)
            {
                throw getTwilioException(e);
            }
            return response;
        }

        private TwilioException getTwilioException(WebException e)
        {
            TwilioException twilioException = null;
            string errorMessage;
            try
            {
                string strResponse = string.Empty;
                using (HttpWebResponse response = (HttpWebResponse)e.Response)
                {
                    using (Stream responseStream = response.GetResponseStream())
                    {
                        StreamReader responseReader = new StreamReader(response.GetResponseStream());
                        string responseText = responseReader.ReadToEnd();

                        dynamic responseDynamic = JsonConvert.DeserializeObject(responseText);

                        errorMessage = (string)responseDynamic.message;
                    }

                    twilioException = new TwilioException(errorMessage, response.StatusCode);
                }
            }
            catch
            {
                errorMessage = e.Message;
                twilioException = new TwilioException(errorMessage);
            }

            return twilioException;
        }
    }

}

```
## ChatHub.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Hubs.Clients;
using AT.AT2017.Api.Repositories;
using Microsoft.AspNetCore.Cors;
using Microsoft.AspNetCore.SignalR;
using Task = System.Threading.Tasks.Task;

namespace AT.AT2017.Api.Hubs
{
    [EnableCors("CorsDarwinClient")]
    public class ChatHub : Hub<IChatClient>
    {
        private IChatContactRepository _chatContactRepository;
        private IChatMessageRepository _chatMessageRepository;
        private ISettingRepository _settingRepository;
        private readonly UserConnectionManager _connectionManager;

        public ChatHub(UserConnectionManager connectionManager, IChatContactRepository chatContactRepository, IChatMessageRepository chatMessagerepository, ISettingRepository settingRepository)
        {
            _connectionManager = connectionManager;
            _chatContactRepository = chatContactRepository;
            _chatMessageRepository = chatMessagerepository;
            _settingRepository = settingRepository;
        }

        public override async Task OnConnectedAsync()
        {
            int userId = int.Parse(Context.User.Identity.Name); // Identity.Name stores the userId
            string connectionId = Context.ConnectionId;

            _connectionManager.AddConnection(userId, connectionId);

            await base.OnConnectedAsync();
        }

        public override async Task OnDisconnectedAsync(Exception exception)
        {
            int userId = int.Parse(Context.User.Identity.Name);
            string connectionId = Context.ConnectionId;

            _connectionManager.RemoveConnection(userId, connectionId);

            await base.OnDisconnectedAsync(exception);
        }

        public ChatMessage SendMessage(ChatMessage message)
        {
            string currentConnectionId = Context.ConnectionId;

            // get flat to send SMS or not
            Setting sendSmsEnabledSetting = _settingRepository.get("CHAT_SEND_SMS_ENABLED");
            bool sendSmsEnabled = false;
            if (sendSmsEnabledSetting != null)
            {
                sendSmsEnabled = bool.Parse(sendSmsEnabledSetting.value);
            }

            // save message in database
            int id = _chatMessageRepository.add(message, sendSmsEnabled);
            message = _chatMessageRepository.get(id);

            // get chat contacts by roomID
            List<ChatContact> contacts = _chatContactRepository.search(message.roomID).ToList();

            // iterate and send message to all "users" excluding this connection
            foreach (ChatContact contact in contacts)
            {
                if (contact.entityType == "user")
                {
                    int userId = contact.entityID;

                    IReadOnlyCollection<string> connections = _connectionManager.GetConnections(userId);

                    foreach (string connectionId in connections)
                    {
                        if (connectionId != currentConnectionId)
                        {
                            Clients.Client(connectionId).ReceiveMessage(message);
                        }
                    }
                }
            }

            return message;
        }
    }
}

```
## UserConnectionManager.cs
```cs
using System.Collections.Concurrent;
using System.Collections.Generic;

namespace AT.AT2017.Api.Hubs
{
    public class UserConnectionManager
    {
        private readonly ConcurrentDictionary<int, HashSet<string>> _userConnections =
            new ConcurrentDictionary<int, HashSet<string>>();

        public void AddConnection(int userId, string connectionId)
        {
            var connections = _userConnections.GetOrAdd(userId, _ => new HashSet<string>());
            lock (connections)
            {
                connections.Add(connectionId);
            }
        }

        public void RemoveConnection(int userId, string connectionId)
        {
            if (_userConnections.TryGetValue(userId, out var connections))
            {
                lock (connections)
                {
                    connections.Remove(connectionId);
                    if (connections.Count == 0)
                    {
                        _userConnections.TryRemove(userId, out _);
                    }
                }
            }
        }

        public IReadOnlyCollection<string> GetConnections(int userId)
        {
            if (_userConnections.TryGetValue(userId, out var connections))
            {
                lock (connections)
                {
                    return connections;
                }
            }

            return new string[0];
        }
    }
}

```
## IChatClient.cs
```cs
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Hubs.Clients
{
    public interface IChatClient
    {
        System.Threading.Tasks.Task ReceiveMessage(ChatMessage message);
    }
}

```
## AuthorizationMiddleware.cs
```cs
using Microsoft.AspNetCore.Http;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using AT.AT2017.Api.Repositories;
using AT.AT2017.Api.Core.Models;
using System.Security.Claims;
using Microsoft.Extensions.Logging;
using AT.AT2017.Api.Core.Exceptions;
using Microsoft.Extensions.Options;

namespace AT.AT2017.Api.Middlewares
{
    public class AuthorizationMiddleware
    {
        private IAuthRepository _authRepository;
        private readonly RequestDelegate _next;
        private ILogger<AuthorizationMiddleware> _logger;
        private ApplicationSettings _appSettings;

        public AuthorizationMiddleware(RequestDelegate next, IAuthRepository authRepository, ILogger<AuthorizationMiddleware> logger, IOptions<ApplicationSettings> appSettings)
        {
            _authRepository = authRepository;
            _next = next;
            _logger = logger;
            _appSettings = appSettings.Value;
        }

        public async System.Threading.Tasks.Task Invoke(HttpContext context)
        {
            string userName;
            string token;

            bool isWebsocketRequest = context.Request.Headers["Upgrade"].ToString() == "websocket";

            if (context.Request.Path.Value.StartsWith("/api") ||context.Request.Path.Value.StartsWith("/hubs"))
            {
                // validate authorization
                if (context.Request.Path.Value.StartsWith("/api/auth/") && !context.Request.Path.Value.StartsWith("/api/auth/loginhistory"))
                {
                    // continue
                    await _next.Invoke(context);
                }
                else
                {
                    // get current route path
                    string routePath = context.Request.Path.Value;

                    // get remote IP address
                    string ipAddress = context.Connection.RemoteIpAddress.MapToIPv4().ToString();

                    // B2B endpoints
                    List<string> b2bEndpoints = new List<string>();
                    b2bEndpoints.AddRange(_appSettings.b2bEndPoints.Split(",").ToList());

                    // get authorization header info
                    string authHeader = string.Empty;

                    // search current endpoint in B2B endpoints list
                    var item = b2bEndpoints.FirstOrDefault(p => routePath.StartsWith(p));
                    bool isB2BEndpoint = item != null;

                    // when is a B2B endpoint, search for "t" param in querystring
                    if (isB2BEndpoint)
                    {
                        var tokenParam = context.Request.Query.FirstOrDefault(p => p.Key == "t");
                        if (tokenParam.Key != null)
                        {
                            authHeader = "Basic " + tokenParam.Value;
                        }
                    }

                    // whe isWebsocketRequest = true, search for "access_token" param in querystring
                    if (isWebsocketRequest)
                    {
                        var accessTokenParam = context.Request.Query.FirstOrDefault(p => p.Key == "access_token");
                        if (accessTokenParam.Key !=  null)
                        {
                            authHeader = accessTokenParam.Value;
                        }
                    }

                    // if authHeader is empty, search for Authorization header
                    if (string.IsNullOrEmpty(authHeader))
                    {
                        authHeader = context.Request.Headers["Authorization"];
                    }

                    // other controllers
                    if (authHeader != null && authHeader.StartsWith("Basic"))
                    {
                        // _logger.LogInformation("header : " + authHeader.ToString());

                        // extract credentials
                        var tokenEncoded = authHeader.Substring("Basic ".Length).Trim();
                        // _logger.LogInformation("tokenEncoded : " + tokenEncoded.ToString());
                        var credentialstring = Encoding.UTF8.GetString(Convert.FromBase64String(tokenEncoded));
                        var credentials = credentialstring.Split(':');

                        userName = credentials[0];
                        token = credentials[1];

                        UserCredentials user = _authRepository.validateToken(userName, token);

                        if (user != null)
                        {
                            // validate permission and IP address when is B2B endpoint
                            if (isB2BEndpoint)
                            {
                                // validate permission for this B2B endpoint
                                bool isEndpointAllowed = false;
                                if (!string.IsNullOrWhiteSpace(user.allowedEndpoints))
                                {
                                    List<string> allowedEndpoints = user.allowedEndpoints.Split(",").ToList();
                                    foreach (string allowedEndpoint in allowedEndpoints)
                                    {
                                        if (context.Request.Path.Value.ToLower().Contains(allowedEndpoint.ToLower()))
                                        {
                                            isEndpointAllowed = true;
                                            break;
                                        }
                                    }
                                }
                                if (!isEndpointAllowed)
                                {
                                    throw new UnauthorizedException(UnauthorizedException.reasonType.AppClientNotAuthorized);
                                }

                                // validate IP Address
                                bool isIPAddressValid = false;
                                List<string> allowedIpRanges = user.allowedIps.Split(";").ToList();
                                foreach (string allowedIpRange in allowedIpRanges)
                                {
                                    if (ipAddress.StartsWith(allowedIpRange.Replace("*", "")))
                                    {
                                        isIPAddressValid = true;
                                        break;
                                    }
                                }
                                if (!isIPAddressValid)
                                {
                                    throw new UnauthorizedException(UnauthorizedException.reasonType.IPInvalid);
                                }
                            }

                            var claims = new[] {
                                new Claim(ClaimTypes.Name, user.userId.ToString()),
                                new Claim("corporateName", user.corporateName),
                                new Claim("userName", user.userName),
                                new Claim("password", user.userPassword),
                                new Claim("database", user.dbName),
                                new Claim("server", user.serverName),
                                new Claim("dbSubmission", user.dbSubmission),
                                new Claim("appClientID", user.appClientID.ToString()),
                                new Claim(ClaimTypes.Role, "Admin")
                            };

                            var identity = new ClaimsIdentity(claims, "Basic");
                            context.User = new ClaimsPrincipal(identity);

                            await _next.Invoke(context);

                        }
                        else
                        {
                            throw new UnauthorizedException(UnauthorizedException.reasonType.AccessTokenInvalid);
                        }

                    }
                    else
                    {
                        throw new UnauthorizedException(UnauthorizedException.reasonType.AuthorizationHeaderNotPresent);
                    }
                }
            }
            else
            {
                // continue
                await _next.Invoke(context);
            }

        }

    }
}

```
## ErrorHandlingMiddleware.cs
```cs
using Microsoft.AspNetCore.Http;
using Newtonsoft.Json;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Net;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Exceptions;
using Microsoft.Extensions.Logging;

namespace AT.AT2017.Api.Middlewares
{
    public class ErrorHandlingMiddleware
    {
        private readonly RequestDelegate next;
        private static ILogger<AuthorizationMiddleware> _logger;

        public ErrorHandlingMiddleware(RequestDelegate next, ILogger<AuthorizationMiddleware> logger)
        {
            this.next = next;
            _logger = logger;
        }

        public async Task Invoke(HttpContext context /* other scoped dependencies */)
        {
            try
            {
                await next(context);
            }
            catch (Exception ex)
            {
                await HandleExceptionAsync(context, ex);
            }
        }

        private static Task HandleExceptionAsync(HttpContext context, Exception exception)
        {
            var code = HttpStatusCode.InternalServerError; // 500 if unexpected

            //if (exception is MyNotFoundException) code = HttpStatusCode.NotFound;
            //else if (exception is MyUnauthorizedException) code = HttpStatusCode.Unauthorized;
            //else if (exception is MyException) code = HttpStatusCode.BadRequest;

            if (exception is ModelValidationException) code = HttpStatusCode.BadRequest; // 400 Bad Request

            if (exception is UnauthorizedException) code = HttpStatusCode.Unauthorized; // 401 Unauthorized

            if (exception is ForteException) code = HttpStatusCode.ExpectationFailed; // 417 ExpectationFailed

            string errorMessage = exception.Message.Replace("The ROLLBACK TRANSACTION request has no corresponding BEGIN TRANSACTION.\r\n", "");

            var result = JsonConvert.SerializeObject(new { error = errorMessage });

            _logger.LogError("exception : " + errorMessage);
            _logger.LogError("stack trace : " + exception.StackTrace);

            if (exception.InnerException != null)
            {
                result = JsonConvert.SerializeObject(new {
                    error = errorMessage,
                    innerError = exception.InnerException.Message,
                    stackTrace = exception.StackTrace
                });

                _logger.LogError("inner exception : " + exception.InnerException.Message);

            }

            if (exception is ForteException)
            {
                result = JsonConvert.SerializeObject(new {
                    error = errorMessage,
                    code = ((ForteException)exception).code,
                    id = ((ForteException)exception).id
                });
            }

            if (exception is UnauthorizedException)
            {
                UnauthorizedException authException = (UnauthorizedException)exception;
                result = JsonConvert.SerializeObject(new {
                    error = errorMessage,
                    reason = (int)authException.reason,
                    userID = (int)authException.userID.GetValueOrDefault()
                });
            }

            if (exception is MxException)
            {
                MxException mxException = (MxException)exception;
                code = mxException.statusCode;
                result = JsonConvert.SerializeObject(new {
                    error = errorMessage,
                    mxException.type,
                });
            }

            context.Response.ContentType = "application/json";
            context.Response.StatusCode = (int)code;
            return context.Response.WriteAsync(result);
        }
    }
}

```
## RequestResponseLoggingMiddleware.cs
```cs
using Microsoft.AspNetCore.Hosting;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Logging;
using Microsoft.Extensions.Options;
using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Repositories;

namespace AT.AT2017.Api.Middlewares
{
    public class RequestResponseLoggingMiddleware
    {
        protected readonly RequestDelegate _next;
        protected readonly ILogger<RequestResponseLoggingMiddleware> _logger;
        protected readonly ApplicationSettings _appSettings;
        protected readonly IHostingEnvironment _env;

        private IApiCallLogRepository _repository;
        private ISettingRepository _settingRepository;

        public RequestResponseLoggingMiddleware(RequestDelegate next, ILogger<RequestResponseLoggingMiddleware> logger, IOptions<ApplicationSettings> appSettings, IHostingEnvironment env, IApiCallLogRepository repository, ISettingRepository settingRepository)
        {
            _next = next;
            _logger = logger;
            _appSettings = appSettings.Value;
            _env = env;
            _repository = repository;
            _settingRepository = settingRepository;
        }

        private string appInsightsConnectionString
        {
            get
            {
                var userName = _appSettings.AdminUser;
                var password = _appSettings.AdminPassword;
                var server = _appSettings.AdminServer;
                var database = _appSettings.AppInsightsDatabase;

                return string.Format("Server={0};Database={1};User Id={2};Password={3};Max Pool Size=1024;Pooling=true;Application Name=AT2017_API;Connection Timeout=60;", server, database, userName, password);

            }
        }

        private bool getSettingValue(List<Setting> settings, string name)
        {
            bool settingValue = false;
            Setting setting = settings.FirstOrDefault((p) => p.name.ToLower() == name.ToLower());
            if (setting != null)
            {
                Boolean.TryParse(setting.value, out settingValue);
            }
            return settingValue;
        }

        public async System.Threading.Tasks.Task Invoke(HttpContext context)
        {
            // skip saving api call log when there is no an authenticated user 
            if (context.User.FindFirst("userName") == null)
            {
                // execute endpoint
                await _next(context);
                return;
            }

            // skip saving api call log for some special endpoints:
            // transform script
            if (context.Request.Path.Value.Contains("/api/feedprocess/run/transformresponse"))
            {
                // execute endpoint
                await _next(context);
                return;
            }

            Stream requestBodyStream = new MemoryStream();
            Stream responseBodyStream = new MemoryStream();

            // get enable_api_call_log header from Request
            bool enableApiCallLog = false;
            bool savePrivateRequest = false;
            bool savePrivateResponse = false;
            bool savePublicRequest = false;
            bool savePublicResponse = false;

            if (context.Request.Headers.ContainsKey("enable_api_call_log") == false
                || context.Request.Headers.ContainsKey("api_call_log_save_private_request") == false
                || context.Request.Headers.ContainsKey("api_call_log_save_private_response") == false
                || context.Request.Headers.ContainsKey("api_call_log_save_public_request") == false
                || context.Request.Headers.ContainsKey("api_call_log_save_public_response") == false)
            {
                // get flags from settings in database
                List<Setting> settings = _settingRepository.search("", "", "API Call Log", "").ToList();
                enableApiCallLog = this.getSettingValue(settings, "enable_api_call_log");
                savePrivateRequest = this.getSettingValue(settings, "api_call_log_save_private_request");
                savePrivateResponse = this.getSettingValue(settings, "api_call_log_save_private_response");
                savePublicRequest = this.getSettingValue(settings, "api_call_log_save_public_request");
                savePublicResponse = this.getSettingValue(settings, "api_call_log_save_public_response");
            }
            else
            {
                Boolean.TryParse(context.Request.Headers["enable_api_call_log"], out enableApiCallLog);
                Boolean.TryParse(context.Request.Headers["api_call_log_save_private_request"], out savePrivateRequest);
                Boolean.TryParse(context.Request.Headers["api_call_log_save_private_response"], out savePrivateResponse);
                Boolean.TryParse(context.Request.Headers["api_call_log_save_public_request"], out savePublicRequest);
                Boolean.TryParse(context.Request.Headers["api_call_log_save_public_response"], out savePublicResponse);
            }

            string darwinVersion = context.Request.Headers["darwin_version"];
            string darwinServer = context.Request.Headers["darwin_server"];
            string apiServer = Environment.MachineName;

            // get isB2BEndoint flag
            bool isB2BEndoint = false;
            List<string> b2bEndPointsList = _appSettings.b2bEndPoints.Split(",").ToList();
            if (b2bEndPointsList.FirstOrDefault(p => context.Request.Path.ToString().StartsWith(p)) != null)
            {
                isB2BEndoint = true;
            }

            // skip saving call log when enable_api_call_log flag is FALSE
            if (!enableApiCallLog)
            {
                // execute endpoint
                await _next(context);
                return;
            }

            string requestBody = string.Empty;
            string responseBody = string.Empty;

            string dbName = string.Empty;
            string serverName = string.Empty;
            string corporateName = string.Empty;
            string userName = string.Empty;
            string basePath = string.Empty;
            string urlPath = string.Empty;
            string method = string.Empty;
            string statusCode = string.Empty;
            DateTime startTime = DateTime.Now;
            DateTime endTime = DateTime.Now;
            bool isHttps = false;
            string exceptionMessage = string.Empty;
            string innerExceptionMessage = string.Empty;
            string stackTrace = string.Empty;

            // get response body
            var originalResponseStream = context.Response.Body;
            context.Response.Body = responseBodyStream;

            try
            {
                // get request body
                using (var bodyReader = new StreamReader(context.Request.Body))
                {
                    var requestBodyAsText = bodyReader.ReadToEnd();
                    if (string.IsNullOrWhiteSpace(requestBodyAsText) == false)
                    {
                        requestBody = requestBodyAsText;
                    }

                    var bytesToWrite = Encoding.UTF8.GetBytes(requestBodyAsText);
                    requestBodyStream.Write(bytesToWrite, 0, bytesToWrite.Length);
                    requestBodyStream.Seek(0, SeekOrigin.Begin);
                    context.Request.Body = requestBodyStream;
                }

                // execute endpoint
                await _next(context);

                // update endtime
                endTime = DateTime.Now;

                // reset the stream position to 0
                responseBodyStream.Seek(0, SeekOrigin.Begin);
                responseBody = new StreamReader(responseBodyStream).ReadToEnd();

                // reset the stream position to 0
                responseBodyStream.Seek(0, SeekOrigin.Begin);

                // copy response body stream to original
                if (context.Response.StatusCode != 204)
                    await responseBodyStream.CopyToAsync(originalResponseStream);

                statusCode = context.Response.StatusCode.ToString();

            }
            catch (Exception ex)
            {
                // update endtime
                endTime = DateTime.Now;

                _logger.LogError(ex.Message);

                exceptionMessage = ex.Message;
                if (ex.InnerException != null) { 
                    innerExceptionMessage = ex.InnerException.Message;
                }
                stackTrace = ex.StackTrace;

                statusCode = "500";

                //allows exception handling middleware to deal with things
                throw;
            }
            finally
            {
                //Reassign the original stream. If we are re-throwing an exception this is important as the exception handling middleware will need to write to the response stream.
                context.Response.Body = originalResponseStream;

                // save api call log in database
                if (context.User.FindFirst("userName") != null)
                {
                    dbName = context.User.FindFirst("database").Value;
                    serverName = context.User.FindFirst("server").Value;
                    corporateName = context.User.FindFirst("corporateName").Value;
                    userName = context.User.FindFirst("userName").Value;
                    basePath = $"{context.Request.Scheme}://{context.Request.Host.Value}{context.Request.Path}";
                    urlPath = $"{context.Request.Scheme}://{context.Request.Host.Value}{context.Request.Path}{context.Request.QueryString}";
                    method = context.Request.Method;
                    isHttps = context.Request.IsHttps;

                    // flags to save request and save response
                    bool saveRequest = savePrivateRequest || (savePublicRequest && isB2BEndoint);
                    bool saveResponse = savePrivateResponse || (savePublicResponse && isB2BEndoint);

                    // clear requestBody
                    if (!saveRequest && string.IsNullOrWhiteSpace(exceptionMessage))
                    {
                        requestBody = null;
                    }
                    
                    // clear responseBody
                    if (!saveResponse)
                    {
                        responseBody = null;
                    }

                    // save api call log
                    _repository.add(
                        dbName,
                        serverName,
                        corporateName,
                        startTime,
                        endTime,
                        userName,
                        basePath,
                        urlPath,
                        method,
                        requestBody,
                        responseBody,
                        statusCode,
                        isHttps,
                        darwinVersion,
                        darwinServer,
                        apiServer,
                        exceptionMessage,
                        innerExceptionMessage,
                        stackTrace,
                        this.appInsightsConnectionString);
                }

                requestBodyStream.Dispose();
                responseBodyStream.Dispose();
            }
        }
    }
}

```
## .NETCoreApp,Version=v2.0.AssemblyAttributes.cs
```cs
// <autogenerated />
using System;
using System.Reflection;
[assembly: global::System.Runtime.Versioning.TargetFrameworkAttribute(".NETCoreApp,Version=v2.0", FrameworkDisplayName = "")]

```
## AT.AT2017.Api.AssemblyInfo.cs
```cs
//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by a tool.
//     Runtime Version:4.0.30319.42000
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------

using System;
using System.Reflection;

[assembly: System.Reflection.AssemblyCompanyAttribute("AT.AT2017.Api")]
[assembly: System.Reflection.AssemblyConfigurationAttribute("Debug")]
[assembly: System.Reflection.AssemblyFileVersionAttribute("1.0.0.0")]
[assembly: System.Reflection.AssemblyInformationalVersionAttribute("1.0.0")]
[assembly: System.Reflection.AssemblyProductAttribute("AT.AT2017.Api")]
[assembly: System.Reflection.AssemblyTitleAttribute("AT.AT2017.Api")]
[assembly: System.Reflection.AssemblyVersionAttribute("1.0.0.0")]

// Generated by the MSBuild WriteCodeFragment class.


```
## UserSecretsAssemblyInfo.cs
```cs
//------------------------------------------------------------------------------
// <auto-generated>
//     Generated by the MSBuild WriteCodeFragment class.
// </auto-generated>
//------------------------------------------------------------------------------

using System;
using System.Reflection;

[assembly: Microsoft.Extensions.Configuration.UserSecrets.UserSecretsIdAttribute("7d530e11-7503-4133-90cf-435f8dc62508")]

```
## AT.AT2017.Api.AssemblyInfo.cs
```cs
//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by a tool.
//     Runtime Version:4.0.30319.42000
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------

using System;
using System.Reflection;

[assembly: System.Reflection.AssemblyCompanyAttribute("AT.AT2017.Api")]
[assembly: System.Reflection.AssemblyConfigurationAttribute("Luis")]
[assembly: System.Reflection.AssemblyFileVersionAttribute("1.0.0.0")]
[assembly: System.Reflection.AssemblyInformationalVersionAttribute("1.0.0")]
[assembly: System.Reflection.AssemblyProductAttribute("AT.AT2017.Api")]
[assembly: System.Reflection.AssemblyTitleAttribute("AT.AT2017.Api")]
[assembly: System.Reflection.AssemblyVersionAttribute("1.0.0.0")]

// Generated by the MSBuild WriteCodeFragment class.


```
## UserSecretsAssemblyInfo.cs
```cs
//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by a tool.
//     Runtime Version:4.0.30319.42000
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------

using System;
using System.Reflection;

[assembly: Microsoft.Extensions.Configuration.UserSecrets.UserSecretsIdAttribute("7d530e11-7503-4133-90cf-435f8dc62508")]

// Generated by the MSBuild WriteCodeFragment class.


```
## AT.AT2017.Api.AssemblyInfo.cs
```cs
//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by a tool.
//     Runtime Version:4.0.30319.42000
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------

using System;
using System.Reflection;

[assembly: System.Reflection.AssemblyCompanyAttribute("AT.AT2017.Api")]
[assembly: System.Reflection.AssemblyConfigurationAttribute("Release")]
[assembly: System.Reflection.AssemblyFileVersionAttribute("1.0.0.0")]
[assembly: System.Reflection.AssemblyInformationalVersionAttribute("1.0.0")]
[assembly: System.Reflection.AssemblyProductAttribute("AT.AT2017.Api")]
[assembly: System.Reflection.AssemblyTitleAttribute("AT.AT2017.Api")]
[assembly: System.Reflection.AssemblyVersionAttribute("1.0.0.0")]

// Generated by the MSBuild WriteCodeFragment class.


```
## UserSecretsAssemblyInfo.cs
```cs
//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by a tool.
//     Runtime Version:4.0.30319.42000
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------

using System;
using System.Reflection;

[assembly: Microsoft.Extensions.Configuration.UserSecrets.UserSecretsIdAttribute("7d530e11-7503-4133-90cf-435f8dc62508")]

// Generated by the MSBuild WriteCodeFragment class.


```
## 1099ReconciliationRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using AT.AT2017.Api.DynamicParameters;
using System.Data.SqlClient;
using AT.AT2017.Api.Core.Shared;

namespace AT.AT2017.Api.Repositories
{
    public class _1099ReconciliationRepository : BaseRepository, I1099ReconciliationRepository
    {
        public _1099ReconciliationRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

         int I1099ReconciliationRepository.add(_1099Reconciliation item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {             

                int id = connection.ExecuteScalar<int>("1099reconciliation_add", 
                    new {
                        companyId = item.companyId,
                        year = item.year,                    
                        description = item.description,
                        basedOn = item.basedOn,
                        isForPeopleNo1099 = item.isForPeopleNo1099
                    }, commandType: CommandType.StoredProcedure,
                    commandTimeout: 0);

                return id;
            }
        }

        void I1099ReconciliationRepository.personAdd(int id, int personId, decimal amount)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("1099reconciliation_person_add", new { personId = personId, amount = amount ,reconciliationId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        _1099Reconciliation I1099ReconciliationRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                _1099Reconciliation item = null;
                try
                {
                    using (var multi = connection.QueryMultiple("1099reconciliation_get", new { reconciliationId = id }, commandType: CommandType.StoredProcedure, commandTimeout: 0))
                    {
                        item = multi.Read<_1099Reconciliation>().Single();
                        item.detail = multi.Read<_1099ReconciliationDetail>().ToList();
                    }
                }
                catch (Exception ex)
                {
                    if (ex.Message != "Sequence contains no elements")
                        throw ex;
                }

                return item;
            }
        }

         void I1099ReconciliationRepository.refresh(int id,string basedOn)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            { 
               connection.ExecuteScalar<int>("1099reconciliation_refresh", new { reconciliationId = id , basedOn = basedOn }, commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }

         void I1099ReconciliationRepository.update(_1099Reconciliation item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                var reconciliationParameter = new _1099ReconciliationDynamicParameter(item);

                int id = connection.ExecuteScalar<int>("1099reconciliation_update", reconciliationParameter, commandType: CommandType.StoredProcedure);
            }
        }

        IEnumerable<_1099Reconciliation> I1099ReconciliationRepository.search(int companyId, int year, string reconciled)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<_1099Reconciliation>("1099reconciliation_search",
                   new
                   {
                       companyId = companyId,
                       year = year,                     
                       reconciled = reconciled
                   },
                   commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<_1099ReconciliationDetail> I1099ReconciliationRepository.searchBreakdown(int id,int personId, bool useCorporateTaxId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<_1099ReconciliationDetail>("1099reconciliation_breakdown_search",
                   new
                   {
                       reconciliationId = id,
                       personId = personId,
                       useCorporateTaxId= useCorporateTaxId
                   },
                   commandType: CommandType.StoredProcedure).ToList();
            }
        }

        _1099Reconciliation I1099ReconciliationRepository.getHeader(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<_1099Reconciliation>("1099reconciliation_getHeader", new { reconciliationId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        PagedList<_1099ReconciliationDetail> I1099ReconciliationRepository.searchDetailPaginated(int id, int pageIndex, int pageSize, string sortBy, string filterBy)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {

                PagedList<_1099ReconciliationDetail> page = null;

                using (var multi = connection.QueryMultiple("1099reconciliation_search_detail_paginated",
                    new
                    {
                        reconciliationId = id,
                        pageIndex,
                        pageSize,
                        sortBy,
                        filterBy
                    }, commandType: CommandType.StoredProcedure, commandTimeout: 0))
                {
                    page = multi.Read<PagedList<_1099ReconciliationDetail>>().Single();
                    page.additionalData = multi.Read<object>().Single();
                    page.data = multi.Read<_1099ReconciliationDetail>().ToList();

                }
                return page;
            }
        }


    }
}

```
## AgentStoreItemRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class AgentStoreItemRepository : BaseRepository, IAgentStoreItemRepository
    {
        public AgentStoreItemRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<AgentStoreItem> IAgentStoreItemRepository.search()
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<AgentStoreItem>("agentStoreItem_search", null, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        AgentStoreItem IAgentStoreItemRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<AgentStoreItem>("agentStoreItem_get", new { agentStoreItemID = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int IAgentStoreItemRepository.add(AgentStoreItem item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("agentStoreItem_add",
                    new
                    {
                        item.description,
                        accountID = item.accountId,
                        item.amount
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IAgentStoreItemRepository.update(AgentStoreItem item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("agentStoreItem_update",
                    new
                    {
                        agentStoreItemID = item.agentStoreItemId,
                        item.description,
                        accountID = item.accountId,
                        item.amount
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IAgentStoreItemRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("agentStoreItem_delete", new { agentStoreItemID = id }, commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## AgentTeamRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using AT.AT2017.Api.DynamicParameters;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class AgentTeamRepository : BaseRepository, IAgentTeamRepository
    {
        public AgentTeamRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<AgentTeam> IAgentTeamRepository.search()
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<AgentTeam>("agentteam_search", null,
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }

        AgentTeam IAgentTeamRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<AgentTeam>("agentteam_get", new { agentTeamID = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int IAgentTeamRepository.add(AgentTeam item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("agentteam_add",
                    new
                    {
                        name = item.name,
                        teamId = item.teamId,
                        teamLeaderId = item.teamLeaderId
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IAgentTeamRepository.update(AgentTeam item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("agentteam_update",
                     new
                     {
                         agentTeamID = item.agentTeamId,
                         name = item.name,
                         teamId = item.teamId,
                         teamLeaderId = item.teamLeaderId
                     },
                     commandType: CommandType.StoredProcedure);
            }
        }

        void IAgentTeamRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("agentteam_delete", new { agentTeamID = id }, commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## AnalyticsDashboardRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Data;
using System.Data.SqlClient;
using System.Linq;
using AT.AT2017.Api.Core.Models;
using Dapper;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;

namespace AT.AT2017.Api.Repositories
{
    public class AnalyticsDashboardRepository : BaseRepository, IAnalyticsDashboardRepository
    {
        public AnalyticsDashboardRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<AnalyticsDashboard> IAnalyticsDashboardRepository.search(string title, string url, bool applySecurity, int userID)
        {
            using (SqlConnection connection = new SqlConnection(base.saConnectionString))
            {
                return connection.Query<AnalyticsDashboard>("analytics_dashboard_search", 
                    new { title, url, applySecurity, userID }, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        AnalyticsDashboard IAnalyticsDashboardRepository.get(int dashboardID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<AnalyticsDashboard>("analytics_dashboard_get", new { dashboardID }, commandType: CommandType.StoredProcedure);
            }
        }

        int IAnalyticsDashboardRepository.add(AnalyticsDashboard item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("analytics_dashboard_add",
                    new
                    {
                        item.title,
                        item.url,
                        item.typeID
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IAnalyticsDashboardRepository.update(AnalyticsDashboard item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("analytics_dashboard_update",
                     new
                     {
                         item.dashboardID,
                         item.title,
                         item.url,
                         item.typeID
                     },
                     commandType: CommandType.StoredProcedure);
            }
        }

        void IAnalyticsDashboardRepository.delete(int dashboardID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("analytics_dashboard_delete", 
                    new { dashboardID }, commandType: CommandType.StoredProcedure);
            }
        }

        AnalyticsDashboardToken IAnalyticsDashboardRepository.getEmbedToken(int dashboardID, int userID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<AnalyticsDashboardToken>("analytics_dashboard_get_embed_code", new { dashboardID, userID }, commandType: CommandType.StoredProcedure);
            }
        }

        AnalyticsDashboard IAnalyticsDashboardRepository.getPBIReportHtml(string datasetID, string groupID, string reportID, string embedURL, int userID)
        {
            using (SqlConnection connection = new SqlConnection(base.saConnectionString))
            {
                return connection.QueryFirstOrDefault<AnalyticsDashboard>("analytics_pbi_reports_get",
                    new
                    {
                        datasetID,
                        groupID,
                        reportID,
                        embedURL,
                        userID

                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        AgentMetrics IAnalyticsDashboardRepository.getAgentMetrics(int userID, string startDate, string endDate)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<AgentMetrics>("person_get_metrics", 
                    new
                    {
                        userID,
                        startDate,
                        endDate 
                    }, 
                    commandType: CommandType.StoredProcedure);
            }
        }
    }
}

```
## ApiCallLogRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;
using Microsoft.AspNetCore.Hosting;
using Hangfire;

namespace AT.AT2017.Api.Repositories
{
    public class ApiCallLogRepository : BaseRepository, IApiCallLogRepository
    {
        private IBackgroundJobClient _backgroundJobs;

        public ApiCallLogRepository(IHttpContextAccessor httpContextAccessor, IHostingEnvironment env, IOptions<ApplicationSettings> appSettings, IBackgroundJobClient backgroundJobs) : base(httpContextAccessor, env, appSettings)
        {
            _backgroundJobs = backgroundJobs;
        }

        IEnumerable<ApiCalllog> IApiCallLogRepository.search(string dbName, string fromDate, string toDate, string basePath, string exceptionMessage)
        {
            using (SqlConnection connection = new SqlConnection(base.appInsightsConnectionString))
            {
                return connection.Query<ApiCalllog>("apicall_log_search", 
                    new {
                        dbName,
                        fromDate,
                        toDate,
                        basePath,
                        exceptionMessage
                    },
                    commandType: CommandType.StoredProcedure,
                    commandTimeout: 0).ToList();
            }
        }

        void IApiCallLogRepository.cleanUp()
        {
            using (SqlConnection connection = new SqlConnection(base.appInsightsConnectionString))
            {
                ApiCalllog item =  connection.QueryFirstOrDefault<ApiCalllog>("apicall_log_get_min_max_dates",commandType: CommandType.StoredProcedure,commandTimeout: 0);

                DateTime minDate = item.minDate.Value;
                DateTime maxDate = item.maxDate.Value;

                while (minDate <= maxDate)
                {
                    connection.Execute("clean_up_and_shrink", 
                    new
                    {
                        referenceDate = minDate
                    }, 
                    commandType: CommandType.StoredProcedure,
                    commandTimeout: 0);

                    minDate = minDate.AddDays(1);
                }

            }
        }


        IEnumerable<ActiveConnection> IApiCallLogRepository.searchActiveConnections(string guid)
        {
            using (SqlConnection connection = new SqlConnection(base.appInsightsConnectionString))
            {
                return connection.Query<ActiveConnection>("active_connections_search",
                    new
                    {
                        guid
                    },
                    commandType: CommandType.StoredProcedure,
                    commandTimeout: 0).ToList();
            }
        }

        ApiCalllog IApiCallLogRepository.get(string guid)
        {
            using (SqlConnection connection = new SqlConnection(base.appInsightsConnectionString))
            {
                return connection.QueryFirstOrDefault<ApiCalllog>("apicall_log_get",
                    new
                    {
                        guid
                    }, commandType: CommandType.StoredProcedure);
            }
        }

        void IApiCallLogRepository.add(string dbName, string serverName, string corporateName, DateTime startTime, DateTime endTime, string userName, string basePath, string urlPath, string method, string requestBody, string responseBody, string statusCode, bool isHttps, string darwinVersion, string darwinServer, string apiServer, string exceptionMessage, string innerExceptionMessage, string stackTrace, string connectionString)
        {
            _backgroundJobs.Enqueue(() => addApiCallLogAsync(dbName, serverName, corporateName, startTime, endTime, userName, basePath, urlPath, method, requestBody, responseBody, statusCode, isHttps, darwinVersion, darwinServer, apiServer, exceptionMessage, innerExceptionMessage, stackTrace, connectionString));
        }

        public void addApiCallLogAsync(string dbName, string serverName, string corporateName, DateTime startTime, DateTime endTime, string userName, string basePath, string urlPath, string method, string requestBody, string responseBody, string statusCode, bool isHttps, string darwinVersion, string darwinServer, string apiServer, string exceptionMessage, string innerExceptionMessage, string stackTrace, string connectionString)
        {
            try
            {
                using (SqlConnection cnn = new SqlConnection(connectionString))
                {
                    cnn.Execute("apicall_log_add",
                        new
                        {
                            dbName,
                            serverName,
                            corporateName,
                            startTime,
                            endTime,
                            userName,
                            basePath,
                            urlPath,
                            method,
                            requestBody,
                            responseBody,
                            statusCode,
                            isHttps,
                            stackTrace,
                            innerExceptionMessage,
                            exceptionMessage,
                            darwinVersion,
                            darwinServer,
                            apiServer
                        },
                        commandType: CommandType.StoredProcedure);
                }

            }
            catch
            {
                // _logger.LogError(ex.Message);
            }
        }

    }
}

```
## ApiEndpointRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using Dapper;
using Microsoft.AspNetCore.Hosting;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using System.Collections.Generic;
using System.Data;
using System.Data.SqlClient;
using System.Linq;

namespace AT.AT2017.Api.Repositories
{
    public class ApiEndpointRepository : BaseRepository, IApiEndpointRepository
    {

        public ApiEndpointRepository(IHttpContextAccessor httpContextAccessor, IHostingEnvironment env, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, env, appSettings)
        {
        }

        IEnumerable<ApiEndpoint> IApiEndpointRepository.search()
        {
            using (SqlConnection connection = new SqlConnection(base.adminConnectionString))
            {
                return connection.Query<ApiEndpoint>("api_endpoint_search",
                    null,
                    commandType: CommandType.StoredProcedure,
                    commandTimeout: 0).ToList();
            }
        }
    }
}

```
## ApPaymentRepository.cs
```cs
//using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using AT.AT2017.Api.DynamicParameters;
using System.Data.SqlClient;
using System;
using AT.AT2017.Api.Core.Shared;

namespace AT.AT2017.Api.Repositories
{
    public class ApPaymentRepository : BaseRepository, IApPaymentRepository
    {
        public ApPaymentRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<ApPayment> IApPaymentRepository.searchDuplicateCheckNumber(int companyId, string checkNumber, int accountId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {

                return connection.Query<ApPayment>("appayment_search_duplicateCheckNumber",
                    new
                    {
                        companyId = companyId,                      
                        checkNumber = checkNumber,
                        accountID = accountId
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<ApPayment> IApPaymentRepository.search(int companyId, int personId, int apPaymentId, string checkNumber, decimal amount, int accountId, string posted, string fromDate, string toDate, string cleared, string reconciled, int propertyId, string memo, int pageIndex, int pageSize, bool withTrash)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {

                return connection.Query<ApPayment>("appayment_search",
                    new
                    {
                        companyId = companyId,
                        personId = personId,
                        apPaymentId = apPaymentId,
                        checkNumber = checkNumber,
                        amount = amount,
                        posted = posted,
                        accountID = accountId,
                        fromDate = fromDate,
                        toDate = toDate,
                        cleared = cleared,
                        reconciled = reconciled,
                        memo = memo,
                        propertyId = propertyId,
                        pageIndex = pageIndex,
                        pageSize = pageSize,
                        withTrash = withTrash

                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<ApPayment> IApPaymentRepository.searchDeletedRecord(int pageIndex, int pageSize)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<ApPayment>("appayment_search_deleted",
                    new
                    {
                        pageIndex = pageIndex,
                        pageSize = pageSize
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<Voucher> IApPaymentRepository.validateOverpayment(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<Voucher>("appayment_validate_overpayment",
                    new
                    {
                        apPaymentID=id
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<ApPayment> IApPaymentRepository.searchPrint(int companyId, int accountId, string checkNumberFrom, string checkNumberTo)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<ApPayment>("appayment_search_print",
                    new
                    {
                        companyId = companyId,
                        accountID = accountId,
                        checkNumberFrom = checkNumberFrom,
                        checkNumberTo = checkNumberTo
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        PagedList<ApPayment> IApPaymentRepository.searchPrintPaginated(int companyId, int accountId, string checkNumberFrom, string checkNumberTo, int pageIndex, int pageSize)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                PagedList<ApPayment> page = null;

                using (var multi = connection.QueryMultiple("appayment_search_print_paginated",
                    new
                    {
                        companyId,
                        accountId,
                        checkNumberFrom,
                        checkNumberTo,
                        pageIndex,
                        pageSize,
                    },
                    commandType: CommandType.StoredProcedure))
                {
                    page = multi.Read<PagedList<ApPayment>>().Single();
                    page.data = multi.Read<ApPayment>().ToList();
                }
                return page;
            }
        }

        IEnumerable<ApPayment> IApPaymentRepository.searchDirects(string date)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<ApPayment>("appayment_search_direct",
                    new
                    {
                        date = date
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        string IApPaymentRepository.getNextCheckNumber(int accountId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                string max = connection.ExecuteScalar<string>("account_search_nextCheckNumber", new
                {
                    accountId = accountId
                }, commandType: CommandType.StoredProcedure);

                return max;
            }
        }

        int IApPaymentRepository.add(ApPayment item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                var apPaymentParameter = new ApPaymentDynamicParameter(item);

                int id = connection.ExecuteScalar<int>("appayment_add", apPaymentParameter, commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        ApPayment IApPaymentRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                ApPayment appayment = null;
                try
                {
                    using (var multi = connection.QueryMultiple("appayment_get", new { apPaymentId = id }, commandType: CommandType.StoredProcedure))
                    {
                        appayment = multi.Read<ApPayment>().Single();
                        appayment.detail = multi.Read<ApPaymentDetail>().ToList();
                    }
                }
                catch (Exception ex)
                {
                    if (ex.Message != "Sequence contains no elements")
                        throw ex;
                }

                return appayment;
            }
        }

        void IApPaymentRepository.voiding(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("appayment_void", new { apPaymentId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        void IApPaymentRepository.update(ApPayment item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                var apPaymentParameter = new ApPaymentDynamicParameter(item);

                int id = connection.ExecuteScalar<int>("appayment_update", apPaymentParameter, commandType: CommandType.StoredProcedure);
            }
        }

        void IApPaymentRepository.updateTemplate(int id, int templateId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("appayment_update_template", new { apPaymentId = id, checkTemplateId = templateId }, commandType: CommandType.StoredProcedure);
            }
        }

        void IApPaymentRepository.updatePaymentDate(int id, string paymentDate)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("appayment_update_paymentDate", new { apPaymentId = id, paymentDate = paymentDate }, commandType: CommandType.StoredProcedure);
            }
        }

        void IApPaymentRepository.updateCheckNumber(int id, string checkNumber)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("appayment_update_checkNumber", new { apPaymentId = id, checkNumber }, commandType: CommandType.StoredProcedure);
            }
        }

        void IApPaymentRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("appayment_delete", new { apPaymentId = id }, commandType: CommandType.StoredProcedure);
            }
        }
       
        void IApPaymentRepository.post(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("appayment_post", new { apPaymentId = id }, commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }

        void IApPaymentRepository.unpost(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("appayment_unpost", new { apPaymentId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int IApPaymentRepository.applyCredit(int customerId, int bankAccountId, decimal amount, string date, int companyId,string checkNumber)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.ExecuteScalar<int>("appayment_applycredit",
                    new
                    {
                        personId = customerId,
                        bankAccountId = bankAccountId,
                        amount = amount,
                        date = date,
                        companyId = companyId,
                        checkNumber = checkNumber
                    }, commandType: CommandType.StoredProcedure);
            }
        }

        void IApPaymentRepository.print(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("appayment_print", new { apPaymentId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        IEnumerable<ApPayment> IApPaymentRepository.searchPostingProperty(int propertyId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<ApPayment>("aPPayment_PostingProperty",
                    new
                    {
                        propertyId
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

    }
}

```
## ApPaymentScannedImageRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using AT.AT2017.Api.Core.Models;
using Dapper;
using System.Data;
using AT.AT2017.Api.DynamicParameters;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class ApPaymentScannedImageRepository : BaseRepository, IApPaymentScannedImageRepository
    {
        public ApPaymentScannedImageRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<ApPaymentScannedImage> IApPaymentScannedImageRepository.search(int apPaymentID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<ApPaymentScannedImage>("apPayment_scannedImage_search",
                    new
                    {
                        apPaymentID,
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        ApPaymentScannedImage IApPaymentScannedImageRepository.get(int scannedImageID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirst<ApPaymentScannedImage>("apPayment_scannedImage_get", 
                    new
                    {
                        scannedImageID
                    }, commandType: CommandType.StoredProcedure);
            }
        }

        int IApPaymentScannedImageRepository.add(ApPaymentScannedImage item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                item.scannedImageID = connection.ExecuteScalar<int>("apPayment_scannedImage_add", new {
                    item.apPaymentID,
                    item.driveID,
                    item.fileName,
                    item.description
                }, commandType: CommandType.StoredProcedure, commandTimeout: 0);

                return item.scannedImageID;
            }
        }

        void IApPaymentScannedImageRepository.delete(int scannedImageID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("apPayment_scannedImage_delete", new { scannedImageID }, commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }

        void IApPaymentScannedImageRepository.update(ApPaymentScannedImage item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("apPayment_scannedImage_update", new
                {
                    item.scannedImageID,
                    item.description
                }, commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }
    }
}

```
## ApPaymentScannedImageViewHistoryRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class ApPaymentScannedImageViewHistoryRepository : BaseRepository, IApPaymentScannedImageViewHistoryRepository
    {
        public ApPaymentScannedImageViewHistoryRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<ApPaymentScannedImage> IApPaymentScannedImageViewHistoryRepository.search(int scannedImageID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<ApPaymentScannedImage>("apPayment_scannedImage_viewHistory_search",
                 new
                 {
                     scannedImageID
                 },
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }

        int IApPaymentScannedImageViewHistoryRepository.add(int scannedImageID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("apPayment_scannedImage_viewHistory_add",
                    new
                    {
                        scannedImageID
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

    }
}

```
## AppClientRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Data;
using System.Data.SqlClient;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Dapper;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;

namespace AT.AT2017.Api.Repositories
{
    public class AppClientRepository : BaseRepository, IAppClientRepository
    {
        public AppClientRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<AppClient> IAppClientRepository.search(string name, int databaseID)
        {
            using (SqlConnection connection = new SqlConnection(base.adminConnectionString))
            {
                return connection.Query<AppClient>("appclient_search",
                    new
                    {
                       name,
                        databaseID
                    }, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        AppClient IAppClientRepository.get(int appClientID)
        {
            using (SqlConnection connection = new SqlConnection(base.adminConnectionString))
            {
                AppClient item = null;

                try
                {
                    using (var multi = connection.QueryMultiple("appClient_get", 
                        new { appClientID },
                        commandType: CommandType.StoredProcedure))
                    {
                        item = multi.Read<AppClient>().Single();
                        item.endpoints = multi.Read<AppClientEndpoint>().ToList();
                    }
                }
                catch (Exception ex)
                {
                    if (ex.Message != "Sequence contains no elements")
                        throw ex;
                }
                return item;
            }
        }

        int IAppClientRepository.add(string name, string clientID, string clientSecret, string allowedIps, int databaseID)
        {
            using (SqlConnection connection = new SqlConnection(base.adminConnectionString))
            {
                int id = connection.ExecuteScalar<int>("appClient_add",
                     new
                     {
                         name,
                         clientID,
                         clientSecret,
                         allowedIps,
                         databaseID
                     }, commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IAppClientRepository.update(int appClientID, string name, string clientID, string clientSecret, string allowedIps, string modifyBy)
        {
            using (SqlConnection connection = new SqlConnection(base.adminConnectionString))
            {
                int id = connection.ExecuteScalar<int>("appClient_update",
                     new
                     {
                         appClientID,
                         name,
                         clientID,
                         clientSecret,
                         allowedIps,
                         modifyBy
                     }, commandType: CommandType.StoredProcedure);
            }
        }

        void IAppClientRepository.delete(int appClientID)
        {
            using (SqlConnection connection = new SqlConnection(base.adminConnectionString))
            {
                connection.ExecuteScalar<int>("appClient_delete", new { appClientID }, commandType: CommandType.StoredProcedure);
            }
        }

        int IAppClientRepository.addEndpoint(AppClientEndpoint item)
        {
            using (SqlConnection connection = new SqlConnection(base.adminConnectionString))
            {

                int id = connection.ExecuteScalar<int>("appClient_endpoint_add",
                    new
                    {
                        item.appClientID,
                        item.endpointID
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IAppClientRepository.deleteEndpoint(int appClientID, int endpointID)
        {
            using (SqlConnection connection = new SqlConnection(base.adminConnectionString))
            {
                connection.Execute("appClient_endpoint_delete",
                    new
                    {
                        appClientID,
                        endpointID
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }
    }
}

```
## ArPaymentRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using AT.AT2017.Api.DynamicParameters;
using System.Data.SqlClient;
using AT.AT2017.Api.Core.Shared;

namespace AT.AT2017.Api.Repositories
{
    public class ArPaymentRepository : BaseRepository, IArPaymentRepository
    {
        public ArPaymentRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<ArPayment> IArPaymentRepository.search(int companyId, int accountId, int personId, decimal amount, string fromDate, string toDate, string posted, string deposited, int customerTypeId, string method, int pageIndex, int pageSize, bool withTrash, int propertyId, string memo, string checkNumber, string payee)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<ArPayment>("arpayment_search",
                    new
                    {
                        companyId,
                        accountId,
                        personId,
                        amount,
                        fromDate,
                        toDate,
                        posted,
                        deposited,
                        customerTypeId,
                        method,
                        pageIndex,
                        pageSize,
                        withTrash,
                        propertyId,
                        memo,
                        checkNumber,
                        payee
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<ArPayment> IArPaymentRepository.searchDeletedRecord(int pageIndex, int pageSize)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<ArPayment>("arpayment_search_deleted",
                    new
                    {
                        pageIndex = pageIndex,
                        pageSize = pageSize
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<ArPayment> IArPaymentRepository.searchUndeposited(int companyId, int accountId, string fromDate, string toDate, string paymentMethod)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<ArPayment>("arpayment_search_undeposited",
                      new
                      {
                          companyId = companyId,
                          accountId = accountId,
                          fromDate = fromDate,
                          toDate = toDate,
                          paymentMethod = paymentMethod
                      },
                      commandType: CommandType.StoredProcedure).ToList();
            }
        }

        PagedList<ArPayment> IArPaymentRepository.searchUndepositedPaginated(int companyId, int accountId, string fromDate, string toDate, string paymentMethod, int pageIndex, int pageSize, string sortBy, string filterBy)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                PagedList<ArPayment> page = null;

                using (var multi = connection.QueryMultiple("arpayment_search_undeposited_paginated",
                   new
                   {
                       companyId,
                       accountId,
                       fromDate,
                       toDate,
                       paymentMethod,
                       pageIndex,
                       pageSize,
                       sortBy,
                       filterBy
                   }, commandType: CommandType.StoredProcedure, commandTimeout: 0))

                {
                    page = multi.Read<PagedList<ArPayment>>().Single();
                    page.data = multi.Read<ArPayment>().ToList();

                }
                return page;
            }
        }

        ArPayment IArPaymentRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                ArPayment arpayment = null;
                try
                {
                    using (var multi = connection.QueryMultiple("arpayment_get", new { arPaymentId = id }, commandType: CommandType.StoredProcedure))
                    {
                        arpayment = multi.Read<ArPayment>().Single();
                        arpayment.detail = multi.Read<ArPaymentDetail>().ToList();
                    }
                }
                catch (Exception ex)
                {
                    if (ex.Message != "Sequence contains no elements")
                        throw ex;
                }

                return arpayment;
            }
        }

        int IArPaymentRepository.add(ArPayment item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                var arPaymentParameter = new ArPaymentDynamicParameter(item);

                int id = connection.ExecuteScalar<int>("arpayment_add", arPaymentParameter, commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IArPaymentRepository.update(ArPayment item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                var arPaymentParameter = new ArPaymentDynamicParameter(item);

                int id = connection.ExecuteScalar<int>("arpayment_update", arPaymentParameter, commandType: CommandType.StoredProcedure);
            }
        }

        void IArPaymentRepository.updatePaymentMethod(ArPayment item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                 int id = connection.ExecuteScalar<int>("arpayment_update_paymentMethod", new { item.arPaymentId,item.paymentMethod }, commandType: CommandType.StoredProcedure);
            }
        }

        void IArPaymentRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("arpayment_delete", new { arPaymentId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        void IArPaymentRepository.post(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("arpayment_post", new { arPaymentID = id }, commandType: CommandType.StoredProcedure);
            }
        }

        void IArPaymentRepository.unpost(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("arpayment_unpost", new { arPaymentID = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int IArPaymentRepository.applyCredit(int customerId, decimal amount, string date, int companyId, string memo, string checkNumber)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.ExecuteScalar<int>("arpayment_applycredit",
                    new
                    {
                        personId = customerId,
                        amount,
                        date,
                        companyId,
                        memo,
                        checkNumber
                    }, commandType: CommandType.StoredProcedure);
            }
        }

        ArPayment IArPaymentRepository.invoiceApplyCreditsbyPerson(int personId, string userName, int companyId, bool onlyLegacy, bool transaction, bool output, bool audit)
        {
            using (SqlConnection connection = new SqlConnection(base.saConnectionString))
            {
                ArPayment arpayment = null;
                try
                {
                    using (var multi = connection.QueryMultiple("invoice_applycredits_by_person",
                         new
                         {
                             personId = personId,
                             userName = userName,
                             companyId = companyId,
                             onlyLegacy = onlyLegacy,
                             transaction = transaction,
                             output = output,
                             audit = audit 
                         }, commandType: CommandType.StoredProcedure)) ;

                       
                        //if (multi != null)
                        //{
                        //    arpayment = multi.Read<ArPayment>().Single();
                        //    arpayment.detail = multi.Read<ArPaymentDetail>().ToList();
                        //}
                        //else
                        //{
                        //    arpayment = null;
                        //}
                }
                catch (Exception ex)
                {
                    if (ex.Message != "Sequence contains no elements")
                        throw ex;
                }

                return arpayment;
            }
        }

        IEnumerable<ArPayment> IArPaymentRepository.searchPostingProperty(int propertyId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<ArPayment>("aRPayment_PostingProperty",
                    new
                    {
                        propertyId
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        void IArPaymentRepository.move(int arpaymentId, int propertyId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("arPayment_move_prepayment", new { arpaymentId, propertyId }, commandType: CommandType.StoredProcedure);
            }
        }
    }
}

```
## ArPaymentScannedImageRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using AT.AT2017.Api.Core.Models;
using Dapper;
using System.Data;
using AT.AT2017.Api.DynamicParameters;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class ArPaymentScannedImageRepository : BaseRepository, IArPaymentScannedImageRepository
    {
        public ArPaymentScannedImageRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<ArPaymentScannedImage> IArPaymentScannedImageRepository.search(int arPaymentID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<ArPaymentScannedImage>("arPayment_scannedImage_search",
                    new
                    {
                        arPaymentID,
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        ArPaymentScannedImage IArPaymentScannedImageRepository.get(int scannedImageID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirst<ArPaymentScannedImage>("arPayment_scannedImage_get", 
                    new
                    {
                        scannedImageID
                    }, commandType: CommandType.StoredProcedure);
            }
        }

        int IArPaymentScannedImageRepository.add(ArPaymentScannedImage item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                item.scannedImageID = connection.ExecuteScalar<int>("arPayment_scannedImage_add", new {
                    item.arPaymentID,
                    item.driveID,
                    item.fileName,
                    item.description
                }, commandType: CommandType.StoredProcedure, commandTimeout: 0);

                return item.scannedImageID;
            }
        }

        void IArPaymentScannedImageRepository.delete(int scannedImageID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("arPayment_scannedImage_delete", new { scannedImageID }, commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }

        void IArPaymentScannedImageRepository.update(ArPaymentScannedImage item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("arPayment_scannedImage_update", new
                {
                    item.scannedImageID,
                    item.description
                }, commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }
    }
}

```
## ArPaymentScannedImageViewHistoryRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class ArPaymentScannedImageViewHistoryRepository : BaseRepository, IArPaymentScannedImageViewHistoryRepository
    {
        public ArPaymentScannedImageViewHistoryRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<ArPaymentScannedImage> IArPaymentScannedImageViewHistoryRepository.search(int scannedImageID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<ArPaymentScannedImage>("arPayment_scannedImage_viewHistory_search",
                 new
                 {
                     scannedImageID
                 },
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }

        int IArPaymentScannedImageViewHistoryRepository.add(int scannedImageID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("arPayment_scannedImage_viewHistory_add",
                    new
                    {
                        scannedImageID
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

    }
}

```
## AuditTrailRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class AuditTrailRepository : BaseRepository, IAuditTrailRepository
    {
        public AuditTrailRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<AuditTrail> IAuditTrailRepository.search(int entityId, string tableName, string fromDate, string endDate, string userName, string changeType, string hostName, string appName)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<AuditTrail>("auditTrail_search",
                 new
                 {
                     entityId,
                     tableName,
                     fromDate,
                     endDate,
                     userName,
                     changeType,
                     hostName,
                     appName
                 },
                 commandType: CommandType.StoredProcedure, commandTimeout: 0).ToList();
            }
        }

        AuditTrail IAuditTrailRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                AuditTrail audit = null;
                try
                {
                    using (var multi = connection.QueryMultiple("auditTrail_get", new { actionId = id }, commandType: CommandType.StoredProcedure))
                    {
                        audit = multi.Read<AuditTrail>().Single();
                        audit.detail = multi.Read<AuditTrailDetail>().ToList();
                    }
                }
                catch (Exception ex)
                {
                    if (ex.Message != "Sequence contains no elements")
                        throw ex;
                }

                return audit;
            }
        }


        IEnumerable<AuditTrail> IAuditTrailRepository.searchCodeValue(string category)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<AuditTrail>("auditTrail_codevalue_search",
                 new
                 {
                     category
                 },
                 commandType: CommandType.StoredProcedure, commandTimeout: 0).ToList();
            }
        }

    }
}

```
## AuthRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using Dapper;
using Microsoft.AspNetCore.Hosting;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Logging;
using Microsoft.Extensions.Options;
using System.Collections.Generic;
using System.Data;
using System.Data.SqlClient;
using System.Linq;

namespace AT.AT2017.Api.Repositories
{
    public class AuthRepository : BaseRepository, IAuthRepository
    {

        private ILogger<AuthRepository> _logger;

        public AuthRepository(IHttpContextAccessor httpContextAccessor, IHostingEnvironment env, IOptions<ApplicationSettings> appSettings, ILogger<AuthRepository> logger) : base(httpContextAccessor, env, appSettings)
        {
            _logger = logger;
        }

        User IAuthRepository.login(string userName, string userPassword, string ipAddress, bool resetToken, int appClientId)
        {
            using (SqlConnection saAdminconnection = new SqlConnection(base.saAdminConnectionString))
            {
                return saAdminconnection.QueryFirstOrDefault<User>("auth_login",
                    new {
                        userName,
                        userPassword,
                        ipAddress,
                        resetToken,
                        appClientId
                    }
                    , commandType: CommandType.StoredProcedure);
            }
        }

        int IAuthRepository.getCompaniesCount(string serverName, string dbName, int userID)
        {
            using (SqlConnection saConnection = new SqlConnection(base.saCustomConnectionString(serverName, dbName)))
            {
                return saConnection.ExecuteScalar<int>("user_get_companies_count",
                    new
                    {
                        userID
                    }, commandType: CommandType.StoredProcedure);
            }
        }

        User IAuthRepository.refreshToken(string userName, string refreshToken)
        {
            using (SqlConnection saAdminconnection = new SqlConnection(base.saAdminConnectionString))
            {
                return saAdminconnection.QueryFirstOrDefault<User>("auth_refresh_token",
                    new
                    {
                        userName,
                        refreshToken
                    }
                    , commandType: CommandType.StoredProcedure);
            }
        }

        UserCredentials IAuthRepository.validateToken(string userName, string token)
        {
            using (SqlConnection saAdminconnection = new SqlConnection(base.saAdminConnectionString))
            {
                return saAdminconnection.Query<UserCredentials>("auth_validate_token",
                 new { userName = userName, token = token },
                 commandType: CommandType.StoredProcedure).FirstOrDefault();
            }
        }

        Database IAuthRepository.validateApiKey(string userName, string apiKey)
        {
            using (SqlConnection saAdminconnection = new SqlConnection(base.saAdminConnectionString))
            {
                return saAdminconnection.Query<Database>("auth_validate_apikey_username",
                   new
                   {
                       userName = userName,
                       apiKey = apiKey
                   },
                   commandType: CommandType.StoredProcedure).FirstOrDefault();
            }
        }

        void IAuthRepository.updatePassword(UserCredentials user)
        {
            using (SqlConnection saAdminConnection = new SqlConnection(base.saAdminConnectionString))
            {
                int id = saAdminConnection.ExecuteScalar<int>("user_update_password", new
                {
                    userId = user.userId,
                    userPassword = user.userPassword
                }, commandType: CommandType.StoredProcedure);
            }
        }

        Server IAuthRepository.validateServer(string userName)
        {
            using (SqlConnection saAdminconnection = new SqlConnection(base.saAdminConnectionString))
            {
                return saAdminconnection.Query<Server>("auth_validate_server",
                   new
                   {
                       userName = userName
                   },
                   commandType: CommandType.StoredProcedure).FirstOrDefault();
            }
        }

        AppClient IAuthRepository.validateClientCredentials(string clientID, string clientSecret)
        {
            using (SqlConnection saAdminconnection = new SqlConnection(base.saAdminConnectionString))
            {
                return saAdminconnection.Query<AppClient>("auth_validate_client_credentials",
                   new
                   {
                       clientID = clientID,
                       clientSecret = clientSecret
                   },
                   commandType: CommandType.StoredProcedure).FirstOrDefault();
            }
        }

        bool IAuthRepository.isHosted(string clientID, string clientSecret)
        {
            using (SqlConnection connection = new SqlConnection(base.saAdminConnectionString))
            {
                bool hosted = connection.ExecuteScalar<bool>("app_client_isHosted",
                     new
                     {
                         clientID = clientID,
                         clientSecret = clientSecret
                     },
                    commandType: CommandType.StoredProcedure);

                return hosted;
            }
        }

        void IAuthRepository.updateClientCredentials(AppClient client)
        {
            using (SqlConnection connection = new SqlConnection(base.saAdminConnectionString))
            {
                int id = connection.ExecuteScalar<int>("appClient_update", new
                {
                    appClientID = client.appClientID,
                    clientID = client.clientID,
                    clientSecret = client.clientSecret,
                    modifyBy = client.modifyBy
                }, commandType: CommandType.StoredProcedure);
            }           
        }

        Widget IAuthRepository.getWidgetToken(string screen, int userID, string systemID)
        {
            using (SqlConnection adminConnection = new SqlConnection(base.saAdminConnectionString))
            {
                return adminConnection.QueryFirstOrDefault<Widget>("widget_add_record",
                     new
                     {
                         screen,
                         userID,
                         systemID
                     },
                     commandType: CommandType.StoredProcedure);
            }
        }

        ExternalSystem IAuthRepository.getExternalSystem(string systemID)
        {
            using (SqlConnection adminConnection = new SqlConnection(base.saAdminConnectionString))
            {
                return adminConnection.QueryFirstOrDefault<ExternalSystem>("external_system_get",
                     new
                     {
                         systemID
                     },
                     commandType: CommandType.StoredProcedure);
            }
        }

        void IAuthRepository.updateExternalSystemCss(string systemID, string css)
        {
            using (SqlConnection adminConnection = new SqlConnection(base.saAdminConnectionString))
            {
                adminConnection.Execute("external_system_update_css",
                     new
                     {
                         systemID,
                         css
                     },
                     commandType: CommandType.StoredProcedure);
            }

        }

        User IAuthRepository.login(string widgetID, string ipAddress, bool resetToken)
        {
            using (SqlConnection adminConnection = new SqlConnection(base.saAdminConnectionString))
            {
                return adminConnection.QueryFirstOrDefault<User>("auth_login_widget",
                     new
                     {
                         widgetID,
                         ipAddress,
                         resetToken
                     },
                     commandType: CommandType.StoredProcedure);
            }
        }

        User IAuthRepository.loginExternal(string token)
        {
            using (SqlConnection adminConnection = new SqlConnection(base.saAdminConnectionString))
            {
                return adminConnection.QueryFirstOrDefault<User>("auth_loginExternal",
                     new
                     {
                         token
                     },
                     commandType: CommandType.StoredProcedure);
            }
        }


        IEnumerable<UserPhone> IAuthRepository.getMobiles(string serverName, string dbName, int userID)
        {
            using (SqlConnection saConnection = new SqlConnection(base.saCustomConnectionString(serverName, dbName)))
            {
                return saConnection.Query<UserPhone>("userPhone_search", new
                {  userId = userID,  onlyVerified = 1
                }, commandType: CommandType.StoredProcedure);           
            }
        }

        bool IAuthRepository.skipDuo(string serverName, string dbName, int userID)
        {
            bool result = false;
            using (SqlConnection saConnection = new SqlConnection(base.saCustomConnectionString(serverName, dbName)))
            {
                result = System.Convert.ToBoolean(saConnection.ExecuteScalar<int>("user_role_skipDuo", new
                {
                    userId = userID
                }, commandType: CommandType.StoredProcedure));
            }
            return result;           
        }

        int IAuthRepository.addMobile(string serverName, string dbName, UserPhone item)
        {
            using (SqlConnection saConnection = new SqlConnection(base.saCustomConnectionString(serverName, dbName)))
            {
                return saConnection.ExecuteScalar<int>("userPhone_add",
                     new
                     {
                         userId = item.userId,
                         phoneCountryCode = item.phoneCountryCode,
                         phoneNumber = item.phoneNumber,
                         phoneName = item.phoneName,
                         verificationCode = item.verificationCode
                     },
                     commandType: CommandType.StoredProcedure);
            }         
        }

        void IAuthRepository.updateCodeLogin(string serverName, string dbName, int id, string code)
        {
            using (SqlConnection saConnection = new SqlConnection(base.saCustomConnectionString(serverName, dbName)))
            {
               saConnection.ExecuteScalar<int>("userPhone_update_codeLogin",
                   new
                   {
                       userPhoneId = id,
                       code = code
                   },
                   commandType: CommandType.StoredProcedure);
            }

        }

        bool IAuthRepository.verifyMobileLogin(string serverName, string dbName, int id, string code)
        {
           using (SqlConnection saConnection = new SqlConnection(base.saCustomConnectionString(serverName, dbName)))
            {
                return System.Convert.ToBoolean(saConnection.ExecuteScalar<int>("userPhone_verifyLogin",
                     new
                     {
                         userPhoneId = id,
                         code = code
                     },
                     commandType: CommandType.StoredProcedure));
            }
        }

        void IAuthRepository.resetPasswordRequest(string userName, string urlHost)
        {
            
            using (SqlConnection adminConnection = new SqlConnection(base.saAdminConnectionString))
            {
                adminConnection.Execute("auth_resetPassword_request", new { userName, urlHost }, commandType: CommandType.StoredProcedure);
            }
        }
    }
}

```
## BackupExecutionLogRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class BackupExecutionLogRepository : BaseRepository, IBackupExecutionLogRepository
    {
        public BackupExecutionLogRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<BackupExecutionLog> IBackupExecutionLogRepository.search(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<BackupExecutionLog>("backupExecutionLog_search", 
                    new { backupExecutionID = id }, commandType: CommandType.StoredProcedure).ToList();
            }
        }
    }
}

```
## BackupExecutionRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;
using Microsoft.AspNetCore.Hosting;

namespace AT.AT2017.Api.Repositories
{
    public class BackupExecutionRepository : BaseRepository, IBackupExecutionRepository
    {
        public BackupExecutionRepository(IHttpContextAccessor httpContextAccessor, IHostingEnvironment env, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, env, appSettings)
        { 
        }

        IEnumerable<BackupExecution> IBackupExecutionRepository.search(int day)
        {
            using (SqlConnection connection = new SqlConnection(base.saConnectionString ))
            {
                return connection.Query<BackupExecution>("backupExecution_search", new { day = day }, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        BackupExecution IBackupExecutionRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.saConnectionString))
            {
                return connection.QueryFirstOrDefault<BackupExecution>("backupexecution_get", new { backupExecutionID = id }, commandType: CommandType.StoredProcedure);
            }
        }

        void IBackupExecutionRepository.reRunBackups(string indexIds,string frecuency)
        {
            using (SqlConnection connection = new SqlConnection(base.saConnectionString))
            {
                connection.Execute("backupExecution_re_run", new
                {
                    indexIds = indexIds,
                    frecuency = frecuency
                },
                commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }

        int IBackupExecutionRepository.add(BackupExecution item)
        {
            using (SqlConnection connection = new SqlConnection(base.saConnectionString))
            {
                int id = connection.ExecuteScalar<int>("backupexecution_add",
                    new
                    {
                        index = item.index,
                        path = item.path,
                        frecuency = item.frecuency
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IBackupExecutionRepository.update(BackupExecution item)
        {
            using (SqlConnection connection = new SqlConnection(base.saConnectionString))
            {
                int id = connection.ExecuteScalar<int>("backupexecution_update",
                    new
                    {
                        backupexecutionID = item.backupExecutionID,
                        index = item.index,
                        path = item.path,
                        frecuency = item.frecuency
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }
    }
}

```
## BankAccountRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Data;
using System.Data.SqlClient;
using System.Linq;
using AT.AT2017.Api.Core.Models;
using Dapper;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;

namespace AT.AT2017.Api.Repositories
{
    public class BankAccountRepository : BaseRepository, IBankAccountRepository
    {
        public BankAccountRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<BankAccount> IBankAccountRepository.search(string accountName)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<BankAccount>("bank_account_search",
                 new
                 {
                     accountName
                 },
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<GLAccount> IBankAccountRepository.searchGLAccounts(string bankAccountType, int companyId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<GLAccount>("bank_account_search_glAccounts", new { bankAccountType, companyID = companyId}, commandType: CommandType.StoredProcedure).ToList();
            }
        }


        BankAccount IBankAccountRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                {
                    return connection.QueryFirstOrDefault<BankAccount>("bank_account_get", new { bankAccountID = id }, commandType: CommandType.StoredProcedure);
                }
            }
        }

        void IBankAccountRepository.update(BankAccount item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("bank_account_update_linkedaccount",
                    new
                    {
                        item.bankAccountID,
                        item.linkedAccountID,
                        item.companyId,
                        item.fromDate
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }
    }
}

```
## BankReconciliationRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using AT.AT2017.Api.DynamicParameters;
using System.Data.SqlClient;
using AT.AT2017.Api.Core.Shared;
using Newtonsoft.Json;

namespace AT.AT2017.Api.Repositories
{
    public class BankReconciliationRepository : BaseRepository, IBankReconciliationRepository
    {
        public BankReconciliationRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<BankReconciliation> IBankReconciliationRepository.search(int companyId, int accountId, int bankrecId, string reconciled)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<BankReconciliation>("bankreconciliation_search",
                   new
                   {
                       companyId = companyId,
                       accountId = accountId,
                       bankrecId = bankrecId,
                       reconciled = reconciled
                   },
                   commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<BankReconciliationDetail> IBankReconciliationRepository.searchDetail(int companyId, int accountId, string limitDate)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<BankReconciliationDetail>("bankreconciliationdetail_search",
                 new
                 {
                     companyId = companyId,
                     accountId = accountId,
                     limitDate = limitDate
                 },
                 commandType: CommandType.StoredProcedure,commandTimeout: 0).ToList();
            }
        }

        BankReconciliation IBankReconciliationRepository.getReconciled(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                BankReconciliation item = null;
                try
                {
                    using (var multi = connection.QueryMultiple("bankreconciliation_get_reconciled", new { bankRecId = id }, commandType: CommandType.StoredProcedure))
                    {
                        item = multi.Read<BankReconciliation>().Single();
                        item.detail = multi.Read<BankReconciliationDetail>().ToList();
                    }
                }
                catch (Exception ex)
                {
                    if (ex.Message != "Sequence contains no elements")
                        throw ex;
                }

                return item;
            }
        }
       
        BankReconciliation IBankReconciliationRepository.get(int id, string limitDate)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                BankReconciliation item = null;
                try
                {
                    using (var multi = connection.QueryMultiple("bankreconciliation_get", new { bankRecId = id, toDate = limitDate }, commandType: CommandType.StoredProcedure, commandTimeout: 0))
                    {
                        item = multi.Read<BankReconciliation>().Single();
                        item.detail = multi.Read<BankReconciliationDetail>().ToList();
                    }
                }
                catch (Exception ex)
                {
                    if (ex.Message != "Sequence contains no elements")
                        throw ex;
                }

                return item;
            }         
        }

        int IBankReconciliationRepository.add(BankReconciliation item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                var bankReconciliationParameter = new BankReconciliationDynamicParameter(item);

                int id = connection.ExecuteScalar<int>("bankreconciliation_add", bankReconciliationParameter, commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IBankReconciliationRepository.update(BankReconciliation item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                var bankReconciliationParameter = new BankReconciliationDynamicParameter(item);

                int id = connection.ExecuteScalar<int>("bankreconciliation_update", bankReconciliationParameter, commandType: CommandType.StoredProcedure, commandTimeout: 0);

            }
        }

        void IBankReconciliationRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("bankreconciliation_delete", new { bankRecId = id }, commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }

        void IBankReconciliationRepository.autoCleared(BankReconciliation item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                var bankReconciliationParameter = new BankReconciliationDynamicParameter(item);

                int id = connection.ExecuteScalar<int>("bankreconciliation_auto_cleared", bankReconciliationParameter, commandType: CommandType.StoredProcedure, commandTimeout: 0);

            }
        }

        void IBankReconciliationRepository.addUnreconcileLog(UnreconcileLog log)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("unreconcile_log_add", 
                                                        new {
                                                            bankRecID = log.bankId,
                                                            log.reason,
                                                            log.signature
                                                        }
                                                        , commandType: CommandType.StoredProcedure);
            }
        }

        void IBankReconciliationRepository.unreconcile(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.saConnectionString))
            {
                connection.Execute("bankreconciliation_unreconciled", new { bankRecId = id }, commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }

        BankReconciliation IBankReconciliationRepository.getHeader(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<BankReconciliation>("bankreconciliation_getHeader", new { id }, commandType: CommandType.StoredProcedure);
            }
        }

        PagedList<BankReconciliationDetail> IBankReconciliationRepository.searchDetailPaginated(int id, bool reconciled, int companyId, int accountId, string limitDate,int filterUser, int pageIndex, int pageSize, string sortBy, string filterBy)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {

                PagedList<BankReconciliationDetail> page = null;

                using (var multi = connection.QueryMultiple("bankreconciliation_search_detail_paginated",
                    new
                    {
                        id,
                        reconciled,
                        companyId,
                        accountId,
                        limitDate,
                        filterUser,
                        pageIndex,
                        pageSize,
                        sortBy,
                        filterBy
                    }, commandType: CommandType.StoredProcedure, commandTimeout: 0))
                {
                    page = multi.Read<PagedList<BankReconciliationDetail>>().Single();
                    page.additionalData = multi.Read<object>().Single();     
                    page.data = multi.Read<BankReconciliationDetail>().ToList();

                }
                return page;
            }
        }

    }
}

```
## BankStreamRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class BankStreamRepository : BaseRepository, IBankStreamRepository
    {
        public BankStreamRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<Office> IBankStreamRepository.searchOffice(int companyId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<Office>("bankstream_search_office", new { companyID = companyId }, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<PlaidWebhook> IBankStreamRepository.searchPlaidWebhook(string item_id)
        {
            using (SqlConnection adminConnection = new SqlConnection(base.adminConnectionString))
            {
                return adminConnection.Query<PlaidWebhook>("webhook_search_by_item_id",
                new
                {
                    item_id
                },
                commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<MxWebhook> IBankStreamRepository.searchMxWebhook(string member_guid)
        {
            using (SqlConnection adminConnection = new SqlConnection(base.adminConnectionString))
            {
                return adminConnection.Query<MxWebhook>("mx_webhook_search_by_guid",
                new
                {
                    member_guid
                },
                commandType: CommandType.StoredProcedure).ToList();
            }
        }

        // TODO: remove this method from this controller; moved to PlaidRepository
        //       drop procedure [bankstream_search_connect_log]; new procedure [plaid_search_connect_log]
        IEnumerable<PlaidConnectLog> IBankStreamRepository.searchConnectLogs()
        {
            using (SqlConnection adminConnection = new SqlConnection(base.connectionString))
            {
                return adminConnection.Query<PlaidConnectLog>("bankstream_search_connect_log", null, commandType: CommandType.StoredProcedure).ToList();
            }
        }

    }
}

```
## BankTransactionRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Data;
using System.Data.SqlClient;
using System.Linq;
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.DynamicParameters;
using Dapper;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;

namespace AT.AT2017.Api.Repositories
{
    public class BankTransactionRepository : BaseRepository, IBankTransactionRepository
    {

        public BankTransactionRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<BankTransaction> IBankTransactionRepository.searchNoClassifed(DateTime? dateFrom, DateTime? dateTo, int companyID, int bankAccountID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<BankTransaction>("bank_transaction_search_not_classified",
                 new
                 {
                     dateFrom,
                     dateTo,
                     companyID,
                     bankAccountID
                 },
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<BankTransaction> IBankTransactionRepository.searchClassifed(DateTime? dateFrom, DateTime? dateTo, int companyID, int bankAccountID, string status, int linkedAccountID, int bankAccountLinkedGLAcctID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<BankTransaction>("bank_transaction_search_classified",
                 new
                 {
                     dateFrom,
                     dateTo,
                     companyID,
                     bankAccountID,
                     status,
                     linkedAccountID,
                     bankAccountLinkedGLAcctID
                 },
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<BankTransaction> IBankTransactionRepository.searchMatchesRecords(int ruleId, bool isApply, bool applyAllEntries)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<BankTransaction>("bank_transaction_search_matches_records",
                 new
                 {
                     ruleId,
                     isApply,
                     applyAllEntries
                 },
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<BankTransaction> IBankTransactionRepository.searchChildTransactions(int parentID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<BankTransaction>("bank_transaction_search_child_transactions",
                 new
                 {
                     parentID,
                 },
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<GLAccount> IBankTransactionRepository.searchGLAccount(string transactionType)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<GLAccount>("bank_transaction_search_glaccount", new { transactionType = transactionType }, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        void IBankTransactionRepository.classify(BankTransaction item, bool createAsRule, string condition)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("bank_transaction_classify",
                    new
                    {
                        item.transactionID,
                        item.linkedAccountID,
                        item.linkedOfficeID,
                        item.linkedDivisionID,
                        item.linkedPersonID,
                        createAsRule,
                        condition,
                        item.memo 
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IBankTransactionRepository.approve(List<BankTransaction> transactions)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                var bankTransactionUpdateParameter = new BankTransactionPostDynamicParameter(transactions);
                connection.Execute(
                    "bank_transaction_approve",
                    bankTransactionUpdateParameter,
                    commandType: CommandType.StoredProcedure,
                    commandTimeout: 0);
            }
        }

        void IBankTransactionRepository.post(List<BankTransaction> transactions)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                var bankTransactionUpdateParameter = new BankTransactionPostDynamicParameter(transactions);
                connection.Execute(
                    "bank_transaction_post",
                    bankTransactionUpdateParameter,
                    commandType: CommandType.StoredProcedure,
                    commandTimeout: 0);
            }
        }
        
        void IBankTransactionRepository.split(int transactionID, List<BankTransaction> childTransactions, bool createAsRule, String memo)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                var bankTransactionSplitParameter = new BankTransactionSplitDynamicParameter(transactionID, childTransactions, createAsRule,memo);
                connection.Execute(
                    "bank_transaction_split",
                    bankTransactionSplitParameter,
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IBankTransactionRepository.unsplit(int transactionID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute(
                    "bank_transaction_unsplit",
                    new
                    {
                        transactionID
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        BankTransaction IBankTransactionRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<BankTransaction>("bank_transaction_get", new { transactionID = id }, commandType: CommandType.StoredProcedure);
            }
        }

        void IBankTransactionRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("bank_transaction_delete", new { transactionID = id }, commandType: CommandType.StoredProcedure);
            }
        }
    }
}

```
## BaseRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Core.Shared;
using Dapper;
using Microsoft.AspNetCore.Hosting;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using System;
using System.Collections.Generic;
using System.Data;
using System.Data.SqlClient;
using System.Linq;
using System.Reflection;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public class BaseRepository
    {
        protected ApplicationSettings _appSettings;
        private ModelValidator _validator;
        private IHttpContextAccessor _context;
        private IHostingEnvironment _env;

        public BaseRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings)
        {
            _context = httpContextAccessor;
            _appSettings = appSettings.Value;
        }

        public BaseRepository(IHttpContextAccessor httpContextAccessor, IHostingEnvironment env, IOptions<ApplicationSettings> appSettings)
        {
            _context = httpContextAccessor;
            _appSettings = appSettings.Value;
            _env = env;
        }

        protected Credentials credentials
        {
            get
            {
                Credentials _credentials = new Credentials();
                _credentials.adminServer = _appSettings.AdminServer;
                _credentials.adminDatabase = _appSettings.AdminDatabase;
                _credentials.adminUser = _appSettings.AdminUser;
                _credentials.adminPassword = _appSettings.AdminPassword;
                if (_context.HttpContext.User.FindFirst("server") != null)
                {
                    _credentials.serverName = _context.HttpContext.User.FindFirst("server").Value;
                }
                if (_context.HttpContext.User.FindFirst("database") != null)
                {
                    _credentials.dbName = _context.HttpContext.User.FindFirst("database").Value;
                }
                if (_context.HttpContext.User.FindFirst("userName") != null)
                {
                    _credentials.userName = _context.HttpContext.User.FindFirst("userName").Value;
                }
                if (_context.HttpContext.User.FindFirst("password") != null)
                {
                    _credentials.userPassword = _context.HttpContext.User.FindFirst("password").Value;
                }
                return _credentials;
            }
        }

        protected string adminServer
        {
            get
            {
                return _appSettings.AdminServer;
            }
        }

        protected string adminDatabase
        {
            get
            {
                return _appSettings.AdminDatabase;
            }
        }

        protected string adminUser
        {
            get
            {
                return _appSettings.AdminUser;
            }
        }

        protected string adminPassword
        {
            get
            {
                return _appSettings.AdminPassword;
            }
        }

        protected string serverNameContext
        {
            get
            {
                return _context.HttpContext.User.FindFirst("server").Value;
            }
        }

        protected string dbNameContext
        {
            get
            {
                return _context.HttpContext.User.FindFirst("database").Value;
            }
        }

        protected string userNameContext
        {
            get
            {
                return _context.HttpContext.User.FindFirst("userName").Value;
            }
        }

        protected string userPasswordContext
        {
            get
            {
                return _context.HttpContext.User.FindFirst("password").Value;
            }
        }

        protected string connectionString
        {
            get
            {
                var userName = _context.HttpContext.User.FindFirst("userName").Value;
                var password = _context.HttpContext.User.FindFirst("password").Value;
                var database = _context.HttpContext.User.FindFirst("database").Value;
                var server = _context.HttpContext.User.FindFirst("server").Value;

                return string.Format("Server={0};Database={1};User Id={2};Password={3};Max Pool Size=1024;Pooling=true;Application Name=AT2017;Connection Timeout=60;", server, database, userName, password);

            }
        }

        protected string saConnectionString
        {
            get
            {
                var userName = _appSettings.AdminUser;
                var password = _appSettings.AdminPassword;
                var database = _context.HttpContext.User.FindFirst("database").Value;
                var server = _context.HttpContext.User.FindFirst("server").Value;

                return string.Format("Server={0};Database={1};User Id={2};Password={3};Max Pool Size=1024;Pooling=true;Application Name=AT2017;Connection Timeout=60;", server, database, userName, password);

            }
        }

        protected string adminConnectionString
        {
            get
            {
                var userName = _context.HttpContext.User.FindFirst("userName").Value;
                var password = _context.HttpContext.User.FindFirst("password").Value;
                var server = _appSettings.AdminServer;
                var database = _appSettings.AdminDatabase;

                return string.Format("Server={0};Database={1};User Id={2};Password={3};Max Pool Size=1024;Pooling=true;Application Name=AT2017;Connection Timeout=60;", server, database, userName, password);

            }
        }

        protected string saAdminConnectionString
        {
            get
            {
                var userName = _appSettings.AdminUser;
                var password = _appSettings.AdminPassword;
                var server = _appSettings.AdminServer;
                var database = _appSettings.AdminDatabase;

                string cnnString = string.Format("Server={0};Database={1};User Id={2};Password={3};Max Pool Size=1024;Pooling=true;Application Name=AT2017;Connection Timeout=60;", server, database, userName, password);

                return cnnString;

            }
        }

        protected string saSubmissionConnectionString
        {
            get
            {
                var userName = _appSettings.AdminUser;
                var password = _appSettings.AdminPassword;
                var server = _appSettings.SubmissionServer;
                var database = _context.HttpContext.User.FindFirst("dbSubmission").Value;

                string cnnString = string.Format("Server={0};Database={1};User Id={2};Password={3};Max Pool Size=1024;Pooling=true;Application Name=AT2017;Connection Timeout=60;", server, database, userName, password);

                return cnnString;

            }
        }

        public string appInsightsConnectionString
        {
            get
            {
                var userName = _appSettings.AdminUser;
                var password = _appSettings.AdminPassword;
                var server = _appSettings.AdminServer;
                var database = _appSettings.AppInsightsDatabase;

                return string.Format("Server={0};Database={1};User Id={2};Password={3};Max Pool Size=1024;Pooling=true;Application Name=AT2017;Connection Timeout=60;", server, database, userName, password);

            }
        }

        public string agentBooksConnectionString
        {
            get
            {
                var userName = _context.HttpContext.User.FindFirst("userName").Value;
                var password = _context.HttpContext.User.FindFirst("password").Value;
                var server = _appSettings.AgentBooksServer;
                var database = _appSettings.AgentBooksDatabase;

                return string.Format("Server={0};Database={1};User Id={2};Password={3};Max Pool Size=1024;Pooling=true;Application Name=AgentBooks;Connection Timeout=60;", server, database, userName, password);

            }
        }

        public string saAgentBooksConnectionString
        {
            get
            {
                var userName = _appSettings.AdminUser;
                var password = _appSettings.AdminPassword;
                var server = _appSettings.AgentBooksServer;
                var database = _appSettings.AgentBooksDatabase;

                return string.Format("Server={0};Database={1};User Id={2};Password={3};Max Pool Size=1024;Pooling=true;Application Name=AgentBooks;Connection Timeout=60;", server, database, userName, password);

            }
        }

        public void isValid(object model)
        {
            using (SqlConnection connection = new SqlConnection(connectionString))
            {

                // get all uiValidation
                Type objType = model.GetType();
                string table = objType.Name;
                List<UIValidation> rules = connection.Query<UIValidation>("uivalidation_search", new { table = table }, commandType: CommandType.StoredProcedure).ToList();
                List<object> detail = null;

                // if model has detail property
                if (objType.GetProperty("detail") != null)
                {
                    PropertyInfo obj = objType.GetProperty("detail");
                    if (typeof(IEnumerable<object>).IsAssignableFrom(obj.GetValue(model, null).GetType()))
                    {
                        detail = ((IEnumerable<object>)obj.GetValue(model, null)).ToList();
                        if (detail.Count > 0)
                        {
                            table = detail[0].GetType().Name;
                            List<UIValidation> rulesDet = connection.Query<UIValidation>("uivalidation_search", new { table = table }, commandType: CommandType.StoredProcedure).ToList();
                            rules.AddRange(rulesDet);
                        }
                    }

                }

                // init validator
                _validator = new ModelValidator(rules);
                _validator.IsValid(model, detail);
            }
        }

        public string saCustomConnectionString(string serverName, string dbName)
        {

            var userName = _appSettings.AdminUser;
            var password = _appSettings.AdminPassword;
            var database = dbName;
            var server = serverName;

            return string.Format("Server={0};Database={1};User Id={2};Password={3};Max Pool Size=1024;Pooling=true;Application Name=AT2017;Connection Timeout=60;", server, database, userName, password);

        }

    }
}

```
## BillingGroupRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using AT.AT2017.Api.DynamicParameters;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class BillingGroupRepository : BaseRepository, IBillingGroupRepository
    {
        public BillingGroupRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<BillingGroup> IBillingGroupRepository.search(int companyId, int hasDetail)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<BillingGroup>("billingGroup_search", new {companyId = companyId, hasDetail = hasDetail }, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<BillingGroupOffice> IBillingGroupRepository.searchOffices(BillingGroup item, string option)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                var billingGroupParameter = new BillingGroupOfficeDynamicParameter(item, option);

                return connection.Query<BillingGroupOffice>("billingGroupOffice_search", billingGroupParameter, commandType: CommandType.StoredProcedure).ToList();
            }          
        }

        int IBillingGroupRepository.add(BillingGroup item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                var billingGroupParameter = new BillingGroupOfficeDynamicParameter(item, "");

                return connection.ExecuteScalar<int>("billingGroup_add", billingGroupParameter, commandType: CommandType.StoredProcedure);
            }
        }

        BillingGroup IBillingGroupRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                BillingGroup billingGroup = null;
                try
                {
                    using (var multi = connection.QueryMultiple("billingGroup_get", new { id = id }, commandType: CommandType.StoredProcedure))
                    {
                        billingGroup = multi.Read<BillingGroup>().Single();
                        billingGroup.detail = multi.Read<BillingGroupOffice>().ToList();
                    }
                }
                catch (Exception ex)
                {
                    if (ex.Message != "Sequence contains no elements")
                        throw ex;
                }

                return billingGroup;
            }
        }

        void IBillingGroupRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("billingGroup_delete", new { id = id }, commandType: CommandType.StoredProcedure);
            }
        }

        void IBillingGroupRepository.update(BillingGroup item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                var billingGroupParameter = new BillingGroupOfficeDynamicParameter(item,"");

                int id = connection.ExecuteScalar<int>("billingGroup_update", billingGroupParameter, commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## BillingItemRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class BillingItemRepository : BaseRepository, IBillingItemRepository
    {
        public BillingItemRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<BillingItem> IBillingItemRepository.search()
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<BillingItem>("billingitem_search", null, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        BillingItem IBillingItemRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<BillingItem>("billingitem_get", new { billingItemId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int IBillingItemRepository.add(BillingItem item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("billingitem_add",
                    new
                    {
                        description = item.description,
                        accountID = item.accountId,
                        amount = item.amount,
                        sortOrder = item.sortOrder,
                        include = item.include,
                        item.orderTypeId
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IBillingItemRepository.update(BillingItem item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("billingitem_update",
                    new
                    {
                        billingItemId = item.billingItemId,
                        description = item.description,
                        accountID = item.accountId,
                        amount = item.amount,
                        sortOrder = item.sortOrder,
                        include = item.include,
                        item.orderTypeId
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IBillingItemRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("billingitem_delete", new { billingItemId = id }, commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## BudgetDetailRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class BudgetDetailRepository : BaseRepository, IBudgetDetailRepository
    {
        public BudgetDetailRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }


        //IEnumerable<BudgetDetail> IBudgetDetailRepository.search()
        //{
        //    using (SqlConnection connection = new SqlConnection(base.connectionString))
        //    {
        //        return connection.Query<BudgetDetail>("budget_detail_search", null, commandType: CommandType.StoredProcedure).ToList();
        //    }
        //}

        BudgetDetail IBudgetDetailRepository.get(int budgetID, int officeID, int personid, int year,int accountID, decimal totalGoalYear)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<BudgetDetail>("budget_detail_get", 
                    new {
                        budgetId = budgetID,
                        officeID,
                        personid,
                        year,
                        accountID,
                        totalGoalYear
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IBudgetDetailRepository.add(BudgetDetail item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("budget_detail_add",
                     new
                     {
                         budgetId = item.budgetID,
                         officeID = item.officeID,
                         personid = item.agent_PersonID,
                         year = item.year,
                         accountID = item.accountID,
                         Jan=item.Jan,
                         Feb = item.Feb,
                         Mar = item.Mar,
                         Apr = item.Apr,
                         May = item.May,
                         Jun = item.Jun,
                         Jul = item.Jul,
                         Aug = item.Aug,
                         Sep = item.Sep,
                         Oct = item.Oct,
                         Nov = item.Nov,
                         Dec = item.Dec

                     },
                     commandType: CommandType.StoredProcedure);
                
            }
        }

        void IBudgetDetailRepository.update(BudgetDetail item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("budget_detail_update",
                     new
                     {
                         budgetId = item.budgetID,
                         officeID = item.officeID,
                         personid = item.agent_PersonID,
                         year = item.year,
                         accountID = item.accountID,
                         Jan = item.Jan,
                         Feb = item.Feb,
                         Mar = item.Mar,
                         Apr = item.Apr,
                         May = item.May,
                         Jun = item.Jun,
                         Jul = item.Jul,
                         Aug = item.Aug,
                         Sep = item.Sep,
                         Oct = item.Oct,
                         Nov = item.Nov,
                         Dec = item.Dec

                     },
                     commandType: CommandType.StoredProcedure);
            }
        }

        void IBudgetDetailRepository.delete(int budgetID, int officeID, int personid, int year,int accountID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("budget_detail_delete", 
                    new {
                        budgetId = budgetID,
                        officeID = officeID,
                        personid = personid,
                        year = year,
                        accountID = accountID,
                    }, 
                    commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## BudgetRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class BudgetRepository : BaseRepository, IBudgetRepository
    {
        public BudgetRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        //IEnumerable<Budget> IBudgetRepository.search(int companyId, int accountId, int officeId, int year, int month)
        //{
        //    using (SqlConnection connection = new SqlConnection(base.connectionString))
        //    {
        //        return connection.Query<Budget>("budget_search",
        //         new
        //         {
        //             companyId = companyId,
        //             accountId = accountId,
        //             officeId = officeId,
        //             year = year,
        //             month = month
        //         },
        //         commandType: CommandType.StoredProcedure).ToList();
        //    }
        //}

        //Budget IBudgetRepository.get(int id)
        //{
        //    using (SqlConnection connection = new SqlConnection(base.connectionString))
        //    {
        //        return connection.QueryFirstOrDefault<Budget>("budget_get", new { budgetId = id }, commandType: CommandType.StoredProcedure);
        //    }
        //}

        //int IBudgetRepository.add(Budget item)
        //{
        //    using (SqlConnection connection = new SqlConnection(base.connectionString))
        //    {
        //        int id = connection.ExecuteScalar<int>("budget_add",
        //            new
        //            {
        //                accountId = item.accountId,
        //                officeId = item.officeId,
        //                year = item.year,
        //                month = item.month,
        //                amount = item.amount,
        //                companyId = item.companyId
        //            },
        //            commandType: CommandType.StoredProcedure);

        //        return id;
        //    }
        //}

        //void IBudgetRepository.update(Budget item)
        //{
        //    using (SqlConnection connection = new SqlConnection(base.connectionString))
        //    {
        //        int id = connection.ExecuteScalar<int>("budget_update",
        //             new
        //             {
        //                 budgetId = item.budgetId,
        //                 accountId = item.accountId,
        //                 officeId = item.officeId,
        //                 year = item.year,
        //                 month = item.month,
        //                 amount = item.amount
        //             },
        //             commandType: CommandType.StoredProcedure);
        //    }
        //}

        //void IBudgetRepository.delete(int id)
        //{
        //    using (SqlConnection connection = new SqlConnection(base.connectionString))
        //    {
        //        connection.Execute("budget_delete", new { budgetId = id }, commandType: CommandType.StoredProcedure);
        //    }
        //}


        IEnumerable<Budget> IBudgetRepository.search()
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<Budget>("budget_search", null, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        Budget IBudgetRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<Budget>("budget_get", new { budgetId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        Budget IBudgetRepository.getbydescription(string desc)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<Budget>("budget_get_budgetType_byGoalTable", new { goalTable = desc }, commandType: CommandType.StoredProcedure);
            }
        }

        int IBudgetRepository.add(Budget item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("budget_add",
                    new
                    {
                        accountId = item.name,
                        budgetType=item.budgetType

                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IBudgetRepository.update(Budget item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("budget_update",
                     new
                     {
                         budgetId = item.name,
                         budgetType = item.budgetType

                     },
                     commandType: CommandType.StoredProcedure);
            }
        }

        void IBudgetRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("budget_delete", new { budgetId = id }, commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## BudgetYearRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class BudgetYearRepository : BaseRepository, IBudgetYearRepository
    {
        public BudgetYearRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<BudgetYear> IBudgetYearRepository.search(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<BudgetYear>("budget_year_search", new { budgetId = id }, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<BudgetYear> IBudgetYearRepository.add()
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<BudgetYear>("budget_year_add", null, commandType: CommandType.StoredProcedure).ToList(); 
            }
        }

    }
}

```
## CampaignCompanyRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class CampaignCompanyRepository : BaseRepository, ICampaignCompanyRepository
    {
        public CampaignCompanyRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<CampaignCompany> ICampaignCompanyRepository.search()
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<CampaignCompany>("campaign_company_search", null, commandType: CommandType.StoredProcedure).ToList();
            }

        }

    }
}

```
## CampaignDatasourceRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class campaigndatasourceRepository : BaseRepository, IcampaigndatasourceRepository
    {
        public campaigndatasourceRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

         IEnumerable<campaigndatasource> IcampaigndatasourceRepository.search()
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<campaigndatasource>("campaign_datasource_search", null, commandType: CommandType.StoredProcedure).ToList();
            }

        }

        IEnumerable<CodeValue> IcampaigndatasourceRepository.searchTypes(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<CodeValue>("campaign_dateType_search", new { datasourceID = id }, commandType: CommandType.StoredProcedure);
            }
        }

        IEnumerable<CodeValue> IcampaigndatasourceRepository.searchOrderTypes(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<CodeValue>("campaign_orderType_search", new { datasourceID = id }, commandType: CommandType.StoredProcedure);
            }
        }


    }
}

```
## CampaignDateRangeRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class CampaignDateRangeRepository : BaseRepository, ICampaignDateRangeRepository
    {
        public CampaignDateRangeRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<CampaignDateRange> ICampaignDateRangeRepository.search()
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<CampaignDateRange>("campaign_daterange_search", null, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        //CampaignDateRange ICampaignDateRangeRepository.get(int id)
        //{
        //    using (SqlConnection connection = new SqlConnection(base.connectionString))
        //    {
        //        return connection.QueryFirstOrDefault<CampaignDateRange>("campaign_daterange_get", new { DateRangeId = id }, commandType: CommandType.StoredProcedure);
        //    }
        //}


    }
}

```
## CampaignDateTypeRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class CampaignDateTypeRepository : BaseRepository, ICampaignDateTypeRepository
    {
        public CampaignDateTypeRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<CampaignDateType> ICampaignDateTypeRepository.search(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<CampaignDateType>("campaign_dateType_search", new { dataSourceID = id }, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        //CampaignDateType ICampaignDateTypeRepository.get(int id)
        //{
        //    using (SqlConnection connection = new SqlConnection(base.connectionString))
        //    {
        //        return connection.QueryFirstOrDefault<CampaignDateType>("campaign_dateType_get", new { dateTypeID = id }, commandType: CommandType.StoredProcedure);
        //    }
        //}
    }
}

```
## CampaignLogRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class CampaignLogRepository : BaseRepository, ICampaignLogRepository
    {
        public CampaignLogRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<CampaignLog> ICampaignLogRepository.search(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<CampaignLog>("campaign_log_search_ByCampaignID", new { campaignID = id }, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<EmailLog> ICampaignLogRepository.searchDetail(int id,string result)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<EmailLog>("campaign_logDetail_search", new { id = id, result = result }, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        CampaignLog ICampaignLogRepository.get(int campaignLogID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<CampaignLog>("campaign_log_get", new { campaignLogID }, commandType: CommandType.StoredProcedure);
            }
        }

        public void resendDetail(int emailLogId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("[campaign_logDetail_resend]", new { emailLogID = emailLogId }, commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## CampaignOfficeRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class CampaignOfficeRepository : BaseRepository, ICampaignOfficeRepository
    {
        public CampaignOfficeRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<CampaignOffice> ICampaignOfficeRepository.search(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<CampaignOffice>("campaign_office_search", new { companyID = id }, commandType: CommandType.StoredProcedure).ToList();
            }
        }
    
    }
}

```
## CampaignRecipientListDetailRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class CampaignRecipientListDetailRepository : BaseRepository, ICampaignRecipientListDetailRepository
    {

        public CampaignRecipientListDetailRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<CampaignRecipientListDetail> ICampaignRecipientListDetailRepository.search(int id, int personId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<CampaignRecipientListDetail>("campaign_recipientListDetail_search", new {
                    recipientListId = id,
                    personId = personId
                }, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<CampaignRecipientListDetail> ICampaignRecipientListDetailRepository.searchByProperty(int recipientListID, int propertyID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<CampaignRecipientListDetail>("campaign_recipientListDetail_search_by_property", new {
                        recipientListID,
                        propertyID
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        int ICampaignRecipientListDetailRepository.add(CampaignRecipientListDetail item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("campaign_recipientListDetail_add",
                    new
                    {

                        RecipientListID = item.RecipientListID,
                        personId = item.personID,
                        userID = item.userID

                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void ICampaignRecipientListDetailRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("campaign_recipientListDetail_delete", new { RecipientListDetailId = id }, commandType: CommandType.StoredProcedure);
            }
        }
    }

}

```
## CampaignRecipientListRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class CampaignRecipientListRepository : BaseRepository, ICampaignRecipientListRepository
    {
        public CampaignRecipientListRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<CampaignRecipientList> ICampaignRecipientListRepository.search()
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<CampaignRecipientList>("campaign_recipientList_search", null, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        CampaignRecipientList ICampaignRecipientListRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<CampaignRecipientList>("campaign_recipientList_get", new { recipientListId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int ICampaignRecipientListRepository.add(CampaignRecipientList item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("campaign_recipientList_add",
                    new
                    {

                        name = item.name                        
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void ICampaignRecipientListRepository.update(CampaignRecipientList item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("campaign_recipientList_update",
                     new
                     {

                         recipientListID = item.RecipientListID,
                         name = item.name
                     },
                     commandType: CommandType.StoredProcedure);
            }
        }

        void ICampaignRecipientListRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("campaign_recipientList_delete", new { recipientListId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        void ICampaignRecipientListRepository.refresh(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("campaign_recipientList_refresh", new { recipientListId = id }, commandType: CommandType.StoredProcedure);
            }
        }
    }
}

```
## CampaignRecipientTypeRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;


namespace AT.AT2017.Api.Repositories
{
    public class CampaignRecipientTypeRepository : BaseRepository, ICampaignRecipientTypeRepository
    {
        public CampaignRecipientTypeRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<CampaignRecipientType> ICampaignRecipientTypeRepository.search()
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<CampaignRecipientType>("campaign_recipientType_search", null, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        //CampaignRecipientType ICampaignRecipientTypeRepository.get(int id)
        //{
        //    using (SqlConnection connection = new SqlConnection(base.connectionString))
        //    {
        //        return connection.QueryFirstOrDefault<CampaignRecipientType>("campaign_recipientType_get", new { recipientTypeID = id }, commandType: CommandType.StoredProcedure);
        //    }
        //}
    }
}

```
## CampaignReportParametersRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class CampaignReportParametersRepository : BaseRepository, ICampaignReportParametersRepository
    {
        public CampaignReportParametersRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<CampaignReportParameters> ICampaignReportParametersRepository.searchintblreportparameter(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<CampaignReportParameters>("campaign_tbl_reportparameter_search", new { reportID = id }, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<CampaignReportParameters> ICampaignReportParametersRepository.searchincmpreportparameter(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<CampaignReportParameters>("campaign_cmp_reportparameter_search", new { campaignID = id }, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        void ICampaignReportParametersRepository.add(CampaignReportParameters item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("campaign_reportparameter_add",
                     new
                     {

                         campaignID = item.campaignID,
                         reportID = item.reportID,
                         parameterID=item.parameterID,
                         defaultValue=item.defaultValue

                     },
                     commandType: CommandType.StoredProcedure);
            }
        }

        void ICampaignReportParametersRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("campaign_reportparameter_delete", new { campaignId = id }, commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## CampaignReportRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class CampaignReportRepository : BaseRepository, ICampaignReportRepository
    {
        public CampaignReportRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<CampaignReport> ICampaignReportRepository.search(string linkFieldName )
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<CampaignReport>("campaign_report_search", new { linkFieldName = linkFieldName }, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        int ICampaignReportRepository.update(ReportCustom item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int value = connection.ExecuteScalar<int>("campaign_report_update",
                    new
                    {
                        reportID = item.reportId,
                        reportBaseID = item.reportBaseId,
                        name = item.name,
                        columns = item.columnsParam,
                        parameters = item.parametersParam,
                        groups = item.groupsParam,
                        overrides = item.overrides
                    },
                    commandType: CommandType.StoredProcedure);

                return value;
            }
        }
    }
}

```
## CampaignRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;
using Hangfire;
using AT.AT2017.Api.Util;
using System.Net.Mail;
using System.ComponentModel.DataAnnotations;

namespace AT.AT2017.Api.Repositories
{
    public class CampaignRepository : BaseRepository, ICampaignRepository
    {

        private IBackgroundJobClient _backgroundJobs;

        public CampaignRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings, IBackgroundJobClient backgroundJobs) : base(httpContextAccessor, appSettings)
        {
            _backgroundJobs = backgroundJobs;
        }

        IEnumerable<Campaign> ICampaignRepository.search(string isPropertyRelated, string documentRelated)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<Campaign>("campaign_search", new { isPropertyRelated, documentRelated }, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<CampaignMergeField> ICampaignRepository.searchMergeFields(int id, string full)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<CampaignMergeField>("campaign_search_mergefields",
                new
                {
                    dataSourceID = id,full =full
                },
                commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<CampaignFunction> ICampaignRepository.searchFunctions(string type)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<CampaignFunction>("campaign_function_search", new { type = type }, commandType: CommandType.StoredProcedure).ToList();
            }

        }

        Campaign ICampaignRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<Campaign>("campaign_get", new { campaignId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int ICampaignRepository.add(Campaign item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("campaign_add",
                    new
                    {
                        name=item.name
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        int ICampaignRepository.copy(int id,string name)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int newId = connection.ExecuteScalar<int>("campaign_copy",
                    new
                    {
                        campaignId = id,
                        name= name
                    },
                    commandType: CommandType.StoredProcedure);

                return newId;
            }
        }

        void ICampaignRepository.update(Campaign item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("campaign_update",
                     new
                     {
                         campaignId = item.campaignID,
                         item.name,
                         item.datasourceID,
                         item.recipientID,
                         item.dateRangeID,
                         item.dateTypeField,
                         item.reportID,
                         item.criteria,
                         item.reportLabel,                                        
                         item.startDate,
                         item.endDate,
                         item.companyID,
                         item.officeID,                        
                         item.generalNotes,
                         item.createUniqueReportLink,
                         item.template,
                         item.emailBCC,
                         item.emailCC,
                         item.subject,
                         item.linkMode,
                         item.datasourceField,
                         item.recipientField,
                         item.emailFrom,
                         item.emailReplyTo,
                         item.regionID,
                         item.orderTypeID 
                     },
                     commandType: CommandType.StoredProcedure);
            }
        }

        void ICampaignRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("campaign_delete", new { campaignId = id }, commandType: CommandType.StoredProcedure);
            }
        }       
        
        DataTable ICampaignRepository.execute(int id, string execution_Type, string email, int propertyID , string personID, bool preview)
        {
            DataTable dt = new DataTable();

            // execute repcube incremental update
            using (SqlConnection connection = new SqlConnection(base.saConnectionString))
            {
                // execute incremental update if needed
                connection.Execute("campaign_execute_incremental_by_ids",
                    new {
                        campaignIDList = id,
                    },
                    commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }

            // execute campaign
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                SqlCommand command = new SqlCommand("campaign_execute_on_scheduled", connection);
                
                command.CommandType = CommandType.StoredProcedure;
                command.CommandTimeout = 0;

                SqlParameter p;
                p = command.Parameters.Add("@campaignID", SqlDbType.Int);
                p.Value = id;
                p = command.Parameters.Add("@execution_Type", SqlDbType.NVarChar,50);
                p.Value = execution_Type;
                p = command.Parameters.Add("@emailForTesting ", SqlDbType.NVarChar, 500);
                p.Value = email;
                p = command.Parameters.Add("@propertyID", SqlDbType.Int);
                p.Value = propertyID;
                if (personID != "")
                {
                    p = command.Parameters.Add("@personID", SqlDbType.VarChar);
                    p.Value = personID;
                }               
                p = command.Parameters.Add("@preview ", SqlDbType.Bit);
                p.Value = (preview == true) ? 1 : 0 ;               

                connection.Open();
                SqlDataReader reader = command.ExecuteReader();
                dt.Load(reader);
                reader.Close();

            }
            return dt;
        }

        int ICampaignRepository.runOnDemand(int campaignID, string emailForTesting, int propertyID, string personID, int documentID)
        {
            int campaignLogID = 0;

            // set executionType
            string executionType = "on-demand";
            if (!string.IsNullOrEmpty(emailForTesting))
            {
                executionType = "run test";
            }

            // create EmailSenderCredentials variable
            EmailSenderCredentials credentials = new EmailSenderCredentials();
            credentials.adminUser = _appSettings.AdminUser;
            credentials.adminPassword = _appSettings.AdminPassword;
            credentials.adminServer = _appSettings.AdminServer;
            credentials.adminDatabase = _appSettings.AdminDatabase;
            credentials.emailHost = _appSettings.EmailHost;
            credentials.emailPort = _appSettings.EmailPort;
            credentials.emailUserName = _appSettings.EmailUserName;
            credentials.emailPassword = _appSettings.EmailPassword;

            using (SqlConnection connection = new SqlConnection(base.connectionString)) {

                // start campaing execution
                campaignLogID = connection.ExecuteScalar<int>("campaign_execute_start ",
                    new { campaignID, executionType }, commandType: CommandType.StoredProcedure);

                // start a background worker
                _backgroundJobs.Enqueue(() => runOnDemandAsync(campaignID, campaignLogID, executionType, emailForTesting, propertyID, personID, connectionString, saConnectionString, documentID, credentials));

            }
            return campaignLogID;
        }

        public void runOnDemandAsync(int campaignID, int campaignLogID, string executionType, string emailForTesting, int propertyID, string personID, string connectionString, string saConnectionString, int documentID, EmailSenderCredentials credentials)
        {

            // execute incremental update if needed
            using (SqlConnection connection = new SqlConnection(saConnectionString))
            {
                connection.Execute("campaign_execute_incremental",
                    new { campaignLogID },
                    commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }

            using (SqlConnection connection = new SqlConnection(connectionString))
            {
                // get list of email to send (emailLog table)
                List<EmailLog> emailList = connection.Query<EmailLog>("campaign_execute_on_scheduled",
                    new
                    {
                        campaignID,
                        execution_Type = executionType,
                        preview = 0,
                        emailForTesting,
                        propertyID,
                        personID,                        
                        campaignLogID,
                        documentID
                    }, commandType: CommandType.StoredProcedure, commandTimeout: 0).ToList();

                string errorMessage;
                foreach (var email in emailList)
                {
                    errorMessage = "";

                    bool result = sendEmail(email.subject, email.message, email.emailFrom, email.emailReplyTo, email.to, email.sendToName, email.toCC, email.toBCC, credentials, ref errorMessage);

                    connection.ExecuteScalar("campaign_update_email_log_result",
                        new
                        {
                            email.emailLogID,
                            result = result ? "S" : "F",
                            errorMessage
                        }
                        , commandType: CommandType.StoredProcedure);
                }
                // refresh campaignlog
                connection.Execute("campaign_execute_refreshLog", new { campaignLogID }, commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }

        DataTable ICampaignRepository.validate(int id)
        {
            DataTable dt = new DataTable();

            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                SqlCommand command = new SqlCommand("campaign_validate", connection);
                command.CommandType = CommandType.StoredProcedure;
                command.CommandTimeout = 0;

                SqlParameter p;
                p = command.Parameters.Add("@campaignID", SqlDbType.Int);
                p.Value = id;
                p = command.Parameters.Add("@showErrors", SqlDbType.Bit);
                p.Value = 1;

                connection.Open();
                SqlDataReader reader = command.ExecuteReader();
                dt.Load(reader);
                reader.Close();

            }
            return dt;
        }

        void ICampaignRepository.exportToMaster(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("campaign_export_to_master", new { campaignID = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int ICampaignRepository.importFromMaster(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {             

                int newid = connection.ExecuteScalar<int>("campaign_import_from_master",
                   new
                   {
                       campaignID = id
                   },
                   commandType: CommandType.StoredProcedure);

                return newid;
            }
        }

        IEnumerable<Campaign> ICampaignRepository.searchFromMaster()
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<Campaign>("campaign_search_from_master", null, commandType: CommandType.StoredProcedure).ToList();
            }
        }
        
        public static bool sendEmail(string subject, string message, string emailFrom, string replyTo, string to, string toName, string CC, string Bcc, EmailSenderCredentials credentials, ref string errorMessage)
        {
            bool result = false;
            try
            {
                MailMessage mail = new MailMessage();
                SmtpClient SmtpServer = new SmtpClient(credentials.emailHost, credentials.emailPort);

                mail.To.Add(new MailAddress(to, toName));
                mail.Subject = subject;
                mail.Body = message;
                mail.IsBodyHtml = true;
                mail.Priority = MailPriority.High;

                // emailFrom => Name <email@domain.com> | email@domain.com
                // ReplyTo, CC and Bcc => Name <email@domain.com>,Name2 <@email2@domain.com>

                // get EmailHost, EmailPort, EmailUserName and EmailPassword from app.setting


                // ReplyTo
                List<MailAddress> replyToList = getMailAddresses(replyTo);
                foreach (var address in replyToList)
                {
                    mail.ReplyToList.Add(address);
                }

                // From
                if (string.IsNullOrEmpty(emailFrom) == false)
                {
                    // get from address
                    MailAddress mailFrom = getMailAddress(emailFrom);
                    // if emailaddress is empty, complete with ReplyTo or darwin@accounttech.com
                    if (mailFrom == null)
                    {
                        // use first ReplyTo mail address is exist
                        if (mail.ReplyToList.Count > 0)
                        {
                            MailAddress firstReplyTo = mail.ReplyToList.First();
                            mail.From = new MailAddress(firstReplyTo.Address, emailFrom);
                        }
                        else
                        {
                            mail.From = new MailAddress("darwin@accounttech.com", emailFrom);
                        }
                    }
                    else
                    {
                        mail.From = mailFrom;
                    }
                }
                else
                {
                    mail.From = new MailAddress("darwin@accounttech.com", "Darwin Campaigns");
                }

                // complete DisplayName from From address
                if (string.IsNullOrWhiteSpace(mail.From.DisplayName))
                {
                    mail.From = new MailAddress(mail.From.Address, "Darwin Campaigns");
                }

                // CC
                List<MailAddress> ccList = getMailAddresses(CC);
                foreach (var address in ccList)
                {
                    mail.CC.Add(address);
                }

                // Bcc
                List<MailAddress> bccList = getMailAddresses(Bcc);
                foreach (var address in bccList)
                {
                    mail.Bcc.Add(address);
                }

                SmtpServer.Credentials = new System.Net.NetworkCredential(credentials.emailUserName, credentials.emailPassword);
                SmtpServer.EnableSsl = true;

                SmtpServer.Send(mail);

                result = true;

            }
            catch (Exception ex)
            {
                errorMessage = ex.Message;
            }
            return result;
        }

        private static bool IsValidEmail(string source)
        {
            return new EmailAddressAttribute().IsValid(source);
        }

        private static MailAddress getMailAddress(string emailAddress)
        {
            string email = "";
            string displayName = "";

            // emailAddress => Name <email@domain.com> | email@domain.com  | <email@domain.com>
            var chunks = emailAddress.Trim().Split(new char[] { '<', '>' });
            if (chunks.Length >= 2)
            {
                displayName = chunks[0].Trim();
                email = chunks[1].Trim();
            }
            else
            {
                // remove '<' and '>' if exists
                emailAddress = emailAddress.Replace("<", "").Replace(">", "");
                if (IsValidEmail(emailAddress))
                {
                    displayName = "";
                    email = emailAddress;
                }
                else
                {
                    email = "";
                    displayName = emailAddress;
                }
            }

            MailAddress result = null;
            if (IsValidEmail(email))
            {
                result = new MailAddress(email, displayName);
            }
            return result;
        }

        private static List<MailAddress> getMailAddresses(string emailAddresses)
        {
            List<MailAddress> addresses = new List<MailAddress>();

            if (string.IsNullOrWhiteSpace(emailAddresses) == false)
            {
                // replace ";" by ","
                emailAddresses = emailAddresses.Trim().Replace(";", ",");

                // split string
                var addressesList = emailAddresses.Split(",").ToList();

                // add mail address
                foreach (var emailAddress in addressesList)
                {
                    if (!string.IsNullOrWhiteSpace(emailAddress))
                    {
                        addresses.Add(getMailAddress(emailAddress));
                    }
                }


            }

            return addresses;
        }

    }
}

```
## CampaignScheduleRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class CampaignScheduleRepository : BaseRepository, ICampaignScheduleRepository
    {
        public CampaignScheduleRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }
        IEnumerable<CampaignSchedule> ICampaignScheduleRepository.search(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<CampaignSchedule>("campaign_schedule_search", new { campaignID = id }, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        CampaignSchedule ICampaignScheduleRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<CampaignSchedule>("campaign_schedule_get", new { scheduleId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int ICampaignScheduleRepository.add(CampaignSchedule item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("campaign_schedule_add",
                    new
                    {

                        scheduleID=item.scheduleID,
                        name=item.name,
                        campaignID=item.campaignID,
                        frecuency=item.frecuency,
                        dayOfWeek=item.dayOfWeek,
                        startIn=item.startIn,
                        nDays=item.nDays,
                        time=item.time,
                        active = item.active 
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void ICampaignScheduleRepository.update(CampaignSchedule item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("campaign_schedule_update",
                     new
                     {
                         scheduleID = item.scheduleID,
                         name = item.name,
                         campaignID = item.campaignID,
                         frecuency = item.frecuency,
                         dayOfWeek = item.dayOfWeek,
                         startIn = item.startIn,
                         nDays = item.nDays,
                         time = item.time,
                         active = item.active
                     },
                     commandType: CommandType.StoredProcedure);
            }
        }

        void ICampaignScheduleRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("campaign_schedule_delete", new { scheduleID = id }, commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## CampaignTemplateRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class CampaignTemplateRepository : BaseRepository, ICampaignTemplateRepository

    {
        public CampaignTemplateRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<CampaignTemplate> ICampaignTemplateRepository.search()
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<CampaignTemplate>("campaign_template_search", null, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<CampaignTemplate> ICampaignTemplateRepository.searchbydescription(string desc)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<CampaignTemplate>("campaign_template_search_ByDescription", new { description = desc }, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        CampaignTemplate ICampaignTemplateRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<CampaignTemplate>("campaign_template_get", new { templateId = id }, commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## CategoryRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using Dapper;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using System;
using System.Collections.Generic;
using System.Data;
using System.Data.SqlClient;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public class CategoryRepository : BaseRepository, ICategoryRepository
    {
        public CategoryRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        public int add(Category item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                /*
                    @CategoryDescription varchar(100),
                    @Sort int,
                    @byNumberOrType varchar(20),
	                @GLAccounts varchar(1000)
                 */
                int id = connection.ExecuteScalar<int>("category_add",
                     new
                     {
                         item.CategoryDescription,
                         item.Sort,
                         item.byNumberOrType,
                         item.CapitalExpenditure,
                         GLAccounts = String.Join(",", (from d in item.Detail
                                                        select (d.Multiplier == -1 ? "-" : string.Empty) + d.accountID.ToString()).ToList()),
                     },
                     commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        public void delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("category_delete", new { CategoryID = id }, commandType: CommandType.StoredProcedure);
            }
        }

        public Category get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                Category category;

                using (var multi = connection.QueryMultiple("category_get",
                    new { CategoryID = id },
                    commandType: CommandType.StoredProcedure))
                {
                    category = multi.ReadFirstOrDefault<Category>();
                    category.Detail = multi.Read<CategoryDetail>().ToList();
                }

                return category;
            }
        }

        public IEnumerable<Category> search()
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                List<Category> categories;
                List<CategoryDetail> details;

                using (var multi = connection.QueryMultiple("category_search",
                    null,
                    commandType: CommandType.StoredProcedure))
                {
                    categories = multi.Read<Category>().ToList();
                    details = multi.Read<CategoryDetail>().ToList();
                }

                foreach (var category in categories)
                {
                    category.Detail = ( from d in details
                                        where d.CategoryID == category.CategoryID
                                        select d).ToList();
                }

                return categories;
            }
        }

        public void update(Category item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("category_update",
                     new
                     {
                         item.CategoryID,
                         item.CategoryDescription,
                         item.Sort,
                         item.byNumberOrType,
                         item.CapitalExpenditure,
                         GLAccounts = String.Join(",", (from d in item.Detail
                                                        select (d.Multiplier == -1 ? "-" : string.Empty) + d.accountID.ToString()).ToList()),
                     },
                     commandType: CommandType.StoredProcedure);
            }
        }
    }
}

```
## CertificationGroupRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Data;
using System.Data.SqlClient;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;

namespace AT.AT2017.Api.Repositories
{
    public class CertificationGroupRepository : BaseRepository, ICertificationGroupRepository
    {
        public CertificationGroupRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        public int add(CertificationGroup item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("certificationGroup_add",
                     new
                     {
                         item.GroupName,
                         item.RecordType,
                         Roles = String.Join(",", (from role in item.Roles
                                                   where role.Checked
                                                   select role.RoleID.ToString()).ToList()),
                     },
                     commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        public void delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("certificationGroup_delete", new { CertificationGroupID = id }, commandType: CommandType.StoredProcedure);
            }
        }

        public CertificationGroup get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                CertificationGroup group;

                using (var multi = connection.QueryMultiple("certificationGroup_get",
                    new { CertificationGroupID = id },
                    commandType: CommandType.StoredProcedure))
                {
                    group = multi.ReadFirstOrDefault<CertificationGroup>();
                    group.Roles = multi.Read<CertificationRoles>().ToList();
                }

                return group;
            }
        }

        public IEnumerable<CertificationGroup> search()
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                List<CertificationGroup> groups;
                List<CertificationRoles> roles;

                using (var multi = connection.QueryMultiple("certificationGroup_search",
                    null,
                    commandType: CommandType.StoredProcedure))
                {
                    groups = multi.Read<CertificationGroup>().ToList();
                    roles = multi.Read<CertificationRoles>().ToList();
                }

                foreach (var _group in groups)
                {
                    _group.Roles = (from role in roles
                                   where role.CertificationGroupID == _group.CertificationGroupID
                                   select role).ToList();
                }

                return groups;
            }
        }

        public void update(CertificationGroup item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("certificationGroup_update",
                     new
                     {
                         item.CertificationGroupID,
                         item.GroupName,
                         item.RecordType,
                         Roles = String.Join(",", (from role in item.Roles
                                                   where role.Checked
                                                   select role.RoleID.ToString()).ToList()),
                     },
                     commandType: CommandType.StoredProcedure);
            }
        }
    }
}

```
## CertificationRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Data;
using System.Data.SqlClient;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;

namespace AT.AT2017.Api.Repositories
{
    public class CertificationRepository : BaseRepository, ICertificationRepository
    {
        public CertificationRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        public int add(Certification item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("certification_add",
                     new
                     {
                         item.FunctionalTestNumber,
                         item.FunctionalTestGroupID,
                         item.Name,
                         item.Instructions,
                         item.Link
                     },
                     commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        public void delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("certification_delete", new { CertificationID = id }, commandType: CommandType.StoredProcedure);
            }
        }

        public Certification get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<Certification>("certification_get",
                   new { CertificationId = id },
                   commandType: CommandType.StoredProcedure).FirstOrDefault();
            }
        }

        public IEnumerable<Certification> search(int groupID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<Certification>("certification_search",
                   new { FunctionalTestGroupID = groupID },
                   commandType: CommandType.StoredProcedure).ToList();
            }
        }

        public void update(Certification item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("certification_update",
                     new
                     {
                         item.CertificationID,
                         item.FunctionalTestNumber,
                         item.FunctionalTestGroupID,
                         item.Name,
                         item.Instructions,
                         item.Link,
                     },
                     commandType: CommandType.StoredProcedure);
            }
        }
    }
}
```
## CertificationRoleRequirementRepository.cs
```cs
using System.Collections.Generic;
using System.Linq;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using AT.AT2017.Api.DynamicParameters;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class CertificationRoleRequirementRepository : BaseRepository, ICertificationRoleRequirementRepository
    {
        public CertificationRoleRequirementRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<CertificationRoleRequirement> ICertificationRoleRequirementRepository.search(int certificationId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<CertificationRoleRequirement>("certificationRoleRequirements_search",
                    new { certificationId = certificationId },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }       

        void ICertificationRoleRequirementRepository.update(int certificationId,IEnumerable<CertificationRoleRequirement> table)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                var tableParameter = new CertificationRoleRequirementParameter(certificationId, table);

                int id = connection.ExecuteScalar<int>("certificationRoleRequirements_update", tableParameter, commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }
    }
}

```
## ChatContactRepository.cs
```cs
using Dapper;
using System.Collections.Generic;
using System.Data;
using System.Data.SqlClient;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;

namespace AT.AT2017.Api.Repositories
{
    public class ChatContactRepository : BaseRepository, IChatContactRepository
    {
        public ChatContactRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<ChatContact> IChatContactRepository.search(int roomID)
        {
            // get contacts from chat room
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<ChatContact>("chat_contact_search",
                    new { roomID }, commandType: CommandType.StoredProcedure);
            }
        }
    }
}

```
## ChatMessageRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Data;
using System.Data.SqlClient;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Core.Shared;
using AT.AT2017.Api.Helpers;
using Dapper;
using Hangfire;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Newtonsoft.Json;
using Newtonsoft.Json.Linq;

namespace AT.AT2017.Api.Repositories
{
    public class ChatMessageRepository : BaseRepository, IChatMessageRepository
    {
        private IBackgroundJobClient _backgroundJobs;
        private IHttpContextAccessor _context;

        public ChatMessageRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings, IBackgroundJobClient backgroundJobs) : base(httpContextAccessor, appSettings)
        {
            _backgroundJobs = backgroundJobs;
            _context = httpContextAccessor;
        }

        PagedList<ChatMessage> IChatMessageRepository.search(int roomID, int userID, string query, int pageIndex, int pageSize)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                PagedList<ChatMessage> page = null;

                using (var multi = connection.QueryMultiple("chat_message_search",
                    new
                    {
                        roomID,
                        userID,
                        query,
                        pageIndex,
                        pageSize
                    }, commandType: CommandType.StoredProcedure, commandTimeout: 0))
                {
                    page = multi.Read<PagedList<ChatMessage>>().Single();
                    page.data = multi.Read<ChatMessage>().ToList();

                }
                return page;
            }
        }

        int IChatMessageRepository.add(ChatMessage item, bool sendSMSEnabled)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int messageID = connection.ExecuteScalar<int>("chat_message_add",
                    new
                    {
                        item.roomID,
                        item.entityType,
                        item.entityID,
                        item.message
                    },
                    commandType: CommandType.StoredProcedure);

                // send SMS
                if (sendSMSEnabled)
                {
                    // payload for background job
                    object payload = new
                    {
                        item.roomID,
                        messageID,
                        base.credentials,
                    };

                    string payloadJson = JsonConvert.SerializeObject(payload);
                    string payloadBase64 = Convert.ToBase64String(System.Text.Encoding.UTF8.GetBytes(payloadJson));

                    // start a background worker
                    _backgroundJobs.Enqueue(() => this.sendSMSAsync(payloadBase64));
                }

                return messageID;
            }
        }

        public void sendSMSAsync(string payloadBase64)
        {
            string payloadJson = System.Text.Encoding.UTF8.GetString(Convert.FromBase64String(payloadBase64));
            dynamic payload = JsonConvert.DeserializeObject<dynamic>(payloadJson);

            int roomID = payload.roomID;
            int messageID = payload.messageID;
            Credentials credentials = ((JObject)payload.credentials).ToObject<Credentials>();

            ChatHelper chatHelper = new ChatHelper(credentials);

            chatHelper.sendSMS(messageID, credentials.serverName, credentials.dbName);

        }

        ChatMessage IChatMessageRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<ChatMessage>("chat_message_get", new { messageID = id }, commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## ChatRoomRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Core.Shared;
using Dapper;
using Microsoft.AspNetCore.Http;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Options;
using System;
using System.Collections.Generic;
using System.Data;
using System.Data.SqlClient;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public class ChatRoomRepository : BaseRepository, IChatRoomRepository
    {

        public ChatRoomRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        PagedList<ChatRoom> IChatRoomRepository.search(int userID, int? topicID, string query, int pageIndex, int pageSize)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                PagedList<ChatRoom> page = null;

                using (var multi = connection.QueryMultiple("chat_room_search",
                    new
                    {
                        userID,
                        topicID,
                        query,
                        pageIndex,
                        pageSize
                    }, commandType: CommandType.StoredProcedure, commandTimeout: 0))
                {
                    page = multi.Read<PagedList<ChatRoom>>().Single();
                    page.data = multi.Read<ChatRoom>().ToList();

                }
                return page;
            }
        }

        PagedList<Person> IChatRoomRepository.searchPerson(string query, int? personTypeID, int pageIndex, int pageSize)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                PagedList<Person> page = null;

                using (var multi = connection.QueryMultiple("chat_room_search_person",
                    new
                    {
                        query,
                        personTypeID,
                        pageIndex,
                        pageSize
                    }, commandType: CommandType.StoredProcedure, commandTimeout: 0))
                {
                    page = multi.Read<PagedList<Person>>().Single();
                    page.data = multi.Read<Person>().ToList();

                }
                return page;
            }
        }

        PagedList<ChatRoomEntity> IChatRoomRepository.searchEntity(string query, int topicID, int? companyID, int pageIndex, int pageSize)
        {

            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                PagedList<ChatRoomEntity> page = null;

                using (var multi = connection.QueryMultiple("chat_room_search_entities",
                    new
                    {
                        query,
                        topicID,
                        companyID,
                        pageIndex,
                        pageSize
                    }, commandType: CommandType.StoredProcedure, commandTimeout: 0))
                {
                    page = multi.Read<PagedList<ChatRoomEntity>>().Single();
                    page.data = multi.Read<ChatRoomEntity>().ToList();

                }
                return page;
            }
        }

        ChatRoom IChatRoomRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<ChatRoom>("chat_room_get", new { roomID = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int IChatRoomRepository.add(ChatRoom item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("chat_room_add",
                    new
                    {
                        item.title,
                        item.topicID,
                        item.entityID,
                        item.userID,
                        item.personID
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IChatRoomRepository.update(ChatRoom item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("chat_room_update",
                    new
                    {
                        item.roomID,
                        item.title,
                        item.conversationSid
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IChatRoomRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("chat_room_delete", new { roomID = id }, commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## CheckbookDetailRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class CheckbookDetailRepository : BaseRepository, ICheckbookDetailRepository
    {
        public CheckbookDetailRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<CheckbookDetail> ICheckbookDetailRepository.search(int checkbookId, int personId, int agentId, string reimb, int expenseJobId, int pageIndex, int pageSize, bool withTrash)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<CheckbookDetail>("checkbook_detail_search",
                   new
                   {
                       checkbookId = checkbookId,
                       personId = personId,
                       agentId = agentId,
                       reimb = reimb,
                       expenseJobId = expenseJobId,
                       pageIndex = pageIndex,
                       pageSize = pageSize,
                       withTrash = withTrash
                   },
                   commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<CheckbookDetail> ICheckbookDetailRepository.searchPostingProperty(int propertyId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<CheckbookDetail>("checkbook_detail_PostingProperty",
                    new
                    {
                        propertyId
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }
    }
}

```
## CheckbookReportRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Data;
using System.Data.SqlClient;
using System.Linq;
using AT.AT2017.Api.Core.Models;
using Dapper;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using AT.AT2017.Api.Util;

namespace AT.AT2017.Api.Repositories
{
    public class CheckbookReportRepository : BaseRepository, ICheckbookReportRepository
    {
        public CheckbookReportRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<CheckbookReport> ICheckbookReportRepository.search(int companyId, string dateStart, string dateEnd, int pageIndex, int pageSize)
        {
            List<CheckbookReport> checkbookReportList = new List<CheckbookReport>();

            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                List<CheckbookReportMaster> masterList = connection.Query<CheckbookReportMaster>("checkbook_report_search",
                   new
                   {
                       companyId,
                       dateStart,
                       dateEnd,
                       pageIndex,
                       pageSize
                   },
                   commandType: CommandType.StoredProcedure, commandTimeout: 0).ToList();

                if (masterList.Count() > 0)
                {
                    List<int> masterAccountList = masterList.Select(p => p.accountID).Distinct().ToList();

                    foreach (int masterAccountID in masterAccountList)
                    {
                        // search account
                        CheckbookReportMaster itemHeader = masterList.First(p => p.accountID == masterAccountID);

                        // create item report
                        CheckbookReport itemReport = new CheckbookReport();
                        itemReport.accountID = itemHeader.accountID;
                        itemReport.accountDescription = itemHeader.accountDescription;
                        itemReport.accountNumber = itemHeader.accountNumber;

                        // get item report detail
                        itemReport.detail = this.getCheckbookReportDetail(masterList, itemHeader.accountID);

                        // add item report
                        checkbookReportList.Add(itemReport);
                        
                    }
                }

            }

            return checkbookReportList;
        }

        private IEnumerable<CheckbookReportDetail> getCheckbookReportDetail(List<CheckbookReportMaster> masterList, int accountID)
        {
            List<CheckbookReportDetail> detail = new List<CheckbookReportDetail>();

            // search records by accountID
            List<CheckbookReportMaster> masterListFiltered = masterList.Where(p => p.accountID == accountID).ToList();
            foreach (CheckbookReportMaster itemFiltered in masterListFiltered)
            {
                CheckbookReportDetail newDetail = new CheckbookReportDetail();
                PropertyCopier<CheckbookReportMaster, CheckbookReportDetail>.Copy(itemFiltered, newDetail);
                detail.Add(newDetail);
            }
            return detail;
        }

    }
}

```
## CheckbookRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using AT.AT2017.Api.DynamicParameters;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class CheckbookRepository : BaseRepository, ICheckbookRepository
    {
        public CheckbookRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        string ICheckbookRepository.getNextCheckNumber(int accountId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                string max = connection.ExecuteScalar<string>("account_search_nextCheckNumber", new
                {
                    accountId = accountId
                }, commandType: CommandType.StoredProcedure);

                return max;
            }
        }
        IEnumerable<Checkbook> ICheckbookRepository.search(int companyId, int personId, int propertyId, int accountId, int checkbookId, decimal amount, string checkNumber, string type, string posted, string printed, string fromDate, string toDate, string memoAndDescription, int pageIndex, int pageSize, bool withTrash)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<Checkbook>("checkbook_search",
                    new
                    {
                        companyId = companyId,
                        personId = personId,
                        propertyId = propertyId,
                        accountId = accountId,
                        checkbookId = checkbookId,
                        amount = amount,
                        checkNumber = checkNumber,
                        type = type,
                        posted = posted,
                        printed = printed,
                        fromDate = fromDate,
                        toDate = toDate,
                        memoAndDescription = memoAndDescription,
                        pageIndex = pageIndex,
                        pageSize = pageSize,
                        withTrash = withTrash
                    },
                    commandType: CommandType.StoredProcedure, commandTimeout: 0).ToList();
            }
        }

        IEnumerable<Checkbook> ICheckbookRepository.searchEscrow(int propertyId, int personId, bool onlyCheck)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<Checkbook>("checkbook_escrow_search", new { propertyId = propertyId, personId = personId, onlyCheck = onlyCheck }, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<Checkbook> ICheckbookRepository.searchDuplicateCheckNumber(int id, int accountID, string checkNumber)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {

                return connection.Query<Checkbook>("checkbook_escrow_search_duplicateCheckNumber",
                    new
                    {
                        checkbookID = id,
                        accountID,
                        checkNumber
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<Checkbook> ICheckbookRepository.searchDeletedRecord(int pageIndex, int pageSize)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<Checkbook>("checkbook_search_deleted",
                    new
                    {
                        pageIndex = pageIndex,
                        pageSize = pageSize
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        Checkbook ICheckbookRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                Checkbook checkbook = null;
                try
                {
                    using (var multi = connection.QueryMultiple("checkbook_get", new { checkbookId = id }, commandType: CommandType.StoredProcedure))
                    {
                        checkbook = multi.Read<Checkbook>().Single();
                        checkbook.detail = multi.Read<CheckbookDetail>().ToList();
                    }
                }
                catch (Exception ex)
                {
                    if (ex.Message != "Sequence contains no elements")
                        throw ex;
                }
                return checkbook;
            }
        }

        int ICheckbookRepository.add(Checkbook item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                var checkbookParameter = new CheckbookDynamicParameter(item);

                int id = connection.ExecuteScalar<int>("checkbook_add", checkbookParameter, commandType: CommandType.StoredProcedure, commandTimeout: 0);

                return id;
            }
        }

        int ICheckbookRepository.addEscrow(Checkbook item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                var checkbookParameter = new CheckbookDynamicParameter(item);

                int id = connection.ExecuteScalar<int>("checkbook_escrow_add", checkbookParameter, commandType: CommandType.StoredProcedure, commandTimeout: 0);

                return id;
            }
        }

        void ICheckbookRepository.updateFlag1099(int id, int flag1099)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("checkbook_update_flag1099", new { checkbookId = id, flag1099 = @flag1099 }, commandType: CommandType.StoredProcedure);
            }
        }

        void ICheckbookRepository.updateEscrow(Checkbook item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                var checkbookParameter = new CheckbookDynamicParameter(item);

                int id = connection.ExecuteScalar<int>("checkbook_escrow_update", checkbookParameter, commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }

        void ICheckbookRepository.deleteEscrow(int id, string type)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("checkbook_escrow_delete", new { checkbookId = id, type = type }, commandType: CommandType.StoredProcedure);
            }
        }

        void ICheckbookRepository.update(Checkbook item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                var checkbookParameter = new CheckbookDynamicParameter(item);

                int id = connection.ExecuteScalar<int>("checkbook_update", checkbookParameter, commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }

        void ICheckbookRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("checkbook_delete", new { checkbookId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        void ICheckbookRepository.post(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("checkbook_post", new { checkbookId = id }, commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }

        void ICheckbookRepository.voiding(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("checkbook_void", new { checkbookId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        void ICheckbookRepository.unpost(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("checkbook_unpost", new { checkbookId = id }, commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }

        void ICheckbookRepository.print(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("checkbook_print", new { checkbookId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        IEnumerable<Checkbook> ICheckbookRepository.searchReassign(int propertyId, int accountId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<Checkbook>("escrow_search", new { propertyId = propertyId, accountId = accountId }, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        void ICheckbookRepository.reassign(Checkbook item, int propertyId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("escrow_reassign", new { docID = item.checkbookId, type = item.type, accountId = item.accountId, arPaymentId = item.escrowArPaymentId, fromPropertyId = item.propertyId, toPropertyId = propertyId }, commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }

        int ICheckbookRepository.addAutoDeposit(Checkbook item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.ExecuteScalar<int>("checkbook_add_autodeposit", new { checkbookId = item.checkbookId, companyId = item.companyId }, commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }

        int ICheckbookRepository.addAutoDepositFromPost(int arPaymentId, int escrowCheckId,int propertyId, string postDateDeposit, int companyId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.ExecuteScalar<int>("checkbook_add_autodeposit_fromPost", new { arPaymentId = arPaymentId, escrowCheckId= escrowCheckId,propertyId = propertyId , postDateDeposit = postDateDeposit , companyId = companyId }, commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }
        
        int ICheckbookRepository.undoAutoDeposit(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.ExecuteScalar<int>("checkbook_undo_autodeposit", new { checkbookId = id }, commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }

        void ICheckbookRepository.reclassify(Checkbook item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                var checkbookParameter = new CheckbookDynamicParameter(item);
                int Id = connection.ExecuteScalar<int>("checkbook_reclassify_details", checkbookParameter, commandType: CommandType.StoredProcedure);
            }
        }
    }
}

```
## CheckbookScannedImageRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using AT.AT2017.Api.Core.Models;
using Dapper;
using System.Data;
using AT.AT2017.Api.DynamicParameters;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class CheckbookScannedImageRepository : BaseRepository, ICheckbookScannedImageRepository
    {
        public CheckbookScannedImageRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<CheckbookScannedImage> ICheckbookScannedImageRepository.search(int checkbookID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<CheckbookScannedImage>("checkbook_scannedImage_search",
                    new
                    {
                        checkbookID,
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        CheckbookScannedImage ICheckbookScannedImageRepository.get(int scannedImageID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirst<CheckbookScannedImage>("checkbook_scannedImage_get", 
                    new
                    {
                        scannedImageID
                    }, commandType: CommandType.StoredProcedure);
            }
        }

        int ICheckbookScannedImageRepository.add(CheckbookScannedImage item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                item.scannedImageID = connection.ExecuteScalar<int>("checkbook_scannedImage_add", new {
                    item.checkbookID,
                    item.driveID,
                    item.fileName,
                    item.description
                }, commandType: CommandType.StoredProcedure, commandTimeout: 0);

                return item.scannedImageID;
            }
        }

        void ICheckbookScannedImageRepository.delete(int scannedImageID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("checkbook_scannedImage_delete", new { scannedImageID }, commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }

        void ICheckbookScannedImageRepository.update(CheckbookScannedImage item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("checkbook_scannedImage_update", new
                {
                    item.scannedImageID,
                    item.description
                }, commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }
    }
}

```
## CheckbookScannedImageViewHistoryRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class CheckbookScannedImageViewHistoryRepository : BaseRepository, ICheckbookScannedImageViewHistoryRepository
    {
        public CheckbookScannedImageViewHistoryRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<CheckbookScannedImage> ICheckbookScannedImageViewHistoryRepository.search(int scannedImageID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<CheckbookScannedImage>("checkbook_scannedImage_viewHistory_search",
                 new
                 {
                     scannedImageID
                 },
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }

        int ICheckbookScannedImageViewHistoryRepository.add(int scannedImageID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("checkbook_scannedImage_viewHistory_add",
                    new
                    {
                        scannedImageID
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

    }
}

```
## CheckMergeFieldRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using AT.AT2017.Api.DynamicParameters;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class CheckMergeFieldRepository : BaseRepository, ICheckMergeFieldRepository
    {
        public CheckMergeFieldRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<CheckMergeField> ICheckMergeFieldRepository.search()
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<CheckMergeField>("checkmergefield_search", null, commandType: CommandType.StoredProcedure).ToList();
            }
        }

    }
}

```
## CheckTemplateRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using AT.AT2017.Api.DynamicParameters;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class CheckTemplateRepository : BaseRepository, ICheckTemplateRepository
    {
        public CheckTemplateRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<CheckTemplate> ICheckTemplateRepository.search(string name)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<CheckTemplate>("checktemplate_search",
                   new
                   {
                       name = name
                   },
                   commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<CheckTemplate> ICheckTemplateRepository.searchFromMaster()
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<CheckTemplate>("checktemplate_search_from_master", null, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        CheckTemplate ICheckTemplateRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                CheckTemplate item = null;
                try
                {
                    using (var multi = connection.QueryMultiple("checktemplate_get", new { checkTemplateId = id }, commandType: CommandType.StoredProcedure))
                    {
                        item = multi.Read<CheckTemplate>().Single();
                        item.mergeFields = multi.Read<CheckMergeField>().ToList();
                    }
                }
                catch (Exception ex)
                {
                    if (ex.Message != "Sequence contains no elements")
                        throw ex;
                }
                return item;
            }          
        }

        void ICheckTemplateRepository.exportToMaster(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("checktemplate_export_to_master", new { checkTemplateID = id }, commandType: CommandType.StoredProcedure);
            }
        }

        CheckTemplate ICheckTemplateRepository.getFromMaster(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                CheckTemplate item = null;
                try
                {
                    using (var multi = connection.QueryMultiple("checktemplate_get_from_master", new { checkTemplateId = id }, commandType: CommandType.StoredProcedure))
                    {
                        item = multi.Read<CheckTemplate>().Single();
                        item.mergeFields = multi.Read<CheckMergeField>().ToList();
                    }
                }
                catch (Exception ex)
                {
                    if (ex.Message != "Sequence contains no elements")
                        throw ex;
                }
                return item;
            }
        }

        int ICheckTemplateRepository.add(CheckTemplate item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("checktemplate_add",
                   new
                   {
                       name = item.name,
                       background = item.background,
                       backgroundPosition = item.backgroundPosition,
                       width = item.width,
                       height = item.height,
                       paper_kind = item.paper_kind,
                       paper_width = item.paper_width,
                       paper_height = item.paper_height,
                       margin_top = item.margin_top,
                       margin_bottom = item.margin_bottom,
                       margin_left = item.margin_left,
                       margin_right = item.margin_right,
                       landscape = item.landscape,
                       checkTypeId = item.checkTypeId,
                       masterId = item.masterId
                   },
                   commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void ICheckTemplateRepository.update(CheckTemplate item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                var checktemplateParameter = new CheckTemplateDynamicParameter(item);

                int id = connection.ExecuteScalar<int>("checktemplate_update", checktemplateParameter, commandType: CommandType.StoredProcedure);
            }
        }

        void ICheckTemplateRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("checktemplate_delete", new { checkTemplateId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int ICheckTemplateRepository.copy(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                id = connection.ExecuteScalar<int>("checktemplate_copy", new { checkTemplateID = id }, commandType: CommandType.StoredProcedure, commandTimeout: 0);

                return id;
            }
        }

        string ICheckTemplateRepository.getImagesPath()
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                string path = connection.ExecuteScalar<string>("checktemplate_get_imagesPath",null, commandType: CommandType.StoredProcedure);

                return path;
            }
        }
        
    }
}

```
## CheckWriterRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class CheckWriterRepository : BaseRepository, ICheckWriterRepository
    {
        public CheckWriterRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<CheckWriter> ICheckWriterRepository.search(int companyId, string source, int entityID, string fromDate, string toDate, int topNumber, int pageIndex, int pageSize)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<CheckWriter>("checkwriter_search",
                    new
                    {
                        companyId = companyId,
                        source = source,
                        entityID = entityID,
                        fromDate = fromDate,
                        toDate = toDate,
                        topNumber = topNumber,
                        pageIndex = pageIndex,
                        pageSize = pageSize
                    }
                   , commandType: CommandType.StoredProcedure, commandTimeout: 30).ToList(); // 30 seconds
            }
        }
    }
}

```
## ClassificationRuleRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;
using Newtonsoft.Json;
using AT.AT2017.Api.Core.Models.BankStream;
using AT.AT2017.Api.DynamicParameters;

// For more information on enabling Web API for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860

namespace AT.AT2017.Api.Repositories
{
    public class ClassificationRuleRepository : BaseRepository, IClassificationRuleRepository
    {
        public ClassificationRuleRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<ClassificationRule> IClassificationRuleRepository.search(string searchRule, int transactionID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString ))
            {
                return connection.Query<ClassificationRule>("classification_rule_search", new
                {
                    searchRule,
                    transactionID
                },
                    commandType: CommandType.StoredProcedure, commandTimeout: 0).ToList();
            }
        }

        ClassificationRule IClassificationRuleRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                ClassificationRule rule = null;
                try
                {
                    using (var multi = connection.QueryMultiple("classification_rule_get", new { ruleId = id }, commandType: CommandType.StoredProcedure))
                    {
                        rule = multi.Read<ClassificationRule>().Single();
                        rule.detail = multi.Read<ClassificationRuleDetail>().ToList();
                    }
                }
                catch (Exception ex)
                {
                    if (ex.Message != "Sequence contains no elements")
                        throw ex;
                }

                return rule;
            }
        }

        int IClassificationRuleRepository.add(ClassificationRule item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                var classificationRuleParameter = new ClassificationRuleDynamicParameter(item);

                int id = connection.ExecuteScalar<int>("classification_rule_add", classificationRuleParameter, commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IClassificationRuleRepository.update(ClassificationRule item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                var classificationRuleParameter = new ClassificationRuleDynamicParameter(item);

                int id = connection.ExecuteScalar<int>("classification_rule_update", classificationRuleParameter, commandType: CommandType.StoredProcedure);
            }
        }

        void IClassificationRuleRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("classification_rule_delete", new { ruleId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        void IClassificationRuleRepository.apply(int ruleId, IEnumerable<BankTransaction> table)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                var classificationRuleApplyParameter = new ClassificationRuleApplyDynamicParameter(ruleId,table);

                int id = connection.ExecuteScalar<int>("classification_rule_apply", classificationRuleApplyParameter, commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }

        void IClassificationRuleRepository.unapply(int ruleId, IEnumerable<BankTransaction> table)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                var classificationRuleApplyParameter = new ClassificationRuleApplyDynamicParameter(ruleId, table);

                int id = connection.ExecuteScalar<int>("classification_rule_unapply", classificationRuleApplyParameter, commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }
    }
}







```
## ClientDeviceRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;
using Microsoft.AspNetCore.Hosting;

namespace AT.AT2017.Api.Repositories
{
    public class ClientDeviceRepository : BaseRepository, IClientDeviceRepository
    {
        public ClientDeviceRepository(IHttpContextAccessor httpContextAccessor, IHostingEnvironment env, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, env, appSettings)
        {
        }

        ClientDevice IClientDeviceRepository.get(string processorId, string computerName, string dbName)
        {
            using (SqlConnection connection = new SqlConnection(base.saAdminConnectionString))
            {
                return connection.QueryFirstOrDefault<ClientDevice>("clientDevice_get", 
                    new {
                        processorId,
                        computerName,
                        dbName
                    }, commandType: CommandType.StoredProcedure);
            }
        }

        int IClientDeviceRepository.add(ClientDevice item)
        {
            using (SqlConnection connection = new SqlConnection(base.saAdminConnectionString))
            {
                int id = connection.ExecuteScalar<int>("clientDevice_add",
                    new
                    {
                        createdBy = item.createdBy,
                        computerName = item.computerName,
                        biosId = item.biosId,
                        motherBoardId = item.motherBoardId,
                        volumeId = item.volumeId,
                        processorId = item.processorId
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IClientDeviceRepository.update(ClientDevice item)
        {
            using (SqlConnection connection = new SqlConnection(base.adminConnectionString))
            {
                int id = connection.ExecuteScalar<int>("clientDevice_update",
                    new
                    {
                        clientDeviceID = item.clientDeviceId,                       
                        authorized = item.authorized,
                        modifyBy = item.modifyBy
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        IEnumerable<ClientDevice> IClientDeviceRepository.search(string dbName, string status, string authorized, string fromDate, string toDate)
        {
            using (SqlConnection connection = new SqlConnection(base.adminConnectionString))
            {

                return connection.Query<ClientDevice>("clientDevice_search",
                    new
                    {
                        dbName = dbName,
                        status = status,
                        authorized = authorized,
                        fromDate = fromDate,
                        toDate = toDate
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }
    }
}

```
## ClientNewRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class ClientNewRepository : BaseRepository, IClientNewRepository
    {
        public ClientNewRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

         int IClientNewRepository.add(ClientNew item)
        {
            using (SqlConnection connection = new SqlConnection(base.adminConnectionString))
            {
                int id = connection.ExecuteScalar<int>("clientNew_add", new {item.typeCode ,item.title ,item.description,item.active,item.sortOrder,item.fromDate,item.toDate  }, commandType: CommandType.StoredProcedure);

                return id;
            }
        }

         void IClientNewRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.adminConnectionString))
            {
                connection.ExecuteScalar<int>("clientNew_delete", new { newId = id }, commandType: CommandType.StoredProcedure);
            }
        }

         ClientNew IClientNewRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.adminConnectionString))
            {
                return connection.QueryFirstOrDefault<ClientNew>("clientNew_get", new { newId = id }, commandType: CommandType.StoredProcedure);
            }
        }

         IEnumerable<ClientNew> IClientNewRepository.search()
        {
            using (SqlConnection connection = new SqlConnection(base.adminConnectionString))
            {
                return connection.Query<ClientNew>("clientNew_search",null,  commandType: CommandType.StoredProcedure).ToList();
            }
        }

         void IClientNewRepository.update(ClientNew item)
        {
            using (SqlConnection connection = new SqlConnection(base.adminConnectionString))
            {
                int id = connection.ExecuteScalar<int>("clientNew_update",
                     new
                     {
                         item.newID,
                         item.typeCode,
                         item.title,
                         item.description,
                         item.active,
                         item.sortOrder,
                         item.fromDate,
                        item.toDate
                     },
                     commandType: CommandType.StoredProcedure);
            }
        }

        string IClientNewRepository.view(string code, int id)
        {
            using (SqlConnection connection = new SqlConnection(base.adminConnectionString))
            {
                return connection.ExecuteScalar<string>("clientNew_view",new  { code ,id }, commandType: CommandType.StoredProcedure);
            }
        }
    }
}

```
## CodeValueCategoryRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using AT.AT2017.Api.DynamicParameters;
using System.Data.SqlClient;


namespace AT.AT2017.Api.Repositories
{
    public class CodeValueCategoryRepository : BaseRepository, ICodeValueCategoryRepository
    {
        public CodeValueCategoryRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        int ICodeValueCategoryRepository.add(CodeValueCategory item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("codevaluecategory_add",
                     new
                     {
                         item.create,
                         item.read,                        
                         item.delete,
                         item.categoryName,                   
                         item.isDashCategory,
                         item.section,
                         item.enableUpdateCode,
                         item.customHeaderCode,
                         item.allowedCodes,
                         item.minRequiredCodes,
                         item.enableUpdateName,
                         item.customHeaderName,
                         item.enableUpdateCustom1,
                         item.customHeaderCustom1,
                         item.typeControlCustom1,
                         item.allowedCodesCustom1,
                         item.enableUpdateCustom2,
                         item.customHeaderCustom2,
                         item.typeControlCustom2,
                         item.allowedCodesCustom2,
                         item.enableUpdateCustom3,
                         item.customHeaderCustom3,
                         item.typeControlCustom3,
                         item.allowedCodesCustom3
                     },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        CodeValueCategory ICodeValueCategoryRepository.get(string name)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<CodeValueCategory>("codevaluecategory_get", new { name }, commandType: CommandType.StoredProcedure);
            }
        }

        IEnumerable<CodeValueCategory> ICodeValueCategoryRepository.search(string section)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<CodeValueCategory>("codevaluecategory_search", new { section }, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        void ICodeValueCategoryRepository.update(CodeValueCategory item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("codevaluecategory_update",
                    new
                    {
                       item.codeValueCategoryID,
                        item.create,
                        item.read,
                        item.delete,
                        item.isDashCategory,
                        item.section,
                        item.enableUpdateCode,
                        item.customHeaderCode,
                        item.allowedCodes,
                        item.minRequiredCodes,
                        item.enableUpdateName,
                        item.customHeaderName,
                        item.enableUpdateCustom1,
                        item.customHeaderCustom1,
                        item.typeControlCustom1,
                        item.allowedCodesCustom1,
                        item.enableUpdateCustom2,
                        item.customHeaderCustom2,
                        item.typeControlCustom2,
                        item.allowedCodesCustom2,
                        item.enableUpdateCustom3,
                        item.customHeaderCustom3,
                        item.typeControlCustom3,
                        item.allowedCodesCustom3
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }
    }
}

```
## CodeValueReportRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using AT.AT2017.Api.Core.Model_Report;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class CodeValueReportRepository : BaseRepository, ICodeValueReportRepository
    {
        public CodeValueReportRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<CodeValueReport> ICodeValueReportRepository.search(int id, string name, string category, int showDeleted, int pageIndex, int pageSize)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<CodeValueReport>("codeValue_report", new { id, name,category, showDeleted, pageIndex, pageSize }, commandType: CommandType.StoredProcedure).ToList();
            }
        }
    }
}

```
## CodeValueRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using AT.AT2017.Api.DynamicParameters;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class CodeValueRepository : BaseRepository, ICodeValueRepository
    {
        public CodeValueRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<CodeValue> ICodeValueRepository.search(string category, string custom, bool withTrash, string group, bool includeNotMaster, bool applySecurity, string accessType)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<CodeValue>("codevalue_search",
                 new
                 {
                     category = category,
                     custom = custom,
                     withTrash = withTrash,
                     group = group,
                     includeNotMaster = includeNotMaster,
                     applySecurity = applySecurity,
                     accessType = accessType,
                 },
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<CodeValue> ICodeValueRepository.searchRecurringCodes()
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<CodeValue>("recurringcode_search", null, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<CodeValue> ICodeValueRepository.searchBrandCodes()
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<CodeValue>("codevalue_search_brand_codes", null, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<CodeValue> ICodeValueRepository.searchForteCodes()
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<CodeValue>("codevalue_search_forteResponseCodes", null, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<CodeValue> ICodeValueRepository.searchInvalidCodes(string category)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<CodeValue>("codevalue_search_invalid_codes",
                 new
                 {
                     category = category
                 },
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<CodeValue> ICodeValueRepository.searchCategoryCodes(string category)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<CodeValue>("codevalue_search_category_codes",
                 new
                 {
                     category = category
                 },
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<CodeValue> ICodeValueRepository.searchCategoryCustom1(string category)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<CodeValue>("codevalue_search_category_custom1",
                 new
                 {
                     category = category
                 },
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<CodeValue> ICodeValueRepository.searchDeletedRecord(int pageIndex, int pageSize)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<CodeValue>("codevalue_search_deleted",
                    new
                    {
                        pageIndex = pageIndex,
                        pageSize = pageSize
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<CodeValue> ICodeValueRepository.searchProtectedCategories()
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<CodeValue>("codevalue_search_dash_protected_categories", null, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<PersonTypeAccess> ICodeValueRepository.searchPersonTypeAccess()
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<PersonTypeAccess>("codevalue_search_persontype_access", null, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        void ICodeValueRepository.updateInvalidCodes(int invalidCodeId, int validCodeId)
        {
            using (SqlConnection connection = new SqlConnection(base.saConnectionString))
            {
                connection.Execute("codevalue_update_invalid_codes", new { invalidCodeID = invalidCodeId, validCodeID = validCodeId }, commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }

        CodeValue ICodeValueRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<CodeValue>("codevalue_get", new { codeValueId = id }, commandType: CommandType.StoredProcedure);
            }
        }
        
        int ICodeValueRepository.add(CodeValue item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("codevalue_add",
                    new
                    {
                        name = item.name,
                        code = item.code,
                        group = item.group,
                        category = item.category,
                        custom1 = item.custom1,
                        custom2 = item.custom2,
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void ICodeValueRepository.update(CodeValue item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("codevalue_update",
                    new
                    {
                        codeValueId = item.codeValueId,
                        name = item.name,
                        code = item.code,
                        group = item.group,
                        custom1 = item.custom1,
                        custom2 = item.custom2,
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void ICodeValueRepository.update(IEnumerable<CodeValue> table, string category)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                var codeValueParameter = new CodeValueDynamicParameter(table,category);

                int id = connection.ExecuteScalar<int>("codevalue_update_table", codeValueParameter, commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }

        void ICodeValueRepository.delete(int id, bool forceDelete)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
            connection.Execute("codevalue_delete", new { codeValueId = id, forceDelete = forceDelete }, commandType: CommandType.StoredProcedure);
            }
        }

        IEnumerable<CodeValue> ICodeValueRepository.searchPersonType(int  id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<CodeValue>("codevalue_search_persontype",
                 new
                 {
                     personTypeId = id
                 },
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<CodeValue> ICodeValueRepository.searchDeletedByCategory(string category)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<CodeValue>("codevalue_search_category_deleted",
                 new
                 {
                     category = category
                 },
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }

        void ICodeValueRepository.reactive(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("codevalue_update_deleted",
                    new
                    {
                        codeValueId = id
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## CompanyBankRepository.cs
```cs
using System;
using System.Data;
using System.Data.SqlClient;
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.DynamicParameters;
using Dapper;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;

namespace AT.AT2017.Api.Repositories
{
    public class CompanyBankRepository : BaseRepository, ICompanyBankRepository
    {

        public CompanyBankRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        CompanyBank ICompanyBankRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<CompanyBank>("company_bank_get",
                    new {
                        bankId = id
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void ICompanyBankRepository.add(CompanyBank item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                var bankAccountParameter = new BankAccountDynamicParameter(
                        itemId: item.item_id,
                        institutionId: item.institution_id,
                        accessToken: item.access_token,
                        bankName: item.bankName,
                        platform: item.platform,
                        accounts: item.accounts
                    );
                connection.Execute(
                    "bank_account_add",
                    bankAccountParameter,
                    commandType: CommandType.StoredProcedure);
            }
        }

        void ICompanyBankRepository.reconnect(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("company_bank_reconnect",
                    new {
                        bankID = id,
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void ICompanyBankRepository.disconnect(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("company_bank_disconnect",
                    new
                    {
                        bankID = id,
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## CompanyReportRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using AT.AT2017.Api.Core.Model_Report;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class CompanyReportRepository : BaseRepository, ICompanyReportRepository
    {
        public CompanyReportRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<CompanyReport> ICompanyReportRepository.search(string name, int id, int showDeleted, int dateType, string dateStart, string dateEnd, int pageIndex, int pageSize)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<CompanyReport>("company_report", new { id,name, dateType, dateStart,dateEnd, showDeleted, pageIndex, pageSize }, commandType: CommandType.StoredProcedure).ToList();
            }
        }
    }
}

```
## CompanyRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;
using Microsoft.AspNetCore.Hosting;

namespace AT.AT2017.Api.Repositories
{
    public class CompanyRepository : BaseRepository, ICompanyRepository
    {
        public CompanyRepository(IHttpContextAccessor httpContextAccessor, IHostingEnvironment env, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, env, appSettings)
        {
        }

        IEnumerable<Company> ICompanyRepository.search(bool withTrash)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<Company>("company_search", new { withTrash = withTrash }, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<Company> ICompanyRepository.adminSearch()
        {
            using (SqlConnection adminConnection = new SqlConnection(base.adminConnectionString))
            {
                return adminConnection.Query<Company>("company_search", null, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<Company> ICompanyRepository.searchDeletedRecord(int pageIndex, int pageSize)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<Company>("company_search_deleted",
                    new
                    {
                        pageIndex = pageIndex,
                        pageSize = pageSize
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        Company ICompanyRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<Company>("company_get", new { companyId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int ICompanyRepository.add(Company item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("company_add",
                    new
                    {
                        name = item.name,
                        legalName = item.legalName,
                        taxId = item.taxId,
                        mailboxId = item.mailboxId,
                        city = item.city,
                        state = item.state,
                        zip = item.zip,
                        address = item.address,
                        brandCode = item.brandCode,
                        brokerage = item.brokerage,
                        sqFt = item.sqFt,
                        monthlyLease = item.monthlyLease,
                        renewalDate = item.renewalDate,
                        item.taxRate 
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void ICompanyRepository.update(Company item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("company_update",
                    new
                    {
                        companyId = item.companyId,
                        name = item.name,
                        legalName = item.legalName,
                        taxId = item.taxId,
                        mailboxId = item.mailboxId,
                        city = item.city,
                        state = item.state,
                        zip = item.zip,
                        address = item.address,
                        brandCode = item.brandCode,
                        stateTax = item.stateTax,
                        brokerage = item.brokerage,
                        sqFt = item.sqFt,
                        monthlyLease = item.monthlyLease,
                        renewalDate = item.renewalDate,
                        item.taxRate
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void ICompanyRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("company_delete", new { companyId = id }, commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## CompanySettingRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;
using Microsoft.AspNetCore.Hosting;
using AT.AT2017.Api.DynamicParameters;

namespace AT.AT2017.Api.Repositories
{
    public class CompanySettingRepository : BaseRepository, ICompanySettingRepository
    {

        public CompanySettingRepository(IHttpContextAccessor httpContextAccessor, IHostingEnvironment env, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, env, appSettings)
        {
        }

        IEnumerable<Setting> ICompanySettingRepository.search()
        {
            using (SqlConnection connection = new SqlConnection(base.adminConnectionString))
            {
                return connection.Query<Setting>("company_settings_search", null, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<Setting> ICompanySettingRepository.searchByAction(int actionID)
        {
            using (SqlConnection connection = new SqlConnection(base.adminConnectionString))
            {
                return connection.Query<Setting>("company_settings_search_by_action", new { actionID }, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        void ICompanySettingRepository.updateActions(int actionID, List<Setting> settings)
        {
            using (SqlConnection connection = new SqlConnection(base.adminConnectionString))
            {
                var actionSettingParameter = new ActionSettingsDynamicParameter(settings, actionID);

                int id = connection.ExecuteScalar<int>("company_setting_update_actions", actionSettingParameter, commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }


    }
}

```
## CorrespondenceMergeFieldRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class CorrespondenceMergeFieldRepository : BaseRepository, ICorrespondenceMergeFieldRepository
    {
        public CorrespondenceMergeFieldRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<CorrespondenceMergeField> ICorrespondenceMergeFieldRepository.search(string type)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<CorrespondenceMergeField>("correspondencemergefield_search", new
                {
                    type = type
                }, commandType: CommandType.StoredProcedure).ToList();
            }
        }
    }
}

```
## CorrespondenceTemplateRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class CorrespondenceTemplateRepository : BaseRepository, ICorrespondenceTemplateRepository
    {
        public CorrespondenceTemplateRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<CorrespondenceTemplate> ICorrespondenceTemplateRepository.search(string name)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<CorrespondenceTemplate>("correspondencetemplate_search",
                   new
                   {
                       name = name
                   },
                   commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<CorrespondenceTemplate> ICorrespondenceTemplateRepository.searchFromMaster(int typeId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<CorrespondenceTemplate>("correspondencetemplate_search_from_master", new { typeId = typeId }, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        CorrespondenceTemplate ICorrespondenceTemplateRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<CorrespondenceTemplate>("correspondencetemplate_get", new { correspondenceTemplateId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        void ICorrespondenceTemplateRepository.exportToMaster(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("correspondencetemplate_export_to_master", new { correspondenceTemplateID = id }, commandType: CommandType.StoredProcedure);
            }
        }

        CorrespondenceTemplate ICorrespondenceTemplateRepository.getFromMaster(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<CorrespondenceTemplate>("correspondencetemplate_get_from_master", new { correspondenceTemplateId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int ICorrespondenceTemplateRepository.add(CorrespondenceTemplate item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("correspondencetemplate_add",
                    new
                    {
                        name = item.name,
                        content = item.content,
                        paper_kind = item.paper_kind,
                        paper_width = item.paper_width,
                        paper_height = item.paper_height,
                        margin_top = item.margin_top,
                        margin_bottom = item.margin_bottom,
                        margin_left = item.margin_left,
                        margin_right = item.margin_right,
                        landscape = item.landscape,
                        typeId = item.typeId,
                        masterId = item.masterId
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void ICorrespondenceTemplateRepository.update(CorrespondenceTemplate item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("correspondencetemplate_update",
                      new
                      {
                          correspondenceTemplateId = item.correspondenceTemplateId,
                          name = item.name,
                          content = item.content,
                          paper_kind = item.paper_kind,
                          paper_width = item.paper_width,
                          paper_height = item.paper_height,
                          margin_top = item.margin_top,
                          margin_bottom = item.margin_bottom,
                          margin_left = item.margin_left,
                          margin_right = item.margin_right,
                          landscape = item.landscape,
                          typeId = item.typeId
                      },
                      commandType: CommandType.StoredProcedure);
            }
        }

        void ICorrespondenceTemplateRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("correspondencetemplate_delete", new { correspondenceTemplateId = id }, commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## CustomControlRepository.cs
```cs
using System.Collections.Generic;
using System.Data;
using System.Data.SqlClient;
using System.Linq;
using AT.AT2017.Api.Core.Models;
using Dapper;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;

namespace AT.AT2017.Api.Repositories
{
    public class CustomControlRepository : BaseRepository, ICustomControlRepository
    {
        public CustomControlRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }


        IEnumerable<CustomControl> ICustomControlRepository.search(int packageID, string formName)
        {
            using (SqlConnection connection = new SqlConnection(base.adminConnectionString))
            {
                return connection.Query<CustomControl>("custom_control_search",
                 new
                 {
                     packageID,
                     formName
                 },
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }

        CustomControl ICustomControlRepository.get(int controlID)
        {
            using (SqlConnection connection = new SqlConnection(base.adminConnectionString))
            {
                return connection.QueryFirstOrDefault<CustomControl>("custom_control_get",
                    new
                    {
                        controlID,
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        int ICustomControlRepository.addOrUpdate(CustomControl item)
        {
            using (SqlConnection connection = new SqlConnection(base.adminConnectionString))
            {
                int id = connection.ExecuteScalar<int>("custom_control_add_or_update",
                    new
                    {
                        item.name,
                        item.type,
                        item.originalText,
                        item.customText,
                        item.formName,
                        item.parent,
                        item.packageID
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }
    }
}

```
## DashboardColumnsRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class DashboardColumnsRepository : BaseRepository, IDashboardColumnsRepository
    {
        public DashboardColumnsRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<DashboardColumns> IDashboardColumnsRepository.search(int dashboardID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<DashboardColumns>("dashboard_columns_search", new { dashboardID = dashboardID }, commandType: CommandType.StoredProcedure).ToList();
            }
        }
    }

}

```
## DashboardRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class DashboardRepository : BaseRepository, IDashboardRepository 
    {
        public DashboardRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<Dashboard> IDashboardRepository.search(int userId, string sectionName, string visible)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
               return connection.Query<Dashboard>("dashboard_search",
                   new
                   {
                       userId = userId,
                       sectionName = sectionName,
                       visible = visible
                   },
                    commandType: CommandType.StoredProcedure, commandTimeout: 0).ToList();
            }
        }

        int IDashboardRepository.add(Dashboard item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
               int id = connection.ExecuteScalar<int>("dashboard_add",
               new
               {
                   sectionId = item.sectionId,
                   entityTypeId = item.entityTypeId,
                   title = item.title,
                   procedureToRun = item.procedureToRun,
                   visible = item.visible
               },
               commandType: CommandType.StoredProcedure);

               return id;
            }
            
        }

        void IDashboardRepository.update_columns(Dashboard item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("dashboard_update_customColumns",
                new
                {
                    dashboardID = item.dashboardId ,
                    userID = item.userID,
                    procedureToRun = item.procedureToRun
                },
                commandType: CommandType.StoredProcedure,commandTimeout:0);
            }
        }

        void IDashboardRepository.update(Dashboard item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("dashboard_update",
                new
                {
                    dashboardID = item.dashboardId,
                    sectionId = item.sectionId,
                    entityTypeId = item.entityTypeId,
                    title = item.title,
                    procedureToRun = item.procedureToRun,
                    visible = item.visible
                },
                commandType: CommandType.StoredProcedure);
            }
        }

        Dashboard IDashboardRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<Dashboard>("dashboard_get", new { dashboardID = id }, commandType: CommandType.StoredProcedure);
            }
        }

        void IDashboardRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("dashboard_delete", new { dashboardId = id }, commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## DashboardUserDetail.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class DashboardUserDetailRepository : BaseRepository, IDashboardUserDetailRepository 
    {
        public DashboardUserDetailRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<DashboardUserDetail> IDashboardUserDetailRepository.search(int dashboardID, int userID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<DashboardUserDetail>("dashboard_user_detail_search", new { dashboardID = dashboardID, userID = userID }, commandType: CommandType.StoredProcedure).ToList();
            }
        }

    }
}

```
## DatabaseLoggedUserRepository.cs
```cs
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Hosting;
using System.Collections.Generic;
using System.Linq;

namespace AT.AT2017.Api.Repositories
{
    public class DatabaseLoggedUserRepository : BaseRepository, IDatabaseLoggedUserRepository
    {

        public DatabaseLoggedUserRepository(IHttpContextAccessor httpContextAccessor, IHostingEnvironment env, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, env, appSettings)
        {
        }

        IEnumerable<DatabaseLoggedUser> IDatabaseLoggedUserRepository.searchSummary(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.saAdminConnectionString))
            {
                return connection.Query<DatabaseLoggedUser>("database_logged_user_search_summary", new { databaseID = id}, commandType: CommandType.StoredProcedure).ToList();
            }
        }
    }
}

```
## DatabasePackageRepository.cs
```cs
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Hosting;
using System.Collections.Generic;
using System.Linq;

namespace AT.AT2017.Api.Repositories
{
    public class DatabasePackageRepository : BaseRepository, IDatabasePackageRepository
    {

        public DatabasePackageRepository(IHttpContextAccessor httpContextAccessor, IHostingEnvironment env, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, env, appSettings)
        {
        }

        DatabasePackage IDatabasePackageRepository.getLastPackage(int id, int userId)
        {
            using (SqlConnection connection = new SqlConnection(base.saAdminConnectionString))
            {
                return connection.QueryFirstOrDefault<DatabasePackage>("database_get_last_package", new { databaseID = id, userID = userId },commandType: CommandType.StoredProcedure);
            }
         }
    }
}

```
## DatabaseRepository.cs
```cs
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Hosting;
using System.Collections.Generic;
using System.Linq;
using Hangfire;

namespace AT.AT2017.Api.Repositories
{
    public class DatabaseRepository : BaseRepository, IDatabaseRepository
    {
        private IBackgroundJobClient _backgroundJobs;

        public DatabaseRepository(IHttpContextAccessor httpContextAccessor, IHostingEnvironment env, IOptions<ApplicationSettings> appSettings, IBackgroundJobClient backgroundJobs) : base(httpContextAccessor, env, appSettings)
        {
            _backgroundJobs = backgroundJobs;
        }

        IEnumerable<Database> IDatabaseRepository.search(string corporateName, string active, string mode)
        {
            using (SqlConnection connection = new SqlConnection(base.adminConnectionString))
            {
                return connection.Query<Database>("database_search",
                   new {
                        corporateName,
                        active,
                        mode
                   },
                   commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<Database> IDatabaseRepository.searchActive()
        {
            using (SqlConnection connection = new SqlConnection(base.adminConnectionString))
            {
                return connection.Query<Database>("database_search_active", null,commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<Database> IDatabaseRepository.searchByPackages(int databaseID, int packageID, string expiresOn)
        {
            using (SqlConnection connection = new SqlConnection(base.adminConnectionString))
            {
                return connection.Query<Database>("database_search_by_packages",
                   new
                   {
                       databaseID,
                       packageID,
                       expiresOn
                   },
                   commandType: CommandType.StoredProcedure).ToList();
            }
        }
        void IDatabaseRepository.update(Database item)
        {
            using (SqlConnection adminConnection = new SqlConnection(base.adminConnectionString))
            {
                adminConnection.ExecuteScalar<int>("database_update", new
                {
                    databaseId = item.databaseId,
                    corporateName = item.corporateName,
                    companyName = item.companyName,
                    dbName = item.dbName,
                    serverName = item.serverName,
                    apiKey = item.apiKey,
                    activeSince = item.activeSince,
                    providerIdentifier = item.providerIdentifier,
                    isCrest = item.isCrest,
                    dbSubmission = item.dbSubmission,
                    active = item.active,
                    mode = item.mode,
                    modifyBy = item.modifyBy
                }, commandType: CommandType.StoredProcedure);
            }
        }

        IEnumerable<BrandCode> IDatabaseRepository.searchBrandCodes()
        {
            using (SqlConnection connection = new SqlConnection(base.adminConnectionString))
            {
                return connection.Query<BrandCode>("brand_code_search", null, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        DataTable IDatabaseRepository.searchNewClientSetupSteps()
        {
            DataTable dt = new DataTable();
            using (SqlConnection adminConnection = new SqlConnection(base.adminConnectionString))
            {
                SqlCommand command = new SqlCommand("migration_new_client_search_steps", adminConnection);
                command.CommandType = CommandType.StoredProcedure;

                adminConnection.Open();
                SqlDataReader reader = command.ExecuteReader();
                dt.Load(reader);
                reader.Close();
            }

            return dt;
        }

        void IDatabaseRepository.updateContactInfo(Database item)
        {
            using (SqlConnection adminConnection = new SqlConnection(base.adminConnectionString))
            {
                adminConnection.ExecuteScalar<int>("database_update_contactinfo", new
                {
                    item.databaseId,
                    item.contactFirstName,
                    item.contactLastName,
                    item.contactEmail,
                    item.activeSince,
                    item.contractType,
                    item.mode
                }, commandType: CommandType.StoredProcedure);
            }
        }

        Database IDatabaseRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.saAdminConnectionString))
            {
                Database item = null;

                using (var multi = connection.QueryMultiple("database_get", new { databaseId = id }, commandType: CommandType.StoredProcedure))
                {
                    item = multi.Read<Database>().Single();
                    item.packages = multi.Read<DatabasePackage>().ToList();
                    item.controls = multi.Read<CustomControl>().ToList();
                }
                return item;
            }
        }

        void IDatabaseRepository.enableTriggers()
        {
            using (SqlConnection connection = new SqlConnection(base.saConnectionString))
            {
                connection.Execute("dataTransfer_alltriggers_enable", commandType: CommandType.StoredProcedure);
            }
        }

        void IDatabaseRepository.enableServiceBroker()
        {
            using (SqlConnection connection = new SqlConnection(base.saConnectionString))
            {
                connection.Execute("database_servicebroker_enable", commandType: CommandType.StoredProcedure);
            }
        }

        void IDatabaseRepository.fixGlAccountSetting()
        {
            using (SqlConnection connection = new SqlConnection(base.saConnectionString))
            {
                connection.Execute("database_fix_glaccountsetting", commandType: CommandType.StoredProcedure);
            }
        }

        void IDatabaseRepository.validateSynonyms(string nameServer)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("admin_validate_synonyms", new { nameServer = nameServer }, commandType: CommandType.StoredProcedure);
            }
        }

        int IDatabaseRepository.addPackage(DatabasePackage item)
        {
            using (SqlConnection connection = new SqlConnection(base.adminConnectionString))
            {
                int id = connection.ExecuteScalar<int>("database_add_package", 
                    new
                    {
                        item.databaseID,
                        item.packageID,
                        item.startDate,
                        item.endDate,
                        item.packagePriceID,
                        item.countFrom,
                        item.countTo,
                        item.initialPrice,
                        item.price
                    }, commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IDatabaseRepository.updatePackage(DatabasePackage item)
        {
            using (SqlConnection connection = new SqlConnection(base.adminConnectionString))
            {
                connection.ExecuteScalar<int>("database_update_package",
                    new
                    {
                        item.databasePackageID,
                        item.startDate,
                        item.endDate,
                        item.packagePriceID,
                        item.countFrom,
                        item.countTo,
                        item.initialPrice,
                        item.price
                    }, commandType: CommandType.StoredProcedure);
            }
        }

        void IDatabaseRepository.cancelPackage(int databasePackageid)
        {
            using (SqlConnection connection = new SqlConnection(base.adminConnectionString))
            {
                connection.ExecuteScalar<int>("database_cancel_package", new { databasePackageid }, commandType: CommandType.StoredProcedure);
            }
        }

        NewClientSetupLog IDatabaseRepository.getNewClientSetupLog(int logID)
        {
            NewClientSetupLog item;
            using (SqlConnection connection = new SqlConnection(base.saAdminConnectionString))
            {
                using (var multi = connection.QueryMultiple("migration_new_client_get_log", new { logID }, commandType: CommandType.StoredProcedure))
                {
                    item = multi.Read<NewClientSetupLog>().Single();
                    item.detail = multi.Read<NewClientSetupLogDetail>().ToList();
                }
                
            };
            return item;
        }

        int IDatabaseRepository.runNewClientSetup(string serverName, string newDatabaseName, string mode, string brandCode, bool isDash, string contactFirstName, string contactLastName, string contactEmail, string executedBy, string originalDbName)
        {
            using (SqlConnection connection = new SqlConnection(base.saAdminConnectionString))
            {
                int logID = connection.ExecuteScalar<int>("migration_new_client_start",
                    new
                    {
                        serverName,
                        newDatabaseName,
                        mode,
                        brandCode,
                        isDash,
                        contactFirstName,
                        contactLastName,
                        contactEmail,
                        executedBy,
                        originalDbName
                    },
                    commandType: CommandType.StoredProcedure);

                // start a background jo for each record
                _backgroundJobs.Enqueue(() => runNewClientSetupAsync(serverName, newDatabaseName, mode, brandCode, isDash, contactFirstName, contactLastName, contactEmail, executedBy, logID, saAdminConnectionString, originalDbName));

                return logID;
            }
        }

        public void runNewClientSetupAsync(string serverName, string newDatabaseName, string mode, string brandCode, bool isDash, string contactFirstName, string contactLastName, string contactEmail, string executedBy, int logID, string connectionString, string originalDbName)
        {
            using (SqlConnection connection = new SqlConnection(connectionString))
            {
                if (mode != "functional_test")
                {
                    connection.Execute("migration_new_client_run_all_steps",
                            new
                            {
                                serverName,
                                newDatabaseName,
                                mode,
                                brandCode,
                                isDash,
                                contactFirstName,
                                contactLastName,
                                contactEmail,
                                executedBy,
                                logID
                            },
                            commandType: CommandType.StoredProcedure,
                            commandTimeout: 0);
                }
                else
                {
                    connection.Execute("database_clone",
                            new
                            {
                                newDatabaseName,
                                originalDbName,
                                logID
                            },
                            commandType: CommandType.StoredProcedure,
                            commandTimeout: 0);
                }
            }
        }

        int IDatabaseRepository.startGoingTolive(string serverName, string dbName, string executedBy)
        {
            using (SqlConnection connection = new SqlConnection(base.saAdminConnectionString))
            {
                int returnID = connection.ExecuteScalar<int>("migration_new_client_goingtolive_start",
                    new
                    {
                        serverName,
                        dbName,
                        executedBy
                    },
                    commandType: CommandType.StoredProcedure,
                    commandTimeout: 0);

                return returnID;
            }
        }

        int IDatabaseRepository.runGoingTolive(string serverName, string dbName, string executedBy, int logID, bool keepAgentData, bool keepOtherPeopleData, bool keepPropertyData, bool keepPropertyACData, bool keepPropertyOPData, bool keepPropertyCLData, bool keepPropertyWDData, bool keepPropertyXPData, bool keepAccountingData, bool keepSettings)
        {
            using (SqlConnection connection = new SqlConnection(base.saAdminConnectionString))
            {
                int returnID = connection.ExecuteScalar<int>("migration_new_client_goingtolive",
                    new
                    {
                        serverName,
                        dbName,
                        executedBy,
                        logID,
                        keepAgentData,
                        keepOtherPeopleData,
                        keepPropertyData,
                        keepPropertyACData,
                        keepPropertyOPData,
                        keepPropertyCLData,
                        keepPropertyWDData,
                        keepPropertyXPData,
                        keepAccountingData,
                        keepSettings
                    },
                    commandType: CommandType.StoredProcedure,
                    commandTimeout: 0);

                return returnID;
            }
        }

        GoingToLiveLog IDatabaseRepository.searchGoingToLiveLog(int logID)
        {
            GoingToLiveLog log;
            using (SqlConnection connection = new SqlConnection(base.saAdminConnectionString))
            {

                using (var multi = connection.QueryMultiple("migration_new_client_goingtolive_search_log",
                    new {
                        logID
                    }, commandType: CommandType.StoredProcedure))
                {
                    log = multi.Read<GoingToLiveLog>().Single();
                    log.detail = multi.Read<GoingToLiveLogDetail>().ToList();
                }

            }
            return log;
        }
    }
}

```
## DataImportRepository.cs
```cs
using System.Collections.Generic;
using System.Linq;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using System.Data;
using Dapper;
using AT.AT2017.Api.DynamicParameters;
using System;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class DataImportRepository : BaseRepository, IDataImportRepository
    {
        public DataImportRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }
        
        IEnumerable<DataImport> IDataImportRepository.search(string type)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<DataImport>("dataimport_search", new {type  }, commandType: CommandType.StoredProcedure, commandTimeout: 0).ToList();
            }
        }

        DataImport IDataImportRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                DataImport item = null;
                List<DataImportRecordValue> values = new List<DataImportRecordValue>();
                try
                {
                    using (var multi = connection.QueryMultiple("dataimport_get",
                        new { dataImportID = id }, commandType: CommandType.StoredProcedure, commandTimeout: 0))
                    {
                        item = multi.Read<DataImport>().Single();
                        item.columns = multi.Read<DataImportColumn>().ToList();
                        item.records = multi.Read<DataImportRecord>().ToList();
                        values = multi.Read<DataImportRecordValue>().ToList();
                        // fill the values field for each record
                        foreach (DataImportRecord record in item.records)
                        {
                            record.values = values.Where((p) => p.sourceRecordID == record.sourceRecordID).ToList();
                        }
                        item.log = multi.Read<DataImportLog>().ToList();
                    }
                }
                catch (Exception ex)
                {
                    if (ex.Message != "Sequence contains no elements")
                        throw ex;
                }
                return item;
            }
        }

        int IDataImportRepository.add(DataImport item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                var dataImportParameter = new DataImportDynamicParameter(item);

                int id = connection.ExecuteScalar<int>("dataimport_add", dataImportParameter, commandType: CommandType.StoredProcedure,commandTimeout :0);

                return id;
            }
        }

        void IDataImportRepository.update(DataImport item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                var dataImportParameter = new DataImportDynamicParameter(item);

                connection.Execute("dataimport_update", dataImportParameter, commandType: CommandType.StoredProcedure, commandTimeout: 0);

            }
        }

        void IDataImportRepository.process(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("dataimport_process",
                    new
                    {
                        dataImportID = id
                    }, commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }

        IEnumerable<DataImportRecord> IDataImportRepository.validate(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<DataImportRecord>("dataimport_validate",
                    new {
                        dataImportID = id
                    }, commandType: CommandType.StoredProcedure, commandTimeout: 0).ToList();
            }
        }

        IEnumerable<DataImportLog> IDataImportRepository.getProcessLog(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<DataImportLog>("dataimport_get_processlog",
                    new { dataImportID = id }, commandType: CommandType.StoredProcedure, commandTimeout: 0).ToList();
            }
        }

        DataImportHistoricalMain IDataImportRepository.getImportHistorical(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                DataImportHistoricalMain dataImport = null;
                try
                {
                    using (var multi = connection.QueryMultiple("dataImport_historical_get", new {id }, commandType: CommandType.StoredProcedure))
                    {
                        dataImport = multi.Read<DataImportHistoricalMain>().Single();
                        dataImport.detail = multi.Read<DataImportHistorical>().ToList();
                    }
                }
                catch (Exception ex)
                {
                    if (ex.Message != "Sequence contains no elements")
                        throw ex;
                }
                return dataImport;
            }
        }

        int IDataImportRepository.updateImportHistorical(int id,IEnumerable<DataImportHistorical> detail)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                var tableParameter = new DataImportHistoricalDynamicParameter(id,detail);

                id = connection.ExecuteScalar<int>("dataImport_historical_update", tableParameter, commandType: CommandType.StoredProcedure, commandTimeout: 0);
                return id;
            }
        }

        int IDataImportRepository.processImportHistorical(int id, IEnumerable<DataImportHistorical> detail)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                var tableParameter = new DataImportHistoricalDynamicParameter(id,detail);

                id = connection.ExecuteScalar<int>("dataImport_historical_process", tableParameter, commandType: CommandType.StoredProcedure, commandTimeout: 0);
                return id;
            }
        }

    }
}

```
## DataProblemRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Data;
using System.Data.SqlClient;
using System.Linq;
using AT.AT2017.Api.Core.Models;
using Dapper;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;

namespace AT.AT2017.Api.Repositories
{
    public class DataProblemRepository : BaseRepository, IDataProblemRepository
    {

        public DataProblemRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<DataProblem> IDataProblemRepository.search(string dbName, string errorCode, string resultType)
        {
            using (SqlConnection connection = new SqlConnection(base.adminConnectionString))
            {
                return connection.Query<DataProblem>("dataproblem_search",
                    new
                    {
                        database = dbName,
                        errorCode = errorCode,
                        resultType = resultType,
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        IEnumerable<DataProblem> IDataProblemRepository.searchDatabases()
        {
            using (SqlConnection connection = new SqlConnection(base.adminConnectionString))
            {
                return connection.Query<DataProblem>("dataproblem_search_databases", null,
                    commandType: CommandType.StoredProcedure);
            }
        }

        IEnumerable<DataProblem> IDataProblemRepository.searchDataProblemTypes(string dbName)
        {
            using (SqlConnection connection = new SqlConnection(base.adminConnectionString))
            {
                return connection.Query<DataProblem>("dataproblem_search_types",
                    new
                    {
                        dbName = dbName
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IDataProblemRepository.run(string dbName)
        {
            using (SqlConnection connection = new SqlConnection(base.saAdminConnectionString))
            {
                connection.Execute("feed_doubleCheck_new",
                    new
                    {
                        database = dbName,
                        code = "",
                        resultType = "DETAIL",
                        persistData = 1
                    },
                    commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }

    }
}

```
## DeductionFormulaRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class DeductionFormulaRepository : BaseRepository, IDeductionFormulaRepository
    {
        public DeductionFormulaRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<DeductionFormula> IDeductionFormulaRepository.search(int deductionId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<DeductionFormula>("deduction_formula_search",
                 new
                 {
                     deductionId = deductionId
                 },
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<DeductionFormula> IDeductionFormulaRepository.research(string deductionIDs, string formula, string officeIDs, string planIDs, string usedForClassificationIDs, string usedForTRTypes,
                                                                            string sides, string sellerLeadSourceIDs, string buyerLeadSourceIDs)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<DeductionFormula>("deduction_formula_research",
                 new
                 {
                     deductionIDs,
                     formula,
                     officeIDs,
                     planIDs,
                     usedForClassificationIDs,
                     usedForTRTypes,
                     sides,
                     sellerLeadSourceIDs,
                     buyerLeadSourceIDs
                 },
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<DeductionFormula> IDeductionFormulaRepository.searchFromMaster()
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<DeductionFormula>("deduction_formula_search_from_master", null,
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }

        DeductionFormula IDeductionFormulaRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<DeductionFormula>("deduction_formula_get", new { formulaId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        DeductionFormula IDeductionFormulaRepository.getFromMaster(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<DeductionFormula>("deduction_formula_get_from_master", new { formulaId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        void IDeductionFormulaRepository.exportToMaster(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("deduction_formula_export_to_master", new { formulaID = id }, commandType: CommandType.StoredProcedure);
            }
        }

        IEnumerable<DeductionFormulaMergeField> IDeductionFormulaRepository.searchMergeFields(string type)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<DeductionFormulaMergeField>("deduction_formula_search_mergefields",
                    new
                    {
                        type = type
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<DeductionFormulaOperator> IDeductionFormulaRepository.searchOperators(string type)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<DeductionFormulaOperator>("deduction_formula_search_operators",
                    new
                    {
                        type = type
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        int IDeductionFormulaRepository.add(DeductionFormula item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("deduction_formula_add",
                    new
                    {
                        deductionId = item.deductionId,
                        name = item.name,
                        officeIds = item.officeIds,
                        planIds = item.planIds,
                        subplanIds = item.subplanIds,
                        listSubplanIds = item.listSubplanIds,
                        sellSubplanIds = item.sellSubplanIds,
                        sides = item.sides,
                        sellerLeadSourceIds = item.sellerLeadSourceIds,
                        buyerLeadSourceIds = item.buyerLeadSourceIds,
                        agentOrOfficeLead = item.agentOrOfficeLead,
                        usedForTRTypes = item.usedForTRTypes,
                        usedForClassificationIds = item.usedForClassificationIds,
                        excludeFlaggedPropsList = item.excludeFlaggedPropsList,
                        excludeFlaggedPropsSell = item.excludeFlaggedPropsSell,
                        sortOrder = item.sortOrder,
                        formulaType = item.formulaType,
                        fixedPercentage = item.fixedPercentage,
                        fixedAmount = item.fixedAmount,
                        customFormulaSP = item.customFormulaSP,
                        topNumberBasedOn = item.topNumberBasedOn,
                        scaleBasedOn_deductionScaleId = item.scaleBasedOn_deductionScaleId,
                        scaleBasedOn_totalId = item.scaleBasedOn_totalId,
                        percentageAfterCAP = item.percentageAfterCAP,
                        fixedAmountAfterCAP = item.fixedAmountAfterCAP,
                        capID = item.capID,
                        percBased_applyLimit = item.percBased_applyLimit,
                        percBased_applyLimitOperator = item.percBased_applyLimitOperator,
                        percBased_applyLimitAmount = item.percBased_applyLimitAmount,
                        scaleBasedOn_prorrateLevels = item.scaleBasedOn_prorrateLevels,
                        scaleBasedOn_prorrateMode = item.scaleBasedOn_prorrateMode,
                        advancedCriteria = item.advancedCriteria,
                        masterId = item.masterId,
                        isSavePercentageAgent = item.isSavePercentageAgent
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IDeductionFormulaRepository.update(DeductionFormula item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("deduction_formula_update",
                    new
                    {
                        formulaId = item.formulaId,
                        deductionId = item.deductionId,
                        name = item.name,
                        officeIds = item.officeIds,
                        planIds = item.planIds,
                        subplanIds = item.subplanIds,
                        listSubplanIds = item.listSubplanIds,
                        sellSubplanIds = item.sellSubplanIds,
                        sides = item.sides,
                        sellerLeadSourceIds = item.sellerLeadSourceIds,
                        buyerLeadSourceIds = item.buyerLeadSourceIds,
                        agentOrOfficeLead = item.agentOrOfficeLead,
                        usedForTRTypes = item.usedForTRTypes,
                        usedForClassificationIds = item.usedForClassificationIds,
                        excludeFlaggedPropsList = item.excludeFlaggedPropsList,
                        excludeFlaggedPropsSell = item.excludeFlaggedPropsSell,
                        sortOrder = item.sortOrder,
                        formulaType = item.formulaType,
                        fixedPercentage = item.fixedPercentage,
                        fixedAmount = item.fixedAmount,
                        customFormulaSP = item.customFormulaSP,
                        topNumberBasedOn = item.topNumberBasedOn,
                        scaleBasedOn_deductionScaleId = item.scaleBasedOn_deductionScaleId,
                        scaleBasedOn_totalId = item.scaleBasedOn_totalId,
                        percentageAfterCAP = item.percentageAfterCAP,
                        fixedAmountAfterCAP = item.fixedAmountAfterCAP,
                        capID = item.capID,
                        percBased_applyLimit = item.percBased_applyLimit,
                        percBased_applyLimitOperator = item.percBased_applyLimitOperator,
                        percBased_applyLimitAmount = item.percBased_applyLimitAmount,
                        scaleBasedOn_prorrateLevels = item.scaleBasedOn_prorrateLevels,
                        scaleBasedOn_prorrateMode = item.scaleBasedOn_prorrateMode,
                        advancedCriteria = item.advancedCriteria,
                        isSavePercentageAgent = item.isSavePercentageAgent
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IDeductionFormulaRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("deduction_formula_delete", new { formulaId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        IEnumerable<DeductionFormulaFunction> IDeductionFormulaRepository.searchFunctions()
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<DeductionFormulaFunction>("deduction_formula_function_search",null, commandType: CommandType.StoredProcedure).ToList();
            }
        }
    }
}

```
## DeductionPlanRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using AT.AT2017.Api.DynamicParameters;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class DeductionPlanRepository : BaseRepository, IDeductionPlanRepository
    {
        public DeductionPlanRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<DeductionPlan> IDeductionPlanRepository.search(int companyId, bool isAgent)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<DeductionPlan>("deduction_plan_search",
                    new
                    {
                        companyID = companyId,
                        isAgent
                    },
                   commandType: CommandType.StoredProcedure).ToList();
            }
        }

        DeductionPlan IDeductionPlanRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<DeductionPlan>("deduction_plan_get", new { planId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int IDeductionPlanRepository.add(DeductionPlan item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("deduction_plan_add",
                    new
                    {
                        item.planName,
                        companyID = item.companyId
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IDeductionPlanRepository.update(IEnumerable<DeductionPlan> table, bool includeTotals)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                if (includeTotals == false)
                {
                    var deductionPlanParameter = new DeductionPlanDynamicParameter(table);

                    int id = connection.ExecuteScalar<int>("deduction_plan_update", deductionPlanParameter, commandType: CommandType.StoredProcedure);
                }
                else
                {
                    var deductionPlanParameter = new DeductionPlanWithTotalsDynamicParameter(table);

                    int id = connection.ExecuteScalar<int>("deduction_plan_update_with_totals", deductionPlanParameter, commandType: CommandType.StoredProcedure);
                }
            }
        }

        void IDeductionPlanRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("deduction_plan_delete", new { planId = id }, commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## DeductionRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class DeductionRepository : BaseRepository, IDeductionRepository
    {
        public DeductionRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<Deduction> IDeductionRepository.search()
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<Deduction>("deduction_search",
                    null,
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        Deduction IDeductionRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<Deduction>("deduction_get", new { deductionId = id }, commandType: CommandType.StoredProcedure);
            }
        }


        void IDeductionRepository.update(Deduction item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("deduction_update",
                     new
                     {
                         item.deductionId,
                         item.displayName,
                         item.notes,
                         item.sortOrder,
                         item.isCompanyDollar,
                         item.showOnChecks,
                         item.allowNegatives,
                         item.is1099,
                         item.treatAsBillDeduction,
                         item.applyOnPost,
                         item.invoiceTypeId,
                         item.creditTypeId,
                         item.showInCampaign 
                     },
                     commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## DeductionScaleRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using System.Data;
using Dapper;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Microsoft.SqlServer.Server;
using AT.AT2017.Api.DynamicParameters;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class DeductionScaleRepository : BaseRepository, IDeductionScaleRepository
    {
        public DeductionScaleRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<DeductionScale> IDeductionScaleRepository.search(string scaleName)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<DeductionScale>("deduction_scale_search",
                    new
                    {
                        scaleName = scaleName
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        DeductionScale IDeductionScaleRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                DeductionScale invoice = null;
                try
                {
                    using (var multi = connection.QueryMultiple("deduction_scale_get", new { deductionScaleId = id }, commandType: CommandType.StoredProcedure))
                    {
                        invoice = multi.Read<DeductionScale>().Single();
                        invoice.detail = multi.Read<DeductionScaleDetail>().ToList();
                    }
                }
                catch (Exception ex)
                {
                    if (ex.Message != "Sequence contains no elements")
                        throw ex;
                }
                return invoice;
            }
        }

        int IDeductionScaleRepository.add(DeductionScale item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                var deductionScaleParameter = new DeductionScaleDynamicParameter(item);

                int id = connection.ExecuteScalar<int>("deduction_scale_add", deductionScaleParameter, commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IDeductionScaleRepository.update(DeductionScale item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                var deductionScaleParameter = new DeductionScaleDynamicParameter(item);

                int id = connection.ExecuteScalar<int>("deduction_scale_update", deductionScaleParameter, commandType: CommandType.StoredProcedure);
            }
        }

        void IDeductionScaleRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("deduction_scale_delete", new { deductionScaleId = id }, commandType: CommandType.StoredProcedure);
            }
        }
    }
}

```
## DeductionSubplanRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Data;
using System.Data.SqlClient;
using System.Linq;
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.DynamicParameters;
using Dapper;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;

namespace AT.AT2017.Api.Repositories
{
    public class DeductionSubplanRepository : BaseRepository, IDeductionSubplanRepository
    {

        public DeductionSubplanRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<DeductionSubplan> IDeductionSubplanRepository.search(int companyId, bool isAgent)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<DeductionSubplan>("deduction_subplan_search",
                    new
                    {
                        companyID = companyId,
                        isAgent
                    },
                   commandType: CommandType.StoredProcedure).ToList();
            }
        }

        DeductionSubplan IDeductionSubplanRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<DeductionSubplan>("deduction_subplan_get", new { planId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int IDeductionSubplanRepository.add(DeductionSubplan item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("deduction_subplan_add",
                    new
                    {
                        item.subplanName,
                        item.companyID
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IDeductionSubplanRepository.update(IEnumerable<DeductionSubplan> table)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                var deductionSubplanParameter = new DeductionSubplanDynamicParameter(table);

                int id = connection.ExecuteScalar<int>("deduction_subplan_update", deductionSubplanParameter, commandType: CommandType.StoredProcedure);
            }
        }

        void IDeductionSubplanRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("deduction_subplan_delete", new { subplanId = id }, commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## DeletedRecordRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using AT.AT2017.Api.DynamicParameters;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class DeletedRecordRepository : BaseRepository, IDeletedRecordRepository
    {
        public DeletedRecordRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<DeletedRecord> IDeletedRecordRepository.search()
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<DeletedRecord>("delete_records_search", null, commandType: CommandType.StoredProcedure).ToList();
            }
        }

    }
}

```
## DivideExpenseTemplateRepository.cs
```cs
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using AT.AT2017.Api.DynamicParameters;
using System.Data.SqlClient;
using System;
using Newtonsoft.Json;

namespace AT.AT2017.Api.Repositories
{
    public class DivideExpenseTemplateRepository : BaseRepository, IDivideExpenseTemplateRepository
    {
        public DivideExpenseTemplateRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<DivideExpenseTemplate> IDivideExpenseTemplateRepository.search()
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<DivideExpenseTemplate>("divideExpenseTemplate_search", null, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        DivideExpenseTemplate IDivideExpenseTemplateRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                var item = connection.QueryFirstOrDefault<DivideExpenseTemplate>("divideExpenseTemplate_get", new { id = id }, commandType: CommandType.StoredProcedure);

                if (!String.IsNullOrWhiteSpace(item.config))
                {
                    item.detail = JsonConvert.DeserializeObject<IEnumerable<Item>>(item.config.ToString());
                }                     

                return item;
            }
        }

        int IDivideExpenseTemplateRepository.add(DivideExpenseTemplate item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                if (item.detail!=null && item.detail.Count()>0)
                {
                    item.config = JsonConvert.SerializeObject(item.detail, Formatting.Indented);
                }
               
                var parameter = new DivideExpenseTemplateDynamicParameter(item);

                int id = connection.ExecuteScalar<int>("divideExpenseTemplate_add", parameter, commandType: CommandType.StoredProcedure, commandTimeout: 0);

                return id;
            }
        }
    }
}

```
## DocumentRepository.cs
```cs
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class DocumentRepository : BaseRepository, IDocumentRepository
    {
        public DocumentRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<Document> IDocumentRepository.searchPending(string documentType)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<Document>("document_search_pending", new { documentType = documentType }, commandType: CommandType.StoredProcedure).ToList();
            }
        }


        void IDocumentRepository.update(Document item)
        {
            string procedure = "document_update";
            if (item.docType == "OFFICE" ){ procedure = "document_officeForm_update"; }

            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>(procedure,
                     new
                     {
                         ID = item.documentID,
                         item.url,
                         item.driveID
                     },
                     commandType: CommandType.StoredProcedure);
            }
        }

    }
}


```
## DropDownRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using AT.AT2017.Api.DynamicParameters;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class DropDownRepository : BaseRepository, IDropDownRepository
    {
        public DropDownRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<Dropdown> IDropDownRepository.search(string type)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<Dropdown>("dropdown_search",
                    new
                    {
                        type = type
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

    }
}

```
## ErrorCodeRepository.cs
```cs
using System.Collections.Generic;
using System.Linq;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;
using Microsoft.AspNetCore.Hosting;

namespace AT.AT2017.Api.Repositories
{
    public class ErrorCodeRepository : BaseRepository, IErrorCodeRepository
    {

        public ErrorCodeRepository(IHttpContextAccessor httpContextAccessor, IHostingEnvironment env,  IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, env, appSettings)
        {
        }

        IEnumerable<ErrorCode> IErrorCodeRepository.search(int systemID, int moduleID, int errorCodeID)
        {
            using (SqlConnection adminConnection = new SqlConnection(base.adminConnectionString))
            {
                return adminConnection.Query<ErrorCode>("errorCode_search", new { systemID = systemID, moduleID = moduleID, errorCodeID = errorCodeID }, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        ErrorCode IErrorCodeRepository.get(int id)
        {
            using (SqlConnection adminConnection = new SqlConnection(base.adminConnectionString))
            {
                return adminConnection.QueryFirstOrDefault<ErrorCode>("errorCode_get", new { errorCodeID = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int IErrorCodeRepository.add(ErrorCode item)
        {
            using (SqlConnection adminConnection = new SqlConnection(base.adminConnectionString))
            {
                int id = adminConnection.ExecuteScalar<int>("errorCode_add",
                    new
                    {
                        errorCode = item.errorCode,
                        moduleID = item.moduleID,
                        message = item.message,
                        details = item.details,
                        humanLanguage = item.humanLanguage,
                        showInBoard = item.showInBoard
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IErrorCodeRepository.update(ErrorCode item)
        {
            using (SqlConnection adminConnection = new SqlConnection(base.adminConnectionString))
            {
                int id = adminConnection.ExecuteScalar<int>("errorCode_update",
                    new
                    {
                        errorCodeID = item.errorCodeID,
                        errorCode = item.errorCode,
                        moduleID = item.moduleID,
                        message = item.message,
                        details = item.details,
                        humanLanguage = item.humanLanguage,
                        showInBoard = item.showInBoard
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IErrorCodeRepository.delete(int id)
        {
            using (SqlConnection adminConnection = new SqlConnection(base.adminConnectionString))
            {
                adminConnection.ExecuteScalar<int>("errorCode_delete", new { errorCodeID = id }, commandType: CommandType.StoredProcedure);
            }
        }

    }  
  
}

```
## ExtraVoucherRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class ExtraVoucherRepository : BaseRepository, IExtraVoucherRepository
    {
        public ExtraVoucherRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<ExtraVoucher> IExtraVoucherRepository.search(int companyID,  bool withTrash)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<ExtraVoucher>("extravoucher_search", new { companyID = companyID, withTrash = withTrash }, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<ExtraVoucher> IExtraVoucherRepository.searchDeletedRecord(int pageIndex, int pageSize)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<ExtraVoucher>("extravoucher_search_deleted",
                    new
                    {
                        pageIndex = pageIndex,
                        pageSize = pageSize
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        ExtraVoucher IExtraVoucherRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<ExtraVoucher>("extravoucher_get", new { extraVoucherID = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int IExtraVoucherRepository.add(ExtraVoucher item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("extravoucher_add",
                    new
                    {
                        companyID = item.companyID,
                        personID = item.personID,
                        officeID = item.officeID,
                        amount = item.amount,
                        name = item.name,
                        accountID = item.accountID,
                        usedForTRTypes = item.usedForTRTypes,
                        usedForClassificationIDs = item.usedForClassificationIDs,
                        doNotCreateIfExcludeSubmission = item.doNotCreateIfExcludeSubmission,
                        usedForLeadSourceIDs = item.usedForLeadSourceIDs,
                        usedForOfficeIDs = item.usedForOfficeIDs,
                        item.side,
                        item.leadGeneratedBy ,
                        item.planIDs ,
                        item.advancedCriteria,
                        item.taxExempt
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IExtraVoucherRepository.update(ExtraVoucher item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("extravoucher_update",
                    new
                    {
                        extraVoucherID = item.extraVoucherID,
                        personID = item.personID,
                        officeID = item.officeID,
                        amount = item.amount,
                        name = item.name,
                        accountID = item.accountID,
                        usedForTRTypes = item.usedForTRTypes,
                        usedForClassificationIDs = item.usedForClassificationIDs,
                        doNotCreateIfExcludeSubmission = item.doNotCreateIfExcludeSubmission,
                        usedForLeadSourceIDs = item.usedForLeadSourceIDs,
                        usedForOfficeIDs = item.usedForOfficeIDs ,
                        item.side,
                        item.leadGeneratedBy,
                        item.planIDs,
                        item.advancedCriteria,
                        item.taxExempt
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IExtraVoucherRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("extravoucher_delete", new { extraVoucherID = id }, commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## FeedProcessRepository.cs
```cs
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using System;
using Newtonsoft.Json;
using System.Data.SqlClient;
using System.Data;
using Dapper;

namespace AT.AT2017.Api.Repositories
{
    public class FeedProcessRepository : BaseRepository, IFeedProcessRepository
    {
        private ApplicationSettings _appSetting;
        protected SqlConnection _connection;
        IHttpContextAccessor _httpContextAccesor;

        public FeedProcessRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
            _appSetting = appSettings.Value;
            _httpContextAccesor = httpContextAccessor;
        }

        string IFeedProcessRepository.runStoredProcedure(string statement)
        {
            string jsonReponse = string.Empty;
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                DataTable dt = new DataTable();
                try
                {
                    SqlCommand command = new SqlCommand("feedprocess_run_storedprocedured", connection);
                    command.CommandType = CommandType.StoredProcedure;

                    SqlParameter p;
                    p = command.Parameters.Add("@statement", SqlDbType.NVarChar, 500);
                    p.Value = statement;

                    connection.Open();
                    SqlDataReader reader = command.ExecuteReader();
                    dt.Load(reader);
                    reader.Close();

                    jsonReponse = JsonConvert.SerializeObject(dt);

                }
                catch ( Exception ex)
                {
                    jsonReponse = ex.Message;
                }
            }
            return jsonReponse;
        }

        string IFeedProcessRepository.resolveFunction(string statement)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.ExecuteScalar<string>(
                    "feedprocess_resolve_function",
                    new
                    {
                        statement
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        string IFeedProcessRepository.resolveScript(string script)
        {
            using (SqlConnection connection = new SqlConnection(base.saConnectionString))
            {
                return connection.ExecuteScalar<string>(
                    "feedprocess_resolve_inlinescript",
                    new
                    {
                        script
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        string IFeedProcessRepository.transformResponse(string jsonToTransform, string script)
        {
            using (SqlConnection connection = new SqlConnection(base.saConnectionString))
            {
                return connection.ExecuteScalar<string>(
                    "feedprocess_transform_response",
                    new
                    {
                        jsonToTransform,
                        script
                    },
                    commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }
    }
}

```
## FeedRelationshipRepository.cs
```cs
using System.Collections.Generic;
using System.Linq;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;
using Microsoft.AspNetCore.Hosting;
using AT.AT2017.Api.Core.Models.Feeds;

namespace AT.AT2017.Api.Repositories
{
    public class FeedRelationshipRepository : BaseRepository, IFeedRelationshipRepository
    {
        public FeedRelationshipRepository(IHttpContextAccessor httpContextAccessor, IHostingEnvironment env, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, env, appSettings)
        {
        }
        
        IEnumerable<FeedRelationship> IFeedRelationshipRepository.search(int feedID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<FeedRelationship>("feedRelationship_search",
                    new
                    {
                        feedID = feedID
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<FeedRelationship> IFeedRelationshipRepository.search_from_master(int feedID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<FeedRelationship>("feedRelationship_search_from_master",
                    new
                    {
                        feedID = feedID
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }
    }
}

```
## FeedRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using AT.AT2017.Api.DynamicParameters;
using System.Data.SqlClient;
using Microsoft.AspNetCore.Hosting;
using Newtonsoft.Json;
using Microsoft.AspNetCore.Mvc;
using AT.AT2017.Api.Core.Models.Feeds;
using Hangfire;

namespace AT.AT2017.Api.Repositories
{
    public class FeedFilterDetailRepository : BaseRepository, IFeedFilterDetailRepository
    {
        public FeedFilterDetailRepository(IHttpContextAccessor httpContextAccessor, IHostingEnvironment env, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, env, appSettings)
        {
        }

        FeedFilterDetail IFeedFilterDetailRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<FeedFilterDetail>("feedFilterDetail_get", new { feedFilterDetailID = id }, commandType: CommandType.StoredProcedure);
            }
        }

        IEnumerable<FeedFilterDetail> IFeedFilterDetailRepository.search(int feedID, int feedFilterID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<FeedFilterDetail>("feedFilterDetail_search",
                    new
                    {
                        feedID = feedID,
                        feedFilterID = feedFilterID
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<FeedFilterDetail> IFeedFilterDetailRepository.search_from_master(int feedID, int feedFilterID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<FeedFilterDetail>("feedFilterDetail_search_from_master",
                    new
                    {
                        feedID = feedID,
                        feedFilterID = feedFilterID
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

    }

    public class FeedExecutionRepository : BaseRepository, IFeedExecutionRepository
    {
        public FeedExecutionRepository(IHttpContextAccessor httpContextAccessor, IHostingEnvironment env, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, env, appSettings)
        {
        }

        IEnumerable<FeedExecution> IFeedExecutionRepository.search(int feedID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<FeedExecution>("feedExecution_search",
                    new
                    {
                        feedID = feedID
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

    }

    public class FeedExecutionDetailRepository : BaseRepository, IFeedExecutionDetailRepository
    {
        public FeedExecutionDetailRepository(IHttpContextAccessor httpContextAccessor, IHostingEnvironment env, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, env, appSettings)
        {
        }

        IEnumerable<FeedExecutionDetail> IFeedExecutionDetailRepository.search(int executionID, int parentExecutionDetailID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<FeedExecutionDetail>("feedExecutionDetail_search",
                    new
                    {
                        executionID,
                        parentExecutionDetailID
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<FeedExecutionSourceRecordField> IFeedExecutionDetailRepository.getSourceData(int sourceRecordID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<FeedExecutionSourceRecordField>("feedExecutionDetail_get_sourcedata",
                    new
                    {
                        sourceRecordID
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<FeedExecutionDetail> IFeedExecutionDetailRepository.search_custom(int executionID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<FeedExecutionDetail>("feedExecutionGetCustomResult",
                    new
                    {
                        executionID = executionID
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

    }

    public class FeedExecutionRecordRepository : BaseRepository, IFeedExecutionRecordRepository
    {
        public FeedExecutionRecordRepository(IHttpContextAccessor httpContextAccessor, IHostingEnvironment env, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, env, appSettings)
        {
        }

        IEnumerable<FeedExecutionRecord> IFeedExecutionRecordRepository.search(int executionID, string type)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<FeedExecutionRecord>("feedExecutionRecord_search",
                    new
                    {
                        executionID = executionID,
                        type = type
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<FeedExecutionRecord> IFeedExecutionRecordRepository.searchParentRecords(int executionID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<FeedExecutionRecord>("feedexecutionRecord_search_parent_records",
                    new
                    {
                        executionID = executionID
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<FeedExecutionRecordChild> IFeedExecutionRecordRepository.searchChild(int executionID, int executionRecordId,string type)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<FeedExecutionRecordChild>("feedExecutionRecordChild_search",
                    new
                    {
                        executionID = executionID,
                        executionRecordId = executionRecordId,
                        type = type
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<FeedExecutionTransformationView> IFeedExecutionRecordRepository.searchTransformation(int executionID, string executionRecordId, string type)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<FeedExecutionTransformationView>("feedExecutionTransformation_search",
                    new
                    {
                        executionID = executionID,
                        guid = executionRecordId,
                        type = type
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<FeedExecutionTransformationDetail> IFeedExecutionRecordRepository.searchTransformationDetail(int executionID, int executionRecordId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<FeedExecutionTransformationDetail>("feedExecutionTransformationDetail_search",
                    new
                    {
                        detailId = executionID,
                        executionID = executionRecordId
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }
    }

    public class FeedMappingRepository : BaseRepository, IFeedMappingRepository
    {
        public FeedMappingRepository(IHttpContextAccessor httpContextAccessor, IHostingEnvironment env, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, env, appSettings)
        {
        }

        FeedMapping IFeedMappingRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<FeedMapping>("feedMapping_get", new { mappingID = id }, commandType: CommandType.StoredProcedure);
            }
        }

        IEnumerable<FeedMapping> IFeedMappingRepository.search(int feedID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<FeedMapping>("feedMapping_search",
                    new
                    {
                        feedID = feedID
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<FeedMapping> IFeedMappingRepository.search_from_master(int feedID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<FeedMapping>("feedMapping_search_from_master",
                    new
                    {
                        feedID = feedID
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

    }

    public class FeedMappingDetailRepository : BaseRepository, IFeedMappingDetailRepository
    {
        public FeedMappingDetailRepository(IHttpContextAccessor httpContextAccessor, IHostingEnvironment env, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, env, appSettings)
        {
        }

        FeedMappingDetail IFeedMappingDetailRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<FeedMappingDetail>("feedMappingDetail_get", new { mappingDetailID = id }, commandType: CommandType.StoredProcedure);
            }
        }

        IEnumerable<FeedMappingDetail> IFeedMappingDetailRepository.search(int feedID, int mappingID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<FeedMappingDetail>("feedMappingDetail_search",
                    new
                    {
                        feedID = feedID,
                        mappingID = mappingID
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<FeedMappingDetail> IFeedMappingDetailRepository.search_from_master(int feedID, int mappingID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<FeedMappingDetail>("feedMappingDetail_search_from_master",
                    new
                    {
                        feedID = feedID,
                        mappingID = mappingID
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

    }

    public class FeedTransformationRepository : BaseRepository, IFeedTransformationRepository
    {
        public FeedTransformationRepository(IHttpContextAccessor httpContextAccessor, IHostingEnvironment env, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, env, appSettings)
        {
        }

        FeedTransformation IFeedTransformationRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<FeedTransformation>("feedTransformation_get", new { transformationID = id }, commandType: CommandType.StoredProcedure);
            }
        }

        IEnumerable<FeedTransformation> IFeedTransformationRepository.search(int feedID, int mappingID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<FeedTransformation>("feedTransformation_search",
                    new
                    {
                        feedID = feedID,
                        mappingID = mappingID
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<FeedTransformation> IFeedTransformationRepository.search_from_master(int feedID, int mappingID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<FeedTransformation>("feedTransformation_search_from_master",
                    new
                    {
                        feedID = feedID,
                        mappingID = mappingID
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        string IFeedTransformationRepository.evalCondition(string condition)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                string res = connection.ExecuteScalar<string>("feed_evalCondition", new
                {
                    condition = condition
                }, commandType: CommandType.StoredProcedure);

                return res;
            }
        }

        string IFeedTransformationRepository.evalReplaceWith(string condition)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                string res = connection.ExecuteScalar<string>("feed_evalReplaceWith", new
                {
                    condition = condition
                }, commandType: CommandType.StoredProcedure);

                return res;
            }
        }

        IEnumerable<FeedTransformation> IFeedTransformationRepository.getTemplates(int feedID, int mappingID, int sourceFieldID, int atFieldID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<FeedTransformation>("feedtransformation_get_templates",
                    new
                    {
                        feedID,
                        mappingID,
                        sourceFieldID,
                        atFieldID
                    }, commandType: CommandType.StoredProcedure).ToList();
            }
        }
    }

    public class FeedScheduleRepository : BaseRepository, IFeedScheduleRepository
    {
        public FeedScheduleRepository(IHttpContextAccessor httpContextAccessor, IHostingEnvironment env, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, env, appSettings)
        {
        }

        FeedSchedule IFeedScheduleRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<FeedSchedule>("feedSchedule_get", new { scheduleID = id }, commandType: CommandType.StoredProcedure);
            }
        }

        IEnumerable<FeedSchedule> IFeedScheduleRepository.search(int feedID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<FeedSchedule>("feedSchedule_search",
                    new
                    {
                        feedID = feedID
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<FeedSchedule> IFeedScheduleRepository.search_from_master(int feedID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<FeedSchedule>("feedSchedule_search_from_master",
                    new
                    {
                        feedID = feedID
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

    }

    public class FeedMatchingRepository : BaseRepository, IFeedMatchRepository
    {
        public FeedMatchingRepository(IHttpContextAccessor httpContextAccessor, IHostingEnvironment env, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, env, appSettings)
        {
        }

        FeedMatching IFeedMatchRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<FeedMatching>("feedMatching_get", new { feedMatchingID = id }, commandType: CommandType.StoredProcedure);
            }
        }

        public IEnumerable<FeedMatching> search(int feedID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<FeedMatching>("feedMatching_search",
                    new
                    {
                        feedID = feedID
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        public IEnumerable<FeedMatching> search_from_master(int feedID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<FeedMatching>("feedMatching_search_from_master",
                    new
                    {
                        feedID = feedID
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

    }
    
    public class FeedFilterRepository : BaseRepository, IFeedFilterRepository
    {
        public FeedFilterRepository(IHttpContextAccessor httpContextAccessor, IHostingEnvironment env, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, env, appSettings)
        {
        }

        FeedFilter IFeedFilterRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<FeedFilter>("feedFilter_get", new { feedFilterID = id }, commandType: CommandType.StoredProcedure);
            }
        }

        string IFeedFilterRepository.executeSentence(string sentence)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                string res = connection.ExecuteScalar<string>("feed_execute_sentence", new
                {
                    sentence = sentence
                }, commandType: CommandType.StoredProcedure);

                return res;
            }
        }


        IEnumerable<FeedFilter> IFeedFilterRepository.search(int feedID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<FeedFilter>("feedFilter_search",
                    new
                    {
                        feedID = feedID
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<FeedFilter> IFeedFilterRepository.search_from_master(int feedID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<FeedFilter>("feedFilter_search_from_master",
                    new
                    {
                        feedID = feedID
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

    }

    public class FeedPODFilterRepository : BaseRepository, IFeedPODFilterRepository
    {
        public FeedPODFilterRepository(IHttpContextAccessor httpContextAccessor, IHostingEnvironment env, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, env, appSettings)
        {
        }

        IEnumerable<FeedPODFilter> IFeedPODFilterRepository.search(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<FeedPODFilter>("feed_podfilter_search", new { feedID = id }, commandType: CommandType.StoredProcedure);
            }
        }

        IEnumerable<FeedPODFilter> IFeedPODFilterRepository.search_from_master(int feedID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<FeedPODFilter>("feedPODFilter_search_from_master",
                    new
                    {
                        feedID = feedID
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        FeedPODFilter IFeedPODFilterRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<FeedPODFilter>("feed_podfilter_get", new { feedFilterID = id }, commandType: CommandType.StoredProcedure);
            }
        }

        FeedPODFilter IFeedPODFilterRepository.getByName(int feedResourceID, string sourceField)
        {
            using (SqlConnection connection = new SqlConnection(base.adminConnectionString))
            {
                return connection.QueryFirstOrDefault<FeedPODFilter>("feed_podfilter_search_by_name",
                    new
                    {
                        feedResourceID,
                        sourceField
                    }, commandType: CommandType.StoredProcedure);
            }
        }

        int IFeedPODFilterRepository.add(FeedPODFilter item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("feed_podfilter_add",
                    new
                    {
                        feedID = item.feedID,
                        sourceFieldID = item.sourceFieldID
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IFeedPODFilterRepository.update(FeedPODFilter item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("feed_podfilter_update",
                    new
                    {
                        feedFilterID = item.feedFilterID,
                        sourceFieldID = item.sourceFieldID
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IFeedPODFilterRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("feed_podfilter_delete", new { feedFilterID = id }, commandType: CommandType.StoredProcedure);
            }
        }

    }

    public class FeedRepository : BaseRepository, IFeedRepository
    {

        private IBackgroundJobClient _backgroundJobs;

        public FeedRepository(IHttpContextAccessor httpContextAccessor, IHostingEnvironment env, IOptions<ApplicationSettings> appSettings, IBackgroundJobClient backgroundJobs) : base(httpContextAccessor, env, appSettings)
        {
            _backgroundJobs = backgroundJobs;
        }

        IEnumerable<Feed> IFeedRepository.search(int feedTypeID, int feedSubtypeID, int feedResourceID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<Feed>("feed_search",
                    new
                    {
                        feedTypeID = feedTypeID,
                        feedSubtypeID = feedSubtypeID,
                        feedResourceID = feedResourceID
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        void IFeedRepository.update_init(int feedID, string companyID, string companyGUID, string brandCode)
        {           
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("feed_update_init",
                    new
                    {
                        feedID = feedID,
                        dashBrandCode = brandCode,
                        dashCompanyID = companyID,
                        dashCompanyGUID = companyGUID
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        IEnumerable<Feed> IFeedRepository.search_from_master(int feedTypeID, int feedSubtypeID, int feedResourceID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<Feed>("feed_search_from_master",
                    new
                    {
                        feedTypeID = feedTypeID,
                        feedSubtypeID = feedSubtypeID,
                        feedResourceID = feedResourceID
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<Feed> IFeedRepository.search_from_submit_init(int feedTypeID, int feedSubtypeID, string process, string brandCode)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<Feed>("feed_search_submit_init",
                    new
                    {
                        feedTypeID = feedTypeID,
                        feedSubtypeID = feedSubtypeID,
                        process = process,
                        brandCode = brandCode
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        Feed IFeedRepository.get_by_setting(int propID, string setting)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<Feed>("feed_get_by_setting", new { propID, setting }, commandType: CommandType.StoredProcedure);
            }
        }

        Feed IFeedRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<Feed>("feed_get", new { feedId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        void IFeedRepository.exportToMaster(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("feed_export_to_master", new { feedID = id }, commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }

        Feed IFeedRepository.get_from_master(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<Feed>("feed_get_from_master", new { feedId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int IFeedRepository.add(Feed feed)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                var feedParameter = new FeedDynamicParameter(feed);

                int id = connection.ExecuteScalar<int>("feed_add", feedParameter, commandTimeout: 180, commandType: CommandType.StoredProcedure);

                autofixTransformationOrder(feed.feedID);

                autofixFilterOrder(feed.feedID);

                // start a background worker
                _backgroundJobs.Enqueue(() => this.synchronizeMetadataAsync(connectionString));

                return id;
            }
        }

        int IFeedRepository.add_submit_init(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int feedId = connection.ExecuteScalar<int>("feed_add_submit_init", new { feedID = id }, commandTimeout: 180, commandType: CommandType.StoredProcedure);

                return feedId;
            }
        }

        void IFeedRepository.update(Feed feed)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                var feedParameter = new FeedDynamicParameter(feed);

                int id = connection.ExecuteScalar<int>("feed_update", feedParameter, commandTimeout: 180, commandType: CommandType.StoredProcedure);

                autofixTransformationOrder(feed.feedID);

                autofixFilterOrder(feed.feedID);

                // start a background worker
                _backgroundJobs.Enqueue(() => this.synchronizeMetadataAsync(connectionString));
            }
        }

        void IFeedRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("feed_delete", new { feedID = id }, commandType: CommandType.StoredProcedure);
            }
        }

        bool IFeedRepository.getConexionCATYLIST(Feed feed)
        {
            bool connectionTest = false;
            string jsonResponse = string.Empty;
            try
            {
                string url = feed.url;
                string api_key = feed.password;
                int from = 0;
                int size = 1;
                string modifiedSince = DateTime.Now.ToString("yyyy-MM-dd");
                using (SqlConnection connection = new SqlConnection(base.saConnectionString))
                {
                    SqlCommand command = new SqlCommand("feed_get_catylist_remote", connection);
                    command.Parameters.Add("@url", SqlDbType.VarChar);
                    command.Parameters["@url"].Value = url;
                    command.Parameters.Add("@apiKey", SqlDbType.VarChar);
                    command.Parameters["@apiKey"].Value = api_key;
                    command.Parameters.Add("@from", SqlDbType.Int);
                    command.Parameters["@from"].Value = from;
                    command.Parameters.Add("@size", SqlDbType.Int);
                    command.Parameters["@size"].Value = size;
                    command.Parameters.Add("@modifiedSince", SqlDbType.VarChar);
                    command.Parameters["@modifiedSince"].Value = modifiedSince;
                    command.CommandType = CommandType.StoredProcedure;
                    command.CommandTimeout = 0;

                    connection.Open();
                    jsonResponse = command.ExecuteScalar().ToString();

                    dynamic response = JsonConvert.DeserializeObject(jsonResponse);
                    if (response.results != null)
                    {
                        connectionTest = true;
                    }
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message);
                connectionTest = false;
            }
            return connectionTest;
        }

        int IFeedRepository.copy(int feedID, string feedNameDest, int feedTypeIDDest, int feedSubTypeIDDest, int feedResourceIDDest)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.ExecuteScalar<int>("feed_copy",
                     new
                     {
                         feedID,
                         feedNameDest,
                         feedTypeIDDest,
                         feedSubTypeIDDest,
                         feedResourceIDDest
                     }, commandTimeout: 60, commandType: CommandType.StoredProcedure);
            }
        }

        public void synchronizeMetadataAsync(string connectionString)
        {
            using (SqlConnection connection = new SqlConnection(connectionString))
            {
                connection.Execute(
                    "feed_metadata_sync_tables",
                    null,
                    commandType: CommandType.StoredProcedure,
                    commandTimeout: 0);
            }
        }

        private void autofixTransformationOrder(int id)
        {
            using (SqlConnection saConnection = new SqlConnection(base.saConnectionString))
            {
                saConnection.Execute("feedTransformation_fix_sortorder", new { feedID = id }, commandType: CommandType.StoredProcedure);
            }
        }

        private void autofixFilterOrder(int id)
        {
            using (SqlConnection saConnection = new SqlConnection(base.saConnectionString))
            {
                saConnection.Execute("feedfilter_fix_sortorder", new { feedID = id }, commandType: CommandType.StoredProcedure);
            }
        }
    }

    public class FeedTypeRepository : BaseRepository, IFeedTypeRepository
    {
        public FeedTypeRepository(IHttpContextAccessor httpContextAccessor, IHostingEnvironment env, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, env, appSettings)
        {
        }

        IEnumerable<FeedType> IFeedTypeRepository.search(string type)
        {
            using (SqlConnection adminConnection = new SqlConnection(base.adminConnectionString))
            {
                return adminConnection.Query<FeedType>("feedType_search", new { type = type }, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        int IFeedTypeRepository.add(FeedType item)
        {
            using (SqlConnection connection = new SqlConnection(base.adminConnectionString))
            {
                int id = connection.ExecuteScalar<int>("feedType_add",
                    new
                    {
                        name = item.type
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IFeedTypeRepository.update(FeedType item)
        {
            using (SqlConnection connection = new SqlConnection(base.adminConnectionString))
            {
                int id = connection.ExecuteScalar<int>("feedType_update",
                    new
                    {
                        feedTypeID = item.feedTypeID,
                        name = item.type
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IFeedTypeRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.adminConnectionString))
            {
                connection.Execute("feedType_delete", new { feedTypeID = id}, commandType: CommandType.StoredProcedure);
            }
        }

    }

    public class FeedSubTypeRepository : BaseRepository, IFeedSubTypeRepository
    {

        public FeedSubTypeRepository(IHttpContextAccessor httpContextAccessor, IHostingEnvironment env, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, env, appSettings)
        {
        }

         IEnumerable<FeedSubtype> IFeedSubTypeRepository.search(int feedTypeID)
        {
            using (SqlConnection adminConnection = new SqlConnection(base.adminConnectionString))
            {
                return adminConnection.Query<FeedSubtype>("feedSubType_search", new { feedTypeID = feedTypeID }, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        FeedSubtype IFeedSubTypeRepository.get(int id)
        {
            using (SqlConnection adminConnection = new SqlConnection(base.adminConnectionString))
            {
                return adminConnection.QueryFirstOrDefault<FeedSubtype>("feedSubType_get", new { feedSubTypeID = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int IFeedSubTypeRepository.add(FeedSubtype item)
        {
            using (SqlConnection connection = new SqlConnection(base.adminConnectionString))
            {
                int id = connection.ExecuteScalar<int>("feedSubType_add",
                    new
                    {
                        item.subType,
                        feedTypeID = item.feedtypeID,
                        item.endpointList,
                        item.endpointDetail,
                        item.endpointPullOnDemand,
                        item.endpointToken
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IFeedSubTypeRepository.update(FeedSubtype item)
        {
            using (SqlConnection connection = new SqlConnection(base.adminConnectionString))
            {
                int id = connection.ExecuteScalar<int>("feedSubType_update",
                    new
                    {
                        feedSubTypeID = item.feedSubtypeID,
                        item.subType,
                        item.endpointList,
                        item.endpointDetail,
                        item.endpointPullOnDemand,
                        item.endpointToken
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IFeedSubTypeRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.adminConnectionString))
            {
                connection.Execute("feedSubType_delete", new { feedSubTypeID = id }, commandType: CommandType.StoredProcedure);
            }
        }
    }

    public class FeedResourceRepository : BaseRepository, IFeedResourceRepository
    {

        public FeedResourceRepository(IHttpContextAccessor httpContextAccessor, IHostingEnvironment env, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, env, appSettings)
        {
        }

        IEnumerable<FeedResource> IFeedResourceRepository.search(int feedSubTypeID)
        {
            using (SqlConnection adminConnection = new SqlConnection(base.adminConnectionString))
            {
                return adminConnection.Query<FeedResource>("feedResource_search", new { feedSubTypeID = feedSubTypeID }, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        void IFeedResourceRepository.refreshMetaData(FeedResourceMetaData feedResourcesMetaData)
        {
            using (SqlConnection adminConnection = new SqlConnection(base.adminConnectionString))
            {
                var feedResourcesMetaDataParameter = new FeedResourceMetaDataDynamicParameter(feedResourcesMetaData);

                adminConnection.ExecuteScalar<int>("feedResource_refresh_metadata", feedResourcesMetaDataParameter, commandTimeout: 0, commandType: CommandType.StoredProcedure);
            }
        }

        int IFeedResourceRepository.add(FeedResource item)
        {
            using (SqlConnection connection = new SqlConnection(base.adminConnectionString))
            {
                int id = connection.ExecuteScalar<int>("feedResource_add",
                    new
                    {
                        feedTypeID = item.feedTypeID,
                        feedSubTypeID = item.feedSubtypeID,
                        resource = item.resource
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IFeedResourceRepository.update(FeedResource item)
        {
            using (SqlConnection connection = new SqlConnection(base.adminConnectionString))
            {
                int id = connection.ExecuteScalar<int>("feedResource_update",
                    new
                    {
                        feedResourceID = item.feedResourceID,
                        resource = item.resource
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        FeedResource IFeedResourceRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.adminConnectionString))
            {
                return connection.QueryFirstOrDefault<FeedResource>("feedResource_get", new { feedResourceID = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int IFeedResourceRepository.addFull(FeedResource item)
        {
            using (SqlConnection connection = new SqlConnection(base.adminConnectionString))
            {
                var feedParameter = new FeedResourceDynamicParameter(item);

                int id = connection.ExecuteScalar<int>("feedResource_fullAdd", feedParameter, commandTimeout: 180, commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IFeedResourceRepository.updateFull(FeedResource item)
        {
            using (SqlConnection connection = new SqlConnection(base.adminConnectionString))
            {
                var feedParameter = new FeedResourceDynamicParameter(item);

                int id = connection.ExecuteScalar<int>("feedResource_fullUpdate", feedParameter, commandTimeout: 180, commandType: CommandType.StoredProcedure);
            }
        }

        void IFeedResourceRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.adminConnectionString))
            {
                connection.Execute("feedResource_delete", new { feedResourceID = id }, commandType: CommandType.StoredProcedure);
            }
        }
    }

     public class FeedSourceFieldRepository : BaseRepository, IFeedSourceFieldRepository
    {

        public FeedSourceFieldRepository(IHttpContextAccessor httpContextAccessor, IHostingEnvironment env, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, env, appSettings)
        {
        }

        IEnumerable<FeedSourceField> IFeedSourceFieldRepository.search(int feedResourceID)
        {
            using (SqlConnection adminConnection = new SqlConnection(base.adminConnectionString))
            {
                return adminConnection.Query<FeedSourceField>("feedSourceField_search", new { feedResourceID = feedResourceID }, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        void IFeedSourceFieldRepository.add(int feedResourceID, List<FeedSourceField> sourceFields)
        {
            using (SqlConnection adminConnection = new SqlConnection(base.adminConnectionString))
            {
                foreach (var item in sourceFields)
                {
                    adminConnection.ExecuteScalar<int>("feedSourcefield_add",
                        new
                        {
                            item.sourceField,
                            feedResourceID,
                            item.sampleData
                        },
                        commandType: CommandType.StoredProcedure);
                }
            }
        }

        int IFeedSourceFieldRepository.add(FeedSourceField item)
        {
            using (SqlConnection connection = new SqlConnection(base.adminConnectionString))
            {
                int id = connection.ExecuteScalar<int>("feedSourceField_add",
                    new
                    {
                        feedResourceID = item.feedResourceID,
                        sourceField = item.sourceField,
                        dataType = item.DataType,
                        sampleData = item.sampleData,
                        separator = item.UseSeparator,
                        formula = item.formula
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IFeedSourceFieldRepository.update(FeedSourceField item)
        {
            using (SqlConnection connection = new SqlConnection(base.adminConnectionString))
            {
                int id = connection.ExecuteScalar<int>("feedSourceField_update",
                    new
                    {
                        sourceFieldID = item.sourceFieldID,
                        sourceField = item.sourceField,
                        dataType = item.DataType,
                        childResourceID = item.childResourceID,
                        separator = item.UseSeparator,
                        formula = item.formula
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IFeedSourceFieldRepository.updateSampleData(int feedResourceID, List<FeedSourceField> sourceFields)
        {
            using (SqlConnection adminConnection = new SqlConnection(base.adminConnectionString))
            {
                foreach (var item in sourceFields)
                {
                    adminConnection.ExecuteScalar<int>("feedSourcefield_update_sampledata",
                        new
                        {
                            item.sourceFieldID,
                            item.sampleData,
                            item.DataType
                        },
                        commandType: CommandType.StoredProcedure);
                }
            }
        }
    }

    public class FeedResourceFieldLookupRepository : BaseRepository, IFeedSourceFieldLookupRepository 
    {
        public FeedResourceFieldLookupRepository(IHttpContextAccessor httpContextAccessor, IHostingEnvironment env, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, env, appSettings)
        {
        }

        IEnumerable<FeedSourceFieldLookup> IFeedSourceFieldLookupRepository.search(int subTypeID, string lookupName)
        {
            using (SqlConnection adminConnection = new SqlConnection(base.adminConnectionString))
            {
                return adminConnection.Query<FeedSourceFieldLookup>("feedSourceFieldLookup_search", new { subTypeID = subTypeID, lookupName = lookupName }, commandType: CommandType.StoredProcedure).ToList();
            }
        }
    }

    public class FeedAtTableRepository : BaseRepository, IFeedAtTableRepository
    {

        public FeedAtTableRepository(IHttpContextAccessor httpContextAccessor, IHostingEnvironment env, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, env, appSettings)
        {
        }

        IEnumerable<FeedAtTable> IFeedAtTableRepository.search(string tableName,int type)
        {
            using (SqlConnection adminConnection = new SqlConnection(base.adminConnectionString))
            {
                return adminConnection.Query<FeedAtTable>("feedAtTable_search", new { tableName = tableName, type= type }, commandType: CommandType.StoredProcedure).ToList();
            }
        }
        
    }
    
    public class FeedAtTableDetailRepository : BaseRepository, IFeedAtTableDetailRepository
    {

        public FeedAtTableDetailRepository(IHttpContextAccessor httpContextAccessor, IHostingEnvironment env, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, env, appSettings)
        {
        }

        IEnumerable<FeedAtTableDetail> IFeedAtTableDetailRepository.search(int tableID)
        {
            using (SqlConnection adminConnection = new SqlConnection(base.adminConnectionString))
            {
                return adminConnection.Query<FeedAtTableDetail>("feedAtTableDetail_search", new { tableID = tableID }, commandType: CommandType.StoredProcedure).ToList();
            }
        }
    }

    public class FeedAtFieldRepository : BaseRepository, IFeedAtFieldRepository
    {

        public FeedAtFieldRepository(IHttpContextAccessor httpContextAccessor, IHostingEnvironment env, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, env, appSettings)
        {
        }

        IEnumerable<FeedAtField> IFeedAtFieldRepository.search(string tableName)
        {
            using (SqlConnection adminConnection = new SqlConnection(base.adminConnectionString))
            {
                return adminConnection.Query<FeedAtField>("feedAtField_search", new { tableName = tableName }, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        FeedAtField IFeedAtFieldRepository.get(int id)
        {
            using (SqlConnection adminConnection = new SqlConnection(base.adminConnectionString))
            {
                return adminConnection.QueryFirstOrDefault<FeedAtField>("feedAtField_get", new { atFieldID = id }, commandType: CommandType.StoredProcedure);
            }
        }
    }

    public class FeedAtFunctionRepository : BaseRepository, IFeedAtFunctionRepository
    {

        public FeedAtFunctionRepository(IHttpContextAccessor httpContextAccessor, IHostingEnvironment env, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, env, appSettings)
        {
        }

        IEnumerable<FeedAtFunction> IFeedAtFunctionRepository.search(string functionName)
        {
            using (SqlConnection adminConnection = new SqlConnection(base.adminConnectionString))
            {
                return adminConnection.Query<FeedAtFunction>("feedAtFunction_search", new { functionName = functionName }, commandType: CommandType.StoredProcedure).ToList();
            }
        }
    }

}

```
## FormControlRepository.cs
```cs
using System.Collections.Generic;
using System.Data;
using System.Data.SqlClient;
using System.Linq;
using AT.AT2017.Api.Core.Models;
using Dapper;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;

namespace AT.AT2017.Api.Repositories
{
    public class FormControlRepository : BaseRepository, IFormControlRepository
    {
        public FormControlRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<FormControl> IFormControlRepository.search(string formName)
        {
            using (SqlConnection connection = new SqlConnection(base.adminConnectionString))
            {
                return connection.Query<FormControl>("form_control_search",
                   new
                   {
                       formName
                   },
                   commandType: CommandType.StoredProcedure).ToList();
            }
        }

        int IFormControlRepository.addOrUpdate(FormControl item)
        {
            using (SqlConnection connection = new SqlConnection(base.adminConnectionString))
            {
                int id = connection.ExecuteScalar<int>("form_control_add_or_update",
                    new
                    {
                        item.name,
                        item.type,
                        item.originalText,
                        item.formName,
                        item.parent
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

    }
}

```
## FortePaymentLogRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{

    public class FortePaymentLogRepository : BaseRepository, IFortePaymentLogRepository
    {
        public FortePaymentLogRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }
              
        void IFortePaymentLogRepository.add(FortePaymentLog item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("fortePaymentLog_add",
                   new
                   {
                       paymentId = item.paymentId,
                       paymentType = item.paymentType,
                       responseCode = item.responseCode,
                       responseDescription = item.responseDescription,
                       authorization_code = item.authorization_code,
                       avs_result = item.avs_result,
                       cvv_result = item.cvv_result,
                       customer_token = item.customer_token,
                       transaction_id = item.transaction_id,
                       location_id = item.location_id,
                       order_number = item.order_number,
                       reference_id = item.reference_id,
                       action = item.action,
                       authorization_amount = item.authorization_amount,
                       entered_by = item.entered_by,
                       json = item.json,
                       paymethodType = item.paymethodType,
                       byEmail = item.byEmail
                   },
                   commandType: CommandType.StoredProcedure);
            }          
       }

        FortePaymentLog IFortePaymentLogRepository.get(int id,string type)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<FortePaymentLog>("fortePaymentLog_get", new { paymentId = id, paymentType = type }, commandType: CommandType.StoredProcedure);
            }
        }
    }
}

```
## ForteRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class ForteRepository : BaseRepository, IForteRepository
    {
        public ForteRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        void IForteRepository.addLog(int id,string method, string request, string response, string error)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("forteCallsLog_add",
                   new
                   {
                       id,
                       method,
                       request,
                       response,
                       error
                   },
                   commandType: CommandType.StoredProcedure);
            }
        }

        void IForteRepository.addPaymentMethod(int personId, string merchantId, string clientId, string paymethodType, string paymethodId,bool isDefault, string label, string last4AccountNumber,
            string accountType ,string routingNumber,string nameOn,string maskedAccountNumber,int expireYear,int expireMonth, string cardType , bool procurementCard, bool suppressAccountUpdate,string accountHolder)
        {
             using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("personPaymentMethod_add",
                   new
                   {
                       personId,
                       merchantId,
                       clientId,
                       paymethodType,
                       paymethodId,
                       label,
                       last4AccountNumber,
                       accountType,
                       routingNumber,
                       nameOn,
                       maskedAccountNumber,
                       expireYear,
                       expireMonth,
                       cardType,
                       procurementCard,
                       suppressAccountUpdate,
                       accountHolder,
                       isDefault
                   },
                   commandType: CommandType.StoredProcedure);
            }
        }

        void IForteRepository.deletePaymentMethod(string paymethodId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("personPaymentMethod_delete",
                   new
                   {
                       paymethodId
                   },
                   commandType: CommandType.StoredProcedure);
            }
        }

        PaymentMethod IForteRepository.getPaymentMethods(int personId, string merchantId)
        {            
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<PaymentMethod>("personPaymentMethod_get", new { personId,merchantId }, commandType: CommandType.StoredProcedure);
            }
           
        }
    }
}

```
## GLAccountCommissionRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class GLAccountCommissionRepository : BaseRepository, IGLAccountCommissionRepository
    {
        public GLAccountCommissionRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<GLAccountCommission> IGLAccountCommissionRepository.search(int accountId, int classificationId, int deductionId, string side)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<GLAccountCommission>("glaccount_commission_search",
                   new
                   {
                       accountId = accountId,
                       classificationId = classificationId,
                       deductionId = deductionId,
                       side = side
                   },
                   commandType: CommandType.StoredProcedure).ToList();
            }
        }

        GLAccountCommission IGLAccountCommissionRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<GLAccountCommission>("glaccount_commission_get", new { accountCommissionId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int IGLAccountCommissionRepository.add(GLAccountCommission item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("glaccount_commission_add",
                    new
                    {
                        accountId = item.accountId,
                        classificationId = item.classificationId,
                        deductionId = item.deductionId,
                        side = item.side
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IGLAccountCommissionRepository.update(GLAccountCommission item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("glaccount_commission_update",
                   new
                   {
                       accountCommissionId = item.accountCommissionId,
                       accountId = item.accountId,
                       classificationId = item.classificationId,
                       deductionId = item.deductionId,
                       side = item.side
                   },
                   commandType: CommandType.StoredProcedure);
            }
        }

        void IGLAccountCommissionRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("glaccount_commission_delete", new { accountCommissionId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        void IGLAccountCommissionRepository.copy(int classificationId, int classificationCopyId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("glaccount_commission_copy", new { classificationId = classificationId, classificationCopyId = classificationCopyId }, commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## GLAccountFortePersonTypeRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using AT.AT2017.Api.DynamicParameters;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class GLAccountFortePersonTypeRepository : BaseRepository, IGLAccountFortePersonTypeRepository
    {
        public GLAccountFortePersonTypeRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<GLAccountFortePersonType> IGLAccountFortePersonTypeRepository.search(int accountId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<GLAccountFortePersonType>("glAccountFortePersonType_search",
                 new
                 {
                    accountId = accountId
                 },
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }       

    }
}

```
## GLAccountPeriodLockRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using System.Data;
using Dapper;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class GLAccountPeriodLockRepository : BaseRepository, IGLAccountPeriodLockRepository
    {
        public GLAccountPeriodLockRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<GLAccountPeriodLock> IGLAccountPeriodLockRepository.search(int companyId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<GLAccountPeriodLock>("glaccount_period_lock_search", 
                    new
                    {
                        companyID = companyId
                    }, commandType: CommandType.StoredProcedure).ToList();
            }
        }
        
        GLAccountPeriodLock IGLAccountPeriodLockRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<GLAccountPeriodLock>("glaccount_period_lock_get", new { periodLockId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int IGLAccountPeriodLockRepository.add(GLAccountPeriodLock item)
        {
            using (SqlConnection connection = new SqlConnection(base.saConnectionString))
            {
                int id = connection.ExecuteScalar<int>("glaccount_period_lock_add",
                    new
                    {
                        item.endDate,
                        item.type,
                        item.createdBy,
                        item.companyId 
                    },
                    commandType: CommandType.StoredProcedure, commandTimeout: 0);

                return id;
            }
        }

        void IGLAccountPeriodLockRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("glaccount_period_lock_delete", new { periodLockID = id }, commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## GLAccountPeriodRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using AT.AT2017.Api.Core.Models;
using System.Data;
using Dapper;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class GLAccountPeriodRepository : BaseRepository, IGLAccountPeriodRepository
    {
        public GLAccountPeriodRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }


        IEnumerable<GLAccountPeriod> IGLAccountPeriodRepository.search(string active)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<GLAccountPeriod>("glaccount_period_search",
                   new
                   {
                       active = active
                   },
                   commandType: CommandType.StoredProcedure).ToList();
            }
        }

        GLAccountPeriod IGLAccountPeriodRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<GLAccountPeriod>("glaccount_period_get", new { periodId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int IGLAccountPeriodRepository.add(GLAccountPeriod item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("glaccount_period_add",
                    new
                    {
                        startDate = item.startDate,
                        endDate = item.endDate
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IGLAccountPeriodRepository.update(GLAccountPeriod item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("glaccount_period_update",
                    new
                    {
                        periodId = item.periodId,
                        startDate = item.startDate,
                        endDate = item.endDate,
                        active = item.active
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IGLAccountPeriodRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("glaccount_period_delete", new { periodId = id }, commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## GLAccountRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using System.Data;
using Dapper;
using System.Data.SqlClient;
using AT.AT2017.Api.DynamicParameters;

namespace AT.AT2017.Api.Repositories
{
    public class GLAccountRepository : BaseRepository, IGLAccountRepository
    {

        public GLAccountRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<GLAccount> IGLAccountRepository.search(int companyId, string accountNumber, string description, string accountType, string headerType, string isEscrow, string systemAccount, bool withTrash)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<GLAccount>("glaccount_search",
                   new
                   {
                       companyId = companyId,
                       accountNumber = accountNumber,
                       description = description,
                       accountType = accountType,
                       headerType = headerType,
                       isEscrow = isEscrow,
                       systemAccount = systemAccount,
                       withTrash = withTrash
                   },
                   commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<GLAccount> IGLAccountRepository.searchDeletedRecord(int pageIndex, int pageSize)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<GLAccount>("glaccount_search_deleted",
                   new
                   {
                       pageIndex = pageIndex,
                       pageSize = pageSize
                   },
                   commandType: CommandType.StoredProcedure).ToList();
            }
        }

        GLAccount IGLAccountRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<GLAccount>("glaccount_get", new { accountId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int IGLAccountRepository.add(GLAccount item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("glaccount_add",
                    new
                    {
                        accountNumber = item.accountNumber,
                        description = item.description,
                        accountType = item.accountType,
                        headerType = item.headerType,
                        systemAccount = item.systemAccount,
                        headerAccountId = item.headerAccountId,
                        companyId = item.companyId,
                        isEscrow = item.isEscrow,
                        escrowLiabilityID = item.escrowLiabilityId,
                        isCommission = item.isCommission
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        decimal IGLAccountRepository.getBalance(int accountId, int companyId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                decimal balance = connection.ExecuteScalar<decimal>("glaccount_get_balance",
                    new
                    {
                        accountId = accountId,
                        companyId = companyId
                    },
                    commandType: CommandType.StoredProcedure,
                    commandTimeout: 0);

                return balance;
            }
        }

        void IGLAccountRepository.update(GLAccount item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("glaccount_update",
                    new
                    {
                        accountId = item.accountId,
                        accountNumber = item.accountNumber,
                        description = item.description,
                        accountType = item.accountType,
                        headerType = item.headerType,
                        systemAccount = item.systemAccount,
                        headerAccountId = item.headerAccountId,
                        isEscrow = item.isEscrow,
                        escrowLiabilityId = item.escrowLiabilityId,
                        isCommission = item.isCommission,
                        routingNumber = item.routingNumber,
                        bankAccountNumber = item.bankAccountNumber,
                        micrFormatID = item.micrFormatID,
                        notes = item.notes,
                        hide = item.hide
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IGLAccountRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("glaccount_delete", new { accountId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        GLAccount IGLAccountRepository.getNACHA(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<GLAccount>("glaccount_nacha_get", new { accountID = id }, commandType: CommandType.StoredProcedure);
            }
        }

        void IGLAccountRepository.updateNACHA(GLAccount item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("glaccount_nacha_update",
                    new
                    {
                        accountId = item.accountId,
                        inmDestination = item.immediateDestination,
                        inmDestinationName = item.immediateDestinationName,
                        immOrigin = item.immediateOrigin,
                        immOriginName = item.immediateOriginName,
                        identification = item.DFIIdentification,
                        accountNumber = item.DFIAccountNumber
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

       string IGLAccountRepository.validateForte(GLAccount item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.ExecuteScalar<string>("glaccount_forte_validate",
                    new
                    {
                        accountId = item.accountId,
                        forteMerchantId = item.forteMerchantId
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IGLAccountRepository.updateForte(int accountId,string forteMerchantId, IEnumerable<GLAccountFortePersonType> items)
        {   
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                var parameter = new GLAccountFortePersonTypeDynamicParameter(items, accountId, forteMerchantId);

                int id = connection.ExecuteScalar<int>("glaccount_forte_update", parameter, commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }

        IEnumerable<GLAccountFortePersonType> IGLAccountRepository.searchFortePersonType(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<GLAccountFortePersonType>("glAccount_forte_personType_search",
                   new
                   {
                       accountID = id
                   },
                   commandType: CommandType.StoredProcedure).ToList();
            }
        }
    }
}

```
## GLAccountSettingRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class GLAccountSettingRepository : BaseRepository, IGLAccountSettingRepository
    {
        public GLAccountSettingRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<GLAccountSetting> IGLAccountSettingRepository.search()
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<GLAccountSetting>("glaccount_setting_search", null, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<GLAccountSetting> IGLAccountSettingRepository.searchColumns(int companyID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<GLAccountSetting>("glaccount_setting_search_columns",
                      new
                      {
                          companyID = companyID
                      },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<GLAccountSetting> IGLAccountSettingRepository.searchAllowedAccounts(int companyID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<GLAccountSetting>("glaccount_setting_search_allowed_accounts",
                   new
                   {
                       companyID = companyID
                   },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        void IGLAccountSettingRepository.update(GLAccountSetting item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("glaccount_setting_update",
                    new
                    {
                        accountSettingID = item.accountSettingID,
                        checkingAccountID = item.checkingAccountID,
                        savingsAccountID = item.savingsAccountID,
                        depositAccountID = item.depositAccountID,
                        commissionAccountID = item.commissionAccountID,
                        payrollAccountID = item.payrollAccountID,
                        undepositedAccountID = item.undepositedAccountID,
                        billPayWashAccountID = item.billPayWashAccountID,
                        thirdPaymentWashAccountID = item.thirdPaymentWashAccountID,
                        arPaymentAccountID = item.arPaymentAccountID,
                        apPaymentAccountID = item.apPaymentAccountID,
                        escrowLiabilityAccountID = item.escrowLiabilityAccountID,
                        agentExpenseAccountID = item.agentExpenseAccountID,
                        bankAccountID = item.bankAccountID,
                        coBrokeIncomeAccountID = item.coBrokeIncomeAccountID,
                        referralIncomeAccountID = item.referralIncomeAccountID,
                        coBrokeCostOfSaleAccountID = item.coBrokeCostOfSaleAccountID,
                        referralCostOfSaleAccountID = item.referralCostOfSaleAccountID,
                        trans1AccountID = item.trans1AccountID,
                        trans2AccountID = item.trans2AccountID,
                        miscOtherIncomeAccountID = item.miscOtherIncomeAccountID,
                        miscOtherExpenseAccountID = item.miscOtherExpenseAccountID,
                        forteBankAccountID = item.forteBankAccountID,
                        item.taxCollectedAccountID,
                        item.taxPaidAccountID 
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        GLAccountSetting IGLAccountSettingRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<GLAccountSetting>("glaccount_setting_get", new { accountSettingID = id }, commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## GlobalSettingRepository.cs
```cs
using Dapper;
using System.Collections.Generic;
using System.Data;
using System.Data.SqlClient;
using System.Linq;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Hosting;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;

namespace AT.AT2017.Api.Repositories
{
    public class GlobalSettingRepository : BaseRepository, IGlobalSettingRepository
    {

        public GlobalSettingRepository(IHttpContextAccessor httpContextAccessor, IHostingEnvironment env, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, env, appSettings)
        {
        }

        IEnumerable<GlobalSetting> IGlobalSettingRepository.search(string name, string section)
        {
            using (SqlConnection adminConnection = new SqlConnection(base.adminConnectionString))
            {
                return adminConnection.Query<GlobalSetting>("global_setting_search",
                    new
                    {
                        name,
                        section
                    }, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<GlobalSetting> IGlobalSettingRepository.searchSection(string section)
        {
            using (SqlConnection adminConnection = new SqlConnection(base.saAdminConnectionString))
            {
                return adminConnection.Query<GlobalSetting>("global_setting_search",
                    new
                    {
                        section
                    }, commandType: CommandType.StoredProcedure).ToList();
            }
        }
    }
}

```
## HelpArticleRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Data;
using System.Data.SqlClient;
using System.Linq;
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.DynamicParameters;
using Dapper;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;

namespace AT.AT2017.Api.Repositories
{
    public class HelpArticleRepository : BaseRepository, IHelpArticleRepository
    {

        public HelpArticleRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<HelpArticle> IHelpArticleRepository.search(string query, bool withTrash)
        {
            using (SqlConnection connection = new SqlConnection(base.adminConnectionString))
            {
                return connection.Query<HelpArticle>("help_article_search",
                    new
                    {
                        query,
                        withTrash
                    },
                    commandType: CommandType.StoredProcedure, commandTimeout: 0).ToList();
            }
        }

        IEnumerable<HelpArticle> IHelpArticleRepository.searchByAction(int actionID, string corporateName, string query)
        {
            using (SqlConnection connection = new SqlConnection(base.adminConnectionString))
            {
                return connection.Query<HelpArticle>("help_article_search_by_action",
                    new
                    {
                        actionID,
                        corporateName,
                        query
                    },
                    commandType: CommandType.StoredProcedure, commandTimeout: 0).ToList();
            }
        }

        HelpArticle IHelpArticleRepository.get(int articleID)
        {
            using (SqlConnection connection = new SqlConnection(base.adminConnectionString))
            {
                return connection.QueryFirstOrDefault<HelpArticle>("help_article_get",
                    new
                    {
                        articleID
                    },
                    commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }

        int IHelpArticleRepository.add(HelpArticle item)
        {
            using (SqlConnection connection = new SqlConnection(base.adminConnectionString))
            {

                int id = connection.ExecuteScalar<int>("help_article_add",
                    new {
                        item.title,
                        item.description,
                        item.publishedDate,
                        item.externalLink,
                        item.brandCodes,
                        item.databaseId
                    }, commandType: CommandType.StoredProcedure, commandTimeout: 0);

                return id;
            }
        }

        void IHelpArticleRepository.update(HelpArticle item)
        {
            using (SqlConnection connection = new SqlConnection(base.adminConnectionString))
            {

                int id = connection.ExecuteScalar<int>("help_article_update",
                    new
                    {
                        item.articleID,
                        item.title,
                        item.description,
                        item.publishedDate,
                        item.externalLink,
                        item.brandCodes,
                        item.databaseId
                    }, commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }

        void IHelpArticleRepository.updateActions(int actionID, List<HelpArticle> articles)
        {
            using (SqlConnection connection = new SqlConnection(base.adminConnectionString))
            {
                var actionHelpArticleParameter = new ActionHelpArticleDynamicParameter(articles, actionID);

                int id = connection.ExecuteScalar<int>("help_article_update_actions", actionHelpArticleParameter, commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }

        void IHelpArticleRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.adminConnectionString))
            {
                connection.Execute("help_article_delete",
                    new {
                        articleID = id
                    }, commandType: CommandType.StoredProcedure);
            }
        }

        void IHelpArticleRepository.addLogEntry(int articleID, HelpArticleLog logData)
        {
            using (SqlConnection connection = new SqlConnection(base.adminConnectionString))
            {
                connection.Execute("help_article_log_add",
                    new
                    {
                        articleID,
                        logData.accessDate,
                        logData.userName,
                        logData.dbName,
                        logData.screenID,
                        logData.screen
                    }, commandType: CommandType.StoredProcedure);
            }
        }
    }
}

```
## I1099ReconciliationRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using AT.AT2017.Api.Core.Shared;

namespace AT.AT2017.Api.Repositories
{
    public interface I1099ReconciliationRepository
    {
        IEnumerable<_1099Reconciliation> search(int companyId, int year,string reconciled);
        IEnumerable<_1099ReconciliationDetail> searchBreakdown(int id, int personId,bool useCorporateTaxId);
        _1099Reconciliation get(int id);     
        int add(_1099Reconciliation item);
        void update(_1099Reconciliation item);
        void personAdd(int id, int personId,decimal amount);
        void refresh(int id, string basedOn);

        _1099Reconciliation getHeader(int id);
        PagedList<_1099ReconciliationDetail> searchDetailPaginated(int id,  int pageIndex, int pageSize, string sortBy, string filterBy);

    }
}

```
## IAgentStoreItemRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IAgentStoreItemRepository
    {
        IEnumerable<AgentStoreItem> search();
        AgentStoreItem get(int id);
        int add(AgentStoreItem item);
        void update(AgentStoreItem item);
        void delete(int id);
    }
}

```
## IAgentTeamRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Repositories
{
    public interface IAgentTeamRepository
    {
        IEnumerable<AgentTeam> search();
        AgentTeam get(int id);
        int add(AgentTeam item);
        void update(AgentTeam item);
        void delete(int id);
    }
}

```
## IAnalyticsDashboardRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System.Collections.Generic;

namespace AT.AT2017.Api.Repositories
{
    public interface IAnalyticsDashboardRepository
    {
        IEnumerable<AnalyticsDashboard> search(string title, string url, bool applySecurity, int userID);

        AnalyticsDashboard get(int dashboardID);

        int add(AnalyticsDashboard item);

        void update(AnalyticsDashboard item);

        void delete(int dashboardID);

        AnalyticsDashboardToken getEmbedToken(int dashboardID, int userID);

        AnalyticsDashboard getPBIReportHtml(string datasetID, string groupID, string reportID, string embedURL, int userID);

        AgentMetrics getAgentMetrics(int userID, string startDate, string endDate);
    }
}

```
## IApiCallLogRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Repositories
{
    public interface IApiCallLogRepository
    {
        IEnumerable<ApiCalllog> search(string dbName, string fromDate, string toDate, string basePath, string exceptionMessage);

        void cleanUp();

        IEnumerable<ActiveConnection> searchActiveConnections(string guid);

        ApiCalllog get(string guid);

        void add(string dbName, string serverName, string corporateName, DateTime startTime, DateTime endTime, string userName, string basePath, string urlPath, string method, string requestBody, string responseBody, string statusCode, bool isHttps, string darwinVersion, string darwinServer, string apiServer, string exceptionMessage, string innerExceptionMessage, string stackTrace, string connectionString);
    }
}

```
## IApiEndpointRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System.Collections.Generic;

namespace AT.AT2017.Api.Repositories
{
    public interface IApiEndpointRepository
    {
        IEnumerable<ApiEndpoint> search();

    }
}

```
## IApPaymentRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Core.Shared;
using System.Collections.Generic;

namespace AT.AT2017.Api.Repositories
{
    public interface IApPaymentRepository
    {
        IEnumerable<ApPayment> search(int companyId, int personId, int apPaymentId, string checkNumber, decimal amount, int accountId, string posted, string fromDate, string toDate, string cleared, string reconciled, int propertyId, string memo,int pageIndex, int pageSize, bool withTrash);
        IEnumerable<ApPayment> searchDeletedRecord(int pageIndex, int pageSize);
        IEnumerable<ApPayment> searchDirects(string date);
        IEnumerable<ApPayment> searchPrint(int companyId, int accountId, string checkNumberFrom, string checkNumberTo);
        PagedList<ApPayment> searchPrintPaginated(int companyId, int accountId, string checkNumberFrom, string checkNumberTo, int pageIndex, int pageSize);
        IEnumerable<Voucher> validateOverpayment(int id);
        IEnumerable<ApPayment> searchDuplicateCheckNumber(int companyId,string checkNumber,  int accountId);
        ApPayment get(int id);
        string getNextCheckNumber(int accountId);
        int add(ApPayment item);
        void update(ApPayment item);
        void updateTemplate(int id, int templateId);
        void delete(int id);   
        void post(int id);
        void unpost(int id);
        void voiding(int id);
        int applyCredit(int customerId,int bankAccountId, decimal amount, string date, int companyId,string checkNumber);
        void print(int id);
        void updatePaymentDate(int id, string paymentDate);
        void updateCheckNumber(int id, string checkNumber);
        IEnumerable<ApPayment> searchPostingProperty(int propertyId);
    }
}

```
## IApPaymentScannedImageRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IApPaymentScannedImageRepository
    {
        IEnumerable<ApPaymentScannedImage> search(int apPaymentID);
        ApPaymentScannedImage get(int id);
        int add(ApPaymentScannedImage item);
        void update(ApPaymentScannedImage item);
        void delete(int id);
    }
}

```
## IApPaymentScannedImageViewHistoryRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IApPaymentScannedImageViewHistoryRepository
    {
        IEnumerable<ApPaymentScannedImage> search(int apPaymentID);
        int add(int id);
    }
}

```
## IAppClientRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System.Collections.Generic;

namespace AT.AT2017.Api.Repositories
{
    public interface IAppClientRepository
    {
        IEnumerable<AppClient> search(string name, int databaseID);

        AppClient get(int appClientID);

        int add(string name, string clientID, string clientSecret, string allowedIps, int databaseID);

        void update(int appClientID, string name, string clientID, string clientSecret, string allowedIps, string modifyBy);

        void delete(int appClientID);

        int addEndpoint(AppClientEndpoint item);

        void deleteEndpoint(int appClientID, int endpointID);

    }
}

```
## IArPaymentRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Core.Shared;
using System.Collections.Generic;

namespace AT.AT2017.Api.Repositories
{
    public interface IArPaymentRepository
    {
        IEnumerable<ArPayment> search(int companyId, int accountId, int personId, decimal amount, string fromDate, string toDate, string posted, string deposited, int customerTypeId, string method, int pageIndex, int pageSize, bool withTrash, int propertyId, string memo, string checkNumber, string payee);
        IEnumerable<ArPayment> searchDeletedRecord(int pageIndex, int pageSize);
        IEnumerable<ArPayment> searchUndeposited(int companyId, int accountId, string fromDate, string toDate, string paymentMethod);

        PagedList<ArPayment> searchUndepositedPaginated(int companyId, int accountId, string fromDate, string toDate, string paymentMethod, int pageIndex, int pageSize, string sortBy, string filterBy);

        ArPayment get(int id);
        int add(ArPayment item);
        void update(ArPayment item);
        void delete(int id);
        void post(int id);
        void unpost(int id);
        int applyCredit(int customerId, decimal amount, string date, int companyId, string memo, string checkNumber);
        void updatePaymentMethod(ArPayment item);
        ArPayment invoiceApplyCreditsbyPerson(int personId, string userName, int companyId, bool onlyLegacy, bool transaction, bool output, bool audit);
        IEnumerable<ArPayment> searchPostingProperty(int propertyId);
        void move(int arpaymentId, int propertyId);
    }
}

```
## IArPaymentScannedImageRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IArPaymentScannedImageRepository
    {
        IEnumerable<ArPaymentScannedImage> search(int arPaymentID);
        ArPaymentScannedImage get(int id);
        int add(ArPaymentScannedImage item);
        void update(ArPaymentScannedImage item);
        void delete(int id);
    }
}

```
## IArPaymentScannedImageViewHistoryRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IArPaymentScannedImageViewHistoryRepository
    {
        IEnumerable<ArPaymentScannedImage> search(int arPaymentID);
        int add(int id);
    }
}

```
## IAuditTrailRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IAuditTrailRepository
    {
        IEnumerable<AuditTrail> search(int entityId, string tableName, string fromDate, string endDate, string userName,string changeType, string hostName, string appName);
        AuditTrail get(int id);
        IEnumerable<AuditTrail> searchCodeValue(string category);
    }
}

```
## IAuthRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System.Collections.Generic;

namespace AT.AT2017.Api.Repositories
{
    public interface IAuthRepository
    {
        User login(string userName, string userPassword, string ipAddress, bool resetToken, int appClientId);
        int getCompaniesCount(string serverName, string dbName, int userID);
        User refreshToken(string userName, string refreshToken);
        void updatePassword(UserCredentials user);
        UserCredentials validateToken(string userName, string token);
        Database validateApiKey(string userName, string apiKey);
        Server validateServer(string userName);
        AppClient validateClientCredentials(string clientID, string clientSecret);
        bool isHosted( string clientID, string clientSecret);
        void updateClientCredentials(AppClient client);

        // widget
        Widget getWidgetToken(string screen, int userID, string systemID);
        ExternalSystem getExternalSystem(string systemID);
        void updateExternalSystemCss(string systemID, string css);
        User login(string widgetID, string ipAddress, bool resetToken);

        //Duo - 2 Factor authentication
        IEnumerable<UserPhone> getMobiles(string serverName, string dbName, int userID);
        bool skipDuo(string serverName, string dbName, int userID);
        int addMobile(string serverName, string dbName, UserPhone item);
        void updateCodeLogin(string serverName, string dbName, int id, string code);
        bool verifyMobileLogin(string serverName, string dbName, int id,string code);

        User loginExternal(string userName);

        void resetPasswordRequest(string userName, string urlHost);
    }
}

```
## IBackupExecutionLogRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Repositories
{
    public interface IBackupExecutionLogRepository
    {
        IEnumerable<BackupExecutionLog> search(int id);
    }
}

```
## IBackupExecutionRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Repositories
{
    public interface IBackupExecutionRepository
    {
        IEnumerable<BackupExecution> search(int day = 0);
        BackupExecution get(int id);
        void reRunBackups(string indexIds, string frecuency);
        int add(BackupExecution item);
        void update(BackupExecution item);
    }
}

```
## IBankAccountRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System.Collections.Generic;

namespace AT.AT2017.Api.Repositories
{
    public interface IBankAccountRepository
    {

        IEnumerable<BankAccount> search(string accountName = "");

        IEnumerable<GLAccount> searchGLAccounts(string bankAccountType, int companyId);

        void update(BankAccount item);

        BankAccount get(int id);
    }
}

```
## IBankReconciliationRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using AT.AT2017.Api.Core.Shared;

namespace AT.AT2017.Api.Repositories
{
    public interface IBankReconciliationRepository
    {
        IEnumerable<BankReconciliation> search(int companyId, int accountId, int bankrecId,string reconciled);

        IEnumerable<BankReconciliationDetail> searchDetail(int companyId,int accountId, string limitDate);

        BankReconciliation get(int id, string limitDate);

        BankReconciliation getReconciled(int id);

        int add(BankReconciliation item);

        void update(BankReconciliation item);

        void delete(int id);

        void autoCleared(BankReconciliation item);

        void addUnreconcileLog(UnreconcileLog log);

        void unreconcile(int id);

        BankReconciliation getHeader(int id);
        PagedList<BankReconciliationDetail> searchDetailPaginated(int id, bool reconciled,int companyId, int accountId, string limitDate, int filterUser    ,int pageIndex, int pageSize, string sortBy, string filterBy);

    }
}

```
## IBankStreamRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IBankStreamRepository
    {
        IEnumerable<Office> searchOffice(int companyId);

        IEnumerable<PlaidWebhook> searchPlaidWebhook(string item_id);

        IEnumerable<MxWebhook> searchMxWebhook(string member_guid);

        IEnumerable<PlaidConnectLog> searchConnectLogs();

    }
}

```
## IBankTransactionRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;

namespace AT.AT2017.Api.Repositories
{
    public interface IBankTransactionRepository
    {

        IEnumerable<BankTransaction> searchNoClassifed(DateTime? dateFrom, DateTime? dateTo, int companyID = 0, int bankAccountID = 0);

        IEnumerable<BankTransaction> searchClassifed(DateTime? dateFrom, DateTime? dateTo, int companyID = 0, int bankAccountID = 0, string status = "all", int linkedAccountID = 0, int bankAccountLinkedGLAcctID = 0);

        IEnumerable<BankTransaction> searchMatchesRecords(int ruleId, bool isApply, bool applyAllEntries);

        IEnumerable<BankTransaction> searchChildTransactions(int parentID);

        IEnumerable<GLAccount> searchGLAccount(string transactionType);

        void classify(BankTransaction item, bool createAsRule, string condition);

        void approve(List<BankTransaction> transactions);

        void post(List<BankTransaction> transactions);

        void split(int transactionID, List<BankTransaction> childTransactions, bool createAsRule, string memo);

        void unsplit(int transactionID);

        BankTransaction get(int id);

        void delete(int id);
    }
}

```
## IBillingGroupRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IBillingGroupRepository
    {
        IEnumerable<BillingGroup> search(int companyId=0,int hasDetail=0);
        IEnumerable<BillingGroupOffice> searchOffices(BillingGroup item, string option);       
        int add(BillingGroup item);
        BillingGroup get(int id);
        void update(BillingGroup item);
        void delete(int id);
    }
}

```
## IBillingItemRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IBillingItemRepository
    {
        IEnumerable<BillingItem> search();
        BillingItem get(int id);
        int add(BillingItem item);
        void update(BillingItem item);
        void delete(int id);
    }
}

```
## IBudgetDetailRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IBudgetDetailRepository
    {
        BudgetDetail get(int budgetID, int officeID, int personid, int year, int accountID, decimal totalGoalYear);
        void update(BudgetDetail item);
        void delete(int budgetID, int officeID, int personid, int year, int accountID);
        void add(BudgetDetail item);
    }
}

```
## IBudgetRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IBudgetRepository
    {
        //IEnumerable<Budget> search(int companyId, int accountId, int officeId, int year, int month);
        //Budget get(int id);
        //int add(Budget item);
        //void update(Budget item);
        //void delete(int id);
        IEnumerable<Budget> search();
        Budget get(int id);
        Budget getbydescription(string desc);
        int add(Budget item);
        void update(Budget item);
        void delete(int id);
    }
}

```
## IBudgetYearRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IBudgetYearRepository
    {
        IEnumerable<BudgetYear> search(int id);
        IEnumerable<BudgetYear> add();

    }
}

```
## ICampaignCompanyRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface ICampaignCompanyRepository
    {
        IEnumerable<CampaignCompany> search();
    }
}

```
## ICampaignDatasourceRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IcampaigndatasourceRepository
    {
        IEnumerable<campaigndatasource> search();
        IEnumerable<CodeValue> searchTypes(int id);
        IEnumerable<CodeValue> searchOrderTypes(int id);
    }
}

```
## ICampaignDateRangeRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface ICampaignDateRangeRepository
    {
        IEnumerable<CampaignDateRange> search();
        //CampaignDateRange get(int id);
    }
}

```
## ICampaignDateTypeRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
namespace AT.AT2017.Api.Repositories
{
    public interface ICampaignDateTypeRepository
    {
        IEnumerable<CampaignDateType> search(int id);
        //CampaignDateType get(int id);
    }
}

```
## ICampaignLogRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface ICampaignLogRepository
    {        
        IEnumerable<CampaignLog> search(int id);
        IEnumerable<EmailLog> searchDetail(int id,string result);
        CampaignLog get(int campaignLogID);
        void resendDetail(int emailLogId);
    }
}

```
## ICampaignOfficeRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface ICampaignOfficeRepository
    {
        IEnumerable<CampaignOffice> search(int id);
    }
}

```
## ICampaignRecipientListDetailRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface ICampaignRecipientListDetailRepository
    {
        IEnumerable<CampaignRecipientListDetail> search(int id, int personId);
        IEnumerable<CampaignRecipientListDetail> searchByProperty(int recipientListID, int propertyID);
        int add(CampaignRecipientListDetail item);
        void delete(int id);
    }
}

```
## ICampaignRecipientListRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface ICampaignRecipientListRepository
    {
        IEnumerable<CampaignRecipientList> search();
        CampaignRecipientList get(int id);
        int add(CampaignRecipientList item);
        //void update(CampaignRecipientList item);
        void delete(int id);
        void update(CampaignRecipientList item);
        void refresh(int id);
    }
}

```
## ICampaignRecipientTypeRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface ICampaignRecipientTypeRepository
    {
        IEnumerable<CampaignRecipientType> search();
        //CampaignRecipientType get(int id);
    }

}

```
## ICampaignReportParametersRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface ICampaignReportParametersRepository
    {
        IEnumerable<CampaignReportParameters> searchintblreportparameter(int id);
        IEnumerable<CampaignReportParameters> searchincmpreportparameter(int id);
        void add(CampaignReportParameters item);
        void delete(int id);
    }
}

```
## ICampaignReportRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface ICampaignReportRepository
    {
        IEnumerable<CampaignReport> search(string linkFieldName);
        int update(ReportCustom item);
    }
}

```
## ICampaignRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Data;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface ICampaignRepository
    {
        IEnumerable<Campaign> search(string isPropertyRelated, string documentRelated);
        IEnumerable<CampaignMergeField> searchMergeFields(int id, string full);
        Campaign get(int id);
        int add(Campaign item);
        int copy(int id,string name);
        void update(Campaign item);        
        void delete(int id);
       
        DataTable execute(int id, string execution_Type, string email, int propertyID, string personID, bool preview);
        int runOnDemand(int campaignID, string emailForTesting, int propertyID, string personID, int documentID);
        IEnumerable<CampaignFunction> searchFunctions(string type);
        DataTable validate(int id);

        void exportToMaster(int id);        
        IEnumerable<Campaign> searchFromMaster();
        int importFromMaster(int id);
    }
}

```
## ICampaignScheduleRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface ICampaignScheduleRepository
    {
        IEnumerable<CampaignSchedule> search(int id);
        CampaignSchedule get(int id);
        int add(CampaignSchedule item);
        void update(CampaignSchedule item);
        void delete(int id);
        
    }
}

```
## ICampaignTemplateRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface ICampaignTemplateRepository
    {
        IEnumerable<CampaignTemplate> search();
        IEnumerable<CampaignTemplate> searchbydescription(string desc);
        CampaignTemplate get(int id);
    }
}

```
## ICategoryRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface ICategoryRepository
    {
        IEnumerable<Category> search();
        Category get(int id);
        int add(Category item);
        void update(Category item);
        void delete(int id);
    }
}

```
## ICertificationGroupRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface ICertificationGroupRepository
    {
        IEnumerable<CertificationGroup> search();
        CertificationGroup get(int id);
        int add(CertificationGroup item);
        void update(CertificationGroup item);
        void delete(int id);
    }
}

```
## ICertificationRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface ICertificationRepository
    {
        IEnumerable<Certification> search(int groupID);
        Certification get(int id);
        int add(Certification item);
        void update(Certification item);
        void delete(int id);
    }
}

```
## ICertificationRoleRequirementRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface ICertificationRoleRequirementRepository
    {
        IEnumerable<CertificationRoleRequirement> search(int certificationId);
        void update(int certificationId,IEnumerable<CertificationRoleRequirement> table);
    }
}

```
## IChatContactRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System.Collections.Generic;

namespace AT.AT2017.Api.Repositories
{
    public interface IChatContactRepository
    {
        IEnumerable<ChatContact> search(int roomID);
    }
}

```
## IChatMessageRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Core.Shared;

namespace AT.AT2017.Api.Repositories
{
    public interface IChatMessageRepository
    {

        PagedList<ChatMessage> search(int roomID, int userID, string query, int pageIndex = 1, int pageSize = 10);

        int add(ChatMessage item, bool sendSMSEnabled);

        ChatMessage get(int id);

    }
}

```
## IChatRoomRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Core.Shared;

namespace AT.AT2017.Api.Repositories
{
    public interface IChatRoomRepository
    {
        PagedList<ChatRoom> search(int userID, int? topicID, string query, int pageIndex = 1, int pageSize = 10);

        PagedList<Person> searchPerson(string query, int? personTypeID, int pageIndex = 1, int pageSize = 10);

        PagedList<ChatRoomEntity> searchEntity(string query, int topicID, int? companyID, int pageIndex = 1, int pageSize = 10);

        ChatRoom get(int id);

        int add(ChatRoom item);

        void update(ChatRoom item);

        void delete(int id);

    }
}

```
## ICheckbookDetailRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface ICheckbookDetailRepository
    {
        IEnumerable<CheckbookDetail> search(int checkbookId, int personId, int agentId, string reimb, int expenseJobId, int pageIndex, int pageSize, bool withTrash);
        IEnumerable<CheckbookDetail> searchPostingProperty(int propertyId);
    }
}

```
## ICheckbookReportRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;

namespace AT.AT2017.Api.Repositories
{
    public interface ICheckbookReportRepository
    {
        IEnumerable<CheckbookReport> search(int companyId, string dateStart, string dateEnd, int pageIndex, int pageSize);
    }
}

```
## ICheckbookRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface ICheckbookRepository
    {
        IEnumerable<Checkbook> search(int companyId, int personId, int propertyId, int accountId, int checkbookId, decimal amount, string checkNumber, string type, string posted, string printed, string fromDate, string toDate, string memoAndDescription, int pageIndex, int pageSize, bool withTrash);
        IEnumerable<Checkbook> searchDeletedRecord(int pageIndex, int pageSize);
        string getNextCheckNumber(int accountId);
        Checkbook get(int id);
        int add(Checkbook item);
        int addAutoDeposit(Checkbook item);
        int undoAutoDeposit(int id);
        void update(Checkbook item);
        void updateFlag1099(int id, int flag1099);
        void delete(int id);
        void post(int id);
        void unpost(int id);
        void print(int id);
        void voiding(int id);
        int addEscrow(Checkbook item);
        void updateEscrow(Checkbook item);
        void deleteEscrow(int id, string type);
        IEnumerable<Checkbook> searchEscrow(int propertyId, int personId, bool onlyCheck);
        IEnumerable<Checkbook> searchDuplicateCheckNumber(int id, int accountID, string checkNumber);

        IEnumerable<Checkbook> searchReassign(int propertyId, int accountId);
        void reassign(Checkbook item, int propertyId);
        int addAutoDepositFromPost(int arPaymentId, int escrowCheckId, int propertyId, string postDateDeposit,int companyId);
        void reclassify(Checkbook item);
    }
}

```
## ICheckbookScannedImageRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface ICheckbookScannedImageRepository
    {
        IEnumerable<CheckbookScannedImage> search(int checkbookID);
        CheckbookScannedImage get(int id);
        int add(CheckbookScannedImage item);
        void update(CheckbookScannedImage item);
        void delete(int id);
    }
}

```
## ICheckbookScannedImageViewHistoryRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface ICheckbookScannedImageViewHistoryRepository
    {
        IEnumerable<CheckbookScannedImage> search(int checkbookID);
        int add(int id);
    }
}

```
## ICheckMergeFieldRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface ICheckMergeFieldRepository
    {
        IEnumerable<CheckMergeField> search();
    }
}
```
## ICheckTemplateRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface ICheckTemplateRepository
    {
        IEnumerable<CheckTemplate> search(string name);
        IEnumerable<CheckTemplate> searchFromMaster();
        CheckTemplate get(int id);
        void exportToMaster(int id);
        CheckTemplate getFromMaster(int id);
        int add(CheckTemplate item);
        void update(CheckTemplate item);
        void delete(int id);
        int copy(int id);
        string getImagesPath();
    }
}

```
## ICheckWriterRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface ICheckWriterRepository
    {
        IEnumerable<CheckWriter> search(int companyId, string source, int entityID, string fromDate, string toDate, int topNumber, int pageIndex, int pageSize);
    }
}

```
## IClassificationRuleRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Core.Models.BankStream;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IClassificationRuleRepository
    {
        IEnumerable<ClassificationRule> search(string searchRule, int transactionID);

        ClassificationRule get(int id);

        int add(ClassificationRule item);

        void update(ClassificationRule item);

        void delete(int id);

        void apply(int ruleId, IEnumerable<BankTransaction> table);

        void unapply(int ruleId, IEnumerable<BankTransaction> table);

    }
}

```
## IClientDeviceRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Repositories
{
    public interface IClientDeviceRepository
    {
        /*User login(string userName, string userPassword, string ipAddress);
        void updatePassword(UserCredentials user);
        UserCredentials validateToken(string userName, string token);
        Database validateApiKey(string userName, string apiKey);*/

        ClientDevice get(string processorId, string computerName, string dbName);
        int add(ClientDevice item);
        void update(ClientDevice item);
        IEnumerable<ClientDevice> search(string dbName ,string status, string authorized, string fromDate, string toDate);
    }
}

```
## IClientNewRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;

namespace AT.AT2017.Api.Repositories
{
    public interface IClientNewRepository
    {
        ClientNew get(int id);
        int add(ClientNew item);
        void update(ClientNew item);      
        void delete(int id);       
        IEnumerable<ClientNew> search();
        string view(string code,int id);
    }
}

```
## ICodeValueCategoryRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using AT.AT2017.Api.Core.Models;
namespace AT.AT2017.Api.Repositories
{
    public interface ICodeValueCategoryRepository
    {
        IEnumerable<CodeValueCategory> search(string section );
        CodeValueCategory get(string name);
        int add(CodeValueCategory item);
        void update(CodeValueCategory item);      
    }
}

```
## ICodeValueReportRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Model_Report;

namespace AT.AT2017.Api.Repositories
{
    public interface ICodeValueReportRepository
    {
        IEnumerable<CodeValueReport> search( int id, string name, string category, int showDeleted,int pageIndex, int pageSize);
    }
}

```
## ICodeValueRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Repositories
{
    public interface ICodeValueRepository
    {
        IEnumerable<CodeValue> search(string category, string custom, bool withTrash, string group, bool includeNotMaster, bool applySecurity, string accessType);
        IEnumerable<CodeValue> searchDeletedRecord(int pageIndex, int pageSize);
        IEnumerable<CodeValue> searchProtectedCategories();
        IEnumerable<CodeValue> searchRecurringCodes();
        IEnumerable<CodeValue> searchBrandCodes();
        IEnumerable<CodeValue> searchInvalidCodes(string category);
        IEnumerable<CodeValue> searchForteCodes();
        IEnumerable<CodeValue> searchCategoryCodes(string category);
        IEnumerable<CodeValue> searchCategoryCustom1(string category);
        IEnumerable<PersonTypeAccess> searchPersonTypeAccess();
        IEnumerable<CodeValue> searchPersonType(int id);
        void updateInvalidCodes(int invalidCodeId, int validCodeId);
        CodeValue get(int id);
        int add(CodeValue item);
        void update(CodeValue item);
        void update(IEnumerable<CodeValue> table, string category);
        void delete(int id, bool forceDelete) ;
        IEnumerable<CodeValue> searchDeletedByCategory(string category);
        void reactive(int id);
    }
}

```
## ICompanyBankRepository.cs
```cs
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Repositories
{
    public interface ICompanyBankRepository
    {
        CompanyBank get(int id);

        void add(CompanyBank item);

        void reconnect(int id);

        void disconnect(int id);

    }
}

```
## ICompanyReportRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Model_Report;

namespace AT.AT2017.Api.Repositories
{
    public interface ICompanyReportRepository
    {
        IEnumerable<CompanyReport> search(string name, int id, int showDeleted, int dateType, string dateStart, string dateEnd, int pageIndex, int pageSize);
    }
}

```
## ICompanyRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface ICompanyRepository
    {
        IEnumerable<Company> search(bool withTrash = false);
        IEnumerable<Company> adminSearch();
        IEnumerable<Company> searchDeletedRecord(int pageIndex, int pageSize);
        Company get(int id);
        int add(Company item);
        void update(Company item);
        void delete(int id);
    }
}

```
## ICompanySettingRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface ICompanySettingRepository
    {

        IEnumerable<Setting> search();

        IEnumerable<Setting> searchByAction(int actionID);

        void updateActions(int actionID, List<Setting> settings);


    }
}

```
## ICorrespondenceMergeFieldRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface ICorrespondenceMergeFieldRepository
    {
        IEnumerable<CorrespondenceMergeField> search(string type);
    }
}

```
## ICorrespondenceTemplateRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface ICorrespondenceTemplateRepository
    {
        IEnumerable<CorrespondenceTemplate> search(string name);
        IEnumerable<CorrespondenceTemplate> searchFromMaster(int typeId);
        CorrespondenceTemplate get(int id);
        void exportToMaster(int id);
        CorrespondenceTemplate getFromMaster(int id);
        int add(CorrespondenceTemplate item);
        void update(CorrespondenceTemplate item);
        void delete(int id);
    }
}

```
## ICustomControlRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System.Collections.Generic;

namespace AT.AT2017.Api.Repositories
{
    public interface ICustomControlRepository
    {
        IEnumerable<CustomControl> search(int packageID, string formName);

        CustomControl get(int controlID);

        int addOrUpdate(CustomControl item);
    }
}

```
## IDashboardColumnsRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IDashboardColumnsRepository
    {
        IEnumerable<DashboardColumns> search(int dashboardID);
    }
}


```
## IDashboardRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IDashboardRepository
    {
        IEnumerable<Dashboard> search(int userId, string sectionName, string visible);
        Dashboard get(int id);
        int add(Dashboard  item);
        void update(Dashboard item);
        void update_columns(Dashboard item);
        void delete(int id);

    }
}


```
## IDashboardUserDetailRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IDashboardUserDetailRepository
    {
        IEnumerable<DashboardUserDetail> search(int dashboardID, int userID);
    }
}


```
## IDatabaseLoggedUserRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System.Collections.Generic;
using System.Data;

namespace AT.AT2017.Api.Repositories
{
    public interface IDatabaseLoggedUserRepository
    {
        IEnumerable<DatabaseLoggedUser> searchSummary(int id);
    }
}

```
## IDatabasePackageRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System.Collections.Generic;
using System.Data;

namespace AT.AT2017.Api.Repositories
{
    public interface IDatabasePackageRepository
    {
        DatabasePackage getLastPackage(int id, int userId);
    }
}

```
## IDatabaseRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System.Collections.Generic;
using System.Data;

namespace AT.AT2017.Api.Repositories
{
    public interface IDatabaseRepository
    {
        IEnumerable<Database> search(string corporateName, string active, string mode);
        IEnumerable<Database> searchActive();
        IEnumerable<Database> searchByPackages(int databaseID, int packageID, string expiresOn);
        IEnumerable<BrandCode> searchBrandCodes();
        DataTable searchNewClientSetupSteps();
        void update(Database item);
        void updateContactInfo(Database item);
        void enableTriggers();
        void enableServiceBroker();
        void fixGlAccountSetting();
        void validateSynonyms(string nameServer);
        Database get(int id);
        int addPackage(DatabasePackage item);
        void updatePackage(DatabasePackage item);
        void cancelPackage(int databasePackageid);
        NewClientSetupLog getNewClientSetupLog(int logID);
        int runNewClientSetup(string serverName, string newDatabaseName, string mode, string brandCode, bool isDash, string contactFirstName, string contactLastName, string contactEmail, string executedBy, string originalDbName);
        int startGoingTolive(string servername, string dbName, string executedBy);
        int runGoingTolive(string servername, string dbName, string executedBy, int logID, bool keepAgentData, bool keepOtherPeopleData, bool keepPropertyData, bool keepPropertyACData, bool keepPropertyOPData, bool keepPropertyCLData, bool keepPropertyWDData, bool keepPropertyXPData,  bool keepAccountingData, bool keepSettings);
        GoingToLiveLog searchGoingToLiveLog(int logID);
    }
}

```
## IDataImportRepository.cs
```cs
using System;
using System.Collections.Generic;
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Repositories
{
    public interface IDataImportRepository
    {
        IEnumerable<DataImport> search(string type);

        DataImport get(int id);

        int add(DataImport item);

        void update(DataImport item);

        void process(int id);

        IEnumerable<DataImportRecord> validate(int id);

        IEnumerable<DataImportLog> getProcessLog(int id);

        DataImportHistoricalMain getImportHistorical(int id);

        int updateImportHistorical(int id,IEnumerable<DataImportHistorical> detail);

        int processImportHistorical(int id,IEnumerable<DataImportHistorical> detail);
    }
}

```
## IDataProblemRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System.Collections.Generic;

namespace AT.AT2017.Api.Repositories
{
    public interface IDataProblemRepository
    {
        IEnumerable<DataProblem> search(string dbName, string errorCode, string resultType);
        IEnumerable<DataProblem> searchDatabases();
        IEnumerable<DataProblem> searchDataProblemTypes(string dbName);
        void run(string dbName);
    }
}

```
## IDeductionFormulaRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IDeductionFormulaRepository
    {
        IEnumerable<DeductionFormula> search(int deductionId);

        IEnumerable<DeductionFormula> research(string deductionIDs, string formula, string officeIDs, string planIDs, string usedForClassificationIDs, string usedForTRTypes,
                                                                            string sides, string sellerLeadSourceIDs, string buyerLeadSourceIDs);

        IEnumerable<DeductionFormula> searchFromMaster();

        DeductionFormula get(int id);

        DeductionFormula getFromMaster(int id);

        void exportToMaster(int id);

        IEnumerable<DeductionFormulaMergeField> searchMergeFields(string type);

        IEnumerable<DeductionFormulaOperator> searchOperators(string type);

        int add(DeductionFormula item);

        void update(DeductionFormula item);

        void delete(int id);

        IEnumerable<DeductionFormulaFunction> searchFunctions();
    }
}

```
## IDeductionPlanRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IDeductionPlanRepository
    {
        IEnumerable<DeductionPlan> search(int companyId, bool isAgent);
        DeductionPlan get(int id);
        int add(DeductionPlan item);
        void update(IEnumerable<DeductionPlan> table, bool includeTotals);
        void delete(int id);
    }
}


```
## IDeductionRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IDeductionRepository
    {
        IEnumerable<Deduction> search();
        Deduction get(int id);
        void update(Deduction item);
    }
}

```
## IDeductionScaleRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IDeductionScaleRepository
    {
        IEnumerable<DeductionScale> search(string scaleName);
        DeductionScale get(int id);
        int add(DeductionScale item);
        void update(DeductionScale item);
        void delete(int id);
    }
}

```
## IDeductionSubplanRepository.cs
```cs
using System.Collections.Generic;
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Repositories
{
    public interface IDeductionSubplanRepository
    {
        IEnumerable<DeductionSubplan> search(int companyId, bool isAgent);
        DeductionSubplan get(int id);
        int add(DeductionSubplan item);
        void update(IEnumerable<DeductionSubplan> table);
        void delete(int id);
    }
}

```
## IDeletedRecordRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Repositories
{
    public interface IDeletedRecordRepository
    {
        IEnumerable<DeletedRecord> search();
    }
}

```
## IDivideExpenseTemplateRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IDivideExpenseTemplateRepository
    {
        IEnumerable<DivideExpenseTemplate> search();
        DivideExpenseTemplate get(int id);
        int add(DivideExpenseTemplate item);
    }
}

```
## IDocumentRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System.Collections.Generic;

namespace AT.AT2017.Api.Repositories
{
    public interface IDocumentRepository
    {
        IEnumerable<Document> searchPending(string documentType);   
        void update(Document item);
    }
}

```
## IDropDownRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Repositories
{
    public interface IDropDownRepository
    {
        IEnumerable<Dropdown> search(string type);
    }
}

```
## IErrorCodeRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Repositories
{
    public interface IErrorCodeRepository
    {
        IEnumerable<ErrorCode> search(int systemID, int moduleID, int errorcodeID);
        ErrorCode get(int id);
        int add(ErrorCode item);
        void update(ErrorCode item);
        void delete(int id);
    }
}

```
## IExtraVoucherRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IExtraVoucherRepository
    {
        IEnumerable<ExtraVoucher> search(int companyID, bool withTrash = false);
        IEnumerable<ExtraVoucher> searchDeletedRecord(int pageIndex, int pageSize);
        ExtraVoucher get(int id);
        int add(ExtraVoucher item);
        void update(ExtraVoucher item);
        void delete(int id);
    }
}

```
## IFeedProcessRepository.cs
```cs
namespace AT.AT2017.Api.Repositories
{
   public interface IFeedProcessRepository
    {
        string runStoredProcedure(string statement);
        string resolveFunction(string statement);
        string resolveScript(string script);
        string transformResponse(string jsonToTransform, string script);
    }
}

```
## IFeedRelationshipRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models.Feeds;

namespace AT.AT2017.Api.Repositories
{
    public interface IFeedRelationshipRepository
    {
        IEnumerable<FeedRelationship> search(int feedID);
        IEnumerable<FeedRelationship> search_from_master(int feedID);
    }
}

```
## IFeedRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Core.Models.Feeds;

namespace AT.AT2017.Api.Repositories
{
    public interface IFeedRepository
    {
        IEnumerable<Feed> search(int feedTypeID, int feedSubtypeID, int feedResourceID);
        IEnumerable<Feed> search_from_master(int feedTypeID, int feedSubtypeID, int feedResourceID);
        IEnumerable<Feed> search_from_submit_init(int feedTypeID, int feedSubtypeID, string process, string brandCode);
        Feed get(int feedID);
        Feed get_by_setting(int propID, string setting);
        Feed get_from_master(int feedID);
        void exportToMaster(int id);
        int add(Feed feed);
        int add_submit_init(int feedID);
        void update(Feed feed);
        void update_init(int feedID, string companyID, string companyGUID, string brandCode);
        void delete(int id);
        int copy(int feedID, string feedNameDest, int feedTypeIDDest, int feedSubTypeIDDest, int feedResourceIDDest);
        bool getConexionCATYLIST(Feed feed);
    }

    public interface IFeedExecutionRepository
    {
        IEnumerable<FeedExecution> search(int feedID);
    }

    public interface IFeedExecutionDetailRepository
    {
        IEnumerable<FeedExecutionDetail> search(int executionID, int parentExecutionDetailID);
        IEnumerable<FeedExecutionDetail> search_custom(int executionID);
        IEnumerable<FeedExecutionSourceRecordField> getSourceData(int sourceRecordID);
    }

    public interface IFeedExecutionRecordRepository
    {
        IEnumerable<FeedExecutionRecord> search(int executionID, string status);
        IEnumerable<FeedExecutionRecord> searchParentRecords(int executionID);
        IEnumerable<FeedExecutionRecordChild> searchChild(int executionID,int executionRecordId, string status);
        IEnumerable<FeedExecutionTransformationView> searchTransformation(int executionID, string executionRecordId, string status);
        IEnumerable<FeedExecutionTransformationDetail> searchTransformationDetail(int executionID, int executionRecordId);
    }

    public interface IFeedFilterRepository
    {
        IEnumerable<FeedFilter> search(int feedID);
        IEnumerable<FeedFilter> search_from_master(int feedID);
        FeedFilter get(int feedFilterID);
        string executeSentence(string sentence);
    }

    public interface IFeedPODFilterRepository
    {
        IEnumerable<FeedPODFilter> search(int feedID);
        IEnumerable<FeedPODFilter> search_from_master(int feedID);
        FeedPODFilter get(int id);
        FeedPODFilter getByName(int feedResourceID, string sourceField);
        int add(FeedPODFilter item);
        void update(FeedPODFilter item);
        void delete(int id);
    }

    public interface IFeedFilterDetailRepository
    {
        IEnumerable<FeedFilterDetail> search(int feedID, int feedFilterID);
        IEnumerable<FeedFilterDetail> search_from_master(int feedID, int feedFilterID);
        FeedFilterDetail get(int feedFilterDetailID);
    }

    public interface IFeedMappingRepository
    {
        IEnumerable<FeedMapping> search(int feedID);
        IEnumerable<FeedMapping> search_from_master(int feedID);
        FeedMapping get(int mappingID);
    }

    public interface IFeedMappingDetailRepository
    {
        IEnumerable<FeedMappingDetail> search(int feedID, int mappingID);
        IEnumerable<FeedMappingDetail> search_from_master(int feedID, int mappingID);
        FeedMappingDetail get(int mappingDetailID);
    }

    public interface IFeedTransformationRepository
    {
        IEnumerable<FeedTransformation> search(int feedID, int mappingID);
        IEnumerable<FeedTransformation> search_from_master(int feedID, int mappingID);
        FeedTransformation get(int trnasformationID);
        string evalCondition(string condition);
        string evalReplaceWith(string condition);
        IEnumerable<FeedTransformation> getTemplates(int feedID, int mappingID, int sourceFieldID, int atFieldID);
    }

    public interface IFeedScheduleRepository
    {
        IEnumerable<FeedSchedule> search(int feedID);
        IEnumerable<FeedSchedule> search_from_master(int feedID);
        FeedSchedule get(int scheduleID);
    }

    public interface IFeedMatchRepository
    {
        IEnumerable<FeedMatching> search(int feedID);
        IEnumerable<FeedMatching> search_from_master(int feedID);
        FeedMatching get(int feedMatchingID);
    }

    public interface IFeedTypeRepository
    {
        IEnumerable<FeedType> search(string type);
        int add(FeedType item);
        void update(FeedType item);      
        void delete(int id);
    }

    public interface IFeedSubTypeRepository
    {
        IEnumerable<FeedSubtype> search(int feedTypeID);
        FeedSubtype get(int feedSubTypeID);
        int add(FeedSubtype item);
        void update(FeedSubtype item);
        void delete(int id);
    }

    public interface IFeedResourceRepository
    {
        IEnumerable<FeedResource> search(int feedSubTypeID);
        void refreshMetaData(FeedResourceMetaData feedResourcesMetaData);
        int add(FeedResource item);
        void update(FeedResource item);
        FeedResource get(int id);
        int addFull(FeedResource item);
        void updateFull(FeedResource item);
        void delete(int id);
    }

    public interface IFeedSourceFieldRepository
    {
        IEnumerable<FeedSourceField> search(int feedResourceID);
        void add(int feedResourceID, List<FeedSourceField> sourceFields);
        int add(FeedSourceField item);
        void update(FeedSourceField item);
        void updateSampleData(int feedResourceID, List<FeedSourceField> sourceFields);
    }

    public interface IFeedSourceFieldLookupRepository
    {
        IEnumerable<FeedSourceFieldLookup> search(int subtypeID, string lookupName);
    }

    public interface IFeedAtTableRepository
    {
        IEnumerable<FeedAtTable> search(string tableName, int type);
    }

    public interface IFeedAtTableDetailRepository
    {
        IEnumerable<FeedAtTableDetail> search(int tableID);
    }

    public interface IFeedAtFieldRepository
    {
        IEnumerable<FeedAtField> search(string tableName);
        FeedAtField get(int atFieldID);
    }

    public interface IFeedAtFunctionRepository
    {
        IEnumerable<FeedAtFunction> search(string functionName);
    }
}

```
## IFormControlRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System.Collections.Generic;

namespace AT.AT2017.Api.Repositories
{
    public interface IFormControlRepository
    {
        IEnumerable<FormControl> search(string formName);

        int addOrUpdate(FormControl item);
    }
}

```
## IFortePaymentLogRepository.cs
```cs
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Repositories
{
    public interface IFortePaymentLogRepository
    {
        void add(FortePaymentLog item);
        FortePaymentLog get(int id, string type);
    }
}

```
## IForteRepository.cs
```cs
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Repositories
{
    public interface IForteRepository
    {
        void addLog(int id,string method,string request, string response, string error);
        void addPaymentMethod(int personId, string merchantId, string clientId, string paymethodType, string paymethodId, bool isDefault, string label, string last4AccountNumber, string accountType, string routingNumber, 
            string nameOn, string maskedAccountNumber, int expireYear, int expireMonth, string cardType, bool procurementCard, bool suppressAccountUpdate, string accountHolder);
        void deletePaymentMethod(string paymethodId);
        PaymentMethod getPaymentMethods(int personId, string merchantId);
    }
}

```
## IGlAccountCommissionRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IGLAccountCommissionRepository
    {
        IEnumerable<GLAccountCommission> search(int accountId, int classificationId, int deductionId, string side);
        GLAccountCommission get(int id);
        int add(GLAccountCommission item);
        void update(GLAccountCommission item);
        void delete(int id);
        void copy(int classificationId, int classificationCopyId);
    }
}

```
## IGLAccountFortePersonTypeRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Repositories
{
    public interface IGLAccountFortePersonTypeRepository
    {
        IEnumerable<GLAccountFortePersonType> search(int accountId);        
    }
}

```
## IGLAccountPeriodLockRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IGLAccountPeriodLockRepository
    {
        IEnumerable<GLAccountPeriodLock> search(int companyId);
        GLAccountPeriodLock get(int id);
        int add(GLAccountPeriodLock item);
        void delete(int id);
    }
}

```
## IGLAccountPeriodRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IGLAccountPeriodRepository
    {
        IEnumerable<GLAccountPeriod> search(string active);
        GLAccountPeriod get(int id);
        int add(GLAccountPeriod item);
        void update(GLAccountPeriod item);
        void delete(int id);
    }
}

```
## IGLAccountRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IGLAccountRepository
    {

        IEnumerable<GLAccount> search(int companyId, string accountNumber, string description, string accountType, string headerType, string isEscrow, string systemAccount, bool withTrash);
        IEnumerable<GLAccount> searchDeletedRecord(int pageIndex, int pageSize);
        GLAccount get(int id);
        int add(GLAccount item);
        decimal getBalance(int accountId,int companyId);
        void update(GLAccount item);
        void delete(int id);
        GLAccount getNACHA(int id);
        void updateNACHA(GLAccount item);

        void updateForte(int id,string merchantId, IEnumerable<GLAccountFortePersonType> table);
        string validateForte(GLAccount item);
        IEnumerable<GLAccountFortePersonType> searchFortePersonType(int id);
    }
}

```
## IGLAccountSettingRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IGLAccountSettingRepository
    {
        IEnumerable<GLAccountSetting> search();
        IEnumerable<GLAccountSetting> searchColumns(int companyID);
        IEnumerable<GLAccountSetting> searchAllowedAccounts(int companyID);
        GLAccountSetting get(int id);
        void update(GLAccountSetting item);

    }
}

```
## IGlobalSettingRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IGlobalSettingRepository
    {

        IEnumerable<GlobalSetting> search(string name = "", string section = "");
        IEnumerable<GlobalSetting> searchSection(string section);
    }
}

```
## IHelpArticleRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System.Collections.Generic;

namespace AT.AT2017.Api.Repositories
{
    public interface IHelpArticleRepository
    {
        IEnumerable<HelpArticle> search(string query, bool withTrash);

        IEnumerable<HelpArticle> searchByAction(int actionID, string corporateName, string query);

        HelpArticle get(int articleID);

        int add(HelpArticle item);

        void update(HelpArticle item);

        void updateActions(int actionID, List<HelpArticle> articles);

        void delete(int id);

        void addLogEntry(int articleID, HelpArticleLog logData);
    }
}

```
## IInquiryRepository.cs
```cs
using System.Collections.Generic;
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Core.Shared;

namespace AT.AT2017.Api.Repositories
{
    public interface IInquiryRepository
    {
        IEnumerable<Inquiry> search(int companyId, int accountId, int officeId, int incomeJobId, int expenseJobId, string fromDate, string toDate, decimal amount, int transactionId, string description);

        PagedList<Inquiry> searchPaginated(int companyId, int accountId, int officeId, int incomeJobId, int expenseJobId, string fromDate, string toDate, decimal amount, int transactionId, string description, int pageIndex, int pageSize, string sortBy, string filterBy);

        Inquiry searchCalculateBalance(int companyId, int accountId, int officeId, int incomeJobId, int expenseJobId, string fromDate, string toDate, decimal amount, int transactionId, string description);

    }
}

```
## IInvoiceDetailRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Repositories
{
    public interface IInvoiceDetailRepository
    {
        int add(Invoice item);
        void update(int id, Invoice item);
        void delete(int id);

    }
}

```
## IInvoiceRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Core.Shared;

namespace AT.AT2017.Api.Repositories
{
    public interface IInvoiceRepository
    {

        IEnumerable<Invoice> search(int companyId, int personId, int propertyId, int orderTypeId, int personTypeId, string posted, string paid, string fromDate, string toDate, decimal amount, string isTemplate, int pageIndex, int pageSize, bool withTrash, string ids);
        IEnumerable<Invoice> searchByVoucher(int voucherId);
        IEnumerable<InvoiceDetail> searchDetail(int personId);
        IEnumerable<Invoice> searchDeletedRecord(int pageIndex, int pageSize);

        IEnumerable<Invoice> searchUnpaid(int companyId, int personId, int propertyId, int orderTypeId, int personTypeId, string fromDate, string toDate, int isForte, int officeId);
        PagedList<Invoice> searchUnpaidPaginated(int companyId, int personId, int propertyId, int orderTypeId, int personTypeId, string fromDate, string toDate, int isForte, int officeId, int pageIndex, int pageSize, string sortBy, string filterBy);

        IEnumerable<ArPaymentDetail> searchPayments(int invoiceId);
        IEnumerable<CheckbookDetail> searchDeposits(int invoiceId);
        Invoice get(int id);
        IEnumerable<Invoice> postBatch(IEnumerable<Invoice> invoicesToPost);
        int add(Invoice item);
        int addFromVoucher(int voucherId);
        void update(Invoice item);
        void delete(int id);
        void post(int id);
        void unpost(int id);
        int pay(int id, decimal howMuchToPay, string paymentDate, string paymentMethod, bool paidByNacha);
        void reclassify(Invoice item);
        IEnumerable<Invoice> searchTemplates(int companyId);
        void updateAsTemplate(Invoice item);
        void updateRecurring(Invoice item);
        int copy(int id);

        InvoiceBillingLog getAgentBilling(int invoiceBillingLogID);       
        InvoiceBillingLog addAgentBilling(int companyId, int officeId, int personTypeId, string orderDate, bool includeBillingItems, bool includeReimbItems, bool posted, IEnumerable<Person> persons);
               IEnumerable<Invoice> searchInvoicesPostingPropertySummary(int propertyId);

        IEnumerable<Invoice> searchUnpaidByPerson(int personId, int companyId);
        int payList(int isForte, IEnumerable<Invoice> invoices);

        InvoiceBillingLog getBillingLog(int invoiceBillingLogID);
        PagedList<InvoiceBillingLogDetail> searchBillingLogDetailPaginated(int invoiceBillingLogID, int pageIndex, int pageSize, string sortBy, string filterBy);
        IEnumerable<Invoice> searchInvoicesFromBilling(int invoiceBillingLogID, int pageIndex, int pageSize);
    }
}

```
## IInvoiceScannedImageRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IInvoiceScannedImageRepository
    {
        IEnumerable<InvoiceScannedImage> search(int invoiceID);
        InvoiceScannedImage get(int id);
        int add(InvoiceScannedImage item);
        void delete(int id);
        void update(InvoiceScannedImage item);
    }
}

```
## IInvoiceScannedImageViewHistoryRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IInvoiceScannedImageViewHistoryRepository
    {
        IEnumerable<InvoiceScannedImage> search(int invoiceID);
        int add(int id);
    }
}

```
## IItemForSaleRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Core.Shared;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IItemForSaleRepository
    {
        PagedList<ItemForSale> search(int pageIndex, int pageSize, string item, bool? inStock, int? priceStart, int? priceEnd, string sortBy);

        ItemForSale get(int id);

        void add(ItemForSale items);

        void update(ItemForSale item);

        void delete(int id);
    }
}

```
## IJobCodeRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IJobCodeRepository
    {
        IEnumerable<JobCode> search(string description, string jobType, int companyId, int officeId, int personId, string active, int pageIndex, int pageSize,int includeTerminated, int includeIntercompany);
        JobCode get(int id);
        int add(JobCode item);
        void update(JobCode item);
        void delete(int id);
    }
}

```
## IJournalRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IJournalRepository
    {
        IEnumerable<Journal> search(int companyId, string reference, string posted, string fromDate, string toDate, string isTemplate, int pageIndex, int pageSize, bool withTrash,int officeId,int accountId,int divisionId,decimal amount,string postedDate, int personId, string ids);
        IEnumerable<Journal> searchDeletedRecord(int pageIndex, int pageSize);
        Journal get(int id);
        int add(Journal item);
        void update(Journal item);
        void delete(int id);
        void post(int id);
        void unpost(int id);
        void reclassify(Journal item);
        void updateRecurring(Journal item);
        IEnumerable<Journal> searchTemplates(int companyId);
        void updateAsTemplate(Journal item);
        int reverse(int id);
        void updateFlag1099(int id, int flag1099);
    }
}

```
## IJournalScannedImageRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IJournalScannedImageRepository
    {
        IEnumerable<JournalScannedImage> search(int journalID);
        JournalScannedImage get(int id);
        int add(JournalScannedImage item);
        void delete(int id);
        void update(JournalScannedImage item);
    }
}

```
## IJournalScannedImageViewHistoryRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IJournalScannedImageViewHistoryRepository
    {
        IEnumerable<JournalScannedImage> search(int journalID);
        int add(int id);
    }
}

```
## ILedgerReportRepository.cs
```cs
using AT.AT2017.Api.Core.Model_Report ;
using System;
using System.Collections.Generic;

namespace AT.AT2017.Api.Repositories
{
    public interface ILedgerReportRepository
    {
        IEnumerable<LedgerGLReportInfo> searchGL(
            string dateStart, string dateEnd, int officeID, int companyID, string ledgerType,
            int accountID, string transactionID, string code, int pageIndex, int pageSize);

        IEnumerable<LedgerGLDetailReportInfo> searchGLDetail(
            string dateStart, string dateEnd, int officeID, int companyID, string ledgerType,
            int accountID, string transactionID, string code, int pageIndex, int pageSize);

        IEnumerable<LedgerPLReportInfo> searchPL(
            string dateStart, string dateEnd, int officeID, int companyID, string ledgerType,
            int accountID, string transactionID, string code, int pageIndex, int pageSize);

        IEnumerable<LedgerPLDetailReportInfo> searchPLDetail(
            string dateStart, string dateEnd, int officeID, int companyID, string ledgerType,
            int accountID, string transactionID, string code, int pageIndex, int pageSize);

    }
}

```
## ILoginHistoryRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Core.Shared;

namespace AT.AT2017.Api.Repositories
{
    public interface ILoginHistoryRepository
    {
        IEnumerable<LoginHistory> search(string userName, string loginStartDate, string loginEndDate, string userNameSearch, string email, string ipAddress, string serverName, int pageIndex, int pageSize, string attemptFailed);

        PagedList<LoginHistory> searchPaginated(string userName, string loginStartDate, string loginEndDate, string email, string ipAddress, string serverName, int pageIndex, int pageSize, string attemptFailed);

        int add(LoginHistory item);

    }
}

```
## IMenuActionRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IMenuActionRepository
    {
        IEnumerable<MenuAction> search(int menuId, string name);
        IEnumerable<MenuAction> searchNotInPackage();
        IEnumerable<MenuAction> searchScreens();
        MenuAction get(int id);
    }
}

```
## IMenuRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IMenuRepository
    {
        IEnumerable<Menu> search(string name);
        Menu get(int id);
    }
}

```
## IMigrationLogDetailRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Repositories
{
    public interface IMigrationLogDetailRepository
    {
        IEnumerable<MigrationLogDetail> search(int submitID);
    }
}

```
## IMigrationLogRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Repositories
{
    public interface IMigrationLogRepository
    {
        IEnumerable<MigrationLog> search(int submitID,string corporateName);
        MigrationLog get(int migrationLogID);
    }
}

```
## IMigrationRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Mvc;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IMigrationRepository
    {

        Company getCompany(string newServer, string newDatabase, string sourceDatabase);

        IEnumerable<Server> searchServers(bool includeOldServers, bool includeNewServers);

        IEnumerable<Database> searchDatabases(string server, string type);

        IEnumerable<MigrationError> validate(string sourceDatabase, bool appendDatabase);

        void createDatabase(string newServer, string newDatabase, bool force);

        void backupNewDatabase(string newServer, string newDatabase);

        void restoreNewDatabase(string newServer, string newDatabase);

        void backupOldDatabase(string sourceServer, string sourceDatabase);

        void restoreOldDatabase(string newServer, string sourceDatabase);

        void backupMasterDatabase();

        void enableTriggers(string newServer, string newDatabase);

        void disableTriggers(string newServer, string newDatabase);

        IEnumerable<TableStatus> cleanUpSection(string newServer, string newDatabase, string section, bool showTableStatus);

        void transferTable(string newServer, string newDatabase, string sourceDatabase, string sectionName, string tableName, bool goLive, string brandCode);

        IEnumerable<MigrationTable> searchTables(string newServer, string newDatabase, string section);

        void fixData(string newServer, string newDatabase, string sourceDatabase, bool addCompany, bool goLive);

        IEnumerable<TableStatus> searchTableStatus(string newServer, string newDatabase);

        IEnumerable<ComparisonInfo> searchComparisonInfo(string newServer, string newDatabase, string sourceDatabase);

        void preserveTables(string newServer, string newDatabase);

        void syncGlobalTables(string newServer, string newDatabase);

        IEnumerable<GLAccountSetting> searchAccountColumns(string newServer, string newDatabase, int companyID);

        IEnumerable<GLAccountSetting> searchAllowedAccounts(string newServer, string newDatabase, int companyID);

        void updateAccountSettings(string newServer, string newDatabase, GLAccountSetting item);

    }
}

```
## IModelDictionaryRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IModelDictionaryRepository
    {
        IEnumerable<ModelDictionary> search();
    }
}

```
## IModuleRepository.cs
```cs
using System.Collections.Generic;
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Repositories
{
    public interface IModuleRepository
    {
        IEnumerable<ModuleErrorCode> search(int systemID, int moduleID);
    }
}

```
## IMxRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System.Collections.Generic;

namespace AT.AT2017.Api.Repositories
{
    public interface IMxRepository
    {
        IEnumerable<MxConnectLog> searchConnectLog();

        void addConnectLog(MxConnectLog item);

    }
}

```
## IMxUserRepository.cs
```cs
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Repositories
{
    public interface IMxUserRepository
    {

        MxUser firstOrCreate(string dbName);

        void update(MxUser item);

    }
}

```
## INotificationRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface INotificationRepository
    {
        EmailLog getLastEmailLog(string token);
    }
}

```
## INotificationScheduleRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface INotificationScheduleRepository
    {    
        NotificationSchedule get(int id);
        NotificationSchedule search(int settingId);
        int add(NotificationSchedule item);
        void update(NotificationSchedule item);
        void delete(int id);
    }
}

```
## INotificationSettingRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface INotificationSettingRepository
    {
        IEnumerable<NotificationSetting> search();
        NotificationSetting get(int id);
        void update(NotificationSetting item);
    }
}

```
## InquiryRepository.cs
```cs
using System.Collections.Generic;
using System.Linq;
using AT.AT2017.Api.Core.Models;
using System.Data;
using Dapper;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using System.Data.SqlClient;
using AT.AT2017.Api.Core.Shared;

namespace AT.AT2017.Api.Repositories
{
    public class InquiryRepository : BaseRepository, IInquiryRepository
    {
        public InquiryRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {

        }

        IEnumerable<Inquiry> IInquiryRepository.search(int companyId, int accountId, int officeId, int incomeJobId, int expenseJobId,  string fromDate, string toDate, decimal amount, int transactionId, string description)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<Inquiry>("inquiry_search",
                    new
                    {
                        companyId = companyId,
                        accountId = accountId,
                        officeId = officeId,
                        incomeJobId = incomeJobId,
                        expenseJobId = expenseJobId,
                        fromDate = fromDate,
                        toDate = toDate,
                        amount = amount,
                        transactionId,
                        description 
                    },
                    commandType: CommandType.StoredProcedure, commandTimeout: 0).ToList();
            }
        }

        PagedList<Inquiry> IInquiryRepository.searchPaginated(int companyId, int accountId, int officeId, int incomeJobId, int expenseJobId, string fromDate, string toDate, decimal amount, int transactionId, string description, int pageIndex, int pageSize, string sortBy, string filterBy)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                PagedList<Inquiry> page = null;

                using (var multi = connection.QueryMultiple("inquiry_search_paginated",
                    new
                    {
                        companyId,
                        accountId,
                        officeId,
                        incomeJobId,
                        expenseJobId,
                        fromDate,
                        toDate,
                        amount,
                        transactionId,
                        description,
                        pageIndex,
                        pageSize,
                        sortBy,
                        filterBy
                    }, commandType: CommandType.StoredProcedure))
                {
                    page = multi.Read<PagedList<Inquiry>>().Single();
                    page.data = multi.Read<Inquiry>().ToList();
                }
                return page;
            }
        }

        Inquiry IInquiryRepository.searchCalculateBalance(int companyId, int accountId, int officeId, int incomeJobId, int expenseJobId, string fromDate, string toDate, decimal amount, int transactionId, string description)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<Inquiry>("inquiry_calculate_balance",
                     new
                     {
                         companyId,
                         accountId,
                         officeId,
                         incomeJobId,
                         expenseJobId,
                         fromDate,
                         toDate,
                         amount,
                         transactionId,
                         description
                     }, commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## InvoiceDetailRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using System.Data.Common;
using System.Data;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;

namespace AT.AT2017.Api.Repositories
{
    public class InvoiceDetailRepository : BaseRepository , IInvoiceDetailRepository
    {
        public InvoiceDetailRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        public int add(Invoice item)
        {
            throw new NotImplementedException();
        }

        public void delete(int id)
        {
            throw new NotImplementedException();
        }
        
        public void update(int id, Invoice item)
        {
            throw new NotImplementedException();
        }
    }
}

```
## InvoiceRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using System.Data;
using Dapper;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Microsoft.SqlServer.Server;
using AT.AT2017.Api.DynamicParameters;
using System.Data.SqlClient;
using Hangfire;
using AT.AT2017.Api.Core.Shared;

namespace AT.AT2017.Api.Repositories
{
    public class InvoiceRepository : BaseRepository , IInvoiceRepository
    {
        private IBackgroundJobClient _backgroundJobs;

        public InvoiceRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings, IBackgroundJobClient backgroundJobs) : base(httpContextAccessor, appSettings)
        {
            _backgroundJobs = backgroundJobs;
        }

        IEnumerable<Invoice> IInvoiceRepository.search(int companyId, int personId, int propertyId, int orderTypeId, int personTypeId, string posted, string paid, string fromDate, string toDate, decimal amount, string isTemplate, int pageIndex, int pageSize, bool withTrash, string ids)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<Invoice>("invoice_search",
                   new
                   {
                       companyId = companyId,
                       personId = personId,
                       propertyId = propertyId,
                       orderTypeId = orderTypeId,
                       personTypeId = personTypeId,
                       posted = posted,
                       paid = paid,
                       fromDate = fromDate,
                       toDate = toDate,
                       amount = amount,
                       isTemplate = isTemplate,
                       pageIndex = pageIndex,
                       pageSize = pageSize,
                       withTrash = withTrash,
                       ids
                   },
                   commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<Invoice> IInvoiceRepository.searchByVoucher(int voucherId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<Invoice>("invoice_search_by_voucher",
                   new
                   {
                       voucherId
                   },
                   commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<InvoiceDetail> IInvoiceRepository.searchDetail(int personId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<InvoiceDetail>("invoice_detail_search",
                   new
                   {
                       personId
                   },
                   commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<Invoice> IInvoiceRepository.searchDeletedRecord(int pageIndex, int pageSize)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<Invoice>("invoice_search_deleted",
                    new
                    {
                        pageIndex = pageIndex,
                        pageSize = pageSize
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<Invoice> IInvoiceRepository.searchUnpaid(int companyId, int personId, int propertyId, int orderTypeId, int personTypeId, string fromDate, string toDate, int isForte, int officeId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<Invoice>("invoice_search_unpaid",
                    new
                    {
                        companyId = companyId,
                        personId = personId,
                        propertyId = propertyId,
                        orderTypeId = orderTypeId,
                        personTypeId = personTypeId,
                        fromDate = fromDate,
                        toDate = toDate,
                        isForte = isForte,
                        officeId
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        PagedList<Invoice> IInvoiceRepository.searchUnpaidPaginated(int companyId, int personId, int propertyId, int orderTypeId, int personTypeId, string fromDate, string toDate, int isForte, int officeId, int pageIndex, int pageSize, string sortBy, string filterBy)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {

                PagedList<Invoice> page = null;

                using (var multi = connection.QueryMultiple("invoice_search_unpaid_paginated",
                    new
                    {
                        companyId,
                        personId,
                        propertyId,
                        orderTypeId,
                        personTypeId,
                        fromDate,
                        toDate,
                        isForte,
                        officeId,
                        pageIndex,
                        pageSize,
                        sortBy,
                        filterBy
                    }, commandType: CommandType.StoredProcedure, commandTimeout: 0))
                {
                    page = multi.Read<PagedList<Invoice>>().Single();
                    page.data = multi.Read<Invoice>().ToList();

                }
                return page;
            }
        }

        IEnumerable<ArPaymentDetail> IInvoiceRepository.searchPayments(int invoiceId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<ArPaymentDetail>("invoice_search_payments",
                    new
                    {
                        invoiceId = invoiceId
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<CheckbookDetail> IInvoiceRepository.searchDeposits(int invoiceId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<CheckbookDetail>("invoice_search_deposits",
                    new
                    {
                        invoiceId = invoiceId
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        Invoice IInvoiceRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                Invoice invoice = null;

                try
                {
                    using (var multi = connection.QueryMultiple("invoice_get", new { invoiceId = id }, commandType: CommandType.StoredProcedure))
                    {
                        invoice = multi.Read<Invoice>().Single();
                        invoice.detail = multi.Read<InvoiceDetail>().ToList();
                    }
                }
                catch (Exception ex)
                {
                    if (ex.Message != "Sequence contains no elements")
                        throw ex;
                }
                return invoice;
            }
        }

        IEnumerable<Invoice> IInvoiceRepository.postBatch(IEnumerable<Invoice> invoicesToPost)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                var invoicesPostBatchParameter = new InvoicePostBatchDynamicParameter(invoicesToPost);

                return connection.Query<Invoice>("invoice_post_batch", invoicesPostBatchParameter, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        int IInvoiceRepository.add(Invoice item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                var invoiceParameter = new InvoiceDynamicParameter(item);

                int id = connection.ExecuteScalar<int>("invoice_add", invoiceParameter, commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        int IInvoiceRepository.addFromVoucher(int voucherId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("invoice_add_fromvoucher", new { voucherId = voucherId }, commandType: CommandType.StoredProcedure, commandTimeout: 0);

                return id;
            }
        }

        void IInvoiceRepository.update(Invoice item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                var invoiceParameter = new InvoiceDynamicParameter(item);

                int id = connection.ExecuteScalar<int>("invoice_update", invoiceParameter, commandType: CommandType.StoredProcedure);
            }
        }

        void IInvoiceRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("invoice_delete", new { invoiceId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        void IInvoiceRepository.post(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("invoice_post", new { invoiceId = id }, commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }
        
        void IInvoiceRepository.unpost(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("invoice_unpost", new { invoiceId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int IInvoiceRepository.pay(int id, decimal howMuchToPay, string paymentDate, string paymentMethod, bool paidByNacha)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int i = connection.ExecuteScalar<int>("invoice_pay",
                    new
                    {
                        invoiceId = id,
                        howMuchToPay = howMuchToPay,
                        paymentDate = paymentDate,
                        paymentMethod = paymentMethod,
                        paidByNacha = paidByNacha
                    }, commandType: CommandType.StoredProcedure);
                return i;
            }
        }

        int IInvoiceRepository.payList(int isForte, IEnumerable<Invoice> invoices)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                var invoiceParameter = new InvoicePayDynamicParameter(isForte, invoices);

                int id = connection.ExecuteScalar<int>("invoice_payList", invoiceParameter, commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        IEnumerable<Invoice> IInvoiceRepository.searchTemplates(int companyId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<Invoice>("invoice_search_templates",
                    new
                    {
                        companyId = companyId
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        void IInvoiceRepository.updateAsTemplate(Invoice item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("invoice_update_asTemplate",
                    new
                    {
                        invoiceId = item.invoiceId,
                        isTemplate = item.isTemplate,
                        templateName = item.templateName
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IInvoiceRepository.updateRecurring(Invoice item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("invoice_update_recurring",
                    new
                    {
                        invoiceId = item.invoiceId,
                        recurring = item.recurring,
                        recurringType = item.recurringType,
                        recurringInvoiceGroupID = item.recurringInvoiceGroupId
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        InvoiceBillingLog IInvoiceRepository.getAgentBilling(int invoiceBillingLogID)
        {
            InvoiceBillingLog invoiceBillingLog = null;

            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                // get invoice billing log
                using (var multi = connection.QueryMultiple("invoice_billing_log_get", new { invoiceBillingLogID}, commandType: CommandType.StoredProcedure))
                {
                    invoiceBillingLog = multi.Read<InvoiceBillingLog>().Single();
                    invoiceBillingLog.detail = multi.Read<InvoiceBillingLogDetail>().ToList();
                }
            }

            return invoiceBillingLog;

        }

        InvoiceBillingLog IInvoiceRepository.getBillingLog(int invoiceBillingLogID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<InvoiceBillingLog>("invoice_billing_log_header_get", new { invoiceBillingLogID }, commandType: CommandType.StoredProcedure);
            }

        }

        PagedList<InvoiceBillingLogDetail> IInvoiceRepository.searchBillingLogDetailPaginated(int invoiceBillingLogID, int pageIndex, int pageSize, string sortBy, string filterBy)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {

                PagedList<InvoiceBillingLogDetail> page = null;

                using (var multi = connection.QueryMultiple("invoice_billing_log_search_paginated",
                    new
                    {
                        invoiceBillingLogID,
                        pageIndex,
                        pageSize,
                        sortBy,
                        filterBy
                    }, commandType: CommandType.StoredProcedure, commandTimeout: 0))
                {
                    page = multi.Read<PagedList<InvoiceBillingLogDetail>>().Single();
                    page.data = multi.Read<InvoiceBillingLogDetail>().ToList();

                }
                return page;
            }

        }

        InvoiceBillingLog IInvoiceRepository.addAgentBilling(int companyId, int officeId, int personTypeId, string orderDate, bool includeBillingItems, bool includeReimbItems, bool posted, IEnumerable<Person> persons)
        {
            InvoiceBillingLog invoiceBillingLog = null;

            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                var invoiceBillingParameter = new InvoiceBillingDynamicParameter(companyId, officeId, personTypeId, orderDate, includeBillingItems, includeReimbItems, posted, persons);

                // create invoice billing log record
                int invoiceBillingLogID = (int)connection.ExecuteScalar("invoice_billing_log_add", invoiceBillingParameter, commandType: CommandType.StoredProcedure);

                // get invoice billing log
                using (var multi = connection.QueryMultiple("invoice_billing_log_get", new { invoiceBillingLogID, onlyHeader=0}, commandType: CommandType.StoredProcedure))
                {
                    invoiceBillingLog = multi.Read<InvoiceBillingLog>().Single();
                    invoiceBillingLog.detail = multi.Read<InvoiceBillingLogDetail>().ToList();
                }

                // create background job to hangfire
                _backgroundJobs.Enqueue(() => processInvoiceBillingAsync(invoiceBillingLogID, connectionString));
            }

            return invoiceBillingLog;

        }

        public void processInvoiceBillingAsync(int invoiceBillingLogID, string connectionString)
        {
            InvoiceBillingLog invoiceBillingLog = null;

            using (SqlConnection connection = new SqlConnection(connectionString))
            {
                //get invoice detail data
                connection.Execute("invoice_billing_datasource_add",
                   new { invoiceBillingLogID },
                   commandType: CommandType.StoredProcedure, commandTimeout: 0);

                // get invoice billing log
                using (var multi = connection.QueryMultiple("invoice_billing_log_get", new { invoiceBillingLogID, onlyHeader = 0 }, commandType: CommandType.StoredProcedure))
                {
                    invoiceBillingLog = multi.Read<InvoiceBillingLog>().Single();
                    invoiceBillingLog.detail = multi.Read<InvoiceBillingLogDetail>().ToList();
                }

                // get pending records
                List<InvoiceBillingLogDetail> pendingRecords = invoiceBillingLog.detail.Where((p) => p.status == "P").ToList();

                foreach (var item in pendingRecords)
                {
                    connection.Execute("invoice_billing_add", new { item.invoiceBillingLogDetailID }, commandType: CommandType.StoredProcedure);
                }
            }
        }

        IEnumerable<Invoice> IInvoiceRepository.searchInvoicesFromBilling(int invoiceBillingLogID, int pageIndex, int pageSize)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<Invoice>("invoice_search_from_billing",
                    new
                    {
                        invoiceBillingLogID,
                        pageIndex,
                        pageSize
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<Invoice> IInvoiceRepository.searchInvoicesPostingPropertySummary(int propertyId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<Invoice>("invoice_PostingProperty_Summary",
                    new
                    {
                        propertyId
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }


        int IInvoiceRepository.copy(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                id = connection.ExecuteScalar<int>("invoice_copy", new { invoiceId = id }, commandType: CommandType.StoredProcedure, commandTimeout: 0);

                return id;
            }

        }

        IEnumerable<Invoice> IInvoiceRepository.searchUnpaidByPerson( int personId, int companyId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<Invoice>("invoice_searchUnpaidByPerson",new{personId = personId, companyId=companyId },commandType: CommandType.StoredProcedure, commandTimeout: 0).ToList();
            }
        }

        void IInvoiceRepository.reclassify(Invoice item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                var invoiceParameter = new InvoiceDynamicParameter(item);
                int Id = connection.ExecuteScalar<int>("invoice_reclassify_details", invoiceParameter, commandType: CommandType.StoredProcedure);
            }
        }
    }
}

```
## InvoiceScannedImageRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using AT.AT2017.Api.Core.Models;
using Dapper;
using System.Data;
using AT.AT2017.Api.DynamicParameters;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class InvoiceScannedImageRepository : BaseRepository, IInvoiceScannedImageRepository
    {
        public InvoiceScannedImageRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<InvoiceScannedImage> IInvoiceScannedImageRepository.search(int invoiceID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<InvoiceScannedImage>("invoice_scannedImage_search",
                    new
                    {
                        invoiceID,
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        InvoiceScannedImage IInvoiceScannedImageRepository.get(int scannedImageID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirst<InvoiceScannedImage>("invoice_scannedImage_get", 
                    new
                    {
                        scannedImageID
                    }, commandType: CommandType.StoredProcedure);
            }
        }

        int IInvoiceScannedImageRepository.add(InvoiceScannedImage item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                item.scannedImageID = connection.ExecuteScalar<int>("invoice_scannedImage_add", new {
                    item.invoiceID,
                    item.driveID,
                    item.fileName,
                    item.description
                }, commandType: CommandType.StoredProcedure, commandTimeout: 0);

                return item.scannedImageID;
            }
        }

        void IInvoiceScannedImageRepository.delete(int scannedImageID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("invoice_scannedImage_delete", new { scannedImageID }, commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }

        void IInvoiceScannedImageRepository.update(InvoiceScannedImage item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("invoice_scannedImage_update", new
                {
                    item.scannedImageID,
                    item.description
                }, commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }
    }
}

```
## InvoiceScannedImageViewHistoryRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class InvoiceScannedImageViewHistoryRepository : BaseRepository, IInvoiceScannedImageViewHistoryRepository
    {
        public InvoiceScannedImageViewHistoryRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<InvoiceScannedImage> IInvoiceScannedImageViewHistoryRepository.search(int scannedImageID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<InvoiceScannedImage>("invoice_scannedImage_viewHistory_search",
                 new
                 {
                     scannedImageID
                 },
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }

        int IInvoiceScannedImageViewHistoryRepository.add(int scannedImageID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("invoice_scannedImage_viewHistory_add",
                    new
                    {
                        scannedImageID
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

    }
}

```
## IOfficeFormRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IOfficeFormRepository
    {
        IEnumerable<OfficeForm> search();
        OfficeForm get(int id);
        int add(OfficeForm item);
        void update(OfficeForm item);
        void delete(int id);
    }
}

```
## IOfficeGoalReportRepository.cs
```cs
using System.Collections.Generic;
using AT.AT2017.Api.Core.Models;
using System.Data;

namespace AT.AT2017.Api.Repositories
{
    public interface IOfficeGoalReportRepository
    {
        DataTable search();
    }
}

```
## IOfficeMlsRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IOfficeMlsRepository
    {
        IEnumerable<OfficeMLS> search(int officeId);
        OfficeMLS get(int id);
        int add(OfficeMLS item);
        void update(OfficeMLS item);
        void delete(int id);
    }
}

```
## IOfficeReportRepository.cs
```cs
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Model_Report;

namespace AT.AT2017.Api.Repositories
{
    public interface IOfficeReportRepository
    {
        IEnumerable<OfficeReport> search( int id, string crestCode, int companyId, int showDeleted, int dateType, string dateStart, string dateEnd, int pageIndex, int pageSize);
    }
}

```
## IOfficeRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IOfficeRepository
    {
        IEnumerable<Office> search(int companyId, string officeName, bool withTrash, bool applySecurity);
        IEnumerable<Office> searchDeletedRecord(int pageIndex, int pageSize);
        Office get(int id);
        Office office_getbynameormlsid(string desc);
        int add(Office item);
        void update(Office item);
        void delete(int id);
    }
}

```
## IPackageRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System.Collections.Generic;

namespace AT.AT2017.Api.Repositories
{
    public interface IPackageRepository
    {
        IEnumerable<Package> search(string name);

        IEnumerable<MenuAction> searchActions(string name);

        IEnumerable<Report> searchReports(string name);

        Package get(int id);

        int add(Package item);

        void update(Package item);

        void delete(int id);

        int copy(int id);

        void restoreDefaults(int id);

    }
}

```
## IPersonAddressRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IPersonAddressRepository
    {
        IEnumerable<PersonAddress> search(int personId);
        PersonAddress get(int id);
        int add(PersonAddress item);
        void update(PersonAddress item);
        void delete(int id);
    }
}

```
## IPersonAreaOfSpecializationRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IPersonAreaOfSpecializationRepository
    {
        IEnumerable<PersonAreaOfSpecialization> search(int personId);
        PersonAreaOfSpecialization get(int id);
        int add(PersonAreaOfSpecialization item);
        void update(PersonAreaOfSpecialization item);
        void delete(int id);
    }
}

```
## IPersonBillingDetailRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IPersonBillingDetailRepository
    {
        IEnumerable<PersonBillingDetail> search(int personId);
        PersonBillingDetail get(int id);
        int add(PersonBillingDetail item);
        void update(PersonBillingDetail item);
        void updateList(int personID, string saveOption, List<PersonBillingDetail> detail);
        void delete(int id);
    }

}

```
## IPersonCustomFieldRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System.Collections.Generic;

namespace AT.AT2017.Api.Repositories
{
    public interface IPersonCustomFieldRepository
    {
        IEnumerable<PersonCustomField> search(int personId);
        int add(PersonCustomField item);
        void update(PersonCustomField item);
        void delete(int id);
    }
}

```
## IPersonDeductionRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IPersonDeductionRepository
    {
        IEnumerable<PersonDeduction> search(int personId);
        PersonDeduction get(int id);
        int add(PersonDeduction item);
        void update(PersonDeduction item);
        void delete(int id);
        decimal getScalePercent(int id, int propertyId, string side);
    }
}

```
## IPersonDesignationRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IPersonDesignationRepository
    {
        IEnumerable<PersonDesignation> search(int personId);
        PersonDesignation get(int id);
        int add(PersonDesignation item);
        void update(PersonDesignation item);
        void delete(int id);
    }
}

```
## IPersonDocumentRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IPersonDocumentRepository
    {
        IEnumerable<PersonDocument> search(int personId);
        PersonDocument get(int id);
        int add(PersonDocument item);
        void update(PersonDocument item);
        void delete(int id);
    }
}

```
## IPersonDuplicatesRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IPersonDuplicatesRepository
    {
        IEnumerable<PersonDuplicates> search(int personID, bool noSearch);
        IEnumerable<PersonDuplicates> searchPeople();
    }
}

```
## IPersonGroupRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IPersonGroupRepository
    {
        IEnumerable<PersonGroup> search(int personId);
        PersonGroup get(int id);
        int add(PersonGroup item);
        void update(PersonGroup item);
        void delete(int id);
    }
}

```
## IPersonInsuranceRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IPersonInsuranceRepository
    {
        IEnumerable<PersonInsurance> search(int personId);
        PersonInsurance get(int id);
        int add(PersonInsurance item);
        void update(PersonInsurance item);
        void delete(int id);
    }
}

```
## IPersonLanguageRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IPersonLanguageRepository
    {
        IEnumerable<PersonLanguage> search(int personId);
        PersonLanguage get(int id);
        int add(PersonLanguage item);
        void update(PersonLanguage item);
        void delete(int id);
    }
}

```
## IPersonLicenseRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IPersonLicenseRepository
    {
        IEnumerable<PersonLicense> search(int personId);
        IEnumerable<PersonLicense> searchByProperty(int propertyID);
        PersonLicense get(int id);
        int add(PersonLicense item);
        void update(PersonLicense item);
        void delete(int id);
    }
}

```
## IPersonManageRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Core.Shared;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IPersonManageRepository
    {
        PagedList<PersonManage> search(int officeID, int personTypeID, int pageIndex, int pageSize, string person);
        PersonManage get(int id);
        void update(PersonManage item);
        IEnumerable<PersonManageInvoice> searchInvoices(int personId);
        //PersonForte getForteInfo(int id);
        //void addForteInfo(PersonForte item);
    }
}

```
## IPersonMediaRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IPersonMediaRepository
    {
        IEnumerable<PersonMedia> search(int personId);
        PersonMedia get(int id);
        int add(PersonMedia item);
        void update(PersonMedia item);
        void delete(int id);
    }
}

```
## IPersonMerchantRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Repositories
{
    public interface IPersonMerchantRepository
    {
        IEnumerable<PersonMerchant> search(int personId);
        PersonMerchant get(int id);
        int add(PersonMerchant item);
        void update(PersonMerchant item);
        void delete(int id);
    }
}

```
## IPersonMessageRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IPersonMessageRepository
    {
        IEnumerable<PersonMessage> search(int fromPersonId, int toPersonId);
        PersonMessage get(int id);
        int add(PersonMessage item);
        void update(PersonMessage item);
        void delete(int id);
    }
}

```
## IPersonMlsRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IPersonMlsRepository
    {
        IEnumerable<PersonMls> search(int personId);
        PersonMls get(int id);
        int add(PersonMls item);
        void update(PersonMls item);
        void delete(int id);
    }
}

```
## IPersonOnlinePaymentRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IPersonOnlinePaymentRepository
    {
        IEnumerable<PersonOnlinePayment> search(int personId);
        PersonOnlinePayment get(int id);
        int add(PersonOnlinePayment item);
        void update(PersonOnlinePayment item);
        void delete(int id);
    }
}

```
## IPersonOverrideRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IPersonOverrideRepository
    {
        IEnumerable<PersonOverride> search(int personAgentId, int overrideTypeId, int person3rdPartyId, int accountId, int officeId);
        PersonOverride get(int id);
        int add(PersonOverride item);
        void update(PersonOverride item);
        void delete(int id);
    }
}

```
## IPersonPhoneRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IPersonPhoneRepository
    {
        IEnumerable<PersonPhone> search(int personId);
        PersonPhone get(int id);
        int add(PersonPhone item);
        void update(PersonPhone item);
        void delete(int id);
    }
}

```
## IPersonPositionRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IPersonPositionRepository
    {
        IEnumerable<PersonPosition> search(int personId);
        PersonPosition get(int id);
        int add(PersonPosition item);
        void update(PersonPosition item);
        void delete(int id);
    }
}

```
## IPersonPreferenceRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IPersonPreferenceRepository
    {
        IEnumerable<PersonPreference> search(int personId);
        PersonPreference get(int id);
        int add(PersonPreference item);
        void update(PersonPreference item);
        void delete(int id);
    }
}

```
## IPersonReportRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IPersonReportRepository
    {
        IEnumerable<PersonReport> search(string personId ,string personType, string active, string dateType, string dateStart, string dateEnd, int pageIndex, int pageSize,
            string showAddresses, string showPhones, string showPositions, string showLicenses, string showInsurances, string showWebProfiles, string showLanguages,
            string showDesignations, string showDeductions, string showTotals, string showExpensesToRecover, string showExpensesRecovered, string showOverrides, string showCustomFields, string showDeleted, string showLevels);
    }
}

```
## IPersonRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Core.Shared;

namespace AT.AT2017.Api.Repositories
{
    public interface IPersonRepository
    {

        IEnumerable<Person> search(string person, int personTypeID, int userID, int companyID, int pageIndex, int pageSize, string sortedBy, string custom, int officeID, int propertyID, string side, string companyName, string mls, string emailAddress, string phoneNumber, string licenseNumber, string filter1, string filter2, bool withTrash,string active, int cobrokeOfficeID, string printedName, int personID, bool applySecurity, string personTaxID);

        PagedList<Person> searchPaginated(string person, int personTypeID, int userID, int companyID, int pageIndex, int pageSize, string sortedBy, string custom, int officeID, int propertyID, string side, string companyName, string mls, string emailAddress, string phoneNumber, string licenseNumber, string filter1, string filter2, bool withTrash,string active, int cobrokeOfficeID, string printedName, int personID, bool applySecurity, string personTaxID, string offices, string sortBy, string FilterBy);

        IEnumerable<Person> searchDeletedRecord(int pageIndex, int pageSize);

        IEnumerable<Property> searchRelatedProperties(int personId);

        IEnumerable<Person> searchAgents();

        IEnumerable<Person> searchByProperty(int propertyID);

        Person get(int id);

        Person getEscrowPayee(int companyID);

        Person person_getbypersonidormls(string desc);

        int add(Person item);

        void update(Person item,string propIds, int updateOption,int autoTerminatePositions);

        void delete(int id);

        void personmerge(int personidtokeep, int personidtoremove);

        IEnumerable<Person> searchRecipients(int recipientId,string personName);

        int import(IEnumerable<PersonImport> table);

        IEnumerable<PersonImport> getImportLog(int logId);

        void updateBillingNotes(int id, string billingNotes);

        IEnumerable<Person> searchForAgentBilling(int personTypeID, int companyID,string officeID,string filter1, string filter2,string active, int pageIndex, int pageSize);

    }
}

```
## IPersonTimelineTaskManualRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IPersonTimelineTaskManualRepository
    {
        PersonTimelineTask get(int id);
        int add(PersonTimelineTask item);
        void update(PersonTimelineTask item);
        void delete(int id);
    }
}

```
## IPersonTimelineTaskRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IPersonTimelineTaskRepository
    {
        IEnumerable<PersonTimelineTask> search(int personId);
        PersonTimelineTask get(int id);
        int add(PersonTimelineTask item);
        void update(PersonTimelineTask item);
        void delete(int id);
    }
}

```
## IPersonTotalDetailRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IPersonTotalDetailRepository
    {
        IEnumerable<PersonTotalDetail> search(int personTotalID);
    }
}

```
## IPersonTotalRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System.Collections.Generic;

namespace AT.AT2017.Api.Repositories
{
    public interface IPersonTotalRepository
    {
        IEnumerable<PersonTotal> search(int personID);

        IEnumerable<PersonTotal> searchByPropertyID(int propertyID, string checkTemplateIDs);

        IEnumerable<PersonTotal> searchUpdateLog(int propertyID, string processedDate);

        PersonTotal get(int id);

        IEnumerable<PersonTotal> total_get_balanceamount(int personId, int propertyId, int totalId);

        int add(PersonTotal item);

        void update(int personID, int validateLogin);

        void delete(int personID, int totalID, int companyID, int officeID , int planID , bool isForTerminated);

        void updateOpeningBalance(int id, decimal openingBalance, string balanceEndDate);

        IEnumerable<PersonTotal> updateOnPropertyPost(int propertyID, string processedDate, string checkTemplateIDs, string actionType);

        IEnumerable<PersonTotal> updateOnCustomCase(int personID, string processedDate, string customCase, int propertyID, string connectionString = null);

        void updateTotalOnDemand(int personTotalID, string processDate, string updateType);

        // on-demand execution
        PersonTotalUpdateLog startOnDemandExecution(string updateType);

        PersonTotalUpdateLog getLastOnDemandExecution(string processDate);

        IEnumerable<PersonTotal> searchPlan(int userID);

    }
}

```
## IPersonUptimeRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IPersonUptimeRepository
    {
        IEnumerable<PersonUptime> search(int personId);
        PersonUptime get(int id);
        int add(PersonUptime item);
        void update(PersonUptime item);
        void delete(int id);
    }
}

```
## IPersonWebProfileRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IPersonWebProfileRepository
    {
        IEnumerable<PersonWebProfile> search(int personId);
        PersonWebProfile get(int id);
        int add(PersonWebProfile item);
        void update(PersonWebProfile item);
        void delete(int id);
    }
}

```
## IPersonWebsiteRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System.Collections.Generic;

namespace AT.AT2017.Api.Repositories
{
    public interface IPersonWebsiteRepository
    {
        IEnumerable<PersonWebsite> search(int personId);
        PersonWebsite get(int id);
        int add(PersonWebsite item);
        void update(PersonWebsite item);
        void delete(int id);
    }
}

```
## IPlaidRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System.Collections.Generic;

namespace AT.AT2017.Api.Repositories
{
    public interface IPlaidRepository
    {
        IEnumerable<PlaidConnectLog> searchConnectLog();

        void saveConnectLog(string actionType, string request_id, string link_token, string link_token_expiration, string public_token, string link_session_id, string institution_name, string institution_id, string item_id, string access_token);

    }
}

```
## IPropertyByAgentCubeRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System.Collections.Generic;
using System.Data;

namespace AT.AT2017.Api.Repositories
{
    public interface IPropertyByAgentCubeRepository
    {
        IEnumerable<PropertyByAgentCube> search(int propertyId);
        PropertyByAgentCube getFieldsSelected(int propertyId,int personId, string side, int columnNumber, int correspondenceTemplateId, int formType);
        PropertyByAgentCube get(int id);
        DataTable processFormulas(int templateId, int propertyId, int personId, string side);
        DataTable getRealLivingClosingsPrior(string monthYear);
        DataTable getRealLivingMonthly(string monthYear);
    }
}

```
## IPropertyCubeRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System.Data;

namespace AT.AT2017.Api.Repositories
{
    public interface IPropertyCubeRepository
    {
        PropertyCube getFieldsSelected(int propertyId, int correspondenceTemplateId, int formType);
        PropertyCube get(int id);
        DataTable processFormulas(int templateId, int propertyId, int personId, string side);
    }
}

```
## IPropertyCustomFieldRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System.Collections.Generic;

namespace AT.AT2017.Api.Repositories
{
    public interface IPropertyCustomFieldRepository
    {
        IEnumerable<PropertyCustomField> search(int propertyId);
        int add(PropertyCustomField item);
        void update(PropertyCustomField item);
        void delete(int id);
    }
}

```
## IPropertyDeductionHistoryRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System.Collections.Generic;

namespace AT.AT2017.Api.Repositories
{
    public interface IPropertyDeductionHistoryRepository
    {
        IEnumerable<PropertyDeductionHistory> search(int propertyDeductionId ,int deductionId);
    }
}

```
## IPropertyDeductionOverrideRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IPropertyDeductionOverrideRepository
    {
        IEnumerable<PropertyDeductionOverride> search(int propertyId, int propertyDeductionId, int personOverrideId, bool applyTaxes, decimal? taxCollected);
        PropertyDeductionOverride get(int id);
        int add(PropertyDeductionOverride item);
        void update(PropertyDeductionOverride item);
        void delete(int id);
        void refresh(int propertyId);
    }
}

```
## IPropertyDeductionRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IPropertyDeductionRepository
    {
        IEnumerable<PropertyDeduction> search(int propertyId, string side, bool applyTaxes, decimal? taxCollected);

        PropertyDeduction get(int id);

        int add(PropertyDeduction item, bool recalculateInParallel, bool updateTotals);

        void update(PropertyDeduction item, string deductCodeUpdated, bool enableFlat, bool recalculateInParallel, bool updateTotals);

        void delete(int id, int propertyId, string side, bool recalculateInParallel, bool updateTotals);

        string calculateBillDeduct(int personId);

        void recalculate(int propertyId, string side, bool inParallel, bool force, bool restart, bool updateTotals);        

        void updateAgentOffice(PropertyDeduction item);

        IEnumerable<Invoice> searchPropertyDeductionAgentsInvoices(int propertyId);

        void recalculateDeductions(int propertyId, string side, List<PropertyDeduction> existingAgents, bool inParallel, bool force, bool updateTotals, int propertyDeductionId = 0, string deductCode = "");

    }
}

```
## IPropertyDocumentHistoryRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IPropertyDocumentHistoryRepository
    {
        IEnumerable<PropertyDocument> search(int documentId);
        int add(int documentId);
    }
}

```
## IPropertyDocumentRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IPropertyDocumentRepository
    {
        IEnumerable<PropertyDocument> search(int propertyId);
        PropertyDocument get(int id);
        int add(PropertyDocument item);
        void update(PropertyDocument item);
        void delete(int id);
        void delivery(int id, string email);
    }
}

```
## IPropertyEmailRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Repositories
{
    public interface IPropertyEmailRepository
    {
        PropertyEmail get(int id);
        PropertyEmail getSuggestion(int id);
        int add(PropertyEmail item);
        bool checkAvailability(PropertyEmail item);
        void delete(int id);
    }
}

```
## IPropertyExtraVoucherRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System.Collections.Generic;

namespace AT.AT2017.Api.Repositories
{
    public interface IPropertyExtraVoucherRepository
    {
        IEnumerable<PropertyExtraVoucher> search(int propertyId, bool applyTaxes, decimal? taxCollected);
        PropertyExtraVoucher get(int id);
        int add(PropertyExtraVoucher item);
        void update(PropertyExtraVoucher item);
        void delete(int id);
        void refresh(int propertyId);
    }
}

```
## IPropertyFeatureRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Repositories
{
    public interface IPropertyFeatureRepository
    {
        IEnumerable<PropertyFeature> search(int propertyId);
        PropertyFeature get(int id);
        int add(PropertyFeature item);
        void update(PropertyFeature item);
        void delete(int id);
    }
}

```
## IPropertyInternalMessageRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IPropertyInternalMessageRepository
    {

        IEnumerable<PropertyInternalMessage> search(int propertyId);
        PropertyInternalMessage get(int id);
        int add(PropertyInternalMessage item);
        void update(PropertyInternalMessage item);
        void delete(int id);

    }
}

```
## IPropertyMlsRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System.Collections.Generic;

namespace AT.AT2017.Api.Repositories
{
    public interface IPropertyMlsRepository
    {
        IEnumerable<PropertyMls> search(int propertyID);

        PropertyMls get(int id);

        int add(PropertyMls item);

        void update(PropertyMls item);

        void delete(int id);
    }
}

```
## IPropertyOffsetRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IPropertyOffsetRepository
    {
        IEnumerable<PropertyOffset> search(string side);
        IEnumerable<PropertyOffset> search_reversible();
        PropertyOffset get(int id);
        void update(PropertyOffset item);

    }
}

```
## IPropertyOpenhouseRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IPropertyOpenhouseRepository
    {
        IEnumerable<PropertyOpenhouse> search(int propertyId);
        PropertyOpenhouse get(int id);
        int add(PropertyOpenhouse item);
        void update(PropertyOpenhouse item);
        void delete(int id);
    }
}

```
## IPropertyPaymentOffTheTopRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IPropertyPaymentOffTheTopRepository
    {
        IEnumerable<PropertyPaymentOffTheTop> search(int propertyId, int personId, bool includeCobroke, bool applyTaxes, decimal? taxCollected);
        PropertyPaymentOffTheTop get(int id);
        int add(PropertyPaymentOffTheTop item);
        void update(PropertyPaymentOffTheTop item);
        void delete(int id);
    }
}

```
## IPropertyPeopleRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IPropertyPeopleRepository
    {
        IEnumerable<PropertyPeople> search(int propertyId, string typeName, string side);
        PropertyPeople get(int id);
        int add(PropertyPeople item);
        void update(PropertyPeople item);
        void delete(int id);
    }
}

```
## IPropertyPictureRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IPropertyPictureRepository
    {
        IEnumerable<PropertyPicture> search(int propertyId);

        PropertyPicture get(int id);

        void add(IEnumerable<PropertyPicture> items);

        void update(PropertyPicture item);

        void delete(int id);

        void delivery(int propertyId, string email);
    }
}

```
## IPropertyReimbursementRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IPropertyReimbursementRepository
    {
        IEnumerable<PropertyReimbursement> search(int propertyId, bool applyTaxes, decimal? taxCollected);
        PropertyReimbursement get(int id);
        int add(PropertyReimbursement item);
        void update(PropertyReimbursement item);
        void delete(int id);
    }
}

```
## IPropertyRemarkRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IPropertyRemarkRepository
    {
        IEnumerable<PropertyRemark> search(int propertyId);
        PropertyRemark get(int id);
        int add(PropertyRemark item);
        void update(PropertyRemark item);
        void delete(int id);
    }
}

```
## IPropertyReportRepository.cs
```cs
using System.Data;
using System.Collections.Generic;
using AT.AT2017.Api.Core.Model_Report;

namespace AT.AT2017.Api.Repositories
{
    public interface IPropertyReportRepository
    {
        IEnumerable<PropertyReport> search(string propertyId, int officeID, int companyID,
                                            string showBasicInfo, string showAgentNetList, 
                                            string showAgentNetSell, string showSellerInfo,
                                            string showBuyerInfo, string showPeople, string showFeatures, string showRemarks, string showRooms,
                                            string showMedia, string showOpenHouses, string showShowings, string showTasks,
                                            string showDocuments, string show3rdPartyPayments, string showReimbs, string showReferrals,
                                            string showExtravouchers, string showOverrides, string showAccounting, string showFinancing,string showCustomFields,
                                            string showDeleted,string statusToShow, int dateType, string dateStart, string dateEnd, string providerType,string personProviderType,
                                            string listOffice,string sellOffice,string listAgent,string sellAgent,string sellerSendSurveyDelivery,string buyerSendSurveyDelivery,
                                            int agentOfficeID, int agentID, int pageIndex, int pageSize);

        DataTable searchSummary(string dateStart, string dateEnd, int companyID, int officeID, int pageIndex, int pageSize);

    }
}

```
## IPropertyRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Data;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Core.Shared;

namespace AT.AT2017.Api.Repositories
{
    public interface IPropertyRepository
    {
        IEnumerable<Property> search(int companyId, string filter, string address, string mls, string propId, string trType, int statusId, int propertyTypeId, int pageIndex, int pageSize, string sortedBy, string customCase, bool withTrash, string statusCode);
        PagedList<Property> searchPaginated(int companyId, string filter, string address, string mls, string propId, string trType, int statusId, int propertyTypeId, int pageIndex, int pageSize, string sortedBy, string customCase, bool withTrash, string statusCode);

        PagedList<PropertyMain> advance_searchPaginated(int companyId, string address, string mls, string propId, string status, int propertyTypeId, string fromDate, string toDate, string qaControl1, string qaControl2, string buyer, string seller, string brokerReferenceNo, string escrowNo, int classificationId, int pageIndex, int pageSize, string filterBy, string trType, bool withTrash, string agent, int officeId, string escrowPayeeName, string sortBy, string filter1By);
        IEnumerable<PropertyMain> advance_search(int companyId, string address, string mls, string propId, string status, int propertyTypeId, string fromDate, string toDate, string qaControl1, string qaControl2, string buyer, string seller, string brokerReferenceNo, string escrowNo, int classificationId, int pageIndex, int pageSize, string filterBy, string trType, bool withTrash, string agent, int officeId, string escrowPayeeName);

        IEnumerable<Property> searchDeletedRecord(int pageIndex, int pageSize);

        IEnumerable<Property> searchByPerson(int personId, string status);
        Property get(int id);
        int add(Property item);
        void update(Property item, bool onlyUpdateCommission, bool refreshListSide, bool refreshSellSide, IPropertyDeductionRepository propertyDeductionRepository, bool recalculateInParallel, bool updateTotals);
        void updateNeedRecalc(int propertyId);
        void updateThirdPartyID(int propertyId, string thirdPartyIdField, string thirdPartyId);
        void updateAppFileID(int propertyID, int appFileID);
        void delete(int id);
        int copy(int id, string copyType);
        void unpost(int id);
        IEnumerable<PropertyPostError> validatePost(Property item, string postDateAccounting, string postDateArPayment, string postDateApPayment, string postDateDeposit, bool directDeposit, string checkNumber, int commissionAccountId, bool recordCommission, bool onePayment, string payment1, string payment2, string payment3, bool recordAsSingleDeposit, int depositAccountId, bool writeEscrowCheck, string escrowCheckNumber, bool payEscrowByForte, string deposits, bool excludeRules);
        PropertyPostResult post(Property item, string postDateAccounting, string postDateArPayment, string postDateApPayment, string postDateDeposit, bool directDeposit, string checkNumber, int commissionAccountId, bool recordCommission, bool onePayment, string payment1, string payment2, string payment3, bool recordAsSingleDeposit, int depositAccountId, bool writeEscrowCheck, string escrowCheckNumber, bool payEscrowByForte, string deposits, bool excludeRules);
        void updatePostInfo(Property item);
        Invoice previewInvoice(int id, string postDate);
        IEnumerable<InvoiceDetail> previewInvoiceRegional(int id);
        IEnumerable<Voucher> previewVoucherxAgent(int id, string postDate, decimal taxCollected);
        IEnumerable<Voucher> previewVoucherxReferral(int id, string postDate, decimal taxCollected);
        IEnumerable<Voucher> previewVoucherxThirdParty(int id, string postDate, decimal taxCollected);
        IEnumerable<Voucher> previewVoucherxOverride(int id, string postDate, decimal taxCollected);
        IEnumerable<Voucher> previewVoucherxReimbursement(int id, string postDate, decimal taxCollected);
        IEnumerable<Voucher> previewVoucherxExtraVoucher(int id, string postDate, decimal taxCollected);
        IEnumerable<Checkbook> previewCheckbookEscrows(int id, string postDate);
        int updateAddCustomer(int id);
        IEnumerable<CodeValue> closeDateList();
        void postRegional(Property item, string postDateAccounting);
        void unpostRegional(int id);
        IEnumerable<PropertyPostError> validatePostRegional(Property item, string postDateAccounting);

        // recalculate pendings
        RecalculatePendingsExecution recalculatePendingsGetExecution(int executionID = 0);
        int recalculatePendings();

        DataTable payload(PropertyPayload payload);

        void updateAgentTeam(int propertyId, int agentTeamId, string side);

        void updateAgentInfo(int propertyId, int agentTeamListId, int agentTeamSellId, int listSubplanId, int sellSubplanId);

        double calculateCustomCommission(double percentage, int codeValueId, int propertyId);
    }
}


```
## IPropertyRoomRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IPropertyRoomRepository
    {
        IEnumerable<PropertyRoom> search(int propertyId);
        PropertyRoom get(int id);
        int add(PropertyRoom item);
        void update(PropertyRoom item);
        void delete(int id);
    }
}

```
## IPropertyShowingFeedbackRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IPropertyShowingFeedbackRepository
    {
        IEnumerable<PropertyShowingFeedback> search(int propertyShowingId);
        PropertyShowingFeedback get(int id);
        int add(PropertyShowingFeedback item);
        void update(PropertyShowingFeedback item);
        void delete(int id);
    }
}

```
## IPropertyShowingRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IPropertyShowingRepository
    {
        IEnumerable<PropertyShowing> search(int propertyId);
        PropertyShowing get(int id);
        int add(PropertyShowing item);
        void update(PropertyShowing item);
        void delete(int id);
    }
}

```
## IPropertySyndicationOptOutRepository.cs
```cs
using System.Collections.Generic;
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Repositories
{
    public interface IPropertySyndicationOptOutRepository
    {
        IEnumerable<PropertySyndicationOptOut> search(int propertyID);

        PropertySyndicationOptOut get(int id);

        int add(PropertySyndicationOptOut item);

        void update(PropertySyndicationOptOut item);

        void delete(int id);
    }
}

```
## IPropertyThirdPartyPaymentRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IPropertyThirdPartyPaymentRepository
    {
        IEnumerable<PropertyThirdPartyPayment> search(int propertyDeductionId, bool applyTaxes, decimal? taxCollected);
        PropertyThirdPartyPayment get(int id);
        int add(PropertyThirdPartyPayment item);
        void update(PropertyThirdPartyPayment item);
        void delete(int id);
    }
}

```
## IPropertyTimelineTaskManualRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IPropertyTimelineTaskManualRepository
    {
        PropertyTimelineTask get(int id);
        int add(PropertyTimelineTask item);
        void update(PropertyTimelineTask item);
        void delete(int id);
    }
}

```
## IPropertyTimelineTaskRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IPropertyTimelineTaskRepository
    {
        IEnumerable<PropertyTimelineTask> search(int propertyId);
        PropertyTimelineTask get(int id);
        int add(PropertyTimelineTask item);
        void notify(int propertyId, string side);
        void update(PropertyTimelineTask item);
        void delete(int id);
    }
}

```
## IPropertyTotalRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System.Collections.Generic;

namespace AT.AT2017.Api.Repositories
{
    public interface IPropertyTotalRepository
    {
        IEnumerable<PropertyTotal> search(int propertyID);

        IEnumerable<PropertyTotal> searchUpdateLog(int propertyID, string processedDate);

        PropertyTotal get(int id);

        int add(PropertyTotal item);

        IEnumerable<PropertyTotal> updateAll(int propertyID, string processedDate, string actionType);

        void delete(int propertyID, int totalID);

    }
}

```
## IPropertyTourRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IPropertyTourRepository
    {
        IEnumerable<PropertyTour> search(int propertyId);
        PropertyTour get(int id);
        int add(PropertyTour item);
        void update(PropertyTour item);
        void delete(int id);
    }
}

```
## IQuickbookRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IQuickbookRepository
    {
        IEnumerable<Quickbook> search(DateTime date, int companyId);
    }
}
```
## IReconciliationFireRepository.cs
```cs
using System;
using System.Collections.Generic;
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Repositories
{
    public interface IReconciliationFireRepository
    {
        IEnumerable<ReconciliationFire> search(int reconciliationId, int year, int companyId);

        IEnumerable<ReconciliationFireSource> searchSource(string fileType);

        ReconciliationFire get(int id, bool onlyHeader = false);

        int add(string fileType, int reconciliationId, int reconciliationFireParentId, string formatType, string description, bool isForRental, string contactName, string contactEmail, string contactPhone);

        void update(ReconciliationFire item);

        void updateDoNotUpload(int reconciliationFireId, bool doNotUpload);

        void rebuild(int reconciliationFireId);

        void delete(int reconciliationFireId);

        ReconciliationFire generate(ReconciliationFire item);

        void send(int reconciliationFireId, string emailAddress, string remoteUrl);

        void uploaded(int reconciliationFireId, DateTime uploadedDate, string uploadedBy);

        IEnumerable<ReconciliationFireError> validate(int reconciliationFireId);
    }
}

```
## IReconciliationMergeFieldRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System.Collections.Generic;

namespace AT.AT2017.Api.Repositories
{
    public interface IReconciliationMergeFieldRepository
    {
        IEnumerable<ReconciliationMergeField> search();
    }
}

```
## IReconciliationTemplateRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System.Collections.Generic;

namespace AT.AT2017.Api.Repositories
{
    public interface IReconciliationTemplateRepository
    {
        IEnumerable<ReconciliationTemplate> search(string name);
        IEnumerable<ReconciliationTemplate> searchFromMaster();
        ReconciliationTemplate get(int id);
        ReconciliationTemplate getFromMaster(int id);
        void exportToMaster(int id);
        int add(ReconciliationTemplate item);
        void update(ReconciliationTemplate item);
        void delete(int id);
    }
}

```
## IReconciliationWriterRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System.Collections.Generic;

namespace AT.AT2017.Api.Repositories
{
    public interface IReconciliationWriterRepository
    {
        IEnumerable<ReconciliationWriter> search(int companyId,int reconciliationId, int year,string personId,int recordsByPage,bool repeatByPage);
    }
}

```
## IRecurringRepository.cs
```cs
using System.Collections.Generic;
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Repositories
{
    public interface IRecurringRepository
    {
        IEnumerable<Recurring> search(string docType, string recurringType,int recurringPayableGroupId);
        void delete(string docType, int entityID);
        int addVoucher(Recurring item);
        int addJournal(Recurring item);
        int addInvoice(Recurring item);
    }
}

```
## IRegionOfficeRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IRegionOfficeRepository
    {
        IEnumerable<RegionOffice> search(int regionId);
        RegionOffice get(int id);
        int add(RegionOffice item);
        void delete(int id);
    }
}

```
## IRegionRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IRegionRepository
    {
        IEnumerable<Region> search();
        Region get(int id);
        int add(Region item);
        void update(Region item);
        void delete(int id);
    }
}

```
## IReimbursementRepository.cs
```cs
using System.Collections.Generic;
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Core.Shared;

namespace AT.AT2017.Api.Repositories
{
    public interface IReimbursementRepository 
    {
        IEnumerable<Reimbursement> search(int personId, string reimb);

        PagedList<Reimbursement> searchPaginated(int personId, string reimb, int pageIndex, int pageSize);

        void update(IEnumerable<Reimbursement> list);
    }
}

```
## IRepCubeRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System.Collections.Generic;

namespace AT.AT2017.Api.Repositories
{
    public interface IRepCubeRepository
    {
        IEnumerable<RepCube> search();

        IEnumerable<RepCube> searchExecutionLog(string cubeName);

        string fillTable(string cubeList, int userID, string updateType);

        bool isRunninng();

        void stopExecution();

    }
}

```
## IReplicationRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System.Collections.Generic;

namespace AT.AT2017.Api.Repositories
{
    public interface IReplicationRepository
    {
        IEnumerable<Database> searchAllDatabases();
        void execute(string server,string database, int logId, string query);
        int addLog(string sql);
    }
}

```
## IReportDataSourceRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Repositories
{
    public interface IReportDataSourceRepository
    {
        IEnumerable<ReportDataSource> search(string dataSource, int type, string filter);
        IEnumerable<string> all(string type);
    }
}


```
## IReportFavoriteRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Repositories
{
    public interface IReportFavoriteRepository
    {
        int add(int id);
        void delete(int id);
    }
}


```
## IReportLaunchedRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System.Collections.Generic;

namespace AT.AT2017.Api.Repositories
{
    public interface IReportLaunchedRepository
    {
        ReportLaunched get(int userId);

        void add(ReportLaunched item);
    }
}

```
## IReportRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IReportRepository
    {
        IEnumerable<Report> search(int userId, string masterKeyName);
        IEnumerable<Report> searchNotInPackage(int userId);
        Report search(string url);
        IEnumerable<Report> searchByGroup(string group);
        Report get(int id, bool raw);
        Report getCampaignReport(int id, int campaignReportId);
        int addCustom(ReportCustom item);
        int add(Report item);
        int update(Report item);
        int delete(int id);
        IEnumerable<Report> searchFromMaster();
        Report getFromMaster(int id);
        IEnumerable<ReportColumn> searchColumns();
        IEnumerable<ReportColumn> searchStandarColumns(int id);
        void exportToMaster(int id);
        void sendByEmail(int id,int userID,string email,string parameters, bool byExcel, string reportLink, string subject);
        IEnumerable<Package> searchPackages(int reportID);
        void addPachages(int reportID, string packages);
    }
}

```
## IRoleRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IRoleRepository
    {
        IEnumerable<Role> search(string name);
        Role get(int id);
        int add(Role item);
        void update(Role item);
        void delete(int id);
    }
}

```
## ISecurityRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface ISecurityRepository
    {
        IEnumerable<Security> search(int roleId, int actionId, int userId);

        IEnumerable<MenuAction> searchActions(int userId, bool retrieveControls);

        Security get(int id);

        int add(Security item);

        void delete(int id);
    }
}

```
## IServerRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IServerRepository
    {
        IEnumerable<Server> searchServers(bool isActive);
    }
}

```
## ISettingRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface ISettingRepository
    {
        IEnumerable<Setting> search(string name, string description, string section, string type);
        IEnumerable<Setting> searchList(string procedure);
        IEnumerable<Setting> searchListByCompany(string procedure, int companyID);
        IEnumerable<Setting> searchListFields(string tableName);
        IEnumerable<Setting> searchDashSettings();
        IEnumerable<Setting> searchByAction(int actionID);
        IEnumerable<SettingWCCheckDetail> searchWCCheckDetailColumns(int id);
        IEnumerable<Setting> searchWCCheckDetailFields(int id);
        Setting get(int id);
        Setting get(string name);
        void update(Setting item);
        int add(Setting item);
    }
}

```
## IStoreOrderRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Core.Shared;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IStoreOrderRepository
    {
        PagedList<StoreOrderSearchResult> search(int orderId, int invoiceId, int inventoryId, int companyId, int personId, int propertyId,
            string descriptiveText, string fromDate, string toDate, bool? filled, decimal? saleTotal, bool? paid, int pageIndex, int pageSize, string item);

        StoreOrder get(int id);

        int add(StoreOrder items);

        void update(StoreOrder item);

        void delete(int id);
    }
}

```
## ISubmissionRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Repositories
{
    public interface ISubmissionRepository
    {
        IEnumerable<Submission> search(int entityId, string entityType,int submitId, string submitType);
        string searchXml(int entityId, string entityType, int detailId, string command, bool dash);
        Submission get(int submitID);
        IEnumerable<SubmissionBatch> searchIdsSQL8(int submitId, string dbName);
        SubmissionBatch getSQL8Results(int submitId, string dbName);
        IEnumerable<Submission> searchIds();

        // Remax
        int addSubmissionRemax(int companyId, int year, int month,bool sendToApi);
        IEnumerable<SubmissionRemax> getSubmissionRemax( int submitId);
        int updateSubmissionRemax(int submitId,string email,string urlFile);
        IEnumerable<SubmissionRemax> searchRemax(int companyId, int year, int month,int submitId);       
        IEnumerable<SubmissionRemax> searchRemaxIds(int companyId, int year, int month);
        int resendSubmissionRemax(int submitId);

        void addRemaxLog(long detailId, RemaxApiLog log);
        IEnumerable<SaveStatisticInput> getSubmissionRemaxStatistic(int submitId);
        SaveStatisticInput refreshItemStatistic(int id);

        // submission Berkshire Hataway
        IEnumerable<SubmissionBHS> searchBHSIds(int companyId, string fromDate, string endDate);
        SubmissionBHS getSubmissionBHS(int submitId);
        SubmissionBHS previewSubmissionBHS(int companyId, string endDate,int validate);
        int addSubmissionBHS( SubmissionBHS submission);
        int refreshSubmissionBHS(SubmissionBHS submission);
        void updateSubmissionBHS(int submitID, string email, string txtUrlFile, string xmlUrlfile);
        int resendSubmissionBHS(int submitId, string email);
        void deleteSubmissionBHS(int submitId);

        // submission NACHA
        IEnumerable<SubmissionNACHA> searchNacha(int companyId,int accountId, string startDate, string endDate);
        SubmissionNACHA getNacha(int submitId);
        SubmissionNACHA previewNacha(int companyId, int accountId, string startDate, string endDate,string processDate, string email, int isBalanced);
        int addNacha(SubmissionNACHA submission);
        void deleteNacha(int submitId);
        void finishNacha(int submitId);
        IEnumerable<SubmissionNachaDetail> validateNacha(int companyId, int accountId, string startDate, string endDate);
    }
}

```
## ISubmissionScheduleRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System.Collections.Generic;

namespace AT.AT2017.Api.Repositories
{
    public interface ISubmissionScheduleRepository
    {
        IEnumerable<SubmissionSchedule> search(int companyId);
        IEnumerable<Server> searchServer();
        SubmissionSchedule get(int id);
        int add(SubmissionSchedule item);
        void update(SubmissionSchedule item);
        void delete(int id);
    }
}

```
## ISystemRepository.cs
```cs
using System.Collections.Generic;
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Repositories
{
    public interface ISystemRepository
    {
        IEnumerable<SystemErrorCode> search(int systemID);
    }
}

```
## ITaskGroupRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System.Collections.Generic;

namespace AT.AT2017.Api.Repositories
{
    public interface ITaskGroupRepository
    {
        IEnumerable<TaskGroup> search(int groupID);
        int add(TaskGroup item);
        void delete(TaskGroup item);
    }
}

```
## ITaskRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System.Collections.Generic;

namespace AT.AT2017.Api.Repositories
{
    public interface ITaskRepository
    {
        IEnumerable<Task> search(string source);
        Task get(int id);
        int add(Task item);
        void update(Task item);
        void delete(int id);
    }
}

```
## ItemForSaleRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using AT.AT2017.Api.Core.Models;
using System.Data.SqlClient;
using AT.AT2017.Api.DynamicParameters;
using AT.AT2017.Api.Core.Shared;

namespace AT.AT2017.Api.Repositories
{
    public class ItemForSaleRepository : BaseRepository, IItemForSaleRepository
    {
        public ItemForSaleRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        PagedList<ItemForSale> IItemForSaleRepository.search(int pageIndex, int pageSize, string item, bool? inStock, int? priceStart, int? priceEnd, string sortBy)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                PagedList<ItemForSale> page = null;

                using (var multi = connection.QueryMultiple("itemForSale_search",
                 new
                 {
                     pageIndex,
                     pageSize,
                     item,
                     inStock,
                     priceStart,
                     priceEnd,
                     sortBy
                 },
                 commandType: CommandType.StoredProcedure))
                {
                    var data = multi.Read<ItemForSale>().ToList();
                    page = multi.Read<PagedList<ItemForSale>>().Single();
                    page.data = data;
                }

                return page;
            }
        }

        ItemForSale IItemForSaleRepository.get(int inventoryId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<ItemForSale>("itemForSale_get", new { inventoryId }, commandType: CommandType.StoredProcedure);
            }
        }

        void IItemForSaleRepository.add(ItemForSale item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("itemForSale_add",
                    new
                    {
                        item.item,
                        item.price,
                        item.driveID,
                        item.imageUrl,
                        item.justInvoice,
                        item.requirePrePayment,
                        item.requirePropertyAddress,
                        item.needsImages,
                        item.needsDescriptiveText,
                        item.description,
                        item.emailTo,
                        item.inventory,
                        item.inventoryStartDate,
                        item.inventoryEndDate,
                        item.accountId,
                        item.agentsOffice,
                        item.companyAndOffice,
                        item.officeId,
                        item.companyId,
                    }, commandType: CommandType.StoredProcedure);
            }
        }

        void IItemForSaleRepository.update(ItemForSale item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("itemForSale_update",
                    new
                    {
                        item.inventoryId,
                        item.item,
                        item.price,
                        item.driveID,
                        item.imageUrl,
                        item.justInvoice,
                        item.requirePrePayment,
                        item.requirePropertyAddress,
                        item.needsImages,
                        item.needsDescriptiveText,
                        item.description,
                        item.emailTo,
                        item.inventory,
                        item.inventoryStartDate,
                        item.inventoryEndDate,
                        item.accountId,
                        item.agentsOffice,
                        item.companyAndOffice,
                        item.officeId,
                        item.companyId,
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IItemForSaleRepository.delete(int pictureId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("itemForSale_delete", new { pictureId }, commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## ITokenRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System.Collections.Generic;

namespace AT.AT2017.Api.Repositories
{
    public interface ITokenRepository
    {
        IEnumerable<Token> search(int userID, string userName, int appClientID);
    }
}

```
## ITotalRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System.Collections.Generic;

namespace AT.AT2017.Api.Repositories
{
    public interface ITotalRepository
    {
        IEnumerable<Total> search();
        IEnumerable<Total> searchDeletedRecord(int pageIndex, int pageSize);
        IEnumerable<Total> searchFromMaster();
        IEnumerable<int> searchReportId();
        IEnumerable<int> searchCommissionIndex();
        IEnumerable<PropertyDateType> searchDateTypes(string statuses);
        Total getFromMaster(int id);
        void exportToMaster(int id);
        Total get(int id);
        int add(Total item);
        void update(Total item);
        void delete(int id);
        string translateFormula(string formula, bool reverse);
        bool validateFormula(string formula, string type);
        decimal calculate(int totalID, int personID, int propertyID,int agentTeamID);
    }
}

```
## IUIExceptionLogRepository.cs
```cs
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Repositories
{
    public interface IUIExceptionLogRepository
    {

        void add(UIExceptionLog item);
    }
}

```
## IUIValidationRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Repositories
{
    public interface IUIValidationRepository
    {
        IEnumerable<UIValidation> search(string table);
        IEnumerable<UIValidation> searchByModule(string moduleTable);
        UIValidation get(int id);
        void update(UIValidation item);
    }
}

```
## IUIValidationTableRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IUIValidationTableRepository
    {
        IEnumerable<UIValidationTable> search(); 
    }
}

```
## IUserCompanyRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IUserCompanyRepository
    {
        IEnumerable<UserCompany> search(int companyId, int userId);
        UserCompany get(int id);
        int add(UserCompany item);
        void delete(int id);
    }
}

```
## IUserGLAccountRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IUserGLAccountRepository
    {
        IEnumerable<UserGLAccount> search(int companyId, int userId, int accountId);
        UserGLAccount get(int id);
        int add(UserGLAccount item);
        void delete(int id);
    }

}

```
## IUserOfficeRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IUserOfficeRepository
    {
        IEnumerable<UserOffice> search(int companyId, int userId, int officeId);
        UserOffice get(int id);
        int add(UserOffice item);
        void delete(int id);
    }
}

```
## IUserPhoneRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IUserPhoneRepository
    {
        IEnumerable<UserPhone> search(int userId, int onlyVerified);

        UserPhone get(int id);

        int add(UserPhone item);

        bool verify(int id, string code);

        void update(UserPhone item);

        void updatePhoneName(UserPhone item);

        void updateCode(UserPhone item);

        void delete(int id);
    }
}

```
## IUserRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Repositories
{
    public interface IUserRepository
    {
        IEnumerable<User> search(string fullName, string userName,string email, string corporateName, int companyId, int officeId, int roleId, int pageIndex, int pageSize);
        User get(int id);
        int add(UserCredentials item);
        void update(User item, string oldUserName);
        void updatePassword(UserCredentials item);
        void validateCurrentPassword(UserCredentials item);
        string updatePasswordBulk(string usersCsv, string newPassword);
        IEnumerable<BulkPasswordUpdateLog> bulkPasswordUpdateSearch(string executionGUID, string status);
        void delete(int id);
    }
}

```
## IUserRoleRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IUserRoleRepository
    {
        IEnumerable<UserRole> search(int userId, int roleId);
        IEnumerable<RolePersonType> searchPersonTypes(int userId, int roleId);
        UserRole get(int id);
        int add(UserRole item);
        void delete(int id);
    }
}

```
## IVoucherDetailRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IVoucherDetailRepository
    {
        IEnumerable<VoucherDetail> search(int voucherId, int personId, int agentId, string reimb, bool excludeCommission, int expenseJobId, int pageIndex, int pageSize, bool withTrash);

        IEnumerable<VoucherDetail> divideByBillingGroup(int billingGroupId, int voucherID = 0, decimal amount = 0, int companyID = 0, int? accountID = null, string description = null);
    }
}

```
## IVoucherRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Core.Shared;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IVoucherRepository
    {
        IEnumerable<Voucher> search(int companyId, int personId, int propertyId, int orderTypeId, int personTypeId, string posted, string paid, decimal amount, string fromDate, string toDate, string memo,string isTemplate, string poNumber, int pageIndex, int pageSize, bool withTrash, string ids);
        IEnumerable<Voucher> searchDeletedRecord(int pageIndex, int pageSize);
        IEnumerable<Voucher> searchNoPaids(int companyId,int propertyId, int personId, int voucherId, string poNumber,decimal amount, string fromDate, string toDate, bool isForte, int officeId, int accountId);
        PagedList<Voucher> searchNoPaidsPaginated(int companyId, int propertyId, int personId, int voucherId, string poNumber, decimal amount, string fromDate, string toDate, bool isForte, int officeId, int accountId, int pageIndex, int pageSize, string sortBy, string filterBy);
        int searchVendorPONumber(int voucherId, int companyId, int personId, string poNumber);
        Voucher get(int id);
        int add(Voucher item);
        void update(Voucher item);
        void updateFlag1099(int id, int flag1099, int personId);
        void delete(int id);
        void post(int id);
        void unpost(int id);
        int pay(VoucherPay item);
        void reclassify(Voucher item);
        void updateAsTemplate(Voucher item);
        void updateRecurring(Voucher item);
        IEnumerable<ApPaymentDetail> searchPayments(int voucherId);
        IEnumerable<Voucher> searchTemplates(int companyId);
        int copy(int id);
        int reverse(int id);
        IEnumerable<Voucher> searchVouchersPostingPropertySummary(int propertyId);
    }
}

```
## IVoucherScannedImageRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IVoucherScannedImageRepository
    {
        IEnumerable<VoucherScannedImage> search(int voucherID);
        VoucherScannedImage get(int id);
        int add(VoucherScannedImage item);
        void update(VoucherScannedImage item);
        void delete(int id);
    }
}

```
## IVoucherScannedImageViewHistoryRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public interface IVoucherScannedImageViewHistoryRepository
    {
        IEnumerable<VoucherScannedImage> search(int voucherID);
        int add(int id);
    }
}

```
## IWebhookRepository.cs
```cs
using AT.AT2017.Api.Core.Models;

namespace AT.AT2017.Api.Repositories
{
    public interface IWebhookRepository
    {
        void addPlaidWebhook(PlaidWebhook item);

        void addMxWebhook(MxWebhook item);

        void addTwilioWebhook(TwilioWebhook item);

    }
}

```
## IZipCodeRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Core.Shared;

namespace AT.AT2017.Api.Repositories
{
    public interface IZipCodeRepository
    {
        IEnumerable<ZipCode> search(string state, string city, string county, string country, string zipCode, int pageIndex, int pageSize);
        PagedList<ZipCode> searchPaginated(string state, string city, string county, string country, string zipCode, int pageIndex, int pageSize);
        IEnumerable<ZipCode> states();
        IEnumerable<ZipCode> cities(string city);
        ZipCode get(int id);
        int add(ZipCode item);
        void update(ZipCode item);
        void delete(int id);
    }
}

```
## JobCodeRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using AT.AT2017.Api.Core.Models;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class JobCodeRepository : BaseRepository, IJobCodeRepository
    {
        public JobCodeRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<JobCode> IJobCodeRepository.search(string description, string jobType, int companyId, int officeId, int personId, string active, int pageIndex, int pageSize, int includeTerminated, int includeIntercompany)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<JobCode>("jobcode_search",
                 new
                 {
                     description = description,
                     jobType = jobType,
                     officeId = officeId,
                     personId = personId,
                     active = active,
                     pageIndex = pageIndex,
                     pageSize = pageSize,
                     includeTerminated = includeTerminated,
                     companyId = companyId,
                     includeIntercompany=includeIntercompany
                 },
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }

        JobCode IJobCodeRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<JobCode>("jobcode_get", new { jobId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int IJobCodeRepository.add(JobCode item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("jobcode_add",
                    new
                    {
                        description = item.description,
                        jobType = item.jobType,
                        officeId = item.officeId,
                        personId = item.personId,
                        strJobId = item.strJobId,
                        active = item.active
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IJobCodeRepository.update(JobCode item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("jobcode_update",
                    new
                    {
                        jobId = item.jobId,
                        description = item.description,
                        jobType = item.jobType,
                        officeId = item.officeId,
                        personId = item.personId,
                        strJobId = item.strJobId,
                        active = item.active
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IJobCodeRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("jobcode_delete", new { jobId = id }, commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## JournalRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using AT.AT2017.Api.DynamicParameters;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class JournalRepository : BaseRepository, IJournalRepository
    {
        public JournalRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<Journal> IJournalRepository.search(int companyId, string reference, string posted, string fromDate, string toDate, string isTemplate, int pageIndex, int pageSize, bool withTrash, int officeId, int accountId, int divisionId, decimal amount, string postedDate, int personId, string ids)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<Journal>("journal_search",
                    new
                    {
                        companyId = companyId,
                        reference = reference,
                        posted = posted,
                        isTemplate = isTemplate,
                        fromDate = fromDate,
                        toDate = toDate,
                        pageIndex = pageIndex,
                        pageSize = pageSize,
                        withTrash = withTrash,
                        officeId,
                        accountId,
                        divisionId,
                        amount,
                        postedDate,
                        personId,
                        ids
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<Journal> IJournalRepository.searchDeletedRecord(int pageIndex, int pageSize)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<Journal>("journal_search_deleted",
                    new
                    {
                        pageIndex = pageIndex,
                        pageSize = pageSize
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        Journal IJournalRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                Journal journal = null;
                try
                {
                    using (var multi = connection.QueryMultiple("journal_get", new { journalId = id }, commandType: CommandType.StoredProcedure))
                    {
                        journal = multi.Read<Journal>().Single();
                        journal.detail = multi.Read<JournalDetail>().ToList();
                    }
                }
                catch (Exception ex)
                {
                    if (ex.Message != "Sequence contains no elements")
                        throw ex;
                }

                return journal;
            }
        }

        int IJournalRepository.add(Journal item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                var journalParameter = new JournalDynamicParameter(item);

                int id = connection.ExecuteScalar<int>("journal_add", journalParameter, commandType: CommandType.StoredProcedure, commandTimeout: 0);

                return id;
            }
        }

        int IJournalRepository.reverse(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                id = connection.ExecuteScalar<int>("journal_reverse", new { journalId = id }, commandType: CommandType.StoredProcedure, commandTimeout: 0);

                return id;
            }
        }

        void IJournalRepository.update(Journal item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                var journalParameter = new JournalDynamicParameter(item);

                int id = connection.ExecuteScalar<int>("journal_update", journalParameter, commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }

        void IJournalRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("journal_delete", new { journalId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        void IJournalRepository.post(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("journal_post", new { journalId = id }, commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }

        void IJournalRepository.unpost(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("journal_unpost", new { journalId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        void IJournalRepository.reclassify(Journal item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                var journalParameter = new JournalDynamicParameter(item);
                int Id = connection.ExecuteScalar<int>("journal_reclassify_details", journalParameter, commandType: CommandType.StoredProcedure);
            }
        }

        public IEnumerable<Journal> searchTemplates(int companyId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<Journal>("journal_search_templates",
                    new
                    {
                        companyId = companyId
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        void IJournalRepository.updateAsTemplate(Journal item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("journal_update_asTemplate",
                    new
                    {
                        journalId = item.journalId,
                        isTemplate = item.isTemplate,
                        templateName = item.templateName
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IJournalRepository.updateRecurring(Journal item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("journal_update_recurring",
                    new
                    {
                        journalId = item.journalId,
                        recurring = item.recurring,
                        recurringType = item.recurringType
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IJournalRepository.updateFlag1099(int id, int flag1099)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("journal_update_flag1099", new { journalId = id, flag1099 = @flag1099}, commandType: CommandType.StoredProcedure);
            }
        }
    }
}

```
## JournalScannedImageRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using AT.AT2017.Api.Core.Models;
using Dapper;
using System.Data;
using AT.AT2017.Api.DynamicParameters;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class JournalScannedImageRepository : BaseRepository, IJournalScannedImageRepository
    {
        public JournalScannedImageRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<JournalScannedImage> IJournalScannedImageRepository.search(int journalID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<JournalScannedImage>("journal_scannedImage_search",
                    new
                    {
                        journalID,
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        JournalScannedImage IJournalScannedImageRepository.get(int scannedImageID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirst<JournalScannedImage>("journal_scannedImage_get", 
                    new
                    {
                        scannedImageID
                    }, commandType: CommandType.StoredProcedure);
            }
        }

        int IJournalScannedImageRepository.add(JournalScannedImage item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                item.scannedImageID = connection.ExecuteScalar<int>("journal_scannedImage_add", new {
                    item.journalID,
                    item.driveID,
                    item.fileName,
                    item.description
                }, commandType: CommandType.StoredProcedure, commandTimeout: 0);

                return item.scannedImageID;
            }
        }

        void IJournalScannedImageRepository.delete(int scannedImageID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("journal_scannedImage_delete", new { scannedImageID }, commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }

        void IJournalScannedImageRepository.update(JournalScannedImage item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("journal_scannedImage_update", new
                {
                    item.scannedImageID,
                    item.description
                }, commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }
    }
}

```
## JournalScannedImageViewHistoryRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class JournalScannedImageViewHistoryRepository : BaseRepository, IJournalScannedImageViewHistoryRepository
    {
        public JournalScannedImageViewHistoryRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<JournalScannedImage> IJournalScannedImageViewHistoryRepository.search(int scannedImageID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<JournalScannedImage>("journal_scannedImage_viewHistory_search",
                 new
                 {
                     scannedImageID
                 },
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }

        int IJournalScannedImageViewHistoryRepository.add(int scannedImageID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("journal_scannedImage_viewHistory_add",
                    new
                    {
                        scannedImageID
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

    }
}

```
## LedgerReportRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using AT.AT2017.Api.Core.Model_Report;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class LedgerReportRepository : BaseRepository, ILedgerReportRepository
    {
        public LedgerReportRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<LedgerGLReportInfo> ILedgerReportRepository.searchGL(
            string dateStart, string dateEnd, int officeID, int companyID, string ledgerType,
            int accountID, string transactionID, string code, int pageIndex, int pageSize)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                IEnumerable<LedgerGLReportInfo> ledgerReport = null;

                ledgerReport = connection.Query<LedgerGLReportInfo>("ledger_GL_report_search",
                                    new
                                    {
                                        dateStart,
                                        dateEnd,
                                        transactionID,
                                        code,
                                        companyID,
                                        officeID,
                                        ledgerType = "SUMMARY",
                                        accountID,
                                        pageIndex,
                                        pageSize
                                    },
                                    commandType: CommandType.StoredProcedure,
                                    commandTimeout: 0
                                ).ToList();

                return ledgerReport;
            }
        }

        IEnumerable<LedgerGLDetailReportInfo> ILedgerReportRepository.searchGLDetail(
            string dateStart, string dateEnd, int officeID, int companyID, string ledgerType,
            int accountID, string transactionID, string code, int pageIndex, int pageSize)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                IEnumerable<LedgerGLDetailReportInfo> ledgerReport = null;

                ledgerReport = connection.Query<LedgerGLDetailReportInfo>("ledger_GL_report_search",
                                    new
                                    {
                                        dateStart,
                                        dateEnd,
                                        transactionID,
                                        code,
                                        companyID,
                                        officeID,
                                        ledgerType = "DETAIL",
                                        accountID,
                                        pageIndex,
                                        pageSize
                                    },
                                    commandType: CommandType.StoredProcedure,
                                    commandTimeout: 0
                                ).ToList();

                return ledgerReport;
            }
        }

        IEnumerable<LedgerPLReportInfo> ILedgerReportRepository.searchPL(
            string dateStart, string dateEnd, int officeID, int companyID, string ledgerType,
            int accountID, string transactionID, string code, int pageIndex, int pageSize)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                IEnumerable<LedgerPLReportInfo> ledgerReport = null;

                ledgerReport = connection.Query<LedgerPLReportInfo>("ledger_PL_report_search",
                                    new
                                    {
                                        dateStart,
                                        dateEnd,
                                        transactionID,
                                        code,
                                        companyID,
                                        officeID,
                                        ledgerType = "SUMMARY",
                                        accountID,
                                        pageIndex,
                                        pageSize
                                    },
                                    commandType: CommandType.StoredProcedure,
                                    commandTimeout: 0
                                ).ToList();

                return ledgerReport;
            }
        }

        IEnumerable<LedgerPLDetailReportInfo> ILedgerReportRepository.searchPLDetail(
            string dateStart, string dateEnd, int officeID, int companyID, string ledgerType,
            int accountID, string transactionID, string code, int pageIndex, int pageSize)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                IEnumerable<LedgerPLDetailReportInfo> ledgerReport = null;

                ledgerReport = connection.Query<LedgerPLDetailReportInfo>("ledger_PL_report_search",
                                    new
                                    {
                                        dateStart,
                                        dateEnd,
                                        transactionID,
                                        code,
                                        companyID,
                                        officeID,
                                        ledgerType = "DETAIL",
                                        accountID,
                                        pageIndex,
                                        pageSize
                                    },
                                    commandType: CommandType.StoredProcedure,
                                    commandTimeout: 0
                                ).ToList();

                return ledgerReport;
            }
        }
    }
}

```
## LoginHistoryRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;
using Microsoft.AspNetCore.Hosting;
using AT.AT2017.Api.Core.Shared;

namespace AT.AT2017.Api.Repositories
{
    public class LoginHistoryRepository : BaseRepository, ILoginHistoryRepository
    {
        public LoginHistoryRepository(IHttpContextAccessor httpContextAccessor, IHostingEnvironment env, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, env, appSettings)
        {
        }
        
        IEnumerable<LoginHistory> ILoginHistoryRepository.search(string userName,string loginStartDate, string loginEndDate, string userNameSearch, string email, string ipAddress, string serverName, int pageIndex, int pageSize, string attemptFailed)
        {
            using (SqlConnection connection = new SqlConnection(base.saAdminConnectionString))
            {
                return connection.Query<LoginHistory>("auth_login_history_search",
                 new
                 {
                     userName = userName,
                     loginStartDate = loginStartDate,
                     loginEndDate = loginEndDate,
                     userNameSearch = userNameSearch,
                     email = email,
                     ipAddress = ipAddress,
                     serverName = serverName,
                     pageIndex = pageIndex,
                     pageSize = pageSize,
                     attemptFailed = attemptFailed
                 },
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }

        PagedList<LoginHistory> ILoginHistoryRepository.searchPaginated(string userName, string loginStartDate, string loginEndDate, string email, string ipAddress, string serverName, int pageIndex, int pageSize, string attemptFailed)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                PagedList<LoginHistory> page = null;

                using (var multi = connection.QueryMultiple("login_history_search_paginated",
                    new
                    {
                        userName,
                        loginStartDate,
                        loginEndDate,
                        email,
                        ipAddress,
                        serverName,
                        pageIndex,
                        pageSize,
                        attemptFailed
                    }, commandType: CommandType.StoredProcedure))
                {
                    page = multi.Read<PagedList<LoginHistory>>().Single();
                    page.data = multi.Read<LoginHistory>().ToList();
                }
                return page;
            }
        }

        int ILoginHistoryRepository.add(LoginHistory item)
        {
            using (SqlConnection connection = new SqlConnection(base.saAdminConnectionString))
            {
                int id = connection.ExecuteScalar<int>("auth_login_history_add", new
                {
                    item.userName ,
                    item.ipAddress,
                    accessToken = item.token,
                    item.attemptFailed,
                    item.computerName,
                    item.processorId
                }, commandType: CommandType.StoredProcedure);

                return id;
            }
        }

    }
}

```
## MenuActionRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class MenuActionRepository : BaseRepository, IMenuActionRepository
    {
        public MenuActionRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<MenuAction> IMenuActionRepository.search(int menuId, string name)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<MenuAction>("menu_action_search",
                new
                {
                    menuId = menuId,
                    name = name
                },
                commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<MenuAction> IMenuActionRepository.searchNotInPackage()
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<MenuAction>("menu_action_search_not_in_package", null, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<MenuAction> IMenuActionRepository.searchScreens()
        {
            using (SqlConnection connection = new SqlConnection(base.adminConnectionString))
            {
                return connection.Query<MenuAction>("menu_action_search_screens", null, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        MenuAction IMenuActionRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<MenuAction>("menu_action_get", new { actionId = id }, commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## MenuRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class MenuRepository : BaseRepository, IMenuRepository
    {
        public MenuRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<Menu> IMenuRepository.search(string name)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<Menu>("menu_search",
                new
                {
                    name = name
                },
                commandType: CommandType.StoredProcedure).ToList();
            }
        }

        Menu IMenuRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<Menu>("menu_get", new { menuId = id }, commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## MigrationLogDetailRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class MigrationLogDetailRepository : BaseRepository, IMigrationLogDetailRepository
    {
        public MigrationLogDetailRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<MigrationLogDetail> IMigrationLogDetailRepository.search(int submitID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<MigrationLogDetail>("migration_log_detail_search",
                new
                {
                    submitID = submitID
                },
                commandType: CommandType.StoredProcedure).ToList();
            }
        }
       
    }
}

```
## MigrationLogRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class MigrationLogRepository : BaseRepository, IMigrationLogRepository
    {
         public MigrationLogRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<MigrationLog> IMigrationLogRepository.search(int submitID, string corporateName)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<MigrationLog>("migration_log_search",
                new
                {
                    submitID = submitID,
                    corporateName = corporateName
                },
                commandType: CommandType.StoredProcedure).ToList();
            }
        }

        MigrationLog IMigrationLogRepository.get(int migrationLogID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                MigrationLog migrationLog = null;
                try
                {
                    using (var multi = connection.QueryMultiple("migration_log_get", new { migrationLogID = migrationLogID }, commandType: CommandType.StoredProcedure))
                    {
                        migrationLog = multi.Read<MigrationLog>().Single();
                        migrationLog.detail = multi.Read<MigrationLogDetail>().ToList();
                    }
                }
                catch (Exception ex)
                {
                    if (ex.Message != "Sequence contains no elements")
                        throw ex;
                }

                return migrationLog;
            }
        }
    }
}

```
## MigrationRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using Microsoft.AspNetCore.Mvc;
using System.Data.SqlClient;
using Microsoft.AspNetCore.Hosting;

namespace AT.AT2017.Api.Repositories
{
    public class MigrationRepository : BaseRepository, IMigrationRepository
    {

        private IHostingEnvironment _env;

        public MigrationRepository(IHttpContextAccessor httpContextAccessor, IHostingEnvironment env, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, env, appSettings)
        {
            _env = env;
        }

        private SqlConnection getMasterConnection(string newServer)
        {

            string cnnString = string.Format("Server={0};Database=master;User Id={1};Password={2};Max Pool Size=1024;Pooling=true;Application Name=AT2017;", newServer, _appSettings.AdminUser, _appSettings.AdminPassword);

            return new SqlConnection(cnnString);
        }

        private SqlConnection getDarwinMasterConnection()
        {

            string cnnString = string.Format("Server={0};Database=AT2017_MASTER;User Id={1};Password={2};Max Pool Size=1024;Pooling=true;Application Name=AT2017;", _appSettings.AdminServer, _appSettings.AdminUser, _appSettings.AdminPassword);
            
            return new SqlConnection(cnnString);
        }

        private SqlConnection getMigrateConnection(string newServer, string newDatabase)
        {
            string cnnString = string.Format("Server={0};Database={1};User Id={2};Password={3};Max Pool Size=1024;Pooling=true;Application Name=AT2017;", newServer, newDatabase, _appSettings.AdminUser, _appSettings.AdminPassword);
            
            return new SqlConnection(cnnString);
        }

        Company IMigrationRepository.getCompany(string newServer, string newDatabase, string sourceDatabase)
        {
            using (SqlConnection connection = this.getMigrateConnection(newServer, newDatabase))
            {
                return connection.QueryFirstOrDefault<Company>("dataTransfer_get_company",
                new
                {
                    sourceDatabase = sourceDatabase
                },
                commandType: CommandType.StoredProcedure);
            }
        }

        IEnumerable<Server> IMigrationRepository.searchServers(bool includeOldServers, bool includeNewServers)
        {
            using (SqlConnection adminConnection = new SqlConnection(base.adminConnectionString))
            {
                return adminConnection.Query<Server>("migration_server_search",
                    new
                    {
                        includeOldServers = includeOldServers,
                        includeNewServers = includeNewServers
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<Database> IMigrationRepository.searchDatabases(string server, string type)
        {
            using (SqlConnection adminConnection = new SqlConnection(base.adminConnectionString))
            {
                return adminConnection.Query<Database>("migration_server_database_search",
                    new
                    {
                        server = server,
                        type = type
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<MigrationError> IMigrationRepository.validate(string sourceDatabase, bool appendDatabase)
        {
            using (SqlConnection connection = this.getDarwinMasterConnection())
            {
                return connection.Query<MigrationError>("dataTransfer_validate",
                    new
                    {
                        dbSourceName = sourceDatabase,
                        appendDatabase = appendDatabase
                    },
                commandType: CommandType.StoredProcedure).ToList();
            }
        }

        void IMigrationRepository.createDatabase(string newServer, string newDatabase, bool force)
        {
            using (SqlConnection connection = this.getMasterConnection(newServer))
            {
                connection.Execute("migration_create_database",
                    new
                    {
                        newDatabase = newDatabase,
                        force = force
                    },
                    commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }

        void IMigrationRepository.backupNewDatabase(string newServer, string newDatabase)
        {
            using (SqlConnection connection = this.getMasterConnection(newServer))
            {
                connection.Execute("migration_create_backup",
                    new
                    {
                        newDatabaseName = newDatabase
                    },
                    commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }

        void IMigrationRepository.restoreNewDatabase(string newServer, string newDatabase)
        {
            using (SqlConnection connection = this.getMasterConnection(newServer))
            {
                connection.Execute("migration_restore_newdatabase",
                   new
                   {
                       newDatabaseName = newDatabase
                   },
                   commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }

        void IMigrationRepository.backupOldDatabase(string sourceServer, string sourceDatabase)
        {
            using (SqlConnection adminConnection = new SqlConnection(base.saAdminConnectionString))
            {
                adminConnection.Execute("migration_create_backup_olddatabase",
                    new
                    {
                        oldServerName = sourceServer,
                        oldDatabaseName = sourceDatabase
                    },
                    commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }

        void IMigrationRepository.restoreOldDatabase(string newServer, string sourceDatabase)
        {
            using (SqlConnection connection = this.getMasterConnection(newServer))
            {
                connection.Execute("migration_restore_olddatabase",
                    new
                    {
                        oldDatabaseName = sourceDatabase
                    },
                    commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }

        void IMigrationRepository.backupMasterDatabase()
        {
            string adminServer = _appSettings.AdminServer;
            using (SqlConnection connection = this.getMasterConnection(adminServer))
            {
                connection.Execute("migration_create_backup",
                    new
                    {
                        newDatabaseName = "AT2017_MASTER"
                    },
                    commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }

        void IMigrationRepository.enableTriggers(string newServer, string newDatabase)
        {
            using (SqlConnection migrateConnection = this.getMigrateConnection(newServer, newDatabase))
            {
                migrateConnection.Execute("dataTransfer_alltriggers_enable", commandType: CommandType.StoredProcedure);
            }
        }

        void IMigrationRepository.disableTriggers(string newServer, string newDatabase)
        {
            using (SqlConnection migrateConnection = this.getMigrateConnection(newServer, newDatabase))
            {
                migrateConnection.Execute("dataTransfer_alltriggers_disable", commandType: CommandType.StoredProcedure);
            }
        }

        IEnumerable<TableStatus> IMigrationRepository.cleanUpSection(string newServer, string newDatabase, string section, bool showTableStatus)
        {
            using (SqlConnection connection = this.getMigrateConnection(newServer, newDatabase))
            {
                return connection.Query<TableStatus>("dataTransfer_cleanup",
                    new
                    {
                        section = section,
                        showTableStatus = showTableStatus
                    },
                    commandType: CommandType.StoredProcedure, commandTimeout: 0).ToList();
            }
        }

        void IMigrationRepository.transferTable(string newServer, string newDatabase, string sourceDatabase, string sectionName, string tableName, bool goLive, string brandCode)
        {
            using (SqlConnection connection = this.getMigrateConnection(newServer, newDatabase))
            {
                if (sectionName != "transactionplan")
                {
                    connection.Execute("dataTransfer",
                    new
                    {
                        sourceDatabase = sourceDatabase,
                        tableName = tableName,
                        goLive = goLive,
                        brandCode = brandCode
                    },
                    commandType: CommandType.StoredProcedure, commandTimeout: 0);
                }
                else
                {
                    connection.Execute("dataTransfer_TP",
                    new
                    {
                        dbSourceName = sourceDatabase,
                        tableName = tableName
                    },
                    commandType: CommandType.StoredProcedure, commandTimeout: 0);
                }
            }
        }

        IEnumerable<MigrationTable> IMigrationRepository.searchTables(string newServer, string newDatabase, string section)
        {
            using (SqlConnection connection = this.getMigrateConnection(newServer, newDatabase))
            {
                return connection.Query<MigrationTable>("dataTransfer_search_tablestotransfer",
                    new
                    {
                        section = section
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        void IMigrationRepository.fixData(string newServer, string newDatabase, string sourceDatabase, bool addCompany, bool goLive)
        {
            using (SqlConnection connection = this.getMigrateConnection(newServer, newDatabase))
            {
                connection.Execute("dataTransfer_fixdata",
                    new
                    {
                        sourceDatabase = sourceDatabase,
                        addCompany = addCompany,
                        goLive = goLive
                    },
                    commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }

        IEnumerable<TableStatus> IMigrationRepository.searchTableStatus(string newServer, string newDatabase)
        {
            using (SqlConnection connection = this.getMigrateConnection(newServer, newDatabase))
            {
                return connection.Query<TableStatus>("dataTransfer_tablestatus", null, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<ComparisonInfo> IMigrationRepository.searchComparisonInfo(string newServer, string newDatabase,string sourceDatabase)
        {
            using (SqlConnection connection = this.getMigrateConnection(newServer, newDatabase))
            {
                return connection.Query<ComparisonInfo>("dataTransfer_comparison",
                    new
                    {
                        dbSourceName = sourceDatabase
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        void IMigrationRepository.preserveTables(string newServer, string newDatabase)
        {
            using (SqlConnection connection = this.getMigrateConnection(newServer, newDatabase))
            {
                connection.Execute("dataTransfer_preserve_data", null, commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }

        void IMigrationRepository.syncGlobalTables(string newServer, string newDatabase)
        {
            using (SqlConnection connection = this.getMigrateConnection(newServer, newDatabase))
            {
                connection.Execute("dataTransfer_sync_globaltables", null, commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }

        IEnumerable<GLAccountSetting> IMigrationRepository.searchAccountColumns(string newServer, string newDatabase, int companyID)
        {
            using (SqlConnection connection = this.getMigrateConnection(newServer, newDatabase))
            {
                return connection.Query<GLAccountSetting>("glaccount_setting_search_columns",
                    new
                    {
                        companyID = companyID
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<GLAccountSetting> IMigrationRepository.searchAllowedAccounts(string newServer, string newDatabase, int companyID)
        {
            using (SqlConnection connection = this.getMigrateConnection(newServer, newDatabase))
            {
                return connection.Query<GLAccountSetting>("glaccount_setting_search_allowed_accounts",
                   new
                   {
                       companyID = companyID,
                       isMigration = 1
                   },
                   commandType: CommandType.StoredProcedure).ToList();
            }

        }

        void IMigrationRepository.updateAccountSettings(string newServer, string newDatabase, GLAccountSetting item)
        {
            using (SqlConnection connection = this.getMigrateConnection(newServer, newDatabase))
            {
                int id = connection.ExecuteScalar<int>("glaccount_setting_update",
                    new
                    {
                        accountSettingID = item.accountSettingID,
                        checkingAccountID = item.checkingAccountID,
                        savingsAccountID = item.savingsAccountID,
                        depositAccountID = item.depositAccountID,
                        commissionAccountID = item.commissionAccountID,
                        payrollAccountID = item.payrollAccountID,
                        undepositedAccountID = item.undepositedAccountID,
                        billPayWashAccountID = item.billPayWashAccountID,
                        thirdPaymentWashAccountID = item.thirdPaymentWashAccountID,
                        arPaymentAccountID = item.arPaymentAccountID,
                        apPaymentAccountID = item.apPaymentAccountID,
                        escrowLiabilityAccountID = item.escrowLiabilityAccountID,
                        agentExpenseAccountID = item.agentExpenseAccountID,
                        bankAccountID = item.bankAccountID,
                        coBrokeIncomeAccountID = item.coBrokeIncomeAccountID,
                        referralIncomeAccountID = item.referralIncomeAccountID,
                        coBrokeCostOfSaleAccountID = item.coBrokeCostOfSaleAccountID,
                        referralCostOfSaleAccountID = item.referralCostOfSaleAccountID,
                        trans1AccountID = item.trans1AccountID,
                        trans2AccountID = item.trans2AccountID,
                        miscOtherIncomeAccountID = item.miscOtherIncomeAccountID,
                        miscOtherExpenseAccountID = item.miscOtherExpenseAccountID
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## ModelDictionaryRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using System.Data;
using Dapper;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class ModelDictionaryRepository : BaseRepository, IModelDictionaryRepository
    {
        public ModelDictionaryRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<ModelDictionary> IModelDictionaryRepository.search()
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<ModelDictionary>("modeldictionary_search", null, commandType: CommandType.StoredProcedure).ToList();
            }
        }
    }
}

```
## ModuleRepository.cs
```cs
using System.Collections.Generic;
using System.Linq;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;
using Microsoft.AspNetCore.Hosting;

namespace AT.AT2017.Api.Repositories
{
    public class ModuleRepository : BaseRepository, IModuleRepository
    {

        public ModuleRepository(IHttpContextAccessor httpContextAccessor, IHostingEnvironment env, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, env,appSettings)
        {
        }

        IEnumerable<ModuleErrorCode> IModuleRepository.search(int systemID, int moduleID)
        {
            using (SqlConnection adminConnection = new SqlConnection(base.adminConnectionString))
            {
                return adminConnection.Query<ModuleErrorCode>("module_search", new { systemID = systemID, moduleID = moduleID }, commandType: CommandType.StoredProcedure).ToList();
            }
        }

    }
}

```
## MxRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Data;
using System.Data.SqlClient;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Dapper;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;

namespace AT.AT2017.Api.Repositories
{
    public class MxRepository : BaseRepository, IMxRepository
    {

        public MxRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<MxConnectLog> IMxRepository.searchConnectLog()
        {
            using (SqlConnection Connection = new SqlConnection(base.connectionString))
            {
                return Connection.Query<MxConnectLog>("mx_connect_log_search", null, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        void IMxRepository.addConnectLog(MxConnectLog item)
        {
            try
            {
                using (SqlConnection connection = new SqlConnection(base.connectionString))
                {
                    connection.ExecuteScalar<int>("mx_connect_log_add",
                        new
                        {
                            item.current_event,
                            item.previous_event,
                            item.user_guid,
                            item.session_guid,
                            item.member_guid,
                            item.institution_name,
                            item.institution_code
                        },
                        commandType: CommandType.StoredProcedure);
                }
            }
            catch (Exception)
            {
            }
        }

    }
}

```
## MxUserRepository.cs
```cs
using System;
using System.Data;
using System.Data.SqlClient;
using AT.AT2017.Api.Core.Models;
using Dapper;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;

namespace AT.AT2017.Api.Repositories
{
    public class MxUserRepository : BaseRepository, IMxUserRepository
    {

        public MxUserRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        MxUser IMxUserRepository.firstOrCreate(string dbName)
        {
            using (SqlConnection connection = new SqlConnection(base.adminConnectionString))
            {
                return connection.QueryFirstOrDefault<MxUser>("mxuser_get_first_or_create",
                    new
                    {
                        dbName
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IMxUserRepository.update(MxUser item)
        {

            using (SqlConnection connection = new SqlConnection(base.adminConnectionString))
            {
                int id = connection.ExecuteScalar<int>("mxuser_update",
                    new
                    {
                        item.userID,
                        item.guid,
                        item.email,
                        item.is_disabled,
                        item.metadata
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }
    }
}

```
## NotificationRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class NotificationRepository : BaseRepository, INotificationRepository
    {
        public NotificationRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        EmailLog INotificationRepository.getLastEmailLog(string token)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<EmailLog>("emailLog_get_notification", 
                    new
                    {
                        token
                    }, commandType: CommandType.StoredProcedure);
            }
        }
    }
}

```
## NotificationScheduleRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class NotificationScheduleRepository : BaseRepository, INotificationScheduleRepository
    {
        public NotificationScheduleRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }
       
        NotificationSchedule INotificationScheduleRepository.search(int settingId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<NotificationSchedule>("NotificationSchedule_search", new { settingId = settingId }, commandType: CommandType.StoredProcedure);
            }
        }

        NotificationSchedule INotificationScheduleRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<NotificationSchedule>("NotificationSchedule_get", new { scheduleId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int INotificationScheduleRepository.add(NotificationSchedule item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("NotificationSchedule_add",
                    new
                    { name = item.name,
                        notificationSettingID = item.notificationSettingID,
                        frequency = item.frequency,
                        dayOfWeek = item.dayOfWeek,
                        startIn = item.startIn,
                        nDays = item.nDays,
                        time = item.time,
                        active = item.active
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void INotificationScheduleRepository.update(NotificationSchedule item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("NotificationSchedule_update",
                     new
                     {
                         scheduleID = item.scheduleID,
                         name = item.name,
                         notificationSettingID = item.notificationSettingID,
                         frequency = item.frequency,
                         dayOfWeek = item.dayOfWeek,
                         startIn = item.startIn,
                         nDays = item.nDays,
                         time = item.time,
                         active = item.active
                     },
                     commandType: CommandType.StoredProcedure);
            }
        }

        void INotificationScheduleRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("NotificationSchedule_delete", new { scheduleID = id }, commandType: CommandType.StoredProcedure);
            }
        }
    }
}

```
## NotificationSettingRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class NotificationSettingRepository : BaseRepository, INotificationSettingRepository
    {
        public NotificationSettingRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<NotificationSetting> INotificationSettingRepository.search()
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<NotificationSetting>("notificationSetting_search", null, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        NotificationSetting INotificationSettingRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<NotificationSetting>("notificationSetting_get", new { notificationSettingId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        void INotificationSettingRepository.update(NotificationSetting item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("notificationSetting_update",
                    new
                    {
                        item.notificationSettingId,
                        item.displayName,
                        item.section,
                        item.active,
                        item.subject,
                        item.template,
                        item.filterByCompany,
                        item.filterByOffice,
                        item.sendBySMS,
                        item.sendByEmail,
                        item.textSMS 
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }
    }
}

```
## OfficeFormRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class OfficeFormRepository : BaseRepository, IOfficeFormRepository
    {
        public OfficeFormRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<OfficeForm> IOfficeFormRepository.search()
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<OfficeForm>("officeForm_search",
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }

        OfficeForm IOfficeFormRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<OfficeForm>("officeForm_get", new { formID = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int IOfficeFormRepository.add(OfficeForm item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("officeForm_add",
                    new
                    {
                        item.fileName,
                        item.description,
                        item.url,
                        item.formCategoryID
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IOfficeFormRepository.update(OfficeForm item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("officeForm_update",
                    new
                    {
                        item.formID,
                        item.fileName,
                        item.description,
                        item.url,
                        item.formCategoryID
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IOfficeFormRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("officeForm_delete", new { formID = id }, commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## OfficeGoalReportRepository.cs
```cs
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class OfficeGoalReportRepository : BaseRepository, IOfficeGoalReportRepository
    {

        public OfficeGoalReportRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        DataTable IOfficeGoalReportRepository.search()
        {
            DataTable dt = new DataTable();

            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                SqlCommand command = new SqlCommand("officeGoals_report", connection);
                command.CommandType = CommandType.StoredProcedure;
                command.CommandTimeout = 0;

                connection.Open();
                SqlDataReader reader = command.ExecuteReader();
                dt.Load(reader);
                reader.Close();
            }
            return dt;
        }
    }
}

```
## OfficeMlsRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using AT.AT2017.Api.Core.Models;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class OfficeMlsRepository : BaseRepository, IOfficeMlsRepository
    {
        public OfficeMlsRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        int IOfficeMlsRepository.add(OfficeMLS item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("office_mlsID_add",
                    new
                    {
                        officeId = item.officeId,
                        mlsID = item.mlsID,
                        feedSubTypeId = item.feedSubTypeId
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IOfficeMlsRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("office_mlsID_delete", new { officeMlsID = id }, commandType: CommandType.StoredProcedure);
            }
        }

        OfficeMLS IOfficeMlsRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<OfficeMLS>("office_mlsID_get", new { officeMlsID = id }, commandType: CommandType.StoredProcedure);
            }
        }

        IEnumerable<OfficeMLS> IOfficeMlsRepository.search(int officeId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<OfficeMLS>("office_mlsID_search",
                 new
                 {
                     officeId = officeId
                 },
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }

        void IOfficeMlsRepository.update(OfficeMLS item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("office_mlsID_update",
                    new
                    {
                        officeMlsID = item.officeMlsID,
                        officeId = item.officeId,
                        mlsID = item.mlsID,
                        feedSubTypeId = item.feedSubTypeId
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }
    }
}

```
## OfficeReportRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using AT.AT2017.Api.Core.Model_Report;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class OfficeReportRepository : BaseRepository, IOfficeReportRepository
    {
        public OfficeReportRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<OfficeReport> IOfficeReportRepository.search(int id, string crestCode, int companyId, int showDeleted, int dateType, string dateStart, string dateEnd, int pageIndex, int pageSize)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<OfficeReport>("office_report", new { id, crestCode, companyId, dateType, dateStart, dateEnd, showDeleted, pageIndex, pageSize }, commandType: CommandType.StoredProcedure).ToList();
            }
        }
    }
}

```
## OfficeRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using AT.AT2017.Api.Core.Models;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class OfficeRepository : BaseRepository, IOfficeRepository
    {
        public OfficeRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<Office> IOfficeRepository.search(int companyId, string officeName, bool withTrash, bool applySecurity)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<Office>("office_search",
                 new
                 {
                     companyId = companyId,
                     officeName = officeName,
                     withTrash = withTrash,
                     applySecurity = applySecurity,
                 },
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<Office> IOfficeRepository.searchDeletedRecord(int pageIndex, int pageSize)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<Office>("office_search_deleted",
                    new
                    {
                        pageIndex = pageIndex,
                        pageSize = pageSize
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        Office IOfficeRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<Office>("office_get", new { officeId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        Office IOfficeRepository.office_getbynameormlsid(string desc)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<Office>("office_getByNameOrMLSID", new { description = desc }, commandType: CommandType.StoredProcedure);
            }
        }
        int IOfficeRepository.add(Office item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("office_add",
                    new
                    {
                        officeName = item.officeName,
                        crestCode = item.crestCode,
                        jobId = item.jobId,
                        miscJobId = item.miscJobID,
                        emailAddress = item.emailAddress,
                        webSiteUrl = item.webSiteURL,
                        phoneNumber = item.phoneNumber,
                        faxNumber = item.faxNumber,
                        streetAddress = item.streetAddress,
                        city = item.city,
                        state = item.state,
                        zip = item.zip,
                        mlsId = item.mlsId,
                        squareFootage=item.squareFootage,
                        canDoCommercialBusiness = item.canDoCommercialBusiness,
                        companyId = item.companyId,
                        item.openDate,
                        item.terminatedDate,
                        item.marketSizeId,
                        item.usaRegionId,
                        item.typeId,
                        item.excludeBenchmarking 
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IOfficeRepository.update(Office item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("office_update",
                    new
                    {
                        officeId = item.officeId,
                        officeName = item.officeName,
                        crestCode = item.crestCode,
                        officeGUID = item.officeGUID,
                        jobId = item.jobId,
                        miscJobId = item.miscJobID,
                        emailAddress = item.emailAddress,
                        webSiteUrl = item.webSiteURL,
                        phoneNumber = item.phoneNumber,
                        faxNumber = item.faxNumber,
                        streetAddress = item.streetAddress,
                        city = item.city,
                        state = item.state,
                        zip = item.zip,
                        mlsId = item.mlsId,
                        squareFootage = item.squareFootage,
                        canDoCommercialBusiness = item.canDoCommercialBusiness,
                        item.openDate,
                        item.terminatedDate,
                        item.marketSizeId,
                        item.usaRegionId,
                        item.typeId,
                        item.excludeBenchmarking 
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IOfficeRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("office_delete", new { officeId = id }, commandType: CommandType.StoredProcedure);
            }
        }
    }
}

```
## PackageRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Data;
using System.Data.SqlClient;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.DynamicParameters;
using Dapper;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;

namespace AT.AT2017.Api.Repositories
{
    public class PackageRepository : BaseRepository, IPackageRepository
    {
        public PackageRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<Package> IPackageRepository.search(string name)
        {
            using (SqlConnection connection = new SqlConnection(base.adminConnectionString))
            {
                return connection.Query<Package>("package_search",
                 new
                 {
                     name
                 },
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<MenuAction> IPackageRepository.searchActions(string name)
        {
            using (SqlConnection connection = new SqlConnection(base.adminConnectionString))
            {
                return connection.Query<MenuAction>("package_search_actions",
                 new
                 {
                     name
                 },
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<Report> IPackageRepository.searchReports(string name)
        {
            using (SqlConnection connection = new SqlConnection(base.adminConnectionString))
            {
                return connection.Query<Report>("package_search_reports",
                 new
                 {
                     name
                 },
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }

        Package IPackageRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.adminConnectionString))
            {
                Package item = null;

                try
                {
                    using (var multi = connection.QueryMultiple("package_get", new { packageID = id }, commandType: CommandType.StoredProcedure))
                    {
                        item = multi.Read<Package>().Single();
                        item.actions = multi.Read<PackageAction>().ToList();
                        item.reports = multi.Read<PackageReport>().ToList();
                        item.prices = multi.Read<PackagePrice>().ToList();
                        item.controls = multi.Read<CustomControl>().ToList();
                    }
                }
                catch (Exception ex)
                {
                    if (ex.Message != "Sequence contains no elements")
                        throw ex;
                }
                return item;
            }
        }

        int IPackageRepository.add(Package item)
        {
            using (SqlConnection connection = new SqlConnection(base.adminConnectionString))
            {
                var packageParameter = new PackageDynamicParameter(item);

                int id = connection.ExecuteScalar<int>("package_add", packageParameter, commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IPackageRepository.update(Package item)
        {
            using (SqlConnection connection = new SqlConnection(base.adminConnectionString))
            {
                var packageParameter = new PackageDynamicParameter(item);

                int id = connection.ExecuteScalar<int>("package_update", packageParameter, commandType: CommandType.StoredProcedure);
            }
        }

        void IPackageRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.adminConnectionString))
            {
                connection.ExecuteScalar<int>("package_delete", new { packageID = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int IPackageRepository.copy(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.adminConnectionString))
            {
                id = connection.ExecuteScalar<int>("package_copy", new { packageID = id }, commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IPackageRepository.restoreDefaults(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.adminConnectionString))
            {
                connection.ExecuteScalar<int>("package_action_restore_defaults", new { packageID = id }, commandType: CommandType.StoredProcedure);
            }
        }
    }
}

```
## PersonAddressRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class PersonAddressRepository : BaseRepository, IPersonAddressRepository
    {
        public PersonAddressRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<PersonAddress> IPersonAddressRepository.search(int personId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<PersonAddress>("person_address_search", new { personId = personId },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        PersonAddress IPersonAddressRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
               return connection.QueryFirstOrDefault<PersonAddress>("person_address_get", new { addressId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int IPersonAddressRepository.add(PersonAddress item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("person_address_add",
                    new
                    {
                        personId = item.personId,
                        addressTypeId = item.addressTypeId,
                        nextAddress = item.nextAddress,
                        streetNumber = item.streetNumber,
                        streetDirection = item.streetDirection,
                        streetName = item.streetName,
                        streetDesignation = item.streetDesignation,
                        streetSuffix = item.streetSuffix,
                        suiteAptNumber = item.suiteAptNumber,
                        buildingFloorNumber = item.buildingFloorNumber,
                        city = item.city,
                        state = item.state,
                        zip = item.zip,
                        country = item.country,
                        ATTN=item.ATTN 
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IPersonAddressRepository.update(PersonAddress item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("person_address_update",
                    new
                    {
                        addressId = item.addressId,
                        personId = item.personId,
                        addressTypeId = item.addressTypeId,
                        nextAddress = item.nextAddress,
                        streetNumber = item.streetNumber,
                        streetDirection = item.streetDirection,
                        streetName = item.streetName,
                        streetDesignation = item.streetDesignation,
                        streetSuffix = item.streetSuffix,
                        suiteAptNumber = item.suiteAptNumber,
                        buildingFloorNumber = item.buildingFloorNumber,
                        city = item.city,
                        state = item.state,
                        zip = item.zip,
                        country = item.country,
                        ATTN = item.ATTN
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IPersonAddressRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("person_address_delete", new { addressId = id }, commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## PersonAreaOfSpecializationRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Data;
using System.Data.SqlClient;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Dapper;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;

namespace AT.AT2017.Api.Repositories
{
    public class PersonAreaOfSpecializationRepository : BaseRepository, IPersonAreaOfSpecializationRepository
    {
        public PersonAreaOfSpecializationRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<PersonAreaOfSpecialization> IPersonAreaOfSpecializationRepository.search(int personId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<PersonAreaOfSpecialization>("person_areaofspecialization_search",
                 new
                 {
                     personId = personId
                 },
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }

        PersonAreaOfSpecialization IPersonAreaOfSpecializationRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<PersonAreaOfSpecialization>("person_areaofspecialization_get", new { personAreaOfSpecializationId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int IPersonAreaOfSpecializationRepository.add(PersonAreaOfSpecialization item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("person_areaofspecialization_add",
                   new
                   {
                        item.personId,
                        item.areaOfSpecializationId
                   },
                   commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IPersonAreaOfSpecializationRepository.update(PersonAreaOfSpecialization item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("person_areaofspecialization_update",
                     new
                     {
                         item.personAreaOfSpecializationId,
                         item.personId,
                         item.areaOfSpecializationId
                     },
                     commandType: CommandType.StoredProcedure);
            }
        }

        void IPersonAreaOfSpecializationRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("person_areaofspecialization_delete", new { personAreaOfSpecializationId = id }, commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## PersonBillingDetailRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using AT.AT2017.Api.DynamicParameters;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class PersonBillingDetailRepository : BaseRepository, IPersonBillingDetailRepository
    {
        public PersonBillingDetailRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<PersonBillingDetail> IPersonBillingDetailRepository.search(int personId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<PersonBillingDetail>("person_billingdetail_search",
                    new
                    {
                        personId = personId
                    }, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        PersonBillingDetail IPersonBillingDetailRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<PersonBillingDetail>("person_billingdetail_get", new { personBillingDetailId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int IPersonBillingDetailRepository.add(PersonBillingDetail item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("person_billingdetail_add",
                    new
                    {
                        personId = item.personId,
                        billingItemId = item.billingItemId,
                        description = item.description,
                        accountId = item.accountId,
                        amount = item.amount,
                        sortOrder = item.sortOrder,
                        include = item.include

                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IPersonBillingDetailRepository.update(PersonBillingDetail item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("person_billingdetail_update",
                    new
                    {
                        personBillingDetailId = item.personBillingDetailId,
                        personId = item.personId,
                        billingItemId = item.billingItemId,
                        description = item.description,
                        accountId = item.accountId,
                        amount = item.amount,
                        sortOrder = item.sortOrder,
                        include = item.include

                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IPersonBillingDetailRepository.updateList(int personID, string saveOption, List<PersonBillingDetail> detail)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                var personBillingDetailParameter = new PersonBillingDetailDynamicParameter(personID, saveOption,detail);

                int id = connection.ExecuteScalar<int>("person_billingdetail_update_list", personBillingDetailParameter, commandType: CommandType.StoredProcedure);
            }
        }

        void IPersonBillingDetailRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("person_billingdetail_delete", new { personBillingDetailId = id }, commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## PersonCustomFieldRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class PersonCustomFieldRepository : BaseRepository, IPersonCustomFieldRepository
    {
        public PersonCustomFieldRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<PersonCustomField> IPersonCustomFieldRepository.search(int personId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<PersonCustomField>("person_customField_search", new { personId = personId }, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        int IPersonCustomFieldRepository.add(PersonCustomField item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("person_customField_add",
                    new
                    {
                        personId = item.personId,
                        fieldId = item.fieldId,
                        fieldValue = item.fieldValue
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IPersonCustomFieldRepository.update(PersonCustomField item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("person_customField_update",
                    new
                    {
                        customFieldId = item.customFieldId,
                        fieldValue = item.fieldValue
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IPersonCustomFieldRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("person_customField_delete", new { customFieldId = id }, commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## PersonDeductionRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class PersonDeductionRepository : BaseRepository, IPersonDeductionRepository
    {
        public PersonDeductionRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<PersonDeduction> IPersonDeductionRepository.search(int personId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<PersonDeduction>("person_deduction_search",
                  new
                  {
                      personId = personId
                  },
                  commandType: CommandType.StoredProcedure).ToList();
            }
        }

        PersonDeduction IPersonDeductionRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<PersonDeduction>("person_deduction_get", new { personDeductionId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        decimal IPersonDeductionRepository.getScalePercent(int id, int propertyId,string side)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                decimal percent = connection.ExecuteScalar<decimal>("person_deduction_get_currentLevel",new {personID = id, propertyID = propertyId, side = side },commandType: CommandType.StoredProcedure,commandTimeout: 0);
                return percent;
            }
        }

        int IPersonDeductionRepository.add(PersonDeduction item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("person_deduction_add",
                    new
                    {
                        personId = item.personId,
                        deductionId = item.deductionId,
                        amount = item.amount,
                        amountCAP = item.amountCAP,
                        percentage = item.percentage,
                        maxAmount = item.maxAmount,
                        maxPercentage = item.maxPercentage,
                        percentageTerminatedDate=item.percentageTerminatedDate
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IPersonDeductionRepository.update(PersonDeduction item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("person_deduction_update",
                    new
                    {
                        personDeductionId = item.personDeductionId,
                        personId = item.personId,
                        deductionId = item.deductionId,
                        amount = item.amount,
                        amountCAP = item.amountCAP,
                        percentage = item.percentage,
                        maxAmount = item.maxAmount,
                        maxPercentage = item.maxPercentage,
                        percentageTerminatedDate = item.percentageTerminatedDate
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IPersonDeductionRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("person_deduction_delete", new { personDeductionId = id }, commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## PersonDesignationRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class PersonDesignationRepository : BaseRepository, IPersonDesignationRepository
    {
        public PersonDesignationRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<PersonDesignation> IPersonDesignationRepository.search(int personId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<PersonDesignation>("person_designation_search",
                 new
                 {
                     personId = personId
                 },
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }

        PersonDesignation IPersonDesignationRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<PersonDesignation>("person_designation_get", new { personDesignationId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int IPersonDesignationRepository.add(PersonDesignation item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("person_designation_add",
                   new
                   {
                       personId = item.personId,
                       designationId = item.designationId
                   },
                   commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IPersonDesignationRepository.update(PersonDesignation item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("person_designation_update",
                     new
                     {
                         personDesignationId = item.personDesignationId,
                         personId = item.personId,
                         designationId = item.designationId
                     },
                     commandType: CommandType.StoredProcedure);
            }
        }

        void IPersonDesignationRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("person_designation_delete", new { personDesignationId = id }, commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## PersonDocumentRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class PersonDocumentRepository : BaseRepository, IPersonDocumentRepository
    {
        public PersonDocumentRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<PersonDocument> IPersonDocumentRepository.search(int personID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<PersonDocument>("PersonDocument_search",
                 new
                 {
                     personID
                 },
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }

        PersonDocument IPersonDocumentRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<PersonDocument>("PersonDocument_get", new { documentID = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int IPersonDocumentRepository.add(PersonDocument item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("PersonDocument_add",
                    new
                    {
                        item.description,
                        item.personID,
                        item.url,
                        item.fileName
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IPersonDocumentRepository.update(PersonDocument item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("PersonDocument_update",
                    new
                    {
                        item.documentID,
                        item.fileName,
                        item.description,
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IPersonDocumentRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("PersonDocument_delete", new { documentID = id }, commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## PersonDuplicatesRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class PersonDuplicatesRepository : BaseRepository, IPersonDuplicatesRepository
    {
        public PersonDuplicatesRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<PersonDuplicates> IPersonDuplicatesRepository.search(int personID, bool noSearch)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<PersonDuplicates>("person_get_duplicates", 
                    new {
                        personID,
                        noSearch
                    }, 
                    commandType: CommandType.StoredProcedure,
                    commandTimeout: 0
                    ).ToList();
            }
        }
        IEnumerable<PersonDuplicates> IPersonDuplicatesRepository.searchPeople()
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<PersonDuplicates>("person_get_duplicatesPeople", null,
                    commandType: CommandType.StoredProcedure, 
                    commandTimeout: 0
                    ).ToList();
            }
        }

    }
}

```
## PersonGroupRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class PersonGroupRepository : BaseRepository, IPersonGroupRepository
    {
        public PersonGroupRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<PersonGroup> IPersonGroupRepository.search(int personId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<PersonGroup>("person_group_search",
                 new
                 {
                     personId = personId
                 },
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }

        PersonGroup IPersonGroupRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<PersonGroup>("person_group_get", new { personGroupId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int IPersonGroupRepository.add(PersonGroup item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("person_group_add",
                    new
                    {
                        personId = item.personId,
                        groupId = item.groupId
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IPersonGroupRepository.update(PersonGroup item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("person_group_update",
                    new
                    {
                        personGroupId = item.personGroupId,
                        personId = item.personId,
                        groupId = item.groupId
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IPersonGroupRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("person_group_delete", new { personGroupId = id }, commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## PersonInsuranceRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using Dapper;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using System;
using System.Collections.Generic;
using System.Data;
using System.Data.SqlClient;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public class PersonInsuranceRepository : BaseRepository, IPersonInsuranceRepository
    {
        public PersonInsuranceRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<PersonInsurance> IPersonInsuranceRepository.search(int personId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<PersonInsurance>("person_insurance_search",
                 new
                 {
                     personId = personId
                 },
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }

        PersonInsurance IPersonInsuranceRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<PersonInsurance>("person_insurance_get", new { personInsuranceId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int IPersonInsuranceRepository.add(PersonInsurance item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("person_insurance_add",
                    new
                    {
                        personId = item.personId,
                        insuranceTypeId = item.insuranceTypeId,
                        expirationDate = item.expirationDate
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IPersonInsuranceRepository.update(PersonInsurance item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("person_insurance_update",
                    new
                    {
                        personInsuranceId = item.personInsuranceId,
                        personId = item.personId,
                        insuranceTypeId = item.insuranceTypeId,
                        expirationDate = item.expirationDate
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IPersonInsuranceRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("person_insurance_delete", new { personInsuranceId = id }, commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## PersonLanguageRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using AT.AT2017.Api.Core.Models;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class PersonLanguageRepository : BaseRepository, IPersonLanguageRepository
    {
        public PersonLanguageRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<PersonLanguage> IPersonLanguageRepository.search(int personId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<PersonLanguage>("person_language_search",
                    new
                     {
                         personId = personId
                     },
                     commandType: CommandType.StoredProcedure).ToList();
            }
        }

        PersonLanguage IPersonLanguageRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<PersonLanguage>("person_language_get", new { personLanguageId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int IPersonLanguageRepository.add(PersonLanguage item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("person_language_add",
                    new
                    {
                        personId = item.personId,
                        languageId = item.languageId
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IPersonLanguageRepository.update(PersonLanguage item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("person_language_update",
                    new
                    {
                        personLanguageId = item.personLanguageId,
                        personId = item.personId,
                        languageId = item.languageId
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IPersonLanguageRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("person_language_delete", new { personLanguageId = id }, commandType: CommandType.StoredProcedure);
            }
        }
    }
}

```
## PersonLicenseRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using AT.AT2017.Api.Core.Models;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class PersonLicenseRepository : BaseRepository, IPersonLicenseRepository
    {
        public PersonLicenseRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<PersonLicense> IPersonLicenseRepository.search(int personId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<PersonLicense>("person_license_search",
                 new
                 {
                     personId = personId
                 },
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<PersonLicense> IPersonLicenseRepository.searchByProperty(int propertyID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<PersonLicense>("person_license_search_by_property",
                    new
                    {
                        propertyID
                    }, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        PersonLicense IPersonLicenseRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<PersonLicense>("person_license_get", new { personLicenseId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int IPersonLicenseRepository.add(PersonLicense item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("person_license_add",
                    new
                    {
                        personId = item.personId,
                        licenseTypeId = item.licenseTypeId,
                        state = item.state,
                        licenseNumber = item.licenseNumber,
                        issuedDate = item.issuedDate,
                        expirationDate = item.expirationDate
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IPersonLicenseRepository.update(PersonLicense item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("person_license_update",
                    new
                    {
                        personLicenseId = item.personLicenseId,
                        personId = item.personId,
                        licenseTypeId = item.licenseTypeId,
                        state = item.state,
                        licenseNumber = item.licenseNumber,
                        issuedDate = item.issuedDate,
                        expirationDate = item.expirationDate
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IPersonLicenseRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("person_license_delete", new { personLicenseId = id }, commandType: CommandType.StoredProcedure);
            }
        }
    }
}

```
## PersonManageRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using AT.AT2017.Api.Core.Models;
using Dapper;
using System.Data;
using System.Data.SqlClient;
using AT.AT2017.Api.Core.Shared;

namespace AT.AT2017.Api.Repositories
{
    public class PersonManageRepository : BaseRepository, IPersonManageRepository
    {
        public PersonManageRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        PagedList<PersonManage> IPersonManageRepository.search(int officeID, int personTypeID, int pageIndex, int pageSize, string person)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                PagedList<PersonManage> page = null;

                using (var multi = connection.QueryMultiple("person_manage_search",
                 new
                 {
                     officeID,
                     personTypeID,
                     pageIndex,
                     pageSize,
                     person
                 },
                 commandType: CommandType.StoredProcedure))
                {
                    var data = multi.Read<PersonManage>().ToList();
                    page = multi.Read<PagedList<PersonManage>>().Single();
                    page.data = data;
                }

                return page;
            }
        }

        PersonManage IPersonManageRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<PersonManage>("person_manage_get", new { personID = id }, commandType: CommandType.StoredProcedure);
            }
        }

        void IPersonManageRepository.update(PersonManage item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("person_manage_update",
                    new {
                        item.personID,
                        item.firstName,
                        item.lastName,
                        item.companyName,
                        item.corporateName,
                        item.useCorporate,
                        decryptedTaxID = item.taxID,

                        item.addressID,
                        item.streetNumber,
                        item.streetDirection,
                        item.streetName,
                        item.streetDesignation,

                        item.streetSuffix,
                        item.suiteAptNumber,
                        item.buildingFloorNumber,
                        item.city,
                        item.state,
                        item.zip,
                        item.country,
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        IEnumerable<PersonManageInvoice> IPersonManageRepository.searchInvoices(int personId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<PersonManageInvoice>("person_manage_invoices_search",
                 new
                 {
                     personId
                 },
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }

        //PersonForte IPersonManageRepository.getForteInfo(int id)
        //{
        //    using (SqlConnection connection = new SqlConnection(base.connectionString))
        //    {
        //        return connection.QueryFirstOrDefault<PersonForte>("person_forte_get", new { personID = id }, commandType: CommandType.StoredProcedure);
        //    }
        //}

        //void IPersonManageRepository.addForteInfo(PersonForte item)
        //{
        //    using (SqlConnection connection = new SqlConnection(base.connectionString))
        //    {
        //        int id = connection.ExecuteScalar<int>("person_forte_add",
        //            new
        //            {
        //                item.personID,
        //                item.forteClientID,
        //                item.forteACHID,
        //                item.forteCCID,

        //                routingNumber = item.achRouterNumber,
        //                bankAccountNumber = item.achAccountNumber
        //            },
        //            commandType: CommandType.StoredProcedure);
        //    }
        //}
    }
}

```
## PersonMediaRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using AT.AT2017.Api.Core.Models;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class PersonMediaRepository : BaseRepository, IPersonMediaRepository
    {
        public PersonMediaRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<PersonMedia> IPersonMediaRepository.search(int personId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<PersonMedia>("person_media_search",
                 new
                 {
                     personId = personId
                 },
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }

        PersonMedia IPersonMediaRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<PersonMedia>("person_media_get", new { mediaId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int IPersonMediaRepository.add(PersonMedia item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("person_media_add",
                    new
                    {
                        item.personId,
                        item.description,
                        item.fileName,
                        item.url,
                        item.driveID,
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IPersonMediaRepository.update(PersonMedia item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("person_media_update",
                new
                {
                    mediaId = item.mediaId,
                    personId = item.personId,
                    caption = item.caption,
                    description = item.description,
                    orientation = item.orientation,
                    url = item.url,
                    sort = item.sort,
                    format = item.format,
                    category = item.category
                },
                commandType: CommandType.StoredProcedure);
            }
        }

        void IPersonMediaRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("person_media_delete", new { mediaId = id }, commandType: CommandType.StoredProcedure);
            }
        }
    }
}

```
## PersonMerchantRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using AT.AT2017.Api.DynamicParameters;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class PersonMerchantRepository : BaseRepository, IPersonMerchantRepository
    {
        public PersonMerchantRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<PersonMerchant> IPersonMerchantRepository.search(int personId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<PersonMerchant>("person_merchant_search", new { personId = personId }, commandType: CommandType.StoredProcedure).ToList();
            }
        }
        PersonMerchant IPersonMerchantRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<PersonMerchant>("person_merchant_get", new { personMerchantId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int IPersonMerchantRepository.add(PersonMerchant item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("person_merchant_add",
                    new
                    {
                        personId = item.personId,
                        merchantId = item.merchantId ,
                        clientId = item.clientId,
                        ccId = item.ccId,
                        achId = item.achId
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IPersonMerchantRepository.update(PersonMerchant item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("person_merchant_update",
                    new
                    {
                        personMerchantId = item.personMerchantId,
                        personId = item.personId,
                        merchantId = item.merchantId,
                        clientId = item.clientId,
                        ccId = item.ccId,
                        achId = item.achId
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IPersonMerchantRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("person_merchant_delete", new { personMerchantId = id }, commandType: CommandType.StoredProcedure);
            }
        }
    }
}

```
## PersonMessageRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using AT.AT2017.Api.Core.Models;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class PersonMessageRepository : BaseRepository, IPersonMessageRepository
    {
        public PersonMessageRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<PersonMessage> IPersonMessageRepository.search(int fromPersonId, int toPersonId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<PersonMessage>("person_message_search",
                 new
                 {
                     fromPersonId = fromPersonId,
                     toPersonId = toPersonId
                 },
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }

        PersonMessage IPersonMessageRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<PersonMessage>("person_message_get", new { messageId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int IPersonMessageRepository.add(PersonMessage item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("person_message_add",
                    new
                    {
                        fromPersonId = item.fromPersonId,
                        toPersonId = item.toPersonId,
                        notes = item.notes
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IPersonMessageRepository.update(PersonMessage item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("person_message_update",
                    new
                    {
                        messageId = item.messageId,
                        fromPersonId = item.fromPersonId,
                        toPersonId = item.toPersonId,
                        notes = item.notes
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IPersonMessageRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("person_message_delete", new { messageId = id }, commandType: CommandType.StoredProcedure);
            }
        }
    }
}

```
## PersonMlsRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using AT.AT2017.Api.Core.Models;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class PersonMlsRepository : BaseRepository, IPersonMlsRepository
    {
        public PersonMlsRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<PersonMls> IPersonMlsRepository.search(int personId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<PersonMls>("person_mlsID_search",
                 new
                 {
                     personId = personId
                 },
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }

        PersonMls IPersonMlsRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<PersonMls>("person_mlsID_get", new { personMlsID = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int IPersonMlsRepository.add(PersonMls item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("person_mlsID_add",
                    new
                    {
                        item.personId,
                        item.mlsID,
                        item.feedSubTypeId,
                        item.dashMlsName
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IPersonMlsRepository.update(PersonMls item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("person_mlsID_update",
                    new
                    {
                        item.personMlsID,
                        item.personId,
                        item.mlsID,
                        item.feedSubTypeId,
                        item.dashMlsName
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IPersonMlsRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("person_mlsID_delete", new { personMlsID = id }, commandType: CommandType.StoredProcedure);
            }
        }
    }
}

```
## PersonOnlinePaymentRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using AT.AT2017.Api.Core.Models;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class PersonOnlinePaymentRepository : BaseRepository, IPersonOnlinePaymentRepository
    {
        public PersonOnlinePaymentRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<PersonOnlinePayment> IPersonOnlinePaymentRepository.search(int personId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<PersonOnlinePayment>("person_onlinepayment_search",
                 new
                 {
                     personId = personId
                 },
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }

        PersonOnlinePayment IPersonOnlinePaymentRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<PersonOnlinePayment>("person_onlinepayment_get", new { onlinePaymentId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int IPersonOnlinePaymentRepository.add(PersonOnlinePayment item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("person_onlinepayment_add",
                    new
                    {
                        personId = item.personId,
                        paymentDate = item.paymentDate,
                        paymentCode = item.paymentCode,
                        clientId = item.clientId,
                        amountPaid = item.amountPaid,
                        paymentStatus = item.paymentStatus,
                        trace_id = item.trace_id,
                        authorization_code = item.authorization_code,
                        order_number = item.order_number
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IPersonOnlinePaymentRepository.update(PersonOnlinePayment item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("person_onlinepayment_update",
                    new
                    {
                        onlinePaymentId = item.onlinePaymentId,
                        personId = item.personId,
                        paymentDate = item.paymentDate,
                        paymentCode = item.paymentCode,
                        clientId = item.clientId,
                        amountPaid = item.amountPaid,
                        paymentStatus = item.paymentStatus,
                        trace_id = item.trace_id,
                        authorization_code = item.authorization_code,
                        order_number = item.order_number
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IPersonOnlinePaymentRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("person_onlinepayment_delete", new { onlinePaymentId = id }, commandType: CommandType.StoredProcedure);
            }
        }
    }
}

```
## PersonOverrideRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class PersonOverrideRepository : BaseRepository, IPersonOverrideRepository
    {
        public PersonOverrideRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<PersonOverride> IPersonOverrideRepository.search(int personAgentId, int overrideTypeId, int person3rdPartyId, int accountId, int officeId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<PersonOverride>("person_override_search",
                    new
                    {
                        personAgentId = personAgentId,
                        overrideTypeId = overrideTypeId,
                        person3rdPartyId = person3rdPartyId,
                        accountId = accountId,
                        officeId = officeId
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        PersonOverride IPersonOverrideRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<PersonOverride>("person_override_get", new { personOverrideId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int IPersonOverrideRepository.add(PersonOverride item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("person_override_add",
                    new
                    {
                        item.personAgentId,
                        item.overrideTypeId,
                        item.person3rdPartyId,
                        item.accountId,
                        item.officeId,
                        item.percentage,
                        item.amount,
                        item.side,
                        item.basedOn,
                        item.sortOrder,
                        item.limitAmount,
                        item.limitNumber,
                        item.limitDate,                      
                        item.trType,
                        item.leadGeneratedBy,
                        item.limitStartDate,
                        item.triggerAfter ,
                        item.limitDateRange,
                        item.classificationIDs,
                        item.buyerLeadSourceIds,
                        item.sellerLeadSourceIDs,
                        item.planIDs,
                        item.AGCIFrom,
                        item.AGCITo,
                        item.sellPriceFrom,
                        item.sellPriceTo,
                        item.advancedCriteria,
                        item.triggerLimitAmount,
                        item.applyLimitOnDateRange,
                        item.taxExempt
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IPersonOverrideRepository.update(PersonOverride item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("person_override_update",
                    new
                    {
                        item.personOverrideId,
                        item.personAgentId,
                        item.overrideTypeId,
                        item.person3rdPartyId,
                        item.accountId,
                        item.officeId,
                        item.percentage,
                        item.amount,
                        item.side,
                        item.basedOn,
                        item.sortOrder,
                        item.limitAmount,
                        item.limitNumber,
                        item.limitDate,                      
                        item.trType,
                        item.leadGeneratedBy,
                        item.limitStartDate,
                        item.triggerAfter,
                        item.limitDateRange,
                        item.classificationIDs,
                        item.buyerLeadSourceIds,
                        item.sellerLeadSourceIDs,
                        item.planIDs,
                        item.AGCIFrom,
                        item.AGCITo,
                        item.sellPriceFrom,
                        item.sellPriceTo,
                        item.advancedCriteria,
                        item.triggerLimitAmount,
                        item.applyLimitOnDateRange,
                        item.taxExempt
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IPersonOverrideRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("person_override_delete", new { personOverrideId = id }, commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## PersonPhoneRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using AT.AT2017.Api.Core.Models;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class PersonPhoneRepository : BaseRepository, IPersonPhoneRepository
    {
        public PersonPhoneRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<PersonPhone> IPersonPhoneRepository.search(int personId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<PersonPhone>("person_phone_search",
                 new
                 {
                     personId = personId
                 },
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }

        PersonPhone IPersonPhoneRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<PersonPhone>("person_phone_get", new { personPhoneId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int IPersonPhoneRepository.add(PersonPhone item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("person_phone_add",
                    new
                    {
                        item.personId,
                        item.phoneTypeId,
                        item.phoneNumber,
                        item.phoneExtension,
                        item.countryCode
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IPersonPhoneRepository.update(PersonPhone item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("person_phone_update",
                    new
                    {
                        item.personPhoneId,
                        item.personId,
                        item.phoneTypeId,
                        item.phoneNumber,
                        item.phoneExtension,
                        item.countryCode
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IPersonPhoneRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("person_phone_delete", new { personPhoneId = id }, commandType: CommandType.StoredProcedure);
            }
        }
    }
}

```
## PersonPositionRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using AT.AT2017.Api.Core.Models;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class PersonPositionRepository : BaseRepository, IPersonPositionRepository
    {
        public PersonPositionRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<PersonPosition> IPersonPositionRepository.search(int personId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<PersonPosition>("person_position_search",
                 new
                 {
                     personId = personId
                 },
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }

        PersonPosition IPersonPositionRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<PersonPosition>("person_position_get", new { positionId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int IPersonPositionRepository.add(PersonPosition item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("person_position_add",
                    new
                    {
                        personId = item.personId,
                        officeId = item.officeId,
                        titleId = item.titleId,
                        positionGuid = item.positionGuid,
                        activeDate = item.activeDate,
                        deactivateDate = item.deactivateDate,
                        item.isFulltime,
                        item.excludeFromSubmission 
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IPersonPositionRepository.update(PersonPosition item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("person_position_update",
                    new
                    {
                        positionId = item.positionId,
                        personId = item.personId,
                        officeId = item.officeId,
                        titleId = item.titleId,
                        positionGuid = item.positionGuid,
                        activeDate = item.activeDate,
                        deactivateDate = item.deactivateDate,
                        item.isFulltime,
                        item.excludeFromSubmission
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IPersonPositionRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("person_position_delete", new { positionId = id }, commandType: CommandType.StoredProcedure);
            }
        }
    }
}

```
## PersonPreferenceRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using AT.AT2017.Api.Core.Models;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class PersonPreferenceRepository : BaseRepository, IPersonPreferenceRepository
    {
        public PersonPreferenceRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<PersonPreference> IPersonPreferenceRepository.search(int personId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<PersonPreference>("person_preference_search",
                 new
                 {
                     personId = personId
                 },
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }

        PersonPreference IPersonPreferenceRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<PersonPreference>("person_preference_get", new { personPreferenceId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int IPersonPreferenceRepository.add(PersonPreference item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("person_preference_add",
                    new
                    {
                        personId = item.personId,
                        preferenceId = item.preferenceId,
                        enabled = item.enabled
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IPersonPreferenceRepository.update(PersonPreference item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("person_preference_update",
                    new
                    {
                        personPreferenceId = item.personPreferenceId,
                        preferenceId = item.preferenceId,
                        enabled = item.enabled
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IPersonPreferenceRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("person_preference_delete", new { personPreferenceId = id }, commandType: CommandType.StoredProcedure);
            }
        }
    }
}

```
## PersonReportRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Data;
using System.Data.SqlClient;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Core.Model_Report;
using Dapper;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;

namespace AT.AT2017.Api.Repositories
{
    public class PersonReportRepository : BaseRepository, IPersonReportRepository
    {
        public PersonReportRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        public IEnumerable<PersonReport> search(string personId ,string personType, string active, string dateType, string dateStart, string dateEnd, int pageIndex, int pageSize,
            string showAddresses, string showPhones, string showPositions, string showLicenses, string showInsurances, string showWebProfiles, string showLanguages,
            string showDesignations, string showDeductions, string showTotals, string showExpensesToRecover, string showExpensesRecovered, string showOverrides, string showCustomFields, 
            string showDeleted,string showLevels)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                try
                {
                    var parameters = new
                    {
                        personId = personId,
                        showAddresses = (showAddresses.ToLower() == "true" || showAddresses == "1"),
                        showPhones = (showPhones.ToLower() == "true" || showPhones == "1"),
                        showPositions = (showPositions.ToLower() == "true" || showPositions == "1"),
                        showLicenses = (showLicenses.ToLower() == "true" || showLicenses == "1"),
                        showInsurances = (showInsurances.ToLower() == "true" || showInsurances == "1"),
                        showWebProfiles = (showWebProfiles.ToLower() == "true" || showWebProfiles == "1"),
                        showLanguages = (showLanguages.ToLower() == "true" || showLanguages == "1"),
                        showDesignations = (showDesignations.ToLower() == "true" || showDesignations == "1"),
                        showDeductions = (showDeductions.ToLower() == "true" || showDeductions == "1"),
                        showTotals = (showTotals.ToLower() == "true" || showTotals == "1"),
                        showExpensesToRecover = (showExpensesToRecover.ToLower() == "true" || showExpensesToRecover == "1"),
                        showExpensesRecovered = (showExpensesRecovered.ToLower() == "true" || showExpensesRecovered == "1"),
                        showOverrides = (showOverrides.ToLower() == "true" || showOverrides == "1"),
                        showCustomFields = (showCustomFields.ToLower() == "true" || showCustomFields == "1"),
                        showDeleted = (showDeleted.ToLower() == "true" || showDeleted == "1"),
                        showLevels = (showLevels.ToLower() == "true" || showLevels == "1"),

                        personType = personType,
                        active = string.IsNullOrEmpty(active) ? (bool?)null : (active.ToLower() == "true" || active == "1"),

                        dateType,
                        dateStart = string.IsNullOrEmpty(dateStart) ? (DateTime?)null : DateTime.Parse(dateStart),
                        dateEnd = string.IsNullOrEmpty(dateEnd) ? (DateTime?)null : DateTime.Parse(dateEnd),

                        pageIndex,
                        pageSize
                    };

                    using (var multi = connection.QueryMultiple("person_report", parameters, commandType: CommandType.StoredProcedure, commandTimeout: 0))
                    {
                        IEnumerable<PersonReport> personReport = multi.Read<PersonReport>().ToList();
                        IEnumerable<PersonReportAddress> personAddresses = parameters.showAddresses ? multi.Read<PersonReportAddress>().ToList() : null;
                        IEnumerable<PersonReportPhone> personPhones = parameters.showPhones ? multi.Read<PersonReportPhone>().ToList() : null;
                        IEnumerable<PersonReportPosition> personPositions = parameters.showPositions ? multi.Read<PersonReportPosition>().ToList() : null;
                        IEnumerable<PersonReportLicense> personLicenses = parameters.showLicenses ? multi.Read<PersonReportLicense>().ToList() : null;
                        IEnumerable<PersonReportInsurance> personInsurances = parameters.showInsurances ? multi.Read<PersonReportInsurance>().ToList() : null;
                        IEnumerable<PersonReportWebProfile> personWebProfiles = parameters.showWebProfiles ? multi.Read<PersonReportWebProfile>().ToList() : null;
                        IEnumerable<PersonReportLanguage> personLanguages = parameters.showLanguages ? multi.Read<PersonReportLanguage>().ToList() : null;
                        IEnumerable<PersonReportDesignation> personDesignations = parameters.showDesignations ? multi.Read<PersonReportDesignation>().ToList() : null;
                        IEnumerable<PersonReportDeduction> personDeductions = parameters.showDeductions ? multi.Read<PersonReportDeduction>().ToList() : null;
                        IEnumerable<PersonReportTotal> personTotals = parameters.showTotals ? multi.Read<PersonReportTotal>().ToList() : null;
                        IEnumerable<ReportReimbursement> expensesToRecover = parameters.showExpensesToRecover ? multi.Read<ReportReimbursement>().ToList() : null;
                        IEnumerable<ReportReimbursement> expensesRecovered = parameters.showExpensesRecovered ? multi.Read<ReportReimbursement>().ToList() : null;
                        IEnumerable<PersonReportOverride> personOverrides = parameters.showOverrides ? multi.Read<PersonReportOverride>().ToList() : null;
                        IEnumerable<PersonCustomField> personCustomFields = parameters.showCustomFields ? multi.Read<PersonCustomField>().ToList() : null;
                        IEnumerable<PersonReportDeductionLevel> personDeductionsLevel = parameters.showLevels ? multi.Read<PersonReportDeductionLevel>().ToList() : null;

                        foreach (var person in personReport)
                        {
                            person.addresses = parameters.showAddresses ? personAddresses.Where(x => x.personId == person.personId).ToList() : null;
                            person.phones = parameters.showPhones ? personPhones.Where(x => x.personId == person.personId).ToList() : null;
                            person.positions = parameters.showPositions ? personPositions.Where(x => x.personId == person.personId).ToList() : null;
                            person.licenses = parameters.showLicenses ? personLicenses.Where(x => x.personId == person.personId).ToList() : null;
                            person.insurances = parameters.showInsurances ? personInsurances.Where(x => x.personId == person.personId).ToList() : null;
                            person.webProfiles = parameters.showWebProfiles ? personWebProfiles.Where(x => x.personId == person.personId).ToList() : null;
                            person.languages = parameters.showLanguages ? personLanguages.Where(x => x.personId == person.personId).ToList() : null;
                            person.designations = parameters.showDesignations ? personDesignations.Where(x => x.personId == person.personId).ToList() : null;
                            person.deductions = parameters.showDeductions ? personDeductions.Where(x => x.personId == person.personId).ToList() : null;
                            person.totals = parameters.showTotals ? personTotals.Where(x => x.personId == person.personId).ToList() : null;
                            person.expensesToRecover = parameters.showExpensesToRecover ? expensesToRecover.Where(x => x.personID == person.personId).ToList() : null;
                            person.expensesRecovered = parameters.showExpensesRecovered ? expensesRecovered.Where(x => x.personID == person.personId).ToList() : null;
                            person.overrides = parameters.showOverrides ? personOverrides.Where(x => x.personAgentId == person.personId).ToList() : null;
                            person.customFields = parameters.showCustomFields ? personCustomFields.Where(x => x.personId == person.personId).ToList() : null;
                            person.deductionsLevel = parameters.showLevels ? personDeductionsLevel.Where(x => x.personid == person.personId).ToList() : null;
                        }

                        return personReport;
                    }
                }
                catch (Exception ex)
                {
                    throw ex;
                }
            }
        }
    }
}

```
## PersonRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;
using AT.AT2017.Api.DynamicParameters;
using AT.AT2017.Api.Core.Shared;

namespace AT.AT2017.Api.Repositories
{
    public class PersonRepository : BaseRepository, IPersonRepository
    {
        public PersonRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
            
        }
        
        IEnumerable<Person> IPersonRepository.search(string person, int personTypeID, int userID,int companyID, int pageIndex, int pageSize, string sortedBy, string custom, int officeID, int propertyID, string side, string companyName, string mls, string emailAddress, string phoneNumber, string licenseNumber, string filter1, string filter2, bool withTrash,string active, int cobrokeOfficeID, string printedName,int personID, bool applySecurity, string personTaxID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<Person>("person_search",
                   new
                   {
                       person = person,
                       personTypeID = personTypeID,
                       userID = userID,
                       pageIndex = pageIndex,
                       pageSize = pageSize,
                       sortedBy = sortedBy,
                       custom = custom,
                       officeID = officeID,
                       propertyID = propertyID,
                       companyID = companyID,
                       side = side,
                       companyName = companyName,
                       mls = mls,
                       emailAddress = emailAddress,
                       phoneNumber = phoneNumber,
                       licenseNumber = licenseNumber,
                       filter1 = filter1,
                       filter2 = filter2,
                       active = active,
                       withTrash = withTrash,
                       cobrokeOfficeID = cobrokeOfficeID,
                       printedName = printedName,
                       personID = personID,
                       applySecurity = applySecurity,
                       personTaxID=personTaxID
                   },
                   commandType: CommandType.StoredProcedure, commandTimeout: 0).ToList();
            }
        }

        IEnumerable<Person> IPersonRepository.searchForAgentBilling(int personTypeID, int companyID, string officeID, string filter1, string filter2, string active, int pageIndex, int pageSize)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<Person>("person_search_forAgentBilling",
                   new
                   {
                      personTypeID = personTypeID,
                       officeID = officeID,
                       companyID = companyID,
                       filter1 = filter1,
                       filter2 = filter2,
                       active = active ,
                       pageIndex = pageIndex,
                       pageSize = pageSize
                   },
                   commandType: CommandType.StoredProcedure, commandTimeout: 0).ToList();
            }
        }


        PagedList<Person> IPersonRepository.searchPaginated(string person, int personTypeID, int userID, int companyID, int pageIndex, int pageSize, string sortedBy, string custom, int officeID, int propertyID, string side, string companyName, string mls, string emailAddress, string phoneNumber, string licenseNumber, string filter1, string filter2, bool withTrash, string active, int cobrokeOfficeID, string printedName, int personID, bool applySecurity, string personTaxID, string offices, string sortBy, string filterBy)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                PagedList<Person> page = null;

                using (var multi = connection.QueryMultiple("person_search_paginated",
                    new
                    {
                        person,
                        personTypeID,
                        userID,
                        pageIndex,
                        pageSize,
                        sortedBy,
                        custom,
                        officeID,
                        propertyID,
                        companyID,
                        side,
                        companyName,
                        mls,
                        emailAddress,
                        phoneNumber,
                        licenseNumber,
                        filter1,
                        filter2,
                        active,
                        withTrash,
                        cobrokeOfficeID,
                        printedName,
                        personID,
                        applySecurity,
                        personTaxID,
                        offices,
                        sortBy,
                        filterBy
                    }, commandType: CommandType.StoredProcedure))
                {
                    page = multi.Read<PagedList<Person>>().Single();
                    page.data = multi.Read<Person>().ToList();
                }
                return page;
            }
        }

        IEnumerable<Person> IPersonRepository.searchDeletedRecord(int pageIndex, int pageSize)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<Person>("person_search_deleted",
                    new
                    {
                        pageIndex = pageIndex,
                        pageSize = pageSize
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<Property> IPersonRepository.searchRelatedProperties(int personId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<Property>("person_search_relatedProperties",
                    new
                    {
                        personId = personId
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<Person> IPersonRepository.searchAgents()
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<Person>("person_search_agents_list", null, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<Person> IPersonRepository.searchByProperty(int propertyID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<Person>("person_search_by_property", 
                    new
                    {
                        propertyID
                    }, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        Person IPersonRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<Person>("person_get", new { personId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        Person IPersonRepository.getEscrowPayee(int companyID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<Person>("person_get_escrow_payee", new { companyID }, commandType: CommandType.StoredProcedure);
            }
        }

        Person IPersonRepository.person_getbypersonidormls(string desc)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<Person>("person_getByPersonIDOrMLS", new { description = desc }, commandType: CommandType.StoredProcedure);
            }
        }

        int IPersonRepository.add(Person item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("person_add",
                    new
                    {
                        item.firstName,
                        item.lastName,
                        item.companyName,
                        item.personTypeId,
                        item.termId,
                        item.emailAddress,
                        item.officeId,
                        item.agentNumber,
                        item.contractStartDate,
                        item.startDate,
                        item.terminatedDate,
                        item.reStartDate,
                        item.planId,
                        item.active,
                        item.leadSourceId,
                        item.salutationId,
                        item.entityTypeId,
                        item.leadGeneratedById,
                        item.entityName,
                        item.sendSurveyFlag,
                        item.callToShow,
                        item.autoDeposit,
                        item.birthDate,
                        item.printedName,
                        item.middleName,
                        item.brandStartDate,
                        item.priorOccupationId,
                        item.educationLevelId,
                        item.genderType,
                        item.priorAffiliationId,
                        item.recruitedByPersonId,
                        item.emergencyPersonId,
                        item.cobrokeOfficePersonId,
                        item.familiarName,
                        item.mlsId,
                        item.url,
                        item.confirmed,
                        item.balance,
                        item.notes,
                        item.referralNotes,
                        item.referralPercentage,
                        item.referralId,
                        item.assignedPersonId,
                        item.taxId,
                        item.accountId,
                        item.useCorporate,
                        item.is1099,
                        item.is1099TypeId,
                        item.divisionId,
                        item.userId,
                        item.title,
                        item.showOnInternet,
                        item.isFullTime,
                        item.agentTeamId ,
                        item.exclude,
                        item.referralBrandId,
                        item.referralNetworkId,
                        item.isIntercompany
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IPersonRepository.update(Person item, string propIds, int updateOption, int autoTerminatePositions)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("person_update",
                    new
                    {
                        item.personId,
                        item.firstName,
                        item.lastName,
                        item.companyName,
                        item.personTypeId,
                        item.termId,
                        item.emailAddress,
                        item.officeId,
                        item.agentNumber,
                        item.contractStartDate,
                        item.startDate,
                        item.terminatedDate,
                        item.reStartDate,
                        item.planId,
                        item.active,
                        item.leadSourceId,
                        item.salutationId,
                        item.entityTypeId,
                        item.leadGeneratedById,
                        item.entityName,
                        item.sendSurveyFlag,
                        item.callToShow,
                        item.autoDeposit,
                        item.birthDate,
                        item.printedName,
                        item.middleName,
                        item.brandStartDate,
                        item.priorOccupationId,
                        item.educationLevelId,
                        item.specialty,
                        item.genderType,
                        item.priorAffiliationId,
                        item.recruitedByPersonId,
                        item.emergencyPersonId,
                        item.coachedByPersonId,
                        item.manageByPersonId,
                        item.cobrokeOfficePersonId,
                        item.forteClientId,
                        item.forteAchId,
                        item.forteCcId,
                        item.familiarName,
                        item.mlsId,
                        item.url,
                        item.confirmed,
                        item.balance,
                        item.notes,
                        item.referralNotes,
                        item.referralPercentage,
                        item.commissionNotes,
                        item.referralId,
                        item.assignedPersonId,
                        item.taxId,
                        item.accountId,
                        item.useCorporate,
                        item.is1099,
                        item.is1099TypeId,
                        item.divisionId,
                        item.userId,
                        item.title,
                        item.accountNumber,
                        item.dotLoopID,
                        item.eRELOID,
                        item.skySlopeID,
                        item.crestID,
                        item.feedID,
                        item.showOnInternet,
                        item.isFullTime,
                        propIds,
                        updateOption,
                        item.agentTeamId,
                        item.exclude,
                        item.referralBrandId,
                        item.referralNetworkId,
                        item.priorProduction,
                        item.atguid,
                        item.guid,
                        item.companyStaffGUID,
                        item.brandName,
                        item.displayName ,
                        item.routingNumber,
                        item.bankAccountNumber,
                        autoTerminatePositions,
                        item.LWID,
                        item.LW_EMPLID,
                        item.priorVolume,
                        item.priorSides,
                        item.priorNet,
                        item.corporateTaxId ,
                        item.corporationStartDate,
                        item.corporationEndDate,
                        item.nextCommissionPlanId,
                        item.nextCommissionEffectiveDate,
                        item.subplanId 
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IPersonRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("person_delete", new { personId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        void IPersonRepository.updateBillingNotes(int id, string billingNotes)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("person_update_billingNotes", new { personId = id , billingNotes = billingNotes }, commandType: CommandType.StoredProcedure);
            }
        }

        void IPersonRepository.personmerge(int personidtokeep, int personidtoremove)
        {
            using (SqlConnection connection = new SqlConnection(base.saConnectionString))
            {
                connection.ExecuteScalar<int>("person_merge", new { personID_ToKeep = personidtokeep,
                    personID_ToRemove = personidtoremove
                }, commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }

        IEnumerable<Person> IPersonRepository.searchRecipients(int recipientId, string personName)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<Person>("person_search_recipients",
                    new
                    {
                        recipientId,                     
                        personName
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<PersonImport> IPersonRepository.getImportLog(int logId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<PersonImport>("person_search_importLog",
                    new
                    {
                        logId
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        int IPersonRepository.import(IEnumerable<PersonImport> table)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                var tableParameter = new PersonImportDynamicParameter(table);

                return connection.ExecuteScalar<int>("person_import", tableParameter, commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }

    }
}

```
## PersonTimelineTaskManualRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using AT.AT2017.Api.Core.Models;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class PersonTimelineTaskManualRepository : BaseRepository, IPersonTimelineTaskManualRepository
    {
        public PersonTimelineTaskManualRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        PersonTimelineTask IPersonTimelineTaskManualRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<PersonTimelineTask>("person_timelinetaskmanual_get", new { personTimelineTaskManualID = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int IPersonTimelineTaskManualRepository.add(PersonTimelineTask item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("person_timelinetaskmanual_add",
                    new
                    {
                        item.personId,
                        item.taskName,
                        item.date,
                        item.notes,
                        item.done,
                        item.locked,
                        item.rejectionNotes
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IPersonTimelineTaskManualRepository.update(PersonTimelineTask item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("person_timelinetaskmanual_update",
                    new
                    {
                        personTimelineTaskManualID = item.personTimelineTaskId,
                        item.taskName,
                        item.date,
                        item.notes,
                        item.done,
                        item.locked,
                        item.rejectionNotes
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IPersonTimelineTaskManualRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("person_timelinetaskmanual_delete", new { personTimelineTaskManualID = id }, commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## PersonTimelineTaskRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using AT.AT2017.Api.Core.Models;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class PersonTimelineTaskRepository : BaseRepository, IPersonTimelineTaskRepository
    {
        public PersonTimelineTaskRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<PersonTimelineTask> IPersonTimelineTaskRepository.search(int personId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<PersonTimelineTask>("person_timelinetask_search",
                 new
                 {
                     personId = personId
                 },
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }

        PersonTimelineTask IPersonTimelineTaskRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<PersonTimelineTask>("person_timelinetask_get", new { personTimelineTaskId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int IPersonTimelineTaskRepository.add(PersonTimelineTask item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("person_timelinetask_add",
                    new
                    {
                        personId = item.personId,
                        taskId = item.taskId,
                        date = item.date,
                        notes = item.notes,
                        done = item.done,
                        locked = item.locked,
                        rejectionNotes = item.rejectionNotes
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IPersonTimelineTaskRepository.update(PersonTimelineTask item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("person_timelinetask_update",
                    new
                    {
                        personTimelineTaskId = item.personTimelineTaskId,
                        personId = item.personId,
                        taskId = item.taskId,
                        date = item.date,
                        notes = item.notes,
                        done = item.done,
                        locked = item.locked,
                        rejectionNotes = item.rejectionNotes
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IPersonTimelineTaskRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("person_timelinetask_delete", new { personTimelineTaskId = id }, commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## PersonTotalDetailRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class PersonTotalDetailRepository : BaseRepository, IPersonTotalDetailRepository
    {
        public PersonTotalDetailRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<PersonTotalDetail> IPersonTotalDetailRepository.search(int personTotalID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<PersonTotalDetail>("person_total_detail_search",
                    new
                    {
                        personTotalID = personTotalID,
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

    }
}

```
## PersonTotalRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;
using Hangfire;

namespace AT.AT2017.Api.Repositories
{
    public class PersonTotalRepository : BaseRepository, IPersonTotalRepository
    {
        private IBackgroundJobClient _backgroundJobs;

        public PersonTotalRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings, IBackgroundJobClient backgroundJobs) : base(httpContextAccessor, appSettings)
        {
            _backgroundJobs = backgroundJobs;
        }

        IEnumerable<PersonTotal> IPersonTotalRepository.search(int personID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<PersonTotal>("person_total_search",
                    new
                    {
                        personID = personID,
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<PersonTotal> IPersonTotalRepository.searchByPropertyID(int propertyID, string checkTemplateIDs)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<PersonTotal>("person_total_search_by_property",
                    new
                    {
                        propertyID = propertyID,
                        checkTemplateIDs = checkTemplateIDs
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<PersonTotal> IPersonTotalRepository.searchUpdateLog(int propertyID, string processedDate)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<PersonTotal>("person_total_search_update_log",
                    new
                    {
                        propertyID,
                        processedDate
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        PersonTotal IPersonTotalRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<PersonTotal>("person_total_get", new { personTotalId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        IEnumerable<PersonTotal> IPersonTotalRepository.total_get_balanceamount(int personId, int propertyId, int totalId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<PersonTotal>("total_get_balanceamount",
                 new
                 {
                     personID = personId,
                     propertyID = propertyId,
                     totalID = totalId
                 },
                  commandType: CommandType.StoredProcedure).ToList();
            }
        }

        int IPersonTotalRepository.add(PersonTotal item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("person_total_add",
                   new
                   {
                       personID = item.personId,
                       totalID = item.totalId,
                       companyID = item.companyId,
                       officeID = item.officeId,
                       planID = item.planId,
                       isForTerminated = item.isForTerminated
                   },
                   commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IPersonTotalRepository.update(int personID,int validateLogin)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("person_total_update",
                    new
                    {
                        personID = personID
                    },
                    commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }

        void IPersonTotalRepository.delete(int personID, int totalID, int companyID, int officeID, int planID, bool isForTerminated)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("person_total_delete", new
                {
                    personID ,
                    totalID,
                    companyID ,
                    officeID,
                    planID,
                    isForTerminated 
                },
                commandType: CommandType.StoredProcedure);
            }
        }

        void IPersonTotalRepository.updateOpeningBalance(int id, decimal openingBalance, string balanceEndDate)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int result = connection.ExecuteScalar<int>("person_total_update_openingBalance",
                    new
                    {
                        personTotalID = id,
                        openingBalance = openingBalance,
                        balanceEndDate = balanceEndDate
                    },
                    commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }

        // update total on demand (no async)
        void IPersonTotalRepository.updateTotalOnDemand(int personTotalID, string processDate, string updateType)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("person_total_update_ondemand",
                    new
                    {
                        processDate = processDate,
                        personTotalID = personTotalID,
                        updateType = updateType
                    },
                    commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }

        // total update on property post/unpost
        IEnumerable<PersonTotal> IPersonTotalRepository.updateOnPropertyPost(int propertyID, string processedDate, string checkTemplateIDs, string actionType)
        {
            // actionType = post | unpost | post regional | unpost regional

            // get list of personTotal records will be updated
            List<PersonTotal> personTotals = new List<PersonTotal>();
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                personTotals = connection.Query<PersonTotal>("person_total_search_by_property",
                    new
                    {
                        propertyID,
                        checkTemplateIDs
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }

            // iterate each personTotal to update
            foreach (var personTotal in personTotals)
            {
                // start a background jo for each record
                _backgroundJobs.Enqueue(() => updatePropertyAgentTotalsAsync(propertyID, processedDate, personTotal.personTotalId, actionType, connectionString));
            }

            // return list of personTotals
            return personTotals;
        }

        // total update based for specific case (processing on background and in parallel)
        IEnumerable<PersonTotal> IPersonTotalRepository.updateOnCustomCase(int personID, string processedDate, string customCase, int propertyID, string cs)
        {
            if (string.IsNullOrEmpty(cs))
            {
                cs = base.connectionString;
            }

            // get list of personTotal records will be updated
            List<PersonTotal> personTotals = new List<PersonTotal>();
            using (SqlConnection connection = new SqlConnection(cs))
            {
                personTotals = connection.Query<PersonTotal>("person_total_search_by_custom_case",
                    new
                    {
                        personID,
                        customCase
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }

            // iterate each personTotal to update
            foreach (var personTotal in personTotals)
            {
                // start a background jo for each record
                _backgroundJobs.Enqueue(() => updateSingleTotalOnDemandAsync(processedDate, personTotal.personTotalId, "FULL", propertyID, cs));
            }

            // return list of personTotals
            return personTotals;
        }

        // total update on-demand execution (for all person)
        PersonTotalUpdateLog IPersonTotalRepository.startOnDemandExecution(string updateType)
        {
            PersonTotalUpdateLog newExecution;
            using (SqlConnection connection = new SqlConnection(connectionString))
            {
                using (var multi = connection.QueryMultiple("person_total_start_ondemand_execution", commandType: CommandType.StoredProcedure))
                {
                    newExecution = multi.Read<PersonTotalUpdateLog>().Single();
                    newExecution.detail = multi.Read<PersonTotalUpdateLogDetail>().ToList();

                    // start a background worker
                    _backgroundJobs.Enqueue(() => updateTotalOnDemandAsync(newExecution.processDate, updateType, 1, connectionString));
                    _backgroundJobs.Enqueue(() => updateTotalOnDemandAsync(newExecution.processDate, updateType, 2, connectionString));
                    _backgroundJobs.Enqueue(() => updateTotalOnDemandAsync(newExecution.processDate, updateType, 3, connectionString));
                    _backgroundJobs.Enqueue(() => updateTotalOnDemandAsync(newExecution.processDate, updateType, 4, connectionString));
                    _backgroundJobs.Enqueue(() => updateTotalOnDemandAsync(newExecution.processDate, updateType, 5, connectionString));
                    _backgroundJobs.Enqueue(() => updateTotalOnDemandAsync(newExecution.processDate, updateType, 6, connectionString));
                    _backgroundJobs.Enqueue(() => updateTotalOnDemandAsync(newExecution.processDate, updateType, 7, connectionString));
                    _backgroundJobs.Enqueue(() => updateTotalOnDemandAsync(newExecution.processDate, updateType, 8, connectionString));
                    _backgroundJobs.Enqueue(() => updateTotalOnDemandAsync(newExecution.processDate, updateType, 9, connectionString));
                    _backgroundJobs.Enqueue(() => updateTotalOnDemandAsync(newExecution.processDate, updateType, 10, connectionString));

                }
            }
            return newExecution;
        }

        PersonTotalUpdateLog IPersonTotalRepository.getLastOnDemandExecution(string processDate)
        {
            PersonTotalUpdateLog lastExecution;
            using (SqlConnection connection = new SqlConnection(connectionString))
            {
                lastExecution = connection.QueryFirstOrDefault<PersonTotalUpdateLog>("person_total_get_last_ondemand_execution", new { processDate }, commandType: CommandType.StoredProcedure);
            }
            return lastExecution;
        }

        // async methods

        public void updatePropertyAgentTotalsAsync(int propertyID, string processedDate, int personTotalID, string actionType, string connectionString)
        {
            using (SqlConnection connection = new SqlConnection(connectionString))
            {
                connection.Execute("property_update_agent_totals",
                        new
                        {
                            propertyID,
                            processedDate,
                            personTotalIDToUpdate = personTotalID,
                            actionType
                        },
                        commandType: CommandType.StoredProcedure,
                        commandTimeout: 0);
            }
        }

        public void updateTotalOnDemandAsync(string processDate, string updateType, int blockNumber, string connectionString)
        {
            using (SqlConnection connection = new SqlConnection(connectionString))
            {
                // get executioninfo
                PersonTotalUpdateLog lastExecution;
                using (var multi = connection.QueryMultiple("person_total_get_last_ondemand_execution", new { processDate }, commandType: CommandType.StoredProcedure))
                {
                    lastExecution = multi.Read<PersonTotalUpdateLog>().Single();
                    lastExecution.detail = multi.Read<PersonTotalUpdateLogDetail>().ToList();
                }

                // calculate records by block
                int recordsByBlock = lastExecution.detail.Count() / 10;

                // calculate startIndex and endIndex
                int startIndex = (recordsByBlock * (blockNumber - 1)) + 1;
                int endIndex;
                if (blockNumber < 10)
                {
                    endIndex = recordsByBlock * blockNumber;
                }
                else
                {
                    endIndex = lastExecution.detail.Count();
                }

                // get pending records filtered by block range
                List<PersonTotalUpdateLogDetail> pendingRecords = lastExecution.detail.Where(p => p.endDate == null && p.recordNumber >= startIndex && p.recordNumber <= endIndex).ToList();

                foreach (var record in pendingRecords)
                {
                    // recalculate this property
                    connection.Execute("person_total_update_ondemand",
                        new {
                            processDate,
                            record.personTotalID,
                            updateType
                        }, commandType: CommandType.StoredProcedure, commandTimeout: 0);
                }
            }
        }

        public void updateSingleTotalOnDemandAsync(string processDate, int personTotalID, string updateType, int propertyID, string connectionString)
        {
            using (SqlConnection connection = new SqlConnection(connectionString))
            {
                // recalculate person total
                connection.Execute("person_total_update_ondemand",
                    new
                    {
                        processDate,
                        personTotalID,
                        updateType,
                        propertyID
                    }, commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }

        IEnumerable<PersonTotal> IPersonTotalRepository.searchPlan(int userID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<PersonTotal>("person_total_search_plan",
                    new
                    {
                        userID,
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }
    }
}

```
## PersonUptimeRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using AT.AT2017.Api.Core.Models;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class PersonUptimeRepository : BaseRepository, IPersonUptimeRepository
    {
        public PersonUptimeRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<PersonUptime> IPersonUptimeRepository.search(int personId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<PersonUptime>("person_uptime_search",
                 new
                 {
                     personId = personId
                 },
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }

        PersonUptime IPersonUptimeRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<PersonUptime>("person_uptime_get", new { personUptimeId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int IPersonUptimeRepository.add(PersonUptime item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("person_uptime_add",
                    new
                    {
                        personId = item.personId,
                        officeId = item.officeId,
                        date = item.date,
                        time = item.time,
                        duration = item.duration,
                        subject = item.subject,
                        notes = item.notes,
                        done = item.done
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IPersonUptimeRepository.update(PersonUptime item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("person_uptime_update",
                    new
                    {
                        personUptimeId = item.personUptimeId,
                        personId = item.personId,
                        officeId = item.officeId,
                        date = item.date,
                        time = item.time,
                        duration = item.duration,
                        subject = item.subject,
                        notes = item.notes,
                        done = item.done
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IPersonUptimeRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("person_uptime_delete", new { personUptimeId = id }, commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## PersonWebProfileRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using AT.AT2017.Api.Core.Models;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class PersonWebProfileRepository : BaseRepository, IPersonWebProfileRepository
    {
        public PersonWebProfileRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<PersonWebProfile> IPersonWebProfileRepository.search(int personId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<PersonWebProfile>("person_webprofile_search",
                 new
                 {
                     personId = personId
                 },
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }

        PersonWebProfile IPersonWebProfileRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<PersonWebProfile>("person_webprofile_get", new { personWebProfileId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int IPersonWebProfileRepository.add(PersonWebProfile item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("person_webprofile_add",
                    new
                    {
                        personId = item.personId,
                        webCategoryId = item.webCategoryId,
                        paragraphNumber = item.paragraphNumber,
                        profileText = item.profileText
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IPersonWebProfileRepository.update(PersonWebProfile item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("person_webprofile_update",
                    new
                    {
                        personWebProfileId = item.personWebProfileId,
                        personId = item.personId,
                        webCategoryId = item.webCategoryId,
                        paragraphNumber = item.paragraphNumber,
                        profileText = item.profileText
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IPersonWebProfileRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("person_webprofile_delete", new { personWebProfileId = id }, commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## PersonWebsiteRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using Dapper;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using System;
using System.Collections.Generic;
using System.Data;
using System.Data.SqlClient;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Repositories
{
    public class PersonWebsiteRepository : BaseRepository, IPersonWebsiteRepository
    {
        public PersonWebsiteRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<PersonWebsite> IPersonWebsiteRepository.search(int personID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<PersonWebsite>("person_website_search",
                 new
                 {
                     personID
                 },
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }

        PersonWebsite IPersonWebsiteRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<PersonWebsite>("person_website_get", new { personWebsiteID = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int IPersonWebsiteRepository.add(PersonWebsite item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("person_website_add",
                    new
                    {
                        item.personID,
                        item.websiteTypeID,
                        item.languageID,
                        item.name,
                        item.url
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IPersonWebsiteRepository.update(PersonWebsite item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("person_website_update",
                    new
                    {
                        item.personWebsiteID,
                        item.personID,
                        item.websiteTypeID,
                        item.languageID,
                        item.name,
                        item.url
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IPersonWebsiteRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("person_website_delete", new { personWebsiteID = id }, commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## PlaidRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Data;
using System.Data.SqlClient;
using System.Linq;
using AT.AT2017.Api.Core.Models;
using Dapper;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;

namespace AT.AT2017.Api.Repositories
{
    public class PlaidRepository : BaseRepository, IPlaidRepository
    {
        public PlaidRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<PlaidConnectLog> IPlaidRepository.searchConnectLog()
        {
            using (SqlConnection Connection = new SqlConnection(base.connectionString))
            {
                return Connection.Query<PlaidConnectLog>("plaid_connect_log_search", null, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        void IPlaidRepository.saveConnectLog(string actionType, string request_id, string link_token, string link_token_expiration, string public_token, string link_session_id, string institution_name, string institution_id, string item_id, string access_token)
        {
            try
            {
                using (SqlConnection connection = new SqlConnection(base.connectionString))
                {
                    connection.ExecuteScalar<int>("plaid_connect_log_add",
                        new
                        {
                            actionType,
                            request_id,
                            link_token,
                            link_token_expiration,
                            public_token,
                            link_session_id,
                            institution_name,
                            institution_id,
                            item_id,
                            access_token
                        },
                        commandType: CommandType.StoredProcedure);
                }
            }
            catch (Exception)
            {
            }
        }

    }
}

```
## PropertyByAgentCubeRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class PropertyByAgentCubeRepository : BaseRepository, IPropertyByAgentCubeRepository
    {
        public PropertyByAgentCubeRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<PropertyByAgentCube> IPropertyByAgentCubeRepository.search(int propertyId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<PropertyByAgentCube>("property_byAgent_cube_search",
                    new
                    {
                        propertyId = propertyId
                    },
                    commandType: CommandType.StoredProcedure, commandTimeout: 0).ToList();
            }
        }

        PropertyByAgentCube IPropertyByAgentCubeRepository.getFieldsSelected(int propertyId, int personId, string side, int columnNumber, int correspondenceTemplateId, int formType)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<PropertyByAgentCube>("property_byAgent_cube_get_fieldsSelected",
                     new
                     {
                         propertyId = propertyId,
                         personId = personId,
                         side = side,
                         columnNumber = columnNumber,
                         correspondenceTemplateId = correspondenceTemplateId,
                         formType = formType
                     },
                     commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }

        PropertyByAgentCube IPropertyByAgentCubeRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<PropertyByAgentCube>("property_byAgent_cube_get", new { propertyId = id }, commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }

        DataTable IPropertyByAgentCubeRepository.processFormulas(int templateId, int propertyId, int personId, string side)
        {
            DataTable dt = new DataTable();
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                SqlCommand command = new SqlCommand("correspondencetemplate_process_formula", connection);
                command.CommandType = CommandType.StoredProcedure;
                command.CommandTimeout = 0;

                SqlParameter p;
                p = command.Parameters.Add("@propertyId", SqlDbType.NVarChar,100);
                p.Value = propertyId;
                p = command.Parameters.Add("@personId", SqlDbType.NVarChar, 100);
                p.Value = personId;
                p = command.Parameters.Add("@side", SqlDbType.NVarChar, 2);
                p.Value = side;
                p = command.Parameters.Add("@templateId", SqlDbType.Int);
                p.Value = templateId;
               
                connection.Open();
                SqlDataReader reader = command.ExecuteReader();
                dt.Load(reader);
                reader.Close();
            }
            return dt;
        }

        DataTable IPropertyByAgentCubeRepository.getRealLivingClosingsPrior(string monthYear)
        {
            DataTable dt = new DataTable();
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                SqlCommand command = new SqlCommand("RPT_RealLiving_ClosingsPrior", connection);
                command.CommandType = CommandType.StoredProcedure;
                command.CommandTimeout = 0;

                SqlParameter p;
                p = command.Parameters.Add("@monthYear", SqlDbType.NVarChar, 100);
                p.Value = monthYear;

                connection.Open();
                SqlDataReader reader = command.ExecuteReader();
                dt.Load(reader);
                reader.Close();
            }
            return dt;
        }

        DataTable IPropertyByAgentCubeRepository.getRealLivingMonthly(string monthYear)
        {
            DataTable dt = new DataTable();
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                SqlCommand command = new SqlCommand("RPT_RealLiving_MonthlyReporting", connection);
                command.CommandType = CommandType.StoredProcedure;
                command.CommandTimeout = 0;

                SqlParameter p;
                p = command.Parameters.Add("@monthYear", SqlDbType.NVarChar, 100);
                p.Value = monthYear;

                connection.Open();
                SqlDataReader reader = command.ExecuteReader();
                dt.Load(reader);
                reader.Close();
            }
            return dt;
        }
    }
}

```
## PropertyCubeRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class PropertyCubeRepository : BaseRepository, IPropertyCubeRepository
    {
        public PropertyCubeRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        PropertyCube IPropertyCubeRepository.getFieldsSelected(int propertyId,int correspondenceTemplateId, int formType)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
               return  connection.QueryFirstOrDefault<PropertyCube>("[property_cube_get_fieldsSelected]",
                                                                                                              new
                                                                                                              {
                                                                                                                  propertyId = propertyId,
                                                                                                                  correspondenceTemplateId = correspondenceTemplateId,
                                                                                                                  formType = formType
                                                                                                              },
                                                                                                              commandType: CommandType.StoredProcedure, commandTimeout: 0);            }
        }

        PropertyCube IPropertyCubeRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<PropertyCube>("property_cube_get", new { propertyId = id }, commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }

        DataTable IPropertyCubeRepository.processFormulas(int templateId, int propertyId, int personId, string side)
        {
            DataTable dt = new DataTable();
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                SqlCommand command = new SqlCommand("correspondencetemplate_process_formula", connection);
                command.CommandType = CommandType.StoredProcedure;
                command.CommandTimeout = 0;

                SqlParameter p;
                p = command.Parameters.Add("@propertyId", SqlDbType.NVarChar, 100);
                p.Value = propertyId;
                p = command.Parameters.Add("@personId", SqlDbType.NVarChar, 100);
                p.Value = personId;
                p = command.Parameters.Add("@side", SqlDbType.NVarChar, 2);
                p.Value = side;
                p = command.Parameters.Add("@templateId", SqlDbType.Int);
                p.Value = templateId;

                connection.Open();
                SqlDataReader reader = command.ExecuteReader();
                dt.Load(reader);
                reader.Close();
            }
            return dt;
        }
    }
}

```
## PropertyCustomFieldRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    

    public class PropertyCustomFieldRepository : BaseRepository, IPropertyCustomFieldRepository
    {
        public PropertyCustomFieldRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<PropertyCustomField> IPropertyCustomFieldRepository.search(int propertyId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<PropertyCustomField>("property_customField_search", new {propertyId = propertyId }, commandType: CommandType.StoredProcedure).ToList();
            }
        }       

        int IPropertyCustomFieldRepository.add(PropertyCustomField item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("property_customField_add",
                    new
                    {
                        propertyId = item.propertyId,
                        fieldId = item.fieldId,
                        fieldValue = item.fieldValue
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IPropertyCustomFieldRepository.update(PropertyCustomField item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("property_customField_update",
                    new
                    {
                        customFieldId = item.customFieldId,
                        fieldValue = item.fieldValue
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IPropertyCustomFieldRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("property_customField_delete", new { customFieldId = id }, commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## PropertyDeductionHistoryRepository.cs
```cs
using System.Collections.Generic;
using System.Linq;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using AT.AT2017.Api.Core.Models;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class PropertyDeductionHistoryRepository : BaseRepository, IPropertyDeductionHistoryRepository
    {


        public PropertyDeductionHistoryRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<PropertyDeductionHistory> IPropertyDeductionHistoryRepository.search(int propertyDeductionId, int deductionId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<PropertyDeductionHistory>("property_deduction_history_search",
                 new
                 {
                     propertyDeductionId = propertyDeductionId,
                     deductionId = deductionId
                 },
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }
    }
       
}

```
## PropertyDeductionOverrideRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class PropertyDeductionOverrideRepository : BaseRepository, IPropertyDeductionOverrideRepository
    {
        public PropertyDeductionOverrideRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<PropertyDeductionOverride> IPropertyDeductionOverrideRepository.search(int propertyId, int propertyDeductionId, int personOverrideId, bool applyTaxes, decimal? taxCollected)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<PropertyDeductionOverride>("property_deduction_override_search",
                   new
                   {
                       propertyId,
                       propertyDeductionId,
                       personOverrideId,
                       applyTaxes,
                       taxCollected
                   },
                   commandType: CommandType.StoredProcedure).ToList();
            }
        }

        PropertyDeductionOverride IPropertyDeductionOverrideRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<PropertyDeductionOverride>("property_deduction_override_get", new { propertyOverrideId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int IPropertyDeductionOverrideRepository.add(PropertyDeductionOverride item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("property_deduction_override_add",
                    new
                    {
                        personAgentId = item.personAgentId,
                        propertyDeductionId = item.propertyDeductionId,
                        person3rdPartyId = item.person3rdPartyId,
                        personOverrideId = item.personOverrideId,
                        accountId = item.accountId,
                        percentage = item.percentage,
                        amount = item.amount,
                        officeId = item.officeId,
                        overrideTypeId = item.overrideTypeId,
                        unlocked = item.unlocked,
                        basedOn = item.basedOn
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IPropertyDeductionOverrideRepository.update(PropertyDeductionOverride item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("property_deduction_override_update",
                    new
                    {
                        propertyOverrideId = item.propertyOverrideId,
                        propertyDeductionId = item.propertyDeductionId,
                        person3rdPartyId = item.person3rdPartyId,
                        personAgentId = item.personAgentId,
                        personOverrideId = item.personOverrideId,
                        accountId = item.accountId,
                        percentage = item.percentage,
                        amount = item.amount,
                        officeId = item.officeId,
                        overrideTypeId = item.overrideTypeId,
                        unlocked = item.unlocked,
                        basedOn = item.basedOn
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IPropertyDeductionOverrideRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("property_deduction_override_delete", new { propertyOverrideId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        void IPropertyDeductionOverrideRepository.refresh(int propertyId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("property_deduction_override_refresh", new { @propertyId = propertyId }, commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
         
        }

    }
}

```
## PropertyDeductionRepository.cs
```cs
using System.Collections.Generic;
using System.Linq;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;
using Hangfire;
using Hangfire.Storage;
using System.Threading;
using Hangfire.Server;
using System;

namespace AT.AT2017.Api.Repositories
{
    public class PropertyDeductionRepository : BaseRepository, IPropertyDeductionRepository
    {
        private IBackgroundJobClient _backgroundJobs;
        private IPersonTotalRepository _personTotalRepository;

        public PropertyDeductionRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings, IPersonTotalRepository personTotalRepository, IBackgroundJobClient backgroundJobs) : base(httpContextAccessor, appSettings)
        {
            _backgroundJobs = backgroundJobs;
            _personTotalRepository = personTotalRepository;
        }

        IEnumerable<PropertyDeduction> IPropertyDeductionRepository.search(int propertyId, string side, bool applyTaxes, decimal? taxCollected)
        {
            // get list of agents
            List<PropertyDeduction> agents = searchRecords(propertyId, side, applyTaxes, taxCollected);

            // stop long running jobs (older than 2 minutes)
            foreach(PropertyDeduction agent in agents)
            {
                if (agent.recalculateJobDate != null && agent.recalculateJobDate.Value.Subtract(DateTime.Now).TotalMinutes > 2)
                {
                    // stop background job
                    stopBackgroundJob(agent.propertyId, agent.personId, agent.recalculateJobID.ToString(), connectionString);

                    // reset recalculate fields
                    agent.recalculateJobDate = null;
                    agent.recalculateJobID = null;
                }
            }

            return agents;
        }

        PropertyDeduction IPropertyDeductionRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<PropertyDeduction>("property_deduction_get", new { propertyDeductionId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int IPropertyDeductionRepository.add(PropertyDeduction item, bool recalculateInParallel, bool updateTotals)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                // get list of existing property deduction records
                List<PropertyDeduction> existingAgents = searchRecords(item.propertyId);

                // add property deduction
                int id = connection.ExecuteScalar<int>("property_deduction_add",
                    new
                    {
                        propertyId = item.propertyId,
                        side = item.side,
                        columnNumber = item.columnNumber,
                        personId = item.personId,
                        grossPercent = item.grossPercent,
                        grossCommission = item.grossCommission,
                        deduct1Flat = item.deduct1Flat,
                        deduct1Amount = item.deduct1Amount,
                        deduct2Flat = item.deduct2Flat,
                        deduct2Amount = item.deduct2Amount,
                        deduct3Flat = item.deduct3Flat,
                        deduct3Amount = item.deduct3Amount,
                        deduct4Flat = item.deduct4Flat,
                        deduct4Amount = item.deduct4Amount,
                        deduct5Flat = item.deduct5Flat,
                        deduct5Amount = item.deduct5Amount,
                        deduct6Flat = item.deduct6Flat,
                        deduct6Amount = item.deduct6Amount,
                        deduct7Flat = item.deduct7Flat,
                        deduct7Amount = item.deduct7Amount,
                        deduct8Flat = item.deduct8Flat,
                        deduct8Amount = item.deduct8Amount,
                        deduct9Flat = item.deduct9Flat,
                        deduct9Amount = item.deduct9Amount,
                        deduct10Flat = item.deduct10Flat,
                        deduct10Amount = item.deduct10Amount,
                        deduct11Flat = item.deduct11Flat,
                        deduct11Amount = item.deduct11Amount,
                        deduct12Flat = item.deduct12Flat,
                        deduct12Amount = item.deduct12Amount,
                        regionalPercent = item.regionalPercent,
                        billDeductFlat = item.billDeductFlat,
                        billDeductAmount = item.billDeductAmount,
                        thirdPartyAmount = item.thirdPartyAmount,
                        finalSplitPercent = item.finalSplitPercent,
                        taxExempt=item.taxExempt
                    },
                    commandType: CommandType.StoredProcedure);

                // recalculate deductions when is needed
                recalculateDeductions(item.propertyId, item.side, existingAgents, recalculateInParallel, false, updateTotals);

                return id;
            }
        }
        
        void IPropertyDeductionRepository.update(PropertyDeduction item, string deductCodeUpdated, bool enableFlat, bool recalculateInParallel, bool updateTotals)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {

                // get list of existing property deduction records
                List<PropertyDeduction> existingAgents = searchRecords(item.propertyId);

                // update property deduction
                int id = connection.ExecuteScalar<int>("property_deduction_update",
                    new
                    {
                        item.propertyDeductionId,
                        item.propertyId,
                        item.side,
                        item.columnNumber,
                        item.personId,
                        item.grossPercent,
                        item.grossCommission,
                        item.deduct1Flat,
                        item.deduct1Amount,
                        item.deduct2Flat,
                        item.deduct2Amount,
                        item.deduct3Flat,
                        item.deduct3Amount,
                        item.deduct4Flat,
                        item.deduct4Amount,
                        item.deduct5Flat,
                        item.deduct5Amount,
                        item.deduct6Flat,
                        item.deduct6Amount,
                        item.deduct7Flat,
                        item.deduct7Amount,
                        item.deduct8Flat,
                        item.deduct8Amount,
                        item.deduct9Flat,
                        item.deduct9Amount,
                        item.deduct10Flat,
                        item.deduct10Amount,
                        item.deduct11Flat,
                        item.deduct11Amount,
                        item.deduct12Flat,
                        item.deduct12Amount,
                        item.regionalPercent,
                        item.billDeductFlat,
                        item.billDeductAmount,
                        item.thirdPartyAmount,
                        item.finalSplitPercent,
                        item.onlyAward,
                        deductCodeUpdated,
                        enableFlat,
                        item.taxExempt
                    },
                    commandType: CommandType.StoredProcedure);

                if (enableFlat == false && item.onlyAward == false) {
                    bool force = !string.IsNullOrEmpty(deductCodeUpdated);
                    // recalculate deductions when is needed
                    recalculateDeductions(item.propertyId, item.side, existingAgents, recalculateInParallel, force, updateTotals, item.propertyDeductionId, deductCodeUpdated);
                }
            }
        }

        void IPropertyDeductionRepository.delete(int id, int propertyId, string side, bool recalculateInParallel, bool updateTotals)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                // get list of existing property deduction records
                List<PropertyDeduction> existingAgents = searchRecords(propertyId);

                // delete property deduction
                connection.ExecuteScalar<int>("property_deduction_delete", new { propertyDeductionId = id }, commandType: CommandType.StoredProcedure);

                // recalculate deductions when is needed
                recalculateDeductions(propertyId, side, existingAgents, recalculateInParallel, false, updateTotals);
            }
        }

        void IPropertyDeductionRepository.recalculate(int propertyId, string side, bool inParallel, bool force, bool restart, bool updateTotals)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                // get list of existing agents
                List<PropertyDeduction> existingAgents = searchRecords(propertyId, side);

                // if there are jobs already running:
                // * when force = true, continue with this process, stop existing jobs and create new ones
                // * when force = false, exit without create new background jobs
                List<int?> runningJobs = existingAgents.Where(p => p.recalculateJobID != null).Select(p => p.recalculateJobID).ToList();
                if (runningJobs.Count == 0 || (runningJobs.Count > 0 && force == true))
                {
                    // fix commission data
                    connection.Execute("property_fix_commission_data",
                        new
                        {
                            propertyID = propertyId,
                            recalculateDeductions = 0
                        }, commandType: CommandType.StoredProcedure);

                    // recalculate deductions always
                    recalculateDeductions(propertyId, side, existingAgents, inParallel, force, updateTotals);
                }
            }
        }

        string IPropertyDeductionRepository.calculateBillDeduct(int personId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                string amount = connection.ExecuteScalar<string>("property_deduction_billDeduct", new { personId = personId }, commandType: CommandType.StoredProcedure);
                return amount;
            }
        }

        IEnumerable<Invoice> IPropertyDeductionRepository.searchPropertyDeductionAgentsInvoices(int propertyId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<Invoice>("property_deduction_billDeducts_invoices",
                    new
                    {
                        propertyId = propertyId
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        void IPropertyDeductionRepository.updateAgentOffice(PropertyDeduction item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("property_deduction_updateAgentOffice",
                    new
                    {
                        item.propertyDeductionId,item.agentOfficeId
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        public List<PropertyDeduction> searchRecords(int propertyId, string side = "", bool applyTaxes = false, decimal? taxCollected = null)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<PropertyDeduction>("property_deduction_search",
                    new
                    {
                        propertyId,
                        side,
                        applyTaxes,
                        taxCollected
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        public void recalculateDeductionsAsync(int propertyId, int personId, int listColumnNumber, int sellColumnNumber, DateTime processDate, string deductCodeUpdated, bool updateTotals, string connectionString, PerformContext context)
        {
            var jobId = context.BackgroundJob.Id;

            using (SqlConnection connection = new SqlConnection(connectionString))
            {
                string errorMessage = "";

                try
                {
                    // list side
                    if (listColumnNumber > 0)
                    {
                        connection.Execute("property_calculateDeductions",
                            new
                            {
                                propertyID = propertyId,
                                side = "L",
                                column = listColumnNumber,
                                processDate,
                                jobId,
                                deductCode = deductCodeUpdated
                            },
                        commandType: CommandType.StoredProcedure, commandTimeout: 60 * 5);

                        if (updateTotals)
                        {
                            _personTotalRepository.updateOnCustomCase(personId, processDate.ToString("yyyy-MM-dd HH:mm:ss.ms"), "comm recalc", propertyId, connectionString);
                        }
                    }

                    // sell side
                    if (sellColumnNumber > 0)
                    {
                        connection.Execute("property_calculateDeductions",
                            new
                            {
                                propertyID = propertyId,
                                side = "S",
                                column = sellColumnNumber,
                                processDate,
                                jobId,
                                deductCode = deductCodeUpdated
                            },
                        commandType: CommandType.StoredProcedure, commandTimeout: 60 * 5);

                        if(updateTotals) {
                            _personTotalRepository.updateOnCustomCase(personId, processDate.ToString("yyyy-MM-dd HH:mm:ss.ms"), "comm recalc", propertyId, connectionString);
                        }
                    }
                }
                catch (Exception ex)
                {
                    errorMessage = ex.Message;
                }

                // reset recalculateJobId
                connection.Execute("property_deduction_reset_recalculate_jobid",
                    new
                    {
                        propertyId,
                        personId,
                        jobId,
                        errorMessage
                    },
                commandType: CommandType.StoredProcedure);
            }
        }

        private void stopBackgroundJob(int propertyId, int personId, string jobId, string connectionString)
        {
            try
            {
                // stop and delete hangfire job
                BackgroundJob.Delete(jobId);

                // reset recalculateJobId in propertyDeduction
                using(SqlConnection connection = new SqlConnection(base.connectionString))
                {
                    connection.Execute("property_deduction_reset_recalculate_jobid",
                        new
                        {
                            propertyId,
                            personId,
                            jobId
                        },
                    commandType: CommandType.StoredProcedure);
                }
            }
            catch (Exception)
            {
                // do nothing
            }
        }

        public void recalculateDeductions(int propertyId, string side, List<PropertyDeduction> existingAgents, bool inParallel, bool force, bool updateTotals, int propertyDeductionId = 0, string deductCodeUpdated = "")
        {
            // force = true, recalculate always (not only when grossCommission has changed)

            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                // processDate
                DateTime processDate = DateTime.Now;

                // get new list of property deduction records
                List<PropertyDeduction> agents = searchRecords(propertyId);

                // filter existingAgents and agents lists if deductCodeUpdated is not null or empty
                if (!string.IsNullOrEmpty(deductCodeUpdated))
                {
                    existingAgents = existingAgents.Where(p => p.propertyDeductionId == propertyDeductionId).ToList();
                    agents = agents.Where(p => p.propertyDeductionId == propertyDeductionId).ToList();
                }

                if (inParallel)
                {
                    // create list of background jobs
                    List<string> jobs = new List<string>();

                    // get list of personID (distinct) in agents
                    List<int> personIDList = agents.Select(p => p.personId).Distinct().ToList();

                    // declare iteration variable
                    PropertyDeduction listAgent;
                    PropertyDeduction sellAgent;
                    PropertyDeduction existingListAgent;
                    PropertyDeduction existingSellAgent;
                    int listColumnNumber;
                    int sellColumnNumber;

                    // iterate persons to recalculate deductions
                    foreach (int personId in personIDList)
                    {
                        // reset variables
                        listAgent = null;
                        sellAgent = null;
                        existingListAgent = null;
                        existingSellAgent = null;
                        listColumnNumber = 0;
                        sellColumnNumber = 0;

                        // search record in agents list
                        listAgent = agents.FirstOrDefault(p => p.personId == personId && p.side.ToUpper() == "L");
                        sellAgent = agents.FirstOrDefault(p => p.personId == personId && p.side.ToUpper() == "S");

                        // search list existing agent
                        if (listAgent != null)
                            existingListAgent = existingAgents.FirstOrDefault(p => p.propertyDeductionId == listAgent.propertyDeductionId);

                        // search sell existing agent
                        if (sellAgent != null)
                            existingSellAgent = existingAgents.FirstOrDefault(p => p.propertyDeductionId == sellAgent.propertyDeductionId);

                        // set listColumnNumber and sellColumnNumber
                        if (listAgent != null && sellAgent != null) // * when personID exists in both sides
                        {
                            // evaluate if grossCommission has changed or not
                            if (existingListAgent == null || existingListAgent.grossCommission != listAgent.grossCommission || force == true)
                            {
                                // LIST agent is new or grossCommission has changed
                                listColumnNumber = listAgent.columnNumber;
                                sellColumnNumber = sellAgent.columnNumber;
                            }
                            else
                            {
                                // SELL agent is new or grossCommission has changed
                                if (existingSellAgent == null || existingSellAgent.grossCommission != sellAgent.grossCommission || force == true)
                                    sellColumnNumber = sellAgent.columnNumber;
                            }
                        }
                        else // * when personID exists only in list or sell side
                        {
                            if (listAgent != null)
                                if (existingListAgent == null || existingListAgent.grossCommission != listAgent.grossCommission || force == true)
                                    listColumnNumber = listAgent.columnNumber;

                            if (sellAgent != null)
                                if (existingSellAgent == null || existingSellAgent.grossCommission != sellAgent.grossCommission || force == true)
                                    sellColumnNumber = sellAgent.columnNumber;
                        }

                        // create background job if listColumnNumber or sellColumnNumber are different to 0
                        if (listColumnNumber != 0 || sellColumnNumber != 0)
                        {
                            // stop running job if exists
                            string runningJobId = "";
                            if (listAgent != null && listAgent.recalculateJobID != null)
                            {
                                runningJobId = listAgent.recalculateJobID.ToString();
                            }
                            else if (sellAgent != null && sellAgent.recalculateJobID != null)
                            {
                                runningJobId = sellAgent.recalculateJobID.ToString();
                            }

                            if (!string.IsNullOrEmpty(runningJobId))
                            {
                                stopBackgroundJob(propertyId, personId, runningJobId, connectionString);
                            }

                            // enqueue job
                            string jobId = _backgroundJobs.Enqueue(() => recalculateDeductionsAsync(propertyId, personId, listColumnNumber, sellColumnNumber, processDate, deductCodeUpdated, updateTotals, connectionString, null));

                            // add jobId to list in memory
                            jobs.Add(jobId);

                            // save jobId in propertyDeduction
                            connection.Execute("property_deduction_update_recalculate_jobid",
                                new
                                {
                                    propertyId,
                                    personId,
                                    jobId
                                }, commandType: CommandType.StoredProcedure);
                        }
                        
                    }
                }
                else
                {
                    // agents list is sorted by side and columnNumber already
                    foreach (PropertyDeduction agent in agents)
                    {
                        PropertyDeduction existingAgent = existingAgents.FirstOrDefault(p => p.propertyDeductionId == agent.propertyDeductionId);
                        if (existingAgent == null || existingAgent.grossCommission != agent.grossCommission || force == true)
                        {
                            connection.Execute("property_calculateDeductions",
                               new
                               {
                                   propertyID = propertyId,
                                   agent.side,
                                   column = agent.columnNumber,
                                   processDate,
                                   jobId = 0,
                                   deductCode = deductCodeUpdated
                               },
                               commandType: CommandType.StoredProcedure, commandTimeout: 60 * 5);

                            if (updateTotals)
                            {
                                _personTotalRepository.updateOnCustomCase(agent.personId, processDate.ToString("yyyy-MM-dd HH:mm:ss.ms"), "comm recalc", propertyId, base.connectionString);
                            }
                        }
                    }
                }

                // disable needRecalc
                connection.Execute("property_update_needrecalc_disable",
                    new
                    {
                        propertyId
                    },
                commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## PropertyDocumentHistoryRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class PropertyDocumentHistoryRepository : BaseRepository, IPropertyDocumentHistoryRepository
    {
        public PropertyDocumentHistoryRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<PropertyDocument> IPropertyDocumentHistoryRepository.search(int documentId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<PropertyDocument>("propertyDocumentHistory_search",
                 new
                 {
                     documentId
                 },
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }

        int IPropertyDocumentHistoryRepository.add(int documentId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("propertyDocumentHistory_add",
                    new
                    {
                        documentId
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

    }
}

```
## PropertyDocumentRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class PropertyDocumentRepository : BaseRepository, IPropertyDocumentRepository
    {
        public PropertyDocumentRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<PropertyDocument> IPropertyDocumentRepository.search(int propertyID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<PropertyDocument>("propertyDocument_search",
                 new
                 {
                     propertyID
                 },
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }

        PropertyDocument IPropertyDocumentRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<PropertyDocument>("propertyDocument_get", new { documentID = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int IPropertyDocumentRepository.add(PropertyDocument item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("propertyDocument_add",
                    new
                    {
                        item.description,
                        item.showSeller,
                        item.showBuyer,
                        item.showListAgent,
                        item.showSellAgent,
                        item.propertyID,
                        item.url,
                        item.views,
                        item.fileName
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IPropertyDocumentRepository.update(PropertyDocument item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("propertyDocument_update",
                    new
                    {
                        item.documentID,
                        item.fileName,
                        item.description,
                        item.showSeller,
                        item.showBuyer,
                        item.showListAgent,
                        item.showSellAgent,
                        
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IPropertyDocumentRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("propertyDocument_delete", new { documentID = id }, commandType: CommandType.StoredProcedure);
            }
        }

        void IPropertyDocumentRepository.delivery(int propertyId, string emailAddress)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("propertyDocument_delivery", new { propertyId, emailAddress }, commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## PropertyEmailRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class PropertyEmailRepository : BaseRepository, IPropertyEmailRepository
    {
        public PropertyEmailRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        PropertyEmail IPropertyEmailRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<PropertyEmail>("property_email_get", new { propertyId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        PropertyEmail IPropertyEmailRepository.getSuggestion(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<PropertyEmail>("property_email_suggestion", new { propertyId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int IPropertyEmailRepository.add(PropertyEmail item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("property_email_add",
                    item,
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        bool IPropertyEmailRepository.checkAvailability(PropertyEmail item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                var value = connection.QueryFirstOrDefault<PropertyEmail>("property_email_checkAvailability",
                    item,
                    commandType: CommandType.StoredProcedure);

                return value == null;
            }
        }

        void IPropertyEmailRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("property_email_delete", new { propertyFeatureId = id }, commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## PropertyExtraVoucherRepository.cs
```cs
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class PropertyExtraVoucherRepository : BaseRepository, IPropertyExtraVoucherRepository
    {
        public PropertyExtraVoucherRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<PropertyExtraVoucher> IPropertyExtraVoucherRepository.search(int propertyId, bool applyTaxes, decimal? taxCollected)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<PropertyExtraVoucher>("property_extraVoucher_search",
                   new
                   {
                       propertyId,
                       applyTaxes,
                       taxCollected
                   },
                   commandType: CommandType.StoredProcedure).ToList();
            }
        }

        PropertyExtraVoucher IPropertyExtraVoucherRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<PropertyExtraVoucher>("property_extraVoucher_get", new { propertyOverrideId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int IPropertyExtraVoucherRepository.add(PropertyExtraVoucher item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("property_extraVoucher_add",
                    new
                    {
                        amount = item.amount,
                        personId = item.personId,
                        propertyId = item.propertyId,
                        unlocked = item.unlocked,
                        extraVoucherId = item.extraVoucherId,
                        accountId = item.accountId,
                        officeId = item.officeId,
                        taxExempt = item.taxExempt
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IPropertyExtraVoucherRepository.update(PropertyExtraVoucher item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("property_extraVoucher_update",
                    new
                    {
                        propertyExtraVoucherId = item.propertyExtraVoucherId,
                        extraVoucherId = item.extraVoucherId,
                        propertyId = item.propertyId,
                        personId = item.personId,
                        officeId = item.officeId,
                        accountId = item.accountId,
                        amount = item.amount,
                        unlocked = item.unlocked,
                        taxExempt = item.taxExempt
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IPropertyExtraVoucherRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("property_extraVoucher_delete", new { propertyOverrideId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        void IPropertyExtraVoucherRepository.refresh(int propertyId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("property_extraVoucher_refresh", new { @propertyId = propertyId }, commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }
    }
}

```
## PropertyFeatureRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class PropertyFeatureRepository : BaseRepository, IPropertyFeatureRepository
    {
        public PropertyFeatureRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<PropertyFeature> IPropertyFeatureRepository.search(int propertyId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<PropertyFeature>("property_feature_search",
                   new
                   {
                       propertyId = propertyId
                   },
                   commandType: CommandType.StoredProcedure).ToList();
            }
        }

        PropertyFeature IPropertyFeatureRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<PropertyFeature>("property_feature_get", new { propertyFeatureId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int IPropertyFeatureRepository.add(PropertyFeature item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("property_feature_add",
                    new
                    {
                        propertyId = item.propertyId,
                        featureTypeId = item.featureTypeId,
                        confirmed = item.confirmed,
                        feedId = item.feedId
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IPropertyFeatureRepository.update(PropertyFeature item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("property_feature_update",
                    new
                    {
                        propertyFeatureId = item.propertyFeatureId,
                        propertyId = item.propertyId,
                        featureTypeId = item.featureTypeId,
                        confirmed = item.confirmed,
                        feedId = item.feedId
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IPropertyFeatureRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("property_feature_delete", new { propertyFeatureId = id }, commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## PropertyInternalMessageRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class PropertyInternalMessageRepository : BaseRepository, IPropertyInternalMessageRepository
    {
        public PropertyInternalMessageRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<PropertyInternalMessage> IPropertyInternalMessageRepository.search(int propertyId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<PropertyInternalMessage>("property_message_search",
                   new
                   {
                       propertyId = propertyId
                   },
                   commandType: CommandType.StoredProcedure).ToList();
            }
        }

        PropertyInternalMessage IPropertyInternalMessageRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<PropertyInternalMessage>("property_message_get", new { internalMessageId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int IPropertyInternalMessageRepository.add(PropertyInternalMessage item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("property_message_add",
                    new
                    {
                        propertyId = item.propertyId,
                        notes = item.notes
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IPropertyInternalMessageRepository.update(PropertyInternalMessage item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("property_message_update",
                    new
                    {
                        internalMessageId = item.internalMessageId,
                        notes = item.notes
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IPropertyInternalMessageRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("property_message_delete", new { internalMessageId = id }, commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## PropertyMlsRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using Dapper;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using System.Collections.Generic;
using System.Data;
using System.Data.SqlClient;
using System.Linq;

namespace AT.AT2017.Api.Repositories
{
    public class PropertyMlsRepository : BaseRepository, IPropertyMlsRepository
    {

        public PropertyMlsRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<PropertyMls> IPropertyMlsRepository.search(int propertyID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<PropertyMls>("property_mls_search",
                 new
                 {
                     propertyID
                 },
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }

        PropertyMls IPropertyMlsRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<PropertyMls>("property_mls_get",
                    new {
                        propertyMlsID = id
                    }, commandType: CommandType.StoredProcedure);
            }
        }

        int IPropertyMlsRepository.add(PropertyMls item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("property_mls_add",
                    new
                    {
                        item.propertyID,
                        item.mlsID,
                        item.feedSubTypeID,
                        item.dashMlsName
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IPropertyMlsRepository.update(PropertyMls item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("property_mls_update",
                    new
                    {
                        item.propertyMlsID,
                        item.propertyID,
                        item.mlsID,
                        item.feedSubTypeID,
                        item.dashMlsName
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IPropertyMlsRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("property_mls_delete",
                    new {
                        propertyMlsID = id
                    }, commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## PropertyOffsetRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using AT.AT2017.Api.Core.Models;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class PropertyOffsetRepository : BaseRepository, IPropertyOffsetRepository 
    {
        public PropertyOffsetRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<PropertyOffset> IPropertyOffsetRepository.search(string side)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<PropertyOffset>("property_offset_search",
                 new
                 {
                     side = side
                 },
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<PropertyOffset> IPropertyOffsetRepository.search_reversible()
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<PropertyOffset>("property_offset_search_reversible", null, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        PropertyOffset IPropertyOffsetRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<PropertyOffset>("property_offset_get", new { offsetId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        void IPropertyOffsetRepository.update(PropertyOffset item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("property_offset_update",
                    new
                    {
                        offsetId = item.propertyOffsetId,
                        side = item.side,
                        deduct1Offset = item.deduct1Offset,
                        deduct2Offset = item.deduct2Offset,
                        deduct3Offset = item.deduct3Offset,
                        deduct4Offset = item.deduct4Offset,
                        deduct5Offset = item.deduct5Offset,
                        deduct6Offset = item.deduct6Offset,
                        deduct7Offset = item.deduct7Offset,
                        deduct8Offset = item.deduct8Offset,
                        deduct9Offset = item.deduct9Offset,
                        deduct10Offset = item.deduct10Offset,
                        deduct11Offset = item.deduct11Offset,
                        deduct12Offset = item.deduct12Offset,
                        cobrokeOffset = item.cobrokeOffset,
                        thirdpartyOffset = item.thirdpartyOffset,
                        referralOffset = item.referralOffset,
                        netCommissionOffset = item.netCommissionOffset,
                        extraVoucherOffset = item.extraVoucherOffset
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }
    }
}

```
## PropertyOpenhouseRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class PropertyOpenhouseRepository : BaseRepository, IPropertyOpenhouseRepository
    {
        public PropertyOpenhouseRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<PropertyOpenhouse> IPropertyOpenhouseRepository.search(int propertyId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<PropertyOpenhouse>("property_openhouse_search",
                   new
                   {
                       propertyId = propertyId
                   },
                   commandType: CommandType.StoredProcedure).ToList();
            }
        }

        PropertyOpenhouse IPropertyOpenhouseRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<PropertyOpenhouse>("property_openhouse_get", new { propertyOpenhouseId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int IPropertyOpenhouseRepository.add(PropertyOpenhouse item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("property_openhouse_add",
                    new
                    {
                        propertyId = item.propertyId,
                        date = item.date,
                        time = item.time,
                        duration = item.duration,
                        notes = item.notes
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IPropertyOpenhouseRepository.update(PropertyOpenhouse item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("property_openhouse_update",
                    new
                    {
                        propertyOpenhouseId = item.propertyOpenhouseId,
                        date = item.date,
                        time = item.time,
                        duration = item.duration,
                        notes = item.notes,
                        done = item.done
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IPropertyOpenhouseRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("property_openhouse_delete", new { propertyOpenhouseId = id }, commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## PropertyPaymentOffTheTopRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using AT.AT2017.Api.Core.Models;
using System.Data;
using Dapper;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class PropertyPaymentOffTheTopRepository : BaseRepository, IPropertyPaymentOffTheTopRepository
    {
        public PropertyPaymentOffTheTopRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<PropertyPaymentOffTheTop> IPropertyPaymentOffTheTopRepository.search(int propertyId, int personId, bool includeCobroke, bool applyTaxes, decimal? taxCollected)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<PropertyPaymentOffTheTop>("property_paymentoffthetop_search",
                   new
                   {
                       propertyId,
                       personId,
                       includeCobroke,
                       applyTaxes,
                       taxCollected
                   },
                   commandType: CommandType.StoredProcedure).ToList();
            }
        }

        PropertyPaymentOffTheTop IPropertyPaymentOffTheTopRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<PropertyPaymentOffTheTop>("property_paymentoffthetop_get", new { topId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int IPropertyPaymentOffTheTopRepository.add(PropertyPaymentOffTheTop item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("property_paymentoffthetop_add",
                    new
                    {
                        propertyId = item.propertyId,
                        personId = item.personId,
                        side = item.side,
                        amount = item.amount,
                        offTheTopAgentName = item.offTheTopAgentName,
                        percent = item.percent,
                        taxExempt=item.taxExempt
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IPropertyPaymentOffTheTopRepository.update(PropertyPaymentOffTheTop item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("property_paymentoffthetop_update",
                    new
                    {
                        topId = item.topId,
                        propertyId = item.propertyId,
                        personId = item.personId,
                        side = item.side,
                        amount = item.amount,
                        offTheTopAgentName = item.offTheTopAgentName,
                        percent = item.percent,
                        taxExempt = item.taxExempt
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IPropertyPaymentOffTheTopRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("property_paymentoffthetop_delete", new { topId = id }, commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## PropertyPeopleRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class PropertyPeopleRepository : BaseRepository, IPropertyPeopleRepository
    {
        public PropertyPeopleRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<PropertyPeople> IPropertyPeopleRepository.search(int propertyId, string typeName, string side)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<PropertyPeople>("property_people_search",
                   new
                   {
                       propertyId = propertyId,
                       typeName = typeName,
                       side = side
                   },
                   commandType: CommandType.StoredProcedure).ToList();
            }
        }

        PropertyPeople IPropertyPeopleRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<PropertyPeople>("property_people_get", new { propertyPeopleId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int IPropertyPeopleRepository.add(PropertyPeople item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("property_people_add",
                    new
                    {
                        propertyId = item.propertyId,
                        personId = item.personId,
                        personTypeId = item.personTypeId,
                        side = item.side,
                        taxExempt = item.taxExempt 
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IPropertyPeopleRepository.update(PropertyPeople item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("property_people_update",
                    new
                    {
                        propertyPeopleId = item.propertyPeopleId,
                        propertyId = item.propertyId,
                        personID = item.personId,
                        personTypeId = item.personTypeId,
                        side = item.side,
                        confirmed = item.confirmed,
                        taxExempt = item.taxExempt
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IPropertyPeopleRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("property_people_delete", new { propertyPeopleId = id }, commandType: CommandType.StoredProcedure);
            }
        }
        
    }
}
```
## PropertyPictureRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using AT.AT2017.Api.Core.Models;
using System.Data.SqlClient;
using AT.AT2017.Api.DynamicParameters;

namespace AT.AT2017.Api.Repositories
{
    public class PropertyPictureRepository : BaseRepository, IPropertyPictureRepository
    {
        public PropertyPictureRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<PropertyPicture> IPropertyPictureRepository.search(int propertyId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<PropertyPicture>("property_picture_search",
                   new
                   {
                       propertyId
                   },
                   commandType: CommandType.StoredProcedure).ToList();
            }
        }

        PropertyPicture IPropertyPictureRepository.get(int pictureId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<PropertyPicture>("property_picture_get", new { pictureId }, commandType: CommandType.StoredProcedure);
            }
        }

        void IPropertyPictureRepository.add(IEnumerable<PropertyPicture> items)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                var tableParameter = new PropertyPicturetParameter(items);
                connection.Execute("property_picture_add", tableParameter, commandType: CommandType.StoredProcedure);
            }
        }

        void IPropertyPictureRepository.update(PropertyPicture item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("property_picture_update",
                    new
                    {
                        item.pictureId,
                        item.sequenceNumber,
                        item.description,
                        item.caption,
                        item.tags,
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IPropertyPictureRepository.delete(int pictureId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("property_picture_delete", new { pictureId }, commandType: CommandType.StoredProcedure);
            }
        }

        void IPropertyPictureRepository.delivery(int propertyId, string emailAddress)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("property_picture_delivery", new { propertyId, emailAddress }, commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## PropertyReimbursementRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class PropertyReimbursementRepository : BaseRepository, IPropertyReimbursementRepository
    {
        public PropertyReimbursementRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<PropertyReimbursement> IPropertyReimbursementRepository.search(int propertyId, bool applyTaxes, decimal? taxCollected)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<PropertyReimbursement>("property_reimbursement_search",
                   new
                   {
                       propertyId,
                       applyTaxes,
                       taxCollected
                   },
                   commandType: CommandType.StoredProcedure).ToList();
            }
        }

        PropertyReimbursement IPropertyReimbursementRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<PropertyReimbursement>("property_reimbursement_get", new { propertyReimbursementId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int IPropertyReimbursementRepository.add(PropertyReimbursement item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("property_reimbursement_add",
                    new
                    {
                        propertyId = item.propertyId,
                        personId = item.personId,
                        amount = item.amount,
                        flag1099 = item.flag1099,
                        taxExempt = item.taxExempt
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IPropertyReimbursementRepository.update(PropertyReimbursement item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("property_reimbursement_update",
                    new
                    {
                        propertyReimbursementId = item.propertyReimbursementId,
                        propertyId = item.propertyId,
                        personId = item.personId,
                        amount = item.amount,
                        flag1099 = item.flag1099
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IPropertyReimbursementRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("property_reimbursement_delete", new { propertyReimbursementId = id }, commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## PropertyRemarkRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class PropertyRemarkRepository : BaseRepository, IPropertyRemarkRepository
    {
        public PropertyRemarkRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<PropertyRemark> IPropertyRemarkRepository.search(int propertyId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<PropertyRemark>("property_remark_search",
                  new
                  {
                      propertyId = propertyId
                  },
                  commandType: CommandType.StoredProcedure).ToList();
            }
        }

        PropertyRemark IPropertyRemarkRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<PropertyRemark>("property_remark_get", new { propertyRemarkId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int IPropertyRemarkRepository.add(PropertyRemark item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("property_remark_add",
                    new
                    {
                        propertyId = item.propertyId,
                        remarkTypeID = item.remarkTypeId,
                        remarkText = item.remarkText,
                        confirmed = item.confirmed,
                        feedId = item.feedId
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IPropertyRemarkRepository.update(PropertyRemark item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("property_remark_update",
                    new
                    {
                        propertyRemarkId = item.propertyRemarkId,
                        propertyId = item.propertyId,
                        remarkTypeId = item.remarkTypeId,
                        remarkText = item.remarkText,
                        confirmed = item.confirmed,
                        feedId = item.feedId
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IPropertyRemarkRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("property_remark_delete", new { propertyRemarkId = id }, commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## PropertyReportRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using AT.AT2017.Api.Core.Model_Report;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class PropertyReportRepository : BaseRepository, IPropertyReportRepository
    {
        public PropertyReportRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<PropertyReport> IPropertyReportRepository.search(
            string propertyId,
            int officeID,
            int companyID,
            string showBasicInfo,
            string showAgentNetList,
            string showAgentNetSell,
            string showSellerInfo,
            string showBuyerInfo,
            string showPeople,
            string showFeatures,
            string showRemarks,
            string showRooms,
            string showMedia,
            string showOpenHouses,
            string showShowings,
            string showTasks,
            string showDocuments,
            string show3rdPartyPayments,
            string showReimbs,
            string showReferrals,
            string showExtravouchers,
            string showOverrides,
            string showAccounting,
            string showFinancing,
            string showCustomFields,
            string showDeleted,
            string statusToShow,
            int dateType,
            string dateStart,
            string dateEnd,
            string providerType,
            string listOffice,
            string sellOffice,
            string listAgent,
            string sellAgent,
            string sellerSendSurveyDelivery,
            string buyerSendSurveyDelivery,
            string personProviderType,
            int agentOfficeID,
            int agentID,

            int pageIndex,
            int pageSize
        ) {
            int showBasicInfo2 = (showBasicInfo.ToLower() == "true" || showBasicInfo == "1") ? 1 : 0;
            int showAgentNetList2 = (showAgentNetList.ToLower() == "true" || showAgentNetList == "1") ? 1 : 0;
            int showAgentNetSell2 = (showAgentNetSell.ToLower() == "true" || showAgentNetSell == "1") ? 1 : 0;
            int showSellerInfo2 = (showSellerInfo.ToLower() == "true" || showSellerInfo == "1") ? 1 : 0;
            int showBuyerInfo2 = (showBuyerInfo.ToLower() == "true" || showBuyerInfo == "1") ? 1 : 0;
            int showPeople2 = (showPeople.ToLower() == "true" || showPeople == "1") ? 1 : 0;
            int showFeatures2 = (showFeatures.ToLower() == "true" || showFeatures == "1") ? 1 : 0;
            int showRemarks2 = (showRemarks.ToLower() == "true" || showRemarks == "1") ? 1 : 0;
            int showRooms2 = (showRooms.ToLower() == "true" || showRooms == "1") ? 1 : 0;
            int showMedia2 = (showMedia.ToLower() == "true" || showMedia == "1") ? 1 : 0;
            int showOpenHouses2 = (showOpenHouses.ToLower() == "true" || showOpenHouses == "1") ? 1 : 0;
            int showShowings2 = (showShowings.ToLower() == "true" || showShowings == "1") ? 1 : 0;
            int showTasks2 = (showTasks.ToLower() == "true" || showTasks == "1") ? 1 : 0;
            int showDocuments2 = (showDocuments.ToLower() == "true" || showDocuments == "1") ? 1 : 0;
            int show3rdPartyPayments2 = (show3rdPartyPayments.ToLower() == "true" || show3rdPartyPayments == "1") ? 1 : 0;
            int showReimbs2 = (showReimbs.ToLower() == "true" || showReimbs == "1") ? 1 : 0;
            int showReferrals2 = (showReferrals.ToLower() == "true" || showReferrals == "1") ? 1 : 0;
            int showExtravouchers2 = (showExtravouchers.ToLower() == "true" || showExtravouchers == "1") ? 1 : 0;
            int showOverrides2 = (showOverrides.ToLower() == "true" || showOverrides == "1") ? 1 : 0;
            int showCustomFields2 = (showCustomFields.ToLower() == "true" || showCustomFields == "1") ? 1 : 0;
            int showDeleted2 = (showDeleted.ToLower() == "true" || showDeleted == "1") ? 1 : 0;
            int showAccounting2 = (showAccounting.ToLower() == "true" || showAccounting == "1") ? 1 : 0;
            int showFinancing2 = (showFinancing.ToLower() == "true" || showFinancing == "1") ? 1 : 0;           

            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                IEnumerable<PropertyReport> propertyReport = null;
                IEnumerable<PropertyBasicInfo> detailsBasicInfo = null;
                IEnumerable<PropertyDeductionInfo> detailsDeductionInfo = null;
                IEnumerable<PropertyDocumentInfo> detailsDocumentInfo = null;
                IEnumerable<PropertyFeatureInfo> detailsFeatureInfo = null;
                IEnumerable<PropertyMediaInfo> detailsMediaInfo = null;
                IEnumerable<PropertyOpenHousesInfo > detailsOpenHousesInfo = null;
                IEnumerable<PropertyBuyerInfo> detailsBuyerInfo = null;
                IEnumerable<PropertySellerInfo> detailsSellerInfo = null;
                IEnumerable<PropertyPeopleInfo> detailsPeopleInfo = null;
                IEnumerable<PropertyReferralsInfo> detailsReferralsInfo = null;
                IEnumerable<PropertyExtravoucherInfo> detailsExtravouchersInfo = null;
                IEnumerable<PropertyOverrideInfo> detailsOverridesInfo = null;
                IEnumerable<PropertyReimbsInfo> detailsReimbsInfo = null;
                IEnumerable<PropertyRemarkInfo> detailsRemarksInfo = null;
                IEnumerable<PropertyRoomInfo> detailsRoomInfo = null;
                IEnumerable<PropertyShowingInfo> detailsShowingInfo = null;
                IEnumerable<PropertyTaskInfo> detailsTaskInfo = null;
                IEnumerable<PropertyThirdPartyPaymentInfo> detailsThirdPartyPaymentInfo = null;
                IEnumerable<PropertyAccountingInfo> detailsAccountingInfo = null;
                IEnumerable<PropertyFinancingInfo> detailsFinancingInfo = null;
                IEnumerable<PropertyCustomFieldInfo> detailsCustomFieldInfo = null;

                try
                {
                    using (var multi = connection.QueryMultiple("property_report_search", new {
                                                        propertyId = propertyId,
                                                        officeID = officeID,
                                                        companyID = companyID,
                                                        showBasicInfo = showBasicInfo2,
                                                        showAgentNetList = showAgentNetList2,
                                                        showAgentNetSell = showAgentNetSell2,
                                                        showSellerInfo = showSellerInfo2,
                                                        showBuyerInfo = showBuyerInfo2,
                                                        showPeople = showPeople2,
                                                        showFeatures = showFeatures2,
                                                        showRemarks = showRemarks2,
                                                        showRooms = showRooms2,
                                                        showMedia = showMedia2,
                                                        showOpenHouses = showOpenHouses2,
                                                        showShowings = showShowings2,
                                                        showTasks = showTasks2,
                                                        showDocuments = showDocuments2,
                                                        show3rdPartyPayments = show3rdPartyPayments2,
                                                        showReimbs = showReimbs2,
                                                        showReferrals = showReferrals2,                                                      
                                                        showDeleted= showDeleted2,
                                                        showExtravouchers = showExtravouchers2,
                                                        showOverrides = showOverrides2,
                                                        showAccounting = showAccounting2,
                                                        showFinancing = showFinancing2,
                                                        showCustomFields = showCustomFields2,
                                                        listOffice=listOffice,
                                                        sellOffice=sellOffice,
                                                        listAgent=listAgent,
                                                        sellAgent=sellAgent,
                                                        sellerSendSurveyDelivery=sellerSendSurveyDelivery,
                                                        buyerSendSurveyDelivery = buyerSendSurveyDelivery,
                                                        statusToShow = statusToShow,
                                                        dateType = dateType,
                                                        dateStart= dateStart,
                                                        dateEnd = dateEnd,
                                                        providerType = providerType,
                                                        personProviderType = personProviderType,
                                                        agentOfficeID,
                                                        agentID,
                                                        pageIndex = pageIndex,
                                                        pageSize = pageSize

                                                    }, commandType: CommandType.StoredProcedure, commandTimeout: 0))
                    {
                        propertyReport = multi.Read<PropertyReport>().ToList();
                        if (showBasicInfo2 == 1)
                        {
                            detailsBasicInfo = multi.Read<PropertyBasicInfo>().ToList();

                            foreach (PropertyReport item in propertyReport)
                            {
                                if (detailsBasicInfo.Where(x => x.propertyID == item.propertyId).ToList().Count>0)
                                    item.propertyBasicInfo = detailsBasicInfo.Where(x => x.propertyID == item.propertyId).ToList();
                            }
                        }
                        if (showAgentNetList2 == 1 || showAgentNetSell2 == 1)
                        {
                            detailsDeductionInfo = multi.Read<PropertyDeductionInfo>().ToList();
                        }
                        if (showAgentNetList2 == 1)
                        {
                            foreach (PropertyReport item in propertyReport)
                            {
                                if (detailsDeductionInfo.Where(x => x.propertyID == item.propertyId && x.side == "L").ToList().Count > 0)
                                    item.propertyAgentListInfo  = detailsDeductionInfo.Where(x => x.propertyID == item.propertyId && x.side == "L").ToList();
                            }
                        }
                        if (showAgentNetSell2 == 1)
                        {
                            foreach (PropertyReport item in propertyReport)
                            {
                                if (detailsDeductionInfo.Where(x => x.propertyID == item.propertyId && x.side == "S").ToList().Count > 0)
                                    item.propertyAgentSellInfo = detailsDeductionInfo.Where(x => x.propertyID == item.propertyId && x.side == "S").ToList();
                            }
                        }
                        if (showBuyerInfo2 == 1)
                        {
                            detailsBuyerInfo = multi.Read<PropertyBuyerInfo>().ToList();

                            foreach (PropertyReport item in propertyReport)
                            {
                                if (detailsBuyerInfo.Where(x => x.propertyId == item.propertyId).ToList().Count > 0)
                                    item.propertyBuyerInfo = detailsBuyerInfo.Where(x => x.propertyId == item.propertyId).ToList();
                            }
                        }
                        if (showSellerInfo2 == 1)
                        {
                            detailsSellerInfo = multi.Read<PropertySellerInfo>().ToList();

                            foreach (PropertyReport item in propertyReport)
                            {
                                if (detailsSellerInfo.Where(x => x.propertyId == item.propertyId).ToList().Count > 0)
                                    item.propertySellerInfo = detailsSellerInfo.Where(x => x.propertyId == item.propertyId).ToList();
                            }
                        }

                        if (showPeople2 == 1)
                        {
                            detailsPeopleInfo = multi.Read<PropertyPeopleInfo>().ToList();

                            foreach (PropertyReport item in propertyReport)
                            {
                                if (detailsPeopleInfo.Where(x => x.propertyId == item.propertyId).ToList().Count > 0)
                                    item.propertyPeopleInfo = detailsPeopleInfo.Where(x => x.propertyId == item.propertyId).ToList();
                            }
                        }

                        if (showFeatures2 == 1)
                        {
                            detailsFeatureInfo = multi.Read<PropertyFeatureInfo>().ToList();

                            foreach (PropertyReport item in propertyReport)
                            {
                                if (detailsFeatureInfo.Where(x => x.propertyID == item.propertyId).ToList().Count > 0)
                                    item.propertyFeaturesInfo = detailsFeatureInfo.Where(x => x.propertyID == item.propertyId).ToList();
                            }
                        }
                        if (showRemarks2 == 1)
                        {
                            detailsRemarksInfo = multi.Read<PropertyRemarkInfo>().ToList();

                            foreach (PropertyReport item in propertyReport)
                            {
                                if (detailsRemarksInfo.Where(x => x.propertyID == item.propertyId).ToList().Count > 0)
                                    item.propertyRemarksInfo = detailsRemarksInfo.Where(x => x.propertyID == item.propertyId).ToList();
                            }
                        }
                        if (showRooms2 == 1)
                        {
                            detailsRoomInfo = multi.Read<PropertyRoomInfo>().ToList();

                            foreach (PropertyReport item in propertyReport)
                            {
                                if (detailsRoomInfo.Where(x => x.propertyID == item.propertyId).ToList().Count > 0)
                                    item.propertyRoomsInfo = detailsRoomInfo.Where(x => x.propertyID == item.propertyId).ToList();
                            }
                        }
                        if (showMedia2 == 1)
                        {
                            detailsMediaInfo = multi.Read<PropertyMediaInfo>().ToList();

                            foreach (PropertyReport item in propertyReport)
                            {
                                if (detailsMediaInfo.Where(x => x.propertyID == item.propertyId).ToList().Count > 0)
                                    item.propertyMediaInfo = detailsMediaInfo.Where(x => x.propertyID == item.propertyId).ToList();
                            }
                        }
                        if (showOpenHouses2 == 1)
                        {
                            detailsOpenHousesInfo = multi.Read<PropertyOpenHousesInfo>().ToList();

                            foreach (PropertyReport item in propertyReport)
                            {
                                if (detailsOpenHousesInfo.Where(x => x.propertyID == item.propertyId).ToList().Count > 0)
                                    item.propertyOpenHousesInfo = detailsOpenHousesInfo.Where(x => x.propertyID == item.propertyId).ToList();
                            }
                        }
                        if (showShowings2 == 1)
                        {
                            detailsShowingInfo = multi.Read<PropertyShowingInfo>().ToList();

                            foreach (PropertyReport item in propertyReport)
                            {
                                if (detailsShowingInfo.Where(x => x.propertyID == item.propertyId).ToList().Count > 0)
                                    item.propertyShowingsInfo = detailsShowingInfo.Where(x => x.propertyID == item.propertyId).ToList();
                            }
                        }
                        if (showTasks2 == 1)
                        {
                            detailsTaskInfo = multi.Read<PropertyTaskInfo>().ToList();

                            foreach (PropertyReport item in propertyReport)
                            {
                                if (detailsTaskInfo.Where(x => x.propertyID == item.propertyId).ToList().Count > 0)
                                    item.propertyTasksInfo = detailsTaskInfo.Where(x => x.propertyID == item.propertyId).ToList();
                            }
                        }
                        if (showDocuments2 == 1)
                        {
                            detailsDocumentInfo = multi.Read<PropertyDocumentInfo>().ToList();

                            foreach (PropertyReport item in propertyReport)
                            {
                                if (detailsDocumentInfo.Where(x => x.propertyID == item.propertyId).ToList().Count > 0)
                                    item.propertyDocumentsInfo = detailsDocumentInfo.Where(x => x.propertyID == item.propertyId).ToList();
                            }
                        }
                        if (show3rdPartyPayments2 == 1)
                        {
                            detailsThirdPartyPaymentInfo = multi.Read<PropertyThirdPartyPaymentInfo>().ToList();

                            foreach (PropertyReport item in propertyReport)
                            {
                                if (detailsThirdPartyPaymentInfo.Where(x => x.propertyId == item.propertyId).ToList().Count > 0)
                                    item.propertyThirdPartyPaymentsInfo = detailsThirdPartyPaymentInfo.Where(x => x.propertyId == item.propertyId).ToList();
                            }
                        }
                        if (showReimbs2 == 1)
                        {
                            detailsReimbsInfo = multi.Read<PropertyReimbsInfo>().ToList();

                            foreach (PropertyReport item in propertyReport)
                            {
                                if (detailsReimbsInfo.Where(x => x.propertyID == item.propertyId).ToList().Count > 0)
                                    item.propertyReimbsInfo = detailsReimbsInfo.Where(x => x.propertyID == item.propertyId).ToList();
                            }
                        }
                        if (showReferrals2 == 1)
                        {
                            detailsReferralsInfo = multi.Read<PropertyReferralsInfo>().ToList();

                            foreach (PropertyReport item in propertyReport)
                            {
                                if (detailsReferralsInfo.Where(x => x.propertyId == item.propertyId).ToList().Count > 0)
                                    item.propertyReferralsInfo = detailsReferralsInfo.Where(x => x.propertyId == item.propertyId).ToList();
                            }
                        }
                        if (showExtravouchers2 == 1)
                        {
                            detailsExtravouchersInfo = multi.Read<PropertyExtravoucherInfo>().ToList();

                            foreach (PropertyReport item in propertyReport)
                            {
                                if (detailsExtravouchersInfo.Where(x => x.propertyId == item.propertyId).ToList().Count > 0)
                                    item.propertyExtravouchersInfo = detailsExtravouchersInfo.Where(x => x.propertyId == item.propertyId).ToList();
                            }
                        }
                        if (showOverrides2 == 1)
                        {
                            detailsOverridesInfo = multi.Read<PropertyOverrideInfo>().ToList();

                            foreach (PropertyReport item in propertyReport)
                            {
                                if (detailsOverridesInfo.Where(x => x.propertyId == item.propertyId).ToList().Count > 0)
                                    item.propertyOverridesInfo = detailsOverridesInfo.Where(x => x.propertyId == item.propertyId).ToList();
                            }
                        }
                        if (showAccounting2 == 1)
                        {
                            detailsAccountingInfo = multi.Read<PropertyAccountingInfo>().ToList();

                            foreach (PropertyReport item in propertyReport)
                            {
                                if (detailsAccountingInfo.Where(x => x.propertyId == item.propertyId).ToList().Count > 0)
                                    item.propertyAccountingInfo = detailsAccountingInfo.Where(x => x.propertyId == item.propertyId).ToList();
                            }
                        }
                        if (showFinancing2 == 1)
                        {
                            detailsFinancingInfo = multi.Read<PropertyFinancingInfo>().ToList();

                            foreach (PropertyReport item in propertyReport)
                            {
                                if (detailsFinancingInfo.Where(x => x.propertyId == item.propertyId).ToList().Count > 0)
                                    item.propertyFinancingInfo = detailsFinancingInfo.Where(x => x.propertyId == item.propertyId).ToList();
                            }
                        }
                        if (showCustomFields2 == 1)
                        {
                            detailsCustomFieldInfo = multi.Read<PropertyCustomFieldInfo>().ToList();

                            foreach (PropertyReport item in propertyReport)
                            {
                                if (detailsCustomFieldInfo.Where(x => x.propertyId == item.propertyId).ToList().Count > 0)
                                    item.propertyCustomFieldInfo = detailsCustomFieldInfo.Where(x => x.propertyId == item.propertyId).ToList();
                            }
                        }
                    }
                }
                catch (Exception ex)
                {
                    if (ex.Message != "Sequence contains no elements")
                        throw ex;
                }
                return propertyReport;
            }
        }

        DataTable IPropertyReportRepository.searchSummary(string dateStart, string dateEnd, int companyID, int officeID, int pageIndex, int pageSize)
        {
            DataTable dt = new DataTable();

            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                SqlCommand command = new SqlCommand("property_report_search_summary", connection);
                command.CommandType = CommandType.StoredProcedure;
                command.CommandTimeout = 0;

                SqlParameter p;
                p = command.Parameters.Add("@companyID", SqlDbType.Int);
                p.Value = companyID;
                p = command.Parameters.Add("@officeID", SqlDbType.Int);
                p.Value = officeID;
                p = command.Parameters.Add("@dateStart", SqlDbType.VarChar, 20);
                p.Value = dateStart;
                p = command.Parameters.Add("@dateEnd", SqlDbType.VarChar, 20);
                p.Value = dateEnd;
                p = command.Parameters.Add("@pageIndex", SqlDbType.Int);
                p.Value = pageIndex;
                p = command.Parameters.Add("@pageSize", SqlDbType.Int);
                p.Value = pageSize;

                connection.Open();
                SqlDataReader reader = command.ExecuteReader();
                dt.Load(reader);
                reader.Close();

            }
            return dt;
        }
    }
}

```
## PropertyRepository.cs
```cs
using System.Collections.Generic;
using System.Linq;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using System.Data;
using Dapper;
using AT.AT2017.Api.DynamicParameters;
using System;
using System.Data.SqlClient;
using Hangfire;
using AT.AT2017.Api.Core.Shared;

namespace AT.AT2017.Api.Repositories
{
    public class PropertyRepository : BaseRepository, IPropertyRepository
    {
        private IBackgroundJobClient _backgroundJobs;

        public PropertyRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings, IBackgroundJobClient backgroundJobs) : base(httpContextAccessor, appSettings)
        {
            _backgroundJobs = backgroundJobs;
        }

        IEnumerable<Property> IPropertyRepository.search(int companyId, string filter, string address, string mls, string propId, string trType, int statusId, int propertyTypeId, int pageIndex, int pageSize, string sortedBy, string customCase, bool withTrash, string statusCode)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<Property>("property_search",
                   new
                   {
                       companyId = companyId,
                       filter = filter,
                       address = address,
                       mls = mls,
                       propId = propId,
                       trType = trType,
                       statusId = statusId,
                       propertyTypeId = propertyTypeId,
                       pageIndex = pageIndex,
                       pageSize = pageSize,
                       sortedBy = sortedBy,
                       custom = customCase,
                       withTrash = withTrash,
                       statusCode = statusCode
                   },
                   commandType: CommandType.StoredProcedure).ToList();
            }
        }

        PagedList<Property> IPropertyRepository.searchPaginated(int companyId, string filter, string address, string mls, string propId, string trType, int statusId, int propertyTypeId, int pageIndex, int pageSize, string sortedBy, string customCase, bool withTrash, string statusCode)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                PagedList<Property> page = null;

                using (var multi = connection.QueryMultiple("property_search",
                   new
                   {
                       companyId = companyId,
                       filter = filter,
                       address = address,
                       mls = mls,
                       propId = propId,
                       trType = trType,
                       statusId = statusId,
                       propertyTypeId = propertyTypeId,
                       pageIndex = pageIndex,
                       pageSize = pageSize,
                       sortedBy = sortedBy,
                       custom = customCase,
                       withTrash = withTrash,
                       statusCode = statusCode
                   },
                   commandType: CommandType.StoredProcedure))
                {
                    var data = multi.Read<Property>().ToList();
                    page = multi.Read<PagedList<Property>>().Single();
                    page.data = data;
                }

                return page;
            }
        }

        PagedList<PropertyMain> IPropertyRepository.advance_searchPaginated(int companyId, string address, string mls, string propertyId, string status, int propertyTypeId, string fromDate, string toDate, string qaControl1, string qaControl2, string buyer, string seller, string brokerReferenceNo, string escrowNo, int classificationId, int pageIndex, int pageSize, string filterBy, string trType, bool withTrash, string agent, int officeId, string escrowPayeeName, string sortBy, string filter1By)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                PagedList<PropertyMain> page = null;

                using (var multi = connection.QueryMultiple("property_advance_search_paginated",
                    new
                    {
                        companyId,
                        address,
                        mls,
                        propertyId,
                        status,
                        propertyTypeId,
                        fromDate,
                        toDate,
                        qaControl1,
                        qaControl2,
                        buyer,
                        seller,
                        brokerReferenceNo,
                        escrowNo,
                        classificationId,
                        pageIndex,
                        pageSize,
                        filterBy,
                        trType,
                        withTrash,
                        agent,
                        officeId,
                        escrowPayeeName,
                        sortBy,
                        filter1By
                    }, commandType: CommandType.StoredProcedure))
                {
                    page = multi.Read<PagedList<PropertyMain>>().Single();
                    page.data = multi.Read<PropertyMain>().ToList();
                }
                return page;
            }
        }

        IEnumerable<PropertyMain> IPropertyRepository.advance_search(int companyId, string address, string mls, string propId, string status,
           int propertyTypeId, string fromDate, string toDate, string qaControl1, string qaControl2, string buyer, string seller, string brokerReferenceNo,
            string escrowNo, int classificationId, int pageIndex, int pageSize, string filterBy, string trType, bool withTrash, string agent, int officeId, string escrowPayeeName)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<PropertyMain>("property_advance_search",
                    new
                    {
                        companyId = companyId,
                        address = address,
                        mls = mls,
                        propId = propId,
                        status = status,
                        propertyTypeId = propertyTypeId,
                        fromDate = fromDate,
                        toDate = toDate,
                        qaControl1 = qaControl1,
                        qaControl2 = qaControl2,
                        buyer = buyer,
                        seller = seller,
                        brokerReferenceNo = brokerReferenceNo,
                        escrowNo = escrowNo,
                        classificationId = classificationId,
                        pageIndex = pageIndex,
                        pageSize = pageSize,
                        filterBy = filterBy,
                        trType = trType,
                        withTrash = withTrash,
                        agent = agent,
                        officeId = officeId,
                        escrowPayeeName = escrowPayeeName
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<Property> IPropertyRepository.searchDeletedRecord(int pageIndex, int pageSize)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<Property>("property_search_deleted",
                    new
                    {
                        pageIndex = pageIndex,
                        pageSize = pageSize
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<Property> IPropertyRepository.searchByPerson(int personId, string status)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<Property>("property_search_byPerson",
                    new
                    {
                        personId = personId,
                        status = status
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        Property IPropertyRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<Property>("property_get", new { propertyId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int IPropertyRepository.add(Property item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("property_add",
                    new
                    {
                        streetNumber = item.streetNumber,
                        streetDirection = item.streetDirection,
                        streetName = item.streetName,
                        streetDesignation = item.streetDesignation,
                        streetSuffix = item.streetSuffix,
                        suiteAptNumber = item.suiteAptNumber,
                        buildingFloorNumber = item.buildingFloorNumber,
                        city = item.city,
                        state = item.state,
                        zip = item.zip,
                        listDate = item.listDate,
                        pendingDate = item.pendingDate,
                        mlsNumber1 = item.mlsNumber1,
                        statusID = item.statusId,
                        classificationID = item.classificationId,
                        companyID = item.companyID,
                        propertyTypeId = item.propertyTypeId,
                        estimatedClosingDate = item.estimatedClosingDate,
                        expiredDate = item.expiredDate,
                        typeCode = item.typeCode,
                        incomeTypeID = item.incomeTypeID
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IPropertyRepository.update(Property item, bool onlyUpdateCommission, bool refreshListSide, bool refreshSellSide, IPropertyDeductionRepository propertyDeductionRepository, bool recalculateInParallel, bool updateTotals)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {

                List<PropertyDeduction> existingAgents = propertyDeductionRepository.search(item.propertyId, "", false, null).ToList();

                List<PropertyDeduction> agents = connection.Query<PropertyDeduction>("property_update",
                    new
                    {
                        propertyId = item.propertyId,
                        propertyAddress = item.propertyAddress,
                        transactionGUID = item.transactionGUID,
                        person_CustomerId = item.person_CustomerId,
                        streetNumber = item.streetNumber,
                        streetDirection = item.streetDirection,
                        streetName = item.streetName,
                        streetDesignation = item.streetDesignation,
                        streetSuffix = item.streetSuffix,
                        suiteAptNumber = item.suiteAptNumber,
                        buildingFloorNumber = item.buildingFloorNumber,
                        city = item.city,
                        state = item.state,
                        zip = item.zip,
                        statusID = item.statusId,
                        excludeList = item.excludeList,
                        excludeSell = item.excludeSell,
                        special = item.special,
                        shortSale = item.shortSale,
                        forclosure = item.forclosure,
                        showOnInternet = item.showOnInternet,
                        showAddressOnInternet = item.showAddressOnInternet,
                        showPriceOnInternet = item.showPriceOnInternet,
                        hideListPriceOnWeb = item.hideListPriceOnWeb,
                        condo = item.condo,
                        condoFee = item.condoFee,
                        mlsNumber1 = item.mlsNumber1,
                        mlsNumber2 = item.mlsNumber2,
                        qaControl1 = item.qaControl1,
                        qaControl2 = item.qaControl2,
                        brokerReferenceNo = item.brokerReferenceNo,
                        escrowNo = item.escrowNo,
                        listDate = item.listDate,
                        expiredDate = item.expiredDate,
                        withdrawnDate = item.withdrawnDate,
                        pendingDate = item.pendingDate,
                        cancelDate = item.cancelDate,
                        cancelReasonId = item.cancelReasonId,
                        estimatedClosingDate = item.estimatedClosingDate,
                        sellerEnglishSurvey = item.sellerEnglishSurvey,
                        sellerDirectMail = item.sellerDirectMail,
                        sellerSendSurveyDelivery = item.sellerSendSurveyDelivery,
                        sellerSurveyDeliveryMethod = item.sellerSurveyDeliveryMethod,
                        buyerEnglishSurvey = item.buyerEnglishSurvey,
                        buyerDirectMail = item.buyerDirectMail,
                        buyerSendSurveyDelivery = item.buyerSendSurveyDelivery,
                        buyerSurveyDeliveryMethod = item.buyerSurveyDeliveryMethod,
                        keyNumber = item.keyNumber,
                        shackleCode = item.shackleCode,
                        notes = item.notes,
                        showingInstructionsInternal = item.showingInstructionsInternal,
                        directionsInternal = item.directionsInternal,
                        alternateListOfficeId = item.alternateListOfficeId,
                        alternateSellOfficeId = item.alternateSellOfficeId,
                        yearBuilt = item.yearBuilt,
                        lastSoldDate = item.lastSoldDate,
                        taxYear = item.taxYear,
                        taxRollNumber = item.taxRollNumber,
                        annualTaxes = item.annualTaxes,
                        numberOfAcres = item.numberOfAcres,
                        lotSize = item.lotSize,
                        squareFeet = item.squareFeet,
                        lotSizeUnitID = item.lotSizeUnitID,
                        squareFeetUnitID = item.squareFeetUnitID,
                        levelsCount = item.levelsCount,
                        transportation = item.transportation,
                        neigborhoodName = item.neigborhoodName,
                        propertyLocation = item.propertyLocation,
                        bedrooms = item.bedrooms,
                        escrowHeld = item.escrowHeld,
                        referralTypeId = item.referralTypeId,
                        transactionTypeId = item.transactionTypeId,
                        propertyTypeId = item.propertyTypeId,
                        propertyUseId = item.propertyUseId,
                        developmentId = item.developmentId,
                        classificationId = item.classificationId,
                        appraisalDate = item.appraisalDate,
                        inspectionDate = item.inspectionDate,
                        applicationDate = item.applicationDate,
                        loanRate = item.loanRate,
                        loanAmount = item.loanAmount,
                        financingTypeId = item.financingTypeId,
                        listingPrice = item.listingPrice,
                        sellingPrice = item.sellingPrice,
                        commissionPrice = item.commissionPrice,
                        isFlatCommission = item.isFlatCommission,
                        listCommRate = item.listCommRate,
                        listCommission = item.listCommission,
                        sellCommRate = item.sellCommRate,
                        sellCommission = item.sellCommission,
                        listingGUID = item.listingGUID,
                        payCobroke = item.payCobroke,
                        refListCommission = item.refListCommission,
                        refSellCommission = item.refSellCommission,
                        refListRate = item.refListRate,
                        refSellRate = item.refSellRate,
                        companyIncome = item.companyIncome,
                        balanceDue = item.balanceDue,
                        trans1 = item.trans1,
                        trans2 = item.trans2,
                        reimbursedDeposit = item.reimbursedDeposit,
                        additionalIncome = item.additionalincome,
                        processedDate = item.processedDate,
                        cobrokeCommRate = item.cobrokeCommRate,
                        cobrokeCommission = item.cobrokeCommission,
                        ourList = item.ourList,
                        ourSell = item.ourSell,
                        transactionNotes = item.transactionNotes,
                        offset = item.offset,
                        excludeFromSubmission = item.excludeFromSubmission,
                        excludeDuplicate = item.excludeDuplicate,
                        fullBaths = item.fullBaths,
                        halfBathsTotal = item.halfBathsTotal,
                        threeQuarterBathsTotal = item.threeQuarterBathsTotal,
                        quarterBathsTotal = item.quarterBathsTotal,
                        subDivision = item.subDivision,
                        statusLocked = item.statusLocked,
                        propertyStyleId = item.propertyStyleId,
                        onlyUpdateCommission = onlyUpdateCommission,
                        refreshListSide = refreshListSide,
                        refreshSellSide = refreshSellSide,
                        listAgentID = item.listAgentID,
                        sellAgentID = item.sellAgentID,
                        reactivate = item.reactivate,
                        sequenceNumber = item.sequenceNumber,
                        DASHTransactionGUID = item.DASHTransactionGUID,
                        typeCode = item.typeCode,
                        incomeTypeID = item.incomeTypeID,
                        rulesEnabled = item.rulesEnabled,
                        numOfRooms = item.numOfRooms,
                        parkingSpaces = item.parkingSpaces,
                        trade_LW = item.trade_LW,
                        listing_LW = item.listing_LW,
                        dotLoopID = item.dotLoopID,
                        eReloID = item.eRELOID,
                        skyslopeID = item.skySlopeID,
                        appFileID = item.appFileID,
                        taxCollected = item.taxCollected,
                        conditions = item.conditions,
                        conditionExpireDate = item.conditionExpireDate,
                        mlsBoardName = item.mlsBoardName,
                        guid1 = item.guid1,
                        guid2 = item.guid2,
                        guid3 = item.guid3,
                        emailAddress_BuySide = item.emailAddress_BuySide
                    },
                    commandType: CommandType.StoredProcedure).ToList();

                // recalculate deductions
                propertyDeductionRepository.recalculateDeductions(item.propertyId, "", existingAgents, recalculateInParallel, false, updateTotals);

            }
        }

        void IPropertyRepository.updateNeedRecalc(int propertyId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("property_update_needrecalc",
                    new
                    {
                        propertyId = propertyId
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IPropertyRepository.updateThirdPartyID(int propertyId, string thirdPartyIdField, string thirdPartyId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("property_update_thirdparty_id",
                    new
                    {
                        propertyId,
                        thirdPartyIdField,
                        thirdPartyId
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IPropertyRepository.updateAppFileID(int propertyId, int appFileID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("property_update_appfileID",
                    new
                    {
                        propertyId,
                        appFileID
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IPropertyRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("property_delete", new { propertyId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int IPropertyRepository.copy(int id, string copyType)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int newId = connection.ExecuteScalar<int>("property_copy", new { propertyId = id, copyType = copyType }, commandType: CommandType.StoredProcedure);

                return newId;
            }
        }

        void IPropertyRepository.unpost(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("property_unpost", new { propertyId = id }, commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }

        void IPropertyRepository.unpostRegional(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("property_unpost_regional", new { propertyId = id }, commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }

        IEnumerable<PropertyPostError> IPropertyRepository.validatePost(Property item, string postDateAccounting, string postDateArPayment, string postDateApPayment, string postDateDeposit, bool directDeposit, string checkNumber, int commissionAccountId, bool recordCommission, bool onePayment, string payment1, string payment2, string payment3, bool recordAsSingleDeposit, int depositAccountId, bool writeEscrowCheck, string escrowCheckNumber, bool payEscrowByForte, string deposits, bool excludeRules)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                var propertyParameter = new PropertyPostDynamicParameter(item, postDateAccounting, postDateArPayment, postDateApPayment, postDateDeposit, directDeposit, checkNumber, commissionAccountId, recordCommission, onePayment, payment1, payment2, payment3, recordAsSingleDeposit, depositAccountId, writeEscrowCheck, escrowCheckNumber, payEscrowByForte, deposits, excludeRules);

                return connection.Query<PropertyPostError>("property_post_validate", propertyParameter, commandType: CommandType.StoredProcedure, commandTimeout: 0).ToList();
            }

        }

        PropertyPostResult IPropertyRepository.post(Property item, string postDateAccounting, string postDateArPayment, string postDateApPayment, string postDateDeposit, bool directDeposit, string checkNumber, int commissionAccountId, bool recordCommission, bool onePayment, string payment1, string payment2, string payment3, bool recordAsSingleDeposit, int depositAccountId, bool writeEscrowCheck, string escrowCheckNumber, bool payEscrowByForte, string deposits, bool excludeRules)
        {
            PropertyPostResult result = null;
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                var propertyParameter = new PropertyPostDynamicParameter(item, postDateAccounting, postDateArPayment, postDateApPayment, postDateDeposit, directDeposit, checkNumber, commissionAccountId, recordCommission, onePayment, payment1, payment2, payment3, recordAsSingleDeposit, depositAccountId, writeEscrowCheck, escrowCheckNumber, payEscrowByForte, deposits, excludeRules);

                //return connection.Query<ApPayment>("property_post", propertyParameter, commandType: CommandType.StoredProcedure, commandTimeout: 0).ToList();
                using (var multi = connection.QueryMultiple("property_post", propertyParameter, commandType: CommandType.StoredProcedure, commandTimeout: 0))
                {
                    result = multi.ReadFirstOrDefault<PropertyPostResult>();
                    result.apPayments = multi.Read<ApPayment>().ToList();                 
                }
                return result;
            }
        }

        void IPropertyRepository.postRegional(Property item, string postDateAccounting)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                var propertyParameter = new PropertyPostRegionalDynamicParameter(item, postDateAccounting);

                int id = connection.ExecuteScalar<int>("property_post_regional", propertyParameter, commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }

        }

        IEnumerable<PropertyPostError> IPropertyRepository.validatePostRegional(Property item, string postDateAccounting)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                var propertyParameter = new PropertyPostRegionalDynamicParameter(item, postDateAccounting);

                return connection.Query<PropertyPostError>("property_post_regional_validate", propertyParameter, commandType: CommandType.StoredProcedure, commandTimeout: 0).ToList();
            }
        }

        void IPropertyRepository.updatePostInfo(Property item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                var propertyParameter = new PropertyDynamicParameter(item);

                int id = connection.ExecuteScalar<int>("property_update_postinfo", propertyParameter, commandType: CommandType.StoredProcedure);
            }
        }

        Invoice IPropertyRepository.previewInvoice(int id, string postDate)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                Invoice invoice = null;
                try
                {
                    using (var multi = connection.QueryMultiple("property_post_preview_invoice", new { propertyID = id, postDateAccounting = postDate }, commandType: CommandType.StoredProcedure))
                    {
                        invoice = multi.Read<Invoice>().Single();
                        invoice.detail = multi.Read<InvoiceDetail>().ToList();
                    }
                }
                catch (Exception ex)
                {
                    if (ex.Message != "Sequence contains no elements")
                        throw ex;
                }

                return invoice;
            }
        }

        IEnumerable<Voucher> IPropertyRepository.previewVoucherxAgent(int id, string postDate, decimal taxCollected)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                IEnumerable<Voucher> vouchers = null;
                IEnumerable<VoucherDetail> details = null;
                try
                {
                    using (var multi = connection.QueryMultiple("property_post_preview_vouchers_agents", new { propertyID = id, postDateAccounting = postDate, taxCollected = taxCollected }, commandType: CommandType.StoredProcedure))
                    {
                        vouchers = multi.Read<Voucher>().ToList();
                        details = multi.Read<VoucherDetail>().ToList();
                    }

                    foreach (Voucher item in vouchers)
                    {
                        item.detail = details.Where(x => x.voucherId == item.voucherId).ToList();
                    }
                }
                catch (Exception ex)
                {
                    if (ex.Message != "Sequence contains no elements")
                        throw ex;
                }

                return vouchers;
            }
        }

        IEnumerable<Voucher> IPropertyRepository.previewVoucherxExtraVoucher(int id, string postDate, decimal taxCollected)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                IEnumerable<Voucher> vouchers = null;
                IEnumerable<VoucherDetail> details = null;
                try
                {
                    using (var multi = connection.QueryMultiple("property_post_preview_vouchers_extravouchers", new { propertyID = id, postDateAccounting = postDate, taxCollected = taxCollected }, commandType: CommandType.StoredProcedure))
                    {
                        vouchers = multi.Read<Voucher>().ToList();
                        details = multi.Read<VoucherDetail>().ToList();
                    }

                    foreach (Voucher item in vouchers)
                    {
                        item.detail = details.Where(x => x.voucherId == item.voucherId).ToList();
                    }
                }
                catch (Exception ex)
                {
                    if (ex.Message != "Sequence contains no elements")
                        throw ex;
                }

                return vouchers;
            }
        }

        IEnumerable<Voucher> IPropertyRepository.previewVoucherxOverride(int id, string postDate, decimal taxCollected)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                IEnumerable<Voucher> vouchers = null;
                IEnumerable<VoucherDetail> details = null;
                try
                {
                    using (var multi = connection.QueryMultiple("property_post_preview_vouchers_overrides", new { propertyID = id, postDateAccounting = postDate, taxCollected = taxCollected }, commandType: CommandType.StoredProcedure))
                    {
                        vouchers = multi.Read<Voucher>().ToList();
                        details = multi.Read<VoucherDetail>().ToList();
                    }

                    foreach (Voucher item in vouchers)
                    {
                        item.detail = details.Where(x => x.voucherId == item.voucherId).ToList();
                    }
                }
                catch (Exception ex)
                {
                    if (ex.Message != "Sequence contains no elements")
                        throw ex;
                }

                return vouchers;
            }
        }

        IEnumerable<Voucher> IPropertyRepository.previewVoucherxReferral(int id, string postDate, decimal taxCollected)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                IEnumerable<Voucher> vouchers = null;
                IEnumerable<VoucherDetail> details = null;
                try
                {
                    using (var multi = connection.QueryMultiple("property_post_preview_vouchers_referrals", new { propertyID = id, postDateAccounting = postDate, taxCollected = taxCollected }, commandType: CommandType.StoredProcedure))
                    {
                        vouchers = multi.Read<Voucher>().ToList();
                        details = multi.Read<VoucherDetail>().ToList();
                    }

                    foreach (Voucher item in vouchers)
                    {
                        item.detail = details.Where(x => x.voucherId == item.voucherId).ToList();
                    }
                }
                catch (Exception ex)
                {
                    if (ex.Message != "Sequence contains no elements")
                        throw ex;
                }

                return vouchers;
            }
        }

        IEnumerable<Voucher> IPropertyRepository.previewVoucherxReimbursement(int id, string postDate, decimal taxCollected)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                IEnumerable<Voucher> vouchers = null;
                IEnumerable<VoucherDetail> details = null;
                try
                {
                    using (var multi = connection.QueryMultiple("property_post_preview_vouchers_reimbursements", new { propertyID = id, postDateAccounting = postDate, taxCollected = taxCollected }, commandType: CommandType.StoredProcedure))
                    {
                        vouchers = multi.Read<Voucher>().ToList();
                        details = multi.Read<VoucherDetail>().ToList();
                    }

                    foreach (Voucher item in vouchers)
                    {
                        item.detail = details.Where(x => x.voucherId == item.voucherId).ToList();
                    }
                }
                catch (Exception ex)
                {
                    if (ex.Message != "Sequence contains no elements")
                        throw ex;
                }

                return vouchers;
            }
        }

        IEnumerable<Voucher> IPropertyRepository.previewVoucherxThirdParty(int id, string postDate, decimal taxCollected)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                IEnumerable<Voucher> vouchers = null;
                IEnumerable<VoucherDetail> details = null;
                try
                {
                    using (var multi = connection.QueryMultiple("property_post_preview_vouchers_thirdparty", new { propertyID = id, postDateAccounting = postDate, taxCollected = taxCollected }, commandType: CommandType.StoredProcedure))
                    {
                        vouchers = multi.Read<Voucher>().ToList();
                        details = multi.Read<VoucherDetail>().ToList();
                    }

                    foreach (Voucher item in vouchers)
                    {
                        item.detail = details.Where(x => x.voucherId == item.voucherId).ToList();
                    }
                }
                catch (Exception ex)
                {
                    if (ex.Message != "Sequence contains no elements")
                        throw ex;
                }

                return vouchers;
            }
        }

        IEnumerable<Checkbook> IPropertyRepository.previewCheckbookEscrows(int id, string postDate)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                IEnumerable<Checkbook> checkbooks = null;
                IEnumerable<CheckbookDetail> details = null;
                try
                {
                    using (var multi = connection.QueryMultiple("property_post_preview_escrow_checks", new { propertyID = id, postDateAccounting = postDate }, commandType: CommandType.StoredProcedure))
                    {
                        checkbooks = multi.Read<Checkbook>().ToList();
                        details = multi.Read<CheckbookDetail>().ToList();
                    }

                    foreach (Checkbook item in checkbooks)
                    {
                        item.detail = details.Where(x => x.checkbookId == item.checkbookId).ToList();
                    }
                }
                catch (Exception ex)
                {
                    if (ex.Message != "Sequence contains no elements")
                        throw ex;
                }

                return checkbooks;
            }
        }

        int IPropertyRepository.updateAddCustomer(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int customerId = connection.ExecuteScalar<int>("property_update_add_customer", new { propertyId = id }, commandType: CommandType.StoredProcedure);
                return customerId;
            }
        }

        IEnumerable<CodeValue> IPropertyRepository.closeDateList()
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<CodeValue>("property_closeDate_list", null, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<InvoiceDetail> IPropertyRepository.previewInvoiceRegional(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<InvoiceDetail>("property_post_regional_preview_invoice", new { propertyId = id }, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        // recalculate pendings

        RecalculatePendingsExecution IPropertyRepository.recalculatePendingsGetExecution(int executionID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<RecalculatePendingsExecution>("property_recalculate_pendings_get_execution",
                    new { executionID }, commandType: CommandType.StoredProcedure);
            }
        }

        int IPropertyRepository.recalculatePendings()
        {
            int executionID = 0;
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                executionID = connection.ExecuteScalar<int>("property_recalculate_pendings_start",
                    null, commandType: CommandType.StoredProcedure);

                // start a background worker
                _backgroundJobs.Enqueue(() => this.recalculatePendingsAsync(executionID, connectionString));

            }
            return executionID;

        }

        public void recalculatePendingsAsync(int executionID, string connectionString)
        {
            using (SqlConnection connection = new SqlConnection(connectionString))
            {
                List<int> properties = connection.Query<int>("property_recalculate_pendings_get_list",
                    new { executionID }, commandType: CommandType.StoredProcedure).ToList();

                int blocksCount = 20;
                int pageSize = (int)Math.Round((decimal)(properties.Count / (decimal)blocksCount), 0, MidpointRounding.AwayFromZero);

                // fix page size if needed
                if ((blocksCount * pageSize) < properties.Count)
                {
                    pageSize = pageSize + 1;
                }

                for (int i = 0; i < blocksCount; i++)
                {
                    int startIndex = pageSize * i;
                    int endIndex = startIndex + (pageSize - 1);

                    if (endIndex > (properties.Count - 1))
                    {
                        pageSize = properties.Count - startIndex;
                    }

                    List<int> propertiesBlock = properties.GetRange(startIndex, pageSize);

                    // start a background worker
                    _backgroundJobs.Enqueue(() => this.recalculatePendingBlockAsync(executionID, connectionString, propertiesBlock));
                }
            }
        }

        public void recalculatePendingBlockAsync(int executionID, string connectionString, List<int> propertiesBlock)
        {
            using (SqlConnection connection = new SqlConnection(connectionString))
            {
                foreach (int propertyID in propertiesBlock)
                {
                    DateTime startDate = DateTime.Now;
                    string resultType;
                    string errorMessage;
                    try
                    {
                        // recalculate this property
                        connection.Execute("property_recalculate_pendings",
                            new { propertyID }, commandType: CommandType.StoredProcedure, commandTimeout: 0);

                        resultType = "S";
                        errorMessage = null;
                    }
                    catch (Exception ex)
                    {
                        resultType = "F";
                        errorMessage = ex.Message;
                    }

                    DateTime endDate = DateTime.Now;

                    // update progress
                    connection.Execute("property_recalculate_pendings_update_progress",
                        new { executionID, propertyID, startDate, endDate, resultType, errorMessage }, commandType: CommandType.StoredProcedure);

                }
            }
        }

        DataTable IPropertyRepository.payload(PropertyPayload payload)
        {
            DataTable dt = new DataTable();

            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                SqlCommand command = new SqlCommand("property_add_payload", connection);
                command.CommandType = CommandType.StoredProcedure;
                command.CommandTimeout = 0;

                SqlParameter p;
                p = command.Parameters.Add("@propertyID", SqlDbType.Int);
                p.Value = payload.propertyId;
                p = command.Parameters.Add("@streetNumber", SqlDbType.VarChar, 100);
                p.Value = payload.streetNumber;
                p = command.Parameters.Add("@streetDirection", SqlDbType.VarChar, 100);
                p.Value = payload.streetDirection;
                p = command.Parameters.Add("@streetName", SqlDbType.VarChar, 100);
                p.Value = payload.streetName;
                p = command.Parameters.Add("@streetDesignation", SqlDbType.VarChar, 100);
                p.Value = payload.streetDesignation;
                p = command.Parameters.Add("@streetSuffix", SqlDbType.VarChar, 100);
                p.Value = payload.streetSuffix;
                p = command.Parameters.Add("@suiteAptNumber", SqlDbType.VarChar, 100);
                p.Value = payload.suiteAptNumber;
                p = command.Parameters.Add("@buildingFloorNumber", SqlDbType.VarChar, 100);
                p.Value = payload.buildingFloorNumber;
                p = command.Parameters.Add("@city", SqlDbType.VarChar, 100);
                p.Value = payload.city;
                p = command.Parameters.Add("@state", SqlDbType.VarChar, 100);
                p.Value = payload.state;
                p = command.Parameters.Add("@zip", SqlDbType.VarChar, 100);
                p.Value = payload.zip;
                p = command.Parameters.Add("@mlsNumber1", SqlDbType.VarChar, 20);
                p.Value = payload.mlsNumber;
                p = command.Parameters.Add("@statusCode", SqlDbType.VarChar, 10);
                p.Value = payload.statusCode;
                p = command.Parameters.Add("@companyName", SqlDbType.VarChar, 100);
                p.Value = payload.companyName;
                p = command.Parameters.Add("@checkType", SqlDbType.VarChar, 10);
                p.Value = payload.checkType;
                p = command.Parameters.Add("@amount", SqlDbType.Decimal);
                p.Value = payload.amount;
                p = command.Parameters.Add("@accountNumber", SqlDbType.VarChar, 50);
                p.Value = payload.accountNumber;
                p = command.Parameters.Add("@payeeID", SqlDbType.Int);
                p.Value = payload.payeeID;
                p = command.Parameters.Add("@checkNumber", SqlDbType.VarChar, 20);
                p.Value = payload.checkNumber;
                p = command.Parameters.Add("@checkDate", SqlDbType.VarChar, 100);
                p.Value = payload.checkDate;
                p = command.Parameters.Add("@checkMemo", SqlDbType.VarChar, 200);
                p.Value = payload.checkMemo;
                p = command.Parameters.Add("@listingAgentPersonId", SqlDbType.Int);
                p.Value = payload.listingAgentPersonId;
                p = command.Parameters.Add("@sellingAgentPersonId", SqlDbType.Int);
                p.Value = payload.sellingAgentPersonId;
                p = command.Parameters.Add("@buyerFirstName", SqlDbType.VarChar, 100);
                p.Value = payload.buyerFirstName;
                p = command.Parameters.Add("@buyerLastName", SqlDbType.VarChar, 100);
                p.Value = payload.buyerLastName;

                connection.Open();
                SqlDataReader reader = command.ExecuteReader();
                dt.Load(reader);
                reader.Close();
            }
            return dt;
        }

        void IPropertyRepository.updateAgentTeam(int propertyId, int agentTeamId, string side)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("property_update_agentTeam",
                    new
                    {
                        propertyId,
                        agentTeamId,
                        side
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }


        void IPropertyRepository.updateAgentInfo(int propertyId, int agentTeamListId, int agentTeamSellId, int listSubplanId, int sellSubplanId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("property_update_agent_info",
                    new
                    {
                        propertyID = propertyId,
                        agentTeamListID = agentTeamListId,
                        agentTeamSellID = agentTeamSellId,
                        listSubplanID = listSubplanId,
                        sellSubplanID = sellSubplanId
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }


        double IPropertyRepository.calculateCustomCommission(double percentage, int codeValueId, int propertyId)
        {
            double calculatedCommission;

            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                calculatedCommission = connection.ExecuteScalar<double>("property_calculate_custom_commission",
                      new
                      {
                          percentage,
                          codeValueID = codeValueId,
                          propertyID = propertyId
                      },
                    null, commandType: CommandType.StoredProcedure);
            }
            return calculatedCommission;

        }
    }
}

```
## PropertyRoomRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using AT.AT2017.Api.Core.Models;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class PropertyRoomRepository : BaseRepository, IPropertyRoomRepository
    {
        public PropertyRoomRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<PropertyRoom> IPropertyRoomRepository.search(int propertyId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<PropertyRoom>("property_room_search",
                   new
                   {
                       propertyId = propertyId
                   },
                   commandType: CommandType.StoredProcedure).ToList();
            }
        }

        PropertyRoom IPropertyRoomRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<PropertyRoom>("property_room_get", new { propertyRoomId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int IPropertyRoomRepository.add(PropertyRoom item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("property_room_add",
                    new
                    {
                        propertyId = item.propertyId,
                        roomName = item.roomName,
                        roomLength = item.roomLength,
                        roomWidth = item.roomWidth,
                        sequenceNumber = item.sequenceNumber,
                        confirmed = item.confirmed,
                        feedId = item.feedId
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IPropertyRoomRepository.update(PropertyRoom item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("property_room_update",
                    new
                    {
                        propertyRoomId = item.propertyRoomId,
                        propertyId = item.propertyId,
                        roomName = item.roomName,
                        roomLength = item.roomLength,
                        roomWidth = item.roomWidth,
                        sequenceNumber = item.sequenceNumber,
                        confirmed = item.confirmed,
                        feedId = item.feedId
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IPropertyRoomRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("property_room_delete", new { propertyRoomId = id }, commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## PropertyShowingFeebackRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class PropertyShowingFeedbackRepository : BaseRepository, IPropertyShowingFeedbackRepository
    {
        public PropertyShowingFeedbackRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<PropertyShowingFeedback> IPropertyShowingFeedbackRepository.search(int propertyShowingId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<PropertyShowingFeedback>("property_showing_feedback_search",
                   new
                   {
                       propertyShowingId = propertyShowingId
                   },
                   commandType: CommandType.StoredProcedure).ToList();
            }
        }

        PropertyShowingFeedback IPropertyShowingFeedbackRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<PropertyShowingFeedback>("property_showing_feedback_get", new { feedbackId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int IPropertyShowingFeedbackRepository.add(PropertyShowingFeedback item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("property_showing_feedback_add",
                    new
                    {
                        propertyShowingId = item.propertyShowingId,
                        feedbackMessage = item.feedbackMessage
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IPropertyShowingFeedbackRepository.update(PropertyShowingFeedback item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("property_showing_feedback_update",
                    new
                    {
                        feedbackId = item.feedbackId,
                        feedbackMessage = item.feedbackMessage
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IPropertyShowingFeedbackRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("property_showing_feedback_delete", new { feedbackId = id }, commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## PropertyShowingRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class PropertyShowingRepository : BaseRepository, IPropertyShowingRepository
    {
        public PropertyShowingRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<PropertyShowing> IPropertyShowingRepository.search(int propertyId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<PropertyShowing>("property_showing_search",
                   new
                   {
                       propertyId = propertyId
                   },
                   commandType: CommandType.StoredProcedure).ToList();
            }
        }

        PropertyShowing IPropertyShowingRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<PropertyShowing>("property_showing_get", new { propertyShowingId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int IPropertyShowingRepository.add(PropertyShowing item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("property_showing_add",
                    new
                    {
                        propertyId = item.propertyId,
                        date = item.date,
                        time = item.time,
                        duration = item.duration,
                        notes = item.notes,
                        cobrokeAgentId = item.cobrokeAgentId,
                        status = item.status,
                        item.showingInstructions,
                        item.feedbackEdited
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IPropertyShowingRepository.update(PropertyShowing item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("property_showing_update",
                    new
                    {
                        propertyShowingId = item.propertyShowingId,
                        propertyId = item.propertyId,
                        date = item.date,
                        time = item.time,
                        duration = item.duration,
                        notes = item.notes,
                        cobrokeAgentId = item.cobrokeAgentId,
                        status = item.status,
                        item.showingInstructions,
                        item.feedbackEdited
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IPropertyShowingRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("property_showing_delete", new { propertyShowingId = id }, commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## PropertySyndicationOptOutRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Data;
using System.Data.SqlClient;
using System.Linq;
using AT.AT2017.Api.Core.Models;
using Dapper;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;

namespace AT.AT2017.Api.Repositories
{
    public class PropertySyndicationOptOutRepository : BaseRepository, IPropertySyndicationOptOutRepository
    {
        public PropertySyndicationOptOutRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<PropertySyndicationOptOut> IPropertySyndicationOptOutRepository.search(int propertyID)
        {

            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<PropertySyndicationOptOut>("property_syndication_opt_out_search",
                   new
                   {
                       propertyID
                   },
                   commandType: CommandType.StoredProcedure).ToList();
            }
        }

        PropertySyndicationOptOut IPropertySyndicationOptOutRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<PropertySyndicationOptOut>("property_syndication_opt_out_get",
                    new {
                        propertySyndicationID = id
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        int IPropertySyndicationOptOutRepository.add(PropertySyndicationOptOut item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("property_syndication_opt_out_add",
                    new
                    {
                        item.propertyID,
                        item.channelID,
                        item.confirmed,
                        item.feedID
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IPropertySyndicationOptOutRepository.update(PropertySyndicationOptOut item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("property_syndication_opt_out_update",
                    new
                    {
                        item.propertySyndicationID,
                        item.propertyID,
                        item.channelID,
                        item.confirmed,
                        item.feedID
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IPropertySyndicationOptOutRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("property_syndication_opt_out_delete",
                    new {
                        propertySyndicationID = id
                   },
                    commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## PropertyThirdPartyPaymentRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class PropertyThirdPartyPaymentRepository : BaseRepository, IPropertyThirdPartyPaymentRepository
    {
        public PropertyThirdPartyPaymentRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<PropertyThirdPartyPayment> IPropertyThirdPartyPaymentRepository.search(int propertyDeductionId, bool applyTaxes, decimal? taxCollected)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<PropertyThirdPartyPayment>("property_thirdpartypayment_search",
                   new
                   {
                       propertyDeductionId,
                       applyTaxes,
                       taxCollected
                   },
                   commandType: CommandType.StoredProcedure).ToList();
            }
        }

        PropertyThirdPartyPayment IPropertyThirdPartyPaymentRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<PropertyThirdPartyPayment>("property_thirdpartypayment_get", new { thirdPartyPaymentId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int IPropertyThirdPartyPaymentRepository.add(PropertyThirdPartyPayment item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("property_thirdpartypayment_add",
                    new
                    {
                        propertyDeductionId = item.propertyDeductionId,
                        vendorPersonId = item.vendorPersonId,
                        amount = item.amount,
                        flag1099 = item.flag1099,
                        taxExempt=item.taxExempt 
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }
        
        void IPropertyThirdPartyPaymentRepository.update(PropertyThirdPartyPayment item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("property_thirdpartypayment_update",
                    new
                    {
                        thirdPartyPaymentId = item.thirdPartyPaymentId,
                        propertyDeductionId = item.propertyDeductionId,
                        vendorPersonId = item.vendorPersonId,
                        amount = item.amount,
                        flag1099 = item.flag1099,
                        taxExempt = item.taxExempt
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IPropertyThirdPartyPaymentRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("property_thirdpartypayment_delete", new { thirdPartyPaymentId = id }, commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## PropertyTimelineTaskManualRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class PropertyTimelineTaskManualRepository : BaseRepository, IPropertyTimelineTaskManualRepository
    {
        public PropertyTimelineTaskManualRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        PropertyTimelineTask IPropertyTimelineTaskManualRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<PropertyTimelineTask>("property_timelinetaskmanual_get", new { propertyTimelineTaskManualID = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int IPropertyTimelineTaskManualRepository.add(PropertyTimelineTask item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("property_timelinetaskmanual_add",
                    new
                    {
                        item.propertyId,
                        item.taskName,
                        item.date,
                        item.notes,
                        item.publishToSeller,
                        item.publishToBuyer,
                        item.done,
                        item.locked,
                        item.rejectionNotes
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IPropertyTimelineTaskManualRepository.update(PropertyTimelineTask item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("property_timelinetaskmanual_update",
                    new
                    {
                        propertyTimelineTaskManualID = item.propertyTimelineTaskId,
                        item.taskName,
                        item.date,
                        item.notes,
                        item.publishToSeller,
                        item.publishToBuyer,
                        item.done,
                        item.locked,
                        item.rejectionNotes
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IPropertyTimelineTaskManualRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("property_timelinetaskmanual_delete", new { propertyTimelineTaskManualID = id }, commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## PropertyTimelineTaskRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class PropertyTimelineTaskRepository : BaseRepository, IPropertyTimelineTaskRepository
    {
        public PropertyTimelineTaskRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<PropertyTimelineTask> IPropertyTimelineTaskRepository.search(int propertyId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<PropertyTimelineTask>("property_timelinetask_search",
                   new
                   {
                       propertyId = propertyId
                   },
                   commandType: CommandType.StoredProcedure).ToList();
            }
        }

        PropertyTimelineTask IPropertyTimelineTaskRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<PropertyTimelineTask>("property_timelinetask_get", new { propertyTimelineTaskId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int IPropertyTimelineTaskRepository.add(PropertyTimelineTask item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("property_timelinetask_add",
                    new
                    {
                        propertyId = item.propertyId,
                        taskId = item.taskId,
                        date = item.date,
                        notes = item.notes,
                        publishToSeller = item.publishToSeller,
                        publishToBuyer = item.publishToBuyer,
                        done = item.done,
                        locked = item.locked,
                        rejectionNotes = item.rejectionNotes
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IPropertyTimelineTaskRepository.notify(int propertyId, string side)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.Execute("property_timelinetask_notify",
                    new
                    {
                        propertyId,
                        side
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IPropertyTimelineTaskRepository.update(PropertyTimelineTask item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("property_timelinetask_update",
                    new
                    {
                        propertyTimelineTaskId = item.propertyTimelineTaskId,
                        propertyId = item.propertyId,
                        taskId = item.taskId,
                        date = item.date,
                        notes = item.notes,
                        publishToSeller = item.publishToSeller,
                        publishToBuyer = item.publishToBuyer,
                        done = item.done,
                        locked = item.locked,
                        rejectionNotes = item.rejectionNotes
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IPropertyTimelineTaskRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("property_timelinetask_delete", new { propertyTimelineTaskId = id }, commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## PropertyTotalRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;
using Hangfire;

namespace AT.AT2017.Api.Repositories
{
    public class PropertyTotalRepository : BaseRepository, IPropertyTotalRepository
    {
        private IBackgroundJobClient _backgroundJobs;

        public PropertyTotalRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings, IBackgroundJobClient backgroundJobs) : base(httpContextAccessor, appSettings)
        {
            _backgroundJobs = backgroundJobs;
        }

        int IPropertyTotalRepository.add(PropertyTotal item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("property_total_add",
                   new
                   {
                       propertyId = item.propertyId,
                       totalID = item.totalId
                   },
                   commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IPropertyTotalRepository.delete(int propertyID, int totalID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("property_total_delete", new { totalId = totalID, propertyID = propertyID }, commandType: CommandType.StoredProcedure);
            }
        }

        PropertyTotal IPropertyTotalRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<PropertyTotal>("property_total_get", new { propertyTotalId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        IEnumerable<PropertyTotal> IPropertyTotalRepository.search(int propertyID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<PropertyTotal>("property_total_search",
                    new
                    {
                        propertyID = propertyID,
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<PropertyTotal> IPropertyTotalRepository.searchUpdateLog(int propertyID, string processedDate)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<PropertyTotal>("property_total_search_update_log",
                    new
                    {
                        propertyID,
                        processedDate
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<PropertyTotal> IPropertyTotalRepository.updateAll(int propertyID, string processedDate, string actionType)
        {
            // get list of personTotal records will be updated
            List<PropertyTotal> propertyTotals = new List<PropertyTotal>();
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                propertyTotals = connection.Query<PropertyTotal>("property_total_search",
                    new
                    {
                        propertyID,
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }

            // iterate each propertyTotal to update
            foreach (var propertyTotal in propertyTotals)
            {
                // start a background jo for each record
                _backgroundJobs.Enqueue(() => updatePropertyTotalAsync(propertyID, processedDate, propertyTotal.propertyTotalId, actionType, connectionString));
            }

            // return list of personTotals
            return propertyTotals;
            
        }

        public void updatePropertyTotalAsync(int propertyID, string processedDate, int propertyTotalID, string actionType, string connectionString)
        {
            using (SqlConnection connection = new SqlConnection(connectionString))
            {
                connection.Execute("property_total_update",
                        new
                        {
                            propertyID,
                            propertyTotalID,
                            processedDate,
                            actionType,
                        },
                        commandType: CommandType.StoredProcedure,
                        commandTimeout: 0);
            }
        }

    }
}

```
## PropertyTourRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using AT.AT2017.Api.Core.Models;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class PropertyTourRepository : BaseRepository, IPropertyTourRepository
    {
        public PropertyTourRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<PropertyTour> IPropertyTourRepository.search(int propertyId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<PropertyTour>("property_tour_search",
                   new
                   {
                       propertyId
                   },
                   commandType: CommandType.StoredProcedure).ToList();
            }
        }

        PropertyTour IPropertyTourRepository.get(int tourID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<PropertyTour>("property_tour_get", new { tourID }, commandType: CommandType.StoredProcedure);
            }
        }

        int IPropertyTourRepository.add(PropertyTour item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("property_tour_add",
                    new
                    {
                        item.propertyId,
                        item.url,
                        item.description,
                        item.mediaFormatID,
                        item.mediaCategoryID,
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IPropertyTourRepository.update(PropertyTour item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("property_tour_update",
                    new
                    {
                        item.tourID,
                        item.url,
                        item.description,
                        item.mediaFormatID,
                        item.mediaCategoryID,
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IPropertyTourRepository.delete(int tourID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("property_tour_delete", new { tourID }, commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## QuickbookRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class QuickbookRepository : BaseRepository, IQuickbookRepository
    {
        public QuickbookRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<Quickbook> IQuickbookRepository.search(DateTime date, int companyId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {

                List<Quickbook> listQuickbook = new List<Quickbook>();
                IEnumerable<QuickbookMaster> list = connection.Query<QuickbookMaster>("quickbooks",
                   new
                   {
                       date = date,
                       companyId = companyId
                   },
                   commandType: CommandType.StoredProcedure, commandTimeout: 0).ToList();

                if (list.Count() > 0)
                {
                    string id = list.First().id;
                    int i = 1;
                    Quickbook master = new Quickbook();
                    List<QuickbookDetail> detail = new List<QuickbookDetail>();

                    foreach (QuickbookMaster item in list)
                    {
                        string idItem = item.id;

                        if (id != idItem)
                        {
                            master.line_items = detail;
                            listQuickbook.Add(master);

                            id = idItem;
                            master = new Quickbook();
                            detail = new List<QuickbookDetail>();
                        }

                        master.action = item.action;
                        master.deleteDate = item.deleteDate;
                        master.id = item.id;
                        master.companyId = item.companyId;
                        master.journalDate = item.journalDate;
                        master.modifyDate = item.modifyDate;
                        master.modifyDateToFilter = item.modifyDateToFilter;
                        master.postedDate = item.postedDate;
                        master.type = item.type;

                        QuickbookDetail itemDetail = new QuickbookDetail();
                        itemDetail.accountDescription = item.accountDescription;
                        itemDetail.accountNumber = item.accountNumber;
                        itemDetail.credit = item.credit;
                        itemDetail.debit = item.debit;
                        itemDetail.description = item.description;
                        itemDetail.@class = item.@class;

                        detail.Add(itemDetail);

                        if (i == list.Count())
                        {
                            master.line_items = detail;
                            listQuickbook.Add(master);
                        }

                        i++;
                    }
                }

                listQuickbook = listQuickbook.OrderByDescending(p => p.modifyDate).ToList();

                return listQuickbook;
            }
        }
    }
}

```
## ReconciliationFireRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;
using AT.AT2017.Api.DynamicParameters;

namespace AT.AT2017.Api.Repositories
{
    public class ReconciliationFireRepository : BaseRepository, IReconciliationFireRepository
    {
        public ReconciliationFireRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<ReconciliationFire> IReconciliationFireRepository.search(int reconciliationId, int year, int companyId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<ReconciliationFire>("reconciliation_fire_search",
                 new
                 {
                     reconciliationId,
                     year,
                     companyId
                 }).ToList();

            }
        }

        IEnumerable<ReconciliationFireSource> IReconciliationFireRepository.searchSource(string fileType)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<ReconciliationFireSource>("reconciliation_fire_search_source",
                    new
                    {
                        fileType
                    }, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        ReconciliationFire IReconciliationFireRepository.get(int id, bool onlyHeader)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                ReconciliationFire item = null;

                try
                {
                    using (var multi = connection.QueryMultiple("reconciliation_fire_get", 
                        new {
                            id,
                            onlyHeader
                        }, commandType: CommandType.StoredProcedure))
                    {
                        item = multi.Read<ReconciliationFire>().Single();

                        if (onlyHeader == false)
                        {
                            item.detail = multi.Read<ReconciliationFireDetail>().ToList();
                            item.transmitter = multi.Read<ReconciliationFireTransmitter>().ToList();
                            item.issuer = multi.Read<ReconciliationFireIssuer>().ToList();
                            item.payee = multi.Read<ReconciliationFirePayee>().ToList();
                            item.summaryOfPayee = multi.Read<ReconciliationFireSummaryOfPayee>().ToList();
                            item.summaryOfStateTotals = multi.Read<ReconciliationFireSummaryOfStateTotals>().ToList();
                            item.endTransaction = multi.Read<ReconciliationFireEndTransaction>().ToList();
                        };
                    }
                }
                catch (Exception ex)
                {
                    if (ex.Message != "Sequence contains no elements")
                        throw ex;
                }
                return item;
            }
        }

        int IReconciliationFireRepository.add(string fileType, int reconciliationId, int reconciliationFireParentId, string formatType, string description, bool isForRental, string contactName, string contactEmail, string contactPhone)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("reconciliation_fire_add",
                    new
                    {
                        fileType,
                        reconciliationId,
                        reconciliationFireParentId,
                        formatType,
                        description,
                        isForRental,
                        contactName,
                        contactEmail,
                        contactPhone
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IReconciliationFireRepository.update(ReconciliationFire item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                var reconciliationFireParameter = new ReconciliationFireDynamicParameter(item);

                int id = connection.ExecuteScalar<int>("reconciliation_fire_update", reconciliationFireParameter, commandType: CommandType.StoredProcedure);
            }
        }

        void IReconciliationFireRepository.updateDoNotUpload(int reconciliationFireId, bool doNotUpload)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("reconciliation_fire_update_donotupload", new { reconciliationFireId, doNotUpload }, commandType: CommandType.StoredProcedure);
            }
        }

        void IReconciliationFireRepository.rebuild(int reconciliationFireId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("reconciliation_fire_rebuild",
                    new
                    {
                        reconciliationFireId
                    },
                    commandType: CommandType.StoredProcedure,
                    commandTimeout: 0);
            }
        }

        void IReconciliationFireRepository.delete(int reconciliationFireId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("reconciliation_fire_delete", 
                    new {
                        reconciliationFireId
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        ReconciliationFire IReconciliationFireRepository.generate(ReconciliationFire item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<ReconciliationFire>("reconciliation_fire_generate",
                    new
                    {
                        item.reconciliationFireId,
                        item.constanceUrl,
                        item.generatedDate,
                        item.generatedBy,
                        item.signature
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IReconciliationFireRepository.send(int reconciliationFireId, string emailAddress, string remoteUrl)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("reconciliation_fire_sent",
                    new
                    {
                        id = reconciliationFireId,
                        email = emailAddress,
                        urlFile = remoteUrl
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IReconciliationFireRepository.uploaded(int reconciliationFireId, DateTime uploadedDate, string uploadedBy)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("reconciliation_fire_uploaded",
                    new
                    {
                        reconciliationFireId,
                        uploadedDate,
                        uploadedBy
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        IEnumerable<ReconciliationFireError> IReconciliationFireRepository.validate(int reconciliationFireId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<ReconciliationFireError>("reconciliation_fire_validate",
                    new
                    {
                        reconciliationFireId
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

    }
}

```
## ReconciliationMergeFieldRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using AT.AT2017.Api.DynamicParameters;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class ReconciliationMergeFieldRepository : BaseRepository, IReconciliationMergeFieldRepository
    {
        public ReconciliationMergeFieldRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<ReconciliationMergeField> IReconciliationMergeFieldRepository.search()
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<ReconciliationMergeField>("reconciliationMergefield_search", null, commandType: CommandType.StoredProcedure).ToList();
            }
        }
    }
}

```
## ReconciliationTemplateRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using AT.AT2017.Api.DynamicParameters;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class ReconciliationTemplateRepository : BaseRepository, IReconciliationTemplateRepository
    {
        public ReconciliationTemplateRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<ReconciliationTemplate> IReconciliationTemplateRepository.search(string name)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<ReconciliationTemplate>("reconciliationTemplate_search",
                   new
                   {
                       name = name
                   },
                   commandType: CommandType.StoredProcedure).ToList();
            }
        }


        IEnumerable<ReconciliationTemplate> IReconciliationTemplateRepository.searchFromMaster()
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<ReconciliationTemplate>("reconciliationTemplate_search_from_master", null, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        ReconciliationTemplate IReconciliationTemplateRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                ReconciliationTemplate item = null;
                try
                {
                    using (var multi = connection.QueryMultiple("reconciliationTemplate_get", new { templateID = id }, commandType: CommandType.StoredProcedure))
                    {
                        item = multi.Read<ReconciliationTemplate>().Single();
                        item.mergeFields = multi.Read<ReconciliationMergeField>().ToList();
                    }
                }
                catch (Exception ex)
                {
                    if (ex.Message != "Sequence contains no elements")
                        throw ex;
                }
                return item;
            }
        }
        ReconciliationTemplate IReconciliationTemplateRepository.getFromMaster(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                ReconciliationTemplate item = null;
                try
                {
                    using (var multi = connection.QueryMultiple("reconciliationTemplate_get_from_master", new { templateId = id }, commandType: CommandType.StoredProcedure))
                    {
                        item = multi.Read<ReconciliationTemplate>().Single();
                        item.mergeFields = multi.Read<ReconciliationMergeField>().ToList();
                    }
                }
                catch (Exception ex)
                {
                    if (ex.Message != "Sequence contains no elements")
                        throw ex;
                }
                return item;
            }
        }


        void IReconciliationTemplateRepository.exportToMaster(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("reconciliationTemplate_export_to_master", new { templateID = id }, commandType: CommandType.StoredProcedure);
            }
        }


        int IReconciliationTemplateRepository.add(ReconciliationTemplate item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("reconciliationTemplate_add",
                   new
                   {
                       name = item.name,
                       background = item.background,
                       backgroundPosition = item.backgroundPosition,
                       width = item.width,
                       height = item.height,
                       paper_kind = item.paper_kind,
                       paper_width = item.paper_width,
                       paper_height = item.paper_height,
                       margin_top = item.margin_top,
                       margin_bottom = item.margin_bottom,
                       margin_left = item.margin_left,
                       margin_right = item.margin_right,
                       landscape = item.landscape,
                       masterId = item.masterId
                   },
                   commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IReconciliationTemplateRepository.update(ReconciliationTemplate item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                var checktemplateParameter = new ReconciliationTemplateDynamicParameter(item);

                int id = connection.ExecuteScalar<int>("reconciliationTemplate_update", checktemplateParameter, commandType: CommandType.StoredProcedure);
            }
        }

        void IReconciliationTemplateRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("reconciliationTemplate_delete", new { templateId = id }, commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## ReconciliationWriterRepository.cs
```cs
using System.Collections.Generic;
using System.Linq;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class ReconciliationWriterRepository : BaseRepository, IReconciliationWriterRepository
    {
        public ReconciliationWriterRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<ReconciliationWriter> IReconciliationWriterRepository.search(int companyId, int reconciliationId, int year, string personId, int recordsByPage, bool repeatByPage)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<ReconciliationWriter>("reconciliationWriter_search",
                    new
                    {
                        companyId,
                        year,
                        reconciliationId,
                        personIds = personId,
                        recordsPerPage= recordsByPage,
                        repeatByPage
                    }
                   , commandType: CommandType.StoredProcedure, commandTimeout: 0).ToList();
            }
        }
    }
}

```
## RecurringRepository.cs
```cs
using System.Collections.Generic;
using System.Linq;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class RecurringRepository : BaseRepository, IRecurringRepository
    {

        public RecurringRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<Recurring> IRecurringRepository.search(string docType, string recurringType, int recurringPayableGroupId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<Recurring>("recurring_search",
                    new
                    {
                        docType = docType,
                        recurringType = recurringType,
                        recurringPayableGroupId = recurringPayableGroupId
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        void IRecurringRepository.delete(string docType, int entityID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("recurring_delete",
                    new
                    {
                        docType = docType,
                        entityID = entityID
                    }, commandType: CommandType.StoredProcedure);
            }
        }

        int IRecurringRepository.addVoucher(Recurring item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("recurring_voucher_add",
                    new
                 {     voucherID= item.id,
                        orderDate = item.nextProcess,
                        posted= item.posted
                    }, commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        int IRecurringRepository.addInvoice(Recurring item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("recurring_invoice_add",
                    new
                    {
                        invoiceID = item.id,
                        orderDate = item.nextProcess,
                        posted = item.posted
                    }, commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        int IRecurringRepository.addJournal(Recurring item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("recurring_journal_add",
                    new
                    {
                        journalID = item.id,
                        orderDate = item.nextProcess,
                        posted = item.posted
                    }, commandType: CommandType.StoredProcedure);

                return id;
            }
        }

    }
}

```
## RegionOfficeRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class RegionOfficeRepository : BaseRepository, IRegionOfficeRepository
    {
        public RegionOfficeRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<RegionOffice> IRegionOfficeRepository.search(int regionId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<RegionOffice>("region_office_search", new { regionId = regionId }, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        RegionOffice IRegionOfficeRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<RegionOffice>("region_office_get", new { regionOfficeId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int IRegionOfficeRepository.add(RegionOffice item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("region_office_add",
                    new
                    {
                        regionId = item.regionId,
                        officeId = item.officeId
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IRegionOfficeRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("region_office_delete", new { regionOfficeId = id }, commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## RegionRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class RegionRepository : BaseRepository, IRegionRepository
    {
        public RegionRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<Region> IRegionRepository.search()
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<Region>("region_search", null, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        Region IRegionRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<Region>("region_get", new { regionId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int IRegionRepository.add(Region item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("region_add",
                    new
                    {
                        name = item.name
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IRegionRepository.update(Region item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("region_update",
                    new
                    {
                        regionId = item.regionId,
                        name = item.name
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IRegionRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("region_delete", new { regionId = id }, commandType: CommandType.StoredProcedure);
            }
        }
        
    }
}

```
## ReimbursementRepository.cs
```cs
using System.Collections.Generic;
using System.Linq;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using AT.AT2017.Api.DynamicParameters;
using System.Data.SqlClient;
using AT.AT2017.Api.Core.Shared;

namespace AT.AT2017.Api.Repositories
{
    public class ReimbursementRepository : BaseRepository, IReimbursementRepository
    {
        public ReimbursementRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {

        }

        IEnumerable<Reimbursement> IReimbursementRepository.search(int personId, string reimb)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<Reimbursement>("person_reimbursement_search",
                new
                {
                    personId = personId,
                    reimb = reimb
                },
                commandType: CommandType.StoredProcedure).ToList();
            }
        }

        PagedList<Reimbursement> IReimbursementRepository.searchPaginated(int personId, string reimb, int pageIndex, int pageSize)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                PagedList<Reimbursement> page = null;

                using (var multi = connection.QueryMultiple("person_reimbursement_search_paginated",
                    new
                    {
                        personId,
                        reimb,
                        pageIndex,
                        pageSize
                    }, commandType: CommandType.StoredProcedure, commandTimeout: 0))
                {
                    page = multi.Read<PagedList<Reimbursement>>().Single();
                    page.data = multi.Read<Reimbursement>().ToList();

                }
                return page;
            }
        }

        void  IReimbursementRepository.update( IEnumerable<Reimbursement> list)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                var reimbursementParameter = new ReimbursementDynamicParameter(list);

                int id = connection.ExecuteScalar<int>("reimbursement_update_reimb", reimbursementParameter, commandType: CommandType.StoredProcedure);
            }
        }
      
    }
}

```
## RepCubeRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using AT.AT2017.Api.Core.Models;
using Dapper;
using System.Data;
using System.Data.SqlClient;
using Microsoft.AspNetCore.Hosting;
using Hangfire;
using AT.AT2017.Api.DynamicParameters;

namespace AT.AT2017.Api.Repositories
{
    public class RepCubeRepository : BaseRepository, IRepCubeRepository
    {
        private IBackgroundJobClient _backgroundJobs;

        public RepCubeRepository(IHttpContextAccessor httpContextAccessor, IHostingEnvironment env, IOptions<ApplicationSettings> appSettings, IBackgroundJobClient backgroundJobs) : base(httpContextAccessor, env, appSettings)
        {
            _backgroundJobs = backgroundJobs;
        }

        IEnumerable<RepCube> IRepCubeRepository.search()
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<RepCube>("rep_cube_search", null, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<RepCube> IRepCubeRepository.searchExecutionLog(string cubeName)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<RepCube>("rep_cube_search_execution_log", new { cubeName }, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        string IRepCubeRepository.fillTable(string cubeList, int userID, string updateType)
        {
            using (SqlConnection saConnection = new SqlConnection(base.saConnectionString))
            {
                var parameters = new RepCubeStartExecutionDynamicParameter(cubeList, "Darwin", userID, DateTime.Now, updateType, false);

                string executionGUID = saConnection.ExecuteScalar<string>("rep_cube_start_execution", parameters);

                // start a background worker
                _backgroundJobs.Enqueue(() => this.repCubeFillTableAsync(executionGUID, saConnectionString));

                return executionGUID;
            }
        }

        public void repCubeFillTableAsync(string executionGUID, string connectionString)
        {
            using (SqlConnection connection = new SqlConnection(connectionString))
            {

                connection.Execute("rep_cube_fill_table",
                    new
                    {
                        executionGUID
                    }, commandTimeout: 0, commandType: CommandType.StoredProcedure);
                
            }
        }

        bool IRepCubeRepository.isRunninng()
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return (bool)connection.ExecuteScalar("rep_cube_is_running", null, commandType: CommandType.StoredProcedure);
            }
        }

        void IRepCubeRepository.stopExecution()
        {
            using (SqlConnection saConnection = new SqlConnection(base.saConnectionString))
            {
                saConnection.ExecuteScalar("rep_cube_stop_execution", null, commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## ReplicationRepository.cs
```cs
using System.Collections.Generic;
using System.Linq;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using AT.AT2017.Api.Core.Models;
using System.Data.SqlClient;
using System;
using System.Text.RegularExpressions;
using Microsoft.AspNetCore.Hosting;

namespace AT.AT2017.Api.Repositories
{
    public class ReplicationRepository : BaseRepository, IReplicationRepository
    {
        protected IHostingEnvironment _env;

        public ReplicationRepository(IHttpContextAccessor httpContextAccessor, IHostingEnvironment env, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, env, appSettings)
        {
            _env = env;
        }

        private string getConnectionString(string server, string database)
        {
            var userName = _appSettings.AdminUser;
            var password = _appSettings.AdminPassword;

            return string.Format("Server={0};Database={1};User Id={2};Password={3};Max Pool Size=1024;Pooling=true;Application Name=AT2017;Connection Timeout=60;", server, database, userName, password);
        }

        public void executeSqlScript(SqlConnection conn, string script)
        {
            var serverConnection = new Microsoft.SqlServer.Management.Common.ServerConnection(conn);
            var server = new Microsoft.SqlServer.Management.Smo.Server(serverConnection);
            server.ConnectionContext.ExecuteNonQuery(script);
        }

        IEnumerable<Database> IReplicationRepository.searchAllDatabases()
        {
            using (SqlConnection adminConnection = new SqlConnection(base.adminConnectionString))
            {
                return adminConnection.Query<Database>("database_search_for_replication", null, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        void IReplicationRepository.execute(string server, string database, int logId, string query)
        {
            // run query
            string result = "";
            string errorMessage = "";

            try
            {
                using (SqlConnection connection = new SqlConnection(this.getConnectionString(server, database)))
                {
                    connection.Open();
                    this.executeSqlScript(connection, query);                   
                    connection.Close();
                }
            }
            catch (SqlException ex)
            {
                errorMessage = ex.Message;
                result = "failed";
            }

            if (errorMessage == "")
            {
                result = "success";
            }

            // insert replication log detail
            this.addLogDetail(logId, server, database, result, errorMessage);

            // throw exception
            if (errorMessage != "")
            {
                throw new Exception(errorMessage);
            }
        }

        int  IReplicationRepository.addLog(string sql)
        {
            using (SqlConnection adminConnection = new SqlConnection(base.adminConnectionString))
            {
                int id = adminConnection.ExecuteScalar<int>("replicationLog_add", new { script = sql }, commandType: CommandType.StoredProcedure);
                return id;
            }
           
        }

        private int addLogDetail(int logID, string serverName, string databaseName, string result, string error)
        {
            using (SqlConnection adminConnection = new SqlConnection(base.adminConnectionString))
            {
                int id = adminConnection.ExecuteScalar<int>("replicationLog_add_detail", new { logID = logID, serverName = serverName, databaseName = databaseName, result = result, error = error }, commandType: CommandType.StoredProcedure);
                return id;
            }

        }

    }
}

```
## ReportDataSourceRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using System.Data;
using Dapper;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class ReportDataSourceRepository : BaseRepository, IReportDataSourceRepository 
    {
        public ReportDataSourceRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        public IEnumerable<string> all(string type)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<string>("TP_REPORTS_DATASOURCE_LIST",
                   new
                   {
                       Type = type
                   },
                   commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<ReportDataSource > IReportDataSourceRepository.search(string dataSource, int  type, string filter)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                var result = connection.Query<ReportDataSource>("report_datasource_search",
                   new
                   {
                       dataSource = dataSource,
                       type = type,
                       filter = filter
                   },
                   commandType: CommandType.StoredProcedure).ToList();

                return result;
            }
        }

    }
}

```
## ReportFavoriteRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using System.Data;
using Dapper;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class ReportFavoriteRepository : BaseRepository, IReportFavoriteRepository
    {
        public ReportFavoriteRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        int IReportFavoriteRepository.add(int reportID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("report_favorite_add", new { reportID }, commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IReportFavoriteRepository.delete(int reportID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("report_favorite_delete", new { reportID }, commandType: CommandType.StoredProcedure);
            }
        }
    }
}

```
## ReportLaunchedRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class ReportLaunchedRepository : BaseRepository, IReportLaunchedRepository
    {
        public ReportLaunchedRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        void IReportLaunchedRepository.add(ReportLaunched item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("reportLaunchedByUser_add",
                   new
                   {
                       userID = item.userID,
                       reportID = item.reportID,
                       reportParameter = item.reportParameter,
                       reportGroupBy = item.reportGroupBy,
                       reportColumn = item.reportColumn
                   },
                   commandType: CommandType.StoredProcedure);
            }
        }

        ReportLaunched IReportLaunchedRepository.get(int userId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<ReportLaunched>("reportLaunchedByUser_get", new { userID = userId }, commandType: CommandType.StoredProcedure);
            }
        }
    }
}

```
## ReportRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using AT.AT2017.Api.DynamicParameters;
using System.Data.SqlClient;


namespace AT.AT2017.Api.Repositories
{
    public class ReportRepository : BaseRepository, IReportRepository
    {
        public ReportRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<Report> IReportRepository.search(int userId, string masterKeyName)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<Report>("report_search",
                    new
                    {
                        userId = userId,
                        masterKeyName = masterKeyName
                    }, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<Report> IReportRepository.searchNotInPackage(int userId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<Report>("report_search_not_in_package",
                    new
                    {
                        userId
                    }, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<ReportColumn> IReportRepository.searchColumns()
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<ReportColumn>("report_search_columns", null, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<ReportColumn> IReportRepository.searchStandarColumns(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<ReportColumn>("report_search_standar_columns", new { reportId = id }, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<Report> IReportRepository.searchFromMaster()
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<Report>("reports_search_from_master", null, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        Report IReportRepository.get(int id, bool raw)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                Report report = connection.QueryFirstOrDefault<Report>("report_get", new { reportId = id }, commandType: CommandType.StoredProcedure);

                if (report != null)
                {
                    using (var multi = connection.QueryMultiple("TP_REPORTS_DETAILS_LIST" + (raw ? "_RAW" : string.Empty), new { reportId = id }, commandType: CommandType.StoredProcedure))
                    {
                        report.parameters = multi.Read<ReportParameter>().ToList();
                        report.columns = multi.Read<ReportColumn>().ToList();
                        report.groupers = multi.Read<ReportGroupBy>().ToList();
                    }
                }

                return report;
            }
        }

        Report IReportRepository.getCampaignReport(int id,int campaignReportId )
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                Report report = connection.QueryFirstOrDefault<Report>("report_get", new { reportId = id }, commandType: CommandType.StoredProcedure);

                if (report != null)
                {
                    using (var multi = connection.QueryMultiple("reportCampaign_get", new { reportId = id, campaignReportId= campaignReportId }, commandType: CommandType.StoredProcedure))
                    {
                        report.parameters = multi.Read<ReportParameter>().ToList();
                        report.columns = multi.Read<ReportColumn>().ToList();
                        report.groupers = multi.Read<ReportGroupBy>().ToList();
                    }
                }

                return report;
            }
        }

        Report IReportRepository.search(string url)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                Report report = connection.QueryFirstOrDefault<Report>("TP_REPORTS_LINKED_SECURITY_CHECK", new { reportPath = url }, commandType: CommandType.StoredProcedure);

                return report;
            }
        }
        
        IEnumerable<Report> IReportRepository.searchByGroup(string group)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<Report>("report_search_byGroup",
                    new
                    {
                        groupName = group
                    }, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        Report IReportRepository.getFromMaster(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                Report report;

                report = connection.QueryFirstOrDefault<Report>("reports_get_from_master", new { reportId = id }, commandType: CommandType.StoredProcedure);

                if (report != null)
                {
                    using (var multi = connection.QueryMultiple("TP_REPORTS_DETAILS_LIST_RAW_FROM_MASTER", new { reportId = id }, commandType: CommandType.StoredProcedure))
                    {
                        report.parameters = multi.Read<ReportParameter>().ToList();
                        report.columns = multi.Read<ReportColumn>().ToList();
                        report.groupers = multi.Read<ReportGroupBy>().ToList();
                    }
                }

                return report;
            }
        }

        int IReportRepository.addCustom(ReportCustom item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int value = connection.ExecuteScalar<int>("TP_REPORTS_CUSTOM_ADD",
                    new
                    {
                        item.reportId,
                        reportBaseID = item.reportBaseId,
                        item.name,
                        columns = item.columnsParam,
                        parameters = item.parametersParam,
                        groups = item.groupsParam,
                        //overrides = item.overrides
                    },
                    commandType: CommandType.StoredProcedure);

                return value;
            }
        }

        int IReportRepository.add(Report item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                var reportParameter = new ReportDynamicParameter(item);

                //int id = base.connection().ExecuteScalar<int>("TP_REPORTS_ADD", 
                //    new
                //    {
                //        name = item.name,
                //        group = item.groupName,
                //        url = item.url
                //    }, commandType: CommandType.StoredProcedure);

                int id = connection.ExecuteScalar<int>("TP_REPORTS_ADD", reportParameter, commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        int IReportRepository.update(Report item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                var reportParameter = new ReportDynamicParameter(item);


                int id = connection.ExecuteScalar<int>("TP_REPORTS_DETAILS_SAVE", reportParameter, commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        int IReportRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int result = connection.ExecuteScalar<int>("TP_REPORTS_DELETE", new { ReportID = id }, commandType: CommandType.StoredProcedure);

                return result;
            }
        }

        void IReportRepository.exportToMaster(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                /*
                 * @ReportID			INT,
                 * @resetPermissions	BIT = 0
                 */
                var parameters = new {
                    ReportID = id,
                    resetPermissions = false
                };

                connection.ExecuteScalar<int>("report_export_to_master", parameters, commandType: CommandType.StoredProcedure);
            }
        }

        void IReportRepository.sendByEmail(int id, int userID, string email, string parameters, bool byExcel, string reportLink, string subject)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("report_sendByEmail", 
                        new { userID = userID, reportID=id, sendTo= email, reportParameters= parameters, byExcel= byExcel, reportLink= reportLink , subject = subject }, 
                                commandType: CommandType.StoredProcedure);

            }
        }

        IEnumerable<Package> IReportRepository.searchPackages(int reportID)
        {
            using (SqlConnection connection = new SqlConnection(base.adminConnectionString))
            {
                return connection.Query<Package>("package_search_by_report", new
                {
                    reportID
                }, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        void IReportRepository.addPachages(int reportID, string packages)
        {
            using (SqlConnection connection = new SqlConnection(base.adminConnectionString))
            {

                connection.Execute("report_add_packages",
                new
                {
                    reportID,
                    packages
                }, commandType: CommandType.StoredProcedure);
            }
        }
    }
}

```
## RoleRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.DynamicParameters;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class RoleRepository : BaseRepository, IRoleRepository
    {
        public RoleRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<Role> IRoleRepository.search(string name)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<Role>("role_search",
                 new
                 {
                     name = name
                 },
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }

        Role IRoleRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                Role item = null;
                try
                {
                    using (var multi = connection.QueryMultiple("role_get", new { roleId = id }, commandType: CommandType.StoredProcedure))
                    {
                        item = multi.Read<Role>().Single();
                        item.users = multi.Read<UserRole>().ToList();
                        item.security = multi.Read<Security>().ToList();
                        item.reports = multi.Read<RoleReport>().ToList();
                        item.personTypes = multi.Read<RolePersonType>().ToList();
                        item.analyticsDashboards = multi.Read<RoleAnalyticsDashboard>().ToList();
                    }
                }
                catch (Exception ex)
                {
                    if (ex.Message != "Sequence contains no elements")
                        throw ex;
                }
                return item;
            }
        }

        int IRoleRepository.add(Role item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                var roleParameter = new RoleDynamicParameter(item);

                int id = connection.ExecuteScalar<int>("role_add", roleParameter, commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IRoleRepository.update(Role item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                var roleParameter = new RoleDynamicParameter(item);

                int id = connection.ExecuteScalar<int>("role_update", roleParameter, commandType: CommandType.StoredProcedure);
            }
        }

        void IRoleRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("role_delete", new { roleId = id }, commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## SecurityRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class SecurityRepository : BaseRepository, ISecurityRepository
    {
        public SecurityRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<Security> ISecurityRepository.search(int roleId, int actionId, int userId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<Security>("security_search",
                 new
                 {
                     roleId = roleId,
                     actionId = actionId,
                     userId = userId
                 },
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<MenuAction> ISecurityRepository.searchActions(int userId, bool retrieveControls)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                List<MenuAction> actions;
                List<CustomControl> customControls = new List<CustomControl>();
                using (var multi = connection.QueryMultiple("security_search_actions_and_controls",
                    new
                    {
                        userId,
                        retrieveControls
                    }
                    , commandType: CommandType.StoredProcedure))
                {
                    actions = multi.Read<MenuAction>().ToList();

                    if (retrieveControls)
                    {
                        customControls = multi.Read<CustomControl>().ToList();
                    }
                }

                if (retrieveControls)
                {
                    foreach (MenuAction action in actions)
                    {
                        List<CustomControl> controls = customControls.Where((p) => p.formName == action.formName).ToList();

                        action.controls = controls;

                    }
                }

                return actions;
            }
        }

        Security ISecurityRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<Security>("security_get", new { securityId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int ISecurityRepository.add(Security item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("security_add",
                    new
                    {
                        roleId = item.roleId,
                        actionId = item.actionId
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void ISecurityRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("security_delete", new { securityId = id }, commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## ServerRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using AT.AT2017.Api.DynamicParameters;
using System.Data.SqlClient;
using Microsoft.AspNetCore.Hosting;

namespace AT.AT2017.Api.Repositories
{
    public class ServerRepository : BaseRepository, IServerRepository
    {

        public ServerRepository(IHttpContextAccessor httpContextAccessor, IHostingEnvironment env, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, env, appSettings)
        {
        }
        
        IEnumerable<Server> IServerRepository.searchServers(bool isActive)
        {
            using (SqlConnection adminConnection = new SqlConnection(base.adminConnectionString))
            {
                return adminConnection.Query<Server>("server_search",
                    new
                    {
                        isActive = isActive
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

       
    }
}

```
## SettingRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class SettingRepository : BaseRepository, ISettingRepository
    {
        public SettingRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<Setting> ISettingRepository.search(string name, string description, string section, string type)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<Setting>("setting_search",
                 new
                 {
                     name = name,
                     description = description,
                     section = section,
                     type = type
                 },
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<Setting> ISettingRepository.searchList(string procedure)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<Setting>("setting_search_list",
                 new
                 {
                     procedure = procedure
                 },
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<Setting> ISettingRepository.searchListByCompany(string procedure, int companyID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<Setting>("setting_search_list_by_company",
                 new
                 {
                     procedure,
                     companyID
                 },
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<Setting> ISettingRepository.searchListFields(string tableName)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<Setting>("setting_search_list_fields",
                 new
                 {
                     tableName = tableName
                 },
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<Setting> ISettingRepository.searchDashSettings()
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<Setting>("settings_search_dash_submission", null, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<Setting> ISettingRepository.searchByAction(int actionID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<Setting>("setting_search_by_action",
                 new
                 {
                     actionID
                 },
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }

        int ISettingRepository.add(Setting item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("setting_add",
                    new
                    {
                        name = item.name,
                        value = item.value,
                        description = item.description,
                        section = item.section,
                        type = item.type,
                        procedure = item.procedure
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        Setting ISettingRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<Setting>("setting_get", new { settingId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        Setting ISettingRepository.get(string name)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<Setting>("setting_get_by_name", new { name }, commandType: CommandType.StoredProcedure);
            }
        }

        void ISettingRepository.update(Setting item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("setting_update",
                    new
                    {
                        settingId = item.settingId,
                        name = item.name,
                        value = item.value,
                        description = item.description,
                        section = item.section,
                        type = item.type
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        IEnumerable<SettingWCCheckDetail> ISettingRepository.searchWCCheckDetailColumns(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<SettingWCCheckDetail>("setting_search_wccheckdetail_columns",
                 new
                 {
                     settingID = id
                 },
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<Setting> ISettingRepository.searchWCCheckDetailFields(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<Setting>("setting_search_wccheckdetail_fields",
                 new
                 {
                     settingID = id
                 },
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }

    }
}

```
## StoreOrderRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using AT.AT2017.Api.Core.Models;
using System.Data.SqlClient;
using AT.AT2017.Api.DynamicParameters;
using AT.AT2017.Api.Core.Shared;

namespace AT.AT2017.Api.Repositories
{
    public class StoreOrderRepository : BaseRepository, IStoreOrderRepository
    {
        public StoreOrderRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        PagedList<StoreOrderSearchResult> IStoreOrderRepository.search(int orderId, int invoiceId, int inventoryId, int companyId, int personId, int propertyId,
            string descriptiveText, string fromDate, string toDate, bool? filled, decimal? saleTotal, bool? paid, int pageIndex, int pageSize, string item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                PagedList<StoreOrderSearchResult> page = null;

                using (var multi = connection.QueryMultiple("storeOrder_search",
                 new
                 {
                     orderId,
                     invoiceId,
                     inventoryId,
                     companyId,
                     personId,
                     propertyId,
                     descriptiveText,
                     fromDate,
                     toDate,
                     filled,
                     saleTotal,
                     paid,
                     pageIndex,
                     pageSize,
                     item
                 },
                 commandType: CommandType.StoredProcedure))
                {
                    var data = multi.Read<StoreOrderSearchResult>().ToList();
                    page = multi.Read<PagedList<StoreOrderSearchResult>>().Single();
                    page.data = data;
                }

                return page;
            }
        }

        StoreOrder IStoreOrderRepository.get(int orderId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                StoreOrder storeOrder = null;
                using (var multi = connection.QueryMultiple("storeOrder_get", new { orderId }, commandType: CommandType.StoredProcedure))
                {
                    storeOrder = multi.Read<StoreOrder>().SingleOrDefault();
                    if (storeOrder != null)
                    {
                        storeOrder.pictures = multi.Read<StoreOrderPicture>().ToList();
                    }

                    return storeOrder;
                }
            }
        }

        int IStoreOrderRepository.add(StoreOrder item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                var parameters = new StoreOrderDynamicParameter(item);

                return connection.ExecuteScalar<int>("storeOrder_add", parameters, commandType: CommandType.StoredProcedure);
            }
        }

        void IStoreOrderRepository.update(StoreOrder item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                var parameters = new StoreOrderDynamicParameter(item);

                connection.Execute("storeOrder_update", parameters, commandType: CommandType.StoredProcedure);
            }
        }

        void IStoreOrderRepository.delete(int orderId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("storeOrder_delete", new { orderId }, commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## SubmissionRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;
using AT.AT2017.Api.DynamicParameters;

namespace AT.AT2017.Api.Repositories
{
    public class SubmissionRepository : BaseRepository, ISubmissionRepository
    {
        public SubmissionRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<SaveStatisticInput> ISubmissionRepository.getSubmissionRemaxStatistic(int submitId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<SaveStatisticInput>("submission_remax_getStatistic",
                 new
                 {
                     submitID = submitId
                 },
                 commandType: CommandType.StoredProcedure, commandTimeout: 0).ToList();
            }
        }

        IEnumerable<SubmissionRemax> ISubmissionRepository.searchRemax(int companyId, int year, int month, int submitId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<SubmissionRemax>("submission_remax_search",
                 new
                 {
                     companyId = companyId,
                     year = year,
                     month = month,
                     submitId = submitId
                 },
                 commandType: CommandType.StoredProcedure, commandTimeout: 0).ToList();
            }
        }

        IEnumerable<Submission> ISubmissionRepository.search(int entityId, string entityType, int submitId, string submitType)
        {
            using (SqlConnection connection = new SqlConnection(base.saSubmissionConnectionString))
            {
                return connection.Query<Submission>("submission_search",
                 new
				 {
					 entityId = entityId,
					 entityType = entityType,
					 submitId = submitId,
					 submitType = submitType,
                     currentDb = base.dbNameContext,

				 },
                 commandType: CommandType.StoredProcedure, commandTimeout: 0).ToList();
            }
        }

		IEnumerable<Submission> ISubmissionRepository.searchIds()
		{
			using (SqlConnection connection = new SqlConnection(base.connectionString))
			{
				return connection.Query<Submission>("submission_search_ids",	null, commandType: CommandType.StoredProcedure).ToList();
			}
		}


        IEnumerable<SubmissionRemax> ISubmissionRepository.searchRemaxIds(int companyId, int year, int month)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<SubmissionRemax>("submission_remax_search_ids",
                 new
                 {
                     companyId = companyId,
                     year = year,
                     month = month
                 },
                 commandType: CommandType.StoredProcedure, commandTimeout: 0).ToList();
            }
        }

        int ISubmissionRepository.resendSubmissionRemax(int submitId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.ExecuteScalar<int>("submission_remax_resend",  new  {submitId = submitId },commandType: CommandType.StoredProcedure);
            }
        }

        int ISubmissionRepository.resendSubmissionBHS(int submitId, string email)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.ExecuteScalar<int>("submission_bhs_resend", new { submitId = submitId,email = email }, commandType: CommandType.StoredProcedure);
            }
        }

        Submission ISubmissionRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<Submission>("submission_get", new { submitId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        IEnumerable<SubmissionBatch> ISubmissionRepository.searchIdsSQL8(int submitId, string dbName)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<SubmissionBatch>("submission_search_SQL8", new { submitId = submitId, dbName = dbName }, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        SubmissionBatch ISubmissionRepository.getSQL8Results(int submitId, string dbName)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<SubmissionBatch>("submission_get_SQL8_result", new { submitId = submitId, dbName = dbName }, commandType: CommandType.StoredProcedure);
            }
        }


        string ISubmissionRepository.searchXml(int entityId, string entityType, int detailId, string command, bool dash)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                string xml = connection.ExecuteScalar<string>("submission_search_submissionXml",
                    new
                    {
                        entityId = entityId,
                        entityType = entityType,
                        detailId = detailId,
                        command = command,
                        dash = dash
                    },
                    commandType: CommandType.StoredProcedure);

                return xml;
            }
        }

      int ISubmissionRepository.addSubmissionRemax(int companyId, int year, int month,bool sendToApi)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int result = connection.ExecuteScalar<int>("submission_remax_add",
                 new
                 {
                     companyId = companyId,
                     year = year,
                     month = month,
                     sendToApi= sendToApi
                 },
                 commandType: CommandType.StoredProcedure, commandTimeout: 0);

                return result;
            }
        }

        void ISubmissionRepository.addRemaxLog(long detailId, RemaxApiLog log)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int result = connection.ExecuteScalar<int>("remaxApiLog_add",
                 new
                 {
                     detailId = detailId,
                     jsonInput=log.jsonInput,
                     jsonOutput = log.jsonOutput,
                     statisticId = log.statisticId.GetValueOrDefault(),
                     relatedStatisticId = log.relatedStatisticId.GetValueOrDefault(),
                     success = log.success,
                     errorMessage = log.errorMessage
                 },
                 commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }

        SaveStatisticInput ISubmissionRepository.refreshItemStatistic(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<SaveStatisticInput>("submission_remax_itemStatistic_refresh", new { id = id }, commandType: CommandType.StoredProcedure,commandTimeout:0);
            }
        }

        IEnumerable<SubmissionRemax> ISubmissionRepository.getSubmissionRemax(int submitId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<SubmissionRemax>("submission_remax_get", new { submitId = submitId }, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        int ISubmissionRepository.updateSubmissionRemax(int submitId, string email, string urlFile)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int result = connection.ExecuteScalar<int>("submission_remax_update",
                    new
                    {
                        submitId = submitId,
                        email = email,
                        urlFile = urlFile
                    },
                    commandType: CommandType.StoredProcedure);

                return result;
            }
        }

        IEnumerable<SubmissionBHS> ISubmissionRepository.searchBHSIds(int companyId, string fromDate, string endDate)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<SubmissionBHS>("submission_bhs_search_ids",
                 new
                 {
                     companyId = companyId,
                     fromDate = fromDate,
                     endDate = endDate
                 },
                 commandType: CommandType.StoredProcedure, commandTimeout: 0).ToList();
            }
        }

        SubmissionBHS ISubmissionRepository.getSubmissionBHS(int submitId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                SubmissionBHS item = null;

                try
                {
                    using (var multi = connection.QueryMultiple("submission_bhs_get", new { submitId = submitId }, commandType: CommandType.StoredProcedure))
                    {
                        item = multi.Read<SubmissionBHS>().Single();
                        item.headerDetail = multi.Read<SubmissionDetailBHSHeader>().ToList();
                        item.salesTransactionDetail = multi.Read<SubmissionDetailBHSSalesTransaction>().ToList();
                        item.miscIncomeDetail = multi.Read<SubmissionDetailBHSMiscIncome>().ToList();
                        item.salesCustomerDetail = multi.Read<SubmissionDetailBHSSalesCustomer>().ToList();
                        item.monthlyListingsDetail = multi.Read<SubmissionDetailBHSMonthlyListings>().ToList();
                        item.salesAssociateDetail = multi.Read<SubmissionDetailBHSSalesAssociate>().ToList();
                        item.associateProductionDetail = multi.Read<SubmissionDetailBHSAssociateProduction>().ToList();
                        item.trailerDetail = multi.Read<SubmissionDetailBHSTrailer>().ToList();
                    }
                }
                catch (Exception ex)
                {
                    if (ex.Message != "Sequence contains no elements")
                        throw ex;
                }
                return item;
            }
        }

        SubmissionBHS ISubmissionRepository.previewSubmissionBHS(int companyId, string endDate,int validate)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                SubmissionBHS item = null;

                try
                {
                    using (var multi = connection.QueryMultiple("submission_bhs_preview", new { companyId = companyId, endDate= endDate, validate= validate }, commandType: CommandType.StoredProcedure, commandTimeout: 0))
                    {
                        item = multi.Read<SubmissionBHS>().Single();
                        item.headerDetail = multi.Read<SubmissionDetailBHSHeader>().ToList();
                        item.salesTransactionDetail = multi.Read<SubmissionDetailBHSSalesTransaction>().ToList();
                        item.miscIncomeDetail = multi.Read<SubmissionDetailBHSMiscIncome>().ToList();
                        item.salesCustomerDetail = multi.Read<SubmissionDetailBHSSalesCustomer>().ToList();
                        item.monthlyListingsDetail = multi.Read<SubmissionDetailBHSMonthlyListings>().ToList();
                        item.salesAssociateDetail = multi.Read<SubmissionDetailBHSSalesAssociate>().ToList();
                        item.associateProductionDetail = multi.Read<SubmissionDetailBHSAssociateProduction>().ToList();
                        item.trailerDetail = multi.Read<SubmissionDetailBHSTrailer>().ToList();
                        item.validation = multi.Read<ValidationError>().ToList();
                    }
                }
                catch (Exception ex)
                {
                    if (ex.Message != "Sequence contains no elements")
                        throw ex;
                }
                return item;
            }
        }

        int ISubmissionRepository.addSubmissionBHS(SubmissionBHS submission)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                var submissionParameter = new SubmissionBHSDynamicParameter(submission);

                return connection.ExecuteScalar<int>("submission_bhs_add", submissionParameter, commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }

        int ISubmissionRepository.refreshSubmissionBHS(SubmissionBHS submission)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                var submissionParameter = new SubmissionBHSDynamicParameter(submission);

                return connection.ExecuteScalar<int>("submission_bhs_refresh", submissionParameter, commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }

        void ISubmissionRepository.updateSubmissionBHS(int submitID, string email, string txtUrlFile, string xmlUrlfile)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("submission_bhs_update", new
                {
                    submitID = submitID,
                    email = email,
                    txtUrlFile = txtUrlFile,
                    xmlUrlfile = xmlUrlfile,
                }, commandType: CommandType.StoredProcedure);
            }
        }

        void ISubmissionRepository.deleteSubmissionBHS(int submitId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("submission_bhs_delete", new
                {
                    submitID = submitId
                }, commandType: CommandType.StoredProcedure);
            }
        }

        IEnumerable<SubmissionNACHA> ISubmissionRepository.searchNacha(int companyId, int accountId, string startDate, string endDate)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<SubmissionNACHA>("submission_nacha_search",
                 new
                 {
                     companyId = companyId,
                     accountId = accountId,
                     startDate = startDate,
                     endDate = endDate
                 },
                 commandType: CommandType.StoredProcedure, commandTimeout: 0).ToList();

            }
        }

        IEnumerable<SubmissionNachaDetail> ISubmissionRepository.validateNacha(int companyId, int accountId, string startDate, string endDate)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<SubmissionNachaDetail>("submission_nacha_validate",
                 new
                 {
                     companyId = companyId,
                     accountId = accountId,
                     startDate = startDate,
                     endDate = endDate
                 },
                 commandType: CommandType.StoredProcedure, commandTimeout: 0).ToList();

            }
        }

        SubmissionNACHA ISubmissionRepository.getNacha(int submitId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                SubmissionNACHA item = null;

                try
                {
                    using (var multi = connection.QueryMultiple("submission_nacha_get", new { submitId = submitId }, commandType: CommandType.StoredProcedure, commandTimeout: 0))
                    {
                        item = multi.Read<SubmissionNACHA>().Single();
                        item.detail = multi.Read<SubmissionNachaDetail>().ToList();
                        item.fileHeaderDetail = multi.Read<SubmissionNachaFileHeader>().ToList();
                        item.batchHeaderDetail = multi.Read<SubmissionNachaBatchHeader>().ToList();
                        item.entryDetail = multi.Read<SubmissionNachaEntryDetail>().ToList();
                        item.addendaDetail = multi.Read<SubmissionNachaAddenda>().ToList();
                        item.batchControlDetail = multi.Read<SubmissionNachaBatchControl>().ToList();
                        item.fileControlDetail = multi.Read<SubmissionNachaFileControl>().ToList();
                    }
                }
                catch (Exception ex)
                {
                    if (ex.Message != "Sequence contains no elements")
                        throw ex;
                }
                return item;
            }
        }

        SubmissionNACHA ISubmissionRepository.previewNacha(int companyId, int accountId, string startDate, string endDate, string processDate, string email,int isBalanced)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                SubmissionNACHA item = null;

                try
                {
                    using (var multi = connection.QueryMultiple("submission_nacha_preview", new { companyId, accountId, startDate , endDate , processDate, email, isBalanced }, commandType: CommandType.StoredProcedure, commandTimeout: 0))
                    {
                        item = multi.Read<SubmissionNACHA>().Single();
                        item.detail = multi.Read<SubmissionNachaDetail>().ToList();
                        item.fileHeaderDetail = multi.Read<SubmissionNachaFileHeader>().ToList();
                        item.batchHeaderDetail = multi.Read<SubmissionNachaBatchHeader>().ToList();
                        item.entryDetail = multi.Read<SubmissionNachaEntryDetail>().ToList();
                        item.addendaDetail = multi.Read<SubmissionNachaAddenda>().ToList();
                        item.batchControlDetail = multi.Read<SubmissionNachaBatchControl>().ToList();
                        item.fileControlDetail = multi.Read<SubmissionNachaFileControl>().ToList();
                    }
                }
                catch (Exception ex)
                {
                    if (ex.Message != "Sequence contains no elements")
                        throw ex;
                }
                return item;
            }
        }

        int ISubmissionRepository.addNacha(SubmissionNACHA submission)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                var submissionParameter = new SubmissionNACHADynamicParameter(submission);

                return connection.ExecuteScalar<int>("submission_nacha_add", submissionParameter, commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }

        void ISubmissionRepository.deleteNacha(int submitId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("submission_nacha_delete", new
                {
                    submitID = submitId
                }, commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }

        void ISubmissionRepository.finishNacha(int submitId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("submission_nacha_finish", new
                {
                    submitID = submitId
                }, commandType: CommandType.StoredProcedure);
            }
        }
    }
}

```
## SubmissionScheduleRepository.cs.cs
```cs
using System.Collections.Generic;
using System.Linq;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class SubmissionScheduleRepository : BaseRepository, ISubmissionScheduleRepository
    {
        public SubmissionScheduleRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<SubmissionSchedule> ISubmissionScheduleRepository.search(int companyId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<SubmissionSchedule>("submission_schedule_search", new { companyId = companyId }, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<Server> ISubmissionScheduleRepository.searchServer()
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<Server>("submission_schedule_server_search", null, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        SubmissionSchedule ISubmissionScheduleRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<SubmissionSchedule>("submission_schedule_get", new { submissionScheduleID = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int ISubmissionScheduleRepository.add(SubmissionSchedule item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("submission_schedule_add",
                    new
                    {
                        time = item.time,
                        server = item.server,
                        corporateName = item.corporateName,
                        submitAutoFix = item.submitAutofix,
                        submitType = item.submitType,
                        entityType = item.entityType,
                        officeIds = item.officeId,
                        propIds = item.propId,
                        personIds = item.personId,
                        item.minutesToGetResult
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void ISubmissionScheduleRepository.update(SubmissionSchedule item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("submission_schedule_update",
                    new
                    {
                        submissionScheduleID = item.submissionScheduleId,
                        time = item.time,
                        server = item.server,
                        corporateName = item.corporateName,
                        submitAutofix = item.submitAutofix,
                        submitType = item.submitType,
                        entityType = item.entityType,
                        officeIds = item.officeId,
                        propIds = item.propId,
                        personIds = item.personId,
                        item.minutesToGetResult
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void ISubmissionScheduleRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("submission_schedule_delete", new { submissionScheduleID = id }, commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## SystemRepository.cs
```cs
using System.Collections.Generic;
using System.Linq;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;
using Microsoft.AspNetCore.Hosting;

namespace AT.AT2017.Api.Repositories
{
    public class SystemRepository : BaseRepository, ISystemRepository
    {

        public SystemRepository(IHttpContextAccessor httpContextAccessor, IHostingEnvironment env, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor,env, appSettings)
        {
        }

        IEnumerable<SystemErrorCode> ISystemRepository.search(int systemID)
        {
            using (SqlConnection adminConnection = new SqlConnection(base.adminConnectionString))
            {
                return adminConnection.Query<SystemErrorCode>("system_search", new { systemID = systemID }, commandType: CommandType.StoredProcedure).ToList();
            }
        }

    }
}

```
## TaskGroupRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using AT.AT2017.Api.Core.Models;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class TaskGroupRepository : BaseRepository, ITaskGroupRepository
    {
        public TaskGroupRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<TaskGroup> ITaskGroupRepository.search(int groupID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<TaskGroup>("taskGroup_search",
                 new
                 {
                     groupID
                 },
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }

        int ITaskGroupRepository.add(TaskGroup item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("taskGroup_add",
                    new
                    {
                        item.taskID,
                        item.groupID
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void ITaskGroupRepository.delete(TaskGroup item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("taskGroup_delete",
                    new
                    {
                        item.taskID,
                        item.groupID
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## TaskRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using AT.AT2017.Api.Core.Models;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class TaskRepository : BaseRepository, ITaskRepository
    {
        public TaskRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<Task> ITaskRepository.search(string source)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<Task>("task_search",
                 new
                 {
                     source
                 },
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }

        Task ITaskRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<Task>("task_get", new { taskID = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int ITaskRepository.add(Task item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("task_add",
                    new
                    {
                        item.source,
                        item.taskName,
                        item.numDays,
                        item.taskTypeID,
                        item.@lock,
                        item.showSeller,
                        item.showBuyer,
                        item.showListAgent,
                        item.showSellAgent
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void ITaskRepository.update(Task item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("task_update",
                    new
                    {
                        item.taskID,
                        item.taskName,
                        item.numDays,
                        item.taskTypeID,
                        item.@lock,
                        item.showSeller,
                        item.showBuyer,
                        item.showListAgent,
                        item.showSellAgent
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void ITaskRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("task_delete", new { taskID = id }, commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## TokenRepository.cs
```cs
using System.Collections.Generic;
using System.Data;
using System.Data.SqlClient;
using System.Linq;
using AT.AT2017.Api.Core.Models;
using Dapper;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;

namespace AT.AT2017.Api.Repositories
{
    public class TokenRepository : BaseRepository, ITokenRepository
    {
        public TokenRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<Token> ITokenRepository.search(int userID, string userName, int appClientID)
        {
            using (SqlConnection connection = new SqlConnection(base.adminConnectionString))
            {
                return connection.Query<Token>("token_search",
                    new
                    {
                        userID,
                        userName,
                        appClientID
                    }, commandType: CommandType.StoredProcedure).ToList();
            }
        }
    }
}

```
## TotalRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class TotalRepository : BaseRepository, ITotalRepository
    {
        public TotalRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<Total> ITotalRepository.search()
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<Total>("total_search", null, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<Total> ITotalRepository.searchDeletedRecord(int pageIndex, int pageSize)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<Total>("total_search_deleted",
                    new
                    {
                        pageIndex = pageIndex,
                        pageSize = pageSize
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<Total> ITotalRepository.searchFromMaster()
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<Total>("total_search_from_master", null, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<int> ITotalRepository.searchReportId()
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<int>("total_reportId_list", null, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<int> ITotalRepository.searchCommissionIndex()
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<int>("total_commissionIndex_list", null, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<PropertyDateType> ITotalRepository.searchDateTypes(string statuses)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<PropertyDateType>("total_search_date_types", new { statuses = statuses}, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        Total ITotalRepository.getFromMaster(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<Total>("total_get_from_master", new { totalId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        void ITotalRepository.exportToMaster(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("total_export_to_master", new { totalId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        Total ITotalRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<Total>("total_get", new { totalId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int ITotalRepository.add(Total item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("total_add",
                    new
                    {
                        name = item.name,
                        totalBasedOnList = item.totalBasedOnList,
                        totalBasedOnList_withinDates = item.totalBasedOnList_withinDates,
                        totalBasedOnList_sellerLeadSourceIDs = item.totalBasedOnList_sellerLeadSourceIDs,
                        totalBasedOnList_agentOrOfficeLead = item.totalBasedOnList_agentOrOfficeLead,
                        totalBasedOnList_usedForTRTypes = item.totalBasedOnList_usedForTRTypes,
                        totalBasedOnList_usedForClassificationIDs = item.totalBasedOnList_usedForClassificationIDs,
                        totalBasedOnList_excludeFlaggedProps = item.totalBasedOnList_excludeFlaggedProps,
                        totalBasedOnList_enabled = item.totalBasedOnList_enabled,
                        totalBasedOnSell = item.totalBasedOnSell,
                        totalBasedOnSell_withinDates = item.totalBasedOnSell_withinDates,
                        totalBasedOnSell_buyerLeadSourceIDs = item.totalBasedOnSell_buyerLeadSourceIDs,
                        totalBasedOnSell_agentOrOfficeLead = item.totalBasedOnSell_agentOrOfficeLead,
                        totalBasedOnSell_usedForTRTypes = item.totalBasedOnSell_usedForTRTypes,
                        totalBasedOnSell_usedForClassificationIDs = item.totalBasedOnSell_usedForClassificationIDs,
                        totalBasedOnSell_excludeFlaggedProps = item.totalBasedOnSell_excludeFlaggedProps,
                        totalBasedOnSell_enabled = item.totalBasedOnSell_enabled,
                        showOnChecks = item.showOnChecks,
                        totalNotes = item.totalNotes,
                        totalType = item.totalType,
                        calculateType = item.calculateType,
                        customSP = item.customSP,
                        masterId = item.masterId,
                        onlyForProperty = item.onlyForProperty,
                        agentTeamId = item.agentTeamId ,
                        format = item.format,
                        propertyStatus = item.propertyStatus,
                        propertyDateTypes = item.propertyDateTypes,
                        formulaFormat = item.formulaFormat,
                        item.showOnCampaign
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void ITotalRepository.update(Total item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("total_update",
                     new
                     {
                         totalId = item.totalId,
                         name = item.name,
                         totalBasedOnList = item.totalBasedOnList,
                         totalBasedOnList_withinDates = item.totalBasedOnList_withinDates,
                         totalBasedOnList_sellerLeadSourceIDs = item.totalBasedOnList_sellerLeadSourceIDs,
                         totalBasedOnList_agentOrOfficeLead = item.totalBasedOnList_agentOrOfficeLead,
                         totalBasedOnList_usedForTRTypes = item.totalBasedOnList_usedForTRTypes,
                         totalBasedOnList_usedForClassificationIDs = item.totalBasedOnList_usedForClassificationIDs,
                         totalBasedOnList_excludeFlaggedProps = item.totalBasedOnList_excludeFlaggedProps,
                         totalBasedOnList_enabled = item.totalBasedOnList_enabled,
                         totalBasedOnSell = item.totalBasedOnSell,
                         totalBasedOnSell_withinDates = item.totalBasedOnSell_withinDates,
                         totalBasedOnSell_buyerLeadSourceIDs = item.totalBasedOnSell_buyerLeadSourceIDs,
                         totalBasedOnSell_agentOrOfficeLead = item.totalBasedOnSell_agentOrOfficeLead,
                         totalBasedOnSell_usedForTRTypes = item.totalBasedOnSell_usedForTRTypes,
                         totalBasedOnSell_usedForClassificationIDs = item.totalBasedOnSell_usedForClassificationIDs,
                         totalBasedOnSell_excludeFlaggedProps = item.totalBasedOnSell_excludeFlaggedProps,
                         totalBasedOnSell_enabled = item.totalBasedOnSell_enabled,
                         showOnChecks = item.showOnChecks,
                         totalNotes = item.totalNotes,
                         totalType = item.totalType,
                         calculateType = item.calculateType,
                         customSP = item.customSP,
                         onlyForProperty = item.onlyForProperty,
                         advancedCriteria = item.advancedCriteria,
                         reportId = item.reportId ,
                         commissionIndex = item.commissionIndex,
                         agentTeamId = item.agentTeamId,
                         format = item.format,
                         propertyStatus = item.propertyStatus,
                         propertyDateTypes = item.propertyDateTypes,
                         formulaFormat = item.formulaFormat,
                         item.showOnCampaign 
                     },
                     commandType: CommandType.StoredProcedure);
            }
        }

        void ITotalRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("total_delete", new { totalId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        string ITotalRepository.translateFormula(string formula, bool reverse)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.ExecuteScalar<string>("total_translate_formula", new { formula = formula, reverse = reverse }, commandType: CommandType.StoredProcedure);
            }
        }

        bool ITotalRepository.validateFormula(string formula, string type)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.ExecuteScalar<bool>("total_validate_formula",
                    new
                    {
                        formula,
                        type
                    }, commandType: CommandType.StoredProcedure);
            }
        }

        decimal ITotalRepository.calculate(int totalID, int personID, int propertyID, int agentTeamID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                decimal result = connection.ExecuteScalar<decimal>("total_test_formula",
                    new {
                        totalID,
                        personID,
                        propertyID,
                        agentTeamID
                    }, commandType: CommandType.StoredProcedure);
                
                return result;
            }
        }

    }
}

```
## UIExceptionLogRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Data;
using System.Data.SqlClient;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Dapper;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;

namespace AT.AT2017.Api.Repositories
{
    public class UIExceptionLogRepository : BaseRepository, IUIExceptionLogRepository
    {
        public UIExceptionLogRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        void IUIExceptionLogRepository.add(UIExceptionLog item)
        {
            using (SqlConnection connection = new SqlConnection(base.appInsightsConnectionString))
            {
                connection.Execute("uiexception_log_add",
                    new
                    {
                        item.eventDate,
                        item.dbName,
                        item.userName,
                        item.exceptionMessage,
                        item.innerExceptionMessage,
                        item.stackTrace,
                        item.darwinVersion,
                        item.darwinServer
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }
    }
}

```
## UIValidationRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using AT.AT2017.Api.Core.Models;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class UIValidationRepository : BaseRepository, IUIValidationRepository
    {
        public UIValidationRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<UIValidation> IUIValidationRepository.search(string table)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<UIValidation>("uivalidation_search", new { table = table }, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<UIValidation> IUIValidationRepository.searchByModule(string moduleTable)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<UIValidation>("uivalidation_search_by_module", new { moduleTable = moduleTable }, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        UIValidation IUIValidationRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<UIValidation>("uiValidation_get", new { validationID = id }, commandType: CommandType.StoredProcedure);
            }
        }

        void IUIValidationRepository.update(UIValidation item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("uiValidation_update",
                     new
                     {
                         validationID = item.validationID,
                         isRequired = item.isRequired
                     },
                     commandType: CommandType.StoredProcedure);
            }
        }
    }
}

```
## UIValidationTableRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using AT.AT2017.Api.DynamicParameters;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class UIValidationTableRepository : BaseRepository, IUIValidationTableRepository
    {
        public UIValidationTableRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<UIValidationTable> IUIValidationTableRepository.search()
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<UIValidationTable>("uivalidation_table_search", null, commandType: CommandType.StoredProcedure).ToList();
            }
        }
    }
}

```
## UserCompanyRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using AT.AT2017.Api.Core.Models;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class UserCompanyRepository : BaseRepository, IUserCompanyRepository
    {
        public UserCompanyRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<UserCompany> IUserCompanyRepository.search(int companyId, int userId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<UserCompany>("user_company_search",
                    new
                    {
                        companyId = companyId,
                        userId = userId
                    }, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        UserCompany IUserCompanyRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<UserCompany>("user_company_get", new { userCompanyId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int IUserCompanyRepository.add(UserCompany item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("user_company_add",
                    new
                    {
                        userId = item.userId,
                        companyId = item.companyId
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IUserCompanyRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("user_company_delete", new { userCompanyId = id }, commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## UserGLAccountRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using AT.AT2017.Api.Core.Models;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class UserGLAccountRepository : BaseRepository, IUserGLAccountRepository
    {
        public UserGLAccountRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<UserGLAccount> IUserGLAccountRepository.search(int companyId, int userId, int accountId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<UserGLAccount>("user_glaccount_search",
                    new
                    {
                        companyId = companyId,
                        userId = userId,
                        accountId = accountId
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        UserGLAccount IUserGLAccountRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<UserGLAccount>("user_glaccount_get", new { userGLAccountId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int IUserGLAccountRepository.add(UserGLAccount item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("user_glaccount_add",
                    new
                    {
                        userId = item.userId,
                        accountId = item.accountId
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IUserGLAccountRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("user_glaccount_delete", new { userGLAccountId = id }, commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## UserOfficeRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using AT.AT2017.Api.Core.Models;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class UserOfficeRepository : BaseRepository, IUserOfficeRepository
    {
        public UserOfficeRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<UserOffice> IUserOfficeRepository.search(int companyId, int userId, int officeId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<UserOffice>("user_office_search",
                    new
                    {
                        companyId = companyId,
                        userId = userId,
                        officeId = officeId
                    }, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        UserOffice IUserOfficeRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<UserOffice>("user_office_get", new { userOfficeId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int IUserOfficeRepository.add(UserOffice item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("user_office_add",
                    new
                    {
                        userId = item.userId,
                        officeId = item.officeId
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IUserOfficeRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("user_office_delete", new { userOfficeId = id }, commandType: CommandType.StoredProcedure);
            }
        }
    }
}

```
## UserPhoneRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using AT.AT2017.Api.Core.Models;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class UserPhoneRepository : BaseRepository, IUserPhoneRepository
    {
        public UserPhoneRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<UserPhone> IUserPhoneRepository.search(int userId, int onlyVerified)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<UserPhone>("userPhone_search",
                 new
                 {
                     userId = userId,
                     onlyVerified= onlyVerified
                 },
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }

        UserPhone IUserPhoneRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<UserPhone>("userPhone_get", new { userPhoneId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int IUserPhoneRepository.add(UserPhone item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("userPhone_add",
                    new
                    {
                        userId = item.userId,
                        phoneCountryCode = item.phoneCountryCode,
                        phoneNumber = item.phoneNumber,
                        phoneName = item.phoneName,
                        verificationCode= item.verificationCode
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }


        bool IUserPhoneRepository.verify(int id,string code)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return System.Convert.ToBoolean(connection.ExecuteScalar<int>("userPhone_verify",
                    new
                    {
                        userPhoneId = id,
                       verificationCode = code
                    },
                    commandType: CommandType.StoredProcedure));
            }
        }

        void IUserPhoneRepository.update(UserPhone item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("userPhone_update",
                    new
                    {
                        item.userPhoneId,
                        item.phoneCountryCode,
                        item.phoneNumber,
                        item.phoneName,
                        item.verificationCode,
                        item.verified,
                        item.userId  
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IUserPhoneRepository.updatePhoneName(UserPhone item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("userPhone_update_phoneName",
                    new
                    {
                        item.userPhoneId,
                        item.phoneName 
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IUserPhoneRepository.updateCode(UserPhone item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("userPhone_update_code",
                    new
                    {
                        userPhoneId = item.userPhoneId,                      
                        verificationCode = item.verificationCode
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IUserPhoneRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("userPhone_delete", new { userPhoneId = id }, commandType: CommandType.StoredProcedure);
            }
        }
    }
}

```
## UserRepository.cs
```cs
using System;
using System.Data.SqlClient;
using System.Linq;
using System.Data;
using Dapper;
using AT.AT2017.Api.Core.Models;
using Microsoft.Extensions.Options;
using Microsoft.AspNetCore.Http;
using System.Collections.Generic;
using AT.AT2017.Api.DynamicParameters;
using Microsoft.AspNetCore.Hosting;
using Hangfire;

namespace AT.AT2017.Api.Repositories
{
    public class UserRepository : BaseRepository, IUserRepository
    {
        private IHttpContextAccessor _context;
        private IBackgroundJobClient _backgroundJobs;

        public UserRepository(IHttpContextAccessor httpContextAccessor, IHostingEnvironment env, IOptions<ApplicationSettings> appSettings, IBackgroundJobClient backgroundJobs) : base(httpContextAccessor, env, appSettings)
        {
            _context = httpContextAccessor;
            _backgroundJobs = backgroundJobs;
        }

        IEnumerable<User> IUserRepository.search(string fullName, string userName, string email, string corporateName, int companyId, int officeId, int roleId, int pageIndex, int PageSize)
        {
            using (SqlConnection adminConnection = new SqlConnection(base.adminConnectionString))
            {
                return adminConnection.Query<User>("user_search",
                 new
                 {
                     fullName = fullName,
                     userName = userName,
                     email = email,
                     corporateName = corporateName,
					 companyId= companyId,
					 officeId = officeId,
					 roleId = roleId,
					 pageIndex = pageIndex,
                     pageSize = PageSize
                 },
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }
        
        User IUserRepository.get(int id)
        {
            User user;

            // get appUser record from admin database
            using (SqlConnection adminConnection = new SqlConnection(base.saAdminConnectionString))
            {
                // get appUser record
                user = adminConnection.QueryFirst<User>("user_get", new { userID = id }, commandType: CommandType.StoredProcedure);
            }

            // get user permissions from customer database
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                using (var multi = connection.QueryMultiple("user_get_permissions", new { userID = id }, commandType: CommandType.StoredProcedure))
                {
                    // read person record to customize some fields
                    Person agent = multi.Read<Person>().SingleOrDefault();

                    if (agent != null)
                    {
                        user.agentId = agent.personId;

                        if (user.agentId != null && user.agentId > 0)  
                        { 
                            user.firstName = agent.firstName;
                            user.lastName = agent.lastName;
                            user.fullName = agent.firstName + " " + agent.lastName;
                        }
                        user.NotifyContactDoc = agent.notifyContactDoc;
                        user.NotifyContactMsg = agent.notifyContactMsg;
                        user.NotifyPropertyDoc = agent.notifyPropertyDoc;
                        user.NotifyPropertyMsg = agent.notifyPropertyMsg;
                    }

                    // fill in permissions tables of user
                    user.userRoles = multi.Read<UserRole>().ToList();
                    user.userCompanies = multi.Read<UserCompany>().ToList();
                    user.userOffices = multi.Read<UserOffice>().ToList();
                    user.userGLAccounts = multi.Read<UserGLAccount>().ToList();
                    user.userVoucherTypes = multi.Read<UserVoucherType>().ToList();
                }
            }

            return user;
        }

        int IUserRepository.add(UserCredentials item)
        {
            using (SqlConnection saConnection = new SqlConnection(base.saConnectionString))
            {
                int id = saConnection.ExecuteScalar<int>("user_add", new {
                    item.userName,
                    item.userPassword,
                    item.email,
                    item.corporateName,
                    item.createdBy
                }, commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IUserRepository.update(User item, string oldUserName)
        {
            using (SqlConnection saConnection = new SqlConnection(base.connectionString))
            {
                var userParameter = new UserDynamicParameter(item);

                int id = saConnection.ExecuteScalar<int>("user_update", userParameter, commandType: CommandType.StoredProcedure);

            }

            if (item.userName != oldUserName)
            {
                using (SqlConnection saConnection = new SqlConnection(base.saConnectionString))
                {
                    int id = saConnection.ExecuteScalar<int>("user_update_loginname", new
                    {
                        item.userId,
                        item.userName,
                        userNameOld = oldUserName,
                    }, commandType: CommandType.StoredProcedure);
                }

                using (SqlConnection saConnection = new SqlConnection(base.saAdminConnectionString))
                {
                    int id = saConnection.ExecuteScalar<int>("user_update_loginname", new
                    {
                        item.userId,
                        item.userName,
                        userNameOld = oldUserName,
                    }, commandType: CommandType.StoredProcedure);
                }
            }
            using (SqlConnection saConnection = new SqlConnection(base.saAdminConnectionString))
            { 
                saConnection.ExecuteScalar<int>("agentbooks_update_loginName", new
                {
                    item.userName,
                    userNameOld = oldUserName,
                }, commandType: CommandType.StoredProcedure);
            }
        }

        void IUserRepository.updatePassword(UserCredentials item)
        {
            using (SqlConnection saAdminConnection = new SqlConnection(base.saAdminConnectionString))
            {
                int id = saAdminConnection.ExecuteScalar<int>("user_update_password", new {
                    item.userId,
                    item.userPassword,
                    item.logId 
                }, commandType: CommandType.StoredProcedure);
            }
        }

        void IUserRepository.validateCurrentPassword(UserCredentials item)
        {
            using (SqlConnection saAdminConnection = new SqlConnection(base.saAdminConnectionString))
            {
                int id = saAdminConnection.ExecuteScalar<int>("user_validate_currentPassword", new
                {
                    item.userId,
                    userPassword = item.oldUserPassword
                }, commandType: CommandType.StoredProcedure);
            }
        }

        string IUserRepository.updatePasswordBulk(string usersCsv, string newPassword)
        {
            using (SqlConnection saAdminConnection = new SqlConnection(base.saAdminConnectionString))
            {
                string executionGUID = saAdminConnection.ExecuteScalar<string>("bulk_password_update_start", new
                {
                    usersCsv = usersCsv
                }, commandType: CommandType.StoredProcedure);

                // start a background worker
                var hangfireJobID = _backgroundJobs.Enqueue(() => this.bulkPasswordUpdateAsync(executionGUID, newPassword, saAdminConnectionString));

                // insert JObID

                return executionGUID;

                //int id = saAdminConnection.ExecuteScalar<int>("user_update_password_bulk", new
                //{
                //    usersCsv = usersCsv,
                //    newPassword = newPassword
                //}, commandType: CommandType.StoredProcedure);
            }
        }

        public void bulkPasswordUpdateAsync(string executionGUID, string newPassword, string connectionString)
        {
            string status = "pending";

            using (SqlConnection connection = new SqlConnection(connectionString))
            {
                IEnumerable<BulkPasswordUpdateLog> list = connection.Query<BulkPasswordUpdateLog>("bulk_password_update_search",
                                                                        new
                                                                        {
                                                                            executionGUID,
                                                                            status
                                                                        }, commandTimeout: 0, commandType: CommandType.StoredProcedure).ToList();

                foreach (BulkPasswordUpdateLog item in list)
                {
                    string exceptionMessage = "";
                    status = "success";

                    try
                    {
                        //connection.Execute("user_update_reset_password", new { userID = item.userId }, commandType: CommandType.StoredProcedure);

                        int id = connection.ExecuteScalar<int>("user_update_password", new
                        {
                            item.userId,
                            userPassword = newPassword
                        }, commandType: CommandType.StoredProcedure);


                    }
                    catch (Exception ex)
                    {
                        exceptionMessage = ex.Message;
                        status = "failed";
                    }

                    connection.Execute("bulk_password_update_log_update_status", new { executionGuid= item.executionGUID, userID = item.userId, status, exceptionMessage }, commandType: CommandType.StoredProcedure);
                }

            }
        }

        IEnumerable<BulkPasswordUpdateLog> IUserRepository.bulkPasswordUpdateSearch(string executionGUID, string status)
        {
            using (SqlConnection adminConnection = new SqlConnection(base.adminConnectionString))
            {
                return adminConnection.Query<BulkPasswordUpdateLog>("bulk_password_update_search",
                                                                        new
                                                                        {
                                                                            executionGUID,
                                                                            status
                                                                        }, commandTimeout: 0, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        void IUserRepository.delete(int id)
        {
            //must be this "agentBooks" code line before "darwin" code line 
            using (SqlConnection saConnection = new SqlConnection(base.saAgentBooksConnectionString))
            {
                saConnection.ExecuteScalar<int>("dw_login_user_delete", new { userId = id }, commandType: CommandType.StoredProcedure);
            }
            using (SqlConnection saConnection = new SqlConnection(base.saConnectionString))
            {
                saConnection.Execute("user_delete", new { userId = id }, commandType: CommandType.StoredProcedure);
            }

        }

    }
}

```
## UserRoleRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class UserRoleRepository : BaseRepository, IUserRoleRepository
    {
        public UserRoleRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<UserRole> IUserRoleRepository.search(int userId, int roleId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<UserRole>("user_role_search",
                 new
                 {
                     userId = userId,
                     roleId = roleId
                 },
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<RolePersonType> IUserRoleRepository.searchPersonTypes(int userId, int roleId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<RolePersonType>("[user_role_persontype_search]",
                 new
                 {
                     userId = userId,
                     roleId = roleId
                 },
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }

        UserRole IUserRoleRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<UserRole>("user_role_get", new { userRoleId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int IUserRoleRepository.add(UserRole item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("user_role_add",
                    new
                    {
                        userId = item.userId,
                        roleId = item.roleId
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IUserRoleRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("user_role_delete", new { userRoleId = id }, commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## VoucherDetailRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class VoucherDetailRepository : BaseRepository, IVoucherDetailRepository
    {
        public VoucherDetailRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<VoucherDetail> IVoucherDetailRepository.search(int voucherId, int personId, int agentId, string reimb, bool excludeCommission, int expenseJobId,int pageIndex, int pageSize, bool withTrash)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<VoucherDetail>("voucher_detail_search",
                    new
                    {
                        voucherId = voucherId,
                        personId = personId,
                        agentId = agentId,
                        reimb = reimb,
                        excludeCommission = excludeCommission,
                        expenseJobId = expenseJobId,
                        pageIndex = pageIndex,
                        pageSize = pageSize,
                        withTrash = withTrash
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<VoucherDetail> IVoucherDetailRepository.divideByBillingGroup(int billingGroupId, int voucherID, decimal amount, int companyID, int? accountID, string description)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<VoucherDetail>("voucher_get_detail_by_billing_group",
                    new
                    {
                        billingGroupId,
                        voucherID,
                        amount,
                        companyID,
                        accountID,
                        description
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

    }
}

```
## VoucherRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using AT.AT2017.Api.Core.Models;
using Dapper;
using System.Data;
using AT.AT2017.Api.DynamicParameters;
using System.Data.SqlClient;
using AT.AT2017.Api.Core.Shared;

namespace AT.AT2017.Api.Repositories
{
    public class VoucherRepository : BaseRepository, IVoucherRepository
    {
        public VoucherRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<Voucher> IVoucherRepository.search(int companyId, int personId, int propertyId, int orderTypeId, int personTypeId, string posted, string paid, decimal amount, string fromDate, string toDate, string memo, string isTemplate, string poNumber, int pageIndex, int pageSize, bool withTrash, string ids)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<Voucher>("voucher_search",
                    new
                    {
                        companyId = companyId,
                        personId = personId,
                        propertyId = propertyId,
                        orderTypeId = orderTypeId,
                        personTypeId = personTypeId,
                        posted = posted,
                        paid = paid,
                        fromDate = fromDate,
                        toDate = toDate,
                        amount = amount,
                        checkMemo = memo,
                        isTemplate = isTemplate,
                        poNumber=poNumber,
                        pageIndex = pageIndex,
                        pageSize = pageSize,
                        withTrash = withTrash,
                        ids= ids
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<Voucher> IVoucherRepository.searchDeletedRecord(int pageIndex, int pageSize)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<Voucher>("voucher_search_deleted",
                    new
                    {
                        pageIndex = pageIndex,
                        pageSize = pageSize
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<Voucher> IVoucherRepository.searchNoPaids(int companyId, int propertyId, int personId, int voucherId, string poNumber, decimal amount, string fromDate, string toDate, bool isForte, int officeId,int accountId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<Voucher>("voucher_search_nopaids",
                      new
                      {
                          companyId = companyId,
                          propertyId = propertyId,
                          personId = personId,
                          voucherId = voucherId,
                          poNumber = poNumber,
                          amount = amount,
                          fromDate = fromDate,
                          toDate = toDate,
                          isForte = isForte,
                          officeId= officeId,
                          accountId = accountId 
                      },
                      commandType: CommandType.StoredProcedure, commandTimeout: 0).ToList();
            }
        }

        PagedList<Voucher> IVoucherRepository.searchNoPaidsPaginated(int companyId, int propertyId, int personId, int voucherId, string poNumber, decimal amount, string fromDate, string toDate, bool isForte, int officeId, int accountId, int pageIndex, int pageSize, string sortBy, string filterBy)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {

                PagedList<Voucher> page = null;

                using (var multi = connection.QueryMultiple("voucher_search_nopaids_paginated",
                    new
                    {
                        companyId,
                        propertyId,
                        personId,
                        voucherId,
                        poNumber,
                        amount,
                        fromDate,
                        toDate,
                        isForte,
                        officeId,
                        accountId,
                        pageIndex,
                        pageSize,
                        sortBy,
                        filterBy
                    }, commandType: CommandType.StoredProcedure, commandTimeout: 0))
                {
                    page = multi.Read<PagedList<Voucher>>().Single();
                    page.data = multi.Read<Voucher>().ToList();

                }
                return page;
            }
        }

        int IVoucherRepository.searchVendorPONumber(int voucherId, int companyId, int personId, string poNumber)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.ExecuteScalar<int>("voucher_search_vendor_ponumber", new
                {
                    voucherId = voucherId,
                    companyId = companyId,
                    personId = personId,
                    poNumber = poNumber
                }, commandType: CommandType.StoredProcedure);
            }        
        }

        Voucher IVoucherRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                Voucher voucher = null;
                try
                {
                    using (var multi = connection.QueryMultiple("voucher_get", new { voucherId = id }, commandType: CommandType.StoredProcedure))
                    {
                        voucher = multi.Read<Voucher>().Single();
                        voucher.detail = multi.Read<VoucherDetail>().ToList();
                    }
                }
                catch (Exception ex)
                {
                    if (ex.Message != "Sequence contains no elements")
                        throw ex;
                }

                return voucher;
            }
        }

        int IVoucherRepository.add(Voucher item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                var voucherParameter = new VoucherDynamicParameter(item);

                int id = connection.ExecuteScalar<int>("voucher_add", voucherParameter, commandType: CommandType.StoredProcedure, commandTimeout: 0);

                return id;
            }
        }

        int IVoucherRepository.copy(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                id = connection.ExecuteScalar<int>("voucher_copy", new { voucherId = id }, commandType: CommandType.StoredProcedure, commandTimeout: 0);

                return id;
            }
        }

        int IVoucherRepository.reverse(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                id = connection.ExecuteScalar<int>("voucher_reverse", new { voucherId = id }, commandType: CommandType.StoredProcedure, commandTimeout: 0);

                return id;
            }
        }

        void IVoucherRepository.updateFlag1099(int id, int flag1099, int personId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("voucher_update_flag1099", new { voucherId = id, flag1099 = @flag1099, alt1099PersonId = personId }, commandType: CommandType.StoredProcedure);
            }
        }

        void IVoucherRepository.update(Voucher item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                var voucherParameter = new VoucherDynamicParameter(item);
                int Id = connection.ExecuteScalar<int>("voucher_update", voucherParameter, commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }

        void IVoucherRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("voucher_delete", new { voucherId = id }, commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }

        void IVoucherRepository.post(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("voucher_post", new { voucherId = id }, commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }

        void IVoucherRepository.unpost(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("voucher_unpost", new { voucherId = id }, commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }

        int IVoucherRepository.pay(VoucherPay item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                var voucherParameter = new VoucherPayDynamicParameter(item);

                int id = connection.ExecuteScalar<int>("voucher_pay", voucherParameter, commandType: CommandType.StoredProcedure, commandTimeout: 0);

                return id;
            }
        }

        void IVoucherRepository.reclassify(Voucher item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                var voucherParameter = new VoucherDynamicParameter(item);
                int Id = connection.ExecuteScalar<int>("voucher_reclassify_expenses", voucherParameter, commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }

        public IEnumerable<ApPaymentDetail> searchPayments(int voucherId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<ApPaymentDetail>("voucher_payment_search",
                    new
                    {
                        voucherId = voucherId
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }


        public IEnumerable<Voucher> searchTemplates(int companyId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<Voucher>("voucher_search_templates",
                    new
                    {
                        companyId = companyId
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        void IVoucherRepository.updateAsTemplate(Voucher item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("voucher_update_asTemplate",
                    new
                    {
                        voucherId = item.voucherId,
                        isTemplate = item.isTemplate,
                        templateName = item.templateName
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        void IVoucherRepository.updateRecurring(Voucher item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("voucher_update_recurring",
                    new
                    {
                        voucherId = item.voucherId,
                        recurring = item.recurring,
                        recurringType = item.recurringType,
                        recurringPayableGroupID = item.recurringPayableGroupId
                    },
                    commandType: CommandType.StoredProcedure);
            }
        }

        IEnumerable<Voucher> IVoucherRepository.searchVouchersPostingPropertySummary(int propertyId)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<Voucher>("voucher_PostingProperty_Summary",
                    new
                    {
                        propertyId
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }
       
    }
}

```
## VoucherScannedImageRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using AT.AT2017.Api.Core.Models;
using Dapper;
using System.Data;
using AT.AT2017.Api.DynamicParameters;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class VoucherScannedImageRepository : BaseRepository, IVoucherScannedImageRepository
    {
        public VoucherScannedImageRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<VoucherScannedImage> IVoucherScannedImageRepository.search(int voucherID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<VoucherScannedImage>("voucher_scannedImage_search",
                    new
                    {
                        voucherID,
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }

        VoucherScannedImage IVoucherScannedImageRepository.get(int scannedImageID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirst<VoucherScannedImage>("voucher_scannedImage_get", 
                    new
                    {
                        scannedImageID
                    }, commandType: CommandType.StoredProcedure);
            }
        }

        int IVoucherScannedImageRepository.add(VoucherScannedImage item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                item.scannedImageID = connection.ExecuteScalar<int>("voucher_scannedImage_add", new {
                    item.voucherID,
                    item.driveID,
                    item.fileName,
                    item.description
                }, commandType: CommandType.StoredProcedure, commandTimeout: 0);

                return item.scannedImageID;
            }
        }

        void IVoucherScannedImageRepository.delete(int scannedImageID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("voucher_scannedImage_delete", new { scannedImageID }, commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }

        void IVoucherScannedImageRepository.update(VoucherScannedImage item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.ExecuteScalar<int>("voucher_scannedImage_update", new
                {
                    item.scannedImageID,
                    item.description
                }, commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }
    }
}

```
## VoucherScannedImageViewHistoryRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories
{
    public class VoucherScannedImageViewHistoryRepository : BaseRepository, IVoucherScannedImageViewHistoryRepository
    {
        public VoucherScannedImageViewHistoryRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<VoucherScannedImage> IVoucherScannedImageViewHistoryRepository.search(int scannedImageID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<VoucherScannedImage>("voucher_scannedImage_viewHistory_search",
                 new
                 {
                     scannedImageID
                 },
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }

        int IVoucherScannedImageViewHistoryRepository.add(int scannedImageID)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("voucher_scannedImage_viewHistory_add",
                    new
                    {
                        scannedImageID
                    },
                    commandType: CommandType.StoredProcedure);

                return id;
            }
        }

    }
}

```
## WebhookRepository.cs
```cs
using Dapper;
using Hangfire;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Newtonsoft.Json;
using System.Data;
using System.Data.SqlClient;
using AT.AT2017.Api.Core.Models;
using AT.AT2017.Api.Helpers;
using System.Collections.Generic;
using AT.AT2017.Api.Hubs;
using Microsoft.AspNetCore.SignalR;
using AT.AT2017.Api.Hubs.Clients;

namespace AT.AT2017.Api.Repositories
{
    public class WebhookRepository : BaseRepository, IWebhookRepository
    {
        private IBackgroundJobClient _backgroundJobs;
        private readonly IHubContext<ChatHub, IChatClient> _hubContext;
        private UserConnectionManager _connectionManager;

        public WebhookRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings, IBackgroundJobClient backgroundJobs, IHubContext<ChatHub, IChatClient> hubContext, UserConnectionManager connectionManager) : base(httpContextAccessor, appSettings)
        {
            _backgroundJobs = backgroundJobs;
            _hubContext = hubContext;
            _connectionManager = connectionManager;
        }

        void IWebhookRepository.addPlaidWebhook(PlaidWebhook item)
        {
            var webhook_type = item.webhook_type;
            var webhook_code = item.webhook_code;
            var item_id = item.item_id;
            var item_consent_expiration_time = item.consent_expiration_time;
            var item_new_webhook_url = item.new_webhook_url;

            var error_code = "";
            var error_display_message = "";
            var error_message = "";
            var error_type = "";
            var error_status = "";
            var error_request_id = "";
            var error_documentation_url = "";
            var error_suggested_action = "";

            if (item.error != null && item.error.ToString() != "")
            {
                var erroritem = JsonConvert.DeserializeObject<PlaidWebhookError>(item.error.ToString());

                error_code = erroritem.error_code;
                error_display_message = erroritem.display_message;
                error_message = erroritem.error_message;
                error_type = erroritem.error_type;
                error_status = erroritem.status;
                error_request_id = erroritem.request_id;
                error_documentation_url = erroritem.documentation_url;
                error_suggested_action = erroritem.suggested_action;
            }

            var tx_new_transactions = item.new_transactions;
            var tx_removed_transactions = item.removed_transactions;

            var json = JsonConvert.SerializeObject(item, Formatting.Indented);

            using (SqlConnection connection = new SqlConnection(base.saAdminConnectionString))
            {
                int id = connection.ExecuteScalar<int>("webhook_add_plaid_bankstream", new {
                    webhook_type,
                    webhook_code,
                    item_id,
                    item_consent_expiration_time,
                    item_new_webhook_url,
                    error_code,
                    error_display_message,
                    error_message,
                    error_type,
                    error_status,
                    error_request_id,
                    error_documentation_url,
                    error_suggested_action,
                    tx_new_transactions,
                    tx_removed_transactions,
                    json
                }, commandType: CommandType.StoredProcedure);
            }
            
        }

        void IWebhookRepository.addMxWebhook(MxWebhook item)
        {
            using (SqlConnection connection = new SqlConnection(base.saAdminConnectionString))
            {
                var json = JsonConvert.SerializeObject(item, Formatting.Indented);

                int id = connection.ExecuteScalar<int>("mx_webhook_add", new
                {
                    item.webhook_type,
                    item.webhook_action,
                    item.member_guid,
                    item.user_guid,
                    item.transactions_created_count,
                    item.transactions_updated_count,
                    item.user_id,
                    item.connection_status,
                    json
                }, commandType: CommandType.StoredProcedure);
            }
        }

        void IWebhookRepository.addTwilioWebhook(TwilioWebhook item)
        {
            using (SqlConnection connection = new SqlConnection(base.saAdminConnectionString))
            {
                var RawContent = JsonConvert.SerializeObject(item, Formatting.Indented);

                int webhookID = connection.ExecuteScalar<int>("twilio_webhook_add", new
                {
                    item.MessagingServiceSid,
                    item.EventType,
                    item.Attributes,
                    item.DateCreated,
                    item.Index,
                    item.ChatServiceSid,
                    item.MessageSid,
                    item.AccountSid,
                    item.Source,
                    item.RetryCount,
                    item.Author,
                    item.ParticipantSid,
                    item.Body,
                    item.ConversationSid,
                    RawContent
                }, commandType: CommandType.StoredProcedure);

                ChatHelper chatHelper = new ChatHelper(base.credentials);

                // on createMessage method it's updated the connection string for SA
                int? messageID = chatHelper.createMessage(webhookID, item);

                if (messageID != null)
                {
                    ChatMessage message = chatHelper.getMessage(messageID.GetValueOrDefault());

                    // get chat contacts by roomID
                    List<ChatContact> contacts = chatHelper.getChatContacts(message.roomID);

                    // iterate and send message to all "users"
                    foreach (ChatContact contact in contacts)
                    {
                        if (contact.entityType == "user")
                        {
                            int userId = contact.entityID;

                            IReadOnlyCollection<string> connections = _connectionManager.GetConnections(userId);

                            foreach (string connectionId in connections)
                            {
                                _hubContext.Clients.Client(connectionId).ReceiveMessage(message);
                            }
                        }
                    }
                }

            }
        }

    }
}

```
## ZipCodeRepository.cs
```cs
using AT.AT2017.Api.Core.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;
using AT.AT2017.Api.Core.Shared;

namespace AT.AT2017.Api.Repositories
{
    public class ZipCodeRepository : BaseRepository, IZipCodeRepository
    {
        public ZipCodeRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<ZipCode> IZipCodeRepository.states()
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<ZipCode>("zipcode_states_list", null, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<ZipCode> IZipCodeRepository.cities(string city)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<ZipCode>("zipcode_cities_list", new { city }, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<ZipCode> IZipCodeRepository.search(string state, string city, string county, string country, string zipCode, int pageIndex, int pageSize)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.Query<ZipCode>("zipcode_search",
                 new
                 {
                     state,
                     city,
                     county,
                     country,
                     zipCode,
                     pageIndex,
                     pageSize
                 },
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }

        PagedList<ZipCode> IZipCodeRepository.searchPaginated(string state, string city, string county, string country, string zipCode, int pageIndex, int pageSize)
        {
            PagedList<ZipCode> page = null;

            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                using (var multi = connection.QueryMultiple("zipcode_search_paginated",
                    new
                    {
                        state,
                        city,
                        county,
                        country,
                        zipCode,
                        pageIndex,
                        pageSize
                    }, commandType: CommandType.StoredProcedure))
                {
                    page = multi.Read<PagedList<ZipCode>>().Single();
                    page.data = multi.Read<ZipCode>().ToList();
                }
            }
            return page;
        }

        ZipCode IZipCodeRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                return connection.QueryFirstOrDefault<ZipCode>("zipcode_get", new { zipCodeId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int IZipCodeRepository.add(ZipCode item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("zipcode_add",
               new
               {
                   zipCode = item.zipCode,
                   state = item.state,
                   city = item.city,
                   county = item.county,
                   country = item.country
               },
               commandType: CommandType.StoredProcedure);

                return id;
            }
        }

        void IZipCodeRepository.update(ZipCode item)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                int id = connection.ExecuteScalar<int>("zipcode_update",
               new
               {
                   zipCodeID = item.zipCodeId,
                   zipCode = item.zipCode,
                   state = item.state,
                   city = item.city,
                   county = item.county,
                   country = item.country
               },
               commandType: CommandType.StoredProcedure);
            }
        }

        void IZipCodeRepository.delete(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.connectionString))
            {
                connection.Execute("zipcode_delete", new { zipCodeID = id }, commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## agentAssignmentRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models.agentBooks;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using AT.AT2017.Api.DynamicParameters;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories.AgentBooks
{
    public class AgentAssignmentRepository : BaseRepository, IAgentAssignmentRepository 
    {
        public AgentAssignmentRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<AgentAssignments> IAgentAssignmentRepository.search(int userID, int typeSearch)
        {
            using (SqlConnection connection = new SqlConnection(base.agentBooksConnectionString ))
            {
                return connection.Query<AgentAssignments>("dw_agentAssignment_search",
                          new
                          {
                              userID = userID,
                               typeSearch = typeSearch
                          }, 
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<AgentAssignments> IAgentAssignmentRepository.search_database(int userID)
        {
            using (SqlConnection connection = new SqlConnection(base.agentBooksConnectionString))
            {
                return connection.Query<AgentAssignments>("dw_agentAssignment_search_database",
                          new
                          {
                              userID = userID
                          },
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<AgentAssignments> IAgentAssignmentRepository.search_groupBy_UserDatabase(int userID, int databaseID, int typeSearch) 
        {
            using (SqlConnection connection = new SqlConnection(base.agentBooksConnectionString))
            {
                return connection.Query<AgentAssignments>("dw_agentAssignment_search_groupBy_userDatabase",
                    new
                    {
                        userID = userID,
                        databaseID = databaseID,
                        typeSearch = typeSearch
                    },
                    commandType: CommandType.StoredProcedure, commandTimeout: 0).ToList();
            }
        }

        int IAgentAssignmentRepository.add(AgentAssignments item)
        {
            using (SqlConnection connection = new SqlConnection(base.agentBooksConnectionString))
            {
                var agentAssignmentParameter = new AgentAssignmentDynamicParameter (item);

                int id = connection.ExecuteScalar<int>("dw_agentAssignment_add", agentAssignmentParameter, commandType: CommandType.StoredProcedure, commandTimeout: 0);

                return id;
            }
        }

    }
}

```
## AgentBankAccountRepository.cs
```cs
using System.Collections.Generic;
using System.Linq;
using AT.AT2017.Api.Core.Models.agentBooks;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories.AgentBooks
{

    public class AgentBankAccountRepository : BaseRepository, IAgentBankAccountRepository
    {

        public AgentBankAccountRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<AgentBankAccount> IAgentBankAccountRepository.search(int agentId)
        {
            using (SqlConnection connection = new SqlConnection(base.agentBooksConnectionString))
            {
                return connection.Query<AgentBankAccount>("dw_agentBankAccount_search",
                    new
                    {
                        agentID = agentId
                    },
                    commandType: CommandType.StoredProcedure, commandTimeout: 0).ToList();
            }
        }
    }
}

```
## AgentBankAccountTransactionRepository.cs
```cs
using System.Collections.Generic;
using System.Linq;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using System.Data.SqlClient;
using AT.AT2017.Api.Core.Models.agentBooks;

namespace AT.AT2017.Api.Repositories.AgentBooks
{
    public class AgentBankAccountTransactionRepository : BaseRepository, IAgentBankAccountTransactionRepository
    {
        public AgentBankAccountTransactionRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<AgentBankAccountTransaction> IAgentBankAccountTransactionRepository.search(int month, int year, int databaseID, int personID, int userID, string approved, string excluded, string databaseName, int bankAccountId)
        {
            using (SqlConnection connection = new SqlConnection(base.agentBooksConnectionString))
            {
                return connection.Query<AgentBankAccountTransaction>("dw_agentBankAccountTransaction_search",
                    new
                    {
                        month = month,
                        year = year,
                        databaseID = databaseID,
                        personID = personID,
                        userID = userID,
                        approved = approved,
                        excluded = excluded,
                        databaseName = databaseName,
                        bankAccountId = bankAccountId
                    },
                    commandType: CommandType.StoredProcedure, commandTimeout: 0).ToList();
            }
        }

        IEnumerable<AgentBankAccountTransaction> IAgentBankAccountTransactionRepository.search_year()
        {
            using (SqlConnection connection = new SqlConnection(base.agentBooksConnectionString ))
            {
                return connection.Query<AgentBankAccountTransaction>("dw_agentBankAccountTransaction_search_year", null, 
                 //new
                 //{
                 //    agent = agent,
                 //},
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<AgentBankAccountTransaction> IAgentBankAccountTransactionRepository.search_masterCategory(int categoryId)
        {
            using (SqlConnection connection = new SqlConnection(base.agentBooksConnectionString))
            {
                return connection.Query<AgentBankAccountTransaction>("dw_agentBankAccountTransaction_search_master_category",
                    new
                    {
                        categoryID = categoryId,
                    },
                    commandType: CommandType.StoredProcedure, commandTimeout: 0).ToList();
            }
        }

        IEnumerable<AgentBankAccountTransaction> IAgentBankAccountTransactionRepository.search_FieldName()
        {
            using (SqlConnection connection = new SqlConnection(base.agentBooksConnectionString))
            {
                return connection.Query<AgentBankAccountTransaction>("dw_agentBankAccountTransaction_fieldName_rules", null,
                    commandType: CommandType.StoredProcedure, commandTimeout: 0).ToList();
            }
        }

        IEnumerable<AgentBankAccountTransaction> IAgentBankAccountTransactionRepository.search_FieldName_value(string fieldName)
        {
            using (SqlConnection connection = new SqlConnection(base.agentBooksConnectionString))
            {
                return connection.Query<AgentBankAccountTransaction>("dw_agentBankAccountTransaction_fieldName_rules",
                    new
                    {
                        fieldName = fieldName,
                    },
                    commandType: CommandType.StoredProcedure, commandTimeout: 0).ToList();
            }
        }

        AgentBankAccountTransaction IAgentBankAccountTransactionRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.agentBooksConnectionString))
            {
                return connection.QueryFirstOrDefault<AgentBankAccountTransaction>("dw_agentBankAccountTransaction_get", new { transactionID = id }, commandType: CommandType.StoredProcedure);
            }
        }

        DataTable IAgentBankAccountTransactionRepository.get_mergeFields_values(int id)
        {
            DataTable dt = new DataTable();

            // execute campaign
            using (SqlConnection connection = new SqlConnection(base.agentBooksConnectionString))
            {
                SqlCommand command = new SqlCommand("dw_agentBankAccountTransaction_seacrh_merge_values", connection);
                command.CommandType = CommandType.StoredProcedure;
                command.CommandTimeout = 0;

                SqlParameter p;
                p = command.Parameters.Add("@transactionID", SqlDbType.Int);
                p.Value = id;

                connection.Open();
                SqlDataReader reader = command.ExecuteReader();
                dt.Load(reader);
                reader.Close();

            }
            return dt;                       
        }


        void IAgentBankAccountTransactionRepository.update(AgentBankAccountTransaction item)
        {
            using (SqlConnection connection = new SqlConnection(base.agentBooksConnectionString))
            {
                int id = connection.ExecuteScalar<int>("dw_agentBankAccountTransaction_update",
                   new
                   {
                       transactionID = item.transactionId,
                       agentCategoryID = item.agentCategoryId,
                       approved = item.approved,
                       excludeFromAutoMapping = item.excludeFromAutoMapping,
                       excluded = item.excluded,
                       descriptionCustom = item.descriptionCustom 
                   },
                   commandType: CommandType.StoredProcedure);
            }
        }
    }
}

```
## AgentBankRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models.agentBooks;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using AT.AT2017.Api.DynamicParameters;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories.AgentBooks
{
    public class AgentBankRepository : BaseRepository, IAgentBankRepository
    {

        public AgentBankRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<AgentBank> IAgentBankRepository.search(int agentId)
        {
            using (SqlConnection connection = new SqlConnection(base.agentBooksConnectionString))
            {
                return connection.Query<AgentBank>("dw_agentBank_search",
                    new
                    {
                        agentID = agentId
                    },
                    commandType: CommandType.StoredProcedure, commandTimeout: 0).ToList();
            }
        }
    }
}

```
## AgentCategoryRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models.agentBooks;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using AT.AT2017.Api.DynamicParameters;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories.AgentBooks
{
    public class AgentCategoryRepository : BaseRepository, IAgentCategoryRepository
    {
        public AgentCategoryRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<AgentCategory> IAgentCategoryRepository.search(int agentID, string type)
        {
            using (SqlConnection connection = new SqlConnection(base.agentBooksConnectionString ))
            {
                return connection.Query<AgentCategory>("dw_agentCategory_search",
                    new
                    {
                        agentID = agentID,
                        type = type
                    },
                    commandType: CommandType.StoredProcedure, commandTimeout: 0).ToList();
            }
        }

        void IAgentCategoryRepository.addUpdate(IEnumerable<AgentCategory> table, int agentID)
        {
            using (SqlConnection connection = new SqlConnection(base.agentBooksConnectionString))
            {
                var agentCategoryParameter = new AgentCategoryDynamicParameter (table, agentID);

                int id = connection.ExecuteScalar<int>("dw_agentCategory_add_update_table", agentCategoryParameter, commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }

    }
}

```
## AgentMessageRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models.agentBooks;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using AT.AT2017.Api.DynamicParameters;
using System.Data.SqlClient;
using Newtonsoft.Json;

namespace AT.AT2017.Api.Repositories.AgentBooks
{
    public class AgentMessageRepository : BaseRepository, IAgentMessageRepository 
    {
        public AgentMessageRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<AgentMessage> IAgentMessageRepository.search(int agentId, int transactionId, int pageIndex, int pageSize, string order)
        {
            using (SqlConnection connection = new SqlConnection(base.agentBooksConnectionString))
            {
                return connection.Query<AgentMessage>("message_get",
                    new
                    {
                        agentID = agentId,
                        transactionID = transactionId,
                        pageIndex = pageIndex,
                        pageSize = pageSize,
                        order = order
                    }
                    , commandType: CommandType.StoredProcedure, commandTimeout: 0).ToList();
            }
        }

        AgentMessage IAgentMessageRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.agentBooksConnectionString))
            {
                return connection.QueryFirstOrDefault<AgentMessage>("dw_agentMessage_get", new { messageId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        AgentMessage IAgentMessageRepository.add(AgentMessage item)
        {

            using (SqlConnection connection = new SqlConnection(base.saAgentBooksConnectionString))
            {
                AgentMessage agentMessage = connection.QueryFirstOrDefault<AgentMessage>("message_add",
                    new
                    {
                        date = item.date,
                        message = item.message,
                        fromUserID = item.fromUserId,
                        toAgentID = item.toAgentId,
                        fromAgentID = item.fromAgentId,
                        toUserID = item.toUserId,
                        transactionID = item.transactionId,
                    }
                    , commandType: CommandType.StoredProcedure, commandTimeout: 0);

                return agentMessage;
            }
        }

    }
}

```
## AgentRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models.agentBooks;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using AT.AT2017.Api.DynamicParameters;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories.AgentBooks
{
    public class AgentRepository : BaseRepository, IAgentRepository
    {
        public AgentRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<Agent> IAgentRepository.search(int databaseID, string agent, int userID, int companyID, int pageIndex, int pageSize, string emailAddress, int agentID, 
                                                int categoryID, int typeSearch)
        {
            using (SqlConnection connection = new SqlConnection(base.agentBooksConnectionString ))
            {
                return connection.Query<Agent>("dw_agent_search",
                    new
                    {
                        databaseID = databaseID,
                        agent = agent,
                        userID = userID,
                        companyID = companyID,
                        pageIndex = pageIndex,
                        pageSize = pageSize,
                        emailAddress = emailAddress,
                        agentID = agentID,
                        categoryID = categoryID,
                        typeSearch = typeSearch
                    },
                    commandType: CommandType.StoredProcedure, commandTimeout: 0).ToList();
            }
        }

        IEnumerable<Agent> IAgentRepository.search_company(int databaseID)
        {
            using (SqlConnection connection = new SqlConnection(base.agentBooksConnectionString))
            {
                return connection.Query<Agent>("dw_company_search",
                    new
                    {
                        databaseID = databaseID
                    },
                    commandType: CommandType.StoredProcedure, commandTimeout: 0).ToList();
            }
        }

        IEnumerable<AgentAssignmentsDarwin> IAgentRepository.searchCompanyAllDarwin(string databaseName, string serverName, int databaseID, int companyID, int officeID, int personID)
        {
            using (SqlConnection adminConnection = new SqlConnection(saCustomConnectionString(serverName, databaseName)))
            {
                return adminConnection.Query<AgentAssignmentsDarwin>("agentBooks_company_office_person_search",
                    new
                    {
                        databaseID = databaseID,
                        dbName = databaseName,
                        companyID = companyID,
                        officeID = officeID,
                        personID = personID
                    }
                    , commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<AgentCompany> IAgentRepository.searchCompanyDarwin(string databaseName, string serverName ) 
        {
            using (SqlConnection adminConnection = new SqlConnection(saCustomConnectionString(serverName, databaseName)))
            {
                return adminConnection.Query<AgentCompany>("agentBooks_company_search", null, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<AgentOffice> IAgentRepository.searchOfficeDarwin(string databaseName, string serverName,int companyId)
        {
            using (SqlConnection adminConnection = new SqlConnection(saCustomConnectionString(serverName, databaseName)))
            {
                return adminConnection.Query<AgentOffice>("agentBooks_office_search",
                 new
                 {
                     companyId = companyId
                 },
                 commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<AgentDarwin> IAgentRepository.searchAgentDarwin(string databaseName, string serverName, int officeId)
        {
            using (SqlConnection adminConnection = new SqlConnection(saCustomConnectionString(serverName, databaseName)))
            {
                return adminConnection.Query<AgentDarwin>("agentBooks_person_search_agents", new
                {
                    officeId = officeId
                }, commandType: CommandType.StoredProcedure).ToList();
            }
        }

        IEnumerable<AgentArPayments> IAgentRepository.search_ArPayment(string databaseName, string serverName, int companyId, int accountId, int personId, decimal amount, string fromDate, string toDate, string posted, string deposited, int customerTypeId, string method, int pageIndex, int pageSize, bool withTrash, int propertyId, bool isAgentBook)
        {
            using (SqlConnection adminConnection = new SqlConnection(saCustomConnectionString(serverName, databaseName)))
            {
                return adminConnection.Query<AgentArPayments>("arpayment_search",
                    new
                    {
                        companyId = companyId,
                        accountId = accountId,
                        personId = personId,
                        amount = amount,
                        fromDate = fromDate,
                        toDate = toDate,
                        posted = posted,
                        deposited = deposited,
                        customerTypeId = customerTypeId,
                        method = method,
                        pageIndex = pageIndex,
                        pageSize = pageSize,
                        withTrash = withTrash,
                        propertyId = propertyId,
                        isAgentBook = isAgentBook 
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }


        IEnumerable<AgentApPayments> IAgentRepository.search_ApPayment(string databaseName, string serverName, int companyId, int personId, int apPaymentId, string checkNumber, decimal amount, int accountId, string posted, string fromDate, string toDate, string cleared, string reconciled, int propertyId, string memo, int pageIndex, int pageSize, bool withTrash, bool isAgentBook)
        {
            using (SqlConnection adminConnection = new SqlConnection(saCustomConnectionString(serverName, databaseName)))
            {

                return adminConnection.Query<AgentApPayments>("agentBooks_appayment_search",
                    new
                    {
                        personId = personId,
                        posted = posted,
                        fromDate = fromDate,
                        toDate = toDate
                    },
                    commandType: CommandType.StoredProcedure).ToList();
            }
        }


    }
}

```
## ClassificationRuleRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models.agentBooks;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using AT.AT2017.Api.DynamicParameters;
using System.Data.SqlClient;
using Newtonsoft.Json;

namespace AT.AT2017.Api.Repositories.AgentBooks
{
    public class ClassificationRuleRepository : BaseRepository, IClassificationRuleRepository
    {
        public ClassificationRuleRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<ClassificationRule> IClassificationRuleRepository.search(int type, string searchRule, int userId)
        {
            using (SqlConnection connection = new SqlConnection(base.agentBooksConnectionString))
            {
                return connection.Query<ClassificationRule>("dw_classificationRule_search", new
                {
                    type = type,
                    searchRule = searchRule,
                    userID = userId
                },
                    commandType: CommandType.StoredProcedure, commandTimeout: 0).ToList();
            }
        }

        IEnumerable<AgentBankAccountTransaction> IClassificationRuleRepository.search_preview(ClassificationRule item)
        {
            using (SqlConnection connection = new SqlConnection(base.agentBooksConnectionString))
            {
                string rulesDetail = JsonConvert.SerializeObject(item.detail);

                return connection.Query<AgentBankAccountTransaction>("classificationRule_add",
                    new
                    {
                        ruleID = item.ruleId,
                        ruleName = item.ruleName,
                        json = rulesDetail,
                        agentID = item.agentId,
                        accountID = item.accountId,
                        categoryID = item.categoryId,
                        type = item.type,
                        mode = item.mode,
                        pageIndex = item.pageIndex,
                        pageSize = item.pageSize,
                        ruleType = item.ruleType,
                        applyType = item.applyType
                    }
                    , commandType: CommandType.StoredProcedure, commandTimeout: 0).ToList();
            }
        }

        ClassificationRule IClassificationRuleRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.agentBooksConnectionString))
            {
                ClassificationRule rule = null;
                try
                {
                    using (var multi = connection.QueryMultiple("dw_classificationRule_get", new { ruleId = id }, commandType: CommandType.StoredProcedure))
                    {
                        rule = multi.Read<ClassificationRule>().Single();
                        rule.detail = multi.Read<ClassificationRuleDetail>().ToList();
                    }
                }
                catch (Exception ex)
                {
                    if (ex.Message != "Sequence contains no elements")
                        throw ex;
                }

                return rule;
            }
        }

        int IClassificationRuleRepository.add(ClassificationRule item)
        {

            using (SqlConnection connection = new SqlConnection(base.agentBooksConnectionString))
            {
                string rulesDetail = JsonConvert.SerializeObject(item.detail);

                int id = connection.ExecuteScalar<int>("classificationRule_add",
                    new
                    {
                        ruleID = item.ruleId,
                        ruleName = item.ruleName,
                        json = rulesDetail,
                        agentID = item.agentId,
                        accountID = item.accountId,
                        categoryID = item.categoryId,
                        type = item.type,
                        mode = item.mode,
                        pageIndex = item.pageIndex,
                        pageSize = item.pageSize,
                        ruleType = item.ruleType,
                        applyType = item.applyType
                    }
                    , commandType: CommandType.StoredProcedure, commandTimeout: 0);

                return id;
            }
        }

        void IClassificationRuleRepository.apply(ClassificationRule item)
        {
            using (SqlConnection connection = new SqlConnection(base.agentBooksConnectionString))
            {
                string rulesDetail = JsonConvert.SerializeObject(item.detail);

                connection.Execute("classificationRule_add",
                    new
                    {
                        ruleID = item.ruleId,
                        ruleName = item.ruleName,
                        json = rulesDetail,
                        agentID = item.agentId,
                        accountID = item.accountId,
                        categoryID = item.categoryId,
                        type = item.type,
                        mode = item.mode,
                        pageIndex = item.pageIndex,
                        pageSize = item.pageSize,
                        ruleType = item.ruleType,
                        applyType = item.applyType
                    }
                    , commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }

        IEnumerable<AgentBankAccountTransaction> IClassificationRuleRepository.preview_unapply(ClassificationRule item)
        {
            using (SqlConnection connection = new SqlConnection(base.agentBooksConnectionString))
            {
                string rulesDetail = JsonConvert.SerializeObject(item.detail);

                return connection.Query<AgentBankAccountTransaction>("dw_classificationRule_unApply",
                    new
                    {
                        ruleID = item.ruleId,
                        agentID = item.agentId,
                        mode = item.mode,
                        pageIndex = item.pageIndex,
                        pageSize = item.pageSize,
                        applyType = item.applyType
                    }
                    , commandType: CommandType.StoredProcedure, commandTimeout: 0).ToList();
            }
        }

        void IClassificationRuleRepository.unapply(ClassificationRule item)
        {
            using (SqlConnection connection = new SqlConnection(base.agentBooksConnectionString))
            {
                string rulesDetail = JsonConvert.SerializeObject(item.detail);

                connection.Execute("dw_classificationRule_unApply",
                    new
                    {
                        ruleID = item.ruleId,
                        agentID = item.agentId,
                        mode = item.mode,
                        pageIndex = item.pageIndex,
                        pageSize = item.pageSize,
                        applyType = item.applyType
                    }
                    , commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }

        void IClassificationRuleRepository.delete(int id, string userName)
        {
            using (SqlConnection connection = new SqlConnection(base.agentBooksConnectionString))
            {
                connection.Execute("dw_classificationRule_delete", new { ruleId = id, userName = userName}, commandType: CommandType.StoredProcedure);
            }
        }

        int IClassificationRuleRepository.copy(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.agentBooksConnectionString))
            {
                id = connection.ExecuteScalar<int>("dw_classificationRule_copy",
                    new { ruleID = id }
                    , commandType: CommandType.StoredProcedure, commandTimeout: 0);

                return id;
            }
        }

    }
}

```
## IAgentAssignmentRepository.cs
```cs
using System;
using System.Collections.Generic;
using AT.AT2017.Api.Core.Models.agentBooks;

namespace AT.AT2017.Api.Repositories.AgentBooks
{
    public interface IAgentAssignmentRepository
    {
        IEnumerable<AgentAssignments> search(int userID, int typeSearch);
        IEnumerable<AgentAssignments> search_database(int userID);
        IEnumerable<AgentAssignments> search_groupBy_UserDatabase(int userID, int databaseID, int typeSearch);
        int add(AgentAssignments item);
    }
}

```
## IAgentBankAccountRepository.cs
```cs
using System.Collections.Generic;
using AT.AT2017.Api.Core.Models.agentBooks;

namespace AT.AT2017.Api.Repositories.AgentBooks
{
    public interface IAgentBankAccountRepository
    {
        IEnumerable<AgentBankAccount> search(int agentId);
    }
}

```
## IAgentBankAccountTransactionRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Data;
using AT.AT2017.Api.Core.Models.agentBooks;

namespace AT.AT2017.Api.Repositories.AgentBooks
{
    public interface IAgentBankAccountTransactionRepository
    {
        IEnumerable<AgentBankAccountTransaction> search(int month, int year, int databaseID, int personID, int userID, string approved, string excluded, string databaseName, int bankAccountId);

        IEnumerable<AgentBankAccountTransaction> search_year();

        IEnumerable<AgentBankAccountTransaction> search_masterCategory(int categoryId);

        AgentBankAccountTransaction get(int id);

        DataTable get_mergeFields_values(int id);

        void update(AgentBankAccountTransaction item);

        IEnumerable<AgentBankAccountTransaction> search_FieldName();

        IEnumerable<AgentBankAccountTransaction> search_FieldName_value(string fieldName);
    }
}

```
## IAgentBankRepository.cs
```cs
using System.Collections.Generic;
using AT.AT2017.Api.Core.Models.agentBooks; 

namespace AT.AT2017.Api.Repositories.AgentBooks
{
    public interface IAgentBankRepository
    {
        IEnumerable<AgentBank> search(int agentId);
    }
}

```
## IAgentCategoryRepository.cs
```cs
using System.Collections.Generic;
using AT.AT2017.Api.Core.Models.agentBooks;

namespace AT.AT2017.Api.Repositories.AgentBooks
{
    public interface IAgentCategoryRepository
    {
        IEnumerable<AgentCategory> search(int agentID, string type);
        void addUpdate(IEnumerable<AgentCategory> table, int agentID);
    }
}

```
## IAgentMessageRepository.cs
```cs
using System;
using System.Collections.Generic;
using AT.AT2017.Api.Core.Models.agentBooks;

namespace AT.AT2017.Api.Repositories.AgentBooks
{
    public interface IAgentMessageRepository
    {
        IEnumerable<AgentMessage> search(int agentId, int transactionId, int pageIndex, int pageSize, string order);
        AgentMessage get(int id);
        AgentMessage add(AgentMessage item);
    }
}

```
## IAgentRepository.cs
```cs
using System;
using System.Collections.Generic;
using AT.AT2017.Api.Core.Models.agentBooks;

namespace AT.AT2017.Api.Repositories.AgentBooks
{
    public interface IAgentRepository
    {
        IEnumerable<Agent> search(int databaseID, string agent, int userID, int companyID, int pageIndex, int pageSize,string emailAddress, int agentID, int categoryID, int typeSearch);
        IEnumerable<Agent> search_company(int databaseID);
        IEnumerable<AgentCompany> searchCompanyDarwin(string databaseName, string serverName);
        IEnumerable<AgentOffice> searchOfficeDarwin(string databaseName, string serverName,int companyId);
        IEnumerable<AgentDarwin> searchAgentDarwin(string databaseName, string serverName, int officeId);
        IEnumerable<AgentArPayments> search_ArPayment(string databaseName, string serverName, int companyId, int accountId, int personId, decimal amount, string fromDate, string toDate, string posted, string deposited, int customerTypeId, string method, int pageIndex, int pageSize, bool withTrash, int propertyId, bool isAgentBook);
        IEnumerable<AgentApPayments> search_ApPayment(string databaseName, string serverName, int companyId, int personId, int apPaymentId, string checkNumber, decimal amount, int accountId, string posted, string fromDate, string toDate, string cleared, string reconciled, int propertyId, string memo, int pageIndex, int pageSize, bool withTrash, bool isAgentBook);
        IEnumerable<AgentAssignmentsDarwin> searchCompanyAllDarwin(string databaseName, string serverName, int databaseID, int companyID, int officeID, int personID);

    }
}

```
## IClassificationRuleRepository.cs
```cs
using System;
using System.Collections.Generic;
using AT.AT2017.Api.Core.Models.agentBooks;

namespace AT.AT2017.Api.Repositories.AgentBooks
{
    public interface IClassificationRuleRepository
    {
        IEnumerable<ClassificationRule> search(int type, string searchRule, int userId);
        ClassificationRule get(int id);
        int add(ClassificationRule item);
        void apply(ClassificationRule item);
        void delete(int id, string userName);
        IEnumerable<AgentBankAccountTransaction> search_preview(ClassificationRule item);
        IEnumerable<AgentBankAccountTransaction> preview_unapply(ClassificationRule item);
        void unapply(ClassificationRule item);
        int copy(int id);

    }
}

```
## IMasterCategoryRepository.cs
```cs
using System;
using System.Collections.Generic;
using AT.AT2017.Api.Core.Models.agentBooks;

namespace AT.AT2017.Api.Repositories.AgentBooks
{
    public interface IMasterCategoryRepository
    {
        IEnumerable<MasterCategory> search(String type);
        MasterCategory get(int id);
        int addUpdate(MasterCategory item);
        void addUpdate(IEnumerable<MasterCategory> table);
        void delete(int id, string userName);


    }
}

```
## IMessageTemplateRepository.cs
```cs
using System;
using System.Collections.Generic;
using AT.AT2017.Api.Core.Models.agentBooks;

namespace AT.AT2017.Api.Repositories.AgentBooks
{
    public interface IMessageTemplateRepository
    {
        IEnumerable<MessageTemplate> search();
    }
}

```
## ITransactionMappingRepository.cs
```cs
using System;
using System.Collections.Generic;
using AT.AT2017.Api.Core.Models.agentBooks;

namespace AT.AT2017.Api.Repositories.AgentBooks
{
    public interface ITransactionMappingRepository
    {
        IEnumerable<TransactionMapping> search(int transactionId, int agentId, int apPaymentId);
        int add(TransactionMapping item);
        void delete(int transactionId, int apPaymentId);
    }
}

```
## MasterCategoryRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models.agentBooks;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using AT.AT2017.Api.DynamicParameters;
using System.Data.SqlClient;

namespace AT.AT2017.Api.Repositories.AgentBooks
{
    public class MasterCategoryRepository : BaseRepository, IMasterCategoryRepository
    {
        public MasterCategoryRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<MasterCategory> IMasterCategoryRepository.search(string type)
        {
            using (SqlConnection connection = new SqlConnection(base.agentBooksConnectionString ))
            {
                return connection.Query<MasterCategory>("dw_masterCategory_search",
                    new
                    {
                        type = type
                    },
                    commandType: CommandType.StoredProcedure, commandTimeout: 0).ToList();
            }
        }

        MasterCategory IMasterCategoryRepository.get(int id)
        {
            using (SqlConnection connection = new SqlConnection(base.agentBooksConnectionString))
            {
                return connection.QueryFirstOrDefault<MasterCategory>("dw_masterCategory_get", new { categoryId = id }, commandType: CommandType.StoredProcedure);
            }
        }

        int IMasterCategoryRepository.addUpdate(MasterCategory item)
        {

            using (SqlConnection connection = new SqlConnection(base.agentBooksConnectionString))
            {
                int id = connection.ExecuteScalar<int>("dw_masterCategory_addUpdate",
                    new
                    {
                        categoryId = item.categoryId,
                        name = item.name,
                        isSystem = item.isSystem,
                        type = item.type,
                    }
                    , commandType: CommandType.StoredProcedure, commandTimeout: 0);

                return id;
            }
        }

        void IMasterCategoryRepository.addUpdate(IEnumerable<MasterCategory> table)
        {
            using (SqlConnection connection = new SqlConnection(base.agentBooksConnectionString))
            {
                var codeValueParameter = new MasterCategoryDynamicParameter(table);

                int id = connection.ExecuteScalar<int>("dw_masterCategory_add_update_table", codeValueParameter, commandType: CommandType.StoredProcedure, commandTimeout: 0);
            }
        }

        void IMasterCategoryRepository.delete(int id, string userName)
        {
            using (SqlConnection connection = new SqlConnection(base.agentBooksConnectionString))
            {
                connection.Execute("dw_masterCategory_delete", new { categoryId = id, userName = userName }, commandType: CommandType.StoredProcedure);
            }
        }

    }
}

```
## MessageTemplateRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models.agentBooks;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using AT.AT2017.Api.DynamicParameters;
using System.Data.SqlClient;
using Newtonsoft.Json;

namespace AT.AT2017.Api.Repositories.AgentBooks
{
    public class MessageTemplateRepository : BaseRepository, IMessageTemplateRepository  
    {
        public MessageTemplateRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<MessageTemplate> IMessageTemplateRepository.search()
        {
            using (SqlConnection connection = new SqlConnection(base.agentBooksConnectionString))
            {
                return connection.Query<MessageTemplate>("dw_messageTemplate_search", null
                     , commandType: CommandType.StoredProcedure, commandTimeout: 0).ToList();
            }
        }

       
    }
}

```
## TransactionMappingRepository.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using AT.AT2017.Api.Core.Models.agentBooks;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Options;
using Dapper;
using System.Data;
using AT.AT2017.Api.DynamicParameters;
using System.Data.SqlClient;
using Newtonsoft.Json;

namespace AT.AT2017.Api.Repositories.AgentBooks
{
    public class TransactionMappingRepository : BaseRepository, ITransactionMappingRepository
    {
        public TransactionMappingRepository(IHttpContextAccessor httpContextAccessor, IOptions<ApplicationSettings> appSettings) : base(httpContextAccessor, appSettings)
        {
        }

        IEnumerable<TransactionMapping> ITransactionMappingRepository.search(int transactionId, int agentId, int apPaymentId)
        {
            using (SqlConnection connection = new SqlConnection(base.agentBooksConnectionString))
            {
                return connection.Query<TransactionMapping>("dw_transactionMapping_search", new
                {
                    transacionID = transactionId,
                    agentID = agentId,
                    apPaymentID = apPaymentId
                },
                    commandType: CommandType.StoredProcedure, commandTimeout: 0).ToList();
            }
        }

        int ITransactionMappingRepository.add(TransactionMapping item)
        {

            using (SqlConnection connection = new SqlConnection(base.agentBooksConnectionString))
            {

                int id = connection.ExecuteScalar<int>("dw_transactionMapping_add",
                    new
                    {
                        transactionID = item.transactionId,
                        agentID = item.agentId,
                        apPaymentID = item.apPaymentId,
                        transactionIDPrev = item.transactionIdPrev
                    }
                    , commandType: CommandType.StoredProcedure, commandTimeout: 0);

                return id;
            }
        }

        void ITransactionMappingRepository.delete(int transactionId, int apPaymentId)
        {
            using (SqlConnection connection = new SqlConnection(base.agentBooksConnectionString))
            {
                connection.Execute("dw_transactionMapping_delete", new
                {
                    transactionID = transactionId,
                    apPaymentID = apPaymentId
                }, commandType: CommandType.StoredProcedure);
            }
        }
    }
}
```
## IEnumerable.cs
```cs
namespace System.Collections.Generic
{
    internal interface IEnumerable
    {
    }
}
```
## EmailSenderCredentials.cs
```cs
namespace AT.AT2017.Api.Util
{
    public class EmailSenderCredentials
    {
        public string adminUser { get; set; }

        public string adminPassword { get; set; }

        public string adminServer { get; set; }

        public string adminDatabase { get; set; }

        public string emailHost { get; set; }

        public int emailPort { get; set; }

        public string emailUserName { get; set; }

        public string emailPassword { get; set; }
    }
}

```
## FeedProcessorContract.cs
```cs
using AT.AT2017.Api.Classes;
using System;
using System.Collections.Generic;
using System.Linq;
using System.ServiceModel;
using System.Threading.Tasks;
using System.Data;

namespace AT.AT2017.Api.Util
{
    [ServiceContract]
    public interface FeedProcessorContract
    {
        [OperationContract]      
        string runFeed(int id, string _accessor, string guids= "");
        [OperationContract]
        string validateFeed(int id, string _accessor);
        [OperationContract]
        string getSourceData(int id, string field, string _accessor);
    }
   
}

```
## GlobalSetting.cs
```cs
using System.Collections.Generic;
using System.Data;
using System.Data.SqlClient;
using System.Linq;
using AT.AT2017.Api.Core.Models;
using Dapper;

namespace AT.AT2017.Api.Util
{
    public class GlobalSettings
    {

        public static List<GlobalSetting> search(string adminConnectionString, string name = "", string section = "")
        {
            using (SqlConnection connection = new SqlConnection(adminConnectionString))
            {
                return connection.Query<GlobalSetting>("global_setting_search",
                          new
                          {
                              name,
                              section,
                          },
                          commandType: CommandType.StoredProcedure
                      ).ToList();
            }
        }

        public static string getSettingValue(List<GlobalSetting> settings, string name)
        {
            string value = string.Empty;
            GlobalSetting setting = settings.Find(p => p.name == name);
            if (setting != null)
                value = setting.value;
            return value;
        }

    }
}

```
## GoogleDrive.cs
```cs
using Newtonsoft.Json;
using System.Collections.Generic;
using System.IO;
using System.Net;
using System.Text;

namespace AT.AT2017.Api.Util
{
    public class GoogleDrive
    {

        public static string upload(string folderPath, string fileName, string mimeType, string gappsURL, byte[] arrFile)
        {
            // mime-types
            //  "xls" =>'application/vnd.ms-excel',
            //  "xlsx" =>'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
            //  "xml" =>'text/xml',
            //  "ods"=>'application/vnd.oasis.opendocument.spreadsheet',
            //  "csv"=>'text/plain',
            //  "tmpl"=>'text/plain',
            //  "pdf"=> 'application/pdf',
            //  "php"=>'application/x-httpd-php',
            //  "jpg"=>'image/jpeg',
            //  "png"=>'image/png',
            //  "gif"=>'image/gif',
            //  "bmp"=>'image/bmp',
            //  "txt"=>'text/plain',
            //  "doc"=>'application/msword',
            //  "js"=>'text/js',
            //  "swf"=>'application/x-shockwave-flash',
            //  "mp3"=>'audio/mpeg',
            //  "zip"=>'application/zip',
            //  "rar"=>'application/rar',
            //  "tar"=>'application/tar',
            //  "arj"=>'application/arj',
            //  "cab"=>'application/cab',
            //  "html"=>'text/html',
            //  "htm"=>'text/html',
            //  "default"=>'application/octet-stream',
            //  "folder"=>'application/vnd.google-apps.folder'

            string content = "data:" + mimeType + ";base64," + System.Convert.ToBase64String(arrFile);

            var postData = "content=" + System.Net.WebUtility.UrlEncode(content);
            postData += "&originalFileName=" + System.Net.WebUtility.UrlEncode(fileName);
            postData += "&path=" + System.Net.WebUtility.UrlEncode(folderPath);
            postData += "&guidFlag=false";

            var send = Encoding.Default.GetBytes(postData);

            var req = WebRequest.Create(gappsURL);
            req.Method = "POST";
            req.ContentType = "application/x-www-form-urlencoded";
            req.ContentLength = send.Length;

            var sout = req.GetRequestStream();
            sout.Write(send, 0, send.Length);
            sout.Flush();
            sout.Close();

            var res = req.GetResponse();
            var sr = new StreamReader(res.GetResponseStream());
            var returnvalue = sr.ReadToEnd();

            string urlFile = string.Empty;
            Dictionary<string, string> values = JsonConvert.DeserializeObject<Dictionary<string, string>>(returnvalue);
            if (values.ContainsKey("url"))
            {
                urlFile = "https://drive.google.com/file/d/" + values["id"] + "/preview";
            }

            return urlFile;

        }

    }
}

```
## IRealogy.cs
```cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Runtime.Serialization;
using System.ServiceModel;
using System.Text;

namespace AT.AT2017.Api.Util
{
    [ServiceContract]
    public interface IRealogy
    {        
        [OperationContract]
        bool getResult(string api, int submitID, string corporateName, string enviroment, string source, bool realtime);

        [OperationContract]
        int sendSubmissionBatch(string api, string corporateName, string entityType = "All", string officesToSend = "All", string propsIDs = "", string personsIDs = "", bool autoFix = false, bool validateBeforeFix = false, bool initSubmission = false, int migrationLog = 0);

        [OperationContract]
        int sendSubmissionRealtime(string corporateName, string entityType, int entityID, int migrationLog = 0);
    }
}

```
## PlaidHelper.cs
```cs
using System;
using System.IO;
using System.Net;
using Newtonsoft.Json;

namespace AT.AT2017.Api.Util
{
    public class PlaidHelper
    {

        public static string plaidRequest(string method, string url, Object body)
        {

            Uri uri = new Uri(url);

            // create web request
            HttpWebRequest request = (HttpWebRequest)WebRequest.Create(uri.AbsoluteUri.ToString());
            request.Method = method;

            // write body json
            using (var streamWriter = new StreamWriter(request.GetRequestStream()))
            {
                //  write your json content here
                string json = JsonConvert.SerializeObject(body);

                streamWriter.Write(json);
                streamWriter.Flush();
                streamWriter.Close();
            }


            // add headers
            request.ContentType = "application/json";

            // get response
            string response = string.Empty;
            using (HttpWebResponse webResponse = (HttpWebResponse)request.GetResponse())
            {
                using (Stream stream = webResponse.GetResponseStream())
                {
                    using (StreamReader reader = new StreamReader(stream))
                    {
                        response = reader.ReadToEnd();
                    }
                }
            }

            return response;
        }

    }
}

```
## PropertyCopier.cs
```cs
namespace AT.AT2017.Api.Util
{
    public class PropertyCopier<TParent, TChild> where TParent : class
                                            where TChild : class
    {
        public static void Copy(TParent parent, TChild child)
        {
            var parentProperties = parent.GetType().GetProperties();
            var childProperties = child.GetType().GetProperties();

            foreach (var childProperty in childProperties) 
            {
                foreach (var parentProperty in parentProperties)
                {
                    if (parentProperty.Name == childProperty.Name && parentProperty.PropertyType == childProperty.PropertyType)
                    {
                        childProperty.SetValue(child, parentProperty.GetValue(parent));
                        break;
                    }
                }
            }
        }
    }
}

```
## ValidateModelAttribute.cs
```cs
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.Filters;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace AT.AT2017.Api.Validation
{
    public class ValidateModelAttribute : ActionFilterAttribute
    {

        public override void OnActionExecuting(ActionExecutingContext context)
        {
            if (!context.ModelState.IsValid)
            {
                context.Result = new ValidationFailedResult(context.ModelState);
            }
        }

    }
}

```
## ValidationError.cs
```cs
using Newtonsoft.Json;
using System;
using System.Collections.Generic;
using Sys